<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="no-referrer">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="æºç å­¦ä¹ ,æ¶ˆæ¯é˜Ÿåˆ—,Beanstalkd,">





  <link rel="alternate" href="/atom.xml" title="é»‘ç™½ä¹‹é™¢" type="application/atom+xml">






<meta name="description" content="å¼•è¨€Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚">
<meta name="keywords" content="æºç å­¦ä¹ ,æ¶ˆæ¯é˜Ÿåˆ—,Beanstalkd">
<meta property="og:type" content="article">
<meta property="og:title" content="Beanstalkd æºç åˆæ¢">
<meta property="og:url" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/index.html">
<meta property="og:site_name" content="é»‘ç™½ä¹‹é™¢">
<meta property="og:description" content="å¼•è¨€Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/ä»»åŠ¡çŠ¶æ€æµè½¬.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/å¯åŠ¨%20beansktalkd.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/ç¼–è¯‘ä¸è°ƒè¯•.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/æ¨¡å—åˆ†ç±».png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/æ¨¡å—%20UML.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/å­—å…¸.png">
<meta property="og:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/å¯åŠ¨æµç¨‹.png">
<meta property="og:updated_time" content="2019-12-08T07:04:44.817Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Beanstalkd æºç åˆæ¢">
<meta name="twitter:description" content="å¼•è¨€Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚">
<meta name="twitter:image" content="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/ä»»åŠ¡çŠ¶æ€æµè½¬.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/">





  <title>Beanstalkd æºç åˆæ¢ | é»‘ç™½ä¹‹é™¢</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">é»‘ç™½ä¹‹é™¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Valar Morghulis</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-æ”¶è—">
          <a href="/collection" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-star"></i> <br>
            
            æ”¶è—
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iFaceless">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é»‘ç™½ä¹‹é™¢">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Beanstalkd æºç åˆæ¢</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-02-04T18:22:05+08:00">
                2019-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/æ¶ˆæ¯é˜Ÿåˆ—/" itemprop="url" rel="index">
                    <span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  5.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  21
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚<br><a id="more"></a><br>åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ï¼Œç»å¸¸ä¼šå€ŸåŠ© Beanstalkd æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼Œå¸¸è§çš„ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·å®Œæˆä¼šå‘˜è´­ä¹°å¹¶æ¿€æ´»åï¼Œå‘é€ç§ä¿¡é€šçŸ¥ã€é‡ç½®è´¦å·é‡å‘½åçŠ¶æ€ç­‰ï¼›</li>
<li>ç”¨æˆ·å®Œæˆè¯„è®ºåï¼Œå¼‚æ­¥æ›´æ–°è¯„è®ºè®¡æ•°ï¼›</li>
<li>ç”¨æˆ·å¯¹ç§å®¶è¯¾æ”¶å¬è®°å½•ä¸ŠæŠ¥åï¼Œå¼‚æ­¥æ›´æ–°æœ€è¿‘æ”¶å¬çš„å°èŠ‚ã€ç´¯ç§¯æ”¶å¬æ—¶é•¿ã€åŒæ­¥åˆ°å…¶å®ƒç³»ç»Ÿç­‰ï¼›</li>
<li>ç”¨æˆ·è®°å½•æ·»åŠ åï¼Œä¼šåŒæ­¥è‡³ Redisï¼Œä¸ºä¿è¯æ•°æ®åº“å’Œ Redis çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¼šæå‰å¯åŠ¨ä¸€ä¸ªå»¶è¿Ÿæ ¡éªŒçš„ä»»åŠ¡ï¼ˆå¦‚ 5s åï¼‰ï¼Œæ£€æŸ¥ Redis ä¸­ä¸æ•°æ®åº“è®°å½•æ˜¯å¦ä¸€è‡´ã€‚</li>
</ol>
<h1 id="Beanstalkd-åˆè¯†"><a href="#Beanstalkd-åˆè¯†" class="headerlink" title="Beanstalkd åˆè¯†"></a>Beanstalkd åˆè¯†</h1><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol>
<li>åŸºäº TCP å¹¶é‡‡ç”¨ ASCII ç¼–ç çš„æ–‡æœ¬åè®®ã€‚è¯¦ç»†å®šä¹‰å‚è§ï¼š<a href="https://github.com/beanstalkd/beanstalkd/blob/master/doc/protocol.txt" target="_blank" rel="noopener">protocol.txt</a>ï¼š<ol>
<li>å®¢æˆ·ç«¯è´Ÿè´£ä¸æœåŠ¡ç«¯çš„äº¤äº’ï¼š<strong>è¿æ¥</strong>ã€<strong>å‘é€å‘½ä»¤å’Œæ•°æ®</strong>ã€<strong>ç­‰å¾…å“åº”</strong>ã€<strong>å…³é—­è¿æ¥</strong></li>
<li>æœåŠ¡ç«¯ä¸²è¡Œå¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥</li>
<li>åè®®ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šæ–‡æœ¬è¡Œï¼ˆç”¨äºå®¢æˆ·ç«¯å‘½ä»¤å’ŒæœåŠ¡ç«¯å“åº”ï¼‰å’Œéç»“æ„åŒ–çš„æ•°æ®å—ï¼ˆç”¨äºä¼ é€ä»»åŠ¡ body å’Œ stats ä¿¡æ¯ï¼‰</li>
</ol>
</li>
</ol>
<ol>
<li>é˜Ÿåˆ—æ¶ˆæ¯æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä½†ç”¨æˆ·å¯ä»¥é€‰æ‹©å¼€å¯ WAL æœºåˆ¶ï¼ˆbinlogï¼‰ï¼Œè¿™æ ·é‡å¯åå¯ä»¥å›æ”¾ä»»åŠ¡ï¼Œæé«˜äº†å¯ç”¨æ€§</li>
<li>é‡‡ç”¨ç±»ä¼¼ Redis çš„å•çº¿ç¨‹æ¨¡å‹ï¼ˆIO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼‰ï¼Œå› æ­¤ä¸å¿…è€ƒè™‘å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹åŒæ­¥ã€åŠ é”ç­‰ï¼Œç®€åŒ–å®ç°</li>
</ol>
<h2 id="å…³é”®è¯"><a href="#å…³é”®è¯" class="headerlink" title="å…³é”®è¯"></a>å…³é”®è¯</h2><ol>
<li>Tubeï¼šç±»ä¼¼ Kafka ä¸­çš„ Topicï¼Œæˆ–è€…å…¶å®ƒé˜Ÿåˆ—ç³»ç»Ÿä¸­çš„ Channel</li>
<li>Jobï¼šå®¢æˆ·ç«¯ç”Ÿäº§å’Œæ¶ˆè´¹çš„åŸºæœ¬å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‰¹å®šçš„ idï¼Œå¯è®¾å®šä¼˜å…ˆçº§ï¼Œè¶…æ—¶æ—¶é—´ï¼Œå»¶è¿Ÿæ‰§è¡Œæ—¶é—´ç­‰</li>
<li>WAL (Write Ahead Log)ï¼šè´Ÿè´£ binlog ç®¡ç†ï¼ˆå†™å…¥ã€å‹ç¼©ã€æ—¥å¿—æ–‡ä»¶æ¸…ç†ã€ä»»åŠ¡æ¢å¤ç­‰ï¼‰</li>
<li>Serverï¼šBeanstalkd æœåŠ¡ç«¯</li>
<li>Connï¼šBeanstalkd å®¢æˆ·ç«¯è¿æ¥å¤„ç†</li>
</ol>
<h2 id="ä»»åŠ¡çŠ¶æ€æµè½¬"><a href="#ä»»åŠ¡çŠ¶æ€æµè½¬" class="headerlink" title="ä»»åŠ¡çŠ¶æ€æµè½¬"></a>ä»»åŠ¡çŠ¶æ€æµè½¬</h2><p><img src="./ä»»åŠ¡çŠ¶æ€æµè½¬.png" alt="image.png"></p>
<h3 id="ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ"><a href="#ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ"></a>ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="./ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ.png" alt="image.png"></p>
<h2 id="å·¥ä½œæ–¹å¼æè¿°"><a href="#å·¥ä½œæ–¹å¼æè¿°" class="headerlink" title="å·¥ä½œæ–¹å¼æè¿°"></a>å·¥ä½œæ–¹å¼æè¿°</h2><ol>
<li><strong>æœåŠ¡ç«¯</strong>ä¼šæœ‰ä¸€åˆ°å¤šä¸ª tubesï¼ˆåœ¨æ•°ç»„ä¸­ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ª tube éƒ½ä¼šåŒ…å«ä¸€ä¸ª<strong>å°±ç»ªé˜Ÿåˆ—</strong>ï¼ˆåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ä»¥åŠä¸€ä¸ª<strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼ˆä¹Ÿåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„ tube ä¸­åº¦è¿‡å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li><strong>å®¢æˆ·ç«¯</strong>å¯ä»¥ä½¿ç”¨ <code>watch</code> æŒ‡ä»¤è®¢é˜…æŸä¸ª tubeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>ignore</code> å–æ¶ˆè®¢é˜…ï¼Œæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶è®¢é˜…å¤šä¸ª tubeï¼Œå½“æ¶ˆè´¹è€… <code>reserve</code> ä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡å¯èƒ½æ¥è‡ªå…¶ <code>watch list</code> ä¸­çš„ä»»æ„ä¸€ä¸ª tube</li>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ <code>default</code> tubeï¼Œå¯ä»¥ä½¿ç”¨ <code>use</code> åˆ‡æ¢ tube</li>
<li>tube æ˜¯ä¼šæ ¹æ®éœ€è¦éšæ—¶åˆ›å»ºçš„ï¼Œå½“æ²¡æœ‰å®¢æˆ·ç«¯å¼•ç”¨æ—¶ï¼Œå°±ä¼šè¢«åˆ é™¤</li>
</ol>
<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>å€ŸåŠ© Docker å¯åŠ¨ä¸€ä¸ª Beanstalkd æœåŠ¡éå¸¸è½»æ¾ï¼Œè¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤è¡Œå³å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 11300:11300 schickling/beanstalkd</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸Šè¿°å‘½ä»¤è¡Œæ‰§è¡Œæ­£å¸¸ï¼Œåˆ™ Beanstalkd æœåŠ¡åº”è¯¥å¯åŠ¨äº†ï¼Œå…¶é»˜è®¤ç›‘å¬çš„ç«¯å£å·ä¸º <code>11300</code>ï¼Œè¿è¡Œ <code>docker ps</code> å¯ä»¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œï¼š</p>
<p><img src="./å¯åŠ¨ beansktalkd.png" alt="image.png"></p>
<h1 id="ç¼–è¯‘-amp-è¿è¡Œ-amp-è°ƒè¯•"><a href="#ç¼–è¯‘-amp-è¿è¡Œ-amp-è°ƒè¯•" class="headerlink" title="ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•"></a>ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•</h1><p>é¦–å…ˆï¼Œéœ€è¦å‰å¾€ <a href="https://github.com/beanstalkd/beanstalkd" target="_blank" rel="noopener">beanstalkd</a> ä»“åº“å…‹éš† Master åˆ†æ”¯æºç è‡³æœ¬åœ°ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ç®¡ç† C é¡¹ç›®ï¼Œè¿™é‡Œä½¿ç”¨äº† JET BRAINS å®¶æ—çš„ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„å·¥å…·æ‰“å¼€ã€‚</p>
<p>ç”±äº Clion ä½¿ç”¨äº† <a href="https://cmake.org/" target="_blank" rel="noopener">CMake</a> ç®¡ç† C&amp;C++ é¡¹ç›®ï¼Œæ‰€ä»¥æ‰“å¼€é¡¹ç›®æ—¶éœ€è¦åœ¨å…¶æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª CMakeLists.txt æ–‡ä»¶ï¼Œå¹¶å¡«å†™å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.13)</span><br><span class="line">project(beanstalkd C)</span><br><span class="line">set(BUILD_DIR .)</span><br><span class="line">add_custom_target(beanstalkd ALL COMMAND make WORKING_DIRECTORY $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;)</span><br><span class="line">add_custom_command(TARGET beanstalkd POST_BUILD</span><br><span class="line">        COMMAND echo copy $&#123;PROJECT_NAME&#125; to $&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">        COMMAND cp $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/beanstalkd $&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ğŸ‰ è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå·²ç»åšå®Œå•¦ã€‚æ¥ä¸‹æ¥ï¼Œå¯ä»¥å°è¯•ç‚¹å‡»ã€Œæ„å»ºã€æŒ‰é’®ï¼Œè¿›è¡Œç¼–è¯‘ã€‚ç¼–è¯‘ç»“æŸåï¼Œå°±å¯ä»¥ç‚¹å‡»è¿è¡Œå¯åŠ¨ Beanstalkd æœåŠ¡å•¦ã€‚å“¦ï¼Œå¯¹äº†ï¼Œå¦‚æœéœ€è¦è°ƒè¯•æ”¯æŒçš„è¯ï¼Œç›´æ¥åœ¨éœ€è¦çš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶ç‚¹å‡»ã€Œè°ƒè¯•ã€æŒ‰é’®å³å¯å¼€å§‹ã€‚</p>
<p><img src="./ç¼–è¯‘ä¸è°ƒè¯•.png" alt="image.png"></p>
<h2 id="å…³äº-Makefile"><a href="#å…³äº-Makefile" class="headerlink" title="å…³äº Makefile"></a>å…³äº Makefile</h2><p>æŸ¥çœ‹ Makefile æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å‡ ä¸ªå‘½ä»¤å¯ä»¥æ‰§è¡Œï¼š</p>
<ol>
<li><code>make all</code>: ç¼–è¯‘ã€é“¾æ¥å¹¶ç”Ÿæˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ <code>beanstalkd</code>ã€‚ç”±äºæˆ‘ä»¬å·²ç»å°†è¯¥å‘½ä»¤æ”¾åˆ° <code>CMakeLists.txt</code> æ–‡ä»¶ä¸­ï¼Œåœ¨ä½¿ç”¨ Clion æ„å»ºæ—¶å¯è‡ªåŠ¨è§¦å‘</li>
<li><code>make install</code>: å°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ <code>beanstalkd</code> å®‰è£…åˆ° <code>BINDIR=$(DESTDIR)/usr/local/bin</code> ç›®å½•ä¸‹</li>
<li><code>make clean</code>: æ¸…ç†ç”Ÿæˆçš„ <code>*.o</code> æ–‡ä»¶</li>
<li><code>make bench</code>: è·‘ Benchmark ç”¨</li>
</ol>
<h1 id="å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹"></a>å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹</h1><p>ä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚ç”Ÿäº§è€…è´Ÿè´£å°†ä¸€ç»„å¾…æŠ“å–çš„ URLs æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå†ç”±ä¸€ç»„æ¶ˆè´¹è€…å¹¶å‘è®¿é—®é˜Ÿåˆ—ä¸­çš„ URLsã€‚ä¸»æµç¨‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šé¦–å…ˆå¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€…åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ç›‘å¬</span></span><br><span class="line"><span class="comment">// ç„¶åè®©ç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­å¡«å…… URLsï¼Œä¾›æ¶ˆè´¹è€…ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> NUM_WORKERS: <span class="built_in">isize</span> = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..NUM_WORKERS &#123;</span><br><span class="line">        <span class="comment">// å¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">let</span> hd = thread::spawn(<span class="keyword">move</span> || consume_urls(i));</span><br><span class="line">        handles.push(hd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    produce_urls();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ¶ˆè´¹è€…ç»“æŸ</span></span><br><span class="line">    <span class="keyword">for</span> hd <span class="keyword">in</span> handles &#123;</span><br><span class="line">        hd.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç”Ÿäº§è€…"><a href="#ç”Ÿäº§è€…" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">produce_urls</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> client = Beanstalkd::localhost().unwrap();</span><br><span class="line">    client.tube(<span class="string">"urls"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> urls = <span class="built_in">vec!</span>[</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/ifaceless.github.io"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/gic"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/rust-exercises"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/learning-rust"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/fixture"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/rest"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/bigcache"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/leetgogo"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/freecache"</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls &#123;</span><br><span class="line">        client.put(url, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>).unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¶ˆè´¹è€…"><a href="#æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">consume_urls</span></span>(id: <span class="built_in">isize</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] started..."</span>, id);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> client = Beanstalkd::localhost().unwrap();</span><br><span class="line">    client.watch(<span class="string">"urls"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (job_id, url) = <span class="keyword">match</span> client.reserve() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(job) =&gt; job,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] error happens: &#123;&#125;"</span>, id, e);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] got job &lt;&#123;&#125;&gt;: &#123;&#125;"</span>, id, job_id, url);</span><br><span class="line">        client.delete(job_id).unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æºç æ¢ç´¢"><a href="#æºç æ¢ç´¢" class="headerlink" title="æºç æ¢ç´¢"></a>æºç æ¢ç´¢</h1><h2 id="æ¨¡å—åˆ†ç±»å›¾"><a href="#æ¨¡å—åˆ†ç±»å›¾" class="headerlink" title="æ¨¡å—åˆ†ç±»å›¾"></a>æ¨¡å—åˆ†ç±»å›¾</h2><p>ä¸ºäº†æ–¹ä¾¿é˜…è¯»æºç ï¼Œç²—ç•¥åœ°æ ¹æ®è‡ªå·±çš„ç†è§£ç»™å„ä¸ªæ–‡ä»¶åšäº†ç®€å•çš„åˆ†ç±»ï¼š</p>
<p><img src="./æ¨¡å—åˆ†ç±».png" alt="image.png"></p>
<h2 id="æ¨¡å—-UML-å›¾"><a href="#æ¨¡å—-UML-å›¾" class="headerlink" title="æ¨¡å— UML å›¾"></a>æ¨¡å— UML å›¾</h2><p>è™½è¯´ Beanstalkd çš„æºç æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„è®¾è®¡æ€æƒ³ä¾ç„¶å¯ä»¥ä»é¢å‘å¯¹è±¡çš„è§’åº¦æ¥è§£é‡Šã€‚æ¯”å¦‚æ¨¡å—åŒ–è®¾è®¡ã€æ¥å£è®¾è®¡ã€å¤šæ€ç­‰ã€‚æ ¹æ®è‡ªå·±çš„ç†è§£ï¼Œå¯¹å…¶ä¸­çš„ä¸€äº›æ ¸å¿ƒæ¨¡å—åšäº†æ¢³ç†ï¼Œå¹¶ç»˜åˆ¶äº†ä¸€ä¸ªç®€å•çš„ UML å›¾æ¥åŠ æ·±ç†è§£ï¼š</p>
<p><img src="./æ¨¡å— UML.png" alt="image.png"></p>
<h2 id="åŸºæœ¬æ•°æ®ç»“æ„"><a href="#åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="åŸºæœ¬æ•°æ®ç»“æ„"></a>åŸºæœ¬æ•°æ®ç»“æ„</h2><h3 id="æœ€å°å †"><a href="#æœ€å°å †" class="headerlink" title="æœ€å°å †"></a>æœ€å°å †</h3><p><strong>äºŒå‰å †ï¼ˆHeapï¼‰</strong> æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ã€‚å…¶åˆ†ä¸º<strong>æœ€å¤§å †ï¼ˆä¹Ÿå«å¤§æ ¹å †ï¼‰</strong> å’Œ <strong>æœ€å°å †ï¼ˆä¹Ÿå«å°æ ¹å †ï¼‰</strong>ï¼š</p>
<ol>
<li>æœ€å¤§å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å¤§è€…çš„å †</li>
<li>æœ€å°å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å°è€…çš„å †</li>
</ol>
<p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/heap.c" target="_blank" rel="noopener">beanstalkd/heap.c</a> æ˜¯å¯¹æœ€å°å †çš„å®ç°ã€‚é‚£ä¹ˆï¼Œbeanstalkd ä¸­å“ªäº›åœ°æ–¹ç”¨åˆ°äº†æœ€å°å †å‘¢ï¼Ÿ</p>
<ol>
<li>Tube ä¸­çš„å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—ï¼ˆæœ€å…ˆåˆ°æœŸçš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼Œè¿™æ ·å¯ä»¥åœ¨ O(1) æ—¶é—´å¤æ‚åº¦è·å–åˆ°ï¼‰</li>
<li>Tube ä¸­çš„å°±ç»ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆåŸºäºä¼˜å…ˆçº§æ’åˆ—ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼‰</li>
<li>Server ä¸­çš„å®¢æˆ·ç«¯è¿æ¥é˜Ÿåˆ—ï¼ˆåŸºäº tickat æ—¶é—´æ’åˆ—ï¼‰</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æœ€å°å †çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">heapinsert(Heap *h, <span class="keyword">void</span> *x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰©å®¹ç­–ç•¥ï¼š2 å€é•¿åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;len == h-&gt;cap) &#123;</span><br><span class="line">        <span class="keyword">void</span> **ndata;</span><br><span class="line">        <span class="keyword">int</span> ncap = (h-&gt;len+<span class="number">1</span>) * <span class="number">2</span>; <span class="comment">/* allocate twice what we need */</span></span><br><span class="line"></span><br><span class="line">        ndata = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">void</span>*) * ncap);</span><br><span class="line">        <span class="keyword">if</span> (!ndata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(ndata, h-&gt;data, <span class="keyword">sizeof</span>(<span class="keyword">void</span>*)*h-&gt;len);</span><br><span class="line">        <span class="built_in">free</span>(h-&gt;data);</span><br><span class="line">        <span class="comment">// æŒ‡å‘æ–°çš„ä½ç½®</span></span><br><span class="line">        h-&gt;data = ndata;</span><br><span class="line">        <span class="comment">// æ›´æ–°å®¹é‡</span></span><br><span class="line">        h-&gt;cap = ncap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    k = h-&gt;len;</span><br><span class="line">    h-&gt;len++;</span><br><span class="line">    <span class="built_in">set</span>(h, k, x);</span><br><span class="line">    siftdown(h, k);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *</span><br><span class="line">heapremove(Heap *h, <span class="keyword">int</span> k)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (k &gt;= h-&gt;len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x = h-&gt;data[k];</span><br><span class="line">    h-&gt;len--;</span><br><span class="line">    <span class="comment">// ç”¨åŸæ¥çš„æ•°ç»„æœ€åä¸€ä½è¦†ç›–è¢«åˆ é™¤çš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">set</span>(h, k, h-&gt;data[h-&gt;len]);</span><br><span class="line">    siftdown(h, k);</span><br><span class="line">    siftup(h, k);</span><br><span class="line">    h-&gt;rec(x, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="built_in">set</span>(Heap *h, <span class="keyword">int</span> k, <span class="keyword">void</span> *x)</span><br><span class="line">&#123;</span><br><span class="line">    h-&gt;data[k] = x;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼šå»è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    h-&gt;rec(x, k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­ä½ç½® a æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å°äº b æŒ‡å‘çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">less(Heap *h, <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// h-&gt;less æ˜¯ä¸€ä¸ªåˆ¤æ–­å¤§å°çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">// å…¶å®è¦åœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œå®Œå…¨å¯ä»¥è‡ªå®šä¸€ä¸ªå®ç°äº†æ¯”è¾ƒå¤§å°çš„æ¥å£</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚åœ¨ Rust ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `PartialEq` é™å®š...</span></span><br><span class="line">    <span class="keyword">return</span> h-&gt;less(h-&gt;data[a], h-&gt;data[b]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å˜é•¿æ•°ç»„"><a href="#å˜é•¿æ•°ç»„" class="headerlink" title="å˜é•¿æ•°ç»„"></a>å˜é•¿æ•°ç»„</h3><p>åœ¨ C è¯­è¨€æ ‡å‡†åº“ä¸­æ˜¯æ²¡æœ‰å¯å˜é•¿åº¦çš„æ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/ms.c" target="_blank" rel="noopener">beanstalkd/ms.c</a> å®ç°äº†ä¸€ç§ç±»ä¼¼çš„æ•°æ®ç»“æ„ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li><code>ms</code> ç»“æ„ä½“ç»´æŠ¤ä¸€ä¸ªå¯åŠ¨æ€æ‰©å®¹çš„æ•°ç»„ï¼ˆ**itemsï¼‰</li>
<li>æ‰©å®¹ç­–ç•¥å¾ˆç²—æš´ï¼Œç›´æ¥æ‰©å……ä¸ºåŸæ¥å®¹é‡çš„ä¸¤å€</li>
<li>æ’å…¥çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li>
<li>åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li>
<li>ç”±äºåˆ é™¤æ—¶ï¼Œä¼šå°†å°¾éƒ¨ item æ›¿æ¢æ‰è¢«åˆ é™¤çš„ itemï¼Œæ‰€ä»¥ä¸èƒ½ä¾èµ–æ•°ç»„ä¸­çš„å…ƒç´ é¡ºåºï¼ˆé¡ºåºä¸ä¿è¯å’Œæ·»åŠ æ—¶ä¸€è‡´ï¼‰</li>
<li>åˆ é™¤ item åï¼Œå…¶å®æ•°ç»„å ç”¨çš„å†…å­˜ç©ºé—´è¿˜åœ¨ï¼ˆå¹¶æ²¡æœ‰åŠ¨æ€ç¼©å®¹çš„ç­–ç•¥ï¼‰</li>
</ol>
<p>é‚£å…·ä½“åœ¨å“ªäº›åœ°æ–¹ç”¨åˆ°äº† <code>ms</code> è¿™ç§æ•°æ®ç»“æ„å‘¢ï¼Ÿæ¢³ç†åï¼Œä¸»è¦å‘ç°ä»¥ä¸‹å‡ å¤„ï¼š</p>
<ol>
<li>å…¨å±€çš„ <a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/tube.c#L6" target="_blank" rel="noopener">Tube åˆ—è¡¨</a></li>
<li>å®¢æˆ·ç«¯è¿æ¥çš„ <code>Conn</code> ä¸­ç»´æŠ¤çš„ <a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/dat.h#L296" target="_blank" rel="noopener">watch list</a></li>
<li>ä¸ Tube å…³è”çš„<a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/dat.h#L161" target="_blank" rel="noopener">ç­‰å¾…è¿æ¥ï¼ˆconnsï¼‰åˆ—è¡¨</a></li>
</ol>
<p>ä¸‹é¢çœ‹çœ‹å…¶å…·ä½“çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°ç»„ï¼Œå¹¶æ³¨å†Œæ’å…¥å’Œç§»é™¤çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ms_init(ms a, ms_event_fn oninsert, ms_event_fn onremove)</span><br><span class="line">&#123;</span><br><span class="line">    a-&gt;used = a-&gt;cap = a-&gt;last = <span class="number">0</span>;</span><br><span class="line">    a-&gt;items = <span class="literal">NULL</span>;</span><br><span class="line">    a-&gt;oninsert = oninsert;</span><br><span class="line">    a-&gt;onremove = onremove;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶æ•°ç»„å¢é•¿</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">grow(ms a)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> **nitems;</span><br><span class="line">    <span class="comment">// å€é€Ÿå¢é•¿ï¼š1, 2, 4, ...</span></span><br><span class="line">    <span class="keyword">size_t</span> ncap = (a-&gt;cap &lt;&lt; <span class="number">1</span>) ? : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    nitems = <span class="built_in">malloc</span>(ncap * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (!nitems) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ—§çš„æ•°æ®æ‹·è´åˆ°æ–°å¼€è¾Ÿçš„ç©ºé—´</span></span><br><span class="line">    <span class="built_in">memcpy</span>(nitems, a-&gt;items, a-&gt;used * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ—§çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">    <span class="built_in">free</span>(a-&gt;items);</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ–°çš„ä½ç½®</span></span><br><span class="line">    a-&gt;items = nitems;</span><br><span class="line">    <span class="comment">// æ›´æ–°æ•°ç»„å®¹é‡</span></span><br><span class="line">    a-&gt;cap = ncap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ•°ç»„å°¾éƒ¨æ’å…¥æ–°çš„ item</span></span><br><span class="line"><span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">ms_append(ms a, <span class="keyword">void</span> *item)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æŒ‰éœ€æ‰©å±•å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;used &gt;= a-&gt;cap) grow(a);</span><br><span class="line">    <span class="comment">// æ‰©å®¹å¤±è´¥ï¼Œå°±è¿”å›ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å†æ–°å¢ item äº†</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;used &gt;= a-&gt;cap) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    a-&gt;items[a-&gt;used++] = item;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰å›è°ƒï¼Œåˆ™è§¦å‘å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;oninsert) a-&gt;oninsert(a, item, a-&gt;used - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤æŒ‡å®šä½ç½®çš„ item</span></span><br><span class="line"><span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">ms_delete(ms a, <span class="keyword">size_t</span> i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= a-&gt;used) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    item = a-&gt;items[i];</span><br><span class="line">    <span class="comment">// ç›¸å½“äºæŠŠå°¾éƒ¨ item å†™åˆ°è¢«åˆ é™¤çš„ä½ç½®ï¼Œå¹¶ã€Œç¼©å®¹ã€</span></span><br><span class="line">    a-&gt;items[i] = a-&gt;items[--a-&gt;used];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* it has already been removed now */</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;onremove) a-&gt;onremove(a, item, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h3><p><img src="./å­—å…¸.png" alt="image.png"></p>
<p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/job.c" target="_blank" rel="noopener">beanstalkd/job.c</a> ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿åŸºäº <code>job_id</code> å¿«é€Ÿå®šä½åˆ°å…·ä½“çš„ä»»åŠ¡ï¼Œä½œè€…å®ç°äº†ä¸€ä¸ªå­—å…¸æ•°æ®ç»“æ„ã€‚è¿™é‡Œæ˜¯å’Œ job è€¦åˆåœ¨ä¸€èµ·å®ç°çš„ï¼Œæ ¹æ®å¯¹æºç çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºè¯¥å­—å…¸æ•°æ®ç»“æ„çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é‡‡ç”¨åŸºäº <code>job_id</code> å“ˆå¸Œå–æ¨¡çš„æ–¹å¼è®¡ç®— <code>slot_id</code></li>
<li>ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çª</li>
<li>æ ¹æ®è´Ÿè½½å› å­è‡ªåŠ¨è¿›è¡Œ rehashï¼ˆè¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹ï¼‰ï¼Œæ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç³»æ•°æ ¹æ® <a href="https://github.com/beanstalkd/beanstalkd/blob/master/primes.c" target="_blank" rel="noopener">beanstalkd/primes.c</a> è®¾ç½®</li>
<li>rehash è¿‡ç¨‹å¹¶æ²¡æœ‰é‡‡ç”¨ç±»ä¼¼ Redis ä¸­æ¸è¿›å¼ rehash æœºåˆ¶ï¼Œè€Œæ˜¯é˜»å¡å¼å®Œæˆæ•´ä¸ªå“ˆå¸Œè¡¨çš„ rehash åæ‰å¯ä»¥è¿›è¡Œåç»­æ“ä½œ</li>
</ol>
<p>å­˜æ”¾ job åŠ rehash çš„è¯¦ç»†æºç åˆ†æå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾ä¸€ä¸ª job</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">store_job(job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    index = _get_job_hash_index(j-&gt;r.id);</span><br><span class="line"></span><br><span class="line">    j-&gt;ht_next = all_jobs[index]; <span class="comment">// å¦‚æœå­˜åœ¨å†²çªï¼Œå°±é‡‡ç”¨é“¾åœ°å€æ³•</span></span><br><span class="line">    all_jobs[index] = j;</span><br><span class="line">    all_jobs_used++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* accept a load factor of 4 */</span></span><br><span class="line">    <span class="comment">// è´Ÿè½½å› å­è®¾ç½®ä¸º 4ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡Œ rehash</span></span><br><span class="line">    <span class="comment">// çœ‹èµ·è¿™é‡Œæ˜¯é˜»å¡çš„æ–¹å¼æ¥è¿›è¡Œ rehash äº†ï¼Œå¦‚æœ hash è¡¨å¤ªå¤§ï¼Œä¼šè¢«é˜»å¡</span></span><br><span class="line">    <span class="comment">// å¹¶æ²¡æœ‰ä½¿ç”¨ç±»ä¼¼ redis é‚£æ ·æ¸è¿›å¼ rehash æ€è·¯</span></span><br><span class="line">    <span class="keyword">if</span> (all_jobs_used &gt; (all_jobs_cap &lt;&lt; <span class="number">2</span>)) rehash(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¯æŒæ‰©å®¹å’Œç¼©å®¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">rehash(<span class="keyword">int</span> is_upscaling)</span><br><span class="line">&#123;</span><br><span class="line">    job *old = all_jobs;</span><br><span class="line">    <span class="comment">// è®°å½•ä¸‹æ—§çš„ hash è¡¨å®¹é‡ï¼Œå…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">size_t</span> old_cap = all_jobs_cap, old_used = all_jobs_used, i;</span><br><span class="line">    <span class="keyword">int</span> old_prime = cur_prime;</span><br><span class="line">    <span class="keyword">int</span> d = is_upscaling ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cur_prime + d &gt;= NUM_PRIMES) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (cur_prime + d &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_upscaling &amp;&amp; hash_table_was_oom) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    cur_prime += d;</span><br><span class="line"></span><br><span class="line">    all_jobs_cap = primes[cur_prime];</span><br><span class="line">    all_jobs = <span class="built_in">calloc</span>(all_jobs_cap, <span class="keyword">sizeof</span>(job));</span><br><span class="line">    <span class="keyword">if</span> (!all_jobs) &#123; <span class="comment">// é’ˆå¯¹æ‰©å®¹å¤±è´¥çš„å¤„ç†ï¼Œæ¢å¤åŸæ¥çš„ä¸å˜ï¼Œä½†æ˜¯æ ‡è®° OOM</span></span><br><span class="line">        twarnx(<span class="string">"Failed to allocate %zu new hash buckets"</span>, all_jobs_cap);</span><br><span class="line">        hash_table_was_oom = <span class="number">1</span>;</span><br><span class="line">        cur_prime = old_prime;</span><br><span class="line">        all_jobs = old;</span><br><span class="line">        all_jobs_cap = old_cap;</span><br><span class="line">        all_jobs_used = old_used;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡ç½® hash è¡¨çŠ¶æ€</span></span><br><span class="line">    all_jobs_used = <span class="number">0</span>;</span><br><span class="line">    hash_table_was_oom = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶å®å°±æ˜¯æŠŠ Hash è¡¨ä¸Šæ‰€æœ‰çš„ jobs å…¨éƒ¨æ˜ å°„åˆ°æ–°çš„ç©ºé—´</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; old_cap; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (old[i]) &#123;</span><br><span class="line">            job j = old[i];</span><br><span class="line">            old[i] = j-&gt;ht_next;</span><br><span class="line">            j-&gt;ht_next = <span class="literal">NULL</span>;</span><br><span class="line">            store_job(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç„¶åæŠŠåŸæ¥çš„å†…å­˜ç©ºé—´é‡Šæ”¾æ‰</span></span><br><span class="line">    <span class="keyword">if</span> (old != all_jobs_init) &#123;</span><br><span class="line">        <span class="built_in">free</span>(old);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h3><p>é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„åœ¨ Beanstalkd å®ç°ä¸­ç”¨å¾—æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”å¦‚</p>
<ol>
<li><a href="https://github.com/beanstalkd/beanstalkd/blob/master/walg.c" target="_blank" rel="noopener">beanstalkd/walg.c</a> ä¸­ä½¿ç”¨äº†å•å‘é“¾è¡¨çš„ä¸²è”äº†ä¸€äº›åˆ—çš„æ—¥å¿—æ–‡ä»¶ï¼ˆå‚è§ä¸‰ä¸ªæ¸¸æ ‡æŒ‡é’ˆï¼š<code>head</code>, <code>cur</code>, <code>tail</code>ï¼‰</li>
<li><a href="https://github.com/beanstalkd/beanstalkd/blob/master/conn.c" target="_blank" rel="noopener">beanstalkd/conn.c</a> ä½¿ç”¨åŒå‘é“¾è¡¨è¿æ¥äº†ä¸€äº›åˆ—è¢« <code>reserve</code> çš„ä»»åŠ¡</li>
</ol>
<p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/job.c" target="_blank" rel="noopener">beastalkd/job.c</a>ï¼Œå¯ä»¥çœ‹åˆ°ä»»åŠ¡åŒå‘é“¾è¡¨å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">job_list_any_p(job head)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> head-&gt;next != head || head-&gt;prev != head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">job</span><br><span class="line">job_remove(job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!j) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!job_list_any_p(j)) <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* not in a doubly-linked list */</span></span><br><span class="line"></span><br><span class="line">    j-&gt;next-&gt;prev = j-&gt;prev;</span><br><span class="line">    j-&gt;prev-&gt;next = j-&gt;next;</span><br><span class="line"></span><br><span class="line">    j-&gt;prev = j-&gt;next = j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">job_insert(job head, job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (job_list_any_p(j)) <span class="keyword">return</span>; <span class="comment">/* already in a linked list */</span></span><br><span class="line"></span><br><span class="line">    j-&gt;prev = head-&gt;prev;</span><br><span class="line">    j-&gt;next = head;</span><br><span class="line">    head-&gt;prev-&gt;next = j;</span><br><span class="line">    head-&gt;prev = j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ "><a href="#éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ " class="headerlink" title="éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ "></a>éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ </h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv) &#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    <span class="comment">// å­˜æ”¾ä»»åŠ¡çš„é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job</span> <span class="title">list</span> = &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    progname = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// è®¾ç½®ä½¿ç”¨è¡Œç¼“å­˜ï¼Œè¡¨ä½¿ç”¨æ ‡å‡†è¾“å‡ºä½œä¸ºæ‰“å°ç›®æ ‡</span></span><br><span class="line">    <span class="comment">// è¯¦ç»†æ–‡æ¡£å‚è§ï¼šhttps://linux.die.net/man/3/setlinebuf</span></span><br><span class="line">    <span class="comment">// æ„æ€æ˜¯ï¼Œåªæœ‰åœ¨æ»¡è¶³ä¸€è¡Œï¼ˆæ¢è¡Œï¼‰æ—¶æ‰è¾“å‡º</span></span><br><span class="line">    setlinebuf(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="comment">// å‘½ä»¤è¡Œå¤„ç†</span></span><br><span class="line">    optparse(&amp;srv, argv + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"pid %d\n"</span>, getpid());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ç«¯ socket åˆå§‹åŒ–ç­‰ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ socket çš„ file descriptor</span></span><br><span class="line">    r = make_server_socket(srv.addr, srv.port);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) twarnx(<span class="string">"make_server_socket()"</span>), <span class="built_in">exit</span>(<span class="number">111</span>);</span><br><span class="line">    srv.sock.fd = r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åè®®å¤„ç†æ¨¡å—åˆå§‹åŒ–</span></span><br><span class="line">    prot_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (srv.user) su(srv.user);</span><br><span class="line">    set_sig_handlers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (srv.wal.use) &#123;</span><br><span class="line">        <span class="comment">// We want to make sure that only one beanstalkd tries</span></span><br><span class="line">        <span class="comment">// to use the wal directory at a time. So acquire a lock</span></span><br><span class="line">        <span class="comment">// now and never release it.</span></span><br><span class="line">        <span class="comment">// WAL å³ Write Ahead Log Directoryï¼Œä¸»è¦æ˜¯è®°å½•æ—¥å¿—ç”¨</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯è¦ä¿è¯æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ª beanstalkd å®ä¾‹ä½¿ç”¨ WAL ç›®å½•ï¼Œé˜²æ­¢ç›¸äº’å†™å…¥å†²çª</span></span><br><span class="line">        <span class="comment">// é‚£ä¼°è®¡ä»¥åå°±æ²¡æ³•ä» binlog æ¢å¤ä»»åŠ¡äº†ã€‚ã€‚ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!waldirlock(&amp;srv.wal)) &#123;</span><br><span class="line">            twarnx(<span class="string">"failed to lock wal dir %s"</span>, srv.wal.dir);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä»»åŠ¡é“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰</span></span><br><span class="line">        <span class="built_in">list</span>.prev = <span class="built_in">list</span>.next = &amp;<span class="built_in">list</span>;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– WALï¼Œå¦‚æœ log ä¸­æœ‰ä»»åŠ¡ï¼Œè¿˜è¦æ¢å¤å›æ¥ï¼ŒæŒ‚è½½åˆ° job list</span></span><br><span class="line">        walinit(&amp;srv.wal, &amp;<span class="built_in">list</span>);</span><br><span class="line">        <span class="comment">// å›æ”¾ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">        r = prot_replay(&amp;srv, &amp;<span class="built_in">list</span>);</span><br><span class="line">        <span class="keyword">if</span> (!r) &#123;</span><br><span class="line">            twarnx(<span class="string">"failed to replay log"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£å¼å¯åŠ¨ serverï¼Œå¹¶ç›‘å¬è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚äº†</span></span><br><span class="line">    srvserve(&amp;srv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="./å¯åŠ¨æµç¨‹.png" alt="image.png"></p>
<h3 id="serv-c"><a href="#serv-c" class="headerlink" title="serv.c"></a>serv.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">srvserve(Server *s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    Socket *sock;</span><br><span class="line">    int64 period;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sockinit() == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarnx(<span class="string">"sockinit"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;sock.x = s;</span><br><span class="line">    <span class="comment">// æŒ‡å®šå›è°ƒï¼Œå½“æ¥æ”¶åˆ° `r` äº‹ä»¶åï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ</span></span><br><span class="line">    s-&gt;sock.f = (Handle)srvaccept;</span><br><span class="line">    <span class="comment">// Server ç»´æŠ¤äº†å…³è”çš„å®¢æˆ·ç«¯è¿æ¥ï¼ˆæœ€å°å †ï¼‰</span></span><br><span class="line">    s-&gt;conns.less = (Less)connless;</span><br><span class="line">    s-&gt;conns.rec = (Record)connrec;</span><br><span class="line"></span><br><span class="line">    r = listen(s-&gt;sock.fd, <span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarn(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œ</span></span><br><span class="line">    r = sockwant(&amp;s-&gt;sock, <span class="string">'r'</span>);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarn(<span class="string">"sockwant"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå‘¨æœŸæ€§çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// å¦‚æœ tick ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ—¶é—´è¿‡ä¹…ï¼Œä¼šé˜»å¡åé¢çš„ socket connection å¤„ç†</span></span><br><span class="line">        <span class="comment">// ä¸¥é‡ä¼šå¯¼è‡´è¶…æ—¶ï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯é‡è¯•è¿‡å¤šï¼Œåˆ™å›å¢åŠ æœåŠ¡ç«¯è´Ÿè½½</span></span><br><span class="line">        period = prottick(s);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è½®è¯¢æ˜¯å¦æœ‰å°±ç»ªçš„è¯·æ±‚ï¼ˆrwï¼‰ï¼Œå…¶å®å°±æ˜¯ä¸ªé€‚é…å™¨ï¼Œå°†å…·ä½“å¹³å°ä¸‹è¿”å›çš„çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// è½¬æ¢æˆç»Ÿä¸€çš„ `r`, `w`, `h`</span></span><br><span class="line">        <span class="comment">// Linux ä½¿ç”¨ epoll å°è£…ï¼ˆå‚è§ `linux.c`ï¼‰</span></span><br><span class="line">        <span class="comment">// Unix ä½¿ç”¨ kqueue å°è£…ï¼ˆå‚è§ `darwin.c`ï¼‰</span></span><br><span class="line">        <span class="keyword">int</span> rw = socknext(&amp;sock, period);</span><br><span class="line">        <span class="keyword">if</span> (rw == <span class="number">-1</span>) &#123;</span><br><span class="line">            twarnx(<span class="string">"socknext"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rw) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè½®è¯¢åˆ°éœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å›è°ƒ Handle</span></span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„å›è°ƒä¾ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¦‚æœä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œå°±å‘µå‘µå“’äº†</span></span><br><span class="line">            sock-&gt;f(sock-&gt;x, rw);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tube-c"><a href="#tube-c" class="headerlink" title="tube.c"></a>tube.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»º tubeï¼Œè¿™é‡Œéœ€è¦ç»™å®š tube åç§°</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª tube æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç»„æˆï¼š</span></span><br><span class="line"><span class="comment">// 1. ç»´æŠ¤å°±ç»ªä»»åŠ¡çš„å †</span></span><br><span class="line"><span class="comment">// 2. ç»´æŠ¤å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„å †</span></span><br><span class="line"><span class="comment">// 3. ç»´æŠ¤å¤„äº buried çŠ¶æ€çš„ä»»åŠ¡é“¾è¡¨</span></span><br><span class="line"><span class="comment">// 4. ç»´æŠ¤ä¸€ä¸ªç­‰å¾…åˆ—è¡¨</span></span><br><span class="line">tube</span><br><span class="line">make_tube(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    tube t;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…å†…å­˜ç©ºé—´ï¼Œç”¨äºå­˜å‚¨ tube ç»“æ„ä½“å€¼</span></span><br><span class="line">    t = <span class="keyword">new</span>(struct tube);</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– tube åç§°</span></span><br><span class="line">    t-&gt;name[MAX_TUBE_NAME_LEN - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(t-&gt;name, name, MAX_TUBE_NAME_LEN - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;name[MAX_TUBE_NAME_LEN - <span class="number">1</span>] != <span class="string">'\0'</span>) twarnx(<span class="string">"truncating tube name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ready å †ç»´æŠ¤ç€ä¸€äº›å·²ç»å°±ç»ªçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‡å®šæŒ‰ç…§ job ä¼˜å…ˆçº§çš„æ–¹å¼æ¯”è¾ƒå¤§å°</span></span><br><span class="line">    <span class="comment">// è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ job</span></span><br><span class="line">    t-&gt;ready.less = job_pri_less;</span><br><span class="line">    <span class="comment">// delay å †ç»´æŠ¤ç€ä¸€äº›è¢«å»¶è¿Ÿæ‰§è¡Œçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‰ç…§ job delay æ—¶é—´æ¯”è¾ƒå¤§å°</span></span><br><span class="line">    <span class="comment">// è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯å»¶è¿Ÿæ—¶é—´æœ€çŸ­çš„ job</span></span><br><span class="line">    t-&gt;delay.less = job_delay_less;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè®°å½• job åœ¨å †ä¸Šçš„ä½ç½®</span></span><br><span class="line">    t-&gt;ready.rec = job_setheappos;</span><br><span class="line">    t-&gt;delay.rec = job_setheappos;</span><br><span class="line">    t-&gt;buried = (struct job) &#123; &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é“¾è¡¨ç»´æŠ¤ç€è¢« bury æ‰çš„ job</span></span><br><span class="line">    t-&gt;buried.prev = t-&gt;buried.next = &amp;t-&gt;buried;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ’é˜Ÿåˆ—è¡¨</span></span><br><span class="line">    ms_init(&amp;t-&gt;waiting, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾ tube</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">tube_free(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å®é™…å°±æ˜¯ä»å…¨å±€çš„ tubes åˆ—è¡¨ä¸­ç§»é™¤è¯¥ tube</span></span><br><span class="line">    prot_remove_tube(t);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å°±ç»ªçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">free</span>(t-&gt;ready.data);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å»¶è¿Ÿçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">free</span>(t-&gt;delay.data);</span><br><span class="line">    <span class="comment">// æ¸…ç©ºç­‰å¾…åˆ—è¡¨</span></span><br><span class="line">    ms_clear(&amp;t-&gt;waiting);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ tube æŒ‡å‘çš„å†…å­˜</span></span><br><span class="line">    <span class="built_in">free</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨è®¡æ•°ï¼šå‡å¼•ç”¨</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">tube_dref(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;refs &lt; <span class="number">1</span>) <span class="keyword">return</span> twarnx(<span class="string">"refs is zero for tube: %s"</span>, t-&gt;name);</span><br><span class="line"></span><br><span class="line">    --t-&gt;refs;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰å¼•ç”¨åå°±å¯ä»¥é‡Šæ”¾è¯¥ tube äº†</span></span><br><span class="line">    <span class="keyword">if</span> (t-&gt;refs &lt; <span class="number">1</span>) tube_free(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨è®¡æ•°ï¼šå¢åŠ å¼•ç”¨</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">tube_iref(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span>;</span><br><span class="line">    ++t-&gt;refs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å»ºä¸€ä¸ª tubeï¼Œç„¶åæ³¨å†Œåˆ°å…¨å±€ tubes åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">static</span> tube</span><br><span class="line">make_and_insert_tube(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    tube t = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    t = make_tube(name);</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We want this global tube list to behave like "weak" refs, so don't</span></span><br><span class="line"><span class="comment">     * increment the ref count. */</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯æƒ³è®©å…¨å±€ tube åˆ—è¡¨è¡¨ç°ä¸ºå¼±å¼•ç”¨ï¼Œæ‰€è¿™é‡Œå¹¶æ²¡æœ‰åšå¢åŠ å¼•ç”¨çš„æ“ä½œ</span></span><br><span class="line">    r = ms_append(&amp;tubes, t);</span><br><span class="line">    <span class="comment">// å¦‚æœæ³¨å†Œ tube å¤±è´¥ï¼Œå‡å¼•ç”¨ï¼Œå¿…è¦çš„è¯ä¼šè¢«é‡Šæ”¾æ‰</span></span><br><span class="line">    <span class="keyword">if</span> (!r) <span class="keyword">return</span> tube_dref(t), (tube) <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="job-c"><a href="#job-c" class="headerlink" title="job.c"></a>job.c</h3><p>åœ¨ Tube ä¸­æœ‰ä¸¤ä¸ªæœ€å°å †æ•°æ®ç»“æ„åˆ†åˆ«å­˜æ”¾è¢«å»¶è¿Ÿçš„ä»»ä½•å’Œå°±ç»ªçš„ä»»åŠ¡ï¼Œè¿™ä¸¤ç§ä½¿ç”¨çš„æ’åºæ–¹å¼æ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬çœ‹åˆ°åœ¨ä¸Šé¢çš„ Tube åˆå§‹åŒ–æ—¶ï¼Œç»™ä¸¤ä¸ªå †ç»‘å®šäº†ä¸åŒçš„æ¯”è¾ƒå¤§å°çš„å›è°ƒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t-&gt;ready.less = job_pri_less;</span><br><span class="line">t-&gt;delay.less = job_delay_less;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸‹å¯ä»¥çœ‹åˆ°å…·ä½“çš„æ’åºæ–¹å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºä¼˜å…ˆçº§æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">job_pri_less(<span class="keyword">void</span> *ax, <span class="keyword">void</span> *bx)</span><br><span class="line">&#123;</span><br><span class="line">    job a = ax, b = bx;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.pri &lt; b-&gt;r.pri) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.pri &gt; b-&gt;r.pri) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;r.id &lt; b-&gt;r.id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºåˆ°æœŸæ—¶é—´æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">job_delay_less(<span class="keyword">void</span> *ax, <span class="keyword">void</span> *bx)</span><br><span class="line">&#123;</span><br><span class="line">    job a = ax, b = bx;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.deadline_at &lt; b-&gt;r.deadline_at) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.deadline_at &gt; b-&gt;r.deadline_at) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;r.id &lt; b-&gt;r.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="è¯»åæ„Ÿ"><a href="#è¯»åæ„Ÿ" class="headerlink" title="è¯»åæ„Ÿ"></a>è¯»åæ„Ÿ</h1><p>æ•´ä¸ª Beanstalkd çš„æ ¸å¿ƒçš„ä»£ç ä¸è¿‡äº”åƒè¡Œå·¦å³ï¼Œä½†è¿™å°±å®ç°äº†ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œçš„ç¡®æ˜¯å¾ˆå‰å®³ã€‚ä¸è¿‡ï¼Œä¹Ÿæ­£å› ä¸ºå…¶å®ç°æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼ Redis çš„ä¸»ä»æœºåˆ¶ç­‰ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¹¶æ²¡æœ‰å®Œæ•´åœ°å‰–ææ‰€æœ‰çš„æ¨¡å—å®ç°ï¼Œåªæ˜¯åˆ—å‡ºäº†ä¸ªäººæ¯”è¾ƒæ„Ÿå…´è¶£çš„æ¨¡å—ï¼›å…³äº binlog ç®¡ç†çš„æºç ï¼ˆæ¯”å¦‚åƒåœ¾å›æ”¶ï¼Œå‹ç¼©ï¼Œé¢„ç•™ç©ºé—´ç”³è¯·ï¼Œä»»åŠ¡æ¢å¤ç­‰ï¼‰åªæ˜¯ç²—ç•¥åœ°é˜…è¯»äº†ä¸‹ï¼Œå°±ä¸åœ¨æ­¤å¤„çŒ®ä¸‘å•¦~</p>
<p>æ€»çš„æ¥è¯´ï¼Œå¯¹äºå•æœºæ¶ˆæ¯é˜Ÿåˆ—å®ç°æ„Ÿå…´è¶£çš„åŒå­¦è¿˜æ˜¯æ¨èé˜…è¯»ä¸‹è¯¥ç³»ç»Ÿçš„æºç ï¼Œå¯ä»¥å­¦ä¹ å…¶ä¸­çš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œå®ç°æ€è·¯ç­‰~</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://www.hulkdev.com/posts/think_in_beanstalkd" target="_blank" rel="noopener">beanstalkd çš„ä¸€äº›çœ‹æ³•</a></li>
<li><a href="https://github.com/beanstalkd/beanstalkd" target="_blank" rel="noopener">beanstalkd repo</a></li>
<li><a href="https://beanstalkd.github.io/" target="_blank" rel="noopener">beanstalkd docs</a></li>
<li><a href="https://segmentfault.com/a/1190000016067218" target="_blank" rel="noopener">æ¶ˆæ¯é˜Ÿåˆ— beanstalkd æºç è¯¦è§£</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E5%A4%A7%E2%80%94%E6%9C%80%E5%B0%8F%E5%A0%86" target="_blank" rel="noopener">æœ€å¤§â€”æœ€å°å †</a></li>
</ol>
<h1 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h1><ol>
<li><a href="https://www.cnblogs.com/FG123/p/5256553.html" target="_blank" rel="noopener">Kqueue ä¸ Epoll æœºåˆ¶</a></li>
<li><a href="https://juejin.im/entry/59376d450ce4630057427d53" target="_blank" rel="noopener">ä» 0åˆ° 100â€”â€”çŸ¥ä¹æ¶æ„å˜è¿å²</a></li>
</ol>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
    iFaceless
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/" title="Beanstalkd æºç åˆæ¢">http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æºç å­¦ä¹ /" rel="tag"><i class="fa fa-tag"></i> æºç å­¦ä¹ </a>
          
            <a href="/tags/æ¶ˆæ¯é˜Ÿåˆ—/" rel="tag"><i class="fa fa-tag"></i> æ¶ˆæ¯é˜Ÿåˆ—</a>
          
            <a href="/tags/Beanstalkd/" rel="tag"><i class="fa fa-tag"></i> Beanstalkd</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/03/clean-arch-notes-paradigms/" rel="next" title="ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹å­¦ä¹ ç¬”è®°ä¹‹ç¼–ç¨‹èŒƒå¼">
                <i class="fa fa-chevron-left"></i> ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹å­¦ä¹ ç¬”è®°ä¹‹ç¼–ç¨‹èŒƒå¼
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/18/explore-thrift/" rel="prev" title="Thrift åˆæ¢">
                Thrift åˆæ¢ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="iFaceless">
            
              <p class="site-author-name" itemprop="name">iFaceless</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ifaceless" target="_blank" title="GitHub">
                      GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:me#ifaceless.space" target="_blank" title="é‚®ç®±">
                      é‚®ç®±</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://zhuanlan.zhihu.com/0xe8551ccb" target="_blank" title="ä¸“æ ">
                      ä¸“æ </a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                å¸¸ç”¨é“¾æ¥
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xieyuanpeng.com" title="Lingering Fragments" target="_blank">Lingering Fragments</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.acolyer.org/" title="The Morning Paper" target="_blank">The Morning Paper</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.freecodecamp.org" title="freeCodeCamp" target="_blank">freeCodeCamp</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å¼•è¨€"><span class="nav-number">1.</span> <span class="nav-text">å¼•è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Beanstalkd-åˆè¯†"><span class="nav-number">2.</span> <span class="nav-text">Beanstalkd åˆè¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç‰¹ç‚¹"><span class="nav-number">2.1.</span> <span class="nav-text">ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…³é”®è¯"><span class="nav-number">2.2.</span> <span class="nav-text">å…³é”®è¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»»åŠ¡çŠ¶æ€æµè½¬"><span class="nav-number">2.3.</span> <span class="nav-text">ä»»åŠ¡çŠ¶æ€æµè½¬</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ"><span class="nav-number">2.3.1.</span> <span class="nav-text">ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å·¥ä½œæ–¹å¼æè¿°"><span class="nav-number">2.4.</span> <span class="nav-text">å·¥ä½œæ–¹å¼æè¿°</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å®‰è£…"><span class="nav-number">3.</span> <span class="nav-text">å®‰è£…</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç¼–è¯‘-amp-è¿è¡Œ-amp-è°ƒè¯•"><span class="nav-number">4.</span> <span class="nav-text">ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å…³äº-Makefile"><span class="nav-number">4.1.</span> <span class="nav-text">å…³äº Makefile</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹"><span class="nav-number">5.</span> <span class="nav-text">å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç”Ÿäº§è€…"><span class="nav-number">5.1.</span> <span class="nav-text">ç”Ÿäº§è€…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¶ˆè´¹è€…"><span class="nav-number">5.2.</span> <span class="nav-text">æ¶ˆè´¹è€…</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æºç æ¢ç´¢"><span class="nav-number">6.</span> <span class="nav-text">æºç æ¢ç´¢</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¨¡å—åˆ†ç±»å›¾"><span class="nav-number">6.1.</span> <span class="nav-text">æ¨¡å—åˆ†ç±»å›¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¨¡å—-UML-å›¾"><span class="nav-number">6.2.</span> <span class="nav-text">æ¨¡å— UML å›¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åŸºæœ¬æ•°æ®ç»“æ„"><span class="nav-number">6.3.</span> <span class="nav-text">åŸºæœ¬æ•°æ®ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æœ€å°å †"><span class="nav-number">6.3.1.</span> <span class="nav-text">æœ€å°å †</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å˜é•¿æ•°ç»„"><span class="nav-number">6.3.2.</span> <span class="nav-text">å˜é•¿æ•°ç»„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å­—å…¸"><span class="nav-number">6.3.3.</span> <span class="nav-text">å­—å…¸</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é“¾è¡¨"><span class="nav-number">6.3.4.</span> <span class="nav-text">é“¾è¡¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ "><span class="nav-number">6.4.</span> <span class="nav-text">éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-c"><span class="nav-number">6.4.1.</span> <span class="nav-text">main.c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serv-c"><span class="nav-number">6.4.2.</span> <span class="nav-text">serv.c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tube-c"><span class="nav-number">6.4.3.</span> <span class="nav-text">tube.c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#job-c"><span class="nav-number">6.4.4.</span> <span class="nav-text">job.c</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è¯»åæ„Ÿ"><span class="nav-number">7.</span> <span class="nav-text">è¯»åæ„Ÿ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">8.</span> <span class="nav-text">å‚è€ƒ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å»¶ä¼¸é˜…è¯»"><span class="nav-number">9.</span> <span class="nav-text">å»¶ä¼¸é˜…è¯»</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">é»‘ç™½ä¹‹é™¢ï¼ˆiFacelessï¼‰</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
