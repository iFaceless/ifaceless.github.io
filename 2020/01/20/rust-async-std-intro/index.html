<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="referrer" content="no-referrer">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Rust,Async,">





  <link rel="alternate" href="/atom.xml" title="é»‘ç™½ä¹‹é™¢" type="application/atom+xml">






<meta name="description" content="å¼•è¨€æœ€è¿‘æ‰“ç®—åŸºäº Rust async-std é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust async-std å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚ async-std æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ async-std ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª">
<meta name="keywords" content="Rust,Async">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust async-std å…¥é—¨">
<meta property="og:url" content="http://ifaceless.space/2020/01/20/rust-async-std-intro/index.html">
<meta property="og:site_name" content="é»‘ç™½ä¹‹é™¢">
<meta property="og:description" content="å¼•è¨€æœ€è¿‘æ‰“ç®—åŸºäº Rust async-std é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust async-std å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚ async-std æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ async-std ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-01-21T03:45:37.518Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rust async-std å…¥é—¨">
<meta name="twitter:description" content="å¼•è¨€æœ€è¿‘æ‰“ç®—åŸºäº Rust async-std é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust async-std å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚ async-std æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ async-std ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ifaceless.space/2020/01/20/rust-async-std-intro/">





  <title>Rust async-std å…¥é—¨ | é»‘ç™½ä¹‹é™¢</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">é»‘ç™½ä¹‹é™¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Valar Morghulis</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-æ”¶è—">
          <a href="/collection" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-star"></i> <br>
            
            æ”¶è—
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ifaceless.space/2020/01/20/rust-async-std-intro/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iFaceless">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é»‘ç™½ä¹‹é™¢">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Rust async-std å…¥é—¨</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-01-20T18:00:40+08:00">
                2020-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index">
                    <span itemprop="name">Rust</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æ‰“ç®—åŸºäº Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚</p>
<p><a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ <code>async-std</code> ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª <code>task</code> æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ <code>thread</code> æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ <code>async/await</code> é£æ ¼çš„ <code>Mutex</code> åŸè¯­ã€‚</p>
<a id="more"></a>
<p>Rust ä¸­æœ‰ä¸¤ç§ç±»å‹çš„ <code>Future</code>ï¼š</p>
<ol>
<li>æºè‡ª<a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">æ ‡å‡†åº“</a>çš„ <code>std::future::Future</code></li>
<li>æºè‡ª <a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  çš„ <code>futures::future::Future</code></li>
</ol>
<p>èƒŒæ™¯æ˜¯è¿™æ ·çš„ï¼Œ<a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  ä¸­å®šä¹‰çš„ future æ˜¯ Future ç±»å‹æœ€åˆçš„å®ç°ã€‚Rust ä¸ºäº†æ”¯æŒ <code>async/await</code> è¯­æ³•ï¼Œå°±æŠŠæ ¸å¿ƒçš„ <code>trait Future</code> è½¬ç§»åˆ°äº†æ ‡å‡†åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„ <code>std::future::Future</code>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>std::future::Future</code> çœ‹ä½œæ˜¯ <code>futures::future::Future</code> çš„æœ€å°å­é›†ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ä¸¥æ ¼åŒºåˆ† <code>std::future::Future</code> å’Œ <code>futures::future::Future</code>ï¼Œä»¥åŠ <code>async-std</code> æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„ã€‚æ€»çš„æ¥è¯´ï¼Œæ™®é€šçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯ä¸ä¼šå’Œ <code>std::future::Future</code> æ‰“äº¤é“çš„ï¼ˆé™¤äº†ä½¿ç”¨ <code>.await</code> è°ƒç”¨ï¼‰ã€‚é€šå¸¸åªæœ‰å®ç° <code>Future</code> çš„å¼€å‘è€…æ‰ä¼šå…³æ³¨ <code>std::future::Future</code> çš„å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚è¿‡å»å¾ˆå¤šåœ¨ <code>Future</code> ä¸­å®šä¹‰çš„åŠŸèƒ½éƒ½è¢«ç§»åŠ¨åˆ°äº† <code>FuturesExt</code> æ‰©å±• trait ä¸­ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† <code>futures</code> åº“å½“ä½œæ˜¯æ ¸å¿ƒ Rust å¼‚æ­¥åŠŸèƒ½çš„æ‰©å±•ã€‚</p>
<p>é‚£ä¹ˆï¼Œä¸Šé¢ä¸€ç›´æåˆ°çš„ Futures ç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿåˆæ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œ<strong>Futures å°±æ˜¯å¯¹äºä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ä¸€ç§æŠ½è±¡</strong>ï¼Œå®ƒä»¬å…¶å®ä»€ä¹ˆä¹Ÿä¸åšã€‚é‚£ä¹ˆæ€ä¹ˆæ¨è¿›æ‰§è¡Œå¹¶è·å¾—ç»“æœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é æ‰§è¡Œå™¨ <code>executor</code>ï¼Œå®ƒä¼šå†³å®š<strong>ä½•æ—¶</strong>åŠ<strong>å¦‚ä½•</strong>æ‰§è¡Œä½ çš„ Futuresã€‚<code>async-std::task</code> æ¨¡å—å°±ä¸ºæˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ‰§è¡Œå™¨æ¥å£ã€‚</p>
<h1 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h1><p>Rust æœ‰ä¸ªéå¸¸äº®çœ¼çš„ç‰¹æ€§å«<a href="https://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html" target="_blank" rel="noopener">ã€Œæ— è°“å¹¶å‘ã€</a>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨è·å¾—å¹¶å‘ç‰¹æ€§çš„åŒæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰çš„é—®é¢˜ï¼ˆç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥åˆ°æ•°æ®ç«äº‰çš„é—®é¢˜ï¼‰ã€‚</p>
<p>Futures æ˜¯å¯¹<strong>è®¡ç®—</strong>çš„æŠ½è±¡ï¼Œå®ƒä»¬æè¿°äº†ã€Œåšä»€ä¹ˆï¼ˆwhatï¼‰ã€ï¼Œä½†æ˜¯ä¸ã€Œåœ¨å“ªå„¿ï¼ˆwhereï¼‰ã€ã€ã€Œä»€ä¹ˆæ—¶å€™ï¼ˆwhenï¼‰ã€æ‰§è¡Œæ˜¯åˆ†å¼€çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ä»£ç æ‰“æ•£æˆå°æ®µçš„ã€å¯ç»„åˆçš„è¡Œä¸ºï¼Œè¿™æ ·å¯ä»¥ä½œä¸ºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ‰§è¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯<strong>è®¡ç®—</strong>ï¼ˆcompute thingsï¼‰ï¼Œå¹¶æ‰¾åˆ°å¯ä»¥æŠ½è±¡çš„åœ°æ–¹ã€‚</p>
<h2 id="Send-å’Œ-Sync"><a href="#Send-å’Œ-Sync" class="headerlink" title="Send å’Œ Sync"></a>Send å’Œ Sync</h2><p>Rust å®‰å…¨å¹¶å‘ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æŠ½è±¡ï¼ˆMarkersï¼‰ï¼š<code>Send</code> å’Œ <code>Sync</code>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ç®€å•çš„ä»‹ç»ï¼š</p>
<ul>
<li><code>Send</code> æ ‡è®°çš„æ•°æ®ç±»å‹æ˜¯å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªè®¡ç®—ï¼ˆcomputationï¼‰<strong>è½¬ç§»åˆ°ï¼ˆmovedï¼‰</strong>å¦å¤–ä¸€ä¸ªå¹¶å‘è®¡ç®—ï¼ˆæ‰€æœ‰æƒä¹ŸåŒæ ·è¢«è½¬ç§»äº†ï¼Œå‘é€æ–¹å°†ä¸èƒ½å†è®¿é—®å®ƒï¼‰ã€‚</li>
<li><code>Sync</code> æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸­<strong>å…±äº«ï¼ˆsharingï¼‰</strong>æ•°æ®ã€‚</li>
</ul>
<p>ä»¥ä¸Šæ²¡æœ‰ä½¿ç”¨ <code>thread</code> å³çº¿ç¨‹è¿™æ ·çš„å­—çœ¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æŠ½è±¡çš„ <code>computation</code>ã€‚<code>Send</code> å’Œ <code>Sync</code> æœ€å¼ºå¤§çš„ç‰¹ç‚¹åœ¨äºå®ƒä¸ºæˆ‘ä»¬å‡è½»äº†çŸ¥é“å…±äº«ä»€ä¹ˆçš„è´Ÿæ‹…ã€‚åœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¯¹äºç›¸åº”çš„æ•°æ®ç±»å‹é‡‡ç”¨ä»€ä¹ˆåˆ†äº«æ–¹å¼å³å¯ã€‚</p>
<p>å…³äº <code>Send</code> å’Œ <code>Sync</code> çš„ç»„åˆè¿˜æœ‰æ›´å¤šæœ‰è¶£çš„ç‰¹æ€§ï¼Œå¯ä»¥å‚è€ƒ <a href="https://doc.rust-lang.org/stable/book/ch16-04-extensible-concurrency-sync-and-send.html" target="_blank" rel="noopener">Rust Book</a> äº†è§£æ›´å¤šã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"><a href="#ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰" class="headerlink" title="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"></a>ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰</h2><p>æ‰€è°“çš„è®¡ç®—ï¼ˆcomputationï¼‰æ˜¯æŒ‡ä¸€ä¸ªå¯ç»„åˆçš„æ“ä½œåºåˆ—ï¼Œå¯ä»¥åŸºäºå†³ç­–åˆ†æ”¯ï¼Œå¯ä»¥ä¸€ç›´æ¨è¿›è¿è¡Œåˆ°ç»“æŸï¼Œæœ€ç»ˆè¿”å›ç»“æœæˆ–è€…é”™è¯¯ã€‚</p>
<h2 id="å»¶è¿Ÿè®¡ç®—"><a href="#å»¶è¿Ÿè®¡ç®—" class="headerlink" title="å»¶è¿Ÿè®¡ç®—"></a>å»¶è¿Ÿè®¡ç®—</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œ<code>Send</code> å’Œ <code>Sync</code> éƒ½æ˜¯æè¿°æ•°æ®çš„ï¼›ä½†åº”ç”¨ç¨‹åºå¯ä¸æ­¢æ•°æ®ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“å¦‚ä½•è®¡ç®—å‡ºæ•°æ®ï¼Œç”±æ­¤å¼•å…¥äº† <code>Futures</code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>Futures</code> æ˜¯æ€ä¹ˆå…è®¸æˆ‘ä»¬ç”¨è‡ªç„¶è¯­è¨€è¡¨è¾¾è¦åšçš„äº‹æƒ…çš„ï¼Œ<code>Futures</code> ä»è¿™æ ·çš„è®¡åˆ’ï¼š</p>
<ul>
<li>Do X</li>
<li>If X succeeded, do Y</li>
</ul>
<p>å˜æˆäº†ï¼š</p>
<ul>
<li>Start doing X</li>
<li>Once X succeeds, start doing Y</li>
</ul>
<p>ç›¸æ¯”äºå‘Šè¯‰è®¡ç®—æœºè¦åšä»€ä¹ˆï¼Œå¹¶ä¸”æ ¹æ®å½“å‰ç»“æœå†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼›å»¶è¿Ÿè®¡ç®—å°±æ˜¯è®©æˆ‘ä»¬å‘Šè¯‰è®¡ç®—æœºè¦å¼€å§‹åšä»€ä¹ˆï¼Œå¹¶å“åº”<strong>æœªæ¥</strong>å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶ã€‚</p>
<h2 id="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"><a href="#ä»ç®€å•çš„ä¾‹å­å¼€å§‹" class="headerlink" title="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"></a>ä»ç®€å•çš„ä¾‹å­å¼€å§‹</h2><p>ä¸‹é¢çš„ä¾‹å­æ˜¯ä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents)?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œä¹Ÿå¾ˆç›´è§‚ã€‚é—®é¢˜æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œæ§åˆ¶æƒå°±ä¼šè½¬ç§»è‡³è¢«è°ƒç”¨çš„å‡½æ•°ç›´åˆ°å…¶è¿”å›ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸Šè¿°è¿”å›å€¼æè¿°çš„æ˜¯è¿‡å»ã€‚è€Œè¿‡å»å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæ‰€æœ‰çš„å†³ç­–éƒ½å·²ç»ç¡®å®šäº†ã€‚ä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜ç‚¹ï¼šè¿”å›çš„ç»“æœå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç¨‹åºè¿‡å»è®¡ç®—çš„ç»“æœè§£åŒ…ï¼ˆunwrapï¼‰å‡ºæ¥ï¼Œç„¶åå†³å®šå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p>
<p>ä½†æˆ‘ä»¬è¿˜æ˜¯æƒ³è¦æŠ½è±¡è®¡ç®—ï¼Œå¹¶è®©åˆ«äººé€‰æ‹©å¦‚ä½•è¿è¡Œå®ƒã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ç±»å‹ï¼Œå¯ä»¥æè¿°è®¡ç®—è¿‡ç¨‹ï¼Œä½†æ˜¯åˆä¸æ‰§è¡Œå®ƒã€‚ğŸ‘† ä¸Šé¢çš„å‡½æ•°åªèƒ½è®©æˆ‘ä»¬åœ¨è°ƒç”¨å‰æˆ–è€…è°ƒç”¨åæ‰§è¡Œæ“ä½œã€‚è¿™å…¶å®å¹¶éé¢„æœŸçš„ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨åœ¨è¿è¡Œçš„æ—¶å€™åšç‚¹åˆ«çš„äº‹æƒ…ï¼ˆå®é™…ä¸Šå°±æ˜¯èƒ½å¤Ÿæ‰“æ–­æ‰§è¡Œæµï¼‰ã€‚å½“åœ¨å¹¶è¡Œç¼–ç¨‹æ—¶ï¼Œè¿™ä¹Ÿå‰¥å¤ºäº†æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡è¿è¡Œæ—¶å¯åŠ¨å¦å¤–ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡çš„èƒ½åŠ›ï¼ˆè¿™æ—¶æ§åˆ¶æƒå·²ç»è½¬ç§»ç»™æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°äº†ï¼‰ã€‚</p>
<p>æ­¤å¤„è™½ç„¶å¯ä»¥å¼•å…¥çº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æœ¬èº«æ˜¯éå¸¸ç‰¹å®šçš„å¹¶å‘åŸè¯­ï¼Œè€Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾çš„æ˜¯ä¸€ç§<strong>æŠ½è±¡</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ ·çš„æŠ½è±¡å°±æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªè¿›è¡Œä¸­çš„å·¥ä½œï¼Œä¼šåœ¨æœªæ¥äº§ç”Ÿç»“æœã€‚ä¸‹é¢çœ‹çœ‹éå®Œæ•´å®šä¹‰çš„ <code>Future</code> traitï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Future</span></span> &#123;</span><br><span class="line">    <span class="comment">// Ouput æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œè¡¨ç¤ºè¾“å‡ºç»“æœçš„æ³›å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span>;</span><br><span class="line">    <span class="comment">// poll æ–¹æ³•ä¼šè¿”å›å½“å‰è®¡ç®—çš„çŠ¶æ€ï¼Œpoll æ–¹æ³•ä¼šè¿”å›ä¸¤ç§ç»“æœï¼š</span></span><br><span class="line">    <span class="comment">// 1. `Poll::Ready`ï¼Œè¡¨ç¤ºè®¡ç®—ç»“æŸ</span></span><br><span class="line">    <span class="comment">// 2. `Poll::Pending`ï¼Œè¡¨ç¤ºè®¡ç®—å°šæœªç»“æŸ</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context) -&gt; Poll&lt;Self::Output&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>poll()</code> æ–¹æ³•æ£€æŸ¥ <code>Future</code> æ˜¯å¦å®Œæˆï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™è¿”å›å¯¹åº”çš„ç»“æœã€‚æ˜¾ç„¶ï¼Œæœ€ç®€å•çš„æœºåˆ¶å°±æ˜¯åœ¨å¾ªç¯ä¸­ä¸æ–­è½®è¯¢ï¼›ä¸è¿‡æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æˆç†Ÿçš„ runtime æ¥æ‰§è¡Œã€‚<em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>poll()</code> è¿”å› <code>Poll::Ready</code> åï¼Œç»§ç»­è°ƒç”¨å¯èƒ½ä¼šæœ‰ä»¤äººå›°æƒ‘çš„è¡Œä¸ºäº§ç”Ÿï¼Œå…·ä½“å¯ä»¥å‚è§ <a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">futures-docs</a></em>ã€‚</p>
<h2 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h2><p>å®é™…ä¸Š <code>Future</code> åœ¨ Rust ä¸­å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´äº†ï¼Œåªæ˜¯ç›´æ¥æ„å»ºå’Œæè¿°å®ƒä»¬æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œ<code>async</code> å…³é”®è¯å°±æ˜¯æˆ‘ä»¬çš„æ•‘æ˜Ÿï¼Œä¸‹é¢çš„ä¾‹å­ä¸­æ¼”ç¤ºäº† <code>async-std</code> æ­é… <code>async/await</code> é‡æ„ä¸Šé¢çš„å‡½æ•°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async æ ‡è®°å‡½æ•°ä½“æ˜¯ä¸€ä¸ªå»¶è¿Ÿè®¡ç®—å¯¹è±¡ï¼Œå½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª `Future&lt;Output = io::Result&lt;string&gt;&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">// è¯¥å€¼å¹¶éç«‹å³è¿”å›çš„ç»“æœ `io::Result&lt;String&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">//ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯äº§ç”Ÿäº†å®ç°äº† `Future&lt;Output = io::Result&lt;String&gt;&gt;` çš„ç±»å‹ï¼‰ã€‚</span></span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="await-å¹²äº†ä»€ä¹ˆ"><a href="#await-å¹²äº†ä»€ä¹ˆ" class="headerlink" title=".await å¹²äº†ä»€ä¹ˆ"></a><code>.await</code> å¹²äº†ä»€ä¹ˆ</h2><p>é¡¾åæ€ä¹‰ï¼Œ<code>.await</code> è¡¨ç¤ºç­‰å¾…è¯·æ±‚è¡Œä¸ºï¼ˆrequested actionï¼‰ç›´åˆ°å®Œæˆï¼Œç„¶åæ‰ä¼šç»§ç»­åç»­çš„æ‰§è¡Œã€‚å‡†ç¡®çš„æ¥è¯´ï¼Œ<code>.await</code> æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºæ­¤å¤„çš„ä»£ç å°†ä¼šç­‰å¾…ç›´åˆ° <code>Future</code> äº§ç”Ÿç»“æœã€‚è‡³äº Future æ˜¯æ€ä¹ˆç»“æŸçš„ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚<code>.await</code> ä¼šè®©è¿è¡Œæ—¶æŒæ§è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œè‡³äºåœ¨è®¡ç®—ç»“æŸæ—¶è¦æ‰§è¡Œå“ªäº›æ“ä½œéƒ½ç”±è¿è¡Œæ—¶æ¥æ“å¿ƒã€‚å½“ä½ ç¼–å†™çš„æ“ä½œåœ¨åå°å®Œæˆæ—¶ï¼Œå®ƒä¼šå›åˆ°æ ‡è®°ç‚¹ï¼Œç»§ç»­åç»­çš„æ“ä½œã€‚æ‰€ä»¥è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¸º <strong>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆevented programmingï¼‰</strong>ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç­‰å¾…æŸäº›äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶ï¼‰ï¼Œå¹¶æ®æ­¤ä½œå‡ºå“åº”ï¼ˆæ¯”å¦‚å¼€å§‹è¯»å–å†…å®¹ï¼‰ã€‚</p>
<p>å½“æœ‰ 2 ä¸ªåŠä»¥ä¸Šè¿™æ ·çš„å‡½æ•°åœ¨åŒæ—¶è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„è¿è¡Œæ—¶ç³»ç»Ÿå°±èƒ½å¤Ÿå¤„ç†å½“å‰æ‰€æœ‰è¿›è¡Œçš„äº‹ä»¶äº†ï¼Œé¿å…äº†å‚»å‚»åœ°ç­‰å¾…ã€‚</p>
<h1 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h1><p>æˆ‘ä»¬å·²ç»çŸ¥é“ä»€ä¹ˆæ˜¯ Futures äº†ï¼Œé‚£å…·ä½“æ€ä¹ˆè¿è¡Œå®ƒä»¬å‘¢ï¼Ÿè¿™å°±æ˜¯æ¥ä¸‹æ¥è¦ä»‹ç»çš„ <code>tasks</code> æ¨¡å—è¦åšçš„äº‹æƒ…ã€‚ä¸‹é¢çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::&#123;fs::File, io, prelude::*, task&#125;;</span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file: File = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// `spawn` æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `Future`ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œå®ƒã€‚</span></span><br><span class="line">    <span class="comment">// è¯¥å‡½æ•°ä¼šè¿”å› `JoinHanle`ã€‚</span></span><br><span class="line">    <span class="keyword">let</span> reader_task = task::spawn(async &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å—ï¼Œå¿…é¡»è¦ä½¿ç”¨å¼‚æ­¥å—æ‰èƒ½è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼ŒåŒæ—¶</span></span><br><span class="line">        <span class="comment">// ä¹Ÿä¼šå¼•å¯¼ç¼–è¯‘å™¨å°†æ‰€æœ‰ç›¸å…³çš„æŒ‡ä»¤åŒ…å«è¿›æ¥ã€‚Rust ä¸­æ‰€æœ‰çš„å—</span></span><br><span class="line">        <span class="comment">// éƒ½ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œ `async` å—åˆ™è¿”å›çš„æ˜¯ç±»å‹ä¸º </span></span><br><span class="line">        <span class="comment">// `Future` çš„å€¼</span></span><br><span class="line">        <span class="keyword">let</span> result = read_file(<span class="string">"data.csv"</span>).await;</span><br><span class="line">        <span class="keyword">match</span> result &#123;</span><br><span class="line">            <span class="literal">Ok</span>(s) =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, s),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">"Error reading &#123;:?&#125;"</span>, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Started task!"</span>);</span><br><span class="line">    task::block_on(reader_task);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Stopped task!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Rust çš„ Futures æœ‰æ—¶ä¹Ÿå«ã€Œå†·ï¼ˆcoldï¼‰ã€Futuresï¼Œä½ éœ€è¦è¿è¡Œå®ƒä»¬çš„ä¸œè¥¿ã€‚ä¸ºäº†è¿è¡Œä¸€ä¸ª Futureï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„è®°è´¦å·¥å…·ï¼šæ¯”å¦‚å½“å‰ Future æ˜¯å¦åœ¨è¿è¡Œä¸­è¿˜æ˜¯å·²ç»ç»“æŸï¼Œåœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå½“å‰çš„çŠ¶æ€ã€‚è¿™ç§è®°è´¦é€»è¾‘å°±è¢«æŠ½è±¡åˆ°äº† <code>Task</code> ä¸­ã€‚</p>
<p><code>Task</code> ç±»ä¼¼äº <code>Thread</code>ï¼Œä½†ä¹Ÿæœ‰äº›è®¸ä¸åŒï¼šå®ƒæ˜¯ç”±åº”ç”¨ç¨‹åºï¼ˆç”¨æˆ·ç©ºé—´ï¼‰è¢«è°ƒåº¦ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ä¼šæ„ŸçŸ¥ï¼›ä¸€æ—¦åˆ°äº†æŸä¸ªç‚¹éœ€è¦ç­‰å¾…ï¼Œåº”ç”¨ç¨‹åºè‡ªå·±éœ€è¦è´Ÿè´£å”¤é†’ä»»åŠ¡ã€‚<code>async_std</code> çš„ä»»åŠ¡å¯ä»¥æ‹¥æœ‰åç§°å’Œ IDã€‚</p>
<p>å½“é€šè¿‡ <code>spawn</code> ç”Ÿæˆä»»åŠ¡åï¼Œä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¿”å›çš„ <code>JoinHandle</code> æœ¬èº«æ˜¯ä¸€ä¸ª Futureï¼Œå®ƒä¼šåœ¨ <code>Task</code> è¿è¡Œç»“æŸåï¼ˆrun to conclusionï¼‰ä¹Ÿä¼šç»“æŸã€‚ç±»ä¼¼ <code>threads</code> å’Œ <code>join</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å¯¹ <code>JoinHandle</code> è°ƒç”¨ <code>block_on</code> å‡½æ•°ï¼Œä»è€Œé˜»å¡ç¨‹åºï¼ˆå‡†ç¡®æ¥è¯´æ˜¯è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ï¼‰ç›´åˆ°å…¶è¿è¡Œç»“æŸã€‚</p>
<h2 id="Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"><a href="#Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ" class="headerlink" title="Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"></a>Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ</h2><p>é€šè¿‡ç®€å•é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/block_on.rs#L129" target="_blank" rel="noopener">src/task/block_on.rs</a> çœ‹åˆ°æ‰§è¡Œçš„é€»è¾‘ï¼Œå½“ Task è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„  <code>run</code> å‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè¿›è€Œæ¨è¿› Future ä¸­çš„è®¡ç®—é€»è¾‘ç›´åˆ°å®Œæˆï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Blocks the current thread on a future's result.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F, T&gt;(future: F) -&gt; T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: Future&lt;Output = T&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    CACHE.with(|cache| &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Poll::Ready(t) = future.as_mut().poll(cx) &#123;</span><br><span class="line">                <span class="comment">// Save the parker for the next invocation of `block`.</span></span><br><span class="line">                cache.set(<span class="literal">Some</span>(arc_parker));</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Yield a few times or park the current thread.</span></span><br><span class="line">            <span class="keyword">if</span> step &lt; <span class="number">3</span> &#123;</span><br><span class="line">                thread::yield_now();</span><br><span class="line">                step += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                arc_parker.park();</span><br><span class="line">                step = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"><a href="#JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ" class="headerlink" title="JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"></a>JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ</h2><p>ç¿»é˜… <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/join_handle.rs#L15" target="_blank" rel="noopener">src/task/join_handle.rs</a> æºç å¾—çŸ¥ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°äº† <code>Future trait</code> çš„å¯¹è±¡ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;T&gt;(async_task::JoinHandle&lt;T, Task&gt;);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Future <span class="keyword">for</span> JoinHandle&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = T;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">mut</span> <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> Pin::new(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>).poll(cx) &#123;</span><br><span class="line">            Poll::Pending =&gt; Poll::Pending,</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ Noneï¼Œè¡¨ç¤ºä»»åŠ¡ panic æˆ–è€…è¢«å–æ¶ˆäº†</span></span><br><span class="line">            Poll::Ready(<span class="literal">None</span>) =&gt; <span class="built_in">panic!</span>(<span class="string">"cannot await the result of a panicked task"</span>),</span><br><span class="line">            <span class="comment">// å½“ä»»åŠ¡ç»“æŸï¼Œè‡ªç„¶ä¼šæ‹¿åˆ°å…·ä½“ç»“æœ</span></span><br><span class="line">            Poll::Ready(<span class="literal">Some</span>(val)) =&gt; Poll::Ready(val),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>async_std</code> ä¸­çš„ <code>JoinHandle</code> å®é™…æ˜¯å¯¹ <code>async_task::JoinHandle</code> çš„åŒ…è£…ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥çœ‹ä¸‹å…·ä½“æ˜¯æ€ä¹ˆä» Task ä¸­å–åˆ°ç»“æœçš„ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async-task-1.1.0/src/join_handle.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A handle that awaits the result of a task.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// * `None` è¡¨ç¤ºä»»åŠ¡è¢«å–æ¶ˆæˆ–è€… panic äº†</span></span><br><span class="line"><span class="comment">/// * `Some(result)` è¡¨ç¤ºä»»åŠ¡ç»“æŸï¼Œè¿”å›çš„ç»“æœ `result` ç±»å‹ä¸º `R`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="comment">/// A raw task pointer.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) raw_task: NonNull&lt;()&gt;,</span><br><span class="line">    <span class="comment">/// A marker capturing generic types `R` and `T`.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) _marker: PhantomData&lt;(R, T)&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Future <span class="keyword">for</span> JoinHandle&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = <span class="built_in">Option</span>&lt;R&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="keyword">self</span>.raw_task.as_ptr();</span><br><span class="line">        <span class="keyword">let</span> header = ptr <span class="keyword">as</span> *<span class="keyword">const</span> Header;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> state = (*header).state.load(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="comment">// If the task has been closed, notify the awaiter and return `None`.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; CLOSED != <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> Poll::Ready(<span class="literal">None</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// If the task is not completed, register the current task.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; COMPLETED == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»»åŠ¡å®Œæˆï¼Œæå–ç»“æœ</span></span><br><span class="line">                <span class="keyword">match</span> (*header).state.compare_exchange(</span><br><span class="line">                    state,</span><br><span class="line">                    state | CLOSED,</span><br><span class="line">                    Ordering::AcqRel,</span><br><span class="line">                    Ordering::Acquire,</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                        <span class="comment">// ä»è¿™é‡ŒæŠŠä»»åŠ¡ç»“æœè·å–å‡ºæ¥ï¼ˆæŒº Hack çš„ï¼‰ï¼Œå°±æ˜¯ä¸‹é¢çš„ output.read()</span></span><br><span class="line">                        <span class="keyword">let</span> output = ((*header).vtable.get_output)(ptr) <span class="keyword">as</span> *<span class="keyword">mut</span> R;</span><br><span class="line">                        <span class="keyword">return</span> Poll::Ready(<span class="literal">Some</span>(output.read()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Err</span>(s) =&gt; state = s,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="async-std-ä¸­çš„-Task"><a href="#async-std-ä¸­çš„-Task" class="headerlink" title="async_std ä¸­çš„ Task"></a>async_std ä¸­çš„ Task</h2><p>Task æ˜¯ <code>async_std</code> ä¸­æœ€æ ¸å¿ƒçš„æŠ½è±¡ä¹‹ä¸€ï¼Œå’Œ Rust ä¸­çš„ <code>thread</code> ç±»ä¼¼ã€‚<code>Tasks</code> å’Œè¿è¡Œæ—¶è™½ç„¶ä¹Ÿæœ‰å…³è”ï¼Œä½†å®ƒä»¬æ˜¯åˆ†å¼€çš„ã€‚<code>async_std</code> Task æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li>æ‰€æœ‰ä»»åŠ¡æ˜¯å•æ¬¡åˆ†é…çš„ï¼ˆin one single allocationï¼‰ï¼›</li>
<li>æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª <code>backchannel</code>ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ <code>JoinHandle</code> å°†ç»“æœå’Œé”™è¯¯ä¼ é€’åˆ°å¯¹åº”çš„ä»»åŠ¡ï¼ˆspawning taskï¼‰ï¼›</li>
<li>å®ƒä»¬æºå¸¦ç”¨äºè°ƒè¯•çš„å…ƒä¿¡æ¯ï¼›</li>
<li>å®ƒä»¬æ”¯æŒ ä»»åŠ¡çº§åˆ«çš„ local storageã€‚</li>
</ul>
<p><code>async_std</code> ä»»åŠ¡ API ä¼šå¤„ç†èƒŒåçš„ runtime åˆå§‹åŒ–ï¼ˆsetupï¼‰å’Œæ¸…ç†ï¼ˆteardownï¼‰å·¥ä½œï¼Œä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼åœ°å¯åŠ¨è¿è¡Œæ—¶ï¼ˆè¿™ä¸ªå’Œ Python 3 æœ‰ä¸¢ä¸¢åŒºåˆ«ï¼‰ã€‚</p>
<h2 id="é˜»å¡ï¼ˆBlockingï¼‰"><a href="#é˜»å¡ï¼ˆBlockingï¼‰" class="headerlink" title="é˜»å¡ï¼ˆBlockingï¼‰"></a>é˜»å¡ï¼ˆBlockingï¼‰</h2><p>ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸º Tasks éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¯èƒ½å®ƒä»¬ä¼šå…±äº«åŒä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆåœ¨è¯¥çº¿ç¨‹ä¸Šåˆ‡æ¢ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚è¿™åŒæ—¶ä¹Ÿæ„å‘³ç€å¦‚æœåœ¨æŸä¸ªæ‰§è¡Œçº¿ç¨‹ä¸Šè°ƒç”¨äº†é˜»å¡ APIï¼ˆæ¯”å¦‚ <code>std::thread::sleep</code> æˆ–è€…æ ‡å‡†åº“çš„ IO å‡½æ•°ï¼‰ï¼Œä¼šå¯¼è‡´å¯¹åº”æ‰§è¡Œçº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´<strong>è¯¥æ‰§è¡Œçº¿ç¨‹ä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½åœæ­¢è¿è¡Œäº†</strong>ã€‚å…¶å®ƒçš„ä¸€äº›åº“ï¼ˆå¦‚ db driversï¼‰ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„è¡Œä¸ºã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé˜»å¡å½“å‰çº¿ç¨‹æœ¬èº«å¹¶éåäº‹æƒ…ï¼Œåªæ˜¯ä¸è¦å’Œ <code>async_std</code> å¹¶å‘æ‰§è¡Œçš„æ¨¡å‹ææ··æ·†å³å¯ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿™æ ·åšï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="comment">//  æ ‡å‡†åº“ std::fsï¼Œä¼šå¯¼è‡´é˜»å¡</span></span><br><span class="line">        std::fs::read_to_string(<span class="string">"test_file"</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœéœ€è¦æ··åˆé˜»å¡ API è°ƒç”¨ï¼Œå»ºè®®å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ ·çš„é˜»å¡æ“ä½œã€‚</p>
<h2 id="å…³äºé”™è¯¯å’Œ-Panic"><a href="#å…³äºé”™è¯¯å’Œ-Panic" class="headerlink" title="å…³äºé”™è¯¯å’Œ Panic"></a>å…³äºé”™è¯¯å’Œ Panic</h2><p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå¦‚æœä»»åŠ¡å¯èƒ½å‡ºé”™ï¼Œé‚£ä¹ˆä»»åŠ¡çš„è¾“å‡º <code>Output</code> åº”è¯¥æ˜¯  <code>Result&lt;T, E&gt;</code> ç±»å‹ã€‚ä½†æ˜¯åœ¨ <code>panic</code> çš„æ—¶å€™ï¼Œå…·ä½“çš„è¡¨ç°åˆ™å–å†³äºæœ‰æ²¡æœ‰åˆç†å¤„ç† panic çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šé€€å‡ºã€‚</p>
<p>å®è·µä¸­ï¼Œæ„å‘³ç€ <code>block_on</code> ä¼šä¼ é€’ panic åˆ°é˜»å¡è°ƒç”¨çš„åœ°æ–¹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        panic!(&quot;test&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br></pre></td></tr></table></figure></p>
<p>è€Œå¯¹äº spwan å‡ºå»çš„ä»»åŠ¡å¦‚æœ panicï¼Œåˆ™ä¼šå¯¼è‡´é€€å‡ºï¼ˆabortï¼‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task::spawn(async &#123;</span><br><span class="line">    panic!(&quot;test&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task::block_on(async &#123;</span><br><span class="line">    task::sleep(Duration::from_millis(10000)).await;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„è¡Œä¸ºæœ€åˆçœ‹ä¸Šå»æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¦å¤–ä¸€ç§é€‰é¡¹æ˜¯å¯¹äº spawn å‡ºå»çš„ä»»åŠ¡å¦‚æœå‘ç”Ÿ panicï¼Œåˆ™ç®€å•å¿½ç•¥æ‰ã€‚å½“å‰çš„è¡Œä¸ºå¯ä»¥è¢«ä¿®æ”¹ä¸ºæ•è· spawn å‡ºå»çš„ä»»åŠ¡ä¸­å‘ç”Ÿçš„ panicï¼Œå¹¶ä¸”æ ¹æ®ä¸åŒçš„æƒ…å†µåšå‡ºä¸åŒçš„å“åº”ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦é‡‡å–ä¸åŒçš„ panic å¤„ç†ç­–ç•¥ã€‚</p>
<h1 id="æ›´å¤šç¤ºä¾‹"><a href="#æ›´å¤šç¤ºä¾‹" class="headerlink" title="æ›´å¤šç¤ºä¾‹"></a>æ›´å¤šç¤ºä¾‹</h1><p>åœ¨ <a href="https://github.com/async-rs/async-std/tree/master/examples" target="_blank" rel="noopener">è¿™é‡Œ</a> æœ‰ä¸å°‘ç¤ºä¾‹ä»£ç å¯ä»¥å‚è€ƒï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ UDP å®¢æˆ·ç«¯ä¾‹å­ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::io;</span><br><span class="line"><span class="keyword">use</span> async_std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> async_std::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="keyword">let</span> socket = UdpSocket::bind(<span class="string">"127.0.0.1:8081"</span>).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Listening on &#123;&#125;"</span>, socket.local_addr()?);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> msg = <span class="string">"hello world"</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&lt;- &#123;&#125;"</span>, msg);</span><br><span class="line">        socket.send_to(msg.as_bytes(), <span class="string">"127.0.0.1:8080"</span>).await?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> buf = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">let</span> (n, _) = socket.recv_from(&amp;<span class="keyword">mut</span> buf).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"-&gt; &#123;&#125;\n"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;buf[..n]));</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://book.async.rs/introduction.html" target="_blank" rel="noopener">Async programming in Rust with async-std</a></li>
<li><a href="https://rust-lang.github.io/async-book/" target="_blank" rel="noopener">Asynchronous Programming in Rust</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
    iFaceless
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="http://ifaceless.space/2020/01/20/rust-async-std-intro/" title="Rust async-std å…¥é—¨">http://ifaceless.space/2020/01/20/rust-async-std-intro/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Rust/" rel="tag"><i class="fa fa-tag"></i> Rust</a>
          
            <a href="/tags/Async/" rel="tag"><i class="fa fa-tag"></i> Async</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/15/elasticsearch-intro/" rel="next" title="åˆè¯† Elasticsearch">
                <i class="fa fa-chevron-left"></i> åˆè¯† Elasticsearch
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/02/go-rest-api-for-beginners/" rel="prev" title="Go RESTful API é¡¹ç›®æ¨¡æ¿ä»‹ç»">
                Go RESTful API é¡¹ç›®æ¨¡æ¿ä»‹ç» <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="iFaceless">
            
              <p class="site-author-name" itemprop="name">iFaceless</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ifaceless" target="_blank" title="GitHub">
                      GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:me#ifaceless.space" target="_blank" title="é‚®ç®±">
                      é‚®ç®±</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://zhuanlan.zhihu.com/0xe8551ccb" target="_blank" title="ä¸“æ ">
                      ä¸“æ </a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                å¸¸ç”¨é“¾æ¥
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xieyuanpeng.com" title="Lingering Fragments" target="_blank">Lingering Fragments</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.acolyer.org/" title="The Morning Paper" target="_blank">The Morning Paper</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.freecodecamp.org" title="freeCodeCamp" target="_blank">freeCodeCamp</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://draveness.me/" title="Draveness's Blog" target="_blank">Draveness's Blog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å¼•è¨€"><span class="nav-number">1.</span> <span class="nav-text">å¼•è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Futures"><span class="nav-number">2.</span> <span class="nav-text">Futures</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Send-å’Œ-Sync"><span class="nav-number">2.1.</span> <span class="nav-text">Send å’Œ Sync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"><span class="nav-number">2.2.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å»¶è¿Ÿè®¡ç®—"><span class="nav-number">2.3.</span> <span class="nav-text">å»¶è¿Ÿè®¡ç®—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»ç®€å•çš„ä¾‹å­å¼€å§‹"><span class="nav-number">2.4.</span> <span class="nav-text">ä»ç®€å•çš„ä¾‹å­å¼€å§‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Async"><span class="nav-number">2.5.</span> <span class="nav-text">Async</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#await-å¹²äº†ä»€ä¹ˆ"><span class="nav-number">2.6.</span> <span class="nav-text">.await å¹²äº†ä»€ä¹ˆ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tasks"><span class="nav-number">3.</span> <span class="nav-text">Tasks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"><span class="nav-number">3.1.</span> <span class="nav-text">Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"><span class="nav-number">3.2.</span> <span class="nav-text">JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#async-std-ä¸­çš„-Task"><span class="nav-number">3.3.</span> <span class="nav-text">async_std ä¸­çš„ Task</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é˜»å¡ï¼ˆBlockingï¼‰"><span class="nav-number">3.4.</span> <span class="nav-text">é˜»å¡ï¼ˆBlockingï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…³äºé”™è¯¯å’Œ-Panic"><span class="nav-number">3.5.</span> <span class="nav-text">å…³äºé”™è¯¯å’Œ Panic</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ›´å¤šç¤ºä¾‹"><span class="nav-number">4.</span> <span class="nav-text">æ›´å¤šç¤ºä¾‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">é»‘ç™½ä¹‹é™¢ï¼ˆiFacelessï¼‰</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
