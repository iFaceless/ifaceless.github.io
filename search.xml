<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Rust é”™è¯¯å¤„ç†]]></title>
    <url>%2F2020%2F06%2F02%2Frust-error-handling%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ æœ¬æ–‡å†…å®¹ä¸»è¦ç¿»è¯‘è‡ª Andrew Gallant çš„æ–‡ç«  Error Handling in Rustã€‚ å¦‚åŒå¤§å¤šæ•°çš„ç¼–ç¨‹è¯­è¨€ï¼ŒRust ä¸­ä¹Ÿéœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹å¼å¤„ç†é”™è¯¯ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œç›®å‰å¸¸è§çš„é”™è¯¯å¤„ç†æ–¹å¼ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š å¼‚å¸¸æœºåˆ¶ï¼ˆC#/Java/Python ç­‰ï¼‰ï¼› è¿”å›é”™è¯¯ï¼ˆGo/Rust ç­‰ï¼‰ã€‚ æœ¬æ–‡å°†ä¼šç»¼åˆå…¨é¢åœ°ä»‹ç» Rust ä¸­çš„é”™è¯¯å¤„ç†ï¼Œé€šè¿‡å¾ªåºæ¸è¿›åœ°å¼•å¯¼ï¼Œå¸¦é¢†åˆå­¦è€…æ‰å®åœ°æŒæ¡è¿™å—çŸ¥è¯†ã€‚å¦‚æœæˆ‘ä»¬ä¸ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨è¾ƒä¸ºæ„šè ¢çš„æ–¹å¼å¤„ç†é”™è¯¯ï¼Œè¿™ç§ä¼šæ¯”è¾ƒç¹çï¼Œäº§ç”Ÿå¾ˆå¤šæ ·æ¿ä»£ç ã€‚æ‰€ä»¥æœ¬æ–‡ä¼šæ¼”ç¤ºå¦‚ä½•å€ŸåŠ©æ ‡å‡†åº“è®©é”™è¯¯å¤„ç†æ›´åŠ ä¼˜é›…å’Œç®€æ´ã€‚ è¯´æ˜æœ¬æ–‡çš„ä»£ç æ”¾åœ¨ä½œè€…çš„ åšå®¢ä»“åº“ã€‚Rust Book, Error Handling ä¸­ä¹Ÿæœ‰å…³äºé”™è¯¯å¤„ç†çš„éƒ¨åˆ†ï¼Œå¯ä»¥å‚ç…§é˜…è¯»ã€‚ æœ¬æ–‡ç¯‡å¹…å·¨é•¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†™äº†å¾ˆå¤šå…³äº Sum Types å’Œç»„åˆå­ï¼ˆCombinatorsï¼‰çš„å†…å®¹ä½œä¸ºå¼€å¤´ï¼Œé€æ­¥è®²è§£ Rust é”™è¯¯å¤„ç†æ–¹å¼çš„æ”¹è¿›ã€‚å› æ­¤ï¼Œå¦‚æœä½ è®¤ä¸ºæ²¡æœ‰å¿…è¦çš„è¯ï¼Œä¹Ÿå¯ä»¥ç•¥è¿‡ã€‚ä»¥ä¸‹æ˜¯ä½œè€…æä¾›çš„ç®€è¦æŒ‡å—ï¼š å¦‚æœä½ æ˜¯ Rust æ–°æ‰‹ï¼Œå¯¹äºç³»ç»Ÿç¼–ç¨‹å’Œå¯Œç±»å‹ç³»ç»Ÿï¼ˆexpressive type systemsï¼‰ä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œæ¨èä½ ä»å¤´å¼€å§‹é˜…è¯»ï¼ˆå¦‚æœæ˜¯å®Œå…¨æ²¡æœ‰äº†è§£è¿‡ Rust çš„ç«¥é‹ï¼Œæ¨èå…ˆé˜…è¯»ä¸‹ [Rust Book](https://doc.rust-lang.org/book/title-page.htmlï¼‰ï¼› å¦‚æœä½ ä»æ¥æ²¡æœ‰äº†è§£è¿‡ Rustï¼Œä½†æ˜¯å¯¹äºå‡½æ•°å¼è¯­è¨€å¾ˆç†Ÿæ‚‰ï¼ˆçœ‹åˆ°ã€Œä»£æ•°æ•°æ®ç±»å‹ï¼ˆalgebaric data typesï¼‰ã€å’Œã€Œç»„åˆå­ï¼ˆcombinatorsï¼‰ã€ä¸ä¼šè®©ä½ æ„Ÿåˆ°é™Œç”Ÿï¼‰ï¼Œé‚£ä¹Ÿè®¸å¯ä»¥ç›´æ¥è·³è¿‡åŸºç¡€éƒ¨åˆ†ï¼Œä»ã€Œå¤šé”™è¯¯ç±»å‹ã€éƒ¨åˆ†å¼€å§‹é˜…è¯»ï¼Œç„¶åé˜…è¯»ã€Œæ ‡å‡†åº“ä¸­çš„ error traitsã€éƒ¨åˆ†; å¦‚æœä½ å·²ç»æ‹¥æœ‰ Rust ç¼–ç¨‹ç»éªŒï¼Œå¹¶ä¸”åªæƒ³äº†è§£ä¸‹é”™è¯¯å¤„ç†çš„æ–¹å¼ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è·³åˆ°æœ€åï¼Œçœ‹çœ‹ä½œè€…ç»™å‡ºçš„æ¡ˆä¾‹ç ”ç©¶ï¼ˆå½“ç„¶ï¼Œè¿˜æœ‰è¯‘è€…ç»™å‡ºçš„å®é™…æ¡ˆä¾‹ï¼‰ã€‚ è¿è¡Œä»£ç å¦‚æœæƒ³è¦ç›´æ¥è¿è¡Œæ ·ä¾‹ä»£ç ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ“ä½œï¼š 123$ git clone git://github.com/BurntSushi/blog$ cd blog/code/rust-error-handling$ cargo run --bin NAME-OF-CODE-SAMPLE [ args ... ] TL;TRæ–‡ç« å¤ªé•¿ï¼Œå¦‚æœæ²¡è€å¿ƒé˜…è¯»çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹å…³äº Rust é”™è¯¯å¤„ç†çš„ä¸€äº›æ€»ç»“ã€‚ä»¥ä¸‹æ˜¯ä½œè€…æä¾›çš„ã€Œç»éªŒæ³•åˆ™ã€ï¼Œä»…ä¾›å‚è€ƒï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾—ä¸€äº›å¯å‘ã€‚ å¦‚æœä½ æ­£åœ¨ç¼–å†™ç®€çŸ­çš„ç¤ºä¾‹ä»£ç ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæœ‰ä¸å°‘é”™è¯¯å¤„ç†çš„è´Ÿæ‹…ï¼Œè¿™ç§åœºæ™¯ä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨ unwrapï¼ˆæ¯”å¦‚ Result::unwrap, Option::unwrap æˆ–è€… Option::expect ç­‰ï¼‰ã€‚é˜…è¯»ä½ ä»£ç çš„äººåº”è¯¥çŸ¥é“å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å¤„ç†é”™è¯¯ï¼ˆå¦‚æœ TA ä¸ä¼šï¼ŒæŠŠè¿™ç¯‡æ–‡ç« ç”©ç»™ TA çœ‹ï¼‰ï¼› å¦‚æœä½ æ­£åœ¨å†™ä¸€ä¸ªç±»ä¼¼ä¸´æ—¶è„šæœ¬ä¸€æ ·çš„ç¨‹åºï¼ˆquick-n-dirty programï¼‰ï¼Œç›´æ¥ç”¨ unwrap ä¹Ÿä¸ç”¨è§‰å¾—ç¾æ„§ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœåˆ«äººæ¥æ”¶ä½ è¿™ä¸ªç¨‹åºï¼Œé‚£å¯èƒ½æ˜¯è¦ä¸çˆ½çš„å“¦ï¼ˆæ¯•ç«Ÿæ²¡æœ‰ç‰¹åˆ«ä¸°å¯Œçš„é”™è¯¯æ¶ˆæ¯ï¼‰ï¼› å¯¹äºğŸ‘†çš„åœºæ™¯ï¼Œå¦‚æœä½ è§‰å¾—ç›´æ¥ç”¨ unwrap ä¸å¤ªå¥½ï¼ˆæ¯•ç«Ÿå‡ºé”™ä¼šç›´æ¥ panic æ‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ Box&lt;dyn Error&gt; æˆ–è€… anyhow::Error ç±»å‹ä½œä¸ºå‡½æ•°çš„é”™è¯¯è¿”å›ç±»å‹ã€‚å¦‚æœä½¿ç”¨äº† anyhow crateï¼Œå½“ä½¿ç”¨ nightly ç‰ˆæœ¬çš„ Rust æ—¶ï¼Œé”™è¯¯ä¼šè‡ªåŠ¨æ‹¥æœ‰å…³è”çš„ backtraceï¼› è¦æ˜¯ä¸Šé¢çš„æ–¹æ³•è¿˜ä¸è¡Œï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œå¹¶ä¸”å®ç° From å’Œ Error traitï¼Œä»è€Œå¯ä»¥é¡ºåˆ©åœ°ä½¿ç”¨ ? æ“ä½œç¬¦ï¼Œè®©é”™è¯¯å¤„ç†æ›´åŠ ä¼˜é›…ï¼ˆè¦æ˜¯ä½ è¿ From å’Œ Error trait ä¹Ÿä¸æ„¿æ„åŠ¨æ‰‹å®ç°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ thiserror æ¥è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼› å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåº“ï¼Œå¹¶ä¸”å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œæ¨èä½ è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œå¹¶ä¸”å®ç° std::error::Error traitï¼Œå¹¶ä¸”å®ç°åˆé€‚çš„ From traitï¼Œä»è€Œæ–¹ä¾¿åº“çš„è°ƒç”¨è€…ç¼–å†™ä»£ç ï¼ˆå› ä¸ºåŸºäº Rust çš„ç›¸å¹²æ€§åŸåˆ™ï¼ˆcoherence rulesï¼‰ï¼Œè°ƒç”¨è€…ä¸èƒ½ä¸ºåº“ä¸­å®šä¹‰çš„é”™è¯¯ç±»å‹å®ç° Fromï¼Œå› æ­¤è¿™æ˜¯åº“ä½œè€…çš„èŒè´£ï¼‰ï¼› å­¦ä¼šä½¿ç”¨ Option å’Œ Result ä¸­å®šä¹‰çš„ç»„åˆå­ï¼Œæœ‰æ—¶å€™åªæ˜¯ä½¿ç”¨å®ƒä»¬å¯èƒ½æ¯”è¾ƒç´¢ç„¶æ— å‘³ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åˆç†åœ°ç»„åˆä½¿ç”¨ ? æ“ä½œç¬¦åˆç»„åˆå­æ¥æ”¹å–„ä»£ç ã€‚and_then, map å’Œ unwrap_or æ˜¯ä½œè€…æ¯”è¾ƒå–œæ¬¢çš„å‡ ä¸ªç»„åˆå­ã€‚ æ€»ç»“ä¸€ä¸‹æµç¨‹å¦‚ä¸‹ï¼š åŸºç¡€çŸ¥è¯†é”™è¯¯å¤„ç†å¯ä»¥çœ‹æˆæ˜¯åˆ©ç”¨ åˆ†æ”¯åˆ¤æ–­ï¼ˆcase analysisï¼‰ é€»è¾‘æ¥æŒ‡ç¤ºä¸€æ¬¡è®¡ç®—æˆåŠŸä¸å¦ã€‚ä¼˜é›…çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œå…³é”®å°±æ˜¯è¦è€ƒè™‘å‡å°‘æ˜¾å¼ç¼–å†™åˆ†æ”¯åˆ¤æ–­é€»è¾‘çš„ä»£ç ï¼ŒåŒæ—¶è¿˜èƒ½ä¿æŒä»£ç çš„å¯ç»„åˆæ€§ï¼ˆå°±æ˜¯è®©è°ƒç”¨æ–¹æœ‰é”™è¯¯å¤„ç†çš„å†³å®šæƒï¼Œè°ƒç”¨æ–¹å¯ä»¥åœ¨çº¦åˆ°é”™è¯¯æ—¶ panic æˆ–è€…åªæ˜¯æ‰“å°å‡ºé”™è¯¯æ¶ˆæ¯ï¼‰ã€‚ ä¿æŒä»£ç çš„å¯ç»„åˆæ€§éå¸¸é‡è¦ï¼Œå¦åˆ™æˆ‘ä»¬å¯èƒ½åœ¨ä»»ä½•é‡åˆ°ä¸å¯é¢„æœŸçš„å¼‚å¸¸æ—¶å‡ºç° panicï¼ˆpanic ä¼šå¯¼è‡´å½“å‰çš„çº¿ç¨‹æ ˆå±•å¼€ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œè¿˜ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼‰ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š 1234567891011121314// file: panic-simple//// Guess a number between 1 and 10.// If it matches the number I had in mind, return true. Else, return false.fn guess(n: i32) -&gt; bool &#123; if n &lt; 1 || n &gt; 10 &#123; panic!("Invalid number: &#123;&#125;", n); &#125; n == 5&#125;fn main() &#123; guess(11);&#125; å¦‚æœå°è¯•è¿è¡Œä¸Šè¿°ä»£ç ï¼Œç¨‹åºä¼šç›´æ¥å´©æºƒï¼Œå¹¶ä¸”ä¼šåå‡ºä¸‹é¢çš„æ¶ˆæ¯ï¼š 1thread '&lt;main&gt;' panicked at 'Invalid number: 11', src/bin/panic-simple.rs:5 ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå¯¹äºç”¨æˆ·è¾“å…¥æ›´åŠ ä¸å¯é¢„çŸ¥ã€‚å®ƒé¢„æœŸç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•´æ•°å­—ç¬¦ä¸²ï¼Œç„¶åå°†å…¶è½¬æ¢æˆæ•´æ•°åå†ä¹˜ä»¥ 2ï¼Œæ‰“å°å‡ºç»“æœï¼š 123456789101112// file: unwrap-doubleuse std::env;fn main() &#123; let mut argv = env::args(); let arg: String = argv.nth(1).unwrap(); // error 1 let n: i32 = arg.parse().unwrap(); // error 2 println!("&#123;&#125;", 2 * n);&#125;// $ cargo run --bin unwrap-double 5// 10 å¦‚æœæˆ‘ä»¬è¾“å…¥çš„æ˜¯ 0 ä¸ªå‚æ•°ï¼ˆerror 1ï¼‰ï¼Œæˆ–è€…å¹²è„†è¾“å…¥ä¸å¯è½¬æ¢æˆæ•´æ•°çš„å­—ç¬¦ä¸²ï¼ˆerror 2ï¼‰ï¼Œåˆ™ä¼šå¯¼è‡´ç¨‹åº panic æ‰ã€‚ Unwrap è¯¦è§£unwrap-double ç¤ºä¾‹ä¸­ï¼Œè™½ç„¶æ²¡æœ‰æ˜¾å¼åœ°ä½¿ç”¨ panicï¼Œä½†æ˜¯å®ƒåœ¨é‡åˆ°é”™è¯¯æ—¶ä¾ç„¶ä¼š panic æ‰ã€‚è¿™æ˜¯å› ä¸º unwrap å†…éƒ¨è°ƒç”¨äº† panicã€‚ unwrap åœ¨ Rust ä¸­çš„æ„æ€æ˜¯è¿™æ ·çš„ï¼šæ ¹æ®æä¾›çš„è®¡ç®—ç»“æœï¼Œå¦‚æœæ˜¯é”™è¯¯ç»“æœï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨ panicã€‚ä¹Ÿè®¸ä½ å¼€å§‹å¥½å¥‡ unwrap çœŸæ­£çš„å®ç°äº†ï¼ˆå®ç°å¾ˆç®€å•ï¼‰ï¼Œä¸è¿‡åœ¨æˆ‘ä»¬å­¦ä¹ å®Œ Option å’Œ Result ç±»å‹åè‡ªç„¶å°±çŸ¥é“äº†ã€‚è¿™ä¸¤ç§ç±»å‹éƒ½æœ‰å…³è”çš„ unwrap æ–¹æ³•å®šä¹‰ã€‚ Option ç±»å‹Option ç±»å‹æ˜¯æ ‡å‡†åº“å®šä¹‰çš„æšä¸¾ç±»å‹ï¼š 1234enum Option&lt;T&gt; &#123; None, Some(T),&#125; åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Option ç±»å‹æ¥è¡¨è¾¾å­˜åœ¨æ€§ã€‚å°†è¿™ç§ç±»å‹åŠ å…¥åˆ° Rust çš„ç±»å‹ç³»ç»Ÿéå¸¸é‡è¦ï¼Œè¿™æ ·ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶ä½¿ç”¨è€…å¤„ç†å­˜åœ¨æ€§ã€‚ä¸‹é¢æ¥çœ‹ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š 12345678910// Searches `haystack` for the Unicode character `needle`. If one is found, the// byte offset of the character is returned. Otherwise, `None` is returned.fn find(haystack: &amp;str, needle: char) -&gt; Option&lt;usize&gt; &#123; for (offset, c) in haystack.char_indices() &#123; if c == needle &#123; return Some(offset); &#125; &#125; None&#125; æ¸©é¦¨æç¤ºï¼šä¸è¦åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨ä¸Šè¿°ä»£ç ï¼Œç›´æ¥ä½¿ç”¨æ ‡å‡†åº“æä¾›çš„ find æ–¹æ³• æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸Šè¿°å‡½æ•°åœ¨æ‰¾åˆ°åŒ¹é…çš„å­—ç¬¦åï¼Œä¸ä¼šç›´æ¥è¿”å› offsetï¼Œè€Œæ˜¯è¿”å› Some(offset)ã€‚Some æ˜¯ Option ç±»å‹çš„å€¼æ„é€ å™¨ï¼Œå¯ä»¥å°†å®ƒæƒ³è±¡æˆè¿™æ ·çš„å‡½æ•°ï¼šfn&lt;T&gt;(value: T) -&gt; Option&lt;T&gt;ã€‚ç›¸åº”åœ°ï¼ŒNone ä¹Ÿæ˜¯ä¸€ä¸ªå€¼æ„é€ å™¨ï¼Œä¸è¿‡å®ƒæ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥å°†å®ƒæƒ³è±¡æˆè¿™æ ·çš„å‡½æ•°ï¼šfn&lt;T&gt;() -&gt; Option&lt;T&gt;ã€‚ Oopsï¼Œçœ‹èµ·æ¥æœ‰ç‚¹æ— èŠå“¦ï¼Œä¸è¿‡æ•…äº‹è¿˜æ²¡å” å®Œã€‚æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆä½¿ç”¨ find å‡½æ•°ï¼Œä¸‹é¢å°±åˆ©ç”¨å®ƒæŸ¥æ‰¾æ–‡ä»¶æ‰©å±•åï¼š 1234567fn main_find() &#123; let file_name = "foobar.rs"; match find(file_name, '.') &#123; Some(i) =&gt; println!("File extension: &#123;&#125;", &amp;file_name[i+1..]), None =&gt; println!("No file extension found."), &#125;&#125; ä¸Šè¿°ä»£ç å¯¹äº find è¿”å›çš„ Option&lt;usize&gt; ä½¿ç”¨äº†ã€Œæ¨¡å¼åŒ¹é…ã€æ¥æ‰§è¡Œåˆ†æ”¯åˆ¤æ–­ã€‚äº‹å®ä¸Šï¼Œåˆ†æ”¯åˆ¤æ–­æ˜¯è·å¾— Option&lt;T&gt; å†…éƒ¨å€¼çš„å”¯ä¸€æ–¹å¼ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»è¦å¤„ç†å¥½ Option&lt;T&gt; ä¸º None çš„æƒ…å†µã€‚ å•Šå–‚ï¼Œç­‰ä¸‹ï¼Œåœ¨å‰é¢æåˆ°çš„ unwrap æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ²¡é”™ï¼Œå®ƒçš„å†…éƒ¨ä¹Ÿä½¿ç”¨äº†åˆ†æ”¯åˆ¤æ–­ï¼æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰è¿™æ ·çš„æ–¹æ³•ï¼š 1234567891011121314enum Option&lt;T&gt; &#123; None, Some(T),&#125;impl&lt;T&gt; Option&lt;T&gt; &#123; fn unwrap(self) -&gt; T &#123; match self &#123; Option::Some(val) =&gt; val, Option::None =&gt; panic!("called `Option::unwrap()` on a `None` value"), &#125; &#125;&#125; unwrap ä¸ºæˆ‘ä»¬å°è£…äº†åˆ†æ”¯åˆ¤æ–­é€»è¾‘ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚ä¸è¿‡ç”±äºå®ƒå†…éƒ¨ä½¿ç”¨äº† panic! è°ƒç”¨ï¼Œè¿™ä¹Ÿæ„å‘³ç€å®ƒä¸å…·å¤‡å¯ç»„åˆæ€§ã€‚ ç»„åˆ Option&lt;T&gt; å€¼Result ç±»å‹è§£ææ•´æ•°Result ç±»å‹åˆ«åå°æ’æ›²ï¼šunwrap å¹¶éé‚ªæ¶å¤„ç†å¤šç§é”™è¯¯ç±»å‹ç»„åˆ Option å’Œ Resultç»„åˆå­çš„é™åˆ¶æå‰è¿”å›ä½¿ç”¨ try! å®æˆ–è€… ? æ“ä½œç¬¦è‡ªå®šä¹‰é”™è¯¯ç±»å‹æ ‡å‡†åº“ä¸­çš„é”™è¯¯å¤„ç† traitError traitFrom traittry! å’Œ ? å†…éƒ¨å®ç°ç»„åˆè‡ªå®šä¹‰é”™è¯¯ç±»å‹ç»™åº“ä½œè€…çš„ä¸€äº›å»ºè®®æ¡ˆä¾‹ç ”ç©¶ï¼šé˜…è¯»äººå£æ•°æ®çš„å°ç¨‹åºå®ƒåœ¨ GitHub ä¸Šé…ç½®å‚æ•°è§£æç¼–å†™ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ Box&lt;dyn Error&gt; å¤„ç†é”™è¯¯ä» stdin ä¸­è¯»å–ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹æ·»åŠ åŠŸèƒ½ç‹¬åˆ›æ¡ˆä¾‹ç ”ç©¶ï¼šæ–°å† æ•°æ®æŸ¥è¯¢åŸæ–‡ Error Handling in Rust]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>Error Handling</tag>
        <tag>ç¿»è¯‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆäºŒï¼‰ï¼šé¢„å¤‡çŸ¥è¯†]]></title>
    <url>%2F2020%2F04%2F21%2Ftalent-plan-rust-network-programming-bb2%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ ææ–™é˜…è¯»ç‚«é…·ç®—æ³•ä¹‹æ—¥å¿—ç»“æ„å­˜å‚¨Damn Cool Algorithms: Log structured storage æ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ä¸å®ç°Bitcaskï¼Œé«˜æ€§èƒ½ &amp; åŸºäºæ—¥å¿—ç»“æ„çš„ Key/Value å­˜å‚¨Rust ä¸­çš„é”™è¯¯å¤„ç†std::collections æ–‡æ¡£å­¦ä¹ std::io æ–‡æ¡£å­¦ä¹ ç»ƒä¹ é¢˜ä½¿ç”¨ serde åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆJSONï¼‰ä½¿ç”¨ serde åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆRONï¼‰ä½¿ç”¨ serde åºåˆ—åŒ–ååºåˆ—åŒ– 1000 ä¸ªæ•°æ®ç»“æ„ï¼ˆBSONï¼‰å°ç»“å‚è€ƒ PNA Rust â€” Building Blocks 2 Whatâ€™s rustdoc å»¶ä¼¸é˜…è¯» What is the difference between a journaling vs a log structured file system? Journaling and Log-structured file systems]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>ç½‘ç»œç¼–ç¨‹</tag>
        <tag>Log-Structured</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆäºŒï¼‰ï¼šç¼–å†™å†…å­˜ KV å­˜å‚¨]]></title>
    <url>%2F2020%2F04%2F17%2Ftalent-plan-rust-network-programming-proj1%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ç»è¿‡ ä¸Šä¸€èŠ‚ çš„å­¦ä¹ ï¼Œç›¸ä¿¡å¯¹äº Cargoã€Rust API æ–‡æ¡£ç¼–å†™è§„èŒƒã€å‘½ä»¤è¡Œå·¥å…·ç¼–å†™éƒ½æœ‰äº†åˆæ­¥è®¤è¯†ï¼Œæ²¡æœ‰æŒæ¡ä¹Ÿæ²¡å…³ç³»ã€‚æœ¬èŠ‚å°†ä¼šç»§ç»­æ·±å…¥å­¦ä¹ å’Œå®è·µï¼Œæˆ‘ä»¬å°†é‡‡ç”¨ æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Development, TDDï¼‰ çš„æ–¹å¼ç¼–å†™ä¸€ä¸ªç®€å•çš„å†…å­˜ key-value å­˜å‚¨åº“ï¼Œä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ç”¨äºæ¥æ”¶å’Œå¤„ç†å¢åˆ æŸ¥å‘½ä»¤ï¼Œå¹¶ä¸”æœ€ç»ˆè¿˜è¦èƒ½å¤Ÿé€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•ã€‚ å…³é”®è¯ï¼šå•å…ƒæµ‹è¯•ã€clap å’Œ structopt crateã€Cargo ç¯å¢ƒå˜é‡ã€clippy å’Œ rustfmt å·¥å…· ç›®æ ‡ï¼š å­¦ä¹ è§„èŒƒçš„é¡¹ç›®ç»“æ„ï¼› å­¦ä¹  cargo new/init/test/run/clippy/fmt å‘½ä»¤ï¼› å­¦ä¹ å¦‚ä½•ä» crates.io å¯¼å…¥æ–°çš„ cratesï¼› ä¸º key-value å­˜å‚¨å®šä¹‰åˆé€‚çš„æ•°æ®ç±»å‹ã€‚ äº†è§£ TDDæµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Developmentï¼‰ æ˜¯ä¸€ç§æ¯”è¾ƒæœ‰è¶£çš„è½¯ä»¶å¼€å‘æ¨¡å¼ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ ¹æ®éœ€æ±‚å…ˆå†™å¥½å•å…ƒæµ‹è¯•æ¡ä¾‹ï¼Œç„¶åå†å»ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè®©æµ‹è¯•é€šè¿‡ã€‚é€šè¿‡æµ‹è¯•é©±åŠ¨è½¯ä»¶å¼€å‘æ¨è¿›ï¼Œä¸€æ–¹é¢å¯ä»¥ä¿è¯æˆ‘ä»¬ç¼–å†™çš„ä»£ç æ»¡è¶³éœ€æ±‚ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¢å¼ºæˆ‘ä»¬çš„ä¿¡å¿ƒï¼Œå……è¶³å•å…ƒæµ‹è¯•ä¹Ÿæœ‰åŠ©äºä»£ç é‡æ„ï¼Œé¿å…å‡ºç°æ ¸å¿ƒé€»è¾‘å˜åŠ¨è€Œå¯¼è‡´ Bugã€‚ åœ¨ Test-Driven Development by Example ä¸­ç»™å‡ºäº† TDD çš„åŸºæœ¬æµç¨‹ï¼š ä¸ºæ–°åŠŸèƒ½ç¼–å†™æµ‹è¯•ï¼› è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ŒæŸ¥çœ‹æ–°åŠŸèƒ½ç›¸å…³æµ‹è¯•æ˜¯å¦å¤±è´¥ï¼› ç¼–å†™ä»£ç ï¼› è¿è¡Œæµ‹è¯•ï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡æµ‹è¯•ï¼Œåˆ™å›åˆ°ä¸Šä¸€æ­¥ç»§ç»­ä¿®å¤ä»£ç ï¼› é‡æ„ä»£ç ï¼› ä¸æ–­é‡å¤ä¸Šè¿°æµç¨‹ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå†æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•å‰ï¼Œæœ€å¥½æ¯æ¬¡å˜æ›´çš„ä»£ç ä¸è¦å¤ªå¤šã€‚è¿™æ ·ä¸€æ—¦æœ‰æµ‹è¯•å¤±è´¥ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ï¼Œå¹¶è¿›è¡Œä¿®å¤æˆ–è€…å›æ»šã€‚ å‘½ä»¤è¡Œå’Œæ¥å£çº¦å®šæœ¬èŠ‚ä¼šåˆ›å»ºä¸€ä¸ªåå« tinkv çš„é¡¹ç›®ï¼ŒåŒ…å«ä¸€ä¸ªåä¸º tinkv çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œå°†ä¼šè°ƒç”¨ tinkv åº“ä¸­æä¾›çš„æ–¹æ³•ï¼ˆå’Œå‘½ä»¤è¡Œå®¢æˆ·ç«¯æ‰“é€šæ”¾åˆ°åé¢å°èŠ‚ä»‹ç»ï¼‰ã€‚ tinkv å‘½ä»¤è¡Œå®¢æˆ·ç«¯éœ€è¦æ”¯æŒå¦‚ä¸‹æ“ä½œï¼š tinkv set &lt;key&gt; &lt;value&gt;ï¼šè®¾ç½® String ç±»å‹çš„ key value åˆ°å­˜å‚¨ä¸­ï¼› tinkv get &lt;key&gt;ï¼šæŸ¥è¯¢æŒ‡å®š key å¯¹åº”çš„ String å€¼ï¼› tinkv rm &lt;key&gt;ï¼šåˆ é™¤æŒ‡å®šçš„ keyï¼› tinkv -Vï¼šæ‰“å°ç¨‹åºçš„ç‰ˆæœ¬å·ã€‚ tinkv åº“ä¸­å®šä¹‰äº†ä¸€ä¸ª KvStore ç±»å‹ï¼Œå°è£…äº†å­˜å‚¨æœåŠ¡çš„æ“ä½œï¼Œéœ€è¦æ”¯æŒå¦‚ä¸‹æ“ä½œï¼š KvStore::set(&amp;mut self, key: String, value: String) KvStore::get(&amp;self, key: String) -&gt; Option&lt;String&gt; KvStore::remove(&amp;mut self, key: String) åŠ¨æ‰‹å®è·µåˆ›å»ºé¡¹ç›®ä½¿ç”¨ Cargo æ–°å»ºé¡¹ç›® tinkvã€‚ 12$ cargo new tinkv$ cd tinkv ç„¶ååˆ›å»º src/bin/tinkv.rs, src/lib.rs å’Œ src/kvstore.rs æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­˜æ”¾æµ‹è¯•çš„æ–‡ä»¶ tests/tests.rsã€‚æœ€ç»ˆçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 12345678910.â”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ README.mdâ”œâ”€â”€ srcâ”‚ â”œâ”€â”€ binâ”‚ â”‚ â””â”€â”€ tinkv.rsâ”‚ â”œâ”€â”€ kvstore.rsâ”‚ â””â”€â”€ lib.rsâ””â”€â”€ tests â””â”€â”€ tests.rs ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ src/bin/tinkv.rs ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„ main å‡½æ•°ï¼š 123fn main() &#123; println!("hello, tinkv");&#125; åœ¨ src/kvstore.rs ä¸­æ–°å¢ KvStore ç±»å‹ï¼š 1234#[derive(Debug)]struct KvStore &#123;&#125; ç„¶ååœ¨ src/lib.rs ä¸­å¯¼å‡º KvStore ç±»å‹ï¼Œè¿™æ ·å¯ä»¥åœ¨æµ‹è¯•ä»¥åŠ src/bin/tinkv.rs::main() ä¸­ä½¿ç”¨ï¼š 12mod kvstore;pub use kvstore::KvStore; æœ€åï¼Œæˆ‘ä»¬å®Œå–„ä¸‹ Cargo.toml ä¸­ [package] éƒ¨åˆ†ï¼š 123456789[package]name = "tinkv"version = "0.1.0"authors = ["0xE8551CCB &lt;noti@ifaceless.space&gt;"]edition = "2018"description = "A simple key-value store"keywords = ["database", "key-value"]categories = ["Development"]license = "MIT" æ·»åŠ å•å…ƒæµ‹è¯•æŒ‰ç…§ TDD çš„æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®Œæˆæ–°éœ€æ±‚å¯¹åº”çš„å•å…ƒæµ‹è¯•ç¼–å†™ï¼Œä¸è¿‡ç°åœ¨å·²ç»ä¸ºä½ å‡†å¤‡å¥½å•¦ï¼Œæ‰€ä»¥è¯·åˆ° tinkv/tests ä¸­å°†æ‰€æœ‰æµ‹è¯•å¤åˆ¶åˆ°æœ¬åœ° tests/tests.rs æ–‡ä»¶ä¸­ã€‚ ä»”ç»†é˜…è¯»æµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æœ‰ä¸¤ç±»æµ‹è¯•ï¼š cli_* æ˜¯é’ˆå¯¹å‘½ä»¤è¡Œå®¢æˆ·ç«¯çš„æµ‹è¯•ï¼› get_stored_value ç­‰æ˜¯é’ˆå¯¹ tinkv::KvStore çš„åŠŸèƒ½æµ‹è¯•ã€‚ 1234567#[test]fn cli_no_args() &#123;/* çœç•¥å†…å®¹ */&#125;//===============åˆ†å‰²çº¿===============#[test]fn get_stored_value() &#123; /* çœç•¥å†…å®¹ */&#125; å•å…ƒæµ‹è¯•æŸç§æ„ä¹‰ä¸Šä¹Ÿæ˜¯æ–‡æ¡£çš„è¡¥å……ï¼Œå®ƒæ¸…æ™°æè¿°äº†æŸä¸ªæ¥å£çš„è¡Œä¸ºï¼Œè€Œæˆ‘ä»¬åªéœ€è¦å®ç°é‚£ä¸ªè¡Œä¸ºå³å¯é€šè¿‡å•å…ƒæµ‹è¯•ã€‚æ‰€ä»¥åé¢çš„æˆ‘ä»¬çš„ä»»åŠ¡ä¾¿æ˜¯é€ä¸ªé€šè¿‡å•å…ƒæµ‹è¯•ï¼Œå®ŒæˆåŠŸèƒ½å¼€å‘ã€‚ å®‰è£…æµ‹è¯•ä¾èµ–åŒ…ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¿è¡Œä¸‹æµ‹è¯•çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼ˆä¸ç”¨å¤šæƒ³ï¼Œä¸€å®šä¼šå¤±è´¥ï¼Œé‡ç‚¹æ˜¯æ‰¾åˆ°åŸå› ï¼‰ï¼Œè¿è¡Œ cargo test ç»“æœå¦‚ä¸‹ï¼š æœä¸å…¶ç„¶ï¼Œçœ‹èµ·æ¥ assert_cmd, predicates crate æ— æ³•å¯¼å…¥ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦ç¼–è¾‘ä¸‹ Cargo.toml æ·»åŠ ä¸€ä¸‹æµ‹è¯•éœ€è¦çš„ä¾èµ–åŒ…ï¼š 123[dev-dependencies]assert_cmd = "0.11.0"predicates = "1.0.0" ç„¶åï¼Œæˆ‘ä»¬å†æ¬¡è¿è¡Œ cargo test çœ‹çœ‹æ•ˆæœï¼Œçœ‹èµ·æ¥è¿˜æ˜¯å¤±è´¥äº†å˜›ï¼Œä¸è¿‡è¿™æ¬¡æŠ¥é”™çš„åŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰ç»™ tinkv::KvStore å®ç° get, set, remove æ–¹æ³•å‘¢ã€‚ ç¼–å†™ KvStoreå½“å‰çš„ç›®æ ‡æ˜¯è®©æµ‹è¯•è·‘èµ·æ¥ï¼Œè‡³å°‘ä¸è¦ç¼–è¯‘å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¦è®© cargo test --no-run èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ã€‚ä»ä¸Šé¢çš„æŠ¥é”™çœ‹åˆ° tinkv::KvStore è¿˜ç¼ºå°‘å¿…é¡»çš„æ–¹æ³•å®šä¹‰å‘¢ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰å…ˆå®Œæˆæ¡†æ¶ï¼Œå³å‡½æ•°å®šä¹‰ï¼Œå®ç°ç»†èŠ‚å…ˆç”¨ panic!() æ›¿ä»£ï¼ˆå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä½¿ç”¨ unimplemented!()ï¼Œä¸è¿‡ panic!() å­—æ•°æ›´å°‘ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ç”¨å¾—æ›´å¤šï¼‰ã€‚ æ·»åŠ å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š 123456789#[derive(Debug)]pub struct KvStore &#123;&#125;impl KvStore &#123; pub fn new() -&gt; Self &#123; KvStore &#123;&#125; &#125; pub fn set(&amp;mut self, key: String, value: String) &#123; panic!(); &#125; pub fn get(&amp;self, key: String) -&gt; Option&lt;String&gt; &#123; panic!(); &#125; pub fn remove(&amp;mut self, key: String) &#123; panic!(); &#125;&#125; å¥½å•¦ï¼Œè¿™æ—¶å†æ‰§è¡Œ cargo test åå¯ä»¥å‘ç°å·²ç»å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œå¹¶èƒ½è¿è¡Œå•å…ƒæµ‹è¯•äº†ï¼ˆè™½ç„¶éƒ½æŒ‚äº†ï¼Œä½†è‡³å°‘ç¼–è¯‘é€šè¿‡äº†ï¼Œå¯å–œå¯è´ºï¼‰ã€‚ å…³äº cargo test ä½¿ç”¨æç¤ºç»†å¿ƒçš„è¯ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•è¾“å‡ºä¸­æœ‰è¿™æ ·çš„æç¤ºï¼š 1234567891011121314running 0 teststest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out Running target/debug/deps/tinkv-3292fe1fc5408d8crunning 0 teststest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out Running target/debug/deps/tests-850c7d178475e2f3running 13 tests... çœ‹èµ·æ¥æ˜¯è¿è¡Œäº†ä¸‰æ¬¡æµ‹è¯•å˜›ï¼Œè¿™æ˜¯å› ä¸º cargo test é»˜è®¤ä¼šåœ¨å¦‚ä¸‹å‡ ä¸ªä½ç½®æŸ¥æ‰¾å¹¶è¿è¡Œæµ‹è¯•ï¼š åº“æºç é‡Œé¢ï¼› æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„æºç ä¸­ï¼› æ¯ä¸ªæµ‹è¯•æ–‡ä»¶ï¼› åº“æ–‡æ¡£æµ‹è¯•ã€‚ ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ é¢å¤–çš„å‚æ•°ï¼ŒæŒ‡å®šè¿è¡Œæµ‹è¯•ï¼Œé€‰é¡¹å¦‚ä¸‹ï¼ˆè¯¦ç»†å¯ä»¥é€šè¿‡ cargo help test æŸ¥çœ‹ï¼‰ï¼š cargo test --lib cargo test --doc cargo test --bins cargo test --bin foo cargo test --test foo é€šå¸¸æˆ‘ä»¬åœ¨å®ç°æŸä¸ªæ¥å£åŠŸèƒ½æ—¶ï¼Œå¯ä»¥åªè¿è¡Œå¯¹åº”çš„æµ‹è¯•ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š 12# ä»…è¿è¡Œåç§°ä¸º cli_no_args çš„æµ‹è¯•å‡½æ•°cargo test cli_no_args ç¼–å†™å‘½ä»¤è¡Œå®¢æˆ·ç«¯åœ¨ä¹‹å‰çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ clap æ¥åˆ›å»ºä¸€ä¸ª CLI Appï¼Œä¹Ÿæ¼”ç¤ºäº†é€šè¿‡ cli.yml é…ç½®æˆ–è€…åœ¨ä»£ç ä¸­ä½¿ç”¨ clap æä¾›çš„æ„é€ å‡½æ•°ç”Ÿæˆå‘½ä»¤è¡Œåº”ç”¨çš„æ–¹å¼ã€‚ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š ç”Ÿæˆ clap::App æ—¶ï¼Œéœ€è¦ç¼–å†™å¾ˆå¤šæ ·æ¿ä»£ç ï¼Œæ¯”è¾ƒå•°å—¦ï¼› åœ¨å¤„ç†å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œä½¿ç”¨ matches.value_of(&quot;arg&quot;) çš„æ–¹å¼æ‹¿åˆ°å€¼åï¼Œå¯èƒ½è¿˜æ¶‰åŠåˆ°ç±»å‹è½¬æ¢ç­‰æ“ä½œï¼Œä¹ŸåŒæ ·ä¼šäº§ç”Ÿå¾ˆå¤šæ ·æ¿ä»£ç ï¼Œä¸å¤Ÿä¼˜é›…å’Œé«˜æ•ˆã€‚ æœ¬èŠ‚å°†ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„ crate structoptï¼Œæˆ‘ä»¬å°†å‘½ä»¤è¡Œå‚æ•°é€šè¿‡ç»“æ„ä½“æˆå‘˜å˜é‡è¡¨ç¤ºï¼Œå‚æ•°ç±»å‹ã€å¸®åŠ©ä¿¡æ¯ç­‰ç¼–å†™èµ·æ¥éƒ½å¾ˆè½»æ¾ï¼Œå®ƒä½¿ç”¨ Rust å®æ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆ clap::Appï¼ŒåŒæ—¶å¯ä»¥è‡ªåŠ¨å®Œæˆå‚æ•°ç±»å‹è½¬æ¢ï¼Œéå¸¸çµæ´»ã€‚ é¦–å…ˆï¼Œä½¿ç”¨ cargo add structopt æ·»åŠ è¯¥ä¾èµ–æŒ‡é¡¹ç›®ä¸­ï¼Œç„¶ååœ¨ src/bin/tinkv.rs ä¸­é…ç½®å‘½ä»¤è¡Œå‚æ•°å¯¹åº”çš„ç»“æ„ä½“ï¼Œå¹¶æ ¹æ®å•å…ƒæµ‹è¯•çš„é¢„æœŸè¡Œä¸ºå®ç°å‘½ä»¤è¡Œç¨‹åºå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253use std::process::exit;use structopt::StructOpt;#[derive(StructOpt, Debug)]enum Command &#123; /// Get value from store Get &#123; /// A string key key: String, &#125;, /// Save key value to store Set &#123; /// A string key key: String, /// A string value value: String, &#125;, #[structopt(name = "rm")] /// Remove value from store Remove &#123; /// A string key key: String, &#125;,&#125;#[derive(StructOpt, Debug)]#[structopt( rename_all = "kebab-case", name = env!("CARGO_PKG_NAME"), about = env!("CARGO_PKG_DESCRIPTION"), version = env!("CARGO_PKG_VERSION"), author = env!("CARGO_PKG_AUTHORS"),)]struct Opt &#123; #[structopt(subcommand)] command: Command,&#125;fn main() &#123; let opt = Opt::from_args(); match opt.command &#123; Command::Get &#123; key: _key &#125; =&gt; unimplemented(), Command::Set &#123; key: _key, value: _value &#125; =&gt; unimplemented(), Command::Remove &#123; key: _value&#125; =&gt; unimplemented(), &#125;&#125;/// æš‚æ—¶æ²¡æœ‰å®ç°å‘½ä»¤è¡Œæ‰§è¡Œæ—¶ä¸ [`tinkv::KvStore`] çš„äº¤äº’ï¼Œ/// å› ä¸ºå½“å‰è¿˜ä¸èƒ½æŒä¹…åŒ–å­˜å‚¨ã€‚fn unimplemented() &#123; eprintln!("unimplemented"); exit(1);&#125; æ­¤æ—¶ï¼Œä½¿ç”¨ cargo test --tests cli è¿è¡Œæ‰€æœ‰å’Œå‘½ä»¤è¡Œæœ‰å…³çš„æµ‹è¯•ï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œåº”è¯¥ä¼šå…¨éƒ¨é€šè¿‡ã€‚ 1234567891011121314151617$ cargo test --tests cli...test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out Running target/debug/deps/tests-850c7d178475e2f3running 9 teststest cli_get ... oktest cli_invalid_rm ... oktest cli_invalid_get ... oktest cli_invalid_subcommand ... oktest cli_set ... oktest cli_rm ... oktest cli_no_args ... oktest cli_invalid_set ... oktest cli_version ... ok... å°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ HashMap&lt;String, String&gt; ä¿å­˜è®¾ç½®çš„æ•°æ®åˆ°å†…å­˜ï¼Œè®©å•å…ƒæµ‹è¯•é€šè¿‡ã€‚å…·ä½“å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸å†èµ˜è¿°ã€‚ 1234567891011121314151617181920212223242526use std::collections::HashMap;#[derive(Debug)]pub struct KvStore &#123; db: HashMap&lt;String, String&gt;,&#125;impl KvStore &#123; pub fn new() -&gt; Self &#123; KvStore &#123; db: HashMap::new(), &#125; &#125; pub fn set(&amp;mut self, key: String, value: String) &#123; self.db.insert(key, value); &#125; pub fn get(&amp;self, key: String) -&gt; Option&lt;String&gt; &#123; self.db.get(&amp;key).map(|x| x.to_string()) &#125; pub fn remove(&amp;mut self, key: String) &#123; self.db.remove(&amp;key); &#125;&#125; è‡³æ­¤ï¼Œè¿è¡Œ cargo test åï¼Œæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹åº”è¯¥éƒ½ä¼šé€šè¿‡äº†ã€‚ 1234567891011121314151617$ cargo test...running 13 teststest cli_get ... oktest cli_invalid_rm ... oktest cli_invalid_subcommand ... oktest cli_invalid_get ... oktest cli_no_args ... oktest cli_invalid_set ... oktest get_non_existent_value ... oktest get_stored_value ... oktest overwrite_value ... oktest remove_key ... oktest cli_rm ... oktest cli_set ... oktest cli_version ... ok... è§„èŒƒæ–‡æ¡£åœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»æåˆ°å¦‚ä½•è§„èŒƒç¼–å†™ API æ–‡æ¡£äº†ï¼Œæœ¬èŠ‚ä¸å†èµ˜è¿°ï¼Œä½†æ˜¯éœ€è¦å¼ºè°ƒçš„æ˜¯æ–‡æ¡£éå¸¸é‡è¦ã€‚åœ¨ Rust æ ‡å‡†åº“ä»¥åŠä¸€äº›ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ crates ä¸­ï¼Œé€šå¸¸ä¼šåœ¨ä»£ç ä¸­çœ‹åˆ°éå¸¸ä¸°å¯Œä¸”è§„èŒƒçš„æ–‡æ¡£ï¼Œå»ºè®®å¤šå¤šé˜…è¯»ã€‚ è¿™é‡Œéœ€è¦æå‡ ç‚¹ï¼š åœ¨ç¼–å†™å¥½æ–‡æ¡£åï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡ cargo doc --open åœ¨æœ¬åœ°æµè§ˆå™¨æŸ¥çœ‹ API æ–‡æ¡£ï¼ˆç”Ÿæˆçš„æ–‡æ¡£ä½äº target/doc ç›®å½•ä¸‹ï¼‰ï¼› å¯ä»¥ä½¿ç”¨ cargo test --doc å¯¹æ–‡æ¡£ä¸­çš„ç¤ºä¾‹è¿›è¡Œæµ‹è¯•ï¼› åœ¨ src/lib.src é¡¶éƒ¨æ·»åŠ  #![deny(missing_docs)] ä¼šå¼ºåˆ¶æ‰€æœ‰å…¬å¼€çš„ç±»å‹ã€å‡½æ•°ç­‰å¿…é¡»ç¼–å†™æ–‡æ¡£ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚ æ‰€ä»¥ï¼Œåœ¨å®Œæˆä»£ç ç¼–å†™åï¼Œä¸€å®šè¦æ·»åŠ ä¸Šè§„èŒƒçš„æ–‡æ¡£å“¦~ clippy å’Œ rustfmtclippy å’Œ rustfmt æ˜¯ Rust å·¥å…·é“¾ä¸­ä¸¤æ¬¾é‡è¦çš„å·¥å…·ï¼š clippy ä¼šæ£€æŸ¥åˆ°ä»£ç ä¸­ä¸å¤Ÿä¼˜é›…æˆ–è€…å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„æ¨¡å¼ï¼Œå¹¶ä¼šç»™å‡ºä¿®æ”¹å»ºè®®ï¼› rustfmt åˆ™ä¼šæ ¼å¼åŒ–ä»£ç ï¼Œä¿è¯ä»£ç é£æ ¼ä¸€è‡´ã€‚ è¿™ä¸¤ä¸ªç»„ä»¶é»˜è®¤æ²¡æœ‰å®‰è£…ï¼Œéœ€è¦é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…ï¼š 12$ rustup component add clippy$ rustup component add rustfmt å®‰è£…åï¼Œå¯ä»¥é€šè¿‡ cargo clippy å’Œ cargo fmt åˆ†åˆ«è°ƒç”¨å®ƒä»¬ã€‚å¼ºçƒˆå»ºè®®åœ¨æäº¤ä»£ç å‰ï¼Œå…ˆè¿è¡Œ cargo clippy å°†å»ºè®®ä¿®æ”¹çš„åœ°æ–¹ä¿®æ”¹å¥½ï¼Œç„¶åä½¿ç”¨ cargo fmt æ ¼å¼åŒ–å¥½ä»£ç åå†æäº¤åˆ°ä¸»å¹²ã€‚ å°ç»“æœ¬èŠ‚ä»¥å®è·µä¸ºä¸»ï¼Œé‡‡ç”¨ TDD æ–¹å¼é€æ­¥å®Œæˆäº†ä¸€ä¸ªç®€å•çš„å†…å­˜ key-value å­˜å‚¨åº“ä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œå¹¶æœ€ç»ˆé€šè¿‡äº†æ‰€æœ‰å•å…ƒæµ‹è¯•ï¼Œåœ¨æœ€åå†æ¬¡å¼ºè°ƒäº†æ–‡æ¡£è§„èŒƒä»¥åŠä»£ç é£æ ¼ç»Ÿä¸€ã€ç¨‹åºå¥å£®çš„é‡è¦æ€§ã€‚æœ¬èŠ‚æ¶‰åŠçš„å®Œæ•´çš„æºç å‚è§ï¼štinkv_v0.2.0ã€‚ å‚è€ƒ Project 1: The Rust toolbox]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>ç½‘ç»œç¼–ç¨‹</tag>
        <tag>å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆä¸€ï¼‰ï¼šé¢„å¤‡çŸ¥è¯†]]></title>
    <url>%2F2020%2F04%2F15%2Ftalent-plan-rust-network-programming-bb1%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä»Šå¤©å¼€å§‹ã€ŒRust ç½‘ç»œç¼–ç¨‹å®è·µã€çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­çš„é¢„å¤‡çŸ¥è¯†å­¦ä¹ ï¼Œå¹¶æœ€ç»ˆèƒ½ç¼–å†™å‡ºä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä»¥ä¸‹ææ–™æ˜¯ä»Šå¤©éœ€è¦é˜…è¯»çš„ï¼š The Cargo manifest formatï¼šäº†è§£ Cargo mainfest æ–‡ä»¶æ ¼å¼ï¼› Cargo environment variablesï¼šäº†è§£ Cargo ç¯å¢ƒå˜é‡ï¼› Rust API Guidelines: Documentationï¼šäº†è§£ Rust ç¨‹åºä¸­çš„æ–‡æ¡£ç¼–å†™ï¼› Write a Good CLI Programï¼šå­¦ä¹ å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œç¨‹åºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¾æ¬¡å®Œæˆä¸Šè¿°ææ–™å­¦ä¹ ï¼Œç€é‡è®°å½•ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå¹¶åœ¨æœ€åç¼–å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºã€‚ Cargo Manifest æ–‡ä»¶æ ¼å¼ åœ¨ä½¿ç”¨ cargo å‘½ä»¤åˆ›å»ºçš„é¡¹ç›®ä¸­ï¼Œéƒ½ä¼šå­˜åœ¨ä¸€ä¸ª cargo.toml æ–‡ä»¶ï¼Œè¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„ manifestã€‚ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š 1234567891011[package]name = "app"version = "0.1.0"authors = ["0xE8551CCB &lt;user@host&gt;"]edition = "2018"[dependencies]clap = &#123;version = "2.33.0", features = ["yaml"]&#125;maplit = "1.0.2"lazy_static = "1.4.0"yaml-rust = "0.3.5" cargo.toml æ˜¯ç”±å¤šä¸ªéƒ¨åˆ†é…ç½®ç»„æˆçš„ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼ˆè¯¦ç»†å®šä¹‰è¯·å‚è€ƒæ–‡æ¡£ï¼‰ï¼š cargo-features: å®éªŒæ€§åŠŸèƒ½ [package]: åŒ…å®šä¹‰ï¼ˆå¦‚åç§°ã€ç‰ˆæœ¬ã€ä½œè€…ã€Rust ç¼–è¯‘å™¨ç‰ˆæœ¬ç­‰ï¼‰ [[lib]]: åº“çš„è®¾ç½® [[bin]]: äºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½® [[example]]: ç¤ºä¾‹æ–‡ä»¶è®¾ç½® [[test]]: æµ‹è¯•è®¾ç½® [[bench]]: åŸºå‡†æµ‹è¯•è®¾ç½® [dependencies]: ä¾èµ–åº“åˆ—è¡¨ [features]: æ¡ä»¶ç¼–è¯‘åŠŸèƒ½ [workspace]: å·¥ä½œç©ºé—´å®šä¹‰ Cargo ç¯å¢ƒå˜é‡ç¯å¢ƒå˜é‡å¯ä»¥ç”¨æ¥å’Œ rustc ä»¥åŠ Cargo è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­é€šè¿‡ env! å®æˆ–è€…åœ¨æ„å»ºè„šæœ¬ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¿™æ ·å¯ä»¥æ§åˆ¶æ„å»ºè¡Œä¸ºã€‚ç›¸å…³ç¯å¢ƒå˜é‡æ¯”è¾ƒå¤šï¼Œç¬”è€…åœ¨è¿™é‡Œä¸å¤šèµ˜è¿°äº†ï¼Œç­‰ç”¨åˆ°æ—¶å†æ¥æŸ¥é˜…ã€‚å»ºè®®æŠŠ Cargo environment variables ç®€å•é˜…è¯»ä¸‹ï¼Œç•™ä¸ªå°è±¡ã€‚ Rust ç¨‹åºæ–‡æ¡£ç¼–å†™Rust API Guidelines åˆ—å‡ºäº†ä¸€äº›è®¾è®¡å’Œç¼–å†™ Rust API çš„å»ºè®®ï¼Œä¸»è¦æ˜¯ç”± Rust Lib å°ç»„åœ¨æ„å»º Rust ç”Ÿæ€ï¼Œç¼–å†™æ ‡å‡†åº“å’Œä¸€äº›å…¶å®ƒ crates æœŸé—´æ€»ç»“è€Œæ¥ã€‚å½“ç„¶ï¼Œè¿™äº›å»ºè®®å¹¶éä¸€å®šéœ€è¦éµå®ˆï¼Œä¸è¿‡æ—¢ç„¶æ¥è‡ªäºå®˜æ–¹ï¼Œé‚£è¿˜æ˜¯éå¸¸å€¼å¾—åƒç¬”è€…è¿™æ ·çš„ Rust å°ç™½å­¦ä¹ çš„ã€‚ ä»Šå¤©ä¸»è¦å­¦ä¹ å…¶ä¸­å…³äºæ–‡æ¡£ç¼–å†™çš„ä¸€äº›å»ºè®®ï¼Œå…¶å®ƒå†…å®¹å»ºè®®æŠ½ç©ºé˜…è¯»ä¸‹ã€‚å…³äºæ–‡æ¡£ç¼–å†™çš„ä¸€äº›å¤§å»ºè®®æ¢³ç†å¦‚ä¸‹ï¼ˆè¯¦ç»†ç¤ºä¾‹è¿˜è¯·å‚è§æ–‡æ¡£ Rust API Guidelines: Documentationï¼‰ï¼š crate çº§åˆ«çš„æ–‡æ¡£åº”è¯¥æ˜¯å…¨é¢è¯¦ç»†çš„ï¼Œä¸”åŒ…å«ä½¿ç”¨ç¤ºä¾‹ï¼› æ‰€æœ‰å…¬å¼€çš„æ¨¡å—ã€traitã€structã€enumã€å‡½æ•°ã€æ–¹æ³•ã€å®ä»¥åŠç±»å‹å®šä¹‰éƒ½éœ€è¦æä¾›ä½¿ç”¨ç¤ºä¾‹ï¼› æ–‡æ¡£ä¸­çš„å®ä¾‹åº”è¯¥ä½¿ç”¨ ? å¤„ç†é”™è¯¯ï¼Œè€Œé try! æˆ–è€… unwrapï¼› å‡½æ•°çš„æ–‡æ¡£ä¸­åº”è¯¥åŒ…æ‹¬ï¼šå‡½æ•°åŠŸèƒ½æè¿°ã€è¿”å›çš„é”™è¯¯ï¼ˆ# Errorsï¼‰ã€Panic æƒ…å†µï¼ˆ# Panicsï¼‰ä»¥åŠä¸€äº›å®‰å…¨ä½¿ç”¨çš„æç¤ºï¼ˆ# Saftyï¼Œæ¯”å¦‚ std::ptr::read è¿™ç§ unsafe å‡½æ•°ï¼‰ï¼› æ–‡æ¡£ä¸­æåˆ°çš„ç±»å‹åº”è¯¥å…³è”åˆ°å¯¹åº”çš„æ–‡æ¡£ï¼ˆLink all the thingsï¼‰ï¼› Cargo.toml ä¸­åº”è¯¥åŒ…å«æ‰€æœ‰å¸¸ç”¨çš„å…ƒä¿¡æ¯ï¼š authors description license repository readme keywords categories crate è¦è®¾ç½®æ­£ç¡®çš„ #![doc(html_root_url = &quot;https://docs.rs/CRATE/MAJOR.MINOR.PATCH&quot;)]ï¼Œå°¤å…¶è¦æ³¨æ„è¿™é‡Œçš„ç‰ˆæœ¬å·è¦å’Œ Cargo.toml ä¸­çš„ version ä¿æŒä¸€è‡´ï¼› åœ¨å‘å¸ƒæ—¥å¿—ï¼ˆRelease notesï¼‰ä¸­è®°å½•æ‰€æœ‰é‡å¤§å˜æ›´ï¼Œå°¤å…¶æ˜¯ä¸å…¼å®¹å˜æ›´éœ€è¦æ¸…æ™°æŒ‡å‡ºï¼› å¯ä»¥é€šè¿‡ #[doc(hidden)] å°†ä¸€äº›æ²¡ä»€ä¹ˆå¸®åŠ©çš„å®ç°ç»†èŠ‚ï¼ˆå¦‚ç§æœ‰ç±»å‹å…³è”çš„æ–¹æ³•å®ç°ç­‰ï¼‰ä»ç”Ÿæˆçš„æ–‡æ¡£ä¸­éšè—èµ·æ¥ã€‚ å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œï¼ˆCLIï¼‰ç¨‹åºï¼ˆWrite a Good CLI Programï¼‰Write a Good CLI Program ä¸€æ–‡ä¸­è®²è§£åœ¨ä½¿ç”¨ Rust ç¼–å†™å‘½ä»¤è¡Œç¨‹åºçš„æœ€ä½³å®è·µï¼Œæ ¸å¿ƒçŸ¥è¯†ç‚¹åŒ…æ‹¬ï¼š ä½¿ç”¨ clap crates ç¼–å†™å¯ä»¥æ¥æ”¶å¤æ‚å‚æ•°çš„å‘½ä»¤è¡Œç¨‹åºï¼› ä½¿ç”¨ .env ç¼–å†™åº”ç”¨é…ç½®ï¼Œä½¿ç”¨ dotenv è¯»å–ç¯å¢ƒå˜é‡ï¼› é”™è¯¯å¤„ç†ï¼š panic ä¼šå¯¼è‡´ç¨‹åºç›´æ¥é€€å‡ºï¼Œé€€å‡ºæ²¡æœ‰é”™è¯¯ç ï¼Œé€‚åˆåœ¨è„šæœ¬ä¸­ä½¿ç”¨ï¼› å‡½æ•°è¿”å› Resultï¼Œå¯ä»¥æ ¹æ®æ˜¯å¦ä¸º Error æ¥å†³å®šåç»­æ“ä½œï¼› å¯ä»¥ä¸ºè‡ªå®šä¹‰ Error å®ç° fmt::Display traitï¼Œæ–¹ä¾¿æ ¼å¼åŒ–è¾“å‡ºé”™è¯¯æ¶ˆæ¯ã€‚ ä½¿ç”¨ println!() ä¼šæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸­ï¼Œè€Œä½¿ç”¨ eprintln!() åˆ™æ˜¯æ ‡å‡†é”™è¯¯ï¼› ä½¿ç”¨ std::process::exit(1) è®¾ç½®ç¨‹åºé€€å‡ºç ï¼ˆExit Codeï¼‰ã€‚ æ‰€è°“çš„å‘½ä»¤è¡Œç¨‹åºï¼ˆCommand Line Interface, CLIï¼‰å°±æ˜¯æŒ‡åœ¨ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºï¼Œæ²¡æœ‰å›¾å½¢ç•Œé¢ã€‚æ¯”å¦‚ ls, ps ç­‰ã€‚åœ¨ awesome-cli-apps ä¸­æ”¶é›†äº†å¾ˆå¤šæ¯”è¾ƒä¼˜è´¨çš„å‘½ä»¤è¡Œç¨‹åºã€‚ é¢˜å¤–è¯ï¼šä½œè€…å®‰åˆ©äº†ä¸€ä¸ªå«ä½œ exa å‘½ä»¤è¡Œç¨‹åºï¼Œä½¿ç”¨ Rust è¯­è¨€å®ç°ï¼Œå¯ä»¥æ›¿ä»£ ls å‘½ä»¤ã€‚ç¬”è€…è¯•ç”¨äº†ä¸€ä¸‹ï¼Œä½“éªŒä¸é”™ã€‚ å‘½ä»¤è¡Œç¨‹åºé•¿ä»€ä¹ˆæ ·ä¸€èˆ¬è€Œè¨€ï¼Œå‘½ä»¤è¡Œç¨‹åºä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1$./program [args] [flags] [options] å¯ä»¥é€šè¿‡ -h æˆ– --help æŸ¥çœ‹æ›´å¤šå¸®åŠ©ä¿¡æ¯ã€‚ åŠ¨æ‰‹å®è·µå¤§ç¥ Linus Torvalds æ›¾è¨€ã€ŒTalk is cheap, show me the codeã€ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æŠŠ Write a Good CLI Program ä¸­æåˆ°çš„ä¸€äº›æŠ€å·§å®è·µä¸€éã€‚ ç¬”è€…æ›¾ç»ä½¿ç”¨ Rust å®ç°è¿‡ä¸€ä¸ªå°å·¥å…· gicï¼Œå®ƒå¯ä»¥ç”Ÿæˆé£æ ¼ä¸€è‡´çš„ git commit messageï¼Œè¿˜ç®—å®ç”¨ã€‚æ¥ä¸‹æ¥å®ç°ä¸€ä¸ªç®€å•ç‰ˆæœ¬ gitc ä»…ä¾›å‚è€ƒï¼Œå…¨éƒ¨ä»£ç å‚è§ talent-plan-projects/gitcã€‚ é¦–å…ˆä½¿ç”¨ cargo åˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼š 12$ cargo new gitc$ cd gitc åº”ç”¨ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 12345678.â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ srcâ”‚ â”œâ”€â”€ cli.ymlâ”‚ â””â”€â”€ main.rsâ””â”€â”€ target â””â”€â”€ debug å®šä¹‰å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶1234567891011121314&lt;--cli.yml--&gt;name: gitcversion: &quot;0.1.0&quot;author: 0xE8551CCB &lt;noti@ifaceless.space&gt;about: Generate elegant and uniform commit messageargs: - message: required: true index: 1 takes_value: true help: Use the given &lt;message&gt; as the commit message - use-emoji-code-only: long: use-emoji-code-only help: Use emoji code instead of emoji æ³¨å†Œ emoji åˆ—è¡¨ä¸ºäº†æ–¹ä¾¿æ‰©å±•ï¼Œå°† emoji ç›¸å…³ä¿¡æ¯æ”¾ç½®åœ¨å…¨å±€çš„åˆ—è¡¨ä¸­ï¼Œæ‰©å±•åªéœ€è¦æ–°å¢åˆ—è¡¨é¡¹å³å¯ã€‚è¿™é‡Œä½¿ç”¨ layzy_static å®ï¼Œä»–å¯ä»¥å®šä¹‰éœ€è¦åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œç”¨æ³•ç±»ä¼¼åœ¨å…¶å®ƒè¯­è¨€ä¸­å®šä¹‰å…¨å±€å˜é‡ã€‚ 12345678910111213141516171819use lazy_static::lazy_static;lazy_static! &#123; // è¿™é‡Œæ³¨å†Œ git emoji åˆ—è¡¨ static ref GITMOJI_LIST: Vec&lt;HashMap&lt;&amp;'static str, &amp;'static str&gt;&gt; = vec![ hashmap! &#123; "name" =&gt; "feat", "emoji" =&gt; "âœ¨", "code" =&gt; ":feat:", "description" =&gt; "âœ¨ Introduce new features" &#125;, hashmap! &#123; "name" =&gt; "fix", "emoji" =&gt; "ğŸ›", "code" =&gt; ":fix:", "description" =&gt; "ğŸ› Fix bugs" &#125; ];&#125; æ„å»ºå‘½ä»¤è¡Œ Appclap æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€å·¥ä½œé«˜æ•ˆçš„ Rust å‘½ä»¤è¡Œè§£æå™¨ï¼Œå€ŸåŠ©å®ƒå¯ä»¥éå¸¸è½»æ¾åœ°åˆ›å»ºå‘½ä»¤è¡Œåº”ç”¨ã€‚gitc åœ¨åˆ›å»ºæ—¶ï¼Œä¸€éƒ¨åˆ†å‘½ä»¤è¡Œé…ç½®æ¥è‡ªé™æ€çš„ YAML æ–‡ä»¶ï¼Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯åŸºäºä¸Šè¿°å¯æ‰©å±•çš„ emoji åˆ—è¡¨é…ç½®ã€‚ 123456789101112fn make_cli_app&lt;'a, 'b&gt;(yml: &amp;'a Yaml) -&gt; App&lt;'a, 'b&gt; &#123; let mut app = App::from_yaml(yml); // å°† gitmoji ç›¸å…³å‘½ä»¤æ³¨å†Œè¿›æ¥ for item in GITMOJI_LIST.iter() &#123; app = app.arg( Arg::with_name(item.get("name").unwrap()) .help(item.get("description").unwrap()) .long(item.get("name").unwrap()), ); &#125; app&#125; ç†è§£å‘½ä»¤è¡Œå‚æ•°å¹¶ç”Ÿæˆæ‰§è¡Œé…ç½®ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸‹é¢æŠ½è±¡äº†ä¸€ä¸ª CommitConfig ç»“æ„ä½“ï¼Œç”¨äºå°† git commit æœ‰å…³çš„ç‰¹æ®Šé…ç½®é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è§£æåˆ°è¿™é‡Œã€‚å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627#[derive(Debug)]struct CommitConfig &#123; message: String, use_emoji_code_only: bool, gitmoji: Option&lt;Gitmoji&gt;,&#125;impl CommitConfig &#123; fn from_cli_arg_matches(m: &amp;ArgMatches) -&gt; Self &#123; let message = m.value_of("message").unwrap(); let use_emoji_code_only = m.is_present("use-emoji-code-only"); CommitConfig &#123; message: message.to_string(), use_emoji_code_only: use_emoji_code_only, gitmoji: Self::match_gitmoji(m), &#125; &#125; fn match_gitmoji(m: &amp;ArgMatches) -&gt; Option&lt;Gitmoji&gt; &#123; for x in GITMOJI_LIST.iter() &#123; if m.is_present(x.get("name").unwrap()) &#123; return Some(Gitmoji::from_gitmoji_config(x)); &#125; &#125; None &#125;&#125; æ‰§è¡Œ git commit å‘½ä»¤ç”±äºéœ€è¦é€šè¿‡ Shell æ‰§è¡Œ git commit å‘½ä»¤ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ std::process::Command ååŠ©å®Œæˆã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š 1234567891011121314fn do_git_commit(c: &amp;CommitConfig) -&gt; Result&lt;(), std::io::Error&gt; &#123; let mut msg = c.message.to_string(); // æ„å»º commit æ¶ˆæ¯...ï¼ˆçœç•¥æ¶ˆæ¯æ„å»ºä»£ç ï¼‰ let mut cmd = Command::new("git"); cmd.arg("commit").arg("-m").arg(msg); // æ‰§è¡Œå‘½ä»¤ï¼Œæ‹¿åˆ°è¾“å‡ºç»“æœ let output = cmd.output()?; println!("&#123;&#125;", String::from_utf8_lossy(&amp;output.stdout)); if !output.status.success() &#123; eprintln!("&#123;&#125;", String::from_utf8_lossy(&amp;output.stderr)); &#125; Ok(())&#125; ç¼–å†™ main å‡½æ•°å¥½å•¦ï¼Œç°åœ¨å¯ä»¥å°†ä¸Šè¿°è¿‡ç¨‹ä¸²è”èµ·æ¥ï¼Œå®Œæˆæˆ‘ä»¬çš„ gitc å‘½ä»¤è¡Œå·¥å…·ï¼š 123456789101112fn main() &#123; let yml = load_yaml!("cli.yml"); let matches = make_cli_app(yml).get_matches(); let commit_config = CommitConfig::from_cli_arg_matches(&amp;matches); match do_git_commit(&amp;commit_config) &#123; Ok(_) =&gt; (), Err(e) =&gt; &#123; eprintln!("Error: &#123;&#125;", e); process::exit(1); &#125; &#125;&#125; å®Œæˆåï¼Œä½¿ç”¨ cargo build å¯ä»¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š å°ç»“æœ¬èŠ‚é¢„å¤‡çŸ¥è¯†ä¸»è¦å­¦ä¹ äº†ä¸ Cargo æœ‰å…³çš„ç¯å¢ƒå˜é‡ä½œç”¨ã€Cargo.toml ä¸­çš„å…ƒä¿¡æ¯æ„æˆä»¥åŠç¼–å†™è§„èŒƒçš„ API æ–‡æ¡£çš„æ–¹æ³•ï¼Œæœ€åé€šè¿‡ç¼–å†™ talent-plan-projects/gitc æŒæ¡äº†å¦‚ä½•ç¼–å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºä»¥åŠä¸€äº›æœ€ä½³å®è·µã€‚ å‚è€ƒ PNA Rust â€” Building Blocks 1]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>ç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µå…¥é—¨]]></title>
    <url>%2F2020%2F04%2F15%2Ftalent-plan-rust-network-programming-intro%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ¬èŠ‚å°†å¼€å§‹ã€ŒTalent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µã€ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å•¦ï¼Œè¯¥ç³»åˆ—è¯¾ç¨‹çš„æœ€ç»ˆç›®æ ‡æ˜¯ä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ä¸€ä¸ªé«˜æ€§èƒ½çš„å•æœºæ—¥å¿—ç±»å‹ï¼ˆlog-structuredï¼‰ key/value å­˜å‚¨æœåŠ¡ï¼Œåˆ†ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®è¿›è¡Œé€šä¿¡ï¼Œèƒ½å¤Ÿä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œæ“ä½œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥ç³»åˆ—è¯¾ç¨‹å¹¶éé¢å‘åˆçº§ç¼–ç¨‹çˆ±å¥½è€…ã€‚å‚ä¸è¯¥ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å’Œå®è·µå‰ï¼Œæœ€å¥½å·²ç»æœ‰è¿‡å…¶å®ƒè¯­è¨€ç¼–ç¨‹ç»éªŒï¼Œå¹¶ä¸”å¯¹ Rust è¯­è¨€æœ‰åŸºæœ¬äº†è§£ï¼Œå†™è¿‡ä¸€äº› Rust ä»£ç ã€‚ç¬”è€…å¼ºçƒˆå»ºè®®é˜…è¯» The Rust Book æˆ–è€…ã€ŠRust ç¼–ç¨‹ä¹‹é“ã€‹è¿™æ ·çš„ä¹¦ç±æ¥æ‰“å¥½åŸºç¡€ã€‚Rust ä¸­å¼•å…¥çš„æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸç­‰æ¦‚å¿µéœ€è¦è½¬å˜æ€ç»´æ¥ç†è§£å®ƒï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½åœ°é¢†æ‚Ÿåˆ°è¿™é—¨è¯­è¨€çš„ç²¾é«“ã€‚ å¤§çº²ä»¥ä¸‹æ˜¯ Rust ç½‘ç»œç¼–ç¨‹å®è·µè¯¾ç¨‹å¤§çº²ï¼Œæ€»å…±åˆ†ä¸ºå…­ä¸ªéƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ªéƒ¨åˆ†è¿˜æ²¡å®Œæˆï¼‰ï¼Œå¾ªåºæ¸è¿›åœ°å¼•å¯¼æˆ‘ä»¬é˜…è¯»ä¸€äº›åšå®¢ï¼ŒæŒæ¡æœ€ä½³ç¼–ç¨‹å®è·µï¼Œé€šè¿‡ä¸æ–­å®è·µæ¥åŠ æ·±å¯¹è¿™é—¨è¯­è¨€çš„ç†è§£ã€‚ å­¦ä¹ å§¿åŠ¿GitHub talent-plan ä»“åº“ä¸­å­˜æ”¾äº†è¯¾ç¨‹ä¸­å®‰æ’çš„ç¼–ç¨‹é¡¹ç›®ï¼Œä½äº /rust/projects ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ¯ä¸€ä¸ªé¡¹ç›®éƒ½æ˜¯åŸºäºå‰ä¸€ä¸ªé¡¹ç›®è¿›è¡Œæ”¹é€ çš„ï¼Œåœ¨æ¯ä¸ªé¡¹ç›®ä¸­éƒ½ä¼šå¢é‡åº”ç”¨ä¸€äº›æ–°çš„ Rust çŸ¥è¯†ï¼Œæ¯”å¦‚å­¦ä¹ å¼•å…¥ç¬¬ä¸‰æ–¹ cratesï¼Œä½¿ç”¨æ ‡å‡†ç½‘ç»œåº“ï¼Œä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ”¹è¿›æœåŠ¡æ€§èƒ½ç­‰ã€‚ åœ¨è¿›è¡Œæ¯ä¸ªé¡¹ç›®å®è·µä¹‹å‰ï¼Œä¼šæœ‰ä¸€ä¸ªé’ˆå¯¹æ€§çš„ Building Blockï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸€äº›é¢„å¤‡çŸ¥è¯†ã€‚åœ¨é¢„å¤‡çŸ¥è¯†ä¸­ï¼Œä¼šé’ˆå¯¹å’Œæ¥ä¸‹æ¥è¦å®è·µçš„é¡¹ç›®æœ‰å…³çš„è¯é¢˜ï¼Œæä¾›ä¸€äº›é˜…è¯»ææ–™å’Œç»ƒä¹ é¢˜ï¼Œåœ¨é˜…è¯»å®Œæˆåå¯ä»¥é€šè¿‡ç»ƒä¹ é¢˜å·©å›ºä¸‹å­¦ä¹ åˆ°çš„çŸ¥è¯†ï¼Œè¿™æ ·åœ¨è¿›è¡Œé¡¹ç›®å®è·µæ—¶ä¼šæ›´åŠ å¾—å¿ƒåº”æ‰‹ï¼Œæå‡æ•ˆç‡ã€‚ å¼€å‘ç¯å¢ƒå‡†å¤‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ rustup ç®¡ç† Rust ç‰ˆæœ¬åŠç›¸å…³çš„å·¥å…·é“¾ã€‚å¦‚æœè¿˜æ²¡æœ‰å®‰è£… Rust ç¼–è¯‘å™¨ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¡Œå®Œæˆï¼ˆLinux æˆ–è€… macOS ç¯å¢ƒï¼‰ï¼š 1$ curl https://sh.rustup.rs -sSf | sh rustup å·¥å…·ä¼šä¸ºæˆ‘ä»¬å®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„ Rust ç¼–è¯‘å™¨ã€‚ä¹‹åä¹Ÿå¯ä»¥é€šè¿‡ rustup update è¿›è¡Œç‰ˆæœ¬æ›´æ–°ï¼Œæˆ–è€…ä½¿ç”¨ rustup self uninstall å®Œæˆ Rust ç¼–è¯‘å™¨å’Œ rustup å¸è½½ã€‚è¯¦ç»†æ“ä½œä¸å†èµ˜è¿°ï¼Œå¯å‚è§ Rust Getting Startedã€‚ ä¸‹é¢ç¬”è€…å°†è¦å®‰åˆ©ä¸¤æ¬¾ç¥å™¨çº§æ’ä»¶ï¼Œä¾¿äºæå‡ Rust ç¼–ç¨‹ä½“éªŒã€‚æ—©æœŸçš„ Rust IDE æ”¯æŒæ¯”è¾ƒå·®ï¼Œæ˜æ˜¾æ²¡æœ‰å…¶å®ƒè¯­è¨€åœ¨ IDE ä¸­ä½“éªŒèˆ’æœï¼ˆç¬”è€…æ›¾ç»åœ¨ Clion ä¸­å°è¯• Rust æ’ä»¶ï¼Œä½†æ˜¯æ•ˆæœæ¬ ä½³ï¼‰ã€‚ä¸è¿‡ç¤¾åŒºä¸€ç›´éƒ½åœ¨åŠªåŠ›æ”¹è¿›è¿™ä¸€ç‚¹ï¼Œä¸‹é¢ä»‹ç»ä¸‹ç¬”è€…çš„å¼€å‘ç¯å¢ƒï¼Œä»…ä¾›å‚è€ƒã€‚ Rust ç‰ˆæœ¬ï¼š1.42 ä»£ç ç¼–è¾‘å™¨ï¼šVisual Studio Code æ’ä»¶ï¼š rust-analyzerï¼šè¿™ä¸ªæ˜¯ç”¨æ¥æ›¿ä»£ RLSï¼ˆRust Language Serverï¼‰çš„å®éªŒäº§å“ï¼Œç›®æ ‡æ˜¯æä¾›æ›´åŠ ä¼˜ç§€çš„ IDE åŠŸèƒ½æ”¯æŒã€‚ç›®å‰è™½ç„¶å¤„äº alpha é˜¶æ®µï¼Œä¸è¿‡ç›¸å¯¹å·²æœ‰çš„å…¶å®ƒæ’ä»¶ï¼Œå·²ç»éå¸¸å®ç”¨äº†ã€‚æ”¯æŒä»£ç è‡ªåŠ¨è¡¥é½ã€æ–‡æ¡£æç¤ºã€å‡½æ•°å®ç°è·³è½¬ã€main å‡½æ•°è¯†åˆ«ã€å•å…ƒæµ‹è¯•è¯†åˆ«ç­‰ã€‚æ¨èä½¿ç”¨~ TabNineï¼šè¿™æ˜¯ä¸€æ¬¾æ™ºèƒ½ä»£ç è‡ªåŠ¨è¡¥å…¨å·¥å…·ï¼Œé‡‡ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯åŠ é€Ÿä»£ç ç¼–å†™ï¼Œæ”¯æŒä¸»æµç¼–ç¨‹è¯­è¨€ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒTabNine æœåŠ¡æœ¬èº«æ˜¯ä½¿ç”¨ Rust ç¼–å†™ï¼Œæ‰€ä»¥å®ƒçš„å¾ˆå¤šä»˜è´¹åŠŸèƒ½éƒ½æ˜¯å¯¹ Rust è¯­è¨€å¼€æ”¾çš„ï¼Œæ‰€ä»¥å°½ç®¡ä½¿ç”¨å§ã€‚ å…³äºè°ƒè¯•æŒæ¡è°ƒè¯•æŠ€èƒ½ï¼Œå¯¹äºæ’æŸ¥ç¨‹åºé—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚é‚£ä¹ˆå¦‚ä½•åœ¨ Visual Studio Code ä¸­è°ƒè¯•æˆ‘ä»¬çš„ Rust é¡¹ç›®å‘¢ï¼Ÿä¸‹é¢å°†ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ¼”ç¤ºä¸‹å¦‚ä½•è¿›è¡Œè°ƒè¯•ã€‚ é¦–å…ˆï¼Œåœ¨å·¥ç¨‹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªç¤ºä¾‹é¡¹ç›® cargo new miaoï¼Œç„¶åè¾“å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶æ‰§è¡Œ cargo buildï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä½äº target/debug ç›®å½•ä¸‹ã€‚ 1234567891011121314151617181920212223242526fn main() &#123; assert_eq!(binary_search(vec![1, 2, 3, 4, 5, 8], 10), -1); assert_eq!(binary_search(vec![1, 2, 3, 4, 5, 8], 1), 0);&#125;fn binary_search(nums: Vec&lt;i32&gt;, target: i32) -&gt; i32 &#123; if nums.len() == 0 &#123; return -1; &#125; let mut left = 0; let mut right = nums.len() - 1; while left &lt; right &#123; let mid = left + (right - left) / 2; if nums[mid] == target &#123; return mid as i32; &#125; else if nums[mid] &lt; target &#123; left = mid + 1; &#125; else &#123; right = mid - 1; &#125; &#125; -1&#125; æ¥ä¸‹æ¥ï¼Œç‚¹å‡» vscode å·¦ä¾§å·¥å…·æ ä¸­çš„ã€Œè°ƒè¯•ã€æŒ‰é’®ï¼Œå¹¶ä¸”ç‚¹å‡»ã€Œcreate a launch.json fileã€æŒ‰é’®ï¼Œåˆ›å»ºå¯åŠ¨é…ç½®æ–‡ä»¶ã€‚åœ¨å¼¹å‡ºçš„å€™é€‰æ¡†ä¸­é€‰æ‹©ã€ŒC++ (GDB/LLDB)ã€ã€‚ ç´§æ¥ç€ï¼Œç¼–è¾‘ç”Ÿæˆçš„ .vscode/launch.json æ–‡ä»¶ï¼Œä¿®æ”¹å…¶ä¸­çš„ç¨‹åºå¯åŠ¨é…ç½®ï¼Œå³ configurations.program æŒ‡å‘å¯æ‰§è¡Œæ–‡ä»¶ ${workspaceFolder}/target/debug/miaoã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨ä»£ç ä¸­æ·»åŠ æ–­ç‚¹ï¼Œç„¶åæ‰§è¡Œ cargo buildï¼ˆé»˜è®¤ä¼šä»¥ debug æ¨¡å¼æ„å»ºï¼‰ï¼Œæœ€åå¯åŠ¨è°ƒè¯•å³å¯ã€‚ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· rust-lldb æ‰§è¡Œè°ƒè¯•ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥å‰å¾€ Rust LLDB è°ƒè¯•å…¥é—¨æŒ‡åŒ— äº†è§£æ›´å¤šç»†èŠ‚ã€‚ å°ç»“æœ¬èŠ‚å¯¹ã€ŒTalent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µã€ç³»åˆ—è¯¾ç¨‹è¿›è¡Œäº†ç®€å•ä»‹ç»ï¼Œäº†è§£è¯¾ç¨‹çš„å…·ä½“å®‰æ’ï¼Œå¹¶åœ¨æœ€åç»™å‡ºäº† Rust å¼€å‘ç¯å¢ƒæ­å»ºçš„ä¸€äº›å‚è€ƒã€‚ å‚è€ƒ Practical Networked Applications in Rust]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>ç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PingCAP Talent Plan è¯¾ç¨‹ä»‹ç»]]></title>
    <url>%2F2020%2F04%2F13%2Ftalent-plan-summary%2F</url>
    <content type="text"><![CDATA[å¼•è¨€éšç€ç§»åŠ¨äº’è”ç½‘ã€ç‰©è”ç½‘ã€äº‘è®¡ç®—ä»¥åŠæœªæ¥ 5G æŠ€æœ¯åœºæ™¯çš„åº”ç”¨æ‹“å±•ï¼Œç›¸å…³åº”ç”¨çš„æ•°æ®è§„æ¨¡ä¹Ÿåœ¨ä¸æ–­å¢é•¿ï¼Œé¢ä¸´çš„å­˜å‚¨å‹åŠ›è¶Šå‘æ˜æ˜¾ã€‚åœ¨æ­¤èƒŒæ™¯ä¸‹ï¼Œä¼ ç»Ÿçš„å•æœº MySQL æ•°æ®åº“å·²ç»æ— æ³•è½»æ¾åº”ä»˜ï¼Œå³ä¾¿ä»¥åˆ†åº“åˆ†è¡¨çš„æ–¹å¼åº”å¯¹ï¼Œä¹Ÿä¾ç„¶å­˜åœ¨æ‰©å±•æ€§è¾ƒå·®ã€å¯ä¼¸ç¼©èƒ½åŠ›ä¸è¶³ã€è‡ªåŠ¨åŒ–è¿ç»´èƒ½åŠ›ä¸è¶³ç­‰é—®é¢˜ã€‚ä¼´éšç€ Google å†…éƒ¨çš„åˆ†å¸ƒå¼æ•°æ®åº“ Spanner å’Œ F1 çš„è®¾è®¡æ€æƒ³å¼€æ”¾ï¼ŒPingCAP å…¬å¸åœ¨ 2015 å¹´å—åˆ°ç›¸åº”çš„å¯å‘åå¼€å‘äº† TiDB æ•°æ®åº“ï¼Œå†ç»å°†è¿‘äº”å¹´çš„è¿­ä»£ï¼Œç›®å‰å®ƒå·²ç»æˆä¸ºå¼€æºç¤¾åŒºéå¸¸çŸ¥åçš„ NewSQL æ•°æ®åº“ä»£è¡¨äº†ï¼Œå¹¶ä¸”å·²ç»åœ¨è¯¸å¤šçŸ¥åä¼ä¸šä¸­å¾—åˆ°äº†éƒ¨ç½²å’Œåº”ç”¨ã€‚ åœ¨æ­£å¼å¼•å…¥ PingCAP Talent Plan ç³»åˆ—è¯¾ç¨‹ä»‹ç»å‰ï¼Œæœ‰å¿…è¦å¯¹ TiDB æœ‰æ‰€äº†è§£ã€‚ä»¥ä¸‹å°†è¦ä»‹ç»çš„å†…å®¹åŒ…æ‹¬ï¼š TiDB æ˜¯ä»€ä¹ˆï¼Ÿ TiDB çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ ä¸ºä»€ä¹ˆä¼šè¯ç”Ÿ Talent Plan è¯¾ç¨‹ï¼Ÿ Talent Plan è¯¾ç¨‹å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ åˆè¯† TiDBä»å®˜ç½‘ä¸Šå¾—çŸ¥ï¼ŒTiDB æ˜¯ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œå¹¶ä¸”é«˜åº¦å…¼å®¹ MySQL åè®®ï¼Œè¿™ä¹Ÿä¸ºæˆ‘ä»¬è¿ç§»å¹¿æ³›åŸºäº MySQL çš„åº”ç”¨å¥ å®šäº†åŸºç¡€ã€‚ä¸‹é¢æ¥çœ‹çœ‹å®ƒä¸»è¦æœ‰å“ªäº›ç‰¹æ€§å‘¢ï¼Ÿ æ”¯æŒ OLTP + OLAP çš„æ··åˆåœºæ™¯ï¼Œæ˜¯ä¸€æ¬¾ HTAPï¼ˆHybrid Transactional/Analytical Processingï¼‰ èåˆå‹æ•°æ®åº“äº§å“ï¼› æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¹è§‚äº‹åŠ¡+æ‚²è§‚äº‹åŠ¡æ¨¡å‹å‡æ”¯æŒï¼‰ï¼› é«˜å¯ç”¨ï¼Œå…·å¤‡æ•…éšœè‡ªåŠ¨æ¢å¤èƒ½åŠ›ï¼› æ˜“äºä¼¸ç¼©ï¼ŒTiDB å’Œ TiKV å‡å¯æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒæµ·é‡æ•°æ®å­˜å‚¨ï¼› TiDB 4.0 å…¨é¢æ‹¥æŠ±äº‘åŸç”Ÿï¼Œæä¾›äº†éå¸¸å¤šçš„éƒ¨ç½²æ–¹å¼ï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿æœ¬åœ°éƒ¨ç½²æµ‹è¯•ï¼Œtiup å·¥å…·çš„è¯ç”Ÿï¼Œä¹Ÿä¸ºåƒç¬”è€…è¿™æ ·çš„å°ç™½ç”¨æˆ·é“ºå¹³äº†é“è·¯ã€‚ æ ¸å¿ƒç»„ä»¶ TiDB in Action ä¸­å¯¹äº TiDB çš„æ•´ä½“æ¶æ„æœ‰è¯¦ç»†çš„æè¿°ã€‚æ¦‚æ‹¬æ¥è¯´ï¼ŒTiDB çš„æ•´ä½“æ¶æ„æ¸…æ™°æ˜“æ‡‚ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š TiDBï¼šæ­¤ä¸º SQL å±‚ï¼Œå³æ— çŠ¶æ€è®¡ç®—å±‚ã€‚è´Ÿè´£ SQL è§£æã€ä¼˜åŒ–ï¼Œå¹¶ç”Ÿæˆåˆ†å¸ƒå¼æ‰§è¡Œè®¡åˆ’ã€‚å®é™…çš„æ•°æ®è¯·æ±‚ä¼šå‘é€ç»™åº•å±‚çš„å­˜å‚¨å¼•æ“ TiKVã€‚å…·ä½“å¯ä»¥é˜…è¯» è°ˆè®¡ç®— äº†è§£æ›´å¤šç»†èŠ‚ã€‚ TiKVï¼šæ­¤ä¸ºå­˜å‚¨å¼•æ“å±‚ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„ KV æ•°æ®åº“ã€‚TiFlash æ˜¯åˆ—å¼å­˜å‚¨å¼•æ“ï¼Œä¸»è¦æ˜¯é’ˆå¯¹åˆ†æå‹åœºæ™¯æŸ¥è¯¢è€Œè®¾è®¡ã€‚ å…·ä½“å¯ä»¥é˜…è¯» è¯´å­˜å‚¨ å’Œ TiFlash æ¶æ„åŸç† äº†è§£æ›´å¤šç»†èŠ‚ã€‚ PDï¼šå…¨ç§°ä¸º Placement Driverï¼Œå®ƒè´Ÿè´£æ•´ä¸ª TiDB é›†ç¾¤çš„å…ƒä¿¡æ¯ç®¡ç†ã€å­˜å‚¨èŠ‚ç‚¹è®¿é—®è‡ªåŠ¨è´Ÿè½½å‡è¡¡è°ƒåº¦ã€åˆ†å¸ƒå¼äº‹åŠ¡ ID åˆ†é…ç­‰ï¼Œå¯ä»¥çœ‹æˆæ•´ä¸ªé›†ç¾¤çš„å¤§è„‘ã€‚å¯ä»¥é˜…è¯» è®²è°ƒåº¦ äº†è§£æ›´å¤šç»†èŠ‚ã€‚ æ›´å¤šå­¦ä¹ èµ„æºTiDB çš„ç¤¾åŒºèµ„æºç›¸å½“ä¸°å¯Œï¼Œåœ¨ PingCAP å®˜ç½‘ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå¤šå­¦ä¹ èµ„æºï¼Œç¬”è€…ç®€å•æ•´ç†äº†ä¸‹ï¼Œä¼ é€é—¨å¦‚ä¸‹ï¼š å¿«é€Ÿå…¥é—¨ï¼› æœ€ä½³å®è·µï¼› å‘¨è¾¹å·¥å…·ï¼› DM æºç è§£è¯»ï¼› TiDB Binglog æºç è§£è¯»ï¼› TiDB æºç è§£è¯»ï¼› TiKV æºç è§£è¯»ï¼› PingCAP Universityï¼› æ·±å…¥ TiKVã€‚ è·ƒè·ƒæ¬²è¯•å¦‚æœå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæ„Ÿå…´è¶£çš„è¯ï¼Œé‚£ä¹ˆè·Ÿç€ PingCAP æ¨å‡ºçš„ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å¹¶å‚ä¸åˆ°å¼€æºé¡¹ç›®ä¸­ï¼Œä¸€å®šä¼šæœ‰å¾ˆå¤šæ”¶è·ã€‚ä¸è¿‡é¢å¯¹å¦‚æ­¤åºå¤§çš„ç³»ç»Ÿï¼Œæƒ³è¦æ·±å…¥äº†è§£å…¶åŸç†å¹¶èƒ½å¤Ÿè¯»æ‡‚æºç è¿˜æ˜¯æœ‰äº›é—¨æ§›çš„ã€‚å¥½åœ¨æœ‰å¾ˆå¤šå®˜æ–¹çš„æºç è§£è¯»åšå®¢å¯ä»¥å­¦ä¹ ~ ä¸è¿‡åœ¨å®é™…å­¦ä¹ ä¸­è¿˜æ˜¯é‡åˆ°ä¸€äº›å›°éš¾ï¼Œæ¯”å¦‚ç¼–ç¨‹è¯­è¨€ï¼ˆGo å’Œ Rustï¼‰å®è·µä¸è¶³ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºå’Œå®è·µç»“åˆå­˜åœ¨é¸¿æ²Ÿç­‰ã€‚æ‰€ä»¥ï¼ŒPingCAP å®˜æ–¹æ¨å‡ºäº† Talent Plan è¯¾ç¨‹ï¼Œåˆ†ä¸º TiDB æ–¹å‘å’Œ TiKV æ–¹å‘ã€‚ç”±äºç¬”è€…å¯¹äº Rust è¯­è¨€çš„äº†è§£ä»…ä»…æµ®äºè¡¨é¢ï¼Œå®è·µä¸å¤šï¼Œåˆšå¥½ Talent Plan æä¾›äº†è¿™æ ·çš„æœºä¼šï¼Œå¯ä»¥ä» 0 åˆ° 1 è®¾è®¡å¹¶å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚åœ¨å®Œæˆè¿™ä¸ªç³»åˆ—è¯¾ç¨‹å­¦ä¹ åï¼Œä¹Ÿèƒ½è®©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£ TiDB å’Œ TiKVï¼Œå¹¶ä¸”åœ¨å°è¯•é˜…è¯»å®ƒä»¬çš„æºç æ—¶ï¼Œä¹Ÿä¸è‡³äºä¸€å¤´é›¾æ°´å•¦~ åœ¨ GitHub talent-plan ä»“åº“ä¸­å¯ä»¥çœ‹åˆ°å…³äºè¿™ä¸ªç³»åˆ—è¯¾ç¨‹çš„ä»‹ç»ã€‚ä¸ºäº†ä¾¿äºå¿«é€Ÿäº†è§£è¯¾ç¨‹å¤§çº²ï¼Œç”»äº†ä¸€ä¸ªæ€ç»´å¯¼å›¾å¦‚ä¸‹ï¼ˆç¬”è€…ä¸»è¦å…³æ³¨çš„æ˜¯ Rust éƒ¨åˆ†ï¼‰ï¼š ä¸Šè½¦ï¼Œèµ°å§æ¥ä¸‹æ¥ï¼Œç¬”è€…å°†æŒ‰ç…§ Talent Plan å®‰æ’çš„è¯¾ç¨‹å¾ªåºæ¸è¿›åœ°å­¦ä¹ ï¼Œå¹¶åœ¨å­¦ä¹ ä¸­åšä¸€äº›ç¬”è®°ï¼Œä»¥ä¾¿éšæ—¶å¤ä¹ ï¼Œæ¬¢è¿å›´è§‚äº¤æµ~ å‚è€ƒ PingCAP å®˜ç½‘ TiDB in Action æˆ‘ä»¬æ˜¯å¦‚ä½•è®¾è®¡ Rust &amp; åˆ†å¸ƒå¼å­˜å‚¨æ•™ç¨‹çš„ï¼Ÿ | Talent Plan èƒŒåçš„æ•…äº‹]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>Rust</tag>
        <tag>PingCAP</tag>
        <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
        <tag>å­˜å‚¨ç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go RESTful API é¡¹ç›®æ¨¡æ¿ä»‹ç»]]></title>
    <url>%2F2020%2F04%2F02%2Fgo-rest-api-for-beginners%2F</url>
    <content type="text"><![CDATA[0x00 å¼•è¨€ç–«æƒ…æœŸé—´å­¦çš„ä¸œè¥¿æ¯”è¾ƒæ‚ï¼ˆæ¯”å¦‚å­¦ä¹ äº†å¦‚ä½•åœ¨å¸‚åœºè¡Œæƒ…ä¸å¥½çš„æ—¶å€™è¿˜ç›²ç›®åŠ ä»“ ğŸ™‚ï¼‰ï¼Œæ²¡ä»€ä¹ˆå¹²è´§å€¼å¾—åˆ†äº«ã€‚ä¸è¿‡è€ƒè™‘åˆ°å¾ˆä¹…éƒ½æ²¡æœ‰æ›´æ–°äº†ï¼Œè¿˜æ˜¯è¦å¼ºè¿«è‡ªå·±å†™ä¸€ç‚¹ä¸œè¥¿ï¼Œä¸ç„¶å®¹æ˜“å˜æ‡’ã€‚æ€»ä¹‹ï¼Œå¤šæ€è€ƒï¼Œå¤šå®è·µè¿˜æ˜¯å¾ˆé‡è¦ã€‚ ä»Šå¤©ä¸»è¦æ˜¯æƒ³æŠŠä¸‰ä¸ªæœˆå‰å°±æ”¾åˆ° GitHub ä¸Šçš„ go-rest-api-starter é¡¹ç›®ä»‹ç»ä¸‹ï¼Œç›®çš„æœ‰ä¸¤ä¸ªï¼š åˆ†äº«ä¸‹æˆ‘ä»¬ç›®å‰çš„å·¥ç¨‹å®è·µï¼› ç»™ portal å¢åŠ ç‚¹æ›å…‰åº¦ ğŸ˜Šã€‚è™½ç„¶ç¬”è€…åœ¨ Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ– åšè¿‡ä»‹ç»ï¼Œä¸è¿‡ä¸€ç›´æ²¡æœ‰ç»™è¿‡æˆ‘ä»¬åœ¨çœŸå®ç¯å¢ƒä¸­çš„å…·ä½“ç”¨æ³•ï¼Œä»Šå¤©æä¾›çš„ç¤ºä¾‹ä¹Ÿåˆšå¥½å¯ä»¥å¸®åŠ©æ„Ÿå…´è¶£çš„åŒå­¦äº†è§£ä¸‹å®ƒçš„ç”¨æ³•ã€‚ 0x01 ä¸ºä»€ä¹ˆï¼Ÿå¥½çš„å·¥ç¨‹è§„èŒƒæ˜¯åœ¨é¡¹ç›®å®è·µä¸­ä¸æ–­è¸©å‘æ€»ç»“å‡ºæ¥çš„ï¼ŒæœŸé—´æˆ‘ä»¬ä¹Ÿé‡åˆ°å„ç§å†™èµ·æ¥ä¸å¤Ÿä¼˜é›…çš„åœ°æ–¹ï¼Œè‡ªç„¶å°±éœ€è¦æƒ³åŠæ³•è§£å†³è¿™äº›é—®é¢˜ã€‚ç»è¿‡è‹¥å¹²é¡¹ç›®çš„å®è·µï¼Œç»“åˆé‡åˆ°çš„é—®é¢˜ï¼Œä¹Ÿé€ äº†äº›è½®å­ä¾¿äºæå‡å¼€å‘å¹¸ç¦åº¦ã€‚æ²‰æ·€å’Œæç‚¼çš„ç»“æœï¼Œä¾¿æ˜¯ä¸€å¥—å¯ä»¥æ²¿è¢­çš„é¡¹ç›®è„šæ‰‹æ¶ï¼Œé›†æˆäº†ä¸€äº›æˆ‘ä»¬è®¤ä¸ºçš„ã€Œæœ€ä½³å®è·µã€ã€‚ ç¬”è€…ç›¸ä¿¡ä¸åŒçš„å›¢é˜Ÿæœ‰ä¸åŒçš„æƒ³æ³•ï¼Œä½†æœ¬è´¨ä¸Šéƒ½æ˜¯æ›´å¥½çš„æœåŠ¡äºä¸šåŠ¡ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»¥ä¸€è‡´ã€æ¸…æ™°çš„æ–¹å¼æ¥ç¼–å†™ä»£ç ï¼Œå¹¶ä¸”ä¿è¯é¡¹ç›®ç»“æ„ä¸è¢«éšæ„ç ´åï¼Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§å¤§äºä¸€åˆ‡ã€‚å¦å¤–ï¼Œå¯¹äºä¸šåŠ¡æ¡†æ¶ï¼Œä¹Ÿä¸åº”è¯¥ä¸€å‘³åœ°æ’æ–¥ã€‚åˆç†åœ°ä½¿ç”¨ä¸šåŠ¡æ¡†æ¶ï¼Œæ—¢æœ‰åˆ©äºç®€åŒ–ä¸šåŠ¡ä»£ç ç¼–å†™ï¼Œåˆæœ‰åˆ©äºç†è§£å’Œç»´æŠ¤ã€‚ 0x02 æ˜¯ä»€ä¹ˆï¼Ÿgo-rest-api-starter æ˜¯ä¸€ä¸ªå®Œæ•´çš„ RESTful API é¡¹ç›®ï¼ˆå•†å“ç®¡ç†åå°+å‰å°æ¥å£ï¼Œæºè‡ª aizoo ç®¡ç†åå°ï¼‰ï¼Œæ¼”ç¤ºäº†æˆ‘ä»¬ç›®å‰çš„å·¥ç¨‹å®è·µæ˜¯ä»€ä¹ˆæ ·çš„ã€‚å½“ç„¶ï¼Œå›¢é˜Ÿå†…éƒ¨ç‰ˆæœ¬ä½¿ç”¨äº†ä¸€äº›éå¼€æºæ¡†æ¶ï¼Œä¸è¿‡åŒæ ·çš„ç†å¿µæ¢æˆåˆ«çš„æ¡†æ¶ä¾ç„¶å¯è¡Œã€‚æ‰€ä»¥ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­ï¼Œç¬”è€…å°†ä¸€äº›å†…éƒ¨æ¡†æ¶æ¢æˆäº†å¼€æºæ¡†æ¶ï¼Œæ–¹ä¾¿å¤§å®¶å‚è€ƒã€‚ ä»è¿™ä¸ªé¡¹ç›®ä¸­å¯ä»¥äº†è§£åˆ°ä»€ä¹ˆï¼Ÿ æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œåˆ†å±‚æƒ…å†µï¼› Model å±‚æ€ä¹ˆç¼–å†™ï¼Œå…³è”èµ„æºå¦‚ä½•ä»¥å±æ€§æ–¹å¼æš´éœ²ï¼› Schema å±‚æ€ä¹ˆç¼–å†™ï¼Œè¡¨å•æ ¡éªŒé€»è¾‘æ”¾åœ¨ä»€ä¹ˆä½ç½®ï¼› å¤æ‚ä¸šåŠ¡é€»è¾‘å¦‚ä½•åœ¨ Controller å±‚å®ç°ï¼› å¦‚ä½•ä¿è¯ Handler å±‚æ•´æ´æ¸…æ™°ï¼› portal æ‰€æ‰®æ¼”çš„è§’è‰²ï¼Œå¦‚ä½•ç®€åŒ–å­—æ®µæ ¼å¼åŒ–é€»è¾‘ã€‚ é¦–å…ˆæ¥çœ‹ä¸‹é¡¹ç›®ç»“æ„ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263â”œâ”€â”€ .envï¼ˆç¯å¢ƒå˜é‡é…ç½®ï¼Œèµ„æºè¿æ¥ä¸²ç­‰ï¼‰â”œâ”€â”€ .env_unittestï¼ˆè·‘å•å…ƒæµ‹è¯•ä½¿ç”¨çš„æµ‹è¯•èµ„æºé…ç½®ï¼‰â”œâ”€â”€ LICENSEâ”œâ”€â”€ Makefileâ”œâ”€â”€ README.mdâ”œâ”€â”€ binâ”‚ â”œâ”€â”€ starter-adminï¼ˆé¢å‘ç®¡ç†åå°çš„ RESTful API æœåŠ¡å™¨ï¼‰â”‚ â””â”€â”€ starter-webï¼ˆé¢å‘å®¢æˆ·ç«¯ã€PC ç­‰å‰å°çš„ RESTful API æœåŠ¡å™¨ï¼‰â”œâ”€â”€ cmdï¼ˆå„ä¸ªæœåŠ¡å¯åŠ¨çš„å…¥å£ï¼‰â”‚ â”œâ”€â”€ adminï¼ˆç®¡ç†åå°ï¼‰â”‚ â”‚ â””â”€â”€ main.goâ”‚ â”œâ”€â”€ beeï¼ˆç¦»çº¿å¼‚æ­¥ä»»åŠ¡ï¼‰â”‚ â”‚ â””â”€â”€ main.goâ”‚ â”œâ”€â”€ serviceï¼ˆRPC æœåŠ¡ï¼‰â”‚ â”‚ â””â”€â”€ main.goâ”‚ â””â”€â”€ webï¼ˆå®¢æˆ·ç«¯ã€PCã€å°ç¨‹åºç­‰å‰å°ï¼‰â”‚ â””â”€â”€ main.goâ”œâ”€â”€ go.modï¼ˆä¾èµ–åŒ… go modulesï¼‰â”œâ”€â”€ pkgâ”‚ â”œâ”€â”€ adminï¼ˆç®¡ç†åå°æœåŠ¡ï¼‰â”‚ â”‚ â”œâ”€â”€ handlerâ”‚ â”‚ â”œâ”€â”€ router.goâ”‚ â”‚ â”œâ”€â”€ schemaï¼ˆå’Œè¿”å›çš„ JSON æ•°æ®å…³è”çš„èµ„æºç»“æ„ä½“å®šä¹‰ï¼‰â”‚ â”‚ â””â”€â”€ validatorï¼ˆé€šç”¨çš„æ ¡éªŒä»£ç ï¼‰â”‚ â”œâ”€â”€ configï¼ˆèµ„æºé…ç½®ï¼‰â”‚ â”‚ â”œâ”€â”€ fixture.goâ”‚ â”‚ â”œâ”€â”€ init.goâ”‚ â”‚ â””â”€â”€ mysql.goâ”‚ â”œâ”€â”€ constantï¼ˆå¸¸é‡ã€æšä¸¾å®šä¹‰ï¼‰â”‚ â”‚ â”œâ”€â”€ enum.goâ”‚ â”‚ â”œâ”€â”€ gen_enum.goâ”‚ â”‚ â””â”€â”€ macro.goâ”‚ â”œâ”€â”€ controllerï¼ˆå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼‰â”‚ â”‚ â”œâ”€â”€ company.goâ”‚ â”‚ â”œâ”€â”€ company_test.goâ”‚ â”‚ â””â”€â”€ product.goâ”‚ â”œâ”€â”€ jobï¼ˆå¼‚æ­¥ç¦»çº¿ä»»åŠ¡ä¸šåŠ¡é€»è¾‘ï¼‰â”‚ â”‚ â””â”€â”€ after_product_created.goâ”‚ â”œâ”€â”€ middlewareï¼ˆå¯å¤ç”¨çš„ä¸­é—´ä»¶ï¼‰â”‚ â”‚ â””â”€â”€ cors.goâ”‚ â”œâ”€â”€ modelï¼ˆModelsï¼Œå¯èƒ½è¿˜ä¼šèšåˆæ¥è‡ª RPC ç­‰æ•°æ®æºï¼Œæ•°æ®æ¨¡å‹æŠ½è±¡ï¼‰â”‚ â”‚ â”œâ”€â”€ company.goâ”‚ â”‚ â”œâ”€â”€ doc.goâ”‚ â”‚ â”œâ”€â”€ init.goâ”‚ â”‚ â””â”€â”€ product.goâ”‚ â”œâ”€â”€ utilï¼ˆå·¥å…·é›†ï¼‰â”‚ â”‚ â”œâ”€â”€ orderby.goâ”‚ â”‚ â”œâ”€â”€ picâ”‚ â”‚ â”œâ”€â”€ restâ”‚ â”‚ â”œâ”€â”€ seqgenâ”‚ â”‚ â””â”€â”€ toolkitâ”‚ â””â”€â”€ webï¼ˆå‰å°æœåŠ¡ï¼‰â”‚ â”œâ”€â”€ handlerâ”‚ â”œâ”€â”€ router.goâ”‚ â””â”€â”€ schemaâ”œâ”€â”€ scriptï¼ˆä¸€äº›è„šæœ¬æ–‡ä»¶ï¼‰â”‚ â””â”€â”€ 20200101â””â”€â”€ testdataï¼ˆå•å…ƒæµ‹è¯•æœ‰å…³æµ‹è¯•æ•°æ®ã€è¡¨ç»“æ„å®šä¹‰ï¼‰ â”œâ”€â”€ fixtures â”‚ â”œâ”€â”€ company.yml â”‚ â”œâ”€â”€ doc.yml â”‚ â””â”€â”€ product.yml â””â”€â”€ schema.sql 0x03 è¯´ Handleræˆ‘ä»¬å¸Œæœ› Handler å±‚çš„é€»è¾‘ä¸è¦å¤ªè¿‡å¤æ‚ï¼Œæ›¾ç»åœ¨çœ‹æŸåå°é¡¹ç›®æ—¶ï¼ŒæŸ Handler è¶³è¶³è¿‘ç™¾è¡Œä»£ç ï¼Œç³…æ‚äº†å¤§é‡çš„å­—æ®µæ ¡éªŒé€»è¾‘ã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®æ ¼å¼åŒ–é€»è¾‘ç­‰ï¼Œæåº¦å•°å—¦ï¼Œéš¾ä»¥ä¿®æ”¹å’Œç»´æŠ¤ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬ä¸å¤ªæƒ³è¦çš„ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼ŒHandler å±‚åº”è¯¥ä¿è¯è¶³å¤Ÿè½»é‡ï¼Œå®ƒå°±åº”è¯¥åƒæ˜¯èƒ¶æ°´ï¼Œè´Ÿè´£å°† Model å±‚ã€Controller å±‚ä»¥åŠ Schema å±‚ç²˜åœ¨ä¸€èµ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344func GetProducts(c *rest.Context) (rest.Response, error) &#123; // 1. å¤æ‚é€»è¾‘ä¸‹æ²‰åˆ° Controller å±‚å®ç° products, total, err := controller.GetProducts( c.Query("title"), c.QueryWithFallback("order_by", "-created_at"), c.Offset(), c.Limit(), ) // 2. Model -&gt; Schema æ¸²æŸ“ var schemas []schema.OutputProductSchema // å€ŸåŠ© portal.Onlyï¼Œå¯ä»¥åœ¨è¯·æ±‚çš„æ—¶å€™æŒ‡å®šåªåå‡ºéœ€è¦çš„å­—æ®µå€¼ err = portal.Dump(&amp;schemas, products, portal.Only(strings.Split(c.QueryWithFallback("only", ""), ",")...)) if err != nil &#123; return nil, err &#125; // 3. è¿”å›ç»“æœ return rest.NewPage(c, schemas, total), nil&#125;func CreateProduct(c *rest.Context) (rest.Response, error) &#123; // 1. è¡¨å•æ ¡éªŒå’Œå¤„ç† var input schema.InputProductSchema err := c.BindJSON(&amp;input) if err != nil &#123; return nil, err &#125; var product model.ProductModel err = portal.Dump(&amp;product, input) if err != nil &#123; return nil, err &#125; // 2. ä¸šåŠ¡é€»è¾‘å¤„ç† prodID, err := controller.CreateProduct(&amp;product, &amp;input) if err != nil &#123; return nil, err &#125; // 3. è¿”å›å¤„ç†ç»“æœ return gin.H&#123;"success": true, "product_id": cast.ToString(prodID)&#125;, nil&#125; æ€»ç»“æ¥çœ‹ï¼ŒHandler å±‚æ— éæ‰§è¡Œå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ˆKeep It Simple, Stupidï¼‰ï¼š è¾“å…¥å‚æ•°æ ¡éªŒå’Œå¤„ç†ï¼ˆå®é™…é€»è¾‘è¦ä¹ˆå°è£…åœ¨ Schema å±‚ï¼Œè¦ä¹ˆåœ¨æ¡†æ¶å±‚è§£å†³ï¼‰ï¼› ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆController å±‚è´Ÿè´£ï¼‰ï¼› ç»“æœè¿”å›ã€‚ 0x04 è®² Schema ä¸ Modelè¿™ä¸¤ä¸ªé€‚åˆæ”¾åœ¨ä¸€èµ·è®²ï¼Œå› ä¸º Schema çš„å­—æ®µæ˜ å°„çš„æ­£æ˜¯å¯¹åº”çš„ Model ä¸­ç›¸å…³å­—æ®µã€‚ä¹Ÿè®¸è¿™é‡Œä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥åœ¨ Model å±‚ï¼Œç»™æŸä¸ª Field åŠ ä¸ª Tag json: field_nameï¼Œç›´æ¥åºåˆ—åŒ–è¿”å›å‡ºå»å‘¢ï¼Ÿä¸ºä½•éè¦ç”Ÿç¡¬åœ°å†™ä¸€ä¸ª Schema ç»“æ„ä½“å†åšæ˜ å°„å‘¢ï¼Ÿ æ¥ä¸‹æ¥å°†ç»“åˆå…·ä½“çš„åœºæ™¯æ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š API è¦æ±‚è¿”å›çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®é™…ç±»å‹ä¸ä¸€è‡´ï¼ˆå¦‚ model.ID ä¸º int ç±»å‹ï¼Œä½† API è¦æ±‚è¿”å› string ç±»å‹ï¼‰ï¼› æŸäº›å­—æ®µè¦æ±‚æ˜¯å¯é€‰è¿”å›å­—æ®µï¼ˆè¿™æ—¶å¯ä»¥è½»æ¾åœ°ä¿®æ”¹ Schema ä¸­çš„å­—æ®µä¸º *type å³å¯ï¼‰ã€‚ æ€»ä¹‹ï¼ŒModel å±‚ä½œä¸º Source of Truthï¼Œä¿æŒæœ€åŸå§‹çš„æ ¼å¼æœ€å¥½ã€‚Schema å±‚åˆ™æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œå˜åŠ¨ï¼Œå¯¹äºä¸é€‚é…çš„åœºæ™¯ï¼Œè‡ªå®šä¹‰ format æ–¹æ³•å®Œæˆè½¬æ¢å³å¯ã€‚è¿™æ ·å¯ä»¥å°†æ”¹åŠ¨åªèšç„¦åœ¨è¾ƒå°çš„èŒƒå›´ï¼Œé¿å…åˆ°å¤„ä¿®æ”¹ç±»å‹ï¼Œæƒ³æƒ³ä¹Ÿå¿ƒç´¯ã€‚ æœ€åè¦æçš„ä¸€ç‚¹æ˜¯ Model çš„å…³è”èµ„æºï¼Œæˆ‘ä»¬æ¨èçš„å†™æ³•å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223type ProductModel struct &#123; ID int64 CompanyID int64 // ... other fields ignored&#125;// Company è¿”å›å•†å“å…³è”çš„å…¬å¸ï¼ˆæ¥æºäºåˆ«çš„è¡¨ï¼‰func (pd *ProductModel) Company() (*CompanyModel, error) &#123; var company CompanyModel err := DB.Where("id = ?", pd.CompanyID).Find(&amp;company).Error if err != nil &#123; if gorm.IsRecordNotFoundError(err) &#123; return nil, nil &#125; return nil, errors.WithStack(err) &#125; return &amp;company, nil&#125;// Rate è¿”å›å•†å“å…³è”çš„è¯„åˆ†ï¼ˆæ¥æºäº RPC è°ƒç”¨ï¼‰func (pd *ProductModel) Rate() (float64, error) &#123; return rpc.GetProductRate(pd.ID)&#125; è¿™æ ·åœ¨ Schema å±‚ï¼Œæˆ‘ä»¬åªéœ€è¦å£°æ˜éœ€è¦æ˜ å°„çš„å­—æ®µï¼Œåœ¨ç»è¿‡ portal.Dump æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å®Œæˆç›¸å…³å­—æ®µæ˜ å°„ï¼Œå¹¶å°†è¿”å›çš„å€¼å¡«å……åˆ°å¯¹åº”çš„ Schema å­—æ®µä¸­ï¼š 12345678910111213141516type OutputCompanySchema struct &#123; ID string `json:"id"` // ...&#125;type OutputProductSchema struct &#123; ID *string `json:"id,omitempty"` // ... Company *OutputCompanySchema `json:"company,omitempty" portal:"nested;async"` CreatedAt *field.Timestamp `json:"created_at,omitempty"`&#125;var output OutputProductSchemaportal.Dump(&amp;output, product)// æ­¤æ—¶å°† output json åºåˆ—åŒ–ï¼Œå°±æ˜¯æƒ³è¦å¾—åˆ°çš„ç»“æœ 0x05 ç¢ç¢å¿µæœ€è¿‘å‡ å¤©åœ¨å°è¯•é‡æ„æŸä¸ªé¡¹ç›®çš„æŸä¸ªå·¨é•¿çš„å‡½æ•°ï¼ˆæ¥è¿‘ 250 è¡Œï¼Œä»£ç å°±ä¸è´´äº†ï¼Œæ€•è¢«æ‰“ ğŸ˜ï¼‰ï¼Œæ¯æ¬¡ä¿®æ”¹å®ƒçš„æ—¶å€™å¿ƒæ€éƒ½è¦å´©ã€‚ä½†è¯´èµ·æ¥ï¼Œå®ƒä¹Ÿæ²¡æœ‰å¤šä¹ˆå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯äº§å“çº¿ç±»å‹è¾ƒå¤šï¼Œç³…æ‚äº†èµ„æºè·å–é€»è¾‘ã€å­—æ®µæ ¼å¼åŒ–é€»è¾‘ç­‰ç­‰ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ä¸Šè¿°çš„ Model &amp; Schema åˆ†å±‚æ€è·¯è¿›è¡Œé‡æ„ï¼Œä½†æ˜¯è¯¥å‡½æ•°åšäº†äº›ä¼˜åŒ–ï¼š ä½¿ç”¨ batch_get_resource æ¥å£æ›¿ä»£ get_resource æ¥å£ï¼› å¹¶å‘è·å–å¤šä¸ªäº§å“çº¿çš„ç« èŠ‚ä¿¡æ¯ç­‰ã€‚ å› ä¸ºè¿™ç§ä¼˜åŒ–çš„å¼•å…¥ï¼Œä¼šå¯¼è‡´ä¸Šè¿°å†™æ³•ä¸Šå­˜åœ¨ä¸€äº›ä¸å¤ªä¼˜é›…çš„åœ°æ–¹ã€‚æ¥ä¸‹æ¥ä¸¾ä¸ªæ —å­ğŸŒ°èƒ½å¤Ÿæ›´å¥½åœ°è¯´æ˜ç°åœ¨é‡åˆ°çš„é—®é¢˜ï¼š å…ˆçœ‹çœ‹å¸¸è§„çš„ StudentModel &amp; StudentSchema å®šä¹‰ï¼š 123456789101112131415type StudentModel struct &#123; MemberID int64&#125;// Member è¿”å›å…³è”çš„è´¦å·è¯¦æƒ…func (s *StudentModel) Member(ctx context.Member) *rpc.Member &#123; // æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å•æ¬¡è°ƒç”¨ï¼Œè€Œéæ‰¹é‡è°ƒç”¨ return rpc.GetMemberByID(s.MemberID)&#125;type MemberSchema struct &#123; /*...*/ &#125;type StudentSchema struct &#123; Member *MemberSchema `portal: nested`&#125; å‡è®¾ä¸€é¡µéœ€è¦è·å– 20 ä¸ªå­¦ç”Ÿä¿¡æ¯ï¼Œportal åºåˆ—åŒ–æ—¶ï¼Œä¼šé»˜è®¤å¯åŠ¨ 20 ä¸ª goroutine åˆ†åˆ«å¤„ç† 20 ä¸ª StudentSchema çš„æ¸²æŸ“ã€‚è¿™æ ·çš„è¯ï¼Œå…·ä½“åˆ° StudentModel.Member è·å–æ—¶ï¼Œå°±ä¼šäº§ç”Ÿ 20 ä¸ªå¹¶å‘çš„ GetMemberByID è¯·æ±‚ï¼Œç›¸å¯¹ä¸²è¡Œæ‰§è¡Œï¼Œè¿™ç§æ–¹å¼è‡ªç„¶å¯ä»¥æé«˜é€Ÿåº¦ã€‚ä½†æ˜¯ä»£ä»·ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§ç”Ÿçš„è¯·æ±‚è¾ƒå¤šã€‚å¯¹äºä¸€äº›åå°é¡¹ç›®è¿™æ ·åšè¿˜å¥½ï¼Œä½†æ˜¯å¯¹äº C ç«¯æ¥å£ï¼Œå¦‚æœè¯·æ±‚é‡è¾ƒé«˜ï¼Œé‚£è¯·æ±‚æ”¾å¤§ä¼šæ¯”è¾ƒä¸¥é‡ã€‚ 1234students := DBGetStudents(20)var output []StudentSchemaportal.Dump(&amp;output, students) å‡è®¾ä¸Šæ¸¸ä¸ºæˆ‘ä»¬æä¾›äº†ç±»ä¼¼ func BatchGetMemberByID(memberIDs []int64) map[int64]*Member æ–¹æ³•ï¼Œé‚£ä¹ˆä»¬å¯ä»¥é€šè¿‡æ‰¹é‡è°ƒç”¨çš„æ–¹å¼è§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åŒæ—¶ä¿®æ”¹åŸæœ‰çš„ Model å±‚å’Œ Schema å±‚å¦‚ä¸‹ï¼š 12345678910111213type StudentModel struct &#123; MemberID int64&#125;type StudentSchema struct &#123; Member *MemberSchema `portal: nested`&#125;func (s *StudentSchema) GetMember(ctx context.Context, student *StudentModel) *rpc.Member &#123; // å‡è®¾å¤–å±‚æ‰¹é‡è°ƒç”¨ç»“æœæ”¾åœ¨ ctx ä¸­ä¼ å…¥ v := ctx.Value("members").(map[int64]*rpc.Member) return v[student.MemberID]&#125; ç„¶ååœ¨ Handler å±‚ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨ BatchGetMemberByID æ¥å£ï¼š 1234567891011121314students := DBGetStudents(20)// æ”¶é›† member_idsmemberIDs := make([]int64, len(students))for i, s := range students &#123; memberIDs[i] = s.MemberID&#125;// æ‰¹é‡è°ƒç”¨ä¸€æ¬¡members := rpc.BatchGetMemberByID(memberIDs)ctx = context.WithValue("members", members)var output []StudentSchemaportal.DumpWithContext(ctx, &amp;output, students) å—¯ï¼Œä¼¼ä¹çœ‹èµ·æ¥å¹¶æ²¡æœ‰å¤šä¹ˆç¹çå˜›ã€‚ä¸è¿‡è¿™æ ·çš„å†™æ³•å¾ˆå®¹æ˜“å¯¼è‡´ Handler å±‚è†¨èƒ€ï¼Œè¯•æƒ³å†åŠ ç‚¹åˆ«çš„å…³è”èµ„æºè·å–å‘¢ï¼Ÿé‚£å„ç§ BatchGetShit å°±æ€¼è¿›å»äº†ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬ç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½åšåˆ°åŸæœ‰çš„ Model å±‚ä¾ç„¶ä¿æŒç®€å•çš„ rpc.GetResourceByID è¿™ç§ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼›Schema å±‚ä¹Ÿä¸ç”¨åšä¾µå…¥å¼ä¿®æ”¹ï¼›Handler å±‚æ›´ä¸ç”¨å¿å—å¯èƒ½å¯¼è‡´çš„ä»£ç è†¨èƒ€é—®é¢˜å‘¢ï¼Ÿä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥å¯¹ rpc.GetResourceByID åšç‚¹åŒ…è£…ï¼Œåœ¨åº•å±‚æ¡†æ¶ä¸Šï¼Œè‡ªåŠ¨æ”¯æŒè¯·æ±‚åˆå¹¶ï¼›è€Œå¯¹äºä¸Šå±‚è°ƒç”¨æ–¹æ— æ„ŸçŸ¥ã€‚ ç†Ÿæ‚‰ HTTP/2 çš„åŒå­¦åº”è¯¥äº†è§£åˆ°å…¶ä¸­ä¸€ä¸ªç‰¹è‰²æ˜¯å¤šè·¯å¤ç”¨ï¼Œé¿å…æ¯æ¬¡æ–°çš„è¯·æ±‚éƒ½è¦è¿›è¡Œ TCP+TLS æ¡æ‰‹ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåšåˆ°åœ¨åº•å±‚å°†ä¸Šå±‚çš„ rpc.GetResourceByID è‡ªåŠ¨åˆå¹¶ä¸º rpc.BatchGetResourceByIDï¼Œä¹Ÿèƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜è¯·æ±‚æ•ˆç‡ï¼Œå‡å°‘ä¸Šæ¸¸æœåŠ¡çš„è¯·æ±‚å‹åŠ›ã€‚è™½ç„¶ç›¸å¯¹äºå¹¶å‘ 20 ä¸ª rpc.GetResourceByID è¯·æ±‚ï¼Œè‡ªåŠ¨åˆå¹¶æŠ€æœ¯å¯èƒ½å› ä¸ºä¼˜åŒ–ä¸åˆ°ä½æˆ–è€…ç­–ç•¥ä¸Šçš„é—®é¢˜ï¼Œå“åº”æ—¶é—´å¯èƒ½ç¨é•¿ï¼Œä½†æ˜¯ç›¸å¯¹äºä¸²è¡Œè°ƒç”¨ï¼Œé€Ÿåº¦ç†è®ºä¸Šä¼šæœ‰å¾ˆå¤§æå‡ã€‚ å…³äºè¿™ä¸ªè¯·æ±‚åˆå¹¶çš„ç­–ç•¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå¯ä»¥æƒ³è±¡ä¸‹ rpc.BatchGetResourceByID å°±åƒä¸€è¾†å¾€è¿”äºä¸¤åœ°çš„å…¬å…±æ±½è½¦ï¼Œå‡è®¾å®ƒæœ‰ä¸¤ä¸ªå…³é”®å±æ€§ï¼š è½¦ä¸Šä¹˜å®¢ä¸€æ—¦åæ»¡ç«‹åˆ»å‡ºå‘ï¼ˆä¸è®¸åŠ å¡ï¼Œå’±ä»¬è¦åˆæ³•ç»è¥ï¼‰ï¼› åˆ°è¾¾ä¸€å®šè¶…æ—¶æ—¶é—´ç«‹åˆ»å‡ºå‘ï¼ˆå®ˆæ—¶å¾ˆé‡è¦ï¼Œä¿è¯æœåŠ¡è´¨é‡ï¼‰ï¼› åˆ°è¾¾ç›®çš„åœ°åï¼Œè¿˜è¦åœ¨è¿”ç¨‹æ—¶å°†åŒä¸€æ‰¹ä¹˜å®¢å°½å¯èƒ½å…¨éƒ¨å¸¦å›æ¥ï¼ˆå‡è®¾ä¹˜å®¢ä»¬è¦ä¹ˆä¹°åˆ°äº†æƒ³è¦çš„ç¤¼ç‰© result æˆ–è€…åƒç¬”è€…ä¸€æ ·æ¯”è¾ƒç©·å°±ä»€ä¹ˆä¹Ÿæ²¡ä¹° errorï¼‰ã€‚ åŸºäºè¿™æ ·çš„å‡è®¾ï¼Œå°è¯•ä½¿ç”¨ Go è¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„ Demoï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‰å¾€ä»“åº“ rpcx æŸ¥çœ‹ã€‚å°è¯•å¼•å…¥äº†ä¸€ä¸ª Proxy å±‚ï¼Œç”± Proxy å±‚æ”¶é›†ä¸šåŠ¡æ–¹çš„è°ƒç”¨å‚æ•°ï¼Œå¹¶æ‰¹é‡å‘èµ·è°ƒç”¨ï¼Œæœ€åå°†ç»“æœåˆ†æ´¾ç»™ä¸šåŠ¡æ–¹ã€‚å½“ç„¶ï¼Œç›®å‰ Proxy æ˜¯ä»¥ä¸€ä¸ªå•ç‹¬çš„ goroutine éƒ¨ç½²ï¼›ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœèƒ½ç”¨ sidecar æ–¹å¼éƒ¨ç½²ï¼Œç”šè‡³å¯ä»¥åšåˆ°è¯­è¨€æ— å…³ï¼Œç‹¬ç«‹å‡çº§ï¼Œå…¶å®ƒè¯­è¨€å®ç°çš„æœåŠ¡ä¹Ÿå¯ä»¥äº«å—åˆ°åŒæ ·çš„ä¼˜åŒ–ã€‚ 12345678910111213141516171819func main() &#123; ctx := context.Background() rsdk.Init(10, 1*time.Millisecond) getMembersAutoAgg(ctx, 20)&#125;func getMembersAutoAgg(ctx context.Context, max int) &#123; var wg sync.WaitGroup for i := 0; i &lt;= max; i++ &#123; wg.Add(1) // åº•å±‚è‡ªåŠ¨å°†å¹¶å‘å•æ¬¡è°ƒç”¨è½¬æ¢æˆæ‰¹é‡è°ƒç”¨ go func(n int) &#123; r, err := rsdk.GetMember(ctx, int64(n)+1) _, _ = r, err wg.Done() &#125;(i) &#125; wg.Wait()&#125; å½“ç„¶ï¼Œæƒ³è¦åœ¨ç”Ÿäº§ç¯å¢ƒæäº‹æƒ…ï¼Œè¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ã€‚æ¯”å¦‚ Proxy ç›‘æ§æ€ä¹ˆåšï¼Ÿå•ç‚¹é—®é¢˜æ€ä¹ˆè§£è§£å†³ï¼Ÿæ˜¯å¦ä¼šæˆä¸ºæ¥å£è°ƒç”¨ç“¶é¢ˆï¼Ÿå¦‚ä½•ä¸å…¬å¸ç°æœ‰çš„ RPC æ¡†æ¶ç»“åˆï¼Ÿæ”¶ç›Šæ˜¯å¦çœŸçš„è¾¾åˆ°é¢„æœŸï¼ˆåˆ†æå…·ä½“åœºæ™¯ï¼‰ï¼Ÿ 0x06 æ€»ç»“ä»¥ä¸Šåˆ†äº«äº†ä¸€äº›å…³äºå·¥ç¨‹å®è·µæ–¹é¢çš„æ€è€ƒï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œæœ‰ä»€ä¹ˆå¥½çš„æƒ³æ³•ä¹Ÿæ¬¢è¿ç•™è¨€äº¤æµ~]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>RESTful</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Rust async-std å…¥é—¨]]></title>
    <url>%2F2020%2F01%2F20%2Frust-async-std-intro%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ€è¿‘æ‰“ç®—åŸºäº Rust async-std é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust async-std å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚ async-std æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ async-std ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª task æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ thread æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ async/await é£æ ¼çš„ Mutex åŸè¯­ã€‚ Rust ä¸­æœ‰ä¸¤ç§ç±»å‹çš„ Futureï¼š æºè‡ªæ ‡å‡†åº“çš„ std::future::Future æºè‡ª futures-rs crate çš„ futures::future::Future èƒŒæ™¯æ˜¯è¿™æ ·çš„ï¼Œfutures-rs crate ä¸­å®šä¹‰çš„ future æ˜¯ Future ç±»å‹æœ€åˆçš„å®ç°ã€‚Rust ä¸ºäº†æ”¯æŒ async/await è¯­æ³•ï¼Œå°±æŠŠæ ¸å¿ƒçš„ trait Future è½¬ç§»åˆ°äº†æ ‡å‡†åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„ std::future::Futureã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ std::future::Future çœ‹ä½œæ˜¯ futures::future::Future çš„æœ€å°å­é›†ã€‚ æˆ‘ä»¬éœ€è¦ä¸¥æ ¼åŒºåˆ† std::future::Future å’Œ futures::future::Futureï¼Œä»¥åŠ async-std æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„ã€‚æ€»çš„æ¥è¯´ï¼Œæ™®é€šçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯ä¸ä¼šå’Œ std::future::Future æ‰“äº¤é“çš„ï¼ˆé™¤äº†ä½¿ç”¨ .await è°ƒç”¨ï¼‰ã€‚é€šå¸¸åªæœ‰å®ç° Future çš„å¼€å‘è€…æ‰ä¼šå…³æ³¨ std::future::Future çš„å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚è¿‡å»å¾ˆå¤šåœ¨ Future ä¸­å®šä¹‰çš„åŠŸèƒ½éƒ½è¢«ç§»åŠ¨åˆ°äº† FuturesExt æ‰©å±• trait ä¸­ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† futures åº“å½“ä½œæ˜¯æ ¸å¿ƒ Rust å¼‚æ­¥åŠŸèƒ½çš„æ‰©å±•ã€‚ é‚£ä¹ˆï¼Œä¸Šé¢ä¸€ç›´æåˆ°çš„ Futures ç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿåˆæ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼ŒFutures å°±æ˜¯å¯¹äºä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ä¸€ç§æŠ½è±¡ï¼Œå®ƒä»¬å…¶å®ä»€ä¹ˆä¹Ÿä¸åšã€‚é‚£ä¹ˆæ€ä¹ˆæ¨è¿›æ‰§è¡Œå¹¶è·å¾—ç»“æœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é æ‰§è¡Œå™¨ executorï¼Œå®ƒä¼šå†³å®šä½•æ—¶åŠå¦‚ä½•æ‰§è¡Œä½ çš„ Futuresã€‚async-std::task æ¨¡å—å°±ä¸ºæˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ‰§è¡Œå™¨æ¥å£ã€‚ FuturesRust æœ‰ä¸ªéå¸¸äº®çœ¼çš„ç‰¹æ€§å«ã€Œæ— è°“å¹¶å‘ã€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨è·å¾—å¹¶å‘ç‰¹æ€§çš„åŒæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰çš„é—®é¢˜ï¼ˆç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥åˆ°æ•°æ®ç«äº‰çš„é—®é¢˜ï¼‰ã€‚ Futures æ˜¯å¯¹è®¡ç®—çš„æŠ½è±¡ï¼Œå®ƒä»¬æè¿°äº†ã€Œåšä»€ä¹ˆï¼ˆwhatï¼‰ã€ï¼Œä½†æ˜¯ä¸ã€Œåœ¨å“ªå„¿ï¼ˆwhereï¼‰ã€ã€ã€Œä»€ä¹ˆæ—¶å€™ï¼ˆwhenï¼‰ã€æ‰§è¡Œæ˜¯åˆ†å¼€çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ä»£ç æ‰“æ•£æˆå°æ®µçš„ã€å¯ç»„åˆçš„è¡Œä¸ºï¼Œè¿™æ ·å¯ä»¥ä½œä¸ºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ‰§è¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcompute thingsï¼‰ï¼Œå¹¶æ‰¾åˆ°å¯ä»¥æŠ½è±¡çš„åœ°æ–¹ã€‚ Send å’Œ SyncRust å®‰å…¨å¹¶å‘ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æŠ½è±¡ï¼ˆMarkersï¼‰ï¼šSend å’Œ Syncã€‚ä¸‹é¢æ¥çœ‹çœ‹ç®€å•çš„ä»‹ç»ï¼š Send æ ‡è®°çš„æ•°æ®ç±»å‹æ˜¯å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªè®¡ç®—ï¼ˆcomputationï¼‰è½¬ç§»åˆ°ï¼ˆmovedï¼‰å¦å¤–ä¸€ä¸ªå¹¶å‘è®¡ç®—ï¼ˆæ‰€æœ‰æƒä¹ŸåŒæ ·è¢«è½¬ç§»äº†ï¼Œå‘é€æ–¹å°†ä¸èƒ½å†è®¿é—®å®ƒï¼‰ã€‚ Sync æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸­å…±äº«ï¼ˆsharingï¼‰æ•°æ®ã€‚ ä»¥ä¸Šæ²¡æœ‰ä½¿ç”¨ thread å³çº¿ç¨‹è¿™æ ·çš„å­—çœ¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æŠ½è±¡çš„ computationã€‚Send å’Œ Sync æœ€å¼ºå¤§çš„ç‰¹ç‚¹åœ¨äºå®ƒä¸ºæˆ‘ä»¬å‡è½»äº†çŸ¥é“å…±äº«ä»€ä¹ˆçš„è´Ÿæ‹…ã€‚åœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¯¹äºç›¸åº”çš„æ•°æ®ç±»å‹é‡‡ç”¨ä»€ä¹ˆåˆ†äº«æ–¹å¼å³å¯ã€‚ å…³äº Send å’Œ Sync çš„ç»„åˆè¿˜æœ‰æ›´å¤šæœ‰è¶£çš„ç‰¹æ€§ï¼Œå¯ä»¥å‚è€ƒ Rust Book äº†è§£æ›´å¤šã€‚ ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰æ‰€è°“çš„è®¡ç®—ï¼ˆcomputationï¼‰æ˜¯æŒ‡ä¸€ä¸ªå¯ç»„åˆçš„æ“ä½œåºåˆ—ï¼Œå¯ä»¥åŸºäºå†³ç­–åˆ†æ”¯ï¼Œå¯ä»¥ä¸€ç›´æ¨è¿›è¿è¡Œåˆ°ç»“æŸï¼Œæœ€ç»ˆè¿”å›ç»“æœæˆ–è€…é”™è¯¯ã€‚ å»¶è¿Ÿè®¡ç®—å¦‚ä¸Šæ‰€è¿°ï¼ŒSend å’Œ Sync éƒ½æ˜¯æè¿°æ•°æ®çš„ï¼›ä½†åº”ç”¨ç¨‹åºå¯ä¸æ­¢æ•°æ®ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“å¦‚ä½•è®¡ç®—å‡ºæ•°æ®ï¼Œç”±æ­¤å¼•å…¥äº† Futuresã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ Futures æ˜¯æ€ä¹ˆå…è®¸æˆ‘ä»¬ç”¨è‡ªç„¶è¯­è¨€è¡¨è¾¾è¦åšçš„äº‹æƒ…çš„ï¼ŒFutures ä»è¿™æ ·çš„è®¡åˆ’ï¼š Do X If X succeeded, do Y å˜æˆäº†ï¼š Start doing X Once X succeeds, start doing Y ç›¸æ¯”äºå‘Šè¯‰è®¡ç®—æœºè¦åšä»€ä¹ˆï¼Œå¹¶ä¸”æ ¹æ®å½“å‰ç»“æœå†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼›å»¶è¿Ÿè®¡ç®—å°±æ˜¯è®©æˆ‘ä»¬å‘Šè¯‰è®¡ç®—æœºè¦å¼€å§‹åšä»€ä¹ˆï¼Œå¹¶å“åº”æœªæ¥å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶ã€‚ ä»ç®€å•çš„ä¾‹å­å¼€å§‹ä¸‹é¢çš„ä¾‹å­æ˜¯ä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š 123456fn read_file(path: &amp;str) -&gt; io::Result&lt;String&gt; &#123; let mut file = File::open(path)?; let mut contents = String::new(); file.read_to_string(&amp;mut contents)?; Ok(contents)&#125; æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œä¹Ÿå¾ˆç›´è§‚ã€‚é—®é¢˜æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œæ§åˆ¶æƒå°±ä¼šè½¬ç§»è‡³è¢«è°ƒç”¨çš„å‡½æ•°ç›´åˆ°å…¶è¿”å›ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸Šè¿°è¿”å›å€¼æè¿°çš„æ˜¯è¿‡å»ã€‚è€Œè¿‡å»å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæ‰€æœ‰çš„å†³ç­–éƒ½å·²ç»ç¡®å®šäº†ã€‚ä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜ç‚¹ï¼šè¿”å›çš„ç»“æœå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç¨‹åºè¿‡å»è®¡ç®—çš„ç»“æœè§£åŒ…ï¼ˆunwrapï¼‰å‡ºæ¥ï¼Œç„¶åå†³å®šå¦‚ä½•ä½¿ç”¨å®ƒã€‚ ä½†æˆ‘ä»¬è¿˜æ˜¯æƒ³è¦æŠ½è±¡è®¡ç®—ï¼Œå¹¶è®©åˆ«äººé€‰æ‹©å¦‚ä½•è¿è¡Œå®ƒã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ç±»å‹ï¼Œå¯ä»¥æè¿°è®¡ç®—è¿‡ç¨‹ï¼Œä½†æ˜¯åˆä¸æ‰§è¡Œå®ƒã€‚ğŸ‘† ä¸Šé¢çš„å‡½æ•°åªèƒ½è®©æˆ‘ä»¬åœ¨è°ƒç”¨å‰æˆ–è€…è°ƒç”¨åæ‰§è¡Œæ“ä½œã€‚è¿™å…¶å®å¹¶éé¢„æœŸçš„ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨åœ¨è¿è¡Œçš„æ—¶å€™åšç‚¹åˆ«çš„äº‹æƒ…ï¼ˆå®é™…ä¸Šå°±æ˜¯èƒ½å¤Ÿæ‰“æ–­æ‰§è¡Œæµï¼‰ã€‚å½“åœ¨å¹¶è¡Œç¼–ç¨‹æ—¶ï¼Œè¿™ä¹Ÿå‰¥å¤ºäº†æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡è¿è¡Œæ—¶å¯åŠ¨å¦å¤–ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡çš„èƒ½åŠ›ï¼ˆè¿™æ—¶æ§åˆ¶æƒå·²ç»è½¬ç§»ç»™æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°äº†ï¼‰ã€‚ æ­¤å¤„è™½ç„¶å¯ä»¥å¼•å…¥çº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æœ¬èº«æ˜¯éå¸¸ç‰¹å®šçš„å¹¶å‘åŸè¯­ï¼Œè€Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾çš„æ˜¯ä¸€ç§æŠ½è±¡ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ ·çš„æŠ½è±¡å°±æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªè¿›è¡Œä¸­çš„å·¥ä½œï¼Œä¼šåœ¨æœªæ¥äº§ç”Ÿç»“æœã€‚ä¸‹é¢çœ‹çœ‹éå®Œæ•´å®šä¹‰çš„ Future traitï¼š 12345678trait Future &#123; // Ouput æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œè¡¨ç¤ºè¾“å‡ºç»“æœçš„æ³›å‹ type Output; // poll æ–¹æ³•ä¼šè¿”å›å½“å‰è®¡ç®—çš„çŠ¶æ€ï¼Œpoll æ–¹æ³•ä¼šè¿”å›ä¸¤ç§ç»“æœï¼š // 1. `Poll::Ready`ï¼Œè¡¨ç¤ºè®¡ç®—ç»“æŸ // 2. `Poll::Pending`ï¼Œè¡¨ç¤ºè®¡ç®—å°šæœªç»“æŸ fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context) -&gt; Poll&lt;Self::Output&gt;;&#125; å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ poll() æ–¹æ³•æ£€æŸ¥ Future æ˜¯å¦å®Œæˆï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™è¿”å›å¯¹åº”çš„ç»“æœã€‚æ˜¾ç„¶ï¼Œæœ€ç®€å•çš„æœºåˆ¶å°±æ˜¯åœ¨å¾ªç¯ä¸­ä¸æ–­è½®è¯¢ï¼›ä¸è¿‡æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æˆç†Ÿçš„ runtime æ¥æ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ poll() è¿”å› Poll::Ready åï¼Œç»§ç»­è°ƒç”¨å¯èƒ½ä¼šæœ‰ä»¤äººå›°æƒ‘çš„è¡Œä¸ºäº§ç”Ÿï¼Œå…·ä½“å¯ä»¥å‚è§ futures-docsã€‚ Asyncå®é™…ä¸Š Future åœ¨ Rust ä¸­å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´äº†ï¼Œåªæ˜¯ç›´æ¥æ„å»ºå’Œæè¿°å®ƒä»¬æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œasync å…³é”®è¯å°±æ˜¯æˆ‘ä»¬çš„æ•‘æ˜Ÿï¼Œä¸‹é¢çš„ä¾‹å­ä¸­æ¼”ç¤ºäº† async-std æ­é… async/await é‡æ„ä¸Šé¢çš„å‡½æ•°ï¼š123456789// async æ ‡è®°å‡½æ•°ä½“æ˜¯ä¸€ä¸ªå»¶è¿Ÿè®¡ç®—å¯¹è±¡ï¼Œå½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª `Future&lt;Output = io::Result&lt;string&gt;&gt;`ï¼Œ// è¯¥å€¼å¹¶éç«‹å³è¿”å›çš„ç»“æœ `io::Result&lt;String&gt;`ï¼Œ//ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯äº§ç”Ÿäº†å®ç°äº† `Future&lt;Output = io::Result&lt;String&gt;&gt;` çš„ç±»å‹ï¼‰ã€‚async fn read_file(path: &amp;str) -&gt; io::Result&lt;String&gt; &#123; let mut file = File::open(path).await?; let mut contents = String::new(); file.read_to_string(&amp;mut contents).await?; Ok(contents)&#125; .await å¹²äº†ä»€ä¹ˆé¡¾åæ€ä¹‰ï¼Œ.await è¡¨ç¤ºç­‰å¾…è¯·æ±‚è¡Œä¸ºï¼ˆrequested actionï¼‰ç›´åˆ°å®Œæˆï¼Œç„¶åæ‰ä¼šç»§ç»­åç»­çš„æ‰§è¡Œã€‚å‡†ç¡®çš„æ¥è¯´ï¼Œ.await æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºæ­¤å¤„çš„ä»£ç å°†ä¼šç­‰å¾…ç›´åˆ° Future äº§ç”Ÿç»“æœã€‚è‡³äº Future æ˜¯æ€ä¹ˆç»“æŸçš„ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚.await ä¼šè®©è¿è¡Œæ—¶æŒæ§è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œè‡³äºåœ¨è®¡ç®—ç»“æŸæ—¶è¦æ‰§è¡Œå“ªäº›æ“ä½œéƒ½ç”±è¿è¡Œæ—¶æ¥æ“å¿ƒã€‚å½“ä½ ç¼–å†™çš„æ“ä½œåœ¨åå°å®Œæˆæ—¶ï¼Œå®ƒä¼šå›åˆ°æ ‡è®°ç‚¹ï¼Œç»§ç»­åç»­çš„æ“ä½œã€‚æ‰€ä»¥è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¸º äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆevented programmingï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç­‰å¾…æŸäº›äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶ï¼‰ï¼Œå¹¶æ®æ­¤ä½œå‡ºå“åº”ï¼ˆæ¯”å¦‚å¼€å§‹è¯»å–å†…å®¹ï¼‰ã€‚ å½“æœ‰ 2 ä¸ªåŠä»¥ä¸Šè¿™æ ·çš„å‡½æ•°åœ¨åŒæ—¶è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„è¿è¡Œæ—¶ç³»ç»Ÿå°±èƒ½å¤Ÿå¤„ç†å½“å‰æ‰€æœ‰è¿›è¡Œçš„äº‹ä»¶äº†ï¼Œé¿å…äº†å‚»å‚»åœ°ç­‰å¾…ã€‚ Tasksæˆ‘ä»¬å·²ç»çŸ¥é“ä»€ä¹ˆæ˜¯ Futures äº†ï¼Œé‚£å…·ä½“æ€ä¹ˆè¿è¡Œå®ƒä»¬å‘¢ï¼Ÿè¿™å°±æ˜¯æ¥ä¸‹æ¥è¦ä»‹ç»çš„ tasks æ¨¡å—è¦åšçš„äº‹æƒ…ã€‚ä¸‹é¢çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415161718192021222324252627use async_std::&#123;fs::File, io, prelude::*, task&#125;;async fn read_file(path: &amp;str) -&gt; io::Result&lt;String&gt; &#123; let mut file: File = File::open(path).await?; let mut contents = String::new(); file.read_to_string(&amp;mut contents).await?; Ok(contents)&#125;fn main() &#123; // `spawn` æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `Future`ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œå®ƒã€‚ // è¯¥å‡½æ•°ä¼šè¿”å› `JoinHanle`ã€‚ let reader_task = task::spawn(async &#123; // è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å—ï¼Œå¿…é¡»è¦ä½¿ç”¨å¼‚æ­¥å—æ‰èƒ½è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼ŒåŒæ—¶ // ä¹Ÿä¼šå¼•å¯¼ç¼–è¯‘å™¨å°†æ‰€æœ‰ç›¸å…³çš„æŒ‡ä»¤åŒ…å«è¿›æ¥ã€‚Rust ä¸­æ‰€æœ‰çš„å— // éƒ½ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œ `async` å—åˆ™è¿”å›çš„æ˜¯ç±»å‹ä¸º // `Future` çš„å€¼ let result = read_file("data.csv").await; match result &#123; Ok(s) =&gt; println!("&#123;&#125;", s), Err(e) =&gt; println!("Error reading &#123;:?&#125;", e) &#125; &#125;); println!("Started task!"); task::block_on(reader_task); println!("Stopped task!");&#125; Rust çš„ Futures æœ‰æ—¶ä¹Ÿå«ã€Œå†·ï¼ˆcoldï¼‰ã€Futuresï¼Œä½ éœ€è¦è¿è¡Œå®ƒä»¬çš„ä¸œè¥¿ã€‚ä¸ºäº†è¿è¡Œä¸€ä¸ª Futureï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„è®°è´¦å·¥å…·ï¼šæ¯”å¦‚å½“å‰ Future æ˜¯å¦åœ¨è¿è¡Œä¸­è¿˜æ˜¯å·²ç»ç»“æŸï¼Œåœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå½“å‰çš„çŠ¶æ€ã€‚è¿™ç§è®°è´¦é€»è¾‘å°±è¢«æŠ½è±¡åˆ°äº† Task ä¸­ã€‚ Task ç±»ä¼¼äº Threadï¼Œä½†ä¹Ÿæœ‰äº›è®¸ä¸åŒï¼šå®ƒæ˜¯ç”±åº”ç”¨ç¨‹åºï¼ˆç”¨æˆ·ç©ºé—´ï¼‰è¢«è°ƒåº¦ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ä¼šæ„ŸçŸ¥ï¼›ä¸€æ—¦åˆ°äº†æŸä¸ªç‚¹éœ€è¦ç­‰å¾…ï¼Œåº”ç”¨ç¨‹åºè‡ªå·±éœ€è¦è´Ÿè´£å”¤é†’ä»»åŠ¡ã€‚async_std çš„ä»»åŠ¡å¯ä»¥æ‹¥æœ‰åç§°å’Œ IDã€‚ å½“é€šè¿‡ spawn ç”Ÿæˆä»»åŠ¡åï¼Œä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¿”å›çš„ JoinHandle æœ¬èº«æ˜¯ä¸€ä¸ª Futureï¼Œå®ƒä¼šåœ¨ Task è¿è¡Œç»“æŸåï¼ˆrun to conclusionï¼‰ä¹Ÿä¼šç»“æŸã€‚ç±»ä¼¼ threads å’Œ join å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å¯¹ JoinHandle è°ƒç”¨ block_on å‡½æ•°ï¼Œä»è€Œé˜»å¡ç¨‹åºï¼ˆå‡†ç¡®æ¥è¯´æ˜¯è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ï¼‰ç›´åˆ°å…¶è¿è¡Œç»“æŸã€‚ Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿé€šè¿‡ç®€å•é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ src/task/block_on.rs çœ‹åˆ°æ‰§è¡Œçš„é€»è¾‘ï¼Œå½“ Task è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„ run å‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè¿›è€Œæ¨è¿› Future ä¸­çš„è®¡ç®—é€»è¾‘ç›´åˆ°å®Œæˆï¼š 12345678910111213141516171819202122232425/// Blocks the current thread on a future's result.fn run&lt;F, T&gt;(future: F) -&gt; Twhere F: Future&lt;Output = T&gt;,&#123; CACHE.with(|cache| &#123; // ... loop &#123; if let Poll::Ready(t) = future.as_mut().poll(cx) &#123; // Save the parker for the next invocation of `block`. cache.set(Some(arc_parker)); return t; &#125; // Yield a few times or park the current thread. if step &lt; 3 &#123; thread::yield_now(); step += 1; &#125; else &#123; arc_parker.park(); step = 0; &#125; &#125; &#125;)&#125; JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿç¿»é˜… src/task/join_handle.rs æºç å¾—çŸ¥ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°äº† Future trait çš„å¯¹è±¡ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š 1234567891011121314pub struct JoinHandle&lt;T&gt;(async_task::JoinHandle&lt;T, Task&gt;);// ...impl&lt;T&gt; Future for JoinHandle&lt;T&gt; &#123; type Output = T; fn poll(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; &#123; match Pin::new(&amp;mut self.0).poll(cx) &#123; Poll::Pending =&gt; Poll::Pending, // å¦‚æœæ˜¯ Noneï¼Œè¡¨ç¤ºä»»åŠ¡ panic æˆ–è€…è¢«å–æ¶ˆäº† Poll::Ready(None) =&gt; panic!("cannot await the result of a panicked task"), // å½“ä»»åŠ¡ç»“æŸï¼Œè‡ªç„¶ä¼šæ‹¿åˆ°å…·ä½“ç»“æœ Poll::Ready(Some(val)) =&gt; Poll::Ready(val), &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œasync_std ä¸­çš„ JoinHandle å®é™…æ˜¯å¯¹ async_task::JoinHandle çš„åŒ…è£…ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥çœ‹ä¸‹å…·ä½“æ˜¯æ€ä¹ˆä» Task ä¸­å–åˆ°ç»“æœçš„ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// async-task-1.1.0/src/join_handle.rs/// A handle that awaits the result of a task.////// * `None` è¡¨ç¤ºä»»åŠ¡è¢«å–æ¶ˆæˆ–è€… panic äº†/// * `Some(result)` è¡¨ç¤ºä»»åŠ¡ç»“æŸï¼Œè¿”å›çš„ç»“æœ `result` ç±»å‹ä¸º `R`pub struct JoinHandle&lt;R, T&gt; &#123; /// A raw task pointer. pub(crate) raw_task: NonNull&lt;()&gt;, /// A marker capturing generic types `R` and `T`. pub(crate) _marker: PhantomData&lt;(R, T)&gt;,&#125;impl&lt;R, T&gt; Future for JoinHandle&lt;R, T&gt; &#123; type Output = Option&lt;R&gt;; fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; &#123; let ptr = self.raw_task.as_ptr(); let header = ptr as *const Header; unsafe &#123; let mut state = (*header).state.load(Ordering::Acquire); loop &#123; // If the task has been closed, notify the awaiter and return `None`. if state &amp; CLOSED != 0 &#123; // ... return Poll::Ready(None); &#125; // If the task is not completed, register the current task. if state &amp; COMPLETED == 0 &#123; // ... &#125; // ä»»åŠ¡å®Œæˆï¼Œæå–ç»“æœ match (*header).state.compare_exchange( state, state | CLOSED, Ordering::AcqRel, Ordering::Acquire, ) &#123; Ok(_) =&gt; &#123; // ä»è¿™é‡ŒæŠŠä»»åŠ¡ç»“æœè·å–å‡ºæ¥ï¼ˆæŒº Hack çš„ï¼‰ï¼Œå°±æ˜¯ä¸‹é¢çš„ output.read() let output = ((*header).vtable.get_output)(ptr) as *mut R; return Poll::Ready(Some(output.read())); &#125; Err(s) =&gt; state = s, &#125; &#125; &#125; &#125;&#125; async_std ä¸­çš„ TaskTask æ˜¯ async_std ä¸­æœ€æ ¸å¿ƒçš„æŠ½è±¡ä¹‹ä¸€ï¼Œå’Œ Rust ä¸­çš„ thread ç±»ä¼¼ã€‚Tasks å’Œè¿è¡Œæ—¶è™½ç„¶ä¹Ÿæœ‰å…³è”ï¼Œä½†å®ƒä»¬æ˜¯åˆ†å¼€çš„ã€‚async_std Task æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š æ‰€æœ‰ä»»åŠ¡æ˜¯å•æ¬¡åˆ†é…çš„ï¼ˆin one single allocationï¼‰ï¼› æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª backchannelï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ JoinHandle å°†ç»“æœå’Œé”™è¯¯ä¼ é€’åˆ°å¯¹åº”çš„ä»»åŠ¡ï¼ˆspawning taskï¼‰ï¼› å®ƒä»¬æºå¸¦ç”¨äºè°ƒè¯•çš„å…ƒä¿¡æ¯ï¼› å®ƒä»¬æ”¯æŒ ä»»åŠ¡çº§åˆ«çš„ local storageã€‚ async_std ä»»åŠ¡ API ä¼šå¤„ç†èƒŒåçš„ runtime åˆå§‹åŒ–ï¼ˆsetupï¼‰å’Œæ¸…ç†ï¼ˆteardownï¼‰å·¥ä½œï¼Œä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼åœ°å¯åŠ¨è¿è¡Œæ—¶ï¼ˆè¿™ä¸ªå’Œ Python 3 æœ‰ä¸¢ä¸¢åŒºåˆ«ï¼‰ã€‚ é˜»å¡ï¼ˆBlockingï¼‰ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸º Tasks éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¯èƒ½å®ƒä»¬ä¼šå…±äº«åŒä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆåœ¨è¯¥çº¿ç¨‹ä¸Šåˆ‡æ¢ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚è¿™åŒæ—¶ä¹Ÿæ„å‘³ç€å¦‚æœåœ¨æŸä¸ªæ‰§è¡Œçº¿ç¨‹ä¸Šè°ƒç”¨äº†é˜»å¡ APIï¼ˆæ¯”å¦‚ std::thread::sleep æˆ–è€…æ ‡å‡†åº“çš„ IO å‡½æ•°ï¼‰ï¼Œä¼šå¯¼è‡´å¯¹åº”æ‰§è¡Œçº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´è¯¥æ‰§è¡Œçº¿ç¨‹ä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½åœæ­¢è¿è¡Œäº†ã€‚å…¶å®ƒçš„ä¸€äº›åº“ï¼ˆå¦‚ db driversï¼‰ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„è¡Œä¸ºã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé˜»å¡å½“å‰çº¿ç¨‹æœ¬èº«å¹¶éåäº‹æƒ…ï¼Œåªæ˜¯ä¸è¦å’Œ async_std å¹¶å‘æ‰§è¡Œçš„æ¨¡å‹ææ··æ·†å³å¯ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿™æ ·åšï¼š 123456fn main() &#123; task::block_on(async &#123; // æ ‡å‡†åº“ std::fsï¼Œä¼šå¯¼è‡´é˜»å¡ std::fs::read_to_string("test_file"); &#125;)&#125; å¦‚æœéœ€è¦æ··åˆé˜»å¡ API è°ƒç”¨ï¼Œå»ºè®®å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ ·çš„é˜»å¡æ“ä½œã€‚ å…³äºé”™è¯¯å’Œ Panicå¸¸è§„æ¨¡å¼ä¸‹ï¼Œå¦‚æœä»»åŠ¡å¯èƒ½å‡ºé”™ï¼Œé‚£ä¹ˆä»»åŠ¡çš„è¾“å‡º Output åº”è¯¥æ˜¯ Result&lt;T, E&gt; ç±»å‹ã€‚ä½†æ˜¯åœ¨ panic çš„æ—¶å€™ï¼Œå…·ä½“çš„è¡¨ç°åˆ™å–å†³äºæœ‰æ²¡æœ‰åˆç†å¤„ç† panic çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šé€€å‡ºã€‚ å®è·µä¸­ï¼Œæ„å‘³ç€ block_on ä¼šä¼ é€’ panic åˆ°é˜»å¡è°ƒç”¨çš„åœ°æ–¹ï¼š12345678fn main() &#123; task::block_on(async &#123; panic!(&quot;test&quot;); &#125;);&#125;thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace. è€Œå¯¹äº spwan å‡ºå»çš„ä»»åŠ¡å¦‚æœ panicï¼Œåˆ™ä¼šå¯¼è‡´é€€å‡ºï¼ˆabortï¼‰ï¼š1234567891011task::spawn(async &#123; panic!(&quot;test&quot;);&#125;);task::block_on(async &#123; task::sleep(Duration::from_millis(10000)).await;&#125;)thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.Aborted (core dumped) ä¸Šé¢çš„è¡Œä¸ºæœ€åˆçœ‹ä¸Šå»æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¦å¤–ä¸€ç§é€‰é¡¹æ˜¯å¯¹äº spawn å‡ºå»çš„ä»»åŠ¡å¦‚æœå‘ç”Ÿ panicï¼Œåˆ™ç®€å•å¿½ç•¥æ‰ã€‚å½“å‰çš„è¡Œä¸ºå¯ä»¥è¢«ä¿®æ”¹ä¸ºæ•è· spawn å‡ºå»çš„ä»»åŠ¡ä¸­å‘ç”Ÿçš„ panicï¼Œå¹¶ä¸”æ ¹æ®ä¸åŒçš„æƒ…å†µåšå‡ºä¸åŒçš„å“åº”ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦é‡‡å–ä¸åŒçš„ panic å¤„ç†ç­–ç•¥ã€‚ æ›´å¤šç¤ºä¾‹åœ¨ è¿™é‡Œ æœ‰ä¸å°‘ç¤ºä¾‹ä»£ç å¯ä»¥å‚è€ƒï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ UDP å®¢æˆ·ç«¯ä¾‹å­ï¼š1234567891011121314151617181920use async_std::io;use async_std::net::UdpSocket;use async_std::task;fn main() -&gt; io::Result&lt;()&gt; &#123; task::block_on(async &#123; let socket = UdpSocket::bind("127.0.0.1:8081").await?; println!("Listening on &#123;&#125;", socket.local_addr()?); let msg = "hello world"; println!("&lt;- &#123;&#125;", msg); socket.send_to(msg.as_bytes(), "127.0.0.1:8080").await?; let mut buf = vec![0u8; 1024]; let (n, _) = socket.recv_from(&amp;mut buf).await?; println!("-&gt; &#123;&#125;\n", String::from_utf8_lossy(&amp;buf[..n])); Ok(()) &#125;)&#125; å‚è€ƒ Async programming in Rust with async-std Asynchronous Programming in Rust]]></content>
      <categories>
        <category>Rust</category>
      </categories>
      <tags>
        <tag>Rust</tag>
        <tag>Async</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆè¯† Elasticsearch]]></title>
    <url>%2F2020%2F01%2F15%2Felasticsearch-intro%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æœç´¢åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯åœ¨ App ä¸­è¿˜æ˜¯ç½‘ç«™ä¸­ã€‚æœç´¢æ¯æ—¶æ¯åˆ»éƒ½åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚æœç´¢å–œæ¬¢çš„é›¶é£Ÿã€å¥½çœ‹çš„è¡£æœã€å–œæ¬¢çš„æ–‡ç« ã€æƒ³è¦å­¦ä¹ çš„è¯¾ç¨‹ç­‰ç­‰ã€‚å¦‚ä»Šè¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ æœç´¢å·²ç»éå¸¸å®¹æ˜“äº†ï¼Œæ—©æœŸæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MySQL çš„ MyISAM å­˜å‚¨å¼•æ“æ¥åšå…¨æ–‡æœ¬æœç´¢æ”¯æŒï¼Œä¸è¿‡ä»Šå¤©è¦è¯´çš„ Elasticsearch åŒæ ·å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ›´å¼ºå¤§ã€‚ç®€å•æ¥è¯´ï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œä¹Ÿæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ELK Stack æ ¸å¿ƒæˆå‘˜ã€‚å®ƒä»¥ JSON çš„æ ¼å¼å­˜å‚¨æ–‡æ¡£åˆ°ç´¢å¼•å½“ä¸­ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å¤šç§ç±»å‹ï¼Œå¹¶æä¾›å¿«é€Ÿæœç´¢çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ•´ä¸ª ELK Stack ç”Ÿæ€éå¸¸å®Œå–„ã€‚ é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è·Ÿç€å®˜æ–¹æ–‡æ¡£å­¦ä¹ ä¸‹ Elasticsearch å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿé€‚ç”¨çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæ”¯æŒä»€ä¹ˆæ•°æ®ç±»å‹å­˜å‚¨å’Œæ£€ç´¢ï¼Ÿ PS: æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ ES æ„å»ºäº†è¯¾ç¨‹å•†å“ï¼ˆSKUï¼‰ç´¢å¼•ï¼Œæ–¹ä¾¿å¯¹ç”¨æˆ·ã€ç®¡ç†åå°æä¾›è¯¾ç¨‹æœç´¢èƒ½åŠ›ã€‚ å®‰è£…docker-elk ä»“åº“æä¾›äº†åœ¨ Docker ç¯å¢ƒä¸‹æ­å»º ELK Stack æœåŠ¡çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶è¯´æ˜æ–‡æ¡£è¿›è¡Œå®‰è£…ï¼ˆåœ¨ macOS Catalina ç¯å¢ƒä¸‹æ“ä½œï¼‰ã€‚ å…‹éš†ä»“åº“ï¼šgit clone git@github.com:deviantony/docker-elk.git ç¬¬ä¸€æ¬¡éœ€è¦è¿è¡Œ docker-compose buildï¼Œç­‰å¾…æ„å»ºå®Œæˆ éœ€è¦åœ¨ docker-compose.yml ä¸­ä¿®æ”¹ä¸‹ ES çš„å¯†ç ï¼Œå½“ç„¶è¿˜æœ‰ elasticsearch/configï¼Œkibana/config, logstash/config ä¸­éƒ½æœ‰å¯†ç éœ€è¦ä¿®æ”¹ã€‚ç”±äºæ˜¯åœ¨æœ¬åœ°å­¦ä¹ ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•è®¾ç½®äº†ä¸‹å¯†ç ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®å‚è€ƒæ–‡æ¡£ï¼Œç”Ÿæˆå¤æ‚çš„å¯†ç  è¿è¡Œ docker-compose up [-d] å³å¯å¯åŠ¨ å…³é—­ docker-compose down -v æ³¨æ„äº‹é¡¹ï¼š é…ç½®æ–‡ä»¶å¹¶éåŠ¨æ€åŠ è½½ï¼Œæ¯æ¬¡å˜æ›´åéœ€è¦é‡å¯å¯¹åº”çš„ç»„ä»¶ ç«¯å£æ˜ å°„è¯´æ˜ï¼š 9200: ES HTTP 9300: ES TCP 5000: Logstash TCP input 5601: Kibana å¯åŠ¨æˆåŠŸåï¼Œå¯ä»¥æ‰“å¼€ Kibana å¼€å§‹æ¢ç´¢å•¦~ Elasticsearch ç®€ä»‹Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼ŒELK æ ˆçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚è€Œ Logstash å’Œ Beats ç”¨äºæ”¶é›†ã€èšåˆã€è½¬æ¢æ•°æ®ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ Elasticsearch å½“ä¸­ã€‚è€Œ Kibana åˆ™è®©æˆ‘ä»¬èƒ½å¤Ÿä¾¿æ·æ¢ç´¢ã€æŸ¥çœ‹å¹¶åˆ†äº«æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥ç®¡ç† ELK æ ˆã€‚ ES æä¾›äº†å®æ—¶çš„æœç´¢å’Œåˆ†æèƒ½åŠ›ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆç»“æ„åŒ–ã€éç»“æ„åŒ–ã€æ•°å­—ã€åœ°ç†ä½ç½®ç­‰ï¼‰ï¼ŒES ä¼šé«˜æ•ˆåœ°å­˜å‚¨å¹¶ç´¢å¼•è¿™äº›æ•°æ®ï¼Œä»è€Œæ”¯æŒå¿«é€Ÿæœç´¢ã€‚ç”±äºåˆ†å¸ƒå¼çš„ç‰¹ç‚¹ï¼Œéšç€æ•°æ®é›†çš„å¢åŠ ï¼Œå¯ä»¥è½»æ¾åœ°è¿›è¡Œæ°´å¹³æ‰©å±•æ¥æé«˜æœåŠ¡å¯é æ€§å’Œæ€§èƒ½ã€‚ ES æ”¯æŒçš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š ä¸ºæˆ‘ä»¬çš„ App æˆ–ç½‘ç«™æä¾›æœç´¢æ”¯æŒ å¯ä»¥å­˜å‚¨åˆ†ææ—¥å¿—ï¼ˆanalyze logsï¼‰ã€æŒ‡æ ‡æ•°æ®ï¼ˆmetricsï¼‰ã€å®‰å…¨äº‹ä»¶æ•°æ®ï¼ˆsecurity event dataï¼‰ åŸºäºæœºå™¨å­¦ä¹ æ ¹æ®æ•°æ®å®æ—¶å»ºæ¨¡ å¯ä»¥ç”¨ä½œ GIS ç³»ç»Ÿï¼ˆåœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼‰ï¼Œç”¨äºç®¡ç†ã€é›†æˆå¹¶åˆ†æç©ºé—´ä¿¡æ¯ å¯ä»¥ç”¨äºç”Ÿç‰©å­¦ç ”ç©¶å·¥å…·ï¼Œå­˜å‚¨å¹¶å¤„ç†åŸºå› æ•°æ® æ–‡æ¡£å’Œç´¢å¼•ES æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨æœåŠ¡ï¼ˆç±»æ¯” Mongoï¼Ÿï¼‰ï¼Œå®é™…åœ¨ç´¢å¼•ä¸­å­˜å‚¨çš„æ˜¯ JSON æ ¼å¼çš„æ–‡æ¡£ã€‚åœ¨ ES é›†ç¾¤ä¸­ï¼Œæ–‡æ¡£ä¼šè¢«åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤å­˜å‚¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ç«‹åˆ»è®¿é—®åˆ°ã€‚ ä¸€æ—¦æ–°çš„æ–‡æ¡£å­˜å‚¨åˆ°ç´¢å¼•åï¼Œå‡ ä¹å¯ä»¥ç«‹åˆ»è¢«æœç´¢åˆ°ï¼ˆ1s ä»¥å†…ï¼‰ï¼Œå› æ­¤å¯ä»¥æ„å»ºè¿‘ä¹å®æ—¶çš„æœç´¢å¼•æ“ã€‚é‚£ä¹ˆ ES ç©¶ç«Ÿæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒä½¿ç”¨äº†å€’æ’ç´¢å¼•ï¼ˆinverted indexï¼‰è¿™ç§æ•°æ®ç»“æ„æ¥æ”¯æŒå…¨æ–‡æœ¬æœç´¢ã€‚æ‰€è°“çš„å€’æ’ç´¢å¼•å°±æ˜¯å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ï¼Œç„¶åè®°å½•æ¯ä¸ªåˆ†è¯æ‰€åœ¨çš„æ–‡æ¡£ idï¼ˆå½“ç„¶è¿˜æœ‰è¯é¢‘ç­‰ä¿¡æ¯ï¼‰ï¼Œè¿™æ ·åœ¨æŸ¥è¯¢æ—¶å¯ä»¥åŸºäºåˆ†è¯å¿«é€Ÿå®šä½æ‰€åœ¨çš„æ–‡æ¡£ã€‚ åœ¨ ES ä¸­ï¼Œç´¢å¼•æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼ˆå›é¡¾ä¸‹ MySQL InnoDB çš„èšç°‡ç´¢å¼•ï¼Œè¡¨ä¸­çš„è®°å½•å­˜å‚¨åœ¨ B-Tree Node ä¸Šï¼ŒåŸºäº B+ Tree è¿™ç§æ•°æ®ç»“æ„å¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„é¡µï¼‰ï¼Œä½†æ˜¯è¿™é‡Œçš„ç´¢å¼•å’Œåœ¨å…³ç³»æ•°æ®åº“ä¸­æåˆ°çš„ç´¢å¼•æœ‰æ‰€å·®åˆ«ã€‚æ€»ç»“ä¸‹ç‰¹ç‚¹ï¼š ES çš„ç´¢å¼•ï¼ˆindexï¼‰å¯ä»¥çœ‹æˆæ–‡æ¡£ï¼ˆdocumentï¼‰çš„é›†åˆï¼› æ¯ä¸ªæ–‡æ¡£ï¼ˆdocumentï¼‰å¯ä»¥çœ‹æˆå­—æ®µï¼ˆfieldï¼‰ï¼ˆç±»æ¯”ä¸‹å­—å…¸ä¸­çš„ key-valueï¼‰çš„é›†åˆï¼› é»˜è®¤è®¾ç½®ä¸‹ï¼ŒES ä¼šä¸ºæ–‡æ¡£ä¸­çš„æ¯ä¸ªå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µéƒ½ä¼šåŒ¹é…ä¸“é—¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„ä»¥è¾¾åˆ°é«˜æ•ˆå­˜å‚¨å’Œå¿«é€Ÿæœç´¢çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šæ–‡æœ¬ä½¿ç”¨å€’æ’ç´¢å¼•ï¼Œæ•°å­—å’Œåœ°ç†ä½ç½®ä½¿ç”¨ BKD æ ‘ã€‚ ES æ”¯æŒ schema-lessï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨ä¸ºæ¯ä¸ªå­—æ®µæ˜¾å¼æŒ‡å®šç´¢å¼•æ–¹å¼ã€‚å½“æˆ‘ä»¬å¯ç”¨åŠ¨æ€æ˜ å°„ï¼ˆdynamic mappingï¼‰æ—¶ï¼ˆè¿™ä¸ªæ˜¯é»˜è®¤è®¾ç½®ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ–°å¢å­—æ®µï¼Œè‡ªåŠ¨å°†æ–‡æ¡£ä¸­çš„ bool å€¼ã€æµ®ç‚¹æ•°ã€æ•´æ•°ã€æ—¥æœŸã€å­—ç¬¦ä¸²ç­‰æ˜ å°„æˆåˆé€‚çš„ ES æ•°æ®ç±»å‹ã€‚ å½“ç„¶ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦å…³é—­åŠ¨æ€æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™æ—¶å¯ä»¥è‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼Œä»è€Œæ§åˆ¶æ¯ä¸ªå­—æ®µå­˜å‚¨å’Œç´¢å¼•çš„æ–¹å¼ã€‚è‡ªå®šä¹‰æ˜ å°„å¸¦å¯ä»¥ï¼š åŒºåˆ†å…¨æ–‡æœ¬å­—ç¬¦ä¸²å­—æ®µå’Œç²¾ç¡®åŒ¹é…çš„å­—ç¬¦ä¸²å­—æ®µï¼› æ‰§è¡Œç‰¹å®šè¯­è¨€çš„æ–‡æœ¬åˆ†æï¼› ä¼˜åŒ–éƒ¨åˆ†åŒ¹é…ï¼› ä½¿ç”¨è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼› ä½¿ç”¨ä¸€äº›æ— æ³•è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ geo_point, geo_shapeï¼‰ã€‚ æ­¤å¤–ï¼ŒES å¯ä»¥ä¸ºç›¸åŒçš„å­—æ®µå»ºç«‹ä¸åŒçš„ç´¢å¼•ï¼Œä»¥æ»¡è¶³ä¸åŒçš„éœ€æ±‚åœºæ™¯ã€‚ æœç´¢ä¸åˆ†æES æä¾›äº†éå¸¸ç®€å•æ˜“äºä½¿ç”¨çš„ REST APIï¼Œå¯ä»¥åˆ©ç”¨å®ƒä»¬ç®¡ç†é›†ç¾¤ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚æˆ‘ä»¬æ—¢å¯ä»¥åœ¨ Kibana æ§åˆ¶å°ä¸­å’Œ ES äº¤äº’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å„ä¸ªè¯­è¨€ï¼ˆæ”¯æŒ Java, JavaScript, Go, .Net, PHP, Perl, Python, Ruby ç­‰ï¼‰çš„å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ã€‚ æœç´¢æ•°æ®ç›®å‰æ”¯æŒä¸¤ç§æŸ¥è¯¢æ–¹å¼ï¼šJSON Query DSL å’Œ SQLã€‚ ES API å…è®¸æˆ‘ä»¬ä½¿ç”¨ç»“æ„åŒ–æŸ¥è¯¢ã€å…¨æ–‡æœ¬æŸ¥è¯¢æˆ–è€…äºŒè€…ç»„åˆï¼š ç»“æ„åŒ–æŸ¥è¯¢ï¼šç±»ä¼¼ SQL é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢æŸå‡ ä¸ªå­—æ®µï¼ŒåŸºäºæŸå­—æ®µæ’åºç­‰ï¼› å…¨æ–‡æœ¬æŸ¥è¯¢ï¼šè¿”å›åŒ¹é…å…³é”®è¯çš„æ–‡æ¡£ï¼Œè¿”å›çš„ç»“æœåŸºäºç›¸å…³æ€§æ’åºã€‚ æ­¤å¤–ï¼Œè¿˜æ”¯æŒå•ç‹¬åˆ†è¯ï¼ˆindividual termsï¼‰æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒçŸ­è¯­æœç´¢ï¼ˆphrase searchesï¼‰ã€ç›¸ä¼¼åº¦æœç´¢ï¼ˆsimilarity searchesï¼‰å’Œå‰ç¼€æœç´¢ï¼ˆprefix searchesï¼‰ï¼Œç”šè‡³å¯ä»¥å¾—åˆ°è‡ªåŠ¨è¡¥å…¨çš„å»ºè®®ã€‚å½“ç„¶ï¼Œå¯¹äºåœ°ç†ä½ç½®æˆ–è€…æ•°å­—ç±»å‹çš„æ•°æ®ï¼ŒES ä¹Ÿå¯ä»¥æä¾›é«˜æ•ˆçš„æŸ¥è¯¢åŠŸèƒ½ã€‚ åˆ†ææ•°æ®ES å…è®¸æˆ‘ä»¬æ‰§è¡Œèšåˆï¼ˆaggregationï¼‰æ“ä½œï¼Œä»è€Œå¯¹å…³é”®çš„æŒ‡æ ‡ã€ å¢é•¿è¶‹åŠ¿ç­‰æœ‰æ›´ä¸ºæ·±åˆ»çš„è®¤è¯†ã€‚ES é«˜æ•ˆèšåˆçš„èƒ½åŠ›ï¼Œå¯ä»¥è®©æˆ‘ä»¬èƒ½å¤Ÿå®æ—¶åœ°åˆ†æå’Œå¯è§†åŒ–æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæœç´¢å’Œèšåˆè”åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æœç´¢ã€è¿‡æ»¤æ–‡æ¡£çš„åŒæ—¶ï¼Œå¯¹ç›¸åŒçš„ç»“æœè¿›è¡Œåˆ†æã€‚ æ­¤å¤–ï¼ŒES è¿˜æä¾›äº†è‡ªåŠ¨åˆ†ææ—¶åºæ•°æ®çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨æœºå™¨å­¦ä¹ æ¥å‘ç°æ•°æ®ä¸­çš„å¼‚å¸¸ï¼Œä¸è¿‡è¿™å—å±äºé«˜çº§åŠŸèƒ½äº†ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸‹~ é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§ æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œé«˜å¯ç”¨å’Œå¯ä¼¸ç¼©çš„èƒ½åŠ›è‡ªç„¶æ˜¯ ES å¿…å¤‡æŠ€èƒ½ã€‚æˆ‘ä»¬å¯ä»¥æŒ‰éœ€ç»™é›†ç¾¤å¢åŠ æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰å®ç°æ‰©å®¹ã€‚ES ä¼šè‡ªåŠ¨å°†æ•°æ®å’ŒæŸ¥è¯¢è´Ÿè½½å‡è¡¡åˆ°å¯ç”¨èŠ‚ç‚¹ä¸Šï¼Œä»¥å®ç°ä¼¸ç¼©å’Œé«˜å¯ç”¨ã€‚ é‚£ä¹ˆï¼ŒES æ˜¯å¦‚ä½•å­˜å‚¨å’Œç»´æŠ¤ç´¢å¼•çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œæ¯ä¸ª ES ç´¢å¼•ï¼ˆindexï¼‰å…¶å®æ˜¯ä¸€ä¸ªåˆ°å¤šä¸ªç‰©ç†åˆ†ç‰‡ï¼ˆphysical shardsï¼‰ æ‰€ç»„æˆçš„é€»è¾‘åˆ†ç»„ï¼ˆlogical groupï¼‰ï¼›æ¯ä¸ªåˆ†ç‰‡å®é™…æ˜¯è‡ªåŒ…å«ç´¢å¼•ï¼ˆself-contained indexï¼‰ã€‚é€šè¿‡å°†ç´¢å¼•æ”¾åˆ°å¤šä¸ªåˆ†ç‰‡å­˜å‚¨ï¼Œç„¶åå°†åˆ†ç‰‡åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼ŒES å¯ä»¥ä¸ºåˆ†ç‰‡æä¾›å†—ä½™å¤‡ä»½ï¼Œä»è€Œè¾¾åˆ°æ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨çš„ç›®çš„ã€‚éšç€é›†ç¾¤çš„æ‰©å®¹ï¼ˆæˆ–ç¼©å®¹ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨å†å‡è¡¡ï¼Œå¿…è¦æ—¶ä¹Ÿä¼šåˆå¹¶åˆ†ç‰‡ã€‚ å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰åˆ†ç‰‡åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š ä¸»åˆ†ç‰‡ï¼ˆprimary shardï¼‰ï¼šç´¢å¼•ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½å±äºæŸä¸ªä¸»åˆ†ç‰‡ã€‚ å‰¯æœ¬åˆ†ç‰‡ï¼ˆreplicasï¼‰ï¼šå‰¯æœ¬åˆ†ç‰‡å…¶å®å°±æ˜¯ä¸»åˆ†ç‰‡çš„æ‹·è´ï¼Œä¸€æ–¹é¢å®ç°æ•°æ®å†—ä½™ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯¹å¤–æä¾›è¯»æœåŠ¡ï¼ˆæœç´¢ã€è·å–æ–‡æ¡£ç­‰ï¼‰ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°åœ¨åˆ›å»ºåå°±ä¸èƒ½ä¿®æ”¹äº†ï¼Œåªèƒ½é‡å»ºé é‡å»ºç´¢å¼•æ¥æ‰©å±•ä¸»åˆ†ç‰‡æ•°ï¼Œä½†æ˜¯å‰¯æœ¬åˆ†ç‰‡æ•°å¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œä¸ä¼šæ‰“æ–­ç´¢å¼•å’ŒæŸ¥è¯¢æ“ä½œã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°è¶Šå¤šè¶Šå¥½å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯è¿™æ ·çš„ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘ç´¢å¼•çš„æ•°æ®é‡å¤§å°ï¼Œå°½å¯èƒ½ä¿è¯æ¯ä¸ªåˆ†ç‰‡ä¸è¦å¤ªå¤§ï¼Œåˆ†ç‰‡æ•°é‡ä¸è¦è¿‡å¤šã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åˆ†ç‰‡æ•°è¿‡å¤šä¼šå¯¼è‡´çš„é—®é¢˜å§ï¼š æ¯ä¸ªåˆ†ç‰‡å…¶å®éƒ½æ˜¯ä¸€ä¸ª Lucene ç´¢å¼•ï¼Œä¼šå ç”¨æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜å’Œ CPU èµ„æºï¼› æœç´¢ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœåˆ†ç‰‡éƒ½ä½äºä¸åŒèŠ‚ç‚¹è¿˜å¥½ï¼Œè¦æ˜¯é›†ä¸­åœ¨æŸä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå‡ºç°çƒ­ç‚¹é—®é¢˜ï¼Œèµ„æºç«äº‰æ¿€çƒˆï¼Œæ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼› è¿‡å¤šçš„åˆ†ç‰‡ä¹Ÿä¼šå¯¼è‡´è¿‡å¤šçš„åˆ†ç‰‡è¯·æ±‚ï¼Œä¼šäº§ç”Ÿä¸€å®šçš„ç½‘ç»œå¼€é”€ç­‰ï¼› ES ä½¿ç”¨è¯é¢‘æ¥ç»Ÿè®¡åŒ¹é…çš„ç›¸å…³æ€§ï¼Œç»Ÿè®¡ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœå¤§é‡åˆ†ç‰‡ä¸Šåªç»´æŠ¤äº†å¾ˆå°‘çš„æ•°æ®ï¼Œåˆ™ä¼šå¯¼è‡´æœ€ç»ˆçš„æ–‡æ¡£çš„ç›¸å…³æ€§è¾ƒå·®ã€‚ å¦‚æœæ¯ä¸ªåˆ†ç‰‡è¿‡å¤§ï¼Œåˆ™ä¼šå¯¼è‡´é›†ç¾¤å†å‡è¡¡åŠæ—¶ï¼Œæ¬è¿æ•°æ®æ›´è€—æ—¶ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æµ‹è¯•æ¥ç¡®å®šæœ€ä½³çš„é…ç½®ã€‚èµ·åˆå¯ä»¥è¿™æ ·ï¼š ä¿è¯æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°åœ¨ GB åˆ°å‡ å GB èŒƒå›´ã€‚å¯¹äºå¸¸è§çš„æ—¶åºæ•°æ®ï¼Œåˆ†ç‰‡å¤§å°åœ¨ 20GB ~ 40GB ä¹Ÿå¾ˆå¸¸è§ã€‚å‚è€ƒæ–‡çŒ®ä¸­ç»™å‡ºçš„å¤§å°é™åˆ¶ä¸º 30GBã€‚ é¿å…è¿‡å¤§çš„åˆ†ç‰‡é—®é¢˜ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯å®¹çº³çš„åˆ†ç‰‡æ•°é‡å’Œå¯ç”¨çš„å †ç©ºé—´æˆæ­£æ¯”ï¼Œæ¯ GB å †ç©ºé—´åˆ†ç‰‡æ•°åº”è¯¥å°äº 20ã€‚ ç¾å¤‡è€ƒè™‘æ€§èƒ½çš„å› ç´ ï¼Œé€šå¸¸é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åº”è¯¥ä½äºç›¸åŒçš„ç½‘ç»œç¯å¢ƒã€‚è·¨æ•°æ®ä¸­å¿ƒå‡è¡¡åˆ†ç‰‡éå¸¸è€—æ—¶ï¼Œå¯é æ€§ä¹Ÿä¼šé™ä½ã€‚ä½†æ˜¯é«˜å¯ç”¨æ¶æ„è®¾è®¡å°±æ˜¯è¦ä¿è¯æˆ‘ä»¬ä¸è¦æŠŠé¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œï¼Œè¿™æ ·ä¸€æ—¦æŸå¤„çš„æœåŠ¡å™¨å®•æœºï¼Œä½äºå…¶å®ƒä½ç½®çš„æœåŠ¡å™¨å¯ä»¥æ¥æ›¿ç»§ç»­æä¾›æœåŠ¡ã€‚ ES ä¸ºæˆ‘ä»¬æä¾›äº† CCR åŠŸèƒ½ï¼ˆè·¨é›†ç¾¤å¤åˆ¶ï¼ŒCross-cluster replicationï¼‰ï¼Œè¿™æ ·å¯ä»¥å°†ä¸»é›†ç¾¤çš„ç´¢å¼•åŒæ­¥åˆ°è¿œç¨‹çš„é›†ç¾¤ä½œä¸ºçƒ­å¤‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŸºäºåœ°ç†ä½ç½®ä½¿ç”¨å…¶å®ƒé›†ç¾¤æä¾›è¯»è¯·æ±‚ã€‚æ‰€æœ‰çš„å†™å…¥æ“ä½œéƒ½åœ¨ä¸»é›†ç¾¤å®Œæˆï¼Œå…¶å®ƒçš„å‰¯æœ¬é›†ç¾¤éƒ½æ˜¯åªè¯»çš„ Followersã€‚ æ¶æ„ å®è·µç”Ÿäº§ç¯å¢ƒåˆ›å»ºç´¢å¼•æ¨¡æ¿ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152PUT /_template/km_server_warehouse_template&#123; "order": 1, "index_patterns": [ "km_server_warehouse*" ], "settings": &#123; "index": &#123; "analysis": &#123; "analyzer": &#123; "znlp-coarse": &#123; "type": "custom", "tokenizer": "znlp-fine" &#125; &#125; &#125;, "number_of_shards": "1", "translog": &#123; "sync_interval": "5s", "durability": "async" &#125;, "number_of_replicas": "4", "similarity": &#123; "scripted_bm25": &#123; "type": "scripted", "script": &#123; "source": "double k1 = 1.2; double b = 0.75; double tfNorm = doc.freq * (k1 + 1) / (doc.freq + k1 * (1 - b + b * doc.length / (1.0 * field.sumTotalTermFreq/field.docCount))); return query.boost * tfNorm;" &#125; &#125; &#125; &#125; &#125;, "mappings": &#123; "contents": &#123; "dynamic": false, "properties": &#123; "content_basic": &#123; "type": "nested", "properties": &#123; "sku_id": &#123; "type": "long" &#125;, "business_id": &#123; "type": "long" &#125;, "business_type": &#123; "type": "keyword" &#125;, "producer": &#123; "type": "keyword" &#125;, "svip_right": &#123; "type": "nested", "properties": &#123; "free": &#123; "type": "boolean" &#125;, "discount": &#123; "type": "short" &#125; &#125; &#125;, "instabook_right": &#123; "type": "nested", "properties": &#123; "free": &#123; "type": "boolean" &#125;, "discount": &#123; "type": "short" &#125; &#125; &#125;, "svip_privileges": &#123; "type": "boolean" &#125;, "title": &#123; "similarity": "scripted_bm25", "analyzer": "znlp-fine", "type": "text" &#125;, "authors": &#123; "type": "keyword" &#125;, "right_list": &#123; "type": "keyword" &#125;, "serial_status": &#123; "type": "short" &#125;, "public_status": &#123; "type": "short" &#125;, "online_time": &#123; "type": "long" &#125;, "categories": &#123; "type": "nested", "properties": &#123; "id": &#123; "type": "long" &#125;, "level": &#123; "type": "short" &#125;, "weight": &#123; "type": "short" &#125;, "name": &#123; "type": "text", "fields": &#123; "keyword": &#123; "ignore_above": 256, "type": "keyword" &#125; &#125; &#125;, "name_en": &#123; "type": "text", "fields": &#123; "keyword": &#123; "ignore_above": 256, "type": "keyword" &#125; &#125; &#125; &#125; &#125;, "is_test": &#123; "type": "boolean" &#125; &#125; &#125;, "content_aggregation": &#123; "type": "nested", "properties": &#123; "interest_count": &#123; "type": "long" &#125; &#125; &#125;, "created_at": &#123; "type": "long" &#125;, "updated_at": &#123; "type": "long" &#125; &#125; &#125; &#125;, "aliases": &#123;&#125;&#125; å‚è€ƒ ES ä»‹ç» Query DSL Elasticsearchç³»ç»Ÿæ¦‚å¿µåŠæ¶æ„å›¾ å€’æ’ç´¢å¼• èŠèŠ ELASTICSEARCH çš„é›†ç¾¤çŠ¶æ€çš„ç®¡ç†å’Œç»´æŠ¤ THE COMPLETE GUIDE TO THE ELK STACK ELK Stack Tutorial â€“ Discover, Analyze And Visualize Your Data Efficiently Lucene BKDæ ‘-åŠ¨æ€ç£ç›˜ä¼˜åŒ–BSPæ ‘ èŠèŠ ES åˆ†ç‰‡ä¼˜åŒ–]]></content>
      <categories>
        <category>Elasticsearch</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
        <tag>ELK</tag>
        <tag>æœç´¢å¼•æ“</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«é€’ç½‘ç‚¹æŠ“å–æ‚è®°]]></title>
    <url>%2F2019%2F12%2F29%2Fcraw-dilivery-network-distribution%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åº”æ±‚å¼€å‘ä¸€ä¸ªç®€å•çš„çˆ¬è™«ï¼Œç”¨äºä»å¿«é€’ 100 æŠ“å–å¿«é€’ç½‘ç‚¹çš„åˆ†å¸ƒï¼Œè¾“å…¥çœä»½+åŸå¸‚+åŒºå¿ï¼Œç„¶åæ˜¯å¿«é€’å…¬å¸åç§°ï¼ŒæŠ“å–å…¶å¯¹åº”çš„å¿«é€’ç½‘ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€åœ°å€ã€ç”µè¯ã€åæ ‡ç­‰ï¼‰ã€‚è¯´èµ·æ¥ï¼Œå¼€å‘è¿™æ ·ä¸€ä¸ªç®€å•çš„çˆ¬è™«å…¶å®æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆæ²¡æœ‰æ—¶é—´è¦æ±‚ã€ä¸éœ€è¦åˆ†å¸ƒå¼æŠ“å–ã€æ²¡ä»€ä¹ˆååçˆ¬ç­–ç•¥åŠ æŒç­‰ï¼‰ï¼Œä¸è¿‡è¿™æœŸé—´ä¹Ÿé‡åˆ°ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸‹ã€‚ å¦å¤–å°±æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦äº† pyecharts è¿™ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨èµ·æ¥è¿˜æŒºæ–¹ä¾¿çš„ã€‚æ ·å¼é…ç½®å¥½ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥å¾ˆå¥½çš„è§†è§‰å†²å‡»çš„ï¼å½“ç„¶ï¼Œå…³é”®æ˜¯åˆ©ç”¨è¿™ç§å·¥å…·æœ‰åŠ©äºå¢åŠ å¯¹æŠ“å–æ•°æ®çš„ç†è§£ï¼ˆçœ‹å…·ä½“éœ€è¦çš„åˆ†æç»´åº¦äº†ï¼‰ã€‚ æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œè™½ç„¶å®šä½æŸäº›å…ƒç´ çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œå†™ XPath è¡¨è¾¾å¼ä¹Ÿæ¯”è¾ƒæ¯ç‡¥ï¼ˆä¸è¦æŒ‡æœ›æµè§ˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„ XPathï¼Œé€šå¸¸éƒ½ä¸å¤Ÿé€šç”¨ï¼‰ã€‚ä½†æ˜¯å®Œæˆæ•´ä¸ªä»»åŠ¡åï¼Œè¿˜æ˜¯æœ‰äº›æ”¶è·çš„ã€‚ä¸‹é¢å¼€å§‹å§~ ç¡®å®šæ–¹æ¡ˆå°è¯• API ç›´æ¥è·å–å¿«é€’ 100 å¯¹å¤–å…¬å¼€çš„ API æ–‡æ¡£åœ¨æ­¤ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æ”¾ç½‘ç‚¹æŸ¥è¯¢çš„æ¥å£ï¼Œæ•…æ— æ³•ä½¿ç”¨ã€‚ç›´æ¥é€šè¿‡ API æŸ¥è¯¢æ˜¯æœ€çœå¿ƒçš„æ–¹å¼ï¼Œä½†æ˜¯ç›®å‰è¿™æ¡è·¯è¡Œä¸é€šã€‚ å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨ API è¯·æ±‚ç½‘ç‚¹æŸ¥è¯¢çš„ä¸»é¡µï¼Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„åŸå¸‚å’Œå¿«é€’å…¬å¸ï¼Œé¡µé¢å†…å®¹è‡ªåŠ¨åˆ‡æ¢ã€‚æ­¤æ—¶ï¼Œè¿˜æ˜¯å°è¯•åˆ†æå…¶ API è¯·æ±‚ï¼Œå› ä¸ºè¿™ä¸ªé€šå¸¸æ˜¯æŠ“å–ç½‘ç«™æœ€ç®€å•çš„æ–¹å¼ã€‚ æ‰“å¼€ Chrome æµè§ˆå™¨çš„è°ƒè¯•æ¨¡å¼ï¼Œé€šè¿‡ç‚¹å‡»é¡µé¢ä¸Šçš„ç­›é€‰é¡¹ï¼ŒæŸ¥çœ‹ç½‘ç»œè¯·æ±‚ï¼Œç¡®å®šè¯·æ±‚äº†ä»€ä¹ˆæ¥å£ï¼Œä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè¿”å›çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œä»è€Œèƒ½å¤Ÿæ¨¡æ‹Ÿå…¶è¯·æ±‚æ–¹å¼æ¥è·å–æ•°æ®ã€‚æ¥ä¸‹æ¥æ¼”ç¤ºçš„æ˜¯æŸ¥è¯¢ä¸Šæµ·åœ°åŒºçš„æŸå¿«é€’å…¬å¸çš„ç½‘ç‚¹ã€‚ æˆªå›¾ 1ï¼šè¯·æ±‚æ–¹å¼ä¸º POSTï¼ŒURL ä¸º www.kuaidi100.com/network/searchapi.do æˆªå›¾ 2ï¼šä»¥è¡¨å•çš„å½¢å¼ï¼Œæäº¤äº†è¯·æ±‚çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯é¡µé¢ç‚¹å‡»çš„ç­›é€‰é¡¹ã€‚ æˆªå›¾ 3ï¼šå½“å®Œæˆè¯·æ±‚åï¼Œå¯ä»¥çœ‹åˆ°å…¶è¿”å›ç»“æœä¸º JSON ç»“æ„ï¼Œå…¶ä¸­çš„ netList æ­£æ˜¯æƒ³è¦æ‰¾çš„ç½‘ç‚¹æ•°æ®ã€‚ å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–ä¸€èˆ¬åœ¨è¿›è¡Œç½‘ç«™æ•°æ®æŠ“å–æ—¶ï¼Œèƒ½é€šè¿‡å…¶ API è·å–ï¼Œå°±å°½å¯èƒ½å»åˆ©ç”¨ã€‚ä½¿ç”¨ API è¯·æ±‚æ•°æ®çš„å¥½å¤„æœ‰è¿™ä¹ˆå‡ ç‚¹ï¼š çœå»äº†åˆ†æç½‘é¡µ HTML ç»“æ„çš„æ—¶é—´ï¼Œå¯ä»¥ç›´æ¥è§£ææ¥å£è¿”å›çš„æ•°æ®ï¼Œæå–æƒ³è¦çš„ä¿¡æ¯å¹¶å­˜å‚¨å³å¯ï¼› API è¯·æ±‚æ–¹å¼æœ€ä¸ºç®€å•å¯é çµæ´»ï¼Œä¸”èƒ½é€‚åº”è¾ƒé«˜çš„æŠ“å–é¢‘ç‡ï¼› ç›¸å¯¹äºåˆ†æç½‘é¡µ HTML ç»“æ„ï¼Œæå–ä¿¡æ¯çš„æ–¹å¼ï¼ŒAPI æŠ“å–é€šå¸¸ä¸ç”¨åƒæ‹…å¿ƒå‰ç«¯é¡µé¢é¢‘ç¹æ”¹ç‰ˆè€Œå¯¼è‡´çˆ¬è™«ç¨‹åºä¹Ÿè¦å³ä½¿æ›´æ–°çš„å›°å¢ƒï¼Œæ–¹ä¾¿ç»´æŠ¤ã€‚ ä¸è¿‡åªæ˜¯é€šè¿‡ API æ¥æŠ“å–ï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œåœ¨ Selenium çš„å¸®åŠ©ä¸‹ï¼Œä»¥å¯è§†åŒ–çš„æ–¹å¼æŠ“å–é¡µé¢è²Œä¼¼æ›´æœ‰è¶£ç‚¹ã€‚è¿™é‡Œçš„æ€è·¯å¦‚ä¸‹ï¼š å®‰è£… Selenium + Chrome Web Driverï¼Œé€šè¿‡æ“çºµæµè§ˆå™¨æ¨¡æ‹Ÿäººç±»è®¿é—®é¡µé¢çš„æ–¹å¼æ¥æŠ“å–æ•°æ®ï¼› ç¼–å†™çˆ¬è™«ç¨‹åºï¼Œæ§åˆ¶æµè§ˆå™¨æ‰“å¼€ç½‘ç‚¹æŸ¥è¯¢çš„é¦–é¡µï¼šhttps://www.kuaidi100.com/network/ æ¥æ”¶è¾“å…¥çš„åŸå¸‚å’Œå¿«é€’å…¬å¸åç§°ä½œä¸ºå‚æ•°ï¼Œç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»ä¸‹æ‹‰æ¡†ï¼Œé€‰æ‹©åŸå¸‚ï¼›ç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»æŒ‡å®šçš„å¿«é€’å…¬å¸ï¼› æ¥ä¸‹æ¥å¼€å§‹è§£æé¡µé¢ç»“æ„ï¼Œæå–å¿«é€’ç½‘ç‚¹æ•°æ®è½¬æ¢ä¸º JSON æ ¼å¼ï¼ˆåœ°ç†ä½ç½®åæ ‡é€šè¿‡ç™¾åº¦åœ°å›¾ API è·å¾—ï¼‰ï¼Œå­˜å‚¨åœ¨æŒ‡å®šè·¯å¾„ä¸‹ï¼›ç„¶åä¸æ–­æ§åˆ¶æµè§ˆå™¨ç¿»é¡µï¼Œå®Œæˆå‰©ä½™é¡µé¢è§£æï¼Œè‡³æ­¤å¯¹åº”çš„ç½‘ç‚¹ä¿¡æ¯æŠ“å–å®Œæˆã€‚ å‡†å¤‡å¼€å‘ç¯å¢ƒ Python 3.7 ç¯å¢ƒï¼› selenium-pythonï¼Œå…¶ä½¿ç”¨æ–‡æ¡£å‚è€ƒæ­¤å¤„ï¼› chromedriver ä¸‹è½½ï¼Œå¹¶è§£å‹å¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼› Anaconda ç¯å¢ƒå®‰è£…ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯ Jupter Notebook èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼› ä¾èµ–çš„é‡è¦ Python åŒ…å®‰è£…ï¼š pyecharts echarts-countries-pypkg echarts-china-provinces-pypkg echarts-china-cities-pypkg echarts-china-counties-pypkg echarts-china-misc-pypkg requests è®°å¾—å®‰è£… Chrome æµè§ˆå™¨ã€‚ é¡µé¢å…³é”®å…ƒç´ å®šä½æ ¹æ®ä¸Šè¿°æŠ“å–æ€è·¯ï¼Œéœ€è¦åšçš„æ˜¯å®šä½ä¸€äº›å…³é”®å…ƒç´ ï¼Œå¹¶ä¸”èƒ½å¤Ÿä» HTML ä¸­æŠ½å–å‡ºéœ€è¦çš„ä¿¡æ¯ã€‚é¡µé¢å…ƒç´ å®šä½ï¼Œéœ€è¦äº†è§£ä¸‹ XPath è¯­æ³•ï¼Œæ‘˜å–æƒ³è¦çš„å…ƒç´ ã€‚ å°æŠ€å·§ï¼Œå¯ä»¥åœ¨ Chrome æ§åˆ¶å°é€šè¿‡ $x(&#39;xpath-expression&#39;) éªŒè¯é€‰æ‹©å™¨æ˜¯å¦æ­£å¸¸ï¼š çœä»½é€‰æ‹©ä¸‹æ‹‰æ¡†å…ƒç´  id ä¸º provinceSelectï¼š å®šä½çœä»½ä½ç½®ï¼ˆæ‹·è´å…¶ XPATHï¼‰ å°ç»“å…¶å®ƒå…³é”®å…ƒç´ ç¡®å®šæ–¹å¼ç±»ä¼¼ï¼Œä¸»è¦ä»¥ XPath çš„æ–¹å¼æŸ¥æ‰¾ã€‚å¾—åˆ°æœ€ç»ˆéœ€è¦çš„ XPath è¡¨è¾¾å¼å¦‚ä¸‹ï¼š 1234567891011121314151617class XPathExpression: # çœä»½ä¸‹æ‹‰æ¡† Tab PROVINCE_TAB = '//*[@id="provinces"]/div/ul/li[2]' # å…·ä½“æŸä¸ªçœä»½ PROVINCE_ITEM = '//*[contains(@class, "place province") and contains(text(), "&#123;&#125;")]' # å…·ä½“æŸä¸ªåŸå¸‚ CITY_ITEM = '//*[contains(@class, "place city") and contains(text(), "&#123;&#125;")]' # å…·ä½“æŸä¸ªåŒºå¿ COUNTY_ITEM = '//*[contains(@class, "place county") and contains(text(), "&#123;&#125;")]' # å³ä¾§æŸ¥è¯¢æŒ‰é’® QUERY_BUTTON = '//*[contains(@class, "btn-query")]' # å¿«é€’å…¬å¸é€‰æ‹© PROVIDER_ITEM = '//ul[@id="companyCount"]/li/*[contains(text(), "&#123;&#125;")]' # ä¸‹ä¸€é¡µ NEXT_PAGE_BUTTON = '//*[contains(@class, "page-down-active")]' # é¡µé¢ä¸­çš„å¿«é€’å…¬å¸ä¿¡æ¯æ¡ç›® QUERY_ITEMS = '//*[@id="queryResult"]/dl' å†™ä»£ç main å‡½æ•°æ˜¯å…³é”®å…¥å£ï¼Œå®ƒä¼šè°ƒç”¨çˆ¬è™«ç±»æœç´¢æŒ‡å®šä½ç½®æŒ‡å®šå…¬å¸çš„å¿«é€’ç½‘ç‚¹ä¿¡æ¯ï¼Œå¹¶å°†è¿”å›çš„æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„è·¯å¾„ä¸‹ï¼Œä½¿ç”¨ json line æ ¼å¼ï¼ˆå³æ¯ä¸€è¡Œéƒ½æ˜¯ json æ ¼å¼å­—ç¬¦ä¸²ï¼‰å­˜å‚¨ã€‚ 123456789101112131415def main(province, city, provider='å…¨éƒ¨'): spider = DeliveryNetworkSpider( driver_path=os.path.join(PROJECT_DIR, 'dep/mac/chromedriver')) try: results = spider.search(province=province, city=city, provider=provider) except Exception as err: print(err) else: for result in results: print(result) store_result(os.path.join(PROJECT_DIR, 'results', f'&#123;province&#125;-&#123;city&#125;-&#123;provider&#125;.jl'), result) finally: spider.close() æ ¸å¿ƒçˆ¬è™«ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151class DeliveryNetworkSpider(object): """åŸºäºå¿«é€’ 100 çš„å¿«é€’ç½‘ç‚¹æŸ¥è¯¢çˆ¬è™« """ def __init__(self, driver_path): """ åˆå§‹åŒ–å¿«é€’ç½‘ç‚¹çˆ¬è™«ï¼Œå…³é”®å‚æ•°æ˜¯è¦æŒ‡å®š webdriver è·¯å¾„ï¼Œå¦åˆ™ æ— æ³•æ§åˆ¶æµè§ˆå™¨è¿›è¡Œæ¨¡æ‹ŸæŸ¥è¯¢ã€‚å½“å‰ä»…æ”¯æŒ Chrome æµè§ˆå™¨ã€‚ :param driver_path: é»˜è®¤æ˜¯ Mac ç‰ˆæœ¬æ‰€åœ¨çš„è·¯å¾„ï¼Œå¦‚æœæ˜¯ win ç‰ˆæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹è·¯å¾„ã€‚ """ # Windows ä¸‹éœ€è¦æ›¿æ¢æˆå¯¹åº”çš„ chromedriverï¼Œå¯ä»¥åœ¨ dep ç›®å½•ä¸‹æ–°å»º win # ç›®å½•ï¼Œå°† windows ç‰ˆæœ¬çš„æ”¾åˆ°ç›®å½•ä¸‹ï¼Œå¹¶ä¿®æ”¹ mac-&gt;win self._driver = webdriver.Chrome(executable_path=driver_path) self._driver.implicitly_wait(10) # éšå¼ç­‰å¾…å…ƒç´ å‡ºç° def close(self): try: self._driver.close() except: pass def search(self, province, city, county='æš‚ä¸é€‰æ‹©', provider='å…¨éƒ¨'): """æ‰§è¡Œç½‘ç‚¹æŸ¥è¯¢çš„æ ¸å¿ƒæ–¹æ³•ã€‚ :param province: çœä»½ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰ :param city: åŸå¸‚ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰ :param county: åŒºå¿ï¼Œé»˜è®¤ä¸ºå…¨éƒ¨åŒºå¿ :param provider: å¿«é€’æœåŠ¡å•†åå­—ï¼Œä¸ä¼ åˆ™æŸ¥è¯¢æ‰€æœ‰å¿«é€’å…¬å¸ """ self._open_home_page() self._select_location(province, city, county) self._select_provider(provider) while True: yield from self._parse_page(province, city) if self._has_next_page(): time.sleep(.5) # é˜²æ­¢ç¿»é¡µå¤ªå¿«è¢«æŠ“åˆ° self._visit_next_page() else: break def _open_home_page(self): self._driver.get('https://www.kuaidi100.com/network/') def _select_location(self, province, city, county): # æ‰¾åˆ°è¾“å…¥ä¸‹æ‹‰æ¡†ä½ç½® elem = self._driver.find_element_by_id('provinceSelect') self.__highlight(elem) elem.click() # å®šä½é€‰æ‹©çœä»½ Tab elem = self._driver.find_element_by_xpath(XPathExpression.PROVINCE_TAB) self.__highlight(elem) elem.click() # æ¥ä¸‹æ¥é€‰æ‹©çœä»½ elem = self._driver.find_element_by_xpath( XPathExpression.PROVINCE_ITEM.format(province)) self.__highlight(elem) elem.click() # ç´§æ¥ç€é€‰æ‹©åŸå¸‚ elem = self._driver.find_element_by_xpath( XPathExpression.CITY_ITEM.format(city)) self.__highlight(elem) elem.click() # é€‰æ‹©æ‰€æœ‰åŒºåŸŸ elem = self._driver.find_element_by_xpath( XPathExpression.COUNTY_ITEM.format(county)) self.__highlight(elem) elem.click() # å®šä½åˆ°æŸ¥è¯¢æŒ‰é’®ï¼Œå¹¶ç‚¹å‡»æŸ¥è¯¢è·³è½¬é¡µé¢ elem = self._driver.find_element_by_xpath(XPathExpression.QUERY_BUTTON) self.__highlight(elem) elem.click() def _select_provider(self, provider): elem = self._driver.find_element_by_xpath( XPathExpression.PROVIDER_ITEM.format(provider)) self.__highlight(elem) elem.click() def _has_next_page(self): try: self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON) except NoSuchElementException: return False else: return True def _visit_next_page(self): elem = self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON) self.__highlight(elem) elem.click() def __highlight(self, elem): """é«˜äº®æ“ä½œçš„å…ƒç´ """ self._driver.execute_script( "arguments[0].setAttribute('style',arguments[1]);", elem, "outline:2px solid red;") time.sleep(.2) def _parse_page(self, province, city): try: elements = self._driver.find_elements_by_xpath(XPathExpression.QUERY_ITEMS) except NoSuchElementException: return [] else: for el in elements: yield self._extract(el.text, province, city) @staticmethod def _extract(text, province, city): item = dict( province=province, city=city, name='', # åç§° address='', # åœ°å€ contact_phone='', # è”ç³»ç”µè¯ pickup_phone='', # å–ä»¶ç”µè¯ check_phone='', # æŸ¥ä»¶ç”µè¯ complaint_phone='', # æŠ•è¯‰ç”µè¯ location=dict( lng=0.0, # ç»åº¦ lat=0.0, # çº¬åº¦ ) ) if not text: return item # æå–å‡ºçº¯æ–‡æœ¬åæ¢è¡Œè§£æ lines = [l.strip() for l in text.splitlines() if l.strip()] def __(k): r = [l for l in lines if l.startswith(k)] return r[0].replace(k, '') if r else '' item['name'] = lines[0] item['address'] = __('å…¬å¸åœ°å€ï¼š') item['contact_phone'] = __('è”ç³»ç”µè¯ï¼š') item['pickup_phone'] = __('å–ä»¶ç”µè¯ï¼š') item['check_phone'] = __('æŸ¥ä»¶ç”µè¯ï¼š') item['complaint_phone'] = __('æŠ•è¯‰ç”µè¯ï¼š') item['location'] = get_location( item['address'], city=u"&#123;&#125;&#123;&#125;".format(province, city)) return item åæ ‡æŸ¥è¯¢123456789101112131415161718192021222324BASE_API = 'http://api.map.baidu.com'LOCATION_API = '/geocoding/v3/?address=&#123;&#125;&amp;city=&#123;&#125;&amp;output=json&amp;ak=&#123;&#125;'# åŠ ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢@filecache(YEAR)def get_location(addr, city=''): """ æ–‡æ¡£å‚è€ƒï¼šhttp://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding """ if not addr: return dict(lng=0.0, lat=0.0) url = _get_query_url(LOCATION_API.format(addr, city, AK)) r = requests.get(url) result = r.json() assert result['status'] == 0, u"è·å–ç»çº¬åº¦ä¿¡æ¯å¤±è´¥ï¼è¯·æ±‚ï¼š&#123;&#125;ï¼Œè¿”å›ç»“æœï¼š&#123;&#125;".format(url, result) return result['result']['location']def _get_query_url(query_str): query_str = query_str.replace('#', '') # å»é™¤ç‰¹æ®Šå­—ç¬¦ # å¯¹ query_str è¿›è¡Œè½¬ç ï¼Œsafe å†…çš„ä¿ç•™å­—ç¬¦ä¸è½¬æ¢ qs = quote(query_str, safe="/:=&amp;?#+!$,;'@()*[]") sn = hashlib.md5(quote_plus(qs + SK).encode('utf8')).hexdigest() return BASE_API + query_str + f'&amp;sn=&#123;sn&#125;' æ§åˆ¶æŠ“å–æ•°æ®æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯æŠ“å–ä¸­é€šå¿«é€’åœ¨åŒ—äº¬å„ä¸ªåœ°åŒºçš„ç½‘ç‚¹ã€‚å¯åŠ¨åï¼Œä¼šé€šè¿‡ Selenuium æ§åˆ¶ Chrome æµè§ˆå™¨è®¿é—®æŸ¥è¯¢ç½‘ç«™ï¼Œå¹¶ç‚¹å‡»å¯¹åº”çš„å…ƒç´ ï¼Œå®Œæˆæ•°æ®çš„æŠ“å–ã€‚ 1main(province='åŒ—äº¬', city='åŒ—äº¬', provider='ä¸­é€š') æ•´ä¸ªå·¥ä½œè¿‡ç¨‹æ¼”ç¤ºå‚è§ ç™¾åº¦ç½‘ç›˜ï¼ˆæå–ç : kaunï¼‰ã€‚æŠ“å–åˆ°çš„æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾è¿™é‡Œå°±éœ€è¦ä½¿ç”¨å…³é”®çš„ pyecharts äº†ï¼Œå…·ä½“æ€ä¹ˆå®‰è£…å’Œé…ç½®å°±ä¸å¤šè¯´äº†ï¼Œå®ƒæœ‰éå¸¸å®Œå–„çš„ä¸­æ–‡æ–‡æ¡£ï¼Œä»¥åŠä¸€äº› Demo å¯ä»¥å­¦ä¹ ã€‚ä»¥ä¸‹å°±æ˜¯åˆ©ç”¨ä¸Šè¿°æŠ“åˆ°çš„æ•°æ®ï¼Œåšä¸ªç®€å•çš„æ¼”ç¤ºï¼Œçœ‹çœ‹è¿™äº›å¿«é€’ç½‘ç‚¹çš„å…·ä½“åˆ†å¸ƒçƒ­ç‚¹æ˜¯æ€ä¹ˆæ ·çš„ã€‚ æˆ‘ä»¬éœ€è¦åˆ‡æ¢åˆ°çˆ¬è™«ç›®å½•ä¸‹ï¼Œå¹¶å¯åŠ¨ Jupter Notebookï¼š 12cd path/to/kuaidi100/srcjupter notebook # å¯åŠ¨æœåŠ¡ ç´§æ¥ç€ï¼Œé€‰æ‹© src/heatmap.ipynb æ–‡ä»¶æ‰“å¼€ï¼š èœå•æ  Cell-&gt;Run All æ‰§è¡Œæ‰€æœ‰ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç®€å•çš„çƒ­ç‚¹åœ°å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š æ€»ç»“è‡³æ­¤ï¼Œæ•´ä¸ªæŠ˜è…¾çš„è¿‡ç¨‹å°±å®Œç»“å’¯ã€‚ä¸»è¦æ—¶é—´èŠ±è´¹åœ¨ç¡®å®šçˆ¬é‡çš„æ–¹æ¡ˆï¼Œä»¥åŠä½¿ç”¨çµæ´»çš„æ–¹å¼å®šä½å…ƒç´ ä¸Šã€‚åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œä¹Ÿé‡åˆ°ä¸€äº›å°é—®é¢˜ï¼Œå¹¶åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼š æ¯”å¦‚æŸäº›æƒ…å†µä¸‹å…ƒç´  click ä¼šå¤±è´¥ï¼Œè¿™æ—¶ä¸ºäº†ä¿è¯çˆ¬è™«çš„å¥å£®æ€§ï¼Œéœ€è¦åšå¼‚å¸¸æ•è·ï¼›é¡µé¢åŠ è½½æœªå®Œæˆæ—¶ï¼Œå¯èƒ½æ— æ³•æŸ¥æ‰¾åˆ°æŒ‡å®šå…ƒç´ ï¼Œå¯¼è‡´çˆ¬è™«ç¨‹åºæŒ‚äº†ï¼Œè¿™é‡Œå°±éœ€è¦é…ç½® Selenium éšå¼ç­‰å¾… 10sã€‚ ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿ Selenium æ­£åœ¨æ“çºµçš„å…ƒç´ ï¼Œè¿™é‡Œå€ŸåŠ©äº† driver.execute_script() çš„æ–¹å¼ç»™é€‰ä¸­çš„å…ƒç´ æ·»åŠ çº¢è‰²è¾¹æ¡†ã€‚ å¦å¤–ï¼Œè€ƒè™‘åˆ°çˆ¬å–é¢‘ç‡è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´è§¦å‘åçˆ¬ç­–ç•¥ï¼Œè¿™é‡Œç®€å•åšäº†å»¶è¿Ÿç­‰å¾…ï¼ˆtime.sleep()ï¼‰ã€‚ æ•´ä½“è€Œè¨€ï¼Œå†™å¾—æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±ç®€å•è®°å½•ä¸‹ã€‚å®Œæ•´çš„ä»£ç ä»“åº“å‚è§ï¼škuaidi100-spiderã€‚ å‚è€ƒ pyecharts åœ°ç†å›¾æ ‡æ–‡æ¡£ pyecharts åœ¨åœ°å›¾ä¸Šæ ¹æ®ç»çº¬åº¦å’Œé‡å€¼ï¼Œç”»å‡ºæ•£ç‚¹å›¾/çƒ­åŠ›å›¾ ç™¾åº¦åœ°å›¾æ–‡æ¡£ XPath è¯­æ³•]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>çˆ¬è™«</tag>
        <tag>Python</tag>
        <tag>æ•°æ®å¯è§†åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç†è§£æ–‡ä»¶æè¿°ç¬¦ä¸æ–‡ä»¶å¥æŸ„]]></title>
    <url>%2F2019%2F12%2F19%2Funderstand-file-descriptor-and-file-description%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨ã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹5.4 èŠ‚ï¼Œå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€çš„æ–‡ä»¶å…³ç³»æ˜¯è¿™æ ·æè¿°çš„ï¼šã€Œå†…æ ¸ä¸ºæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ç»´æŠ¤äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„æè¿°è¡¨ï¼ˆopen file description tableï¼‰ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸ºæ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰ï¼Œå¹¶å°†è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ç§°ä¸ºæ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰ã€‚è€Œé’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸åˆä¸ºå…¶ç»´æŠ¤äº†æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰ã€ã€‚ åæ¥åœ¨è¿™ç¯‡æ–‡ç«  Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“ ä¸­ï¼Œçœ‹åˆ°äº†è¿™æ ·çš„çš„æè¿°ï¼šã€Œç®€å•æ¥è¯´ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)ã€‚è¡¨ä¸­çš„æ¯ä¸€é¡¹æ˜¯struct fileç±»å‹ï¼ŒåŒ…å«äº†æ‰“å¼€æ–‡ä»¶çš„ä¸€äº›å±æ€§æ¯”å¦‚åç§»é‡ï¼Œè¯»å†™è®¿é—®æ¨¡å¼ç­‰ï¼Œè¿™æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ–‡ä»¶å¥æŸ„ã€ã€‚ é‚£ä¹ˆè¿™é‡Œæåˆ°çš„ã€Œæ‰“å¼€çš„æ–‡ä»¶è¡¨ã€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œæ€ä¹ˆåˆå˜æˆäº†æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰çš„å‘¢ï¼Ÿã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸­ä¸æ˜¯è¯´ã€Œæ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰ã€æ˜¯ç‹¬ç«‹äºè¿›ç¨‹çš„ç³»ç»Ÿçº§è¡¨å—ï¼Ÿæ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å›°æƒ‘å’ŒçŸ›ç›¾å‘¢ï¼Ÿ ä¸ºäº†èƒ½å¤Ÿè§£ç­”å›°æƒ‘ï¼ŒåŠ æ·±å¯¹æ–‡ä»¶æè¿°ç¬¦çš„ç†è§£ï¼Œç‰¹åœ°æ·±æ‰’äº†ä¸‹ Linux å†…æ ¸çš„ç›¸å…³æºç ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ä¸Šæ–‡æåˆ°çš„æè¿°è¡¨ï¼ˆopen file description tableï¼‰ã€æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰ã€æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰è¿™ä¸‰ç§æŠ½è±¡çš„æ•°æ®ç»“æ„å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä»¥ä¾¿èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ä¹¦ä¸­çš„æ¦‚å¿µã€‚ æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»åœ¨åŒºåˆ†è¿™äº›æ¦‚å¿µå‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ open() ç³»ç»Ÿè°ƒç”¨çš„ man page ä¸­æåˆ°çš„ä¸€æ®µè¯´æ˜ï¼š A call to open() creates a new open file description, an entry in thesystem-wide table of open files. The open file description recordsthe file offset and the file status flags (see below). A filedescriptor is a reference to an open file description; this referenceis unaffected if pathname is subsequently removed or modified torefer to a different fileâ€¦ åœ¨çœ‹å®Œä¸Šé¢çš„ä»‹ç»åï¼Œç»“åˆã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹æåˆ°çš„åè¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½œå‡ºè¿™æ ·çš„æ˜ å°„ï¼š open file description: æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰ï¼Œå®ƒæ‰ä¼šå…³è”åˆ°çœŸæ­£åœ°æ–‡ä»¶ inode table of open files: å°±æ˜¯ä¹¦ä¸­æåˆ°çš„ç³»ç»Ÿçº§æè¿°è¡¨ï¼ˆopen file tableï¼‰ file descriptor: å…¶å®å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹æ–‡ä»¶å¥æŸ„çš„å¼•ç”¨ å¥½å•¦ï¼Œä¸‹é¢æ¥çœ‹çœ‹ä¸æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„å®ç°ç»†èŠ‚ï¼Œå¹¶äº†è§£å‡ ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨ å®ç°ã€‚ å®ç°ç»†èŠ‚ä»¥ä¸‹ä»£ç æ‘˜è‡ª Linux Kernel 5.4ï¼Œè€ƒè™‘åˆ°å†…æ ¸ä»£ç éå¸¸å¤æ‚ï¼Œå¤„ç†ç»†èŠ‚ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æŠŠæ¯ä¸ªå‡½æ•°æˆ–æ•°æ®ç»“æ„æ‰€æœ‰ä»£ç éƒ½è´´å‡ºæ¥ï¼Œåªä¿ç•™äº†ä¸€äº›å’Œæœ¬æ–‡ç„¦ç‚¹æœ‰å…³çš„ä»£ç è¡Œã€‚ Linux å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„æ¯ä¸ªè¿›ç¨‹éƒ½å…³è”æŒ‡å‘äº†ä¸€ä¸ª files_structï¼Œå³æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯ï¼š 12345678struct task_struct &#123; // ... /* Filesystem information*/ struct fs_struct *fs /* Open file information*/ struct files_struct *files; // ...&#125; é‚£ä¹ˆï¼Œæ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿ 123456789101112131415161718192021struct files_struct &#123; /* * read mostly part */ // å¼•ç”¨è®¡æ•°ï¼Œå¯ä»¥å’Œå…¶å®ƒ task å…±äº« atomic_t count; bool resize_in_progress; wait_queue_head_t resize_wait; // fdtable æ˜¯æ¯ä¸ªè¿›ç¨‹ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ struct fdtable __rcu *fdt; struct fdtable fdtab; /* * written part on a separate cache line in SMP */ spinlock_t file_lock ____cacheline_aligned_in_smp; unsigned int next_fd; unsigned long close_on_exec_init[1]; unsigned long open_fds_init[1]; unsigned long full_fds_bits_init[1]; struct file __rcu * fd_array[NR_OPEN_DEFAULT];&#125;; è€Œå…³äº fdtable ï¼ˆè¿™ä¸ªå¯ä»¥ç†è§£ä¸ºè¿›ç¨‹ç‹¬ç«‹çš„æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰ï¼‰çš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011struct fdtable &#123; unsigned int max_fds; // è¿™é‡Œ fd æ•°ç»„ï¼Œç»´æŠ¤äº†è¿›ç¨‹å…³è”çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶æ–‡ä»¶å¥æŸ„çš„æŒ‡é’ˆ // æ–‡ä»¶å¥æŸ„å¯ä»¥å…±äº«ï¼ˆæ¯”å¦‚ï¼Œdup ç³»ç»Ÿè°ƒç”¨ï¼‰ // ä½†æ˜¯åœ¨ä½¿ç”¨ open ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼šåˆ›å»ºæ–°çš„ fileï¼Œå³æ–‡ä»¶å¥æŸ„ struct file __rcu **fd; /* current fd array */ unsigned long *close_on_exec; unsigned long *open_fds; unsigned long *full_fds_bits; struct rcu_head rcu;&#125;; å†æ¥çœ‹çœ‹æ–‡ä»¶å¥æŸ„ï¼ˆå³ open file descriptionï¼‰æ˜¯ä»€ä¹ˆï¼Ÿå®ƒç»´æŠ¤äº†å’Œæ‰“å¼€æ–‡ä»¶æœ‰å…³çš„é‡è¦ä¿¡æ¯ï¼š 123456789101112131415161718192021222324252627struct file &#123; // ... // æ–‡ä»¶è·¯å¾„ struct path f_path; // æŒ‡å‘çœŸæ­£çš„æ–‡ä»¶ï¼Œinode æŒ‡é’ˆ struct inode *f_inode; /* cached value */ // æ–‡ä»¶ç›¸å…³çš„æ“ä½œ const struct file_operations *f_op; /* * Protects f_ep_links, f_flags. * Must not be taken from IRQ context. */ spinlock_t f_lock; enum rw_hint f_write_hint; // å¼•ç”¨è®¡æ•°ï¼Œåªæœ‰ count ä¸º 0 æ—¶ï¼Œæ‰ä¼šè¢«çœŸæ­£åœ°å›æ”¶ atomic_long_t f_count; unsigned int f_flags; fmode_t f_mode; struct mutex f_pos_lock; // æ–‡ä»¶åç§» loff_t f_pos; struct fown_struct f_owner; const struct cred *f_cred; struct file_ra_state f_ra; u64 f_version; // ...&#125; ç”»äº†ä¸€ä¸ªå›¾ï¼Œæ–¹ä¾¿äº†è§£ä¸Šè¿°æ•°æ®ç»“æ„å…³ç³»ï¼š ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°openopen() ç³»ç»Ÿè°ƒç”¨ä¼šåˆ†é…æ–°çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ï¼Œç”¨æ¥ç»´æŠ¤ä¸æ‰“å¼€æ–‡ä»¶ç›¸å…³çš„å…ƒä¿¡æ¯ï¼ˆå¦‚åç§»é‡ã€è·¯å¾„ã€æ“ä½œæ–¹æ³•ç­‰ï¼‰ï¼Œå¹¶ä¼šç»™è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå…¶å®å°±æ˜¯ä¸ªå°æ•´æ•°ï¼‰ã€‚å®ƒå¯¹åº”çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263// fs/open.clong do_sys_open(int dfd, const char __user *filename, int flags, umode_t mode)&#123; struct open_flags op; // ä¸è¦è¢«åå­— fd è¿·æƒ‘äº†ï¼Œå…¶å®è¿™é‡Œè¿”å›çš„æ˜¯é”™è¯¯ä¿¡æ¯ï¼ˆé 0 è¡¨ç¤ºå‡ºé”™äº†ï¼ï¼‰ int fd = build_open_flags(flags, mode, &amp;op); struct filename *tmp; if (fd) return fd; tmp = getname(filename); if (IS_ERR(tmp)) return PTR_ERR(tmp); // åˆ†é…æ–‡ä»¶æè¿°ç¬¦ fd = get_unused_fd_flags(flags); if (fd &gt;= 0) &#123; // åˆ†é…æ–‡ä»¶å¥æŸ„ struct file *f = do_filp_open(dfd, tmp, &amp;op); if (IS_ERR(f)) &#123; put_unused_fd(fd); fd = PTR_ERR(f); &#125; else &#123; fsnotify_open(f); // æ³¨å†Œåˆ°è¿›ç¨‹çš„ fdtable ä¸­ fd_install(fd, f); &#125; &#125; putname(tmp); return fd;&#125;// fs/namei.cstruct file *do_filp_open(int dfd, struct filename *pathname, const struct open_flags *op)&#123; // ... struct file *filp; filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU); // ... return filp;&#125;static struct file *path_openat(struct nameidata *nd, const struct open_flags *op, unsigned flags)&#123; struct file *file; file = alloc_empty_file(op-&gt;open_flag, current_cred()); // ... return file&#125;void fd_install(unsigned int fd, struct file *file)&#123; __fd_install(current-&gt;files, fd, file);&#125;void __fd_install(struct files_struct *files, unsigned int fd, struct file *file)&#123; struct fdtable *fdt; // ... rcu_assign_pointer(fdt-&gt;fd[fd], file);&#125; dupdup() ç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šæ˜¯ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯åº•å±‚è¿˜æ˜¯ä¼šæŒ‡å‘ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦å…³è”çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233// fs/file.cSYSCALL_DEFINE1(dup, unsigned int, fildes)&#123; int ret = -EBADF; // åŸºäºä¼ å…¥çš„æ–‡ä»¶æè¿°ï¼ŒæŸ¥æ‰¾åˆ°å…³è”çš„æ–‡ä»¶å¥æŸ„ // éšè—äº†ä¸€äº›é”™è¯¯åˆ¤æ–­é€»è¾‘ // fget_raw ä¼šè°ƒç”¨ __fget å‡½æ•° struct file *file = fget_raw(fildes); ret = get_unused_fd_flags(0); fd_install(ret, file); return ret;&#125;// fs/file.cstatic struct file *__fget(unsigned int fd, fmode_t mask, unsigned int refs)&#123; // å¾—åˆ°å½“å‰è¿›ç¨‹å…³è”çš„æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆOpen file info tableï¼‰ struct files_struct *files = current-&gt;files; struct file *file; // æŸ¥æ‰¾ fd -&gt; æ–‡ä»¶å¥æŸ„ file = fcheck_files(files, fd); if (file) &#123; /* File object ref couldn't be taken. * dup2() atomicity guarantee is the reason * we loop to catch the new file (or NULL pointer) */ if (file-&gt;f_mode &amp; mask) file = NULL; else if (!get_file_rcu_many(file, refs)) goto loop; &#125; return file;&#125; closeclose() ç³»ç»Ÿè°ƒä¼šå›æ”¶æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒæ—¶ä¼šç»™æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰çš„å¼•ç”¨è®¡æ•°å‡ 1ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œå›æ”¶ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š å…¶å¯¹åº”çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162SYSCALL_DEFINE1(close, unsigned int, fd)&#123; int retval = __close_fd(current-&gt;files, fd); // ...&#125;// fs/file.c// __close_fd å…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶ä¸­ `files` æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹å…³è”çš„// æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è¡¨ã€‚int __close_fd(struct files_struct *files, unsigned fd)&#123; struct file *file; struct fdtable *fdt; spin_lock(&amp;files-&gt;file_lock); fdt = files_fdtable(files); // åˆ¤æ–­ä¼ å…¥çš„ file descriptor æœ‰æ•ˆæ€§ if (fd &gt;= fdt-&gt;max_fds) goto out_unlock; // æŸ¥æ‰¾åˆ°å…³è”çš„ file descriptionï¼Œå³æ–‡ä»¶å¥æŸ„ file = fdt-&gt;fd[fd]; // å›æ”¶ file descriptor rcu_assign_pointer(fdt-&gt;fd[fd], NULL); __put_unused_fd(files, fd); spin_unlock(&amp;files-&gt;file_lock); // å…³é—­ file description return filp_close(file, files);out_unlock: spin_unlock(&amp;files-&gt;file_lock); return -EBADF;&#125;// filp_close å…³é—­æŒ‡å‘çš„ file descriptionï¼Œå…¶ä¸­ id ä¸º// POSIX çº¿ç¨‹ IDã€‚int filp_close(struct file *filp, fl_owner_t id)&#123; int retval = 0; // å¦‚æœæ–‡ä»¶å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œè¯´æ˜å­˜åœ¨é”™è¯¯ï¼Œæ— æ³•å…³é—­ if (!file_count(filp)) &#123; printk(KERN_ERR "VFS: Close: file count is 0\n"); return 0; &#125; if (filp-&gt;f_op-&gt;flush) retval = filp-&gt;f_op-&gt;flush(filp, id); // å¯èƒ½ä¼šå›æ”¶ file descriptionï¼Œä½†æ˜¯ä¼šè€ƒè™‘å…¶å¼•ç”¨è®¡æ•° fput(filp); return retval;&#125;// ä»¥ä¸‹å®šä¹‰åœ¨ï¼šfs/file_table.cvoid fput(struct file *file)&#123; // ç»™ file description çš„å¼•ç”¨è®¡æ•°å‡ 1 fput_many(file, 1);&#125;void fput_many(struct file *file, unsigned int refs)&#123; // åŸå­æ“ä½œï¼š&amp;file-&gt;f_count -= refs if (atomic_long_sub_and_test(refs, &amp;file-&gt;f_count)) &#123; // ... &#125;&#125; æ€»ç»“æœ¬æ–‡ä»‹ç»äº†ä¸‹æ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€æ–‡ä»¶çš„å…³ç³»ï¼Œå¹¶ç®€è¦è®²è§£äº† Linux å†…æ ¸ä¸­å…³äºè¿™äº›æŠ½è±¡æ¦‚å¿µçš„å…·ä½“å®ç°ã€‚åŒæ—¶ï¼Œè¿˜ç®€å•ä»‹ç»äº†ä¸‹ open(), dup() å’Œ close() ç³»ç»Ÿè°ƒç”¨çš„å®ç°ã€‚ç›¸ä¿¡åœ¨çœ‹å®Œè¿™äº›åï¼Œèƒ½å¤Ÿæ›´åŠ æ·±å…¥å’Œæ¸…æ™°åœ°ç†è§£è¿™ä¸‰ä¸ªæ¦‚å¿µï¼šç³»ç»Ÿçº§æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰/æè¿°è¡¨ï¼ˆopen file description tableï¼‰ã€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰/æ–‡ä»¶æè¿°ï¼ˆfile descriptionï¼‰ä»¥åŠæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ã€‚ æœ€åï¼Œå›ç­”ä¸‹æœ¬æ–‡å¼€å¤´æåˆ°çš„é—®é¢˜ã€‚å…¶å®ï¼Œç«™åœ¨è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œä½œè€…åœ¨ Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“ ä¸­æåˆ°ã€Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)ã€è¿™æ ·çš„è¯´æ³•å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚åªæ˜¯æ­¤å¤„æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)å’Œã€ŠLinux ç³»ç»Ÿç¼–ç¨‹ã€‹ä¸­æåˆ°çš„ç³»ç»Ÿçº§æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰å¹¶éä¸€ä¸ªæ¦‚å¿µã€‚ä½œè€…æåˆ°çš„æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)å…¶å®æ­£æ˜¯æŠ½è±¡çš„è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰è¡¨ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æ²¡å¿…è¦ä¸ºæ­¤çº ç»“ï¼Œå’¬æ–‡åš¼å­—ä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä¸è¿‡å¯¹äºå›°æƒ‘çš„ä¸œè¥¿è¿˜æ˜¯èƒ½å¤Ÿææ¸…æ¥šæ‰å¥½ã€‚ å‚è€ƒ Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“ Linux å†…æ ¸æ–‡ä»¶æè¿°ç¬¦è¡¨çš„æ¼”å˜ man open(2) Linux IOæ ¸å¿ƒæ•°æ®ç»“æ„ä¹‹ä¸€]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>æ–‡ä»¶æè¿°ç¬¦</tag>
        <tag>æ–‡ä»¶å¥æŸ„</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go è¯­è¨€å®ç° Redis å­—å…¸]]></title>
    <url>%2F2019%2F12%2F17%2Fimplement-redis-dict-in-go%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”®å€¼æ•°æ®åº“ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹åœ¨ Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„ ä¸­æåˆ°çš„ Redis å­—å…¸å®ç°çš„ä¸€äº›ç‰¹ç‚¹ï¼š æ”¯æŒæµ·é‡ &lt;key, value&gt; å­˜å‚¨ï¼› ä½¿ç”¨æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œé¿å…å› ä¸ºéœ€è¦è¿ç§»çš„ buckets å¤ªå¤šå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼ˆRedis æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼‰ï¼› é»˜è®¤ä½¿ç”¨ SipHash ç®—æ³•è®¡ç®—é”®çš„ hash å€¼ï¼› å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œé‡‡ç”¨äº†å¸¸è§çš„é“¾åœ°å€æ³•ï¼Œä¸”æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼› å­—å…¸å†…éƒ¨ç»´æŠ¤äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¼šåœ¨æ‰©å®¹æœŸé—´ï¼ˆRehashï¼‰ä½¿ç”¨ï¼› æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ã€‚ åœ¨çœ‹äº† Redis å­—å…¸æºç ï¼Œææ‡‚å®ƒçš„å·¥ä½œåŸç†åï¼Œæœ‰æ²¡æœ‰æƒ³è¦è‡ªå·±å®ç°ä¸‹å‘¢ï¼Ÿæ‰€ä»¥ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å±±å¯¨ä¸€ä¸ª Redis å­—å…¸å®ç°ï¼Œè™½ç„¶ã€Œå®¹è²Œã€æœ‰å¼‚ï¼Œä½†ã€Œå†…æ ¸ã€è¿˜æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨å®ç°çš„æ—¶å€™å…ˆä¸è€ƒè™‘ goroutine å®‰å…¨é—®é¢˜ï¼Œç„¦ç‚¹æ”¾åœ¨ Redis å­—å…¸å®ç°çš„æ ¸å¿ƒæ€æƒ³ä¸Šã€‚æ‰€ä»¥åé¢çš„å®ç°ï¼Œéƒ½å‡è®¾åªæœ‰ä¸€ä¸ª goroutine åœ¨å¯¹å­—å…¸è¿›è¡Œæ“ä½œã€‚ç”±äº Go è¯­è¨€è‡ªå¸¦ GCï¼Œæ‰€ä»¥ä½¿ç”¨å®ƒæ¥å®ç°å°±ä¸ç”¨çƒ¦å¿ƒå†…å­˜ç®¡ç†çš„é—®é¢˜äº†ï¼ˆåœ¨ Redis dict.c å®ç°ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šä»£ç æ˜¯æ¶‰åŠå†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„ï¼‰ï¼Œè¿™æ ·å°±èƒ½è®©æˆ‘ä»¬æ›´åŠ å®¹æ˜“åœ°ç†è§£æ ¸å¿ƒçš„å®ç°ç­–ç•¥ã€‚ ä¸€ç‚¹è¯´æ˜æ­£æ‰€è°“ã€Œå…¥ä¹¡éšä¿—ã€å˜›ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°çš„å­—å…¸ä¸­ï¼Œå¹¶æ²¡æœ‰ç…§æ¬åŸå…ˆ Redis ä¸­å­—å…¸çš„æ¥å£ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç»„ç±»ä¼¼äºæ ‡å‡†åº“ sync.Map çš„æ¥å£ã€‚ å¦å¤–ï¼Œä»€ä¹ˆæ ·çš„ key å¯ä»¥ä½œä¸ºå­—å…¸çš„é”®å‘¢ï¼Ÿé¦–å…ˆï¼Œå¿…é¡»è¦æ˜¯æ–¹ä¾¿è®¡ç®—å“ˆå¸Œå€¼çš„ï¼›å…¶æ¬¡ï¼Œæ–¹ä¾¿è¿›è¡Œç›´æ¥æ¯”è¾ƒã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Redis çš„å­—å…¸å®ç°ä¸­æä¾›äº†ä¸€ç»„æ¥å£ï¼Œä¾›å®é™…ä½¿ç”¨å­—å…¸å­˜å‚¨çš„æ•°æ®ç±»å‹å®ç°ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„æ‰©å±•æ€§ã€‚ 12345678typedef struct dictType &#123; uint64_t (*hashFunction)(const void *key); void *(*keyDup)(void *privdata, const void *key); void *(*valDup)(void *privdata, const void *obj); int (*keyCompare)(void *privdata, const void *key1, const void *key2); void (*keyDestructor)(void *privdata, void *key); void (*valDestructor)(void *privdata, void *obj);&#125; dictType; ä¸è¿‡ä¸ºäº†ç®€å•èµ·è§ï¼Œåœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°æ—¶å­—å…¸æ—¶ï¼Œä¼ å…¥çš„ key å’Œ value å‡ä¸º interface{} ç±»å‹ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶çš„æ¥å£å®ç°è¦æ±‚ã€‚å¦å¤–ï¼Œé’ˆå¯¹ key å°†åªæ”¯æŒ string å’Œ int ç±»å‹åŠå…¶å˜ç§ã€‚è¿™ç§å¯ä»¥æ»¡è¶³åŸºæœ¬çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæ‹¥æœ‰å’Œ sync.Map ä¸€æ ·çš„æ¥å£ç­¾åã€‚ æœ€åï¼Œæ¥çœ‹ä¸‹å­—å…¸çš„æ¥å£è®¾è®¡ï¼š 123456789101112131415161718192021222324252627282930// Store å‘å­—å…¸ä¸­æ·»åŠ æ–°çš„ key-valuefunc (d *Dict) Store(key interface&#123;&#125;, value interface&#123;&#125;)// Load ä»å­—å…¸ä¸­è·å–æŒ‡å®š key å¯¹åº”çš„å€¼func (d *Dict) Load(key interface&#123;&#125;) (value interface&#123;&#125;, ok bool)// LoadOrStore ç”¨äºæ ¹æ®æŒ‡å®š key å…ˆæŸ¥æ‰¾å¯¹åº”å€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å¯¹åº”å€¼ï¼›// å¦åˆ™ï¼Œä¼šå°†ç»™å®š key-value å­˜å‚¨åˆ°å­—å…¸ä¸­ï¼Œå¹¶è¿”å›ä¼ å…¥çš„ valueã€‚func (d *Dict) LoadOrStore(key, value interface&#123;&#125;) (actual interface&#123;&#125;, loaded bool)// Delete åˆ é™¤æŒ‡å®šçš„ keyfunc (d *Dict) Delete(key interface&#123;&#125;)// Len è¿”å›å­—å…¸çš„å…ƒç´ ä¸ªæ•°func (d *Dict) Len() uint64// Cap è¿”å›å­—å…¸çš„å®¹é‡func (d *Dict) Cap() uint64// Range æ¨¡æ‹Ÿ Redis å­—å…¸æ™®é€šè¿­ä»£å™¨è¡Œä¸ºï¼Œä¸æ”¯æŒéå®‰å…¨çš„æ“ä½œfunc (d *Dict) Range(fn func(key, value interface&#123;&#125;) bool)// RangeSafely æ¨¡æ‹Ÿ Redis å­—å…¸å®‰å…¨è¿­ä»£å™¨è¡Œä¸ºï¼Œè¿­ä»£æœŸé—´ä¸åš rehash æ“ä½œfunc (d *Dict) RangeSafely(fn func(key, value interface&#123;&#125;) bool)// Resize ç”¨äºè°ƒæ•´å­—å…¸å®¹é‡ï¼ˆæ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯ rehash è¿˜æ˜¯æ¸è¿›å¼çš„ï¼‰func (d *Dict) Resize() error// RehashForAWhile æ‰§è¡Œä¸€æ®µæ—¶é—´çš„ rehashfunc (d *Dict) RehashForAWhile(duration time.Duration) å®ç°ç»†èŠ‚æ•°æ®ç»“æ„1234567891011121314151617type Dict struct &#123; hashTables []*hashTable rehashIdx int64 iterators uint64&#125;type hashTable struct &#123; buckets []*entry size uint64 sizemask uint64 used uint64&#125;type entry struct &#123; key, value interface&#123;&#125; next *entry&#125; å­—å…¸åˆå§‹åŒ–1234567891011// New å®ä¾‹åŒ–ä¸€ä¸ªå­—å…¸ã€‚func New() *Dict &#123; return &amp;Dict&#123; // åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‡†å¤‡ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œé»˜è®¤ä½¿ç”¨å“ˆå¸Œè¡¨ 1 // åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œä¼šå°†å“ˆå¸Œè¡¨ 1 ä¸­çš„æ‰€æœ‰å…ƒç´ è¿ç§»åˆ° // å“ˆå¸Œè¡¨ 2ã€‚ hashTables: []*hashTable&#123;&#123;&#125;, &#123;&#125;&#125;, rehashIdx: -1, iterators: 0, &#125;&#125; åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®ä¸‹é¢è¿™ä¸ªå‡½æ•°å°†åŸºäºæŒ‡å®šçš„ key è®¡ç®—å‡ºå¯¹åº”çš„ hash å€¼ï¼ˆä½¿ç”¨ SipHash ç®—æ³•ï¼ŒRedis å­—å…¸ä¸­é»˜è®¤ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡æŸ¥è¯¢å“ˆå¸Œè¡¨æ¥ç¡®å®šå¯¹åº”çš„ key æ˜¯å¦å­˜åœ¨äºå­—å…¸ä¸­ã€‚è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé‡è¦ï¼Œåœ¨åé¢çš„ Load å’Œ Store å‡½æ•°ä¸­éƒ½æœ‰åº”ç”¨ï¼Œä¸‹é¢æ¥çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°å§ï¼š 123456789101112131415161718192021// keyIndex åŸºäºæŒ‡å®šçš„ key è·å¾—å¯¹åº”çš„ bucket ç´¢å¼•// å¦‚æœ key å·²ç»å­˜åœ¨äºå­—å…¸ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›å…³è”çš„ entryfunc (d *Dict) keyIndex(key interface&#123;&#125;) (idx uint64, existed *entry) &#123; hash := SipHash(key) for i := 0; i &lt; 2; i++ &#123; ht := d.hashTables[i] idx = ht.sizemask &amp; hash for ent := ht.buckets[idx]; ent != nil; ent = ent.next &#123; if ent.key == key &#123; return idx, ent &#125; &#125; if !d.isRehashing() &#123; break &#125; &#125; // å¦‚æœå­—å…¸å¤„äº rehashing ä¸­ï¼Œä¸Šé¢çš„å¾ªç¯å¯ä»¥ä¿è¯æœ€åçš„ idx ä¸€å®šä½äº // ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä»è€Œä¿è¯ä¾èµ–è¯¥æ¥å£çš„åœ°æ–¹å­˜å‚¨çš„æ–°é”®ä¸€å®šè¿›å…¥åˆ°æ–°çš„å“ˆå¸Œè¡¨ return idx, nil&#125; æŸ¥è¯¢é”®å€¼å¯¹12345678910111213// Load ä»å­—å…¸ä¸­åŠ è½½æŒ‡å®šçš„ key å¯¹åº”çš„å€¼ã€‚func (d *Dict) Load(key interface&#123;&#125;) (value interface&#123;&#125;, ok bool) &#123; if d.isRehashing() &#123; d.rehashStep() &#125; _, existed := d.keyIndex(key) if existed != nil &#123; return existed.value, true &#125; return nil, false&#125; å­˜å‚¨é”®å€¼å¯¹1234567891011121314151617181920212223242526272829303132333435// Store å‘å­—å…¸ä¸­æ·»åŠ  key-valueã€‚func (d *Dict) Store(key interface&#123;&#125;, value interface&#123;&#125;) &#123; ent, loaded := d.loadOrStore(key, value) if loaded &#123; ent.value = value // ç›´æ¥æ›´æ–° value å³å¯ &#125; // å¦åˆ™ï¼Œä¸Šè¿°å‡½æ•°è°ƒç”¨ä¼šè‡ªåŠ¨æ·»åŠ  (key, value) åˆ°å­—å…¸ä¸­&#125;// loadOrStore å…ˆå°è¯•ä½¿ç”¨ key æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°åˆ™ç›´æ¥è¿”å›å¯¹åº” entryï¼Œ// å¦åˆ™ï¼Œä¼šæ·»åŠ æ–°çš„ entry åˆ°å­—å…¸ä¸­ï¼ŒåŒæ—¶è¿”å› nilï¼Œè¡¨ç¤ºä¹‹å‰ä¸å­˜åœ¨ã€‚func (d *Dict) loadOrStore(key, value interface&#123;&#125;) (ent *entry, loaded bool) &#123; if d.isRehashing() &#123; d.rehashStep() &#125; _ = d.expandIfNeeded() // è¿™é‡Œç®€å•èµ·è§ï¼Œå‡è®¾ä¸€å®šæ˜¯å¯ä»¥æ‰©å®¹æˆåŠŸçš„ï¼Œå¿½ç•¥äº†é”™è¯¯ idx, existed := d.keyIndex(key) ht := d.hashTables[0] if d.isRehashing() &#123; ht = d.hashTables[1] &#125; if existed != nil &#123; return existed, true &#125; else &#123; // å¦åˆ™ï¼Œéœ€è¦åœ¨æŒ‡å®š bucket æ·»åŠ æ–°çš„ entry // å¯¹äºå“ˆå¸Œå†²çªçš„æƒ…å†µï¼Œé‡‡ç”¨é“¾åœ°å€æ³•ï¼Œåœ¨æ’å…¥æ–°çš„ entry æ—¶ï¼Œ // é‡‡ç”¨å¤´æ’æ³•ï¼Œä¿è¯æœ€è¿‘æ·»åŠ çš„åœ¨æœ€å‰é¢ entry := &amp;entry&#123;key: key, value: value, next: ht.buckets[idx]&#125; ht.buckets[idx] = entry ht.used++ &#125; return nil, false&#125; åˆ é™¤é”®å€¼å¯¹åˆ é™¤æ“ä½œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æŸ¥æ‰¾åˆ°è¦åˆ é™¤çš„ Entry åï¼Œéœ€è¦è®°å¾—è°ƒæ•´å“ˆå¸Œæ¡¶çš„å¤´æŒ‡é’ˆï¼Œå¯èƒ½è¢«åˆ é™¤çš„ Entry æ°å¥½å°±æ˜¯å¤´èŠ‚ç‚¹ã€‚ä»£ç å®ç°æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940// Delete ä»å­—å…¸ä¸­åˆ é™¤æŒ‡å®šçš„ keyï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆä¹Ÿ// ä¸åšã€‚// å®ç°æè¿°ï¼š// 1. éå†å“ˆå¸Œè¡¨ï¼Œå®šä½åˆ°å¯¹åº”çš„ buckets// 2. åˆ é™¤ buckets ä¸­åŒ¹é…çš„ entryã€‚func (d *Dict) Delete(key interface&#123;&#125;) &#123; if d.Len() == 0 &#123; // ä¸è¦åšæ— ç•çš„æŒ£æ‰ï¼ return &#125; if d.isRehashing() &#123; d.rehashStep() &#125; hash := SipHash(key) for i := 0; i &lt; 2; i++ &#123; ht := d.hashTables[i] idx := ht.sizemask &amp; hash var prevEntry *entry for ent := ht.buckets[idx]; ent != nil; ent = ent.next &#123; if ent.key == key &#123; // æ­¤æ—¶éœ€è¦é‡Šæ”¾ ent èŠ‚ç‚¹ if prevEntry != nil &#123; prevEntry.next = ent.next &#125; else &#123; // è¯´æ˜å¾…é‡Šæ”¾çš„èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒæ•´ buckets[idx] æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ ht.buckets[idx] = ent.next &#125; ent.next = nil ht.used-- return &#125; prevEntry = ent &#125; if !d.isRehashing() &#123; break &#125; &#125;&#125; æ‰©å®¹å’Œç¼©å®¹åœ¨ç»™å­—å…¸æ·»åŠ é”®å€¼å¯¹æ—¶ï¼Œä¼šè°ƒç”¨ loadOrStore æ–¹æ³•ï¼Œè€Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†ä¸€æ¬¡ d.expandIfNeeded() æ–¹æ³•å°è¯•ç»™å­—å…¸æŒ‰éœ€æ‰©å®¹ã€‚é‚£ä¹ˆï¼Œå­—å…¸æ‰©å®¹çš„æ—¶æœºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰©å®¹çš„ç­–ç•¥åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿä¸”çœ‹æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566const ( _initialHashtableSize uint64 = 4)func (d *Dict) expandIfNeeded() error &#123; if d.isRehashing() &#123; // æ­¤æ—¶è¡¨æ˜æ‰©å®¹å·²ç»æˆåŠŸï¼Œæ­£åœ¨è¿›è¡Œè¿ç§»ï¼ˆrehashï¼‰ return nil &#125; if d.hashTables[0].size == 0 &#123; // ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œéœ€è¦ä¸€å®šçš„ç©ºé—´å­˜æ”¾æ–°çš„ keys return d.resizeTo(_initialHashtableSize) &#125; // å¦åˆ™ï¼Œæ ¹æ®è´Ÿè½½å› å­åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ // æ‰©å®¹ç­–ç•¥ç®€å•ç²—æš´ï¼Œè‡³å°‘è¦æ˜¯å·²æœ‰å…ƒç´ ä¸ªæ•°çš„äºŒå€ if d.hashTables[0].used == d.hashTables[0].size &#123; return d.resizeTo(d.hashTables[0].used * 2) &#125; return nil&#125;func (d *Dict) resizeTo(size uint64) error &#123; // è¿™é‡Œä¸»è¦æ˜¯è¦ä¿è¯æ‰©å®¹å¤§å°ç¬¦åˆè¦æ±‚ï¼Œè‡³å°‘è¦æ¯”ç°æœ‰å…ƒç´ ä¸ªæ•°å¤š if d.isRehashing() || d.hashTables[0].used &gt; size &#123; return errors.New("failed to resize") &#125; size = d.nextPower(size) if size == d.hashTables[0].size &#123; return nil &#125; // å‡†å¤‡å¼€å§‹æ‰©å®¹ var ht *hashTable if d.hashTables[0].size == 0 &#123; // ç¬¬ä¸€æ¬¡æ‰§è¡Œæ‰©å®¹ï¼Œç»™ ht[0] å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥ keys å¯ä»¥ç›´æ¥æ”¾è¿›æ¥ ht = d.hashTables[0] &#125; else &#123; ht = d.hashTables[1] // è¡¨æ˜éœ€è¦å¼€å§‹è¿›ä¸€æ­¥æ‰©å®¹ï¼Œè¿ç§» ht[0] -&gt; ht[1] d.rehashIdx = 0 &#125; ht.size = size ht.sizemask = size - 1 ht.buckets = make([]*entry, ht.size) return nil&#125;// nextPower æ‰¾åˆ°åŒ¹é… size çš„æ‰©å®¹å¤§å°// 2^2 -&gt; 2^3 -&gt; 2^4 -&gt; 2^5 -&gt; ...func (d *Dict) nextPower(size uint64) uint64 &#123; if size &gt;= math.MaxUint64 &#123; return math.MaxUint64 &#125; i := _initialHashtableSize for i &lt; size &#123; i &lt;&lt;= 1 // i*= 2 &#125; return i&#125; æˆ‘ä»¬çŸ¥é“äº†æ‰©å®¹æ˜¯ä½•æ—¶è¿›è¡Œçš„äº†ï¼Œ ä½†æ˜¯çœ‹èµ·æ¥å¹¶æ²¡æœ‰åœ¨åˆ é™¤å…ƒç´ æ—¶æ‰§è¡Œç¼©å®¹æ“ä½œå‘¢ï¼Ÿé‚£ç¼©å®¹ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿåœ¨ Redis ä¸­ï¼Œæ˜¯ç”±å­—å…¸çš„ä½¿ç”¨è€…æ¥ç¡®å®šç¼©å®¹çš„æ—¶æœºçš„ï¼Œæ¯”å¦‚åœ¨åˆ é™¤é”®å€¼å¯¹åï¼Œæˆ–è€…åœ¨ serverCron ä¸­æ‰§è¡Œï¼ˆå…·ä½“è°ƒç”¨é“¾è·¯ä¸ºï¼šserverCron-&gt;databasesCron-&gt;tryResizeHashTables-&gt;dictResizeï¼‰ã€‚è¯¥æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œç”¨ Go è¯­è¨€è¡¨è¾¾å¦‚ä¸‹ï¼š 123456789101112131415// Resize è®©å­—å…¸æ‰©å®¹æˆ–è€…ç¼©å®¹åˆ°ä¸€å®šå¤§å°ã€‚// æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ä¼šå‡†å¤‡å¥½ç”¨äºæ‰©å®¹çš„ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä½†çœŸæ­£çš„è¿ç§»è¿˜æ˜¯åˆ†æ•£// åœ¨å¤šæ¬¡ Rehash æ“ä½œä¸­ã€‚func (d *Dict) Resize() error &#123; if d.isRehashing() &#123; return errors.New("dict is rehashing") &#125; size := d.hashTables[0].used if size &lt; _initialHashtableSize &#123; size = _initialHashtableSize &#125; return d.resizeTo(size)&#125; æ¸è¿›å¼ rehashæ¸è¿›å¼ Rehash çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å¤§é‡çš„å·¥ä½œåˆ†æˆå¾ˆå¤šæ­¥å®Œæˆã€‚åœ¨ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒLoad, Store, Delete æ–¹æ³•ä¸­ï¼Œéƒ½æœ‰è°ƒç”¨ d.rehashStep()ï¼Œè¿›è€Œåˆä¼šè°ƒç”¨ d.rehash(1)ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¸è¿›å¼ Rehash æ˜¯æ€ä¹ˆå®ç°çš„ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445// rehash å®ç°æ¸è¿›å¼ Rehash ç­–ç•¥ã€‚åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œæ¯æ¬¡å¯¹æœ€å¤š// steps ä¸ª buckets è¿›è¡Œè¿ç§»ã€‚å¦å¤–ï¼Œè€ƒè™‘åˆ°å¯èƒ½æ—§çš„å“ˆå¸Œè¡¨ä¸­// ä¼šè¿ç»­é‡åˆ°è¾ƒå¤šçš„ç©º bucketsï¼Œå¯¼è‡´è€—è´¹æ—¶é—´ä¸å—é™åˆ¶ï¼Œè¿™é‡Œè¿˜// é™å®šæœ€å¤šé‡åˆ° 10 * steps ä¸ªç©º buckets å°±é€€å‡ºã€‚func (d *Dict) rehash(steps uint64) (finished bool) &#123; if !d.isRehashing() &#123; return true &#125; maxEmptyBucketsMeets := 10 * steps src, dst := d.hashTables[0], d.hashTables[1] for ; steps &gt; 0 &amp;&amp; src.used != 0; steps-- &#123; // æ‰«æå“ˆå¸Œè¡¨ç›´åˆ°é‡åˆ°éç©ºçš„ bucket for src.buckets[d.rehashIdx] == nil &#123; d.rehashIdx++ maxEmptyBucketsMeets-- if maxEmptyBucketsMeets &lt;= 0 &#123; return false &#125; &#125; // æŠŠæ•´ä¸ª bucket ä¸Šæ‰€æœ‰çš„ entry éƒ½è¿ç§»èµ° for ent := src.buckets[d.rehashIdx]; ent != nil; &#123; next := ent.next idx := SiphHash(ent.key) &amp; dst.sizemask ent.next = dst.buckets[idx] dst.buckets[idx] = ent src.used-- dst.used++ ent = next &#125; src.buckets[d.rehashIdx] = nil // æ¸…ç©ºæ—§çš„ bucket d.rehashIdx++ &#125; // å¦‚æœè¿ç§»å®Œæ¯•ï¼Œéœ€è¦å°† ht[0] æŒ‡å‘è¿ç§»åçš„å“ˆå¸Œè¡¨ if src.used == 0 &#123; d.hashTables[0] = dst d.hashTables[1] = &amp;hashTable&#123;&#125; d.rehashIdx = -1 return true &#125; return false&#125; å­—å…¸è¿­ä»£å™¨è¿­ä»£å™¨çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516171819// iterator å®ç°äº†ä¸€ä¸ªå¯¹å­—å…¸çš„è¿­ä»£å™¨ã€‚// ä¸è¿‡è€ƒè™‘åˆ°æˆ‘ä»¬å°†ä¸ºå­—å…¸æä¾› `Range` æ–¹æ³•ï¼Œæ•…è¯¥è¿­ä»£å™¨å°±ä¸å¾€å¤–æš´éœ²äº†ã€‚type iterator struct &#123; d *Dict tableIndex int safe bool fingerprint int64 entry *entry bucketIndex uint64 waitFirstIteration bool&#125;func newIterator(d *Dict, safe bool) *iterator &#123; return &amp;iterator&#123; d: d, safe: safe, waitFirstIteration: true, &#125;&#125; åœ¨ Redis çš„å­—å…¸ä¸­ï¼Œæä¾›äº†ä¸¤ç§ç±»å‹çš„è¿­ä»£å™¨ï¼Œåˆ†åˆ«é€šè¿‡ dictGetIterator å’Œ dictGetSafeIterator è·å¾—ã€‚æ™®é€šè¿­ä»£å™¨åªèƒ½æ‰§è¡Œå’Œå­—å…¸å…³è”çš„ dictNext æ–¹æ³•ï¼Œä¸å…è®¸æ‰§è¡Œ dictFindï¼ŒdictAdd ç­‰æ“ä½œï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºè¿™äº›æ“ä½œå¯èƒ½ä¼šå¼•èµ· Rehashï¼Œä»è€Œå¯¼è‡´åœ¨è¿­ä»£æœŸé—´å¯èƒ½ä¼šæ‰«æåˆ°é‡å¤çš„é”®å€¼å¯¹ï¼ˆæ¯”å¦‚åœ¨æ‰§è¡Œ Rehash æœŸé—´ï¼ŒæŸäº›é”®å€¼å¯¹è¢«è¿ç§»åˆ°äº†æ–°çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¼˜å…ˆæ‰«æç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç„¶åå†æ‰«æç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œè€Œæ­¤æ—¶å¯èƒ½ä¼šé‡åˆ°ä¹‹å‰æ‰«æè¿‡çš„å…ƒç´ ï¼‰ã€‚å½“ç„¶ï¼ŒRedis çš„æ™®é€šè¿­ä»£å™¨æ˜¯æ²¡æ³•é˜»æ­¢ä½ åœ¨è¿­ä»£æœŸé—´æ‰§è¡Œä¸å®‰å…¨çš„æ“ä½œçš„ï¼Œä½†æ˜¯å®ƒä¼šé€šè¿‡è®¡ç®—è¿­ä»£å‰åå­—å…¸çš„æŒ‡çº¹ä¿¡æ¯ï¼Œå¹¶åœ¨æœ€åè¿›è¡Œæ¯”å¯¹ï¼Œè‹¥æŒ‡çº¹ä¸åŒ¹é…ï¼Œåˆ™æ— æ³•é€šè¿‡ assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d)) æ–­è¨€ã€‚ é‚£ä¹ˆå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å¯ä»¥å…è®¸ dictFind å’Œ dictAdd ç­‰æ“ä½œæ‰§è¡Œçš„å‘¢ï¼Ÿå…¶å®å®ƒæ˜¯é€šè¿‡é˜»æ­¢å­—å…¸ rehash å®ç°çš„ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒæ‰å¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°æ‰«æå“ˆå¸Œè¡¨ä¸­çš„ Entriesï¼Œè€Œä¸ç”¨æ‹…å¿ƒé‡åˆ°é‡å¤çš„ Entriesã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Loadã€Store å’Œ Delete ä¸­éƒ½æœ‰ç›´æ¥æˆ–é—´æ¥åœ°è°ƒç”¨ d.rehashStep() æ–¹æ³•ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š 12345func (d *Dict) rehashStep() &#123; if d.iterators == 0 &#123; d.rehash(1) &#125;&#125; æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿­ä»£å™¨æœ€é‡è¦çš„ next() æ–¹æ³•å®ç°ï¼Œå°±å¯ä»¥çœ‹åˆ°å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«äº†ï¼š 1234567891011121314151617181920212223242526272829303132333435363738// next ä¼šä¾æ¬¡æ‰«æå­—å…¸ä¸­å“ˆå¸Œè¡¨çš„æ‰€æœ‰ bucketsï¼Œå¹¶å°†å…¶ä¸­çš„ entry ä¸€ä¸€è¿”å›ã€‚// å¦‚æœå­—å…¸æ­£åœ¨ rehashï¼Œé‚£ä¹ˆä¼šåœ¨æ‰«æå®Œå“ˆå¸Œè¡¨ 1 åï¼Œç»§ç»­æ‰«æå“ˆå¸Œè¡¨ 2ã€‚éœ€è¦// æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨è¿­ä»£æœŸé—´ï¼Œç»§ç»­å‘å­—å…¸ä¸­æ·»åŠ æ•°æ®å¯èƒ½æ²¡æ³•è¢«æ‰«æåˆ°ï¼func (it *iterator) next() *entry &#123; for &#123; if it.entry == nil &#123; if it.waitFirstIteration &#123; // ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œè¦åšç‚¹ç‰¹åˆ«çš„äº‹æƒ…~ if it.safe &#123; // å‘Šè¯‰ dictï¼Œæœ‰æ­£åœ¨è¿è¡Œçš„å®‰å…¨è¿­ä»£å™¨ï¼Œè¿›è€Œé˜»æ­¢æŸäº›æ“ä½œæ—¶çš„ Rehash æ“ä½œ it.d.iterators++ &#125; else &#123; it.fingerprint = it.d.fingerprint() &#125; it.waitFirstIteration = false &#125; ht := it.d.hashTables[it.tableIndex] if it.bucketIndex &gt;= ht.size &#123; if !it.d.isRehashing() || it.tableIndex != 0 &#123; return nil &#125; // åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ç»§ç»­æ‰«æ it.tableIndex = 1 it.bucketIndex = 0 ht = it.d.hashTables[1] &#125; it.entry = ht.buckets[it.bucketIndex] it.bucketIndex++ &#125; else &#123; it.entry = it.entry.next &#125; if it.entry != nil &#123; return it.entry &#125; &#125;&#125; ä½¿ç”¨ç¤ºä¾‹12345678910111213func main() &#123; d := dict.New() d.Store("hello", "world") d.Store(100, 200) fmt.Println(d.Load("hello")) fmt.Println(d.LoadOrStore("language", "Eng")) d.Range(func(key, value interface&#123;&#125;) bool &#123; fmt.Println(key, "=&gt;", value) return true &#125;) _ = d.Resize() d.RehashForAWhile(1 * time.Microsecond)&#125; æ€»ç»“å¥½å•¦ï¼Œå…³äº Redis å­—å…¸çš„å®ç°ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢å•¦ã€‚ç›¸ä¿¡çœ‹å®Œä¸Šé¢çš„ä»£ç åï¼Œåº”è¯¥å¯ä»¥äº†è§£åˆ° Redis å­—å…¸çš„æ‰©å®¹æœºåˆ¶ã€æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œä»¥åŠå“ˆå¸Œå†²çªè§£å†³æ–¹æ¡ˆã€‚å®Œæ•´çš„å®ç°ä»£ç åŠå…¶å•å…ƒæµ‹è¯•å‚è§ go-redis-dictã€‚]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>Redis</tag>
        <tag>å­—å…¸</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„]]></title>
    <url>%2F2019%2F12%2F15%2Fredis-low-level-data-structures%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ Redis åº•å±‚çš„åŸºç¡€æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šåŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsdsï¼‰ã€è·³è¡¨ï¼ˆskiplistï¼‰ã€å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€æ•´æ•°é›†åˆï¼ˆintsetï¼‰ï¼Œå¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰ç­‰ï¼Œt_hashï¼Œt_set, t_zset, t_list ç­‰å¯¹å¤–ç±»å‹çš„å†…éƒ¨å®ç°éƒ½ä¾èµ–äºè¿™äº›æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥éå¸¸å€¼å¾—å­¦ä¹ ã€‚ åœ¨å­¦ä¹ æ¯ç§æ•°æ®ç»“æ„æ—¶ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Œåšäº†ä»€ä¹ˆæ ·çš„æƒè¡¡ï¼Ÿæ¯”å¦‚ï¼Œæœ‰äº›æ•°æ®ç»“æ„æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥ä¼šç‰ºç‰²ä¸€å®šçš„æŸ¥æ‰¾æ•ˆç‡ï¼› æ¯ç§æ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå…·ä½“åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹åº”ç”¨åˆ°ï¼Ÿ ä¸€äº›æ•°æ®ç»“æ„æ¥å£çš„å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯ä»€ä¹ˆï¼Ÿ å¾ˆå¤šæ•°æ®ç»“æ„åœ¨ä¸Šå±‚ä½¿ç”¨æ—¶ï¼Œä¼šæ ¹æ®éœ€è¦é€‰æ‹©ï¼Œå¿…è¦æ—¶ä¼šè¿›è¡Œè½¬æ¢ã€‚éœ€è¦äº†è§£è½¬æ¢çš„æ—¶æœºå’Œè§¦å‘çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ æŸäº›æ•°æ®ç»“æ„å†…éƒ¨ä¼šæŒ‰éœ€æ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œéœ€è¦å…³æ³¨å®ƒä»¬æ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç­–ç•¥å¦‚ä½•ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘ï¼Ÿ æœ¬æ–‡çš„æºç å­¦ä¹ ç¬”è®°æ˜¯åŸºäº Redis 5.0.7 ç‰ˆæœ¬åšçš„ï¼Œè‡ªå·±åšäº†äº›ä¸­æ–‡æ³¨é‡Šï¼Œæ¨é€åˆ°äº† redis comment-src åˆ†æ”¯ï¼Œå‚è€ƒä¹¦ç±ä¸ºã€ŠRedis 5 æºç è®¾è®¡ä¸åˆ†æã€‹ã€‚ åšäº†ä¸€ä¸ªç®€å•çš„æ€ç»´å¯¼å›¾ï¼Œç®€å•æ€»ç»“äº†å„ä¸ªæ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹å’Œä¸€äº›å€¼å¾—é˜…è¯»æºç çš„ APIsï¼Œå¦‚æœæƒ³è¦å¿«é€Ÿäº†è§£çš„è¯ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°æœ¬æ–‡æœ€åä¸€èŠ‚æŸ¥çœ‹~ åŠ¨æ€å­—ç¬¦ä¸²åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDS, Simple Dynamic Stringï¼‰æ˜¯ Redis ä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹ä¹‹ä¸€ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´æ•°ã€‚å¹¶ä¸”å®ƒæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œè¿˜å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²çš„ç»“æŸç¬¦ â€˜\0â€™ï¼Œæ‰€ä»¥éƒ¨åˆ† C æ ‡å‡†åº“ä¸­çš„å­—ç¬¦ä¸²å‡½æ•°ä¹Ÿå¯ä»¥å¯¹ SDS è¿›è¡Œæ“ä½œã€‚ åŠ¨æ€å­—ç¬¦ä¸²å…ƒä¿¡æ¯åŠå­˜å‚¨å­—ç¬¦ä¸²çš„ buf æ˜¯ç”± sdshdr* ç»´æŠ¤çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516171819202122// __attribute__ ((__packed__)) ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¦æ±‚ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ï¼ŒæŒ‰ç…§å®é™…çš„å­—èŠ‚æ•°è¿›è¡Œå¯¹é½ã€‚// è¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ä¸ªï¼š// 1. èŠ‚çº¦å†…å­˜ï¼ˆå¦åˆ™ä¸åŒçš„ sdshdr* å› ä¸ºä¸åŒçš„å­—èŠ‚å¯¹é½æ–¹å¼ï¼Œè€Œå¯¼è‡´å æ®è¾ƒå¤šå†…å­˜ï¼‰// 2. é€šè¿‡ header è·å¾— buf åœ°å€æ—¶ï¼Œä¸ç”¨è€ƒè™‘ç¹ççš„å­—èŠ‚å¯¹é½é—®é¢˜è€Œå¯¼è‡´è®¡ç®—å¤æ‚struct __attribute__ ((__packed__)) sdshdr5 &#123; // flags çš„ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ä¸‰ä½è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr8 &#123; // len å­—ç¬¦ä¸²é•¿åº¦ uint8_t len; /* used */ // alloc è¡¨ç¤ºæŸ”æ€§æ•°ç»„åˆ†é…çš„é•¿åº¦ï¼ˆä¸åŒ…å« header å’Œå­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦å·ï¼‰ uint8_t alloc; /* excluding the header and null terminator */ // flags ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ 5 ä½ä¿ç•™ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[];&#125;;// æ­¤å¤–è¿˜æœ‰ sdshdr16, sdshdr32, sdshdr64ï¼ŒåŒºåˆ«ä»…åœ¨äº len, alloc ä½¿ç”¨çš„æ•´æ•°å­—èŠ‚é•¿åº¦ å…³äº SDS çš„å‡ ä¸ªé—®é¢˜ï¼š å¦‚ä½•å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²æ ‡å‡†ï¼Ÿ SDS è¿”å›çš„å°±æ˜¯æŒ‡å‘å­˜å‚¨å­—ç¬¦ä¸² buf çš„æŒ‡é’ˆï¼Œä¸”ä»¥ â€˜\0â€™ ç»“å°¾ã€‚ å¦‚ä½•èŠ‚çº¦å†…å­˜ï¼Ÿ SDS ä¸­æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œæä¾›äº†ä¸åŒç±»å‹çš„ç»“æ„ä½“è¡¨ç¤ºï¼ˆsdshdr5, sdshdr8, sdshdr16, sdshdr32, sdshdr64ï¼‰ï¼Œå¹¶ä¸”ç»“æ„ä½“ä¸­çš„å­—æ®µæŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼ˆ((__packed__))ï¼‰è¿›ä¸€æ­¥å‡å°‘å› é»˜è®¤å­—èŠ‚å¯¹é½æ–¹å¼å¸¦æ¥äº†å†…å­˜æ¶ˆè€—ï¼›åŒæ—¶æŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼Œä¹Ÿæ–¹ä¾¿åŸºäº header æŒ‡é’ˆè®¡ç®—å‡ºæŸ”æ€§æ•°ç»„çš„æŒ‡é’ˆã€‚ å¦‚ä½•åšåˆ°äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿ SDS Header ç»“æ„ä½“ä¸­æ‹¥æœ‰ len å­—æ®µï¼Œè®°å½•äº†å®é™…å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸å«ç»“æŸç¬¦ï¼‰ï¼Œå› æ­¤åœ¨è¯»å–çš„æ—¶å€™å¯ä»¥ç¡®åˆ‡åœ°çŸ¥é“åœ¨å“ªå„¿åœæ­¢ï¼Œä¸ä¼šå—åˆ°ä¸­é—´çš„ â€˜\0â€™ å½±å“ã€‚ SDS åœ¨åˆ›å»ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œä¸ºä½•å°† sdshdr5 è½¬æˆ sdshdr8ï¼Ÿ è€ƒè™‘åˆ° sdshdr5 å¯èƒ½éœ€è¦é¢‘ç¹æ‰©å®¹ï¼Œå¯¼è‡´å†…å­˜å¤åˆ¶å¼€é”€ã€‚ä½¿ç”¨ sdshdr8 å¯ä»¥æœ‰æ•ˆç¼“è§£ã€‚ SDS å¯¹äºçŸ­å­—ç¬¦ä¸²ä¸ºä½•ä½¿ç”¨ sdshdr5ï¼Ÿ å¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå¤šæ•°çš„å­—ç¬¦ä¸²å¯èƒ½éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²ï¼ˆé•¿åº¦ 32 ä»¥å†…ï¼‰ã€‚ SDS åœ¨å†™å…¥æ—¶å¯èƒ½ä¼šæ‰©å®¹ï¼Œé‚£ä¹ˆå®ƒçš„æ‰©å®¹ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿå®ƒçš„ç­–ç•¥æ¯”è¾ƒç®€å•ï¼Œå¦‚æœ buf å‰©ä½™ç©ºé—´ï¼ˆalloc-lenï¼‰èƒ½å¤Ÿæ”¾ä¸‹æ–°å¢çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ™ä¸ä¼šæœ‰å®è´¨çš„æ‰©å®¹å‘ç”Ÿï¼›å¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿï¼Œåˆ™éœ€è¦çœ‹ len+newLen çš„é•¿åº¦å€¼ï¼Œå¦‚æœå°äº 1MBï¼Œåˆ™æŒ‰ç…§ 2 å€æ‰©å®¹ï¼›å¦åˆ™æ¯æ¬¡å¢åŠ  1MBã€‚åœ¨æ‰©å®¹åï¼Œè¿˜è¦çœ‹æ–°çš„ header ç±»å‹ï¼ˆflags å­—æ®µè¡¨ç¤ºï¼‰æ˜¯å¦å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ realloc åŸåœ°æ‰©å®¹å³å¯ï¼›å¦åˆ™éœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿæ–°ç©ºé—´ï¼Œå¹¶ä½¿ç”¨ memcopy å¤åˆ¶æ•°æ®ã€‚å®Œæˆæ‰©å®¹åï¼Œéœ€è¦æ›´æ–° SDS çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶è¿”å›æ–°çš„ buf æŒ‡é’ˆï¼ˆä¹Ÿå¯èƒ½æŒ‡å‘åŸæ¥ä½ç½®ï¼Œå…·ä½“çœ‹æ‰©å®¹æ—¶çš„ç­–ç•¥æ‰§è¡Œï¼‰ã€‚ æ ¸å¿ƒæºç è¯¦ç»†çš„æºç æ³¨é‡Šå‚è§ è¿™é‡Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109// sdsnewlen åˆ›å»ºä¸€ä¸ªæ–°çš„ sds å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ init æŒ‡å‘çš„å†…å®¹åˆå§‹åŒ–sds sdsnewlen(const void *init, size_t initlen) &#123; void *sh; sds s; char type = sdsReqType(initlen); // ç©ºå­—ç¬¦ä¸²åˆ›å»ºé€šå¸¸éƒ½éœ€è¦æ‰§è¡Œ append è¿½åŠ å­—ç¬¦ä¸²ã€‚ä½¿ç”¨ type 8 æ¯”è¾ƒé€‚åˆï¼Œ // type 5 å¯èƒ½ç©ºé—´ä¸è¶³ï¼Œè¿˜éœ€è¦æ‰§è¡Œæ‰©å®¹ã€‚ if (type == SDS_TYPE_5 &amp;&amp; initlen == 0) type = SDS_TYPE_8; int hdrlen = sdsHdrSize(type); // æ ¹æ®æ•°æ®ç±»å‹ç¡®å®š header é•¿åº¦ unsigned char *fp; /* flags pointer. */ sh = s_malloc(hdrlen+initlen+1); // åˆ†é… sds å†…å­˜ï¼Œ+1 ä¸ºäº†å­˜å‚¨ '\0' if (init==SDS_NOINIT) init = NULL; else if (!init) memset(sh, 0, hdrlen+initlen+1); // å†…å­˜åˆå§‹åŒ–ä¸º 0 if (sh == NULL) return NULL; s = (char*)sh+hdrlen; // æ‹¿åˆ°æŒ‡å‘ buf çš„æŒ‡é’ˆ fp = ((unsigned char*)s)-1; // point to flag, æ³¨æ„ flag å…¶å®æ˜¯ unsigned char ç±»å‹ switch(type) &#123; case SDS_TYPE_5: &#123; // type 5 çš„ flag æ¯”è¾ƒç‰¹æ®Šï¼Œç±»å‹ä¿ç•™åœ¨ä½ 3 ä½ *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS); break; &#125; case SDS_TYPE_8: &#123; SDS_HDR_VAR(8,s); sh-&gt;len = initlen; sh-&gt;alloc = initlen; *fp = type; break; &#125; // SDS_TYPE_16, SDS_TYPE_32, SDS_TYPE_64... &#125; if (initlen &amp;&amp; init) memcpy(s, init, initlen); // å°†ç”¨æˆ·æŒ‡å®šåŒºåŸŸçš„æ•°æ®æ‹·è´è¿‡æ¥ï¼Œä¸è€ƒè™‘ \0ï¼ŒäºŒè¿›åˆ¶å®‰å…¨ s[initlen] = '\0'; // C è¯­è¨€å­—ç¬¦ä¸²ä»¥ '\0' ç»“å°¾ return s;&#125;void sdsfree(sds s) &#123; if (s == NULL) return; // s å®é™…æŒ‡å‘çš„æ˜¯ buf ä½ç½®ï¼Œè¿™é‡Œéœ€è¦è®¡ç®—å‡º header æŒ‡é’ˆ // flag å§‹ç»ˆä½äº buf å‰é¢ï¼Œæ‰€ä»¥ s[-1] å¯ä»¥å¾—åˆ° flagï¼Œè¿›è€Œ // ç¡®å®š typeï¼Œä»è€Œå¯ä»¥è®¡ç®—å‡º header é•¿åº¦ s_free((char*)s-sdsHdrSize(s[-1]));&#125;sds sdsMakeRoomFor(sds s, size_t addlen)&#123; void *sh, *newsh; size_t avail = sdsavail(s); // ç¡®å®š buf å‰©ä½™çš„ç©ºé—´ï¼ˆalloc-lenï¼‰ size_t len, newlen; char type, oldtype = s[-1] &amp; SDS_TYPE_MASK; int hdrlen; /* Return ASAP if there is enough space left. */ // å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿï¼Œåˆ™ç›´æ¥è¿”å› if (avail &gt;= addlen) return s; // ç¡®å®šç°æœ‰å­—ç¬¦ä¸²é•¿åº¦ len = sdslen(s); // è·å¾—å­—ç¬¦ä¸²å¯¹åº”çš„ sdshdr æŒ‡é’ˆ sh = (char *)s - sdsHdrSize(oldtype); // è¿™é‡Œçš„æ–°é•¿åº¦æ˜¯åé¢æ‰©å®¹ç­–ç•¥æ‰§è¡Œçš„ä¾æ® newlen = (len + addlen); if (newlen &lt; SDS_MAX_PREALLOC) // ç›®å‰æ˜¯ 1MB ä»¥å†…ï¼Œ2 å€æ‰©å®¹ newlen *= 2; else // å¦åˆ™éƒ½æ˜¯åŠ  1MB newlen += SDS_MAX_PREALLOC; type = sdsReqType(newlen); /* Don't use type 5: the user is appending to the string and type 5 is * not able to remember empty space, so sdsMakeRoomFor() must be called * at every appending operation. */ if (type == SDS_TYPE_5) type = SDS_TYPE_8; hdrlen = sdsHdrSize(type); if (oldtype == type) &#123; // å¦‚æœç±»å‹ä¸å˜ï¼Œåˆ™æ‰§è¡Œæ‰©å®¹ newsh = s_realloc(sh, hdrlen + newlen + 1); if (newsh == NULL) return NULL; // è·å–æ–°çš„ sds æŒ‡å‘ s = (char *)newsh + hdrlen; &#125; else &#123; /* Since the header size changes, need to move the string forward, * and can't use realloc */ // ç”±äº header å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿç©ºé—´äº† newsh = s_malloc(hdrlen + newlen + 1); if (newsh == NULL) return NULL; // å°† sds ä¸­çš„å†…å®¹æ‹·è´åˆ°æ–°çš„ç©ºé—´ï¼ŒåŒ…æ‹¬ \0 memcpy((char *)newsh + hdrlen, s, len + 1); // é‡Šæ”¾æ—§çš„å†…å­˜ s_free(sh); // è·å–æ–°çš„ sds æŒ‡é’ˆ s = (char *)newsh + hdrlen; // æ›´æ–° flags s[-1] = type; // æ›´æ–°é•¿åº¦ä¿¡æ¯ sdssetlen(s, len); &#125; // æ›´æ–°åˆ†é…çš„ç©ºé—´å¤§å° sdssetalloc(s, newlen); return s;&#125; è·³è¡¨ï¼ˆskiplistï¼‰è·³è¡¨æ˜¯ Redis é›†åˆï¼ˆzsetï¼‰åº•å±‚çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼ˆå¦ä¸€ç§æ˜¯ ziplistï¼‰ã€‚è·³è¡¨çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š åŸç†ç®€å•ï¼Œå®ç°éš¾åº¦è¿œä½äºå¹³è¡¡æ ‘ï¼ˆçº¢é»‘æ ‘ï¼‰ï¼› å¯¹äºæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤ï¼Œå¹³å‡ O(logN) æ—¶é—´å¤æ‚åº¦ï¼Œæ•ˆç‡å’Œçº¢é»‘æ ‘ç›¸å½“ï¼› å†…å­˜å¼€é”€ç›¸å¯¹å¹³è¡¡æ ‘å¹¶æ²¡æœ‰ç‰¹åˆ«å¤§ï¼› ç‰¹åˆ«å®¹æ˜“å®ç° Redis zset ä¸­èŒƒå›´æŸ¥è¯¢ã€‚ è·³è¡¨æ ¸å¿ƒè¦ç´ ï¼šåˆ†å±‚ + æœ‰åºé“¾è¡¨ã€‚ è·³è¡¨æŸ¥æ‰¾è¿‡ç¨‹æè¿°ï¼šä»æœ€ä¸Šå±‚ä¾æ¬¡å‘åæŸ¥æ‰¾ï¼Œå¦‚æœæœ¬å±‚çš„ next èŠ‚ç‚¹å¤§äºè¦æŸ¥æ‰¾çš„å€¼ï¼Œæˆ–è€… next èŠ‚ç‚¹ä¸º NULLï¼Œåˆ™ä»æœ¬èŠ‚ç‚¹å¼€å§‹ï¼Œé™ä½ä¸€å±‚ç»§ç»­å¾€åæŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œåˆ™è¿”å›ï¼›å¦åˆ™è¿”å› NULLã€‚ æ­¤å‰ä½¿ç”¨ Go è¯­è¨€å°è¯•å®ç°äº†ä¸‹ Redis è·³è¡¨ï¼Œç›¸å…³æ–‡ç« å‚è§ Go è¯­è¨€å®ç° Redis è·³è¡¨ï¼Œæºç åŠæ³¨é‡Šå‚è§ æ­¤å¤„ã€‚æ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥é˜…è¯»ä¸‹~ Redis è·³è¡¨å®ç°ç‰¹ç‚¹ æœ€å¤šæœ‰ 64 å±‚ï¼Œå¯ä»¥è¡¨ç¤º 2^64 ä¸ªå…ƒç´ ï¼› æ‹¥æœ‰ backward åé€€æŒ‡é’ˆï¼Œæ–¹ä¾¿åå‘éå†ï¼› æ·»åŠ äº† span å­—æ®µï¼Œè®°å½• forward æŒ‡å‘çš„èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„é—´éš”ã€‚span è¶Šå¤§ï¼Œè·³è¿‡çš„èŠ‚ç‚¹ä¼šè¶Šå¤šã€‚åœ¨è®¡ç®—æ’åï¼ˆrankï¼‰æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ span è®¡ç®—å¾—åˆ°ï¼› æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œå±‚é«˜æ˜¯é€šè¿‡ zlsRandomLevel() å‡½æ•°éšæœºç”Ÿæˆçš„ï¼ŒèŒƒå›´æ˜¯ [1, 64]ã€‚ä½†æ˜¯è¯¥å‡½æ•°ä¼šä¿è¯è¶Šé«˜ level å€¼çš„å‡ºç°çš„æ¦‚ç‡è¶Šä½ã€‚èŠ‚ç‚¹çš„å±‚é«˜ç¡®å®šåï¼Œå°†ä¸ä¼šæ”¹è¾¹ï¼› èŠ‚ç‚¹ä¸­çš„ score å…è®¸é‡å¤ã€‚ è·³è¡¨çš„å…·ä½“åº”ç”¨zset ä¼šä½¿ç”¨è·³è¡¨å­˜å‚¨æ•°æ®ï¼Œä½†æ˜¯å®ƒä¼šæ ¹æ®é…ç½® zset-max-ziplist-entries 128 å’Œ zset-max-ziplist-value 64 å€¼æ¥ç¡®å®šè¯¥ä½¿ç”¨è·³è¡¨è¿˜æ˜¯ ziplistã€‚å¦å¤–ï¼Œåœ¨æ–°å¢å…ƒç´ æ—¶ï¼Œå¦‚æœåŸå…ˆæ˜¯ ziplistï¼Œå½“ä¸´ç•Œæ¡ä»¶è¾¾åˆ°æ—¶ï¼Œä¼šè¢«è½¬æ¢æˆ skiplistï¼Œè€Œä¸”è½¬å˜åå°±ä¸å¯é€†äº†ã€‚ æ ¸å¿ƒæºç ä¸è·³è¡¨ç›¸å…³çš„å‡ ä¸ªé‡è¦çš„å‡½æ•°ä½œäº†æ³¨é‡Šï¼Œå‚è§ æ­¤å¤„ã€‚éœ€è¦é‡ç‚¹å…³æ³¨çš„å‡½æ•°å¦‚ä¸‹ï¼š12345zskiplist *zslCreate(void)zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele)void zslDeleteNode(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update)int zslDelete(zskiplist *zsl, double score, sds ele, zskiplistNode **node)zskiplistNode *zslUpdateScore(zskiplist *zsl, double curscore, sds ele, double newscore) åœ¨çœ‹æºç æ—¶ï¼Œä¼šç»å¸¸çœ‹åˆ° update[] æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„æ˜¯ç”¨æ¥å­˜æ”¾æ¯ä¸€å±‚éœ€è¦è¢«æ›´æ–°çš„èŠ‚ç‚¹ï¼ˆåœ¨å¢åŠ ã€åˆ é™¤èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°ï¼‰ï¼ŒæŠŠå®ƒçœ‹æˆ pending_update_nodes æˆ–è®¸ä¼šæ›´å¥½ç†è§£ç‚¹ã€‚å¦å¤–ï¼Œåœ¨å¢ã€åˆ ã€æ”¹çš„æ—¶å€™ï¼Œéƒ½ä¼šæ¶‰åŠåˆ° span çš„æ›´æ–°ï¼Œéœ€è¦ä»”ç»†æ–Ÿé…Œè®¡ç®—é€»è¾‘ï¼Œä¸€ä¸å°å¿ƒå°±ç®—é”™äº†ã€‚ å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰å‹ç¼©è¡¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæ˜¯ä¸€ç§ä¸ºèŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„æ•°æ®ç»“æ„ã€‚å¯ä»¥å­˜å‚¨å¤šä¸ªå…ƒç´ ï¼Œä¸”æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯æ•´æ•°æˆ–è€…å­—ç¬¦ä¸²ï¼ˆè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—èŠ‚æ•°ç»„ï¼‰ã€‚ä¸¤ç«¯æ“ä½œï¼ˆpop/pushï¼‰æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œä½†è€ƒè™‘åˆ°å®ƒæ¯æ¬¡æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œéƒ½éœ€è¦è°ƒæ•´å†…å­˜ï¼ˆæ‰©å®¹æˆ–è€…ç¼©å°å†…å­˜å ç”¨ï¼‰ï¼Œæ‰€ä»¥å®é™…çš„æ—¶é—´å¤æ‚åº¦å’Œå®ƒå ç”¨çš„å†…å­˜æœ‰å…³ã€‚ ziplist åœ¨æ•£åˆ—è¡¨ã€åˆ—è¡¨å’Œæœ‰åºé›†åˆä¸­å‡æœ‰ï¼ˆç›´æ¥æˆ–é—´æ¥åœ°ï¼‰åº”ç”¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ object encoding &lt;key&gt; æ¥æŸ¥çœ‹å…·ä½“çš„ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼š 123&gt; zadd visitors 1.0 a&gt; object encoding visitors&quot;ziplist&quot; å†…å­˜å¸ƒå±€åœ¨ Redis çš„ ziplist.c ä¸­ï¼Œä½œè€…åœ¨æ³¨é‡Šä¸­ç»™å‡ºäº†å‹ç¼©åˆ—è¡¨å­˜å‚¨å¸ƒå±€ï¼Œå¹¶ä¸”ç»™å‡ºäº†éå¸¸è¯¦ç»†çš„è¯´æ˜å’Œç¤ºä¾‹ï¼Œå€¼å¾—é˜…è¯»ã€‚æ•´ä½“æ¥çœ‹ï¼Œå‹ç¼©åˆ—è¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š å­—æ®µå ç±»å‹ è¯´æ˜ zlbytes uint32_t å‹ç¼©è¡¨å­—èŠ‚é•¿åº¦ï¼ˆåŒ…æ‹¬ zlbytes è‡ªå·±ï¼‰ zltail uint32_t å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»ï¼Œå¦‚æ­¤æ–¹ä¾¿å¿«é€Ÿ pop æœ€åä¸€ä¸ªå…ƒç´  zllen uint16_t è¡¨ç¤º entries çš„ä¸ªæ•°ï¼Œæœ€å¤§æœ‰æ•ˆå€¼ä¸º 2^16-2ï¼Œä¸€æ—¦è¶…å‡ºï¼Œè¯¥å€¼å›ºå®šä¸º 2^16-1ï¼Œå¹¶ä¸”éœ€è¦éå†æ•´ä¸ªåˆ—è¡¨æ‰èƒ½å¾—åˆ°å‡†ç¡®çš„é•¿åº¦ zlend uint8_t å›ºå®šä¸º 0xffï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„ç»“å°¾ Entryæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ¯ä¸ª entry ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œprevlen è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å­—èŠ‚æ•°ï¼Œä¾¿äºä»åå‘å‰éå†ï¼›encoding åˆ™è¡¨ç¤ºå½“å‰ entry çš„ç¼–ç ï¼ˆæ•´æ•°ç±»å‹ï¼Ÿå­—ç¬¦ä¸²ç±»å‹ï¼Ÿï¼‰ï¼›è€Œ entry-data åˆ™æ˜¯çœŸå®å­˜å‚¨å†…å®¹çš„éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œè¿™é‡Œçš„ prevlen å’Œ encoding éƒ½æ˜¯å˜é•¿çš„ï¼Œè€Œ entry-data åˆ™å¯èƒ½æ²¡æœ‰ï¼ˆæ¯”å¦‚å­˜å‚¨å°æ•´æ•° 0~12 æ—¶ï¼‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œprevlen é‡‡ç”¨ uint8_t ç±»å‹ï¼Œå¯è¡¨ç¤ºæœ€å¤š 253 å­—èŠ‚é•¿åº¦ï¼Œè¶…å‡º 253 åï¼Œå°†ä¼šä½¿ç”¨ 5 ä¸ªå­—èŠ‚ã€‚ 1234// å¸¸è§„æƒ…å†µä¸‹&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;// é•¿åº¦è¶…è¿‡ 253 å0xFE &lt;4 å­—èŠ‚ï¼Œå°ç«¯åº prevlen&gt; &lt;encoding&gt; &lt;entry&gt; encoding å­—æ®µä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒå ç”¨å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå’Œå®é™…è¦å­˜å‚¨çš„å†…å®¹æœ‰å…³ï¼š å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ encoding çš„å‰ä¸¤ä½è¡¨ç¤ºç±»å‹ï¼Œå‰©ä¸‹çš„åˆ™è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼š |00pppppp|ï¼šè¡¨ç¤ºé•¿åº¦å°äº 64 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œpppppp è¡¨ç¤º 6 ä½æ— ç¬¦å·æ•´æ•° |01pppppp|qqqqqqqq| - 2 å­—èŠ‚ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^14 å­—èŠ‚çš„å­—ç¬¦ä¸² |10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 å­—èŠ‚ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^32 çš„å­—ç¬¦ä¸² å¦‚æœæ˜¯æ•´æ•°ç±»å‹ï¼Œåˆ™ encoding çš„å‰ä¸¤ä½æ€»æ˜¯ 1ï¼Œç´§æ¥ç€çš„ä¸¤ä½åˆ™è¡¨ç¤ºå…·ä½“çš„æ•´æ•°ç±»å‹ï¼š |11000000|ï¼šint16 |11010000|ï¼šint32 |11100000|ï¼šint64 |11110000|ï¼š24 ä½æœ‰ç¬¦å·æ•´æ•° |11111110|ï¼š8 ä½æœ‰ç¬¦å·æ•´æ•° |1111xxxx|ï¼šè¡¨ç¤º 4 ä½ç«‹å³æ•´æ•°ï¼ˆimediate integerï¼‰ï¼Œ0~12 æ— ç¬¦å·æ•´æ•°ï¼Œæ­¤æ—¶æ²¡æœ‰ entry-data å­—æ®µäº† å°ç»“æ ¹æ®ä¸Šé¢æè¿°çš„ ziplist ç¼–ç ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ¡ä»¶ä¸‹å®ƒä¼šå ç”¨è¾ƒå¤šå†…å­˜ï¼Ÿä¸ºä»€ä¹ˆè¯´ ziplist é€‚åˆå­˜å‚¨ä¸ªæ•°è¾ƒå°‘ï¼Œä¸”é•¿åº¦è¾ƒçŸ­çš„å…ƒç´ å‘¢ï¼Ÿ é€šè¿‡ zzlen å¯çŸ¥ï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°è¶…å‡º 2^16-2 æ—¶ï¼Œéœ€è¦éå†æ•´ä¸ª ziplist å…ƒç´ æ‰å¯ä»¥çŸ¥é“å…·ä½“çš„é•¿åº¦ï¼Œæ•ˆç‡è‡ªç„¶ä¼šé™ä½å¾ˆå¤šï¼› é€šè¿‡ prevlen å¯çŸ¥ï¼Œå¦‚æœå‰ä¸€ä¸ª entry è¶…å‡ºå…¶è¡¨ç¤ºçš„èŒƒå›´æ—¶ï¼ˆ253 å­—èŠ‚ï¼‰ï¼Œå°±éœ€è¦ç”±åŸæ¥çš„ 1 ä¸ªå­—èŠ‚å˜æˆ 5 å­—èŠ‚è¡¨ç¤ºï¼› é€šè¿‡ encoding å¯çŸ¥ï¼Œå¯¹äºå­—ç¬¦ä¸²ç±»å‹å…ƒç´ ï¼Œé•¿åº¦è¶Šé•¿ï¼Œencoding éœ€è¦å ç”¨çš„å­—èŠ‚è¶Šå¤šã€‚å°¤å…¶æ˜¯åœ¨è¶…å‡º 2^14-1 æ—¶ï¼Œæ–°çš„ encoding è¿˜è¦æµªè´¹ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸­çš„å 6 ä½ï¼Œè€Œä½¿ç”¨åé¢çš„ 32 ä½æ•´æ•°æ¥è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œå½±å“å†…å­˜å ç”¨å’Œæ‰§è¡Œæ•ˆç‡çš„ä¸»è¦å› ç´ å¦‚ä¸‹ï¼š å…ƒç´ ä¸ªæ•°ï¼› å…ƒç´ ç±»å‹ï¼› å…ƒç´ é•¿åº¦ã€‚ æ ¸å¿ƒæºç ä¸ºäº†æ–¹ä¾¿è·å¾—æ¯ä¸ª entry ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œåœ¨ ziplist.c ä¸­å®šä¹‰äº†ä¸€ä¸ª zlentry ç»“æ„ä½“ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯è¯¥ç»“æ„ä½“å¹¶é entry å®é™…ç¼–ç çš„å¸ƒå±€ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031// zlentry å­˜åœ¨çš„ç›®çš„å°±æ˜¯ä¿å­˜æ¯ä¸ª entry è§£ç åçš„å…ƒä¿¡æ¯ã€‚å› ä¸ºå®é™…æ¯æ¬¡å¯¹ length, encoding// ç­‰è¿›è¡Œè§£ç æ˜¯æ¯”è¾ƒå¤æ‚çš„è¿ç®—ï¼Œè¿™é‡Œç¼“å­˜ä¸‹æ¥ä¹Ÿä¾¿äºåç»­æ“ä½œã€‚// æ‰€ä»¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œzlentry å¹¶éçœŸå®çš„ entry ç¼–ç ç»“æ„ã€‚typedef struct zlentry &#123; // prevrawlensize è¡¨ç¤º `prevlen` å ç”¨äº†å‡ ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„é•¿åº¦ unsigned int prevrawlensize; /* Bytes used to encode the previous entry len*/ // prevrawlen è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å®é™…é•¿åº¦ unsigned int prevrawlen; /* Previous entry len. */ // lensize è¡¨ç¤º `encoding` å ç”¨äº†å‡ ä¸ªå­—èŠ‚ unsigned int lensize; /* Bytes used to encode this entry type/len. For example strings have a 1, 2 or 5 bytes header. Integers always use a single byte.*/ // len è¡¨ç¤º entry å†…å®¹çœŸæ­£çš„é•¿åº¦ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼›å¦‚æœæ˜¯æ•´æ•° // åˆ™å¯èƒ½çš„å€¼ä¸º 0ï¼ˆ4 ä½å°æ•´æ•°ï¼‰ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ8ï¼ˆå’Œå…·ä½“çš„ int ç±»å‹æœ‰å…³ï¼‰ unsigned int len; /* Bytes used to represent the actual entry. For strings this is just the string length while for integers it is 1, 2, 3, 4, 8 or 0 (for 4 bit immediate) depending on the number range. */ // headersize è¡¨ç¤ºæ•´ä¸ª header éƒ¨åˆ†é•¿åº¦ï¼š&lt;prevlen&gt; + &lt;encoding&gt; unsigned int headersize; /* prevrawlensize + lensize. */ // encoding è¡¨ç¤ºå…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œå¦‚æœ `ZIP_STR_*`,`ZIP_INT_*` // è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯å°æ•´æ•°ï¼Œè¿˜è¦åšèŒƒå›´æ£€æŸ¥ unsigned char encoding; /* Set to ZIP_STR_* or ZIP_INT_* depending on the entry encoding. However for 4 bits immediate integers this can assume a range of values and must be range-checked. */ // p æŒ‡å‘å…ƒç´ å¼€å¤´çš„æŒ‡é’ˆï¼Œå®é™…æŒ‡å‘çš„å°±æ˜¯ `prevlen` ä½ç½® unsigned char *p; /* Pointer to the very start of the entry, that is, this points to prev-entry-len field. */&#125; zlentry; ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç”»ä¸€ä¸ªç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š ziplist ç›¸å…³çš„æºç å‚è§ æ­¤å¤„ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š 12345unsigned char *ziplistNew(void);unsigned char *ziplistPush(unsigned char *zl, unsigned char *s, unsigned int slen, int where);unsigned char *ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen);unsigned char *ziplistDelete(unsigned char *zl, unsigned char **p);unsigned char *ziplistFind(unsigned char *p, unsigned char *vstr, unsigned int vlen, unsigned int skip); ziplist ä¸­æ¯”è¾ƒæ™¦æ¶©æˆ–è€…æ¯ç‡¥çš„éƒ¨åˆ†æ˜¯ç¼–ç ã€è§£ç æ“ä½œï¼›å…¶æ¬¡ï¼Œæ¯æ¬¡å¢åŠ æˆ–è€…ç§»é™¤å…ƒç´ æ—¶ï¼Œéƒ½æ¶‰åŠåˆ°å¾ˆå¤šå†…å­˜æ“ä½œï¼ˆåˆ†é…ç©ºé—´ã€å†…å­˜æ‹·è´ï¼‰ä»¥åŠ entry header çš„è°ƒæ•´ã€‚æƒ³è¦å†™å‡ºå¯é çš„ä»£ç æ¥ï¼Œè¿˜æ˜¯éœ€è¦å¿ƒæ€ç¼œå¯†ï¼Œé€»è¾‘æ¸…æ™°æ‰å¯ä»¥ï¼Œå¤§ä½¬ä»¬çš„ç¼–ç èƒ½åŠ›å®åœ¨æ˜¯å¤ªå¼ºæ‚äº†ï¼ è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯ï¼Œå…ƒç´ çš„æ’å…¥å’Œåˆ é™¤ï¼Œå¯èƒ½ä¼šäº§ç”Ÿè¿é”æ›´æ–°é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è‡ªæ’å…¥ç‚¹ï¼ˆæˆ–åˆ é™¤ç‚¹ï¼‰åç»­çš„ entry prevlen éƒ½éœ€è¦ä¿®æ”¹ï¼ˆè¿˜è®°å¾—å‰é¢æåˆ°çš„ entry prevlen æ˜¯å˜é•¿çš„å—ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å°† prevlen å¢é•¿åˆ° 5 å­—èŠ‚å®¹çº³æ›´å¤§çš„å€¼ï¼›ä½†æ˜¯åè¿‡æ¥ï¼Œå¹¶æ²¡æœ‰å…è®¸ç¼©å®¹ï¼‰ã€‚ä¸è¿‡è¿™ç§æƒ…å†µï¼Œåªæœ‰åœ¨åç»­å…ƒç´ çš„å¤§å°æ¥è¿‘äº ZIP_BIG_PREVLEN æ‰å¯èƒ½å‘ç”Ÿï¼Œæ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥å®é™…ä¸Šä¹Ÿæ²¡åšä»€ä¹ˆä¼˜åŒ–ã€‚å…·ä½“ç­–ç•¥çš„å®ç°å¯ä»¥å‚è€ƒ __ziplistCascadeUpdate()ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p)&#123; size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize; size_t offset, noffset, extra; unsigned char *np; zlentry cur, next; // éå†æ‰€æœ‰å…ƒç´  while (p[0] != ZIP_END) &#123; // è®¡ç®—å½“å‰ entry é•¿åº¦å­˜å‚¨éœ€è¦çš„å­—èŠ‚æ•°ï¼šrawlensize zipEntry(p, &amp;cur); rawlen = cur.headersize + cur.len; rawlensize = zipStorePrevEntryLength(NULL, rawlen); if (p[rawlen] == ZIP_END) break; zipEntry(p + rawlen, &amp;next); // å¦‚æœé•¿åº¦ä¸å˜ï¼Œåˆ™ç›´æ¥é€€å‡º if (next.prevrawlen == rawlen) break; if (next.prevrawlensize &lt; rawlensize) &#123; // ä¸‹ä¸€ä¸ªå…ƒç´ çš„ prevlen éœ€è¦æ›´å¤šå­—èŠ‚æ¥å­˜å‚¨ prevrawlen å€¼ offset = p - zl; extra = rawlensize - next.prevrawlensize; // æ‰©å®¹ä»¥æ”¯æŒå­˜å‚¨æ›´é•¿çš„ rawlen zl = ziplistResize(zl, curlen + extra); // å¢åŠ  extra ç©ºé—´ p = zl + offset; np = p + rawlen; noffset = np - zl; // æ›´æ–° tail åç§»ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„ä½ç½® if ((zl + intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) &#123; ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)) + extra); &#125; // å°†åç»­ entry æ¬ç§»ï¼Œè…¾æŒªå‡ºç©ºé—´å­˜æ”¾æ–°çš„é•¿åº¦å€¼ memmove(np + rawlensize, np + next.prevrawlensize, curlen - noffset - next.prevrawlensize - 1); // next entry prevlen è®°å½•ä¸‹ä¹‹å‰ entry çš„é•¿åº¦å€¼ zipStorePrevEntryLength(np, rawlen); // ...ç»§ç»­ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡éƒ½å¯èƒ½æ¶‰åŠåˆ°å†…å­˜çš„æ‰©å®¹å’Œå…ƒç´ çš„ memmove æ“ä½œ &#125; else &#123; // é˜»æ­¢è¿›è¡Œç¼©å®¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢åç»­æ’å…¥æ—¶ï¼Œå¯èƒ½é¢‘ç¹åœ° shrink æˆ–è€… grow å¯¼è‡´ // æ›´å¤šåœ°å¼€é”€ã€‚ if (next.prevrawlensize &gt; rawlensize) &#123; /* This would result in shrinking, which we want to avoid. * So, set "rawlen" in the available bytes. */ zipStorePrevEntryLengthLarge(p + rawlen, rawlen); &#125; else &#123; zipStorePrevEntryLength(p + rawlen, rawlen); &#125; break; &#125; &#125; return zl;&#125; å­—å…¸ï¼ˆdictï¼‰å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ª Key-Value æ•°æ®åº“ã€‚Redis ä¸­çš„å­—å…¸å®ç°ç‰¹ç‚¹å¦‚ä¸‹ï¼š å¯ä»¥æ”¯æŒæµ·é‡çš„ key-value æ˜ å°„ï¼› key çš„ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•´æ•°ç­‰ç±»å‹ï¼ˆvoid *ï¼‰ï¼›value å¯ä»¥æ˜¯å¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆstring, hash, list, set, sorted setï¼‰æˆ–è€…æ˜¯æ•´æ•°ã€æµ®ç‚¹æ•°ç­‰ï¼› ä¸ºäº†é¿å…å“ˆå¸Œå†²çªï¼Œé‡‡ç”¨äº†é“¾åœ°å€æ³•ï¼Œå°†å†²çªçš„ Entry ä¸²è”äº†èµ·æ¥ï¼› ä¸ºäº†é¿å…åœ¨è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œéœ€è¦å¯¹æµ·é‡ keys è¿›è¡Œ rehash è€Œå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼Œé‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥ï¼› æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ï¼› å¯¹äº keys éå¸¸å¤§çš„å­—å…¸ï¼Œæä¾›äº† dictScan æ–¹æ³•ï¼Œé—´æ–­è¿­ä»£ï¼Œé¿å…å› ä¸ºæ™®é€šè¿­ä»£æ—¶é˜»å¡å…¶å®ƒæ“ä½œã€‚ æ•°æ®ç»“æ„1234567891011121314151617181920212223242526272829303132333435363738typedef struct dictEntry &#123; void *key; union &#123; void *val; uint64_t u64; int64_t s64; double d; &#125; v; struct dictEntry *next;&#125; dictEntry;typedef struct dictType &#123; uint64_t (*hashFunction)(const void *key); void *(*keyDup)(void *privdata, const void *key); void *(*valDup)(void *privdata, const void *obj); int (*keyCompare)(void *privdata, const void *key1, const void *key2); void (*keyDestructor)(void *privdata, void *key); void (*valDestructor)(void *privdata, void *obj);&#125; dictType;/* This is our hash table structure. Every dictionary has two of this as we * implement incremental rehashing, for the old to the new table. */typedef struct dictht &#123; dictEntry **table; unsigned long size; // å“ˆå¸Œè¡¨çœŸæ­£çš„å¤§å° unsigned long sizemask; // sizemask = size-1ï¼Œè¿™é‡Œç”¨äº hash &amp; sizemask è®¡ç®—å‡º slot unsigned long used; // å“ˆå¸Œè¡¨ä¸­çš„ keys ä¸ªæ•°&#125; dictht;typedef struct dict &#123; dictType *type; // ä¾èµ–æ•°æ®æŠ½è±¡çš„æ“ä½œæ¥å£ void *privdata; // ç§æœ‰æ•°æ®ï¼Œé…åˆ type å­—æ®µæŒ‡å‘çš„å‡½æ•°ä½¿ç”¨ dictht ht[2]; // æœ‰ä¸¤ä¸ª hash table // rehashidx è¡¨ç¤º rehash çš„è¿›åº¦ long rehashidx; /* rehashing not in progress if rehashidx == -1 */ // iterators å½“å‰æ­£åœ¨è¿è¡Œçš„è¿­ä»£å™¨æ•°é‡ unsigned long iterators; /* number of iterators currently running */&#125; dict; å­—å…¸æ•´ä½“ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š æ‰©å®¹ä¸ç¼©å®¹åœ¨æ‰§è¡Œ dictAddRaw() æ—¶ï¼Œä¼šå°è¯•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š 12345dictAddRaw() _dictKeyIndex() _dictExpandIfNeeded() dictExpand() _dictNextPower() æ‰€ä»¥æ‰©å®¹æˆ–è€…ç¼©å®¹çš„æ ¸å¿ƒé€»è¾‘åœ¨ dictExpand() å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¯¥å‡½æ•°å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435int dictExpand(dict *d, unsigned long size)&#123; // ç¡®ä¿æˆ‘ä»¬è¦æ‰©å®¹çš„å¤§å°å¯ä»¥å®¹çº³ç›®å‰çš„å…ƒç´  if (dictIsRehashing(d) || d-&gt;ht[0].used &gt; size) return DICT_ERR; // å¾—åˆ°ç›®æ ‡æ‰©å®¹å¤§å° unsigned long realsize = _dictNextPower(size); /* Rehashing to the same table size is not useful. */ // æ‰©å®¹æ—¶æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œé¿å…æ— æ•ˆæ‰©å®¹ if (realsize == d-&gt;ht[0].size) return DICT_ERR; // åˆå§‹åŒ–æ–°çš„å“ˆå¸Œè¡¨ dictht n; n.size = realsize; n.sizemask = realsize-1; n.table = zcalloc(realsize*sizeof(dictEntry*)); n.used = 0; // ht[1] æŒ‡å‘çš„å“ˆå¸Œè¡¨ä¾›æ¸è¿›å¼ rehash ä½¿ç”¨ã€‚ d-&gt;ht[1] = n; d-&gt;rehashidx = 0; // è¡¨ç¤º rehash å‡†å¤‡å®Œæ¯•ï¼Œè¿›åº¦ä¸º 0 return DICT_OK;&#125;// æ‰©å®¹ç­–ç•¥ï¼š4 -&gt; 4 * 2 -&gt; 4 * 2 * 2 -&gt; ...// æŒ‰ç…§ 2 çš„å€æ•°å¢åŠ ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³ size å¤§å°çš„æ•°æ‰¾åˆ°ä¸ºæ­¢static unsigned long _dictNextPower(unsigned long size)&#123; unsigned long i = DICT_HT_INITIAL_SIZE; // 4 if (size &gt;= LONG_MAX) return LONG_MAX + 1LU; while (1) &#123; if (i &gt;= size) return i; i *= 2; &#125;&#125; åœ¨éœ€è¦çš„æ—¶å€™ï¼ŒRedis å¯ä»¥å¯¹å­—å…¸æ‰§è¡Œç¼©å®¹æ“ä½œï¼Œå…·ä½“å¯ä»¥è°ƒç”¨ dictResize() å‡½æ•°å®ç°ï¼š 1234567int dictResize(dict *d)&#123; int minimal = d-&gt;ht[0].used; if (minimal &lt; DICT_HT_INITIAL_SIZE) minimal = DICT_HT_INITIAL_SIZE; return dictExpand(d, minimal);&#125; æ¸è¿›å¼ Rehashä¸ºäº†é¿å…åœ¨ rehash æœŸé—´ï¼Œå› ä¸ºè¦è¿ç§»çš„ keys å¤ªå¤šï¼Œå¯¼è‡´é˜»å¡å…¶å®ƒæ“ä½œæ—¶é—´å¤ªä¹…ï¼ŒRedis çš„å­—å…¸å®ç°ä¸­ï¼Œä½¿ç”¨äº†æ¸è¿›å¼ rehash çš„ç­–ç•¥ï¼Œä»è€Œå°†å¯¹å¤§é‡ keys çš„è¿ç§»åˆ†æ•£åœ¨ N æ¬¡æ“ä½œä¸­ï¼Œç›´åˆ°æœ€ç»ˆå®Œæˆï¼Œå…·ä½“å®ç°å‚è§ dictRehash()ã€‚ é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥åï¼Œæ¯æ¬¡åœ¨æ‰§è¡ŒæŸ¥æ‰¾ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ä»¥åŠ Redis æœåŠ¡å™¨ç©ºé—²æ—¶ï¼Œå¯ä»¥æ‰§è¡Œä¸€éƒ¨åˆ† keys çš„ rehash æ“ä½œã€‚å…·ä½“æ‰§è¡Œæ—¶æœºå¦‚ä¸‹ï¼š _dictRehashStep() -&gt; dictRehash(d, 1)ï¼š dictAddRaw() dictDelete() dictUnlink() dictFind() dictGetRandomKey() dictGetSomeKeys() incrementallyRehash() -&gt; dictRehashMilliseconds(d, 1) -&gt; dictRehash(d, 100)ï¼šServer å¤„äºç©ºé—²æ—¶æ‰§è¡Œ 1ms çš„ rehash å·¥ä½œã€‚ æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨è¿­ä»£å™¨æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¯¹å®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†ï¼Œä½†ä¸éœ€è¦äº†è§£å®¹å™¨å†…éƒ¨å®ç°ç»†èŠ‚ã€‚Redis çš„å­—å…¸ä¹Ÿæˆ‘ä»¬æä¾›äº†è¿­ä»£å™¨æ•°æ®ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314typedef struct dictIterator &#123; dict *d; long index; // table æŒ‡å‘çš„å½“å‰åœ¨è¿­ä»£ tableï¼Œsafe è¡¨æ˜æ˜¯å¦ä¸ºå®‰å…¨çš„è¿­ä»£å™¨ int table, safe; dictEntry *entry, *nextEntry; // fingerprint ç”¨æ¥æ£€æŸ¥éå®‰å…¨è¿­ä»£å™¨åœ¨ä½¿ç”¨æœŸé—´æ˜¯å¦æ‰§è¡Œäº†ä¸å…è®¸çš„æ“ä½œ long long fingerprint;&#125; dictIterator;dictIterator *dictGetIterator(dict *d);dictIterator *dictGetSafeIterator(dict *d);dictEntry *dictNext(dictIterator *iter);void dictReleaseIterator(dictIterator *iter); å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«ï¼š å®‰å…¨è¿­ä»£å™¨å…è®¸æˆ‘ä»¬åœ¨è¿­ä»£æœŸé—´ï¼Œæ‰§è¡ŒæŸ¥æ‰¾ã€åˆ é™¤ã€æ–°å¢ç­‰å¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå¦‚æ‰§è¡Œ keys * å‘½ä»¤æ—¶ä¼šåˆ›å»ºå®‰å…¨è¿­ä»£å™¨ï¼‰ï¼› æ™®é€šè¿­ä»£å™¨åˆ™åªèƒ½å…è®¸æˆ‘ä»¬æ‰§è¡Œ dictNext() è¿›è¡Œè¿­ä»£ï¼Œå…¶å®ƒæ“ä½œæ˜¯ä¸å…è®¸çš„ï¼ˆå¦‚æ‰§è¡Œ sort ä¼šåˆ›å»ºéå®‰å…¨è¿­ä»£å™¨ï¼‰ã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é™åˆ¶å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨è¿­ä»£æœŸé—´ï¼Œå¦‚æœæœ‰æ‰§è¡ŒæŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤ç­‰æ“ä½œï¼Œå¯èƒ½ä¼šå‘ç”Ÿ rehashï¼Œè¿›è€Œå¯¼è‡´æ‰«æåˆ°é‡å¤çš„ entryã€‚ æ™®é€šè¿­ä»£å™¨åœ¨è¿­ä»£å¼€å§‹æ—¶ï¼Œè®¡ç®—å‡ºå½“å‰ dict çš„æŒ‡çº¹ï¼Œå¹¶åœ¨è¿­ä»£ç»“æŸæ—¶å†æ¬¡è®¡ç®— dict çš„æŒ‡çº¹ï¼Œä»è€Œç¡®å®š dict åœ¨æ­¤æœŸé—´æ˜¯å¦å‘ç”Ÿè¿‡ä¿®æ”¹è¿‡ï¼Œç›¸å…³å®ç°å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425dictEntry *dictNext(dictIterator *iter) &#123; while (1) &#123; if (iter-&gt;entry == NULL) &#123; dictht *ht = &amp;iter-&gt;d-&gt;ht[iter-&gt;table]; if (iter-&gt;index == -1 &amp;&amp; iter-&gt;table == 0) &#123; // å¼€å§‹è¿­ä»£ï¼Œè®¡ç®—ä¸‹ fp iter-&gt;fingerprint = dictFingerprint(iter-&gt;d); &#125; iter-&gt;index++; // ... &#125; // ... &#125; return NULL;&#125;void dictReleaseIterator(dictIterator *iter) &#123; if (!(iter-&gt;index == -1 &amp;&amp; iter-&gt;table == 0)) &#123; if (iter-&gt;safe) iter-&gt;d-&gt;iterators--; else assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d)); &#125; zfree(iter);&#125; é‚£ä¹ˆï¼Œå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å®‰å…¨çš„å‘¢ï¼Ÿå…¶å®ç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œå¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œæ—¶ï¼Œé˜»æ­¢å…¶è¿›è¡Œ rehash å³å¯ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åº•å±‚çš„ hash tables ä¸ä¼šæœ‰ keys çš„è¿ç§»ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š è¿­ä»£å™¨åˆå§‹åŒ–æ—¶ï¼Œsafe å­—æ®µç½® 1ï¼› åˆæ¬¡è¿­ä»£æ—¶ï¼Œæ‰§è¡Œ iter-&gt;d-&gt;iterators++ï¼Œå‘Šè¯‰ dict å½“å‰å­˜åœ¨å®‰å…¨çš„è¿­ä»£å™¨åœ¨è¿è¡Œï¼› _dictRehashStep æ—¶ï¼Œå¦‚æœ dict-&gt;iterators != 0 åˆ™ä¸ä¼šæ‰§è¡Œ rehashã€‚ é—´æ–­è¿­ä»£å™¨ä¸ºäº†é¿å…æ‰«ææ‰€æœ‰çš„ keys è€Œé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼ˆäº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒæ˜¯ç¦ç”¨ keys å‘½ä»¤çš„ï¼‰ï¼ŒRedis åœ¨ 2.8 ä¹‹ååŠ å…¥äº† scan æ“ä½œï¼Œä»è€Œèƒ½å¤Ÿé—´æ–­åœ°è¿­ä»£æ•´ä¸ªå­—å…¸ã€‚zscan å’Œ hscan åº•å±‚éƒ½ä¼šæ‰§è¡Œé—´æ–­è¿­ä»£æ“ä½œï¼Œå®ƒçš„å…·ä½“å®ç°å‚è§ dictScanï¼Œæ ¸å¿ƒæ˜¯å›´ç»•ä¸€ä¸ªæ¸¸æ ‡è¿›è¡Œçš„ï¼Œå…³äºå®ƒçš„å…·ä½“ç­–ç•¥å¯ä»¥å‚è§æºç çš„è¯¦ç»†æè¿°ã€‚ è¿™é‡Œæ€»ç»“ä¸‹ dictScan ç®—æ³•çš„ä¸»è¦ç‰¹ç‚¹ï¼š è¿­ä»£å™¨æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ˆå’Œä¸Šé¢çš„ä¸¤ä¸ªç›¸æ¯”ï¼‰ï¼Œè¿­ä»£ä½ç½®æ˜¯åŸºäºæ¸¸æ ‡è®¡ç®—çš„ï¼Œè€Œæ¸¸æ ‡ä¼šè¿”å›ç»™ç”¨æˆ·ï¼Œç”±ç”¨æˆ·ä¿å­˜ï¼Œå¹¶åœ¨è¿­ä»£æ—¶ä¼ å…¥ï¼› å¯èƒ½ä¼šè¿­ä»£åˆ°é‡å¤çš„å…ƒç´ ï¼Œä½†ç”±äºé‡‡ç”¨äº† reverse binary iteration ç®—æ³•ï¼Œèƒ½å¤Ÿä¿è¯ä¸æ¼éå†ä¸”å°½å¯èƒ½ä¸é‡å¤éå†ï¼› æ¯æ¬¡è¿­ä»£ä¼šè¿”å›å¤šä¸ªå…ƒç´ ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºé¿å… rehash çš„å½±å“ï¼Œæ¯æ¬¡ä¼šå°†ä¸€ä¸ª bucket ä¸Šæ‰€æœ‰çš„ keys éƒ½è¿”å›å‡ºå»ã€‚ æ•´æ•°é›†åˆï¼ˆintsetï¼‰é¡¾åæ€ä¹‰ï¼Œintset æ˜¯è½¬é—¨ç”¨äºå­˜å‚¨æ•´æ•°çš„é›†åˆã€‚å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œéšç€å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ çš„ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œå®ƒä¹Ÿä¼šæŒ‰éœ€æ‰©å®¹ã€‚intset è¿˜æœ‰ä¸ªç‰¹ç‚¹æ˜¯æœ‰åºä¸”ä¸é‡å¤ï¼ˆå¯ä»¥æƒ³åˆ°æŸ¥æ‰¾æ—¶å°±å¯ä»¥å…‰æ˜æ­£å¤§åœ°åˆ©ç”¨äºŒåˆ†ç®—æ³•äº†ï¼‰ã€‚ intset å®é™…ä¸Šæ˜¯ Redis é›†åˆç±»å‹åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå½“å…ƒç´ ä¸º 64 ä½ä»¥å†…æœ‰ç¬¦å·æ•´æ•°ï¼ˆæ”¯æŒ int16_t, int32_t, int64_tï¼‰ï¼Œä¸”å…ƒç´ ä¸ªæ•°ä¸å¤šï¼ˆå–å†³äº set_max_intset_entries è®¾ç½®ï¼‰æ—¶ä½¿ç”¨ã€‚å½“å…ƒç´ ä¸ªæ•°è¶…å‡ºè®¾å®šå€¼ï¼Œæˆ–è€…æ–°å¢å…ƒç´ ç±»å‹éæ•´æ•°ï¼Œintset å°±ä¼šè¢«è½¬æ¢æˆ hashtableï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ dict æ¥å­˜å‚¨ã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š 1234567891011121314151617181920212223242526272829robj *setTypeCreate(sds value) &#123; if (isSdsRepresentableAsLongLong(value,NULL) == C_OK) return createIntsetObject(); return createSetObject();&#125;int setTypeAdd(robj *subject, sds value)&#123; long long llval; if (subject-&gt;encoding == OBJ_ENCODING_HT) &#123; /*...*/ &#125; else if (subject-&gt;encoding == OBJ_ENCODING_INTSET) &#123; if (isSdsRepresentableAsLongLong(value, &amp;llval) == C_OK) &#123; uint8_t success = 0; subject-&gt;ptr = intsetAdd(subject-&gt;ptr, llval, &amp;success); if (success) &#123; // å…ƒç´ ä¸ªæ•°è¶…å‡ºèŒƒå›´ï¼Œéœ€è¦è½¬æ¢æˆå­—å…¸å­˜å‚¨ if (intsetLen(subject-&gt;ptr) &gt; server.set_max_intset_entries) setTypeConvert(subject, OBJ_ENCODING_HT); return 1; &#125; &#125; else &#123; // éæ•´æ•°ç±»å‹ï¼Œè½¬æ¢æˆå­—å…¸ setTypeConvert(subject, OBJ_ENCODING_HT); // ... &#125; &#125; return 0;&#125; æ•°æ®ç»“æ„12345typedef struct intset &#123; uint32_t encoding; // æ•´æ•°é•¿åº¦ï¼šINTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64 uint32_t length; // æ•´æ•°ä¸ªæ•° int8_t contents[];&#125; intset; ç®€å•ç”»äº†ä¸ªå†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹ï¼Œç›¸ä¿¡å¯ä»¥ç›´è§‚åœ°è¡¨è¾¾è¿™ä¸ªæ•°æ®ç»“æ„çš„ç‰¹ç‚¹ï¼š æ ¸å¿ƒæºç intset çš„æ ¸å¿ƒ API æ¯”è¾ƒå°‘ï¼Œä¸”å®ç°æ¯”è¾ƒç®€å•ï¼Œå¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å¤šèµ˜è¿°äº†ï¼Œç›¸å…³æºç ä¸­æ–‡æ³¨é‡Šç›´æ¥çœ‹ è¿™é‡Œã€‚ 12345678intset *intsetNew(void);intset *intsetAdd(intset *is, int64_t value, uint8_t *success); // O(N)intset *intsetRemove(intset *is, int64_t value, int *success); // O(N)uint8_t intsetFind(intset *is, int64_t value); // O(logN)int64_t intsetRandom(intset *is); // O(1)uint8_t intsetGet(intset *is, uint32_t pos, int64_t *value); // O(1)uint32_t intsetLen(const intset *is); // O(1)size_t intsetBlobLen(intset *is); // O(1) å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä½†æ˜¯å®ƒçš„æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä½äº ziplist ä¸­ï¼Œå¹¶ä¸”ä¸­é—´èŠ‚ç‚¹çš„ ziplist è¿˜å¯ä»¥ä½¿ç”¨ LZF ç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ã€‚æ€»çš„æ¥è¯´ï¼Œquicklist æ˜¯ä¸€ä¸ªç»¼åˆäº†åŒå‘é“¾è¡¨å’Œ ziplist ä¼˜ç‚¹çš„æ•°æ®ç»“æ„ã€‚ziplist æœ€å¤§çš„ç‰¹ç‚¹æ˜¯èŠ‚çº¦å†…å­˜ï¼Œä½†ä¸é€‚å®œå­˜å‚¨è¿‡å¤šçš„å…ƒç´ ï¼›è€Œé“¾è¡¨åˆ™ä¾¿äºä»å¤´éƒ¨æˆ–è€…å°¾éƒ¨æ‰§è¡Œæ’å…¥æˆ–æŸ¥æ‰¾ã€‚ å› æ­¤ï¼Œquicklist ç®—æ˜¯ä¸º Redis åˆ—è¡¨ç±»å‹ t_list ç‰¹åˆ«å®šåˆ¶çš„æ•°æ®ç»“æ„ï¼Œå…¼é¡¾äº†æ—¶é—´å’Œç©ºé—´æ•ˆç‡ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„ LPUSH, LPOP, RPUSH, RPOP å‘½ä»¤ï¼Œå®é™…ä¸Šåªéœ€è¦æ“ä½œåˆ—è¡¨ä¸¤ç«¯å³å¯ï¼Œè€Œ qucklist æ°å¥½ç»´æŠ¤äº† head å’Œ tail çš„èŠ‚ç‚¹æŒ‡é’ˆï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½ã€‚ æ•°æ®ç»“æ„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374// quicklist æ˜¯å¯¹å¿«é€Ÿé“¾è¡¨è¿™ç§æ•°æ®ç»“æ„çš„æŠ½è±¡ï¼Œå…¶ä¸­å­˜å‚¨äº†ä¸€äº›å…ƒä¿¡æ¯ã€‚typedef struct quicklist &#123; // head, tail æŒ‡å‘é“¾è¡¨çš„å¤´å°¾ quicklistNode *head; quicklistNode *tail; // count è®°å½•äº†æ‰€æœ‰ ziplists çš„å…ƒç´ ä¸ªæ•°ä¹‹å’Œ unsigned long count; /* total count of all entries in all ziplists */ // len è®°å½•äº†æœ‰å¤šå°‘ä¸ª Nodes unsigned long len; /* number of quicklistNodes */ // fill è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¯ä»¥åŒ…å«çš„æ•°æ®é¡¹ï¼Œæ­£æ•°è¡¨ç¤ºæœ€å¤šå¯ä»¥å«æœ‰çš„å…ƒç´ ä¸ªæ•° // è´Ÿæ•°åˆ™è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹ ziplist çš„æœ€å¤§é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼š // -1, 4KB // -2, 8KB // -3, 16KB // -4, 32KB // -5, 64KB int fill : 16; /* fill factor for individual nodes */ // compress è¡¨ç¤ºä¸¤ç«¯ä¸è¢«å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚ä¸€èˆ¬å¯¹äº list çš„æ“ä½œé€šå¸¸æ˜¯åœ¨ä¸¤ç«¯è¿›è¡Œçš„ // æ‰€ä»¥ï¼Œä¸ºäº†æ–¹ä¾¿ LPUSH/LPOP/RPUSH/RPOP å‘½ä»¤ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©å¯¹ä¸¤ç«¯ä¸åšå‹ç¼©ã€‚ // ä½†æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œä¼šå¯¹ä¸­é—´èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼ˆziplist å·²ç»å¤ŸèŠ‚çº¦å†…å­˜äº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å‹ç¼© // æ›´è¿›ä¸€æ­¥åœ°èŠ‚çº¦å†…å­˜ï¼‰ï¼Œä»£ä»·å°±æ˜¯æ¶ˆè€—ç‚¹ CPU æ—¶é—´ç”¨äºå‹ç¼©æˆ–è€…è§£å‹ç¼©ã€‚ unsigned int compress : 16; /* depth of end nodes not to compress;0=off */&#125; quicklist;// quicklistNode å®é™…ä¸Šæ˜¯å¯¹ ziplist çš„æè¿°ï¼Œå…ƒç´ å­˜å‚¨äº ziplist ä¸­ã€‚// ä¸ºä»€ä¹ˆéœ€è¦åœ¨ quicklistNode ä¸­ä½äº ziplist çš„ä¸€äº›å…ƒä¿¡æ¯å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸º// èŠ‚ç‚¹æŒ‡å‘çš„ ziplist å¯ä»¥è¢«å‹ç¼©ï¼Œè¿™æ ·å°±ä¸èƒ½å¿«é€Ÿè·å–ä¸€äº›å…ƒä¿¡æ¯äº†ï¼ˆå…ƒç´ ä¸ªæ•°ç­‰ï¼‰ã€‚typedef struct quicklistNode &#123; // åŒå‘é“¾è¡¨ï¼Œè‡ªç„¶éœ€è¦å‰åå…³è” struct quicklistNode *prev; struct quicklistNode *next; // æŒ‡å‘ ziplist æŒ‡é’ˆï¼ˆå¦‚æœæ˜¯å‹ç¼©èŠ‚ç‚¹ï¼Œå®é™…æŒ‡å‘çš„æ˜¯ quicklistLZFï¼‰ unsigned char *zl; // ziplist çš„å¤§å°ï¼ˆbytesï¼‰ unsigned int sz; /* ziplist size in bytes */ // ziplist ä¸­å­˜å‚¨çš„å…ƒç´ ä¸ªæ•° unsigned int count : 16; /* count of items in ziplist */ // è¡¨ç¤º ziplist è¿›è¡Œäº†å‹ç¼©ç¼–ç ï¼ŒRAW=1 è¡¨ç¤ºæ²¡æœ‰å‹ç¼©ï¼›2 è¡¨ç¤ºä½¿ç”¨äº† LZF ç®—æ³•å‹ç¼© unsigned int encoding : 2; /* RAW==1 or LZF==2 */ // å®¹å™¨ç±»å‹ unsigned int container : 2; /* NONE==1 or ZIPLIST==2 */ // å½“å‰èŠ‚ç‚¹æ˜¯å¦è¢«å‹ç¼©è¿‡ï¼Ÿå¦‚æœå‹ç¼©è¿‡è¿˜éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œè§£å‹ unsigned int recompress : 1; /* was this node previous compressed? */ // å½“å‰èŠ‚ç‚¹å¤ªå°äº†ï¼Œæ— æ³•å‹ç¼© unsigned int attempted_compress : 1; /* node can't compress; too small */ unsigned int extra : 10; /* more bits to steal for future usage */&#125; quicklistNode;// quicklistLZF è¡¨ç¤º ziplist å‹ç¼©åçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ª 4+N å­—èŠ‚å¤§å°çš„ç»“æ„ä½“ã€‚typedef struct quicklistLZF &#123; // sz è¡¨ç¤º LZF å‹ç¼©åçš„æ•°æ®å¤§å° unsigned int sz; /* LZF size in bytes*/ // compressed å­˜å‚¨å‹ç¼©åçš„æ•°æ® char compressed[];&#125; quicklistLZF;// quicklistEntry æ˜¯å¯¹ quicklistNode ä¸‹ ziplist æŸä¸ªå…ƒç´ çš„æŠ½è±¡ï¼Œ// æ–¹ä¾¿æˆ‘ä»¬è·å–å…ƒç´ çš„å†…å®¹ã€‚typedef struct quicklistEntry &#123; // quicklist æŒ‡å‘ quicklist çš„æŒ‡é’ˆ const quicklist *quicklist; // quicklistNode å½“å‰ entry å…³è”çš„èŠ‚ç‚¹ quicklistNode *node; // zi å…³è”çš„ ziplist unsigned char *zi; // value æŒ‡å‘ string ç±»å‹çš„å…ƒç´ ä½ç½® unsigned char *value; // longvalue å…ƒç´ è½¬æ¢ä¸ºæ•´æ•°çš„å€¼ long long longval; // sz è¡¨ç¤º value çš„æœ‰æ•ˆé•¿åº¦ï¼ˆstring ç±»å‹ç¼–ç æ—¶ï¼Œencoding ä¸­çš„é•¿åº¦éƒ¨åˆ†å°±æ˜¯è¿™ä¸ªï¼‰ unsigned int sz; // offset è¡¨ç¤ºåœ¨å½“å‰ ziplist ä¸­çš„åç§»é‡ int offset;&#125; quicklistEntry; é€šè¿‡ä¸‹å›¾å¯ä»¥å¯¹ quicklist æœ‰ä¸ªç›´è§‚çš„æ„Ÿå—ï¼Œä¾¿äºç†è§£è¿™ç§æ•°æ®ç»“æ„ï¼š æ ¸å¿ƒæºç quicklist çš„æºç æ¯”è¾ƒå¤šï¼Œå°±ä¸å†æœ¬æ–‡ä¸­èµ˜è¿°äº†ï¼Œè¯¦ç»†çš„æºç æ³¨é‡Šå¯ä»¥åœ¨ æ­¤å¤„ æŸ¥çœ‹ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š 12345678910// n ä¸º quicklist èŠ‚ç‚¹ä¸ªæ•°ï¼Œm è¡¨ç¤ºå†…éƒ¨ ziplist çš„å…ƒç´ ä¸ªæ•°quicklist *quicklistCreate(void); // O(1)int quicklistPushHead(quicklist *quicklist, void *value, const size_t sz); // O(m)int quicklistPushTail(quicklist *quicklist, void *value, const size_t sz); // O(m)void quicklistPush(quicklist *quicklist, void *value, const size_t sz, int where); // O(m)void quicklistInsertAfter(quicklist *quicklist, quicklistEntry *node, void *value, const size_t sz); // O(m)void quicklistInsertBefore(quicklist *quicklist, quicklistEntry *node, void *value, const size_t sz); // O(m)int quicklistIndex(const quicklist *quicklist, const long long index, quicklistEntry *entry); // O(n+m)int quicklistPop(quicklist *quicklist, int where, unsigned char **data, unsigned int *sz, long long *slong); // O(m) æ€»ç»“è¿™é‡Œå°±ä¸å¤šåºŸè¯äº†ï¼Œå¯¹äºåŸºæœ¬çš„æ•°æ®ç»“æ„åšäº†ç‚¹æ€»ç»“ï¼Œæ”¾åœ¨ä¸‹é¢çš„æ€ç»´å¯¼å›¾ä¸­ã€‚å…¶ä¸­ APIs åˆ†æ”¯å¹¶éæ¯ä¸ªæ•°æ®ç»“æ„å…¨éƒ¨çš„æ¥å£ï¼Œè€Œæ˜¯ä¸€äº›æ¯”è¾ƒæœ‰è¶£ï¼Œå€¼å¾—é˜…è¯»æºç çš„æ¥å£ï¼Œæœ‰å…´è¶£åœ°è¯å¯ä»¥æ¬£èµä¸‹å®ƒä»¬çš„å†…éƒ¨å®ç°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€æŒ‡æ­£~ å‚è€ƒ Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>æºç å­¦ä¹ </tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go è¯­è¨€å®ç° Redis è·³è¡¨]]></title>
    <url>%2F2019%2F12%2F11%2Fimplement-redis-skiplist-in-go%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è¯»è¿‡ Redis æºç çš„ç«¥é‹ï¼Œæƒ³å¿…ä¼šçŸ¥é“ zset å®ç°æ—¶ï¼Œä½¿ç”¨äº†ã€Œè·³è¡¨ã€ï¼ˆSkiplistï¼‰è¿™ç§æ•°æ®ç»“æ„å§ã€‚å®ƒçš„åŸç†éå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœå¯¹é“¾è¡¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼ˆæ ¸å¿ƒï¼šæœ‰åºé“¾è¡¨ + åˆ†å±‚ï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸ä¼šè¯¦ç»†è®²è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¯¹äº Redis è·³è¡¨æºç çš„è¯¦ç»†åˆ†æã€‚å› ä¸ºå·²ç»æœ‰å‰è¾ˆä»¬äº§å‡ºäº†éå¸¸ä¸°å¯Œçš„æ–‡ç« æ¥è®²è§£ Redis è·³è¡¨ï¼Œéœ€è¦çš„è¯ï¼Œæ¨èé˜…è¯» è¿™ç¯‡æ–‡ç«  äº†è§£æ›´å¤šç»†èŠ‚ã€‚ æ€»çš„æ¥è¯´ï¼ŒRedis çš„ zset å®ç°ä¸­ï¼Œé€‰ç”¨ã€Œè·³è¡¨ã€çš„ä¸»è¦åŸå› å¦‚ä¸‹ï¼š åŸç†æ¸…æ™°æ˜“æ‡‚ï¼Œä¸”å®¹æ˜“å®ç°ï¼Œæ–¹ä¾¿ç»´æŠ¤ï¼šå¯¹æ¯”ä¸‹å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘ï¼ˆå¯èƒ½å°±åƒ Raft v.s. Paxos çš„æ„Ÿè§‰ä¸€æ ·ï¼‰ï¼Œä¸ç®¡æ˜¯åŸç†è¿˜æ˜¯å®ç°éƒ½ç®€å•äº†å¾ˆå¤šã€‚å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘åœ¨å®ç°æ—¶ï¼Œè¿˜è¦æ—¶åˆ»ç»´æŠ¤èŠ‚ç‚¹å…³ç³»ï¼Œå¿…è¦æ—¶è¿˜éœ€è¦æ‰§è¡Œæ ‘çš„å·¦æ—‹æˆ–è€…å³æ—‹æ¥ä¿æŒå¹³è¡¡ï¼› æ‹¥æœ‰åª²ç¾å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡ï¼šæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„å¹³å‡æ—¶é—´å¤æ‚åº¦å¯ä»¥è¾¾åˆ° O(logN)ã€‚ å½“ç„¶ï¼Œç›¸å¯¹äº William Pugh åœ¨ä»–çš„è®ºæ–‡ä¸­æ‰€æè¿°çš„ã€Œè·³è¡¨ã€ç®—æ³•è€Œè¨€ï¼Œä½œè€…åœ¨å®ç° Redis ä¸­çš„ã€Œè·³è¡¨ã€æ—¶ï¼Œç»™å®ƒåŠ äº†ç‚¹ã€Œæ–™ã€ï¼š å…è®¸é‡å¤çš„åˆ†æ•°å­˜åœ¨ï¼› åœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œä¸ä»…ä¼šæ¯”è¾ƒ scoreï¼Œè¿˜ä¼šè€ƒè™‘å…³è”çš„æ•°æ®ï¼› æ·»åŠ äº†ä¸€ä¸ªå›é€€æŒ‡é’ˆï¼Œä»è€Œæ„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆlevel[0]ï¼‰ï¼Œä¾¿äºå€’åºéå†é“¾è¡¨ï¼ˆZREVRANGEï¼‰ä½¿ç”¨ã€‚ å¥½äº†ï¼ŒåºŸè¯å®Œæ¯•ã€‚æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å®ç°ã€Œè·³è¡¨ã€å§ï¼ˆè´´ä»£ç æ¨¡å¼å¼€å¯~ï¼‰ã€‚ è·³è¡¨å®ç°ä»¥ä¸‹ä»…ä»…åˆ—å‡ºäº†å‡ ä¸ªæ¯”è¾ƒæœ‰è¶£ä¸”å…³é”®çš„æ–¹æ³•å®ç°ï¼Œå³ï¼šæ’å…¥ã€åˆ é™¤å’Œæ›´æ–°åˆ†æ•°ã€‚å®Œæ•´çš„å®ç°æºç å¯ä»¥å‚è€ƒ è¿™é‡Œ æˆ–è€… è¿™é‡Œï¼ŒåŒ…å«äº†æ¯”è¾ƒè¯¦ç»†çš„å•å…ƒæµ‹è¯•ã€‚ æ•°æ®ç»“æ„å®šä¹‰éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œå‡è®¾å­˜å‚¨çš„å…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆè¦æ˜¯ä½¿ç”¨ interface{} çš„è¯ï¼Œåˆå¾—åŠ äº›ä»£ç æ”¯æŒå…ƒç´ ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼‰ã€‚ä½†æ˜¯åœ¨ Redis ä¸­ï¼Œå®é™…çš„ element ç±»å‹æ˜¯ sdsã€‚ 123456789101112131415161718192021222324const ( MaxLevel = 64 // è¶³ä»¥å®¹çº³ 2^64 ä¸ªå…ƒç´  P = 0.25)type Node struct &#123; elem string score float64 backward *Node level []skipLevel&#125;type skipLevel struct &#123; // forward æ¯å±‚éƒ½è¦æœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ forward *Node // span é—´éš”å®šä¹‰ä¸ºï¼šä»å½“å‰èŠ‚ç‚¹åˆ° forward æŒ‡å‘çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¹‹é—´é—´éš”çš„èŠ‚ç‚¹æ•° span int&#125;type Skiplist struct &#123; header, tail *Node level int // è®°å½•è·³è¡¨çš„å®é™…é«˜åº¦ length int // è®°å½•è·³è¡¨çš„é•¿åº¦ï¼ˆä¸å«å¤´èŠ‚ç‚¹ï¼‰&#125; è¾…åŠ©æ–¹æ³•è€ƒè™‘åˆ°åœ¨å®ç°æ—¶ï¼Œç»å¸¸éœ€è¦æ¯”è¾ƒ score å’Œ elementï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç»™ Node å®ç°äº†ä¸€äº›æ¯”è¾ƒæ–¹æ³•ï¼Œä¾¿äºä½¿ç”¨ã€‚ 12345678910111213141516171819202122232425func (node *Node) Compare(other *Node) int &#123; if node.score &lt; other.score || (node.score == other.score &amp;&amp; node.elem &lt; other.elem) &#123; return -1 &#125; else if node.score &gt; other.score || (node.score == other.score &amp;&amp; node.elem &gt; other.elem) &#123; return 1 &#125; else &#123; return 0 &#125;&#125;func (node *Node) Lt(other *Node) bool &#123; return node.Compare(other) &lt; 0&#125;func (node *Node) Lte(other *Node) bool &#123; return node.Compare(other) &lt;= 0&#125;func (node *Node) Gt(other *Node) bool &#123; return node.Compare(other) &gt; 0&#125;func (node *Node) Eq(other *Node) bool &#123; return node.Compare(other) == 0&#125; æ’å…¥å…ƒç´ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485// Insert å‘è·³è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚// æ­¥éª¤ï¼š// 1. æŸ¥æ‰¾æ’å…¥ä½ç½®// 2. åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶åœ¨ç›®æ ‡ä½ç½®æ’å…¥èŠ‚ç‚¹// 3. è°ƒæ•´è·³è¡¨ backward æŒ‡é’ˆç­‰func (sl *Skiplist) Insert(score float64, elem string) *Node &#123; var ( // update ç”¨äºè®°å½•æ¯å±‚å¾…æ›´æ–°çš„èŠ‚ç‚¹ update [MaxLevel]*Node // rank ç”¨æ¥è®°å½•æ¯å±‚ç»è¿‡çš„èŠ‚ç‚¹è®°å½•ï¼ˆå¯ä»¥çœ‹æˆåˆ°å¤´èŠ‚ç‚¹çš„è·ç¦»ï¼‰ rank [MaxLevel]int // æ„å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œç”¨äºä¸‹é¢çš„å¤§å°åˆ¤æ–­ï¼Œå…¶ level åœ¨åé¢è®¾ç½® node = &amp;Node&#123;score: score, elem: elem&#125; ) cur := sl.header for i := sl.level - 1; i &gt;= 0; i-- &#123; if cur == sl.header &#123; rank[i] = 0 &#125; else &#123; rank[i] = rank[i+1] &#125; // ä¸åŒå±‚çš„åä¸€ä¸ªèŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœåä¸€ä¸ªæ¯”ç›®æ ‡å€¼å°ï¼Œåˆ™å¯ä»¥ç»§ç»­å‘å // å¦åˆ™ä¸‹é™åˆ°ä¸€å±‚æŸ¥æ‰¾ã€‚æ³¨æ„è¿™é‡Œçš„å¤§å°æ¯”è¾ƒæ˜¯æŒ‰ç…§ score å’Œ // elem ç»¼åˆè®¡ç®—å¾—åˆ°çš„ã€‚ for cur.level[i].forward != nil &amp;&amp; cur.level[i].forward.Lt(node) &#123; rank[i] += cur.level[i].span // åŒå±‚ç»§ç»­å¾€åæŸ¥æ‰¾ cur = cur.level[i].forward &#125; update[i] = cur &#125; // è°ƒæ•´è·³è¡¨é«˜åº¦ level := sl.randomLevel() if level &gt; sl.level &#123; // åˆå§‹åŒ–æ¯å±‚ for i := level - 1; i &gt;= sl.level; i-- &#123; rank[i] = 0 update[i] = sl.header update[i].level[i].span = sl.length &#125; sl.level = level &#125; // æ›´æ–°èŠ‚ç‚¹ levelï¼Œå¹¶æ’å…¥æ–°èŠ‚ç‚¹ node.setLevel(level) for i := 0; i &lt; level; i++ &#123; // æ›´æ–°æ¯å±‚çš„èŠ‚ç‚¹æŒ‡å‘ node.level[i].forward = update[i].level[i].forward update[i].level[i].forward = node // æ›´æ–° span ä¿¡æ¯ node.level[i].span = update[i].level[i].span - (rank[0] - rank[i]) update[i].level[i].span = (rank[0] - rank[i]) + 1 &#125; // é’ˆå¯¹æ–°å¢èŠ‚ç‚¹ level &lt; sl.level çš„æƒ…å†µï¼Œéœ€è¦æ›´æ–°ä¸Šé¢æ²¡æœ‰æ‰«åˆ°çš„å±‚ span for i := level; i &lt; sl.level; i++ &#123; update[i].level[i].span++ &#125; // è°ƒæ•´ backward æŒ‡é’ˆ // å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™ backward ä¸º nil // å¦åˆ™ backward æŒ‡å‘ä¹‹å‰èŠ‚ç‚¹ if update[0] != sl.header &#123; // update[0] å°±æ˜¯å’Œæ–°å¢èŠ‚ç‚¹ç›¸é‚»çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ node.backward = update[0] &#125; // å¦‚æœæ–°å¢èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™éœ€è¦æ›´æ–° tail æŒ‡é’ˆ if node.level[0].forward == nil &#123; sl.tail = node &#125; else &#123; // ä¸­é—´èŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹çš„å›é€€æŒ‡é’ˆ node.level[0].forward.backward = node &#125; sl.length++ return node&#125;// randomLevel å¯¹äºæ–°å¢èŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªéšæœºçš„ level// è¿”å›çš„ level èŒƒå›´ä¸º [1, MaxLevel]ã€‚å¹¶ä¸”ï¼Œé‡‡ç”¨çš„// ç®—æ³•ä¼šä¿è¯ï¼Œæ›´å¤§çš„ level è¿”å›çš„æ¦‚ç‡è¶Šä½ã€‚// æ¯ä¸ª level å‡ºç°çš„æ¦‚ç‡è®¡ç®—ï¼š(1-p) * p^(level-1)func (sl *Skiplist) randomLevel() int &#123; level := 1 for rand.Float64() &lt; P &amp;&amp; level &lt; MaxLevel &#123; level++ &#125; return level&#125; åˆ é™¤å…ƒç´ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// Delete ç”¨äºåˆ é™¤è·³è¡¨ä¸­æŒ‡å®šçš„èŠ‚ç‚¹ã€‚func (sl *Skiplist) Delete(score float64, elem string) *Node &#123; // ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°éœ€è¦åˆ é™¤èŠ‚ç‚¹ var ( update [MaxLevel]*Node targetNode = &amp;Node&#123;elem: elem, score: score&#125; ) cur := sl.header for i := sl.level - 1; i &gt;= 0; i-- &#123; for cur.level[i].forward != nil &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123; cur = cur.level[i].forward &#125; update[i] = cur &#125; // ç›®æ ‡èŠ‚ç‚¹æ‰¾åˆ°åï¼Œè¿™é‡Œéœ€è¦åˆ¤æ–­ä¸‹ elem æ˜¯å¦ç›¸ç­‰ // score å¯ä»¥é‡å¤ï¼Œæ‰€ä»¥å¿…é¡»è¦è°¨æ… nodeToBeDeleted := update[0].level[0].forward if nodeToBeDeleted == nil || !nodeToBeDeleted.Eq(targetNode) &#123; return nil &#125; sl.deleteNode(update, nodeToBeDeleted) return nodeToBeDeleted&#125;func (sl *Skiplist) deleteNode(update [64]*Node, nodeToBeDeleted *Node) &#123; // è¿™æ—¶æˆ‘ä»¬è¦åˆ é™¤çš„èŠ‚ç‚¹å°±æ˜¯ nodeToBeDeleted // è°ƒæ•´æ¯å±‚å¾…æ›´æ–°èŠ‚ç‚¹ï¼Œä¿®æ”¹ forward æŒ‡å‘ for i := 0; i &lt; sl.level; i++ &#123; if update[i].level[i].forward == nodeToBeDeleted &#123; update[i].level[i].forward = nodeToBeDeleted.level[i].forward update[i].level[i].span += nodeToBeDeleted.level[i].span - 1 &#125; else &#123; update[i].level[i].span-- &#125; &#125; // è°ƒæ•´å›é€€æŒ‡é’ˆï¼š // 1. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–° sl.tail // 2. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹ä½äºä¸­é—´ï¼Œåˆ™ç›´æ¥æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹ backward å³å¯ if sl.tail == nodeToBeDeleted &#123; sl.tail = nodeToBeDeleted.backward &#125; else &#123; nodeToBeDeleted.level[0].forward.backward = nodeToBeDeleted.backward &#125; // è°ƒæ•´å±‚æ•° for sl.header.level[sl.level-1].forward == nil &#123; sl.level-- &#125; // å‡å°‘èŠ‚ç‚¹è®¡æ•° sl.length-- nodeToBeDeleted.backward = nil nodeToBeDeleted.level[0].forward = nil&#125; æ›´æ–°åˆ†æ•°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// UpdateScore ç”¨äºæ›´æ–°èŠ‚ç‚¹çš„åˆ†æ•°ã€‚è¯¥å‡½æ•°ä¼šä¿è¯æ›´æ–°åˆ†æ•°åï¼Œ// èŠ‚ç‚¹çš„æœ‰åºæ€§ä¾ç„¶å¯ä»¥ç»´æŒã€‚// ç­–ç•¥å¦‚ä¸‹ï¼š// 1. å¿«é€Ÿåˆ¤æ–­èƒ½å¦åŸèŠ‚ç‚¹ä¿®æ”¹ï¼Œå¦‚æœå¯ä»¥åˆ™ç›´æ¥ä¿®æ”¹å¹¶è¿”å›ï¼›// 2. é‡‡ç”¨æ›´åŠ æ˜‚è´µçš„æ“ä½œï¼šåˆ é™¤å†æ·»åŠ ã€‚func (sl *Skiplist) UpdateScore(curScore float64, elem string, newScore float64) *Node &#123; var ( update [MaxLevel]*Node targetNode = &amp;Node&#123;elem: elem, score: curScore&#125; ) cur := sl.header // ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡èŠ‚ç‚¹ for i := sl.level - 1; i &gt;= 0; i-- &#123; for cur.level[i].forward != nil &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123; cur = cur.level[i].forward &#125; update[i] = cur &#125; node := cur.level[0].forward if node == nil || !node.Eq(targetNode) &#123; return nil &#125; if sl.canUpdateScoreFor(node, newScore) &#123; node.score = newScore return node &#125; else &#123; // éœ€è¦åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œå¢åŠ æ–°èŠ‚ç‚¹ sl.deleteNode(update, node) return sl.Insert(newScore, node.elem) &#125;&#125;// canUpdateScoreFor ç¡®å®šèƒ½å¦ç›´æ¥åœ¨åŸæœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œä¿®æ”¹// ä»€ä¹ˆæ¡ä»¶æ‰å¯ä»¥ç›´æ¥åŸåœ°æ›´æ–° score å‘¢ï¼Ÿ// 1. node æ˜¯å”¯ä¸€ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼ˆnode.backward == NULL &amp;&amp; node-&gt;level[0].forward == NULLï¼‰// 2. node æ˜¯ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸”æ–°çš„åˆ†æ•°è¦æ¯” node ä¹‹åèŠ‚ç‚¹åˆ†æ•°è¦å°ï¼ˆè¿™æ ·æ‰èƒ½ä¿è¯æœ‰åºï¼‰// å³ï¼šnode.backward == NULL &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newScoreï¼‰// 3. node æ˜¯æœ€åä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸” node ä¹‹å‰èŠ‚ç‚¹çš„åˆ†æ•°è¦æ¯”æ–°æ”¹çš„åˆ†æ•°å°// å³ï¼šnode-&gt;backward-&gt;score &lt; newScore &amp;&amp; node-&gt;level[0].forward == NULL// 4. node æ˜¯ä¿®æ”¹çš„åçš„åˆ†æ•°æ°å¥½è¿˜èƒ½ä¿è¯ä½äºå‰ä¸€ä¸ªå’Œåä¸€ä¸ªèŠ‚ç‚¹åˆ†æ•°ä¹‹é—´// å³ï¼šnode-&gt;backward-&gt;score &lt; newscore &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newscorefunc (sl *Skiplist) canUpdateScoreFor(node *Node, newScore float64) bool &#123; if (node.backward == nil || node.backward.score &lt; newScore) &amp;&amp; (node.level[0].forward == nil || node.level[0].forward.score &gt; newScore) &#123; return true &#125; return false&#125; æ€»ç»“ä¿—è¯è¯´ï¼Œã€Œè¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥éš¾ã€ã€‚åœ¨å®ç°ã€Œè·³è¡¨ã€çš„æ—¶å€™æ„Ÿå—é¢‡æ·±ï¼Œä¼¼ä¹çœ‹å®Œ Redis çš„ã€Œè·³è¡¨ã€æºç å’Œç½‘ä¸Šè¯¸å¤šå‰è¾ˆç¼–å†™çš„æ–‡ç« åï¼Œè‡ªä»¥ä¸ºæ‡‚å¾—äº†åŸç†ï¼ˆå¯èƒ½ç¡®å®æ‡‚äº†ï¼‰ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°çš„æ—¶å€™è¿˜æ˜¯è¸©äº†ä¸å°‘å‘ã€‚æ¯”å¦‚ï¼Œç©ºæŒ‡é’ˆå¼•èµ· panicï¼›i-- å†™æˆäº† i++ å¯¼è‡´æŸ¥æ‰¾å¤±è´¥ï¼›ä¸€äº›è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­ç­‰ã€‚æ€»ä¹‹ï¼Œç»†èŠ‚å†³å®šæˆè´¥ï¼Œéœ€è¦åœ¨ä¿æŒæ€è·¯æ¸…æ™°çš„åŒæ—¶ï¼Œæ›´åŠ è°¨æ…ä¸€äº›æ‰èƒ½å†™å‡ºè¶³å¤Ÿå¥å£®çš„ä»£ç æ¥ã€‚å½“ç„¶ï¼Œè¿™æœŸé—´è‡ªç„¶å°‘ä¸äº†å•å…ƒæµ‹è¯•çš„åŠ©æ”»ï¼Œå¦åˆ™æœ‰å¾ˆå¤šé—®é¢˜å¯èƒ½éƒ½æ²¡æ³•æš´éœ²å‡ºæ¥~ å‚è€ƒ æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯è·³è¡¨ï¼Ÿ Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>Redis</tag>
        <tag>è·³è¡¨</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redis 5 æºç åˆæ¢]]></title>
    <url>%2F2019%2F12%2F08%2Fprimitive-exploration-of-redis5%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Redis, REmote DIctionary Server å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼ ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼› ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼› ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯å­—ç¬¦ä¸²ã€é›†åˆï¼ˆæœ‰åº/æ— åºï¼‰ã€å­—å…¸ã€åˆ—è¡¨ç­‰ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚ æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚ æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ é¦–å…ˆï¼Œã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹ å’Œ ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹ å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚ æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼› åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼› æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼› å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚ Redis ç‰¹ç‚¹ç¬¬ä¸€ä¸ªå€¼å¾—ç§°é“çš„ç‰¹ç‚¹å°±æ˜¯é«˜æ€§èƒ½ï¼ŒRedis çš„é«˜æ€§èƒ½å¾—ç›Šäºå¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼› æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼› ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼› é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š &lt;key, value&gt; ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼› æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼› æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼› æ”¯æŒé›†ç¾¤ã€‚ æºç æ¦‚è§ˆåé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼šhttps://github.com/iFaceless/redis/tree/5.0ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ comment-src åˆ†æ”¯ä¸‹ã€‚ å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ README.md ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š src: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰ tests: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰ deps: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« jemalloc æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ mallocï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡ server.hserver.h ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ struct redisServer ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š db: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ® commands: å‘½ä»¤è¡¨ clients: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨ master: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯ å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ redisClientï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š 12345678910111213struct client &#123; int fd; // å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚ sds querybuf; int argc; robj **argv; redisDb *db; int flags; // reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ® list *reply; char buf[PROTO_REPLY_CHUNK_BYTES]; ... many other fields ...&#125; è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ robjï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰typedef struct redisObject &#123; // type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹ unsigned type:4; unsigned encoding:4; unsigned lru:LRU_BITS; /* lru time (relative to server.lruclock) */ // refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜ int refcount; // ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ void *ptr;&#125; robj; server.cRedis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ main å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š initServerConfig() ç”¨æ¥é…ç½® struct server çš„é»˜è®¤å€¼ initServer() åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰ aeMain() å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥ Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š serverCron() ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ server.hz é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰ beforeSleep() ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰ åœ¨ server.c ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š call() ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨ activeExpireCycle() ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys freeMemoryIfNeeded() å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ maxmemory æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜ redisCommandTable ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§ networking.cåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š createClient() åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯ addReply*() å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ® writeToClient() ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« sendReplyToClient() è°ƒç”¨ readQueryFromClient() ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº processInputBuffer() æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ processCommand() æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤ freeClient() é‡Šæ”¾å®¢æˆ·ç«¯ aof.c å’Œ rdb.cé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ fork() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚rdb.c åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›aof.c åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚ db.cdb.c ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ DEL å’Œ EXPIRE ç­‰ã€‚æ­¤å¤–ï¼Œdb.c ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚ ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š lookupKeyRead() å’Œ lookupKeyWrite() ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› NULL dbAdd() åŠæ›´æŠ½è±¡çš„å‡½æ•° setKey() æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key dbDelete() ç§»é™¤ key åŠå…³è”çš„ value emptyDb() ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“ object.cstruct robj æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ object.c ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š incrRefcount() å’Œ decrRefCount() ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡ createObject() ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ createStringObjectFromLongLong() ç­‰ replication.creplication.c æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚ è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° replicationFeedSlaves()ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† SYNC å’Œ PSYNC å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚ å…¶å®ƒ t_hash.c, t_list.c, t_set.c, t_string.c å’Œ t_zset.c æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç° ae.c Redis äº‹ä»¶å¾ªç¯å®ç° sds.c Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸² anet.c å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£ dict.c éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç° scripting.c å®ç°äº† Luc è„šæœ¬ cluster.c Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ Redis é›†ç¾¤è¯´æ˜ æ€ç»´å¯¼å›¾ æ„å»º &amp; è°ƒè¯•Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ Clion ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç  è¿™ç¯‡æ–‡ç« ~ åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° src ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ ./mkreleasehdr.sh è„šæœ¬ç”Ÿæˆ src/release.h æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š 1cmake . æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ src/server.c ï¼Œå¹¶æ‰¾åˆ° main å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» main å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚ Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚ å‚è€ƒ Redis README Clion è°ƒè¯• Redis æºç  ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç  ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>æºç å­¦ä¹ </tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gcache æºç å­¦ä¹ ]]></title>
    <url>%2F2019%2F12%2F03%2Fgcache-code-analysis%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Redis, REmote DIctionary Server å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼ ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼› ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼› ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚ å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯ string, set, zset, list, hash mapã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚ æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚ æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ é¦–å…ˆï¼Œã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹ å’Œ ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹ å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚ æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼› åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼› æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼› å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚ Redis ç‰¹ç‚¹Redis ä¹‹æ‰€ä»¥èƒ½å¤Ÿæœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼› æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼› ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼› é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š &lt;key, value&gt; ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼› æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼› æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼› æ”¯æŒé›†ç¾¤ã€‚ æºç æ¦‚è§ˆåé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼šhttps://github.com/iFaceless/redis/tree/5.0ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ comment-src åˆ†æ”¯ä¸‹ã€‚ å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ README.md ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š src: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰ tests: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰ deps: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« jemalloc æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ mallocï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡ server.hserver.h ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ struct redisServer ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š db: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ® commands: å‘½ä»¤è¡¨ clients: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨ master: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯ å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ redisClientï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š 12345678910111213struct client &#123; int fd; // å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚ sds querybuf; int argc; robj **argv; redisDb *db; int flags; // reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ® list *reply; char buf[PROTO_REPLY_CHUNK_BYTES]; ... many other fields ...&#125; è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ robjï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰typedef struct redisObject &#123; // type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹ unsigned type:4; unsigned encoding:4; unsigned lru:LRU_BITS; /* lru time (relative to server.lruclock) */ // refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜ int refcount; // ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ void *ptr;&#125; robj; server.cRedis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ main å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š initServerConfig() ç”¨æ¥é…ç½® struct server çš„é»˜è®¤å€¼ initServer() åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰ aeMain() å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥ Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š serverCron() ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ server.hz é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰ beforeSleep() ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰ åœ¨ server.c ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š call() ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨ activeExpireCycle() ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys freeMemoryIfNeeded() å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ maxmemory æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜ redisCommandTable ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§ networking.cåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š createClient() åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯ addReply*() å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ® writeToClient() ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« sendReplyToClient() è°ƒç”¨ readQueryFromClient() ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº processInputBuffer() æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ processCommand() æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤ freeClient() é‡Šæ”¾å®¢æˆ·ç«¯ aof.c å’Œ rdb.cé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ fork() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚rdb.c åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›aof.c åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚ db.cdb.c ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ DEL å’Œ EXPIRE ç­‰ã€‚æ­¤å¤–ï¼Œdb.c ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚ ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š lookupKeyRead() å’Œ lookupKeyWrite() ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› NULL dbAdd() åŠæ›´æŠ½è±¡çš„å‡½æ•° setKey() æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key dbDelete() ç§»é™¤ key åŠå…³è”çš„ value emptyDb() ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“ object.cstruct robj æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ object.c ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š incrRefcount() å’Œ decrRefCount() ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡ createObject() ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ createStringObjectFromLongLong() ç­‰ replication.creplication.c æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚ è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° replicationFeedSlaves()ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† SYNC å’Œ PSYNC å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚ å…¶å®ƒ t_hash.c, t_list.c, t_set.c, t_string.c å’Œ t_zset.c æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç° ae.c Redis äº‹ä»¶å¾ªç¯å®ç° sds.c Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸² anet.c å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£ dict.c éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç° scripting.c å®ç°äº† Luc è„šæœ¬ cluster.c Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ Redis é›†ç¾¤è¯´æ˜ æ€ç»´å¯¼å›¾ æ„å»º &amp; è°ƒè¯•Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ Clion ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç  è¿™ç¯‡æ–‡ç« ~ åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° src ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ ./mkreleasehdr.sh è„šæœ¬ç”Ÿæˆ src/release.h æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š 1cmake . æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ src/server.c ï¼Œå¹¶æ‰¾åˆ° main å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» main å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚ Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚ å‚è€ƒ Redis README Clion è°ƒè¯• Redis æºç  ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç  ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
        <tag>LRU</tag>
        <tag>LFU</tag>
        <tag>ARC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ–ï¼Ÿ]]></title>
    <url>%2F2019%2F11%2F28%2Fportal%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚ è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¹Ÿé‡åˆ°äº†è¯¸å¤šé—®é¢˜ï¼š API Schema çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®šä¹‰çš„ä¸åŒï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨å‘å·å™¨è·å¾—çš„ ID åœ¨ Model struct ä¸­å®šä¹‰çš„æ˜¯ int64ï¼Œä½†æ˜¯ä¸ºäº†é¿å… json.Marshal æ—¶æº¢å‡ºï¼ˆæµè§ˆå™¨æˆªæ–­ï¼‰ï¼Œç»Ÿä¸€è¿”å›äº† string ç±»å‹çš„ IDï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼› API Schema çš„å­—æ®µåç§°å’Œ Model ä¸­å®šä¹‰çš„å¯èƒ½ä¸åŒï¼› æ”¯æŒçµæ´»çš„ Schema å­—æ®µè¿‡æ»¤æ¯”è¾ƒéº»çƒ¦ï¼Œä¸åŒçš„é¡¹ç›®å®ç°å¯èƒ½ä¸åŒï¼› åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚è¯¾ç¨‹ API Schema å…³è”çš„ä¸€äº›æ•°æ®æ¥è‡ªäºå…¶å®ƒæœåŠ¡ï¼ˆéœ€è¦é€šè¿‡ RPC è°ƒç”¨ï¼‰ï¼Œè¿™æ—¶å¦‚æœèƒ½å¤Ÿå¹¶å‘åŠ è½½å°±æœ‰æé«˜æ¥å£å“åº”é€Ÿåº¦çš„å¯èƒ½ï¼Œä½†æ˜¯éœ€è¦æ¯æ¬¡åœ¨åº”ç”¨å±‚é‡æ–°å®ç°ï¼ˆå½“ç„¶å¯ä»¥å†æŠ½ä¸€å±‚å‡ºæ¥ï¼Œä¸è¿‡è¿˜æ˜¯å¾ˆéº»çƒ¦ï¼Œä¼šæœ‰å¿ƒæ™ºè´Ÿæ‹…ï¼‰ã€‚ â€¦â€¦ é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”æˆ‘ä»¬ä¹‹å‰åœ¨ä½¿ç”¨ Python é¡¹ç›®å¼€å‘æ—¶ï¼Œä½¿ç”¨åˆ°äº† marshmallow è¿™ä¸ªè½»é‡çº§çš„å¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ã€‚å½“ç„¶ï¼Œå®ƒä¸ä»…ä»…æä¾›åºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œè¿˜æœ‰ååºåˆ—åŒ–ä»¥åŠå­—æ®µæ ¡éªŒçš„èƒ½åŠ›ã€‚å¦‚æœèƒ½å¤Ÿæ°å½“çš„ä½¿ç”¨å®ƒï¼Œæ˜¯å¯ä»¥æå‡å¼€å‘æ•ˆç‡çš„ã€‚å¦‚æœåœ¨ Go è¯­è¨€ç¤¾åŒºä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªæ¡†æ¶çš„è¯ï¼Œå®ƒæ˜¯å¯ä»¥è§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜çš„ã€‚ åœ¨ç»è¿‡ä¸€ç•ªæ€æƒ³æ–—äº‰åï¼Œæ–—èƒ†å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„æ¡†æ¶ portal ç”¨äºè§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜ã€‚portal èšç„¦äºä»¥ä¼˜é›…ä¸”ä¸€è‡´çš„æ–¹å¼å¤„ç†å¯¹è±¡åºåˆ—åŒ–çš„é—®é¢˜ï¼›è€Œå¯¹äº Struct Fields çš„æ ¡éªŒé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¬¬ä¸‰æ–¹åº“å¦‚ go-playground/validator æˆ– asaskevich/govalidatorã€‚ ç›®å‰æ¥è¯´ï¼Œæ ¸å¿ƒåŠŸèƒ½å‡å·²æŒ‰ç…§æœ€åˆçš„è®¾è®¡å®ç°äº†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š æä¾›ç®€æ´æ˜“ç”¨çš„ API æ¥å£ æ”¯æŒéå¸¸çµæ´»çš„å­—æ®µè¿‡æ»¤èƒ½åŠ›ï¼ˆä»»æ„æ·±åº¦çš„åµŒå¥—å­—æ®µè¿‡æ»¤ï¼‰ è‡ªåŠ¨å°è¯•ç±»å‹è½¬æ¢ï¼Œè¿œç¦»æ‰‹åŠ¨ç¼–å†™å¤ªå¤šæ²¡ä»€ä¹ˆçµé­‚çš„ç±»å‹è½¬æ¢ä»£ç ï¼ˆæ—©ç‚¹ä¸‹ç­ä¸å¥½å—ï¼Ÿï¼‰ æ”¯æŒå¹¶å‘å¡«å……å­—æ®µå€¼ï¼š å¯æ‰‹åŠ¨æŒ‡å®šå“ªäº›å­—æ®µå¼‚æ­¥åŠ è½½ å¯è®¾ç½®å…¨å±€çš„ goroutine æ± å¤§å° ä½¿ç”¨ PORTALå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…è¯¥åŒ…ï¼š 1get get -u github.com/ifaceless/portal ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ Model ç»“æ„ä½“ 12345678910111213141516171819202122232425262728293031323334353637type NotificationModel struct &#123; ID int Title string Content string&#125;type UserModel struct &#123; ID int&#125;func (u *UserModel) Fullname() string &#123; // åç§°ç”šè‡³å¯ä»¥æ¥è‡ª RPC è°ƒç”¨ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹ return fmt.Sprintf("user:%d", u.ID)&#125;// Notifications è¿”å›ç”¨æˆ·å…³è”çš„ä¸€äº›é€šçŸ¥ä¿¡æ¯åˆ—è¡¨func (u *UserModel) Notifications() (result []*NotificationModel) &#123; for i := 0; i &lt; 1; i++ &#123; result = append(result, &amp;NotificationModel&#123; ID: i, Title: fmt.Sprintf("title_%d", i), Content: fmt.Sprintf("content_%d", i), &#125;) &#125; return&#125;type TaskModel struct &#123; ID int UserID int Title string&#125;// User è¿”å› Task å…³è”çš„ç”¨æˆ·æ˜¯è°func (t *TaskModel) User() *UserModel &#123; return &amp;UserModel&#123;t.UserID&#125;&#125; ç¬¬äºŒæ­¥ï¼šå®šä¹‰ API Schema ç»“æ„ä½“ ä»¥ä¸‹ Schema åœ¨å®šä¹‰æ—¶ï¼Œéƒ½æ·»åŠ äº† json tagï¼Œå¹¶ä¸”æ ‡è®°ä¸º omitemptyã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œå½“æˆ‘ä»¬é€‰æ‹©è¿‡æ»¤æŸäº›å­—æ®µçš„æ—¶å€™ï¼Œportal å°±ä¸ä¼šå¡«å……å¯¹åº”çš„ Schema Fieldsã€‚å› æ­¤ï¼Œæ ‡è®°äº† omitempty çš„å­—æ®µåœ¨ json.Marshal åå°±ä¸ä¼šå‡ºç°ï¼Œä»è€Œè¾¾åˆ°å­—æ®µè¿‡æ»¤çš„ç›®çš„ã€‚ 12345678910111213141516171819202122232425262728293031type NotiSchema struct &#123; ID string `json:"id,omitempty"` Title string `json:"title,omitempty"` Content string `json:"content,omitempty"`&#125;type UserSchema struct &#123; ID string `json:"id,omitempty"` // åç§°æ˜¯ä» User.Fullname() æ–¹æ³•ä¸­è·å–ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º User çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨ `attr` æ ‡è®° Name string `json:"name,omitempty" portal:"attr:Fullname"` // nested è¡¨æ˜è¯¥å­—æ®µçš„å€¼æ˜¯ä¸€ä¸ªå¤åˆç±»å‹ï¼Œportal ä¼šè‡ªåŠ¨å°† notifications æ•°æ®å¡«å……åˆ°å¯¹åº”çš„ schema åˆ—è¡¨ Notifications []*NotiSchema `json:"notifications,omitempty" portal:"nested"` AnotherNotifications []*NotiSchema `json:"another_notifications,omitempty" portal:"nested;attr:Notifications"`&#125;type TaskSchema struct &#123; ID string `json:"id,omitempty"` Title string `json:"title,omitempty"` Description string `json:"description,omitempty" portal:"meth:GetDescription"` // UserSchema is a nested schema User *UserSchema `json:"user,omitempty" portal:"nested"` // We just want `Name` field for `SimpleUser`. // Besides, the data source is the same with `UserSchema` SimpleUser *UserSchema `json:"simple_user,omitempty" portal:"nested;only:Name;attr:User"`&#125;// GetDescription æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•æ¥æä¾›æƒ³è¦çš„æ•°æ®// ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿”å›ä¸åŒçš„æ–‡æ¡ˆfunc (ts *TaskSchema) GetDescription(model *model.TaskModel) string &#123; return "Custom description"&#125; ç¬¬ä¸‰æ­¥ï¼šæŒ‰éœ€åºåˆ—åŒ–1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package mainimport ( "encoding/json" "github.com/ifaceless/portal")func main() &#123; // log debug info portal.SetDebug(true) // set max worker pool size portal.SetMaxPoolSize(1024) // make sure to clean up. defer portal.CleanUp() // write to a specified task schema var taskSchema schema.TaskSchema portal.Dump(&amp;taskSchema, &amp;taskModel) // data: &#123;"id":"1","title":"Finish your jobs.","description":"Custom description","user":&#123;"id":"1","name":"user:1","notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;],"another_notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125; data, _ := json.Marshal(taskSchema) // select specified fields portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only("Title", "SimpleUser")) // data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125; data, _ := json.Marshal(taskSchema) // select fields with alias defined in the json tag. // actually, the default alias tag is `json`, `portal.FieldAliasMapTagName("json")` is optional. portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only("title", "SimpleUser"), portal.FieldAliasMapTagName("json")) // data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125; data, _ := json.Marshal(taskSchema) // you can keep any fields for any nested schemas // multiple fields are separated with ',' // nested fields are wrapped with '[' and ']' portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only("ID", "User[ID,Notifications[ID],AnotherNotifications[Title]]", "SimpleUser")) // data: &#123;"id":"1","user":&#123;"id":"1","notifications":[&#123;"id":"0"&#125;],"another_notifications":[&#123;"title":"title_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125; data, _ := json.Marshal(taskSchema) // ignore specified fields portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Exclude("Description", "ID", "User[Name,Notifications[ID,Content],AnotherNotifications], SimpleUser")) // data: &#123;"title":"Finish your jobs.","user":&#123;"id":"1","notifications":[&#123;"title":"title_0"&#125;]&#125;&#125; data, _ := json.Marshal(taskSchema) // dump multiple tasks var taskSchemas []schema.TaskSchema portal.Dump(&amp;taskSchemas, &amp;taskModels, portal.Only("ID", "Title", "User[Name]")) // data: [&#123;"id":"0","title":"Task #1","user":&#123;"name":"user:100"&#125;&#125;,&#123;"id":"1","title":"Task #2","user":&#123;"name":"user:101"&#125;&#125;] data, _ := json.Marshal(taskSchema)&#125; ä»¥ä¸Šä»…ä»…æ˜¯ PORTAL çš„ä¸€äº›ç®€å•åœºæ™¯çš„åº”ç”¨ï¼Œè¯¦ç»†å¯ä»¥æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹ï¼Œåœ¨ä½¿ç”¨æŒ‡å—ä¸­æä¾›äº†ä¸€äº›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ã€‚ æ ¸å¿ƒ API123456func New(opts ...Option) (*Chell, error)func Dump(dst, src interface&#123;&#125;, opts ...Option) error func DumpWithContext(ctx context.Context, dst, src interface&#123;&#125;, opts ...Option)func SetDebug(v bool)func SetMaxPoolSize(size int)func CleanUp() å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥ å½“æŸä¸ª Schema ç»“æ„ä½“å­—æ®µæ ‡è®°äº† portal:&quot;async&quot; æ ‡ç­¾æ—¶ä¼šå¼‚æ­¥å¡«å……å­—æ®µå€¼ï¼› å½“åºåˆ—åŒ– Schema åˆ—è¡¨æ—¶ï¼Œä¼šåˆ†æ Schema ä¸­æœ‰æ— æ ‡è®°äº† async çš„å­—æ®µï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ä½¿ç”¨å¹¶å‘å¡«å……ç­–ç•¥ï¼›å¦åˆ™åªåœ¨å½“å‰ goroutine ä¸­å®Œæˆåºåˆ—åŒ–ï¼› å¯ä»¥åœ¨ Dump æ—¶æ·»åŠ  portal.DisableConcurrency() ç¦ç”¨å¹¶å‘åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚ FAQQ: ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€ worker pool å­˜åœ¨ï¼ŸA: è€ƒè™‘åˆ°åœ¨ Web æœåŠ¡ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutine å¤„ç†ã€‚è€Œåœ¨å¤„ç†è¯·æ±‚ä¸­ï¼Œå¦‚æœä¸é™åˆ¶ PORTAL å¹¶å‘åŠ è½½å­—æ®µå€¼æ—¶çš„ goroutine æ•°é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„èµ„æºæ¶ˆè€—é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† ants æ¡†æ¶ã€‚ Q: æ€§èƒ½ v.s å¼€å‘æ•ˆç‡ï¼ŸA:å…¶å®å¼•å…¥è¿™ç§æ¡†æ¶ï¼ŒåŠ¿å¿…ä¼šå¯¹æ¥å£å¤„ç†æ—¶çš„å†…å­˜å ç”¨ï¼Œå¤„ç†æ€§èƒ½äº§ç”Ÿå½±å“ã€‚å› ä¸ºå†…éƒ¨å®ç°ä¸­ä¹Ÿä¸å¯é¿å…åœ°å¤§é‡ä½¿ç”¨äº†åå°„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½çš„è¯ï¼Œé‚£è¿˜æ˜¯ä¸æ¨èä½¿ç”¨äº†ã€‚å°±æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼Œå¾ˆå¤šæ¥å£çš„ QPS å¹¶ä¸é«˜ï¼ˆå°¤å…¶æ˜¯ä¸€äº›åå°æ¥å£ï¼‰ï¼Œä¸ç®¡æ˜¯ CPU è¿˜æ˜¯å†…å­˜èµ„æºéƒ½æ˜¯å……è¶³çš„ã€‚è¿™ä¸ªæ—¶å€™ä½¿ç”¨ PORTAL æ˜¯å¯ä»¥æœ‰æ•ˆæé«˜å¼€å‘æ•ˆç‡çš„ï¼ˆä¸ªäººæ„šè§ï¼‰ï¼Œæ¯•ç«Ÿå¯ä»¥å°‘å†™ä¸€äº›ä»£ç ï¼Œè®©æœºå™¨å¹²äº›è ¢æ´»è„æ´»ã€‚ Q: å®é™…é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ portal çš„ï¼Ÿæœ‰ä»€ä¹ˆä½“ä¼šï¼Ÿå¸¦æ¥äº†ä»€ä¹ˆæ”¶ç›Šï¼ŸA:å†ç»å°†è¿‘ä¸€ä¸ªæœˆçš„å®é™…é¡¹ç›®å®è·µï¼Œportal ç›®å‰å·²ç»è¶‹äºç¨³å®šï¼Œå¹¶ä¸”ä¿®å¤äº†å¤§é‡é—®é¢˜ï¼Œå‘å¸ƒäº† 22 ä¸ªç‰ˆæœ¬ã€‚ç›®å‰è¯¥å·¥å…·åŒ…åº”åº”ç”¨åœ¨å¤šä¸ªçº¿ä¸ŠæœåŠ¡ä¸­ï¼ˆåŒ…æ‹¬ HTTP RESTful API å’Œ RPC ä¸­ Model åˆ° thrift å®šä¹‰ç±»å‹çš„æ˜ å°„ï¼‰ï¼Œæ•´ä½“æ„Ÿå—å°±æ˜¯å¼€å‘ä½“éªŒæˆå€æé«˜ï¼Œè€Œä¸”å¸¦æ¥äº†æ€§èƒ½å½±å“å¹¶æ²¡æœ‰æœ€å¼€å§‹è®¤ä¸ºçš„é‚£ä¹ˆå¤§ã€‚ æ€»ç»“ä¸ªäººè®¤ä¸ºï¼Œæ¡†æ¶çš„å¼•å…¥æ­£æ˜¯ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œæå‡é¡¹ç›®è´¨é‡çš„ã€‚æ¡†æ¶å±‚çš„æŠ½è±¡å’Œå°è£…å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½åœ¨ä¸šåŠ¡ä»£ç å±‚ç¼–å†™é‡å¤æœºæ¢°å¼çš„ä»£ç ï¼ŒåŒæ—¶èƒ½å¤Ÿä¿è¯ç¼–å†™æ–¹å¼çš„ä¸€è‡´æ€§ï¼Œæå‡é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚æ‰€è°“çš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿè®¸æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼›æ‰€è°“çš„æå‰ä¼˜åŒ–ï¼Œä¹Ÿè®¸åªæ˜¯è¿‡åº¦ä¼˜åŒ–ã€‚æˆ‘ä»¬åº”è¯¥ç”¨ 20% æ—¶é—´è§£å†³ 80% çš„å¸¸è§„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯é«˜æ•ˆç‡é«˜è´¨é‡çš„é‚£ç§ã€‚è€Œå‰©ä¸‹ 20% çš„éš¾é¢˜ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ«çš„æ–¹æ³•è§£å†³ã€‚åˆ‡å‹¿æœ¬æœ«å€’ç½®ï¼]]></content>
      <categories>
        <category>Web å¼€å‘</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>å¯¹è±¡åºåˆ—åŒ–</tag>
        <tag>Web API</tag>
        <tag>portal</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®ºæ–‡å­¦ä¹ ä¹‹ Linux è°ƒåº¦å™¨]]></title>
    <url>%2F2019%2F11%2F17%2Fguide-to-linux-scheduler%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Linux Kernel Development ä¸€ä¹¦ä¸­ï¼Œå…³äº Linux çš„è¿›ç¨‹è°ƒåº¦å™¨å¹¶æ²¡æœ‰è®²è§£çš„å¾ˆæ·±å…¥ï¼Œåªæ˜¯æåˆ°äº† CFS è°ƒåº¦å™¨çš„åŸºæœ¬æ€æƒ³å’Œä¸€äº›å®ç°ç»†èŠ‚ï¼›å¹¶æ²¡æœ‰ Linux æ—©æœŸçš„è°ƒåº¦å™¨ä»‹ç»ï¼Œä»¥åŠæœ€è¿‘è¿™äº›å¹´æ–°å¢çš„åœ¨å†…æ ¸æºç æ ‘å¤–ç»´æŠ¤çš„è°ƒåº¦å™¨æ€æƒ³ã€‚æ‰€ä»¥åœ¨ç»è¿‡ä¸€ç•ªæœå¯»åï¼Œçœ‹åˆ°äº†è¿™ç¯‡è®ºæ–‡ A complete guide to Linux process schedulingï¼Œå¯¹ Linux çš„è°ƒåº¦å™¨å†å²è¿›è¡Œäº†å›é¡¾ï¼Œå¹¶ä¸”ç›¸å¯¹ç»†è‡´åœ°è®²è§£äº† CFS è°ƒåº¦å™¨ã€‚æ•´ä½“æ¥è¯´ï¼Œè™½ç„¶æ¯”è¾ƒå•°å—¦ï¼Œä½†æ˜¯å¯¹äºæƒ³è¦çŸ¥é“æ›´å¤šç»†èŠ‚çš„æˆ‘æ¥è¯´éå¸¸é€‚åˆï¼Œæ‰€ä»¥å°±æœ‰äº†ç¿»è¯‘å®ƒçš„å†²åŠ¨ã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ è¿‡ç¨‹ä¹Ÿå‚è€ƒäº†å…¶å®ƒè®ºæ–‡ã€‚ä¸‹é¢å¼€å¯å­¦ä¹ ä¹‹æ—…å§~ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Linux ä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªç»“æ„ä½“ï¼ˆtask_structï¼Œå³ä»»åŠ¡æè¿°ç¬¦ï¼‰è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æ–‡ä¸­ä¼šäº¤å‰ä½¿ç”¨è¿›ç¨‹ã€çº¿ç¨‹å’Œä»»åŠ¡ç­‰æœ¯è¯­ï¼Œå¯ä»¥å°†å®ƒä»¬è§†ä½œåŒä¹‰è¯ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ç§°ä¸ºæœ€å°æ‰§è¡Œå•å…ƒã€‚ä½† Linux çš„è°ƒåº¦ç®—æ³•ï¼ˆå¦‚ CFSï¼‰å¯ä»¥åº”ç”¨æ›´åŠ é€šç”¨çš„è°ƒåº¦å•å…ƒï¼ˆå¦‚çº¿ç¨‹ã€cgroupã€ç”¨æˆ·ç­‰ï¼‰ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿‡åº¦çº ç»“è¿™é‡Œçš„æœ¯è¯­ï¼Œé‡è¦çš„æ˜¯äº†è§£æ¯ç§è°ƒåº¦ç®—æ³•çš„æ€æƒ³ï¼ ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦Linux æ˜¯ä¸€ä¸ªå¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿï¼Œè¿™å°±æ„å‘³ç€å®ƒå¯ä»¥ã€ŒåŒæ—¶ã€æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚åœ¨å•æ ¸å¤„ç†å™¨ä¸Šï¼Œä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰§è¡Œï¼ˆå¹¶å‘ï¼‰ï¼›è€Œåœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œåˆ™å…è®¸ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œã€‚ç„¶è€Œï¼Œä¸ç®¡æ˜¯ä½•ç§ç¡¬ä»¶ç±»å‹çš„æœºå™¨ä¸Šï¼Œå¯èƒ½åŒæ—¶è¿˜æœ‰å¾ˆå¤šåœ¨å†…å­˜ä¸­æ— æ³•å¾—åˆ°æ‰§è¡Œçš„è¿›ç¨‹ï¼Œå®ƒä»¬æ­£åœ¨ç­‰å¾…è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨ç¡çœ ã€‚è´Ÿè´£å°† CPU æ—¶é—´åˆ†é…ç»™è¿›ç¨‹çš„å†…æ ¸ç»„ä»¶å°±æ˜¯ã€Œè¿›ç¨‹è°ƒåº¦å™¨ã€ã€‚ è°ƒåº¦å™¨è´Ÿè´£ç»´æŠ¤è¿›ç¨‹è°ƒåº¦é¡ºåºï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¦‚åŒå¤šæ•°å…¶å®ƒçš„ç°ä»£æ“ä½œç³»ç»Ÿï¼ŒLinux å®ç°äº†æŠ¢å å¼å¤šä»»åŠ¡æœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒåº¦å™¨å¯ä»¥éšæ—¶å†³å®šä»»æ„è¿›ç¨‹åœæ­¢è¿è¡Œï¼Œè€Œè®©å…¶å®ƒè¿›ç¨‹è·å¾— CPU èµ„æºã€‚è¿™ç§è¿èƒŒæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ„æ„¿ï¼Œåœæ­¢å…¶è¿è¡Œçš„è¡Œä¸ºå°±æ˜¯æ‰€è°“çš„ã€ŒæŠ¢å ã€ã€‚æŠ¢å é€šå¸¸å¯ä»¥åœ¨å®šæ—¶å™¨ä¸­æ–­æ—¶å‘ç”Ÿï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢ä»»åŠ¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šå®Œæˆè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¯ä¸ªè¿›ç¨‹æ‰€è·å¾—çš„è¿è¡Œæ—¶é—´å«åšè¿›ç¨‹çš„æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰ã€‚ ä»»åŠ¡é€šå¸¸å¯ä»¥åŒºåˆ†ä¸ºäº¤äº’å¼ï¼ˆI/O å¯†é›†å‹ï¼‰å’Œéäº¤äº’å¼ï¼ˆCPU å¯†é›†å‹ï¼‰ä»»åŠ¡ã€‚äº¤äº’å¼ä»»åŠ¡é€šå¸¸ä¼šé‡åº¦ä¾èµ– I/O æ“ä½œï¼ˆå¦‚ GUI åº”ç”¨ï¼‰ï¼Œå¹¶ä¸”é€šå¸¸ç”¨ä¸å®Œåˆ†é…ç»™å®ƒçš„æ—¶é—´ç‰‡ã€‚è€Œéäº¤äº’å¼ä»»åŠ¡ï¼ˆå¦‚æ•°å­¦è¿ç®—ï¼‰åˆ™éœ€è¦ä½¿ç”¨æ›´å¤šçš„ CPU èµ„æºã€‚å®ƒä»¬é€šå¸¸ä¼šç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡ä¹‹åè¢«æŠ¢å ï¼Œå¹¶ä¸ä¼šè¢« I/O è¯·æ±‚é¢‘ç¹é˜»å¡ã€‚ å½“ç„¶ï¼Œç°å®ä¸­çš„åº”ç”¨ç¨‹åºå¯èƒ½åŒæ—¶åŒ…å«ä¸Šè¿°ä¸¤ç§åˆ†ç±»ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ‹¼å†™æ£€æŸ¥æ—¶ä¹Ÿä¼šéœ€è¦å ç”¨å¤§é‡ CPU èµ„æºã€‚ æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥å°±éœ€è¦å‡è¡¡è¿™ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¿è¯æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¾—åˆ°è¶³å¤Ÿçš„æ‰§è¡Œèµ„æºï¼Œè€Œä¸ä¼šå¯¹å…¶å®ƒä»»åŠ¡äº§ç”Ÿæ˜æ˜¾çš„æ€§èƒ½å½±å“ã€‚ Linux ä¸ºäº†ä¿è¯ CPU åˆ©ç”¨ç‡æœ€å¤§åŒ–ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ›´å¿«çš„å“åº”æ—¶é—´ï¼Œå€¾å‘äºä¸ºéäº¤äº’å¼ä»»åŠ¡åˆ†é…æ›´å¤§çš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯ä»¥è¾ƒä½çš„é¢‘ç‡è¿è¡Œå®ƒä»¬ï¼›è€Œé’ˆå¯¹ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œåˆ™ä¼šåœ¨è¾ƒçŸ­å‘¨æœŸå†…é¢‘ç¹åœ°æ‰§è¡Œã€‚ è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦è¿›ç¨‹æè¿°ç¬¦ï¼ˆtask_structï¼‰ä¸­çš„å¾ˆå¤šå­—æ®µä¼šè¢«è°ƒåº¦æœºåˆ¶ç›´æ¥ä½¿ç”¨ã€‚ä»¥ä¸‹ä»…åˆ—å‡ºä¸€äº›æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶åœ¨åæ–‡è¯¦ç»†è®¨è®ºã€‚1234567891011struct task_struct &#123; int prio, static_prio, normal_prio; unsigned int rt_priority; const struct sched_class *sched_class; struct sched_entity se; struct sched_rt_entity rt; â€¦ unsigned int policy; cpumask_t cpus_allowed; â€¦&#125;; å…³äºè¿™äº›å­—æ®µçš„è¯´æ˜å¦‚ä¸‹ï¼š prio è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿›ç¨‹è¿è¡Œæ—¶é—´ï¼ŒæŠ¢å é¢‘ç‡éƒ½ä¾èµ–äºè¿™äº›å€¼ã€‚rt_priority åˆ™ç”¨äºå®æ—¶ï¼ˆreal-timeï¼‰ä»»åŠ¡ï¼› sched_class è¡¨ç¤ºè¿›ç¨‹ä½äºå“ªä¸ªè°ƒåº¦ç±»ï¼› sched_entity çš„æ„ä¹‰æ¯”è¾ƒç‰¹æ®Šã€‚é€šå¸¸æŠŠä¸€ä¸ªçº¿ç¨‹ï¼ˆLinux ä¸­çš„è¿›ç¨‹ã€ä»»åŠ¡åŒä¹‰è¯ï¼‰å«ä½œæœ€å°è°ƒåº¦å•å…ƒã€‚ä½†æ˜¯ Linux è°ƒåº¦å™¨ä¸ä»…ä»…åªèƒ½å¤Ÿè°ƒåº¦å•ä¸ªä»»åŠ¡ï¼Œè€Œä¸”è¿˜å¯ä»¥å°†ä¸€ç»„è¿›ç¨‹ï¼Œç”šè‡³å±äºæŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹ä½œä¸ºæ•´ä½“è¿›è¡Œè°ƒåº¦ã€‚è¿™å°±å…è®¸æˆ‘ä»¬å®ç°ç»„è°ƒåº¦ï¼Œä»è€Œå°† CPU æ—¶é—´å…ˆåˆ†é…åˆ°è¿›ç¨‹ç»„ï¼Œå†åœ¨ç»„å†…åˆ†é…åˆ°å•ä¸ªçº¿ç¨‹ã€‚å½“å¼•å…¥è¿™é¡¹åŠŸèƒ½åï¼Œå¯ä»¥å¤§å¹…åº¦æå‡æ¡Œé¢ç³»ç»Ÿçš„äº¤äº’æ€§ã€‚æ¯”å¦‚ï¼Œå¯ä»¥å°†ç¼–è¯‘ä»»åŠ¡èšé›†æˆä¸€ä¸ªç»„ï¼Œç„¶åè¿›è¡Œè°ƒåº¦ï¼Œä»è€Œä¸ä¼šå¯¹äº¤äº’æ€§äº§ç”Ÿæ˜æ˜¾çš„å½±å“ã€‚è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸‹ï¼Œ**Linux è°ƒåº¦å™¨ä¸ä»…ä»…èƒ½ç›´æ¥è°ƒåº¦è¿›ç¨‹ï¼Œä¹Ÿèƒ½å¯¹è°ƒåº¦å•å…ƒï¼ˆschedulable entitiesï¼‰è¿›è¡Œè°ƒåº¦ã€‚è¿™æ ·çš„è°ƒåº¦å•å…ƒæ­£æ˜¯ç”¨ struct sched_entity æ¥è¡¨ç¤ºçš„ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå®ƒå¹¶éä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥åµŒå¥—åœ¨è¿›ç¨‹æè¿°ç¬¦ä¸­çš„ã€‚å½“ç„¶ï¼Œåé¢çš„è°ˆè®ºå°†èšç„¦åœ¨å•è¿›ç¨‹è°ƒåº¦è¿™ç§ç®€å•åœºæ™¯ã€‚ç”±äºè°ƒåº¦å™¨æ˜¯é¢å‘è°ƒåº¦å•å…ƒè®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒä¼šå°†å•ä¸ªè¿›ç¨‹ä¹Ÿè§†ä¸ºè°ƒåº¦å•å…ƒï¼Œå› æ­¤ä¼šä½¿ç”¨ sched_entity ç»“æ„ä½“æ“ä½œå®ƒä»¬ã€‚sched_rt_entity åˆ™æ˜¯å®æ—¶è°ƒåº¦æ—¶ä½¿ç”¨çš„ã€‚ policy è¡¨æ˜ä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼šé€šå¸¸æ„å‘³ç€é’ˆå¯¹æŸäº›ç‰¹å®šçš„è¿›ç¨‹ç»„ï¼ˆå¦‚éœ€è¦æ›´é•¿æ—¶é—´ç‰‡ï¼Œæ›´é«˜ä¼˜å…ˆçº§ç­‰ï¼‰åº”ç”¨ç‰¹æ®Šçš„è°ƒåº¦å†³ç­–ã€‚Linux å†…æ ¸ç›®å‰æ”¯æŒçš„è°ƒåº¦ç­–ç•¥å¦‚ä¸‹ï¼š SCHED_NORMALï¼šæ™®é€šä»»åŠ¡ä½¿ç”¨çš„è°ƒåº¦ç­–ç•¥ï¼› SCHED_BATCHï¼šä¸åƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œå¯å…è®¸ä»»åŠ¡è¿è¡Œå°½å¯èƒ½é•¿çš„æ—¶é—´ï¼Œä»è€Œæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ï¼Œä½†æ˜¯ä»£ä»·è‡ªç„¶æ˜¯æŸå¤±äº¤äº’æ€§èƒ½ã€‚è¿™ç§éå¸¸é€‚åˆæ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼ˆæ‰¹é‡çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼‰; SCHED_IDLEï¼šå®ƒè¦æ¯” nice 19 çš„ä»»åŠ¡ä¼˜å…ˆçº§è¿˜è¦ä½ï¼Œä½†å®ƒå¹¶éçœŸçš„ç©ºé—²ä»»åŠ¡; SCHED_FIFO å’Œ SCHED_RR æ˜¯è½¯å®æ—¶è¿›ç¨‹è°ƒåº¦ç­–ç•¥ã€‚å®ƒä»¬æ˜¯ç”± POSIX æ ‡å‡†å®šä¹‰çš„ï¼Œç”± &lt;kernel/sched/rt.c&gt; é‡Œé¢å®šä¹‰çš„å®æ—¶è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ã€‚RR å®ç°çš„æ˜¯å¸¦æœ‰å›ºå®šæ—¶é—´ç‰‡çš„è½®è½¬è°ƒåº¦æ–¹å¼ï¼›SCHED_FIFO åˆ™ä½¿ç”¨çš„æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æœºåˆ¶ã€‚ cpus_allowedï¼šç”¨æ¥è¡¨ç¤ºä»»åŠ¡çš„ CPU äº²å’Œæ€§ã€‚ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡ sched_setaffinity ç³»ç»Ÿè°ƒç”¨æ¥è®¾ç½®ã€‚ ä¼˜å…ˆçº§ Priorityè¿›ç¨‹ä¼˜å…ˆçº§æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§æ‰€æœ‰çš„ç±» Unix æ“ä½œç³»ç»Ÿéƒ½å®ç°äº†ä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªå€¼ï¼Œç„¶åé€šè¿‡è¯¥å€¼å†³å®šä»»åŠ¡çš„é‡è¦ç¨‹åº¦ã€‚å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸€è‡´ï¼Œåˆ™ä¸€æ¬¡é‡å¤è¿è¡Œå®ƒä»¬ã€‚åœ¨ Linux ä¸­ï¼Œæ¯ä¸€ä¸ªæ™®é€šä»»åŠ¡éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ª nice å€¼ï¼Œå®ƒçš„èŒƒå›´æ˜¯ -20 åˆ° +19ï¼Œä»»åŠ¡é»˜è®¤ nice å€¼æ˜¯ 0ã€‚ nice å€¼è¶Šé«˜ï¼Œä»»åŠ¡ä¼˜å…ˆçº§è¶Šä½ï¼ˆitâ€™s nice to othersï¼‰ã€‚Linux ä¸­å¯ä»¥ä½¿ç”¨ nice(int increment) ç³»ç»Ÿè°ƒç”¨æ¥ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°ä½äº &lt;kernel/shced/core.c&gt; ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åªèƒ½ä¸ºè¯¥ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹å¢åŠ  nice å€¼ï¼ˆå³é™ä½ä¼˜å…ˆçº§ï¼‰ã€‚å¦‚æœéœ€è¦å¢åŠ ä¼˜å…ˆçº§ï¼ˆå‡å°‘ nice å€¼ï¼‰ï¼Œæˆ–è€…ä¿®æ”¹å…¶å®ƒç”¨æˆ·è¿›ç¨‹ä¼˜å…ˆçº§ï¼Œåˆ™å¿…é¡»ä»¥ root èº«ä»½æ“ä½œã€‚ å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§åœ¨ Linux ä¸­ï¼Œé™¤äº†æ™®é€šä»»åŠ¡å¤–ï¼Œè¿˜æœ‰ä¸€ç±»ä»»åŠ¡å±äºå®æ—¶ä»»åŠ¡ã€‚å®æ—¶ä»»åŠ¡æ˜¯ç¡®ä¿å®ƒä»¬èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæœ‰ä¸¤ç±»å®æ—¶ä»»åŠ¡ï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š ç¡¬å®æ—¶ä»»åŠ¡ï¼šä¼šæœ‰ä¸¥æ ¼çš„æ—¶é—´é™åˆ¶ï¼Œä»»åŠ¡å¿…é¡»åœ¨æ—¶é™å†…å®Œæˆã€‚æ¯”å¦‚ç›´å‡æœºçš„é£æ§ç³»ç»Ÿï¼Œå°±éœ€è¦åŠæ—¶å“åº”é©¾é©¶å‘˜çš„æ“æ§ï¼Œå¹¶åšå‡ºé¢„æœŸçš„åŠ¨ä½œã€‚ç„¶è€Œï¼ŒLinux æœ¬èº«å¹¶ä¸æ”¯æŒç¡¬å®æ—¶ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰ä¸€äº›åŸºäºå®ƒä¿®æ”¹çš„ç‰ˆæœ¬ï¼Œå¦‚ RTLinuxï¼ˆå®ƒä»¬é€šå¸¸è¢«ç§°ä¸º RTOSï¼‰åˆ™æ˜¯æ”¯æŒç¡¬å®æ—¶è°ƒåº¦çš„ã€‚ è½¯å®æ—¶ä»»åŠ¡ï¼šè½¯å®æ—¶ä»»åŠ¡å…¶å®ä¹Ÿä¼šæœ‰æ—¶é—´é™åˆ¶ï¼Œä½†ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»åŠ¡æ™šä¸€ç‚¹è¿è¡Œä»»åŠ¡ï¼Œå¹¶ä¸ä¼šé€ æˆä¸å¯æŒ½å›çš„ç¾éš¾æ€§äº‹æ•…ã€‚å®è·µä¸­ï¼Œè½¯å®æ—¶ä»»åŠ¡ä¼šæä¾›ä¸€å®šçš„æ—¶é—´é™åˆ¶ä¿éšœï¼Œä½†æ˜¯ä¸è¦è¿‡åº¦ä¾èµ–è¿™ç§ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼ŒVOIP è½¯ä»¶ä¼šä½¿ç”¨è½¯å®æ—¶ä¿éšœçš„åè®®ä¼ æ¥é€éŸ³è§†é¢‘ä¿¡å·ï¼Œä½†æ˜¯å³ä¾¿å› ä¸ºæ“ä½œç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œè€Œäº§ç”Ÿä¸€ç‚¹å»¶è¿Ÿï¼Œä¹Ÿä¸ä¼šé€ æˆå¾ˆå¤§å½±å“ã€‚æ— è®ºå¦‚ä½•ï¼Œè½¯å®æ—¶ä»»åŠ¡æ€»ä¼šæ¯”æ™®é€šä»»åŠ¡çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚ Linux ä¸­å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§èŒƒå›´æ˜¯ 0~99ï¼Œä½†æ˜¯æœ‰è¶£çš„æ˜¯ï¼Œå®ƒå’Œ nice å€¼çš„ä½œç”¨åˆšå¥½ç›¸åï¼Œè¿™é‡Œçš„ä¼˜å…ˆçº§å€¼è¶Šå¤§ï¼Œå°±æ„å‘³ç€ä¼˜å…ˆçº§è¶Šé«˜ã€‚ ç±»ä¼¼å…¶å®ƒçš„ Unix ç³»ç»Ÿï¼ŒLinux ä¹Ÿæ˜¯åŸºäº POSIX 1b æ ‡å‡†å®šä¹‰çš„ ã€ŒReal-time Extensionsã€å®ç°å®æ—¶ä¼˜å…ˆçº§ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å®æ—¶ä»»åŠ¡ï¼š 1$ ps -eo pid, rtprio, cmd ä¹Ÿå¯é€šè¿‡ chrt -p pid æŸ¥çœ‹å•ä¸ªè¿›ç¨‹çš„è¯¦æƒ…ã€‚Linux ä¸­å¯ä»¥é€šè¿‡ chrt -p prio pid æ›´æ”¹å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ“ä½œçš„æ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼ˆé€šå¸¸å¹¶ä¸ä¼šå°†æ™®é€šç”¨æˆ·çš„è¿›ç¨‹è®¾ç½®ä¸ºå®æ—¶çš„ï¼‰ï¼Œåˆ™å¿…é¡»æœ‰ root æƒé™æ‰å¯ä»¥ä¿®æ”¹å®æ—¶ä¼˜å…ˆçº§ã€‚ å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§å®æ—¶ä¸Šï¼Œå†…æ ¸çœ‹åˆ°çš„ä»»åŠ¡ä¼˜å…ˆçº§å’Œç”¨æˆ·çœ‹åˆ°çš„å¹¶ä¸ç›¸åŒï¼Œåœ¨è®¡ç®—å’Œç®¡ç†ä¼˜å…ˆçº§æ—¶ä¹Ÿéœ€è¦è€ƒè™‘å¾ˆå¤šæ–¹é¢ã€‚Linux å†…æ ¸ä¸­ä½¿ç”¨ 0~139 è¡¨ç¤ºä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”ï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼ˆæ³¨æ„å’Œç”¨æˆ·ç©ºé—´çš„åŒºåˆ«ï¼‰ã€‚å…¶ä¸­ 0~99 ä¿ç•™ç»™å®æ—¶è¿›ç¨‹ï¼Œ100~139ï¼ˆæ˜ å°„æˆ nice å€¼å°±æ˜¯ -20~19ï¼‰ä¿ç•™ç»™æ™®é€šè¿›ç¨‹ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ &lt;include/linux/sched/prio.h&gt; å¤´æ–‡ä»¶ä¸­çœ‹åˆ°å†…æ ¸è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§çš„å•ä½ï¼ˆscaleï¼‰å’Œå®å®šä¹‰ï¼ˆmacrosï¼‰ï¼Œå®ƒä»¬ç”¨æ¥å°†ç”¨æˆ·ç©ºé—´ä¼˜å…ˆçº§æ˜ å°„åˆ°åˆ°å†…æ ¸ç©ºé—´ã€‚1234567891011121314151617181920212223#define MAX_NICE 19#define MIN_NICE -20#define NICE_WIDTH (MAX_NICE - MIN_NICE + 1)â€¦#define MAX_USER_RT_PRIO 100#define MAX_RT_PRIO MAX_USER_RT_PRIO#define MAX_PRIO (MAX_RT_PRIO + NICE_WIDTH)#define DEFAULT_PRIO (MAX_RT_PRIO + NICE_WIDTH / 2)/** Convert user-nice values [ -20 ... 0 ... 19 ]* to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],* and back.*/#define NICE_TO_PRIO(nice) ((nice) + DEFAULT_PRIO)#define PRIO_TO_NICE(prio) ((prio) - DEFAULT_PRIO)/** 'User priority' is the nice value converted to something we* can work with better when scaling various scheduler parameters,* it's a [ 0 ... 39 ] range.*/#define USER_PRIO(p) ((p)-MAX_RT_PRIO)#define TASK_USER_PRIO(p) USER_PRIO((p)-&gt;static_prio)#define MAX_USER_PRIO (USER_PRIO(MAX_PRIO)) ä¼˜å…ˆçº§è®¡ç®—åœ¨ task_struct ä¸­æœ‰å‡ ä¸ªå­—æ®µç”¨æ¥è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§ï¼š12int prio, static_prio, normal_prio;unsigned int rt_priority; static_prio æ˜¯ç”±ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾å®šçš„ã€Œé™æ€ã€ä¼˜å…ˆçº§æ˜ å°„æˆå†…æ ¸è¡¨ç¤ºçš„ä¼˜å…ˆçº§ï¼š1p-&gt;static_prio = NICE_TO_PRIO(nice_value); normal_prio å­˜æ”¾çš„æ˜¯åŸºäº static_prio å’Œè¿›ç¨‹è°ƒåº¦ç­–ç•¥ï¼ˆå®æ—¶æˆ–æ™®é€šï¼‰å†³å®šçš„ä¼˜å…ˆçº§ï¼Œç›¸åŒçš„é™æ€ä¼˜å…ˆçº§ï¼Œåœ¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥ä¸‹ï¼Œå¾—åˆ°çš„æ­£å¸¸ä¼˜å…ˆçº§æ˜¯ä¸åŒçš„ã€‚å­è¿›ç¨‹åœ¨ fork æ—¶ï¼Œä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ normal_prioã€‚ prio åˆ™æ˜¯ã€ŒåŠ¨æ€ä¼˜å…ˆçº§ã€ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ä¼˜å…ˆçº§ä¼šå‘ç”Ÿå˜åŠ¨ã€‚ä¸€ç§åœºæ™¯å°±æ˜¯ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡ç»™æŸä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡ä¸€æ®µæ—¶é—´ï¼Œä»è€ŒæŠ¢å å…¶å®ƒé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¸€æ—¦ static_prio ç¡®å®šï¼Œprio å­—æ®µå°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¡ç®—ï¼š12345678910111213141516171819202122232425262728293031p-&gt;prio = effective_prio(p);// kernel/sched/core.c ä¸­å®šä¹‰äº†è®¡ç®—æ–¹æ³•static int effective_prio(struct task_struct *p)&#123; p-&gt;normal_prio = normal_prio(p); /* * If we are RT tasks or we were boosted to RT priority, * keep the priority unchanged. Otherwise, update priority * to the normal priority: */ if (!rt_prio(p-&gt;prio)) return p-&gt;normal_prio; return p-&gt;prio;&#125;static inline int normal_prio(struct task_struct *p)&#123; int prio; if (task_has_dl_policy(p)) prio = MAX_DL_PRIO-1; else if (task_has_rt_policy(p)) prio = MAX_RT_PRIO-1 - p-&gt;rt_priority; else prio = __normal_prio(p); return prio;&#125;static inline int __normal_prio(struct task_struct *p)&#123; return p-&gt;static_prio;&#125; è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰ä¼˜å…ˆçº§ä¼šè®©ä¸€äº›ä»»åŠ¡æ¯”åˆ«çš„ä»»åŠ¡æ›´é‡è¦ï¼Œå› æ­¤ä¹Ÿä¼šè·å¾—æ›´å¤šçš„ CPU ä½¿ç”¨æ—¶é—´ã€‚nice å€¼å’Œæ—¶é—´ç‰‡çš„æ¯”ä¾‹å…³ç³»æ˜¯é€šè¿‡è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰è¿›è¡Œç»´æŠ¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ task_struct-&gt;se.load ä¸­çœ‹åˆ°è¿›ç¨‹çš„æƒé‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š12345678struct sched_entity &#123; struct load_weight load; /* for load-balancing */ â€¦&#125;struct load_weight &#123; unsigned long weight; u32 inv_weight;&#125;; ä¸ºäº†è®© nice å€¼çš„å˜åŒ–åæ˜ åˆ° CPU æ—¶é—´å˜åŒ–ç‰‡ä¸Šæ›´åŠ åˆç†ï¼ŒLinux å†…æ ¸ä¸­å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºæ˜ å°„ nice å€¼åˆ°æƒé‡ï¼š12345678910static const int prio_to_weight[40] = &#123; /* -20 */ 88761, 71755, 56483, 46273, 36291, /* -15 */ 29154, 23254, 18705, 14949, 11916, /* -10 */ 9548, 7620, 6100, 4904, 3906, /* -5 */ 3121, 2501, 1991, 1586, 1277, /* 0 */ 1024, 820, 655, 526, 423, /* 5 */ 335, 272, 215, 172, 137, /* 10 */ 110, 87, 70, 56, 45, /* 15 */ 36, 29, 23, 18, 15,&#125;; æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ä¸Šé¢çš„æ˜ å°„è¡¨ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªä¼˜å…ˆçº§éƒ½æ˜¯ 0 çš„ä»»åŠ¡ï¼Œæ¯ä¸ªéƒ½èƒ½è·å¾— 50% çš„ CPU æ—¶é—´ï¼ˆ1024 / (1024 + 1024) = 0.5ï¼‰ã€‚å¦‚æœçªç„¶ç»™å…¶ä¸­çš„ä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡äº† 1 ï¼ˆnice å€¼ -1ï¼‰ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªä»»åŠ¡åº”è¯¥ä¼šè·å¾—é¢å¤– 10% å·¦å³çš„ CPU æ—¶é—´ï¼Œè€Œå¦ä¸€ä¸ªåˆ™ä¼šå‡å°‘ 10% CPU æ—¶é—´ã€‚æ¥çœ‹çœ‹è®¡ç®—ç»“æœï¼š1277 / (1024 + 1277) â‰ˆ 0.55ï¼Œ1024 / (1024 + 1277) â‰ˆ 0.45ï¼ŒäºŒè€…å·®è·åˆšå¥½åœ¨ 10% å·¦å³ï¼Œç¬¦åˆé¢„æœŸã€‚å®Œæ•´çš„è®¡ç®—å‡½æ•°å®šä¹‰åœ¨ &lt;kernel/sched/core.c&gt; ä¸­ï¼š123456789101112131415static void set_load_weight(struct task_struct *p)&#123; int prio = p-&gt;static_prio - MAX_RT_PRIO; struct load_weight *load = &amp;p-&gt;se.load; /* * SCHED_IDLE tasks get minimal weight: */ if (p-&gt;policy == SCHED_IDLE) &#123; load-&gt;weight = scale_load(WEIGHT_IDLEPRIO); load-&gt;inv_weight = WMULT_IDLEPRIO; return; &#125; load-&gt;weight = scale_load(prio_to_weight[prio]); load-&gt;inv_weight = prio_to_wmult[prio];&#125; è°ƒåº¦ç±» Scheduling Classesè™½è¯´ Linux å†…æ ¸ä½¿ç”¨çš„ C è¯­è¨€å¹¶éæ‰€è°“çš„ OOP è¯­è¨€ï¼ˆæ²¡æœ‰ç±»ä¼¼ C++/Java ä¸­çš„ class æ¦‚å¿µï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ä»£ç ä¸­çœ‹åˆ°ä¸€äº›ä½¿ç”¨ C è¯­è¨€ç»“æ„ä½“ + å‡½æ•°æŒ‡é’ˆï¼ˆHooksï¼‰çš„æ–¹å¼æ¥æ¨¡æ‹Ÿé¢å‘å¯¹è±¡çš„æ–¹å¼ï¼ŒæŠ½è±¡è¡Œä¸ºå’Œæ•°æ®ã€‚è°ƒåº¦ç±»ä¹Ÿæ˜¯è¿™æ ·å®ç°çš„ï¼ˆæ­¤å¤–ï¼Œè¿˜æœ‰ inode_operations, super_block_operations ç­‰ï¼‰ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº &lt;kernel/shced/sched.h&gt;ï¼‰ï¼š1234567891011121314151617181920212223242526// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆå¦‚ SMP ç›¸å…³çš„ï¼‰struct sched_class &#123; // å¤šä¸ª sched_class æ˜¯é“¾æ¥åœ¨ä¸€èµ·çš„ const struct sched_class *next; // è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†è°ƒåº¦å•å…ƒï¼ˆå¦‚ä¸€ä¸ªä»»åŠ¡ï¼‰æ”¾åˆ° // é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶é€’å¢ `nr_running` å˜é‡ï¼ˆè¯¥å˜é‡è¡¨ç¤ºè¿è¡Œé˜Ÿåˆ—ä¸­å¯è¿è¡Œçš„ä»»åŠ¡æ•°ï¼‰ void (*enqueue_task) (struct rq *rq, struct task_struct *p, int flags); // è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¸å¯è¿è¡Œæ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†ä»»åŠ¡ç§»å‡ºé˜Ÿåˆ—ï¼ŒåŒæ—¶é€’å‡ `nr_running` void (*dequeue_task) (struct rq *rq, struct task_struct *p, int flags); // è¯¥ hook å¯ä»¥åœ¨ä»»åŠ¡éœ€è¦ä¸»åŠ¨æ”¾å¼ƒ CPU æ—¶è°ƒç”¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸ä¼šæ”¹å˜ // ä»»åŠ¡çš„å¯è¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ä¾ç„¶ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ã€‚ç±»ä¼¼äºå…ˆ dequeue_taskï¼Œ // å† enqueue_task void (*yield_task) (struct rq *rq); // è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨å¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡ void (*check_preempt_curr) (struct rq *rq, struct task_struct *p, int flags); // è¯¥ hook ç”¨æ¥é€‰æ‹©æœ€é€‚åˆè¿è¡Œçš„ä¸‹ä¸€ä¸ªä»»åŠ¡ struct task_struct * (*pick_next_task) (struct rq *rq, struct task_struct *prev); // è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¿®æ”¹è‡ªèº«çš„è°ƒåº¦ç±»æˆ–è€…ä»»åŠ¡ç»„æ—¶è°ƒç”¨ void (*set_curr_task) (struct rq *rq); // é€šå¸¸æ˜¯åœ¨æ—¶é’Ÿä¸­æ–­æ—¶è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»»åŠ¡åˆ‡æ¢ void (*task_tick) (struct rq *rq, struct task_struct *p, int queued); // å½“ä»»åŠ¡è¢« fork æ—¶é€šçŸ¥è°ƒåº¦å™¨ void (*task_fork) (struct task_struct *p); // å½“ä»»åŠ¡æŒ‚æ‰æ—¶é€šçŸ¥è°ƒåº¦å™¨ void (*task_dead) (struct task_struct *p);&#125;; å…³äºè°ƒåº¦ç­–ç•¥çš„å…·ä½“ç»†èŠ‚çš„å®ç°æœ‰å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š core.c åŒ…å«è°ƒåº¦å™¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼› fair.c å®ç°äº† CFSï¼ˆComple Faire Schedulerï¼Œå®Œå…¨å…¬å¹³ä»»åŠ¡è°ƒåº¦å™¨ï¼‰ è°ƒåº¦å™¨ï¼Œåº”ç”¨äºæ™®é€šä»»åŠ¡ï¼› rt.c å®ç°äº†å®æ—¶è°ƒåº¦ï¼Œåº”ç”¨äºå®æ—¶ä»»åŠ¡ï¼› idle_task.c å½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œçš„ä»»åŠ¡æ—¶ï¼Œä¼šè¿è¡Œç©ºé—²ä»»åŠ¡ã€‚å†…æ ¸æ˜¯åŸºäºä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼ˆSCHED_*ï¼‰æ¥å†³å®šä½¿ç”¨ä½•ç§è°ƒåº¦ç±»å®ç°ï¼Œå¹¶ä¼šè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚SCHED_NORMAL, SCHED_BATCH å’Œ SCHED_IDLE è¿›ç¨‹ä¼šæ˜ å°„åˆ° fair_sched_class ï¼ˆç”± CFS å®ç°ï¼‰ï¼›SCHED_RR å’Œ SCHED_FIFO åˆ™æ˜ å°„çš„ rt_sched_class ï¼ˆå®æ—¶è°ƒåº¦å™¨ï¼‰ã€‚ è¿è¡Œé˜Ÿåˆ— Run Queueæ‰€æœ‰å¯è¿è¡Œçš„ä»»åŠ¡æ˜¯æ”¾åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­çš„ï¼Œå¹¶ä¸”ç­‰å¾… CPU è¿è¡Œã€‚æ¯ä¸ª CPU æ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„è¿è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡ä»»æ„æ—¶åˆ»åªèƒ½å¤„äºå…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åœ¨å¤šå¤„ç†å™¨æœºå™¨ä¸­ï¼Œä¼šæœ‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»»åŠ¡å°±ä¼šè½¬ç§»åˆ°å…¶å®ƒ CPU ä¸Šè¿è¡Œçš„å¯èƒ½ã€‚ è¿è¡Œé˜Ÿåˆ—æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº &lt;kernel/sched/sched.h&gt;ï¼‰:1234567891011121314151617181920// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆSMP ç›¸å…³ï¼‰// è¿™ä¸ªæ˜¯æ¯ä¸ª CPU éƒ½ä¼šæœ‰çš„ä¸€ä¸ªä»»åŠ¡è¿è¡Œé˜Ÿåˆ—struct rq&#123; // è¡¨ç¤ºå½“å‰é˜Ÿåˆ—ä¸­æ€»å…±æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆåŒ…å«æ‰€æœ‰çš„ sched classï¼‰ unsigned int nr_running;#define CPU_LOAD_IDX_MAX 5 unsigned long cpu_load[CPU_LOAD_IDX_MAX]; // è¿è¡Œé˜Ÿåˆ—è´Ÿè½½è®°å½• struct load_weight load; // åµŒå¥—çš„ CFS è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ— struct cfs_rq cfs; // åµŒå¥—çš„å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ— struct rt_rq rt; // curr æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æè¿°ç¬¦ // idle åˆ™æŒ‡å‘ç©ºé—²è¿›ç¨‹æè¿°ç¬¦ï¼ˆå½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šå¯åŠ¨ï¼‰ struct task_struct *curr, *idle; u64 clock; int cpu;&#125; ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿå®æ—¶ä¸Šï¼Œè°ƒåº¦å‡½æ•° schedule() ä¼šåœ¨å¾ˆå¤šåœºæ™¯ä¸‹è¢«è°ƒç”¨ã€‚æœ‰çš„æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæœ‰çš„åˆ™æ˜¯éšå¼è°ƒç”¨ï¼ˆé€šè¿‡è®¾ç½® TIF_NEED_RESCHED æ¥æç¤ºæ“ä½œç³»ç»Ÿå°½å¿«è¿è¡Œè°ƒåº¦å‡½æ•°ï¼‰ã€‚ä»¥ä¸‹ä¸‰ä¸ªè°ƒåº¦æ—¶æœºå€¼å¾—å…³æ³¨ä¸‹ï¼š æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨ scheduler_tick() å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ›´æ–°ä¸€äº›å’Œè°ƒåº¦æœ‰å…³çš„æ•°æ®ç»Ÿè®¡ï¼Œå¹¶è§¦å‘è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦æ–¹æ³•ï¼Œä»è€Œé—´æ¥åœ°è¿›è¡Œè°ƒåº¦ã€‚ä»¥ 2.6.39 æºç ä¸ºä¾‹ï¼Œå¯èƒ½çš„è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š 123456scheduler_tickâ””â”€â”€ task_tick â””â”€â”€ entity_tick â””â”€â”€ check_preempt_tick â””â”€â”€ resched_task â””â”€â”€ set_tsk_need_resched å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è¿›å…¥ç¡çœ çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡ä¼šä¸»åŠ¨é‡Šæ”¾ CPUã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥ä»»åŠ¡ä¼šå› ä¸ºç­‰å¾…æŒ‡å®šçš„äº‹ä»¶è€Œç¡çœ ï¼Œå®ƒå¯ä»¥å°†è‡ªå·±æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨å¾ªç¯æ£€æŸ¥æœŸæœ›çš„æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚åœ¨è¿›å…¥ç¡çœ å‰ï¼Œä»»åŠ¡å¯ä»¥å°†è‡ªå·±çš„çŠ¶æ€è®¾ç½®ä¸º TASK_INTERRUPTABLEï¼ˆé™¤äº†ä»»åŠ¡è¦ç­‰å¾…çš„äº‹ä»¶å¯å”¤é†’å¤–ï¼Œä¹Ÿå¯ä»¥è¢«ä¿¡å·å”¤é†’ï¼‰æˆ–è€… TASK_UNINTERRUPTABLEï¼ˆè‡ªç„¶æ˜¯ä¸ä¼šç†ä¼šä¿¡å·å’¯ï¼‰ï¼Œç„¶åè°ƒç”¨ schedule() é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡è¿è¡Œã€‚ ç¡çœ çš„ä»»åŠ¡è¢«å”¤é†’ã€‚ä»»åŠ¡ç­‰å¾…çš„äº‹ä»¶å¯ä»¥åœ¨å…³è”çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šè°ƒç”¨ wake_up() å‡½æ•°å”¤é†’ä»»åŠ¡ï¼šç›¸å…³ä»»åŠ¡ä¼šå°†è‡ªå·±è®¾ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœå½“å‰å”¤é†’çš„ä»»åŠ¡ä¼˜å…ˆçº§æ¯”è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä»»ä½•ä»»åŠ¡éƒ½é«˜ï¼Œåˆ™ä¼šè®¾ç½® TIF_NEED_RESCHED æ ‡å¿—ï¼Œä»è€Œè®©æ“ä½œç³»ç»Ÿå°½å¿«è°ƒç”¨ schedule() å‡½æ•°ã€‚ Linux è°ƒåº¦å™¨æ—©æœŸç‰ˆæœ¬Linux 0.0.1 ç‰ˆæœ¬å°±å·²ç»æœ‰äº†ä¸€ä¸ªç®€å•çš„è°ƒåº¦å™¨ï¼Œå½“ç„¶å¹¶éé€‚åˆæ‹¥æœ‰ç‰¹åˆ«å¤šå¤„ç†å™¨çš„ç³»ç»Ÿã€‚è¯¥è°ƒåº¦å™¨åªç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„è¿›ç¨‹é˜Ÿåˆ—ï¼Œæ¯æ¬¡éƒ½éœ€è¦éå†è¯¥é˜Ÿåˆ—æ¥å¯»æ‰¾æ–°çš„è¿›ç¨‹æ‰§è¡Œï¼Œè€Œä¸”å¯¹ä»»åŠ¡æ•°é‡è¿˜æœ‰ä¸¥æ ¼é™åˆ¶ï¼ˆNR_TASKS åœ¨æœ€åˆçš„ç‰ˆæœ¬ä¸­åªæœ‰ 32ï¼‰ã€‚ä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„å§ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041// 'schedule()' is the scheduler function. // This is GOOD CODE! There probably won't be any reason to change // this, as it should work well in all circumstances (ie gives // IO-bound processes good response etc)...void schedule(void)&#123; int i, next, c; struct task_struct **p; // éå†æ‰€æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰ä¿¡å·ï¼Œåˆ™éœ€è¦å”¤é†’ `TASK_INTERRUPTABLE` çš„ä»»åŠ¡ for (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p) if (*p) &#123; if ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123; (*p)-&gt;signal |= (1 &lt;&lt; (SIGALRM - 1)); (*p)-&gt;alarm = 0; &#125; if ((*p)-&gt;signal &amp;&amp; (*p)-&gt;state == TASK_INTERRUPTIBLE) (*p)-&gt;state = TASK_RUNNING; &#125; while (1) &#123; c = -1; next = 0; i = NR_TASKS; p = &amp;task[NR_TASKS]; // éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ‰¾åˆ°æ—¶é—´ç‰‡æœ€é•¿çš„é‚£ä¸ª while (--i) &#123; if (!*--p) continue; if ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c) c = (*p)-&gt;counter, next = i; &#125; if (c) break; // éå†ä»»åŠ¡ï¼Œé‡æ–°è®¾å€¼æ—¶é—´ç‰‡ for (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p) if (*p) (*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; 1) + (*p)-&gt;priority; &#125; // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ switch_to(next);&#125; O(n)2.4 ç‰ˆæœ¬çš„ Linux å†…æ ¸ä½¿ç”¨çš„è°ƒåº¦ç®—æ³•éå¸¸ç®€å•å’Œç›´æ¥ï¼Œç”±äºæ¯æ¬¡åœ¨å¯»æ‰¾ä¸‹ä¸€ä¸ªä»»åŠ¡æ—¶éœ€è¦éå†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆé“¾è¡¨ï¼‰ï¼Œå› æ­¤è¢«ç§°ä¸º O(n) è°ƒåº¦å™¨ï¼ˆæ—¶é—´å¤æ‚åº¦ï¼‰ã€‚ å½“ç„¶ï¼Œè¯¥è°ƒåº¦å™¨è¦æ¯” 0.01 ç‰ˆæœ¬å†…æ ¸ä¸­çš„è°ƒåº¦ç®—æ³•ç¨å¾®å¤æ‚ç‚¹ï¼Œå®ƒå¼•å…¥äº† epoch æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯å°†æ—¶é—´åˆ†æˆçºªå…ƒï¼ˆepochsï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæ¯ä¸ªçºªå…ƒç»“æŸï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½åº”è¯¥è¿è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œè€Œä¸”é€šå¸¸ç”¨å…‰äº†å®ƒå½“å‰çš„æ—¶é—´ç‰‡ã€‚ä½†å®é™…ä¸Šï¼Œæœ‰äº›ä»»åŠ¡å¹¶æ²¡æœ‰å®Œå…¨ç”¨å®Œæ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆå®ƒå‰©ä½™æ—¶é—´ç‰‡çš„ä¸€åŠå°†ä¼šå’Œæ–°çš„æ—¶é—´ç‰‡ç›¸åŠ ï¼Œä»è€Œåœ¨ä¸‹ä¸€ä¸ªçºªå…ƒè¿è¡Œæ›´é•¿çš„æ—¶é—´ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹ schedule() ç®—æ³•çš„æ ¸å¿ƒæºç ï¼š123456789101112131415161718192021222324// schedule() ç®—æ³•ä¼šéå†æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆO(N)ï¼‰ï¼Œå¹¶ä¸”è®¡ç®—å‡ºæ¯ä¸ªä»»åŠ¡çš„// goodness å€¼ï¼Œä¸”æŒ‘é€‰å‡ºã€Œæœ€å¥½ã€çš„ä»»åŠ¡æ¥è¿è¡Œã€‚// ä»¥ä¸‹æ˜¯éƒ¨åˆ†æ ¸å¿ƒæºç ï¼Œä¸»è¦æ˜¯äº†è§£ä¸‹å®ƒçš„æ€è·¯ã€‚asmlinkage void schedule(void)&#123; // ä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æè¿°ç¬¦ï¼š // 1. prev: å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ // 2. next: ä¸‹ä¸€ä¸ªå°†è¿è¡Œçš„ä»»åŠ¡ // 3. p: å½“å‰æ­£åœ¨éå†çš„ä»»åŠ¡ struct task_struct *prev, *next, *p; int this_cpu, c; // c è¡¨ç¤ºæƒé‡å€¼repeat_schedule: // é»˜è®¤é€‰ä¸­çš„ä»»åŠ¡ next = idle_task(this_cpu); c = -1000; list_for_each(tmp, &amp;runqueue_head) &#123; p = list_entry(tmp, struct task_struct, run_list); if (can_schedule(p, this_cpu)) &#123; int weight = goodness(p, this_cpu, prev-&gt;active_mm); if (weight &gt; c) c = weight, next = p; &#125; &#125;&#125; æºç ä¸­çš„ goodness() å‡½æ•°ä¼šè®¡ç®—å‡ºä¸€ä¸ªæƒé‡å€¼ï¼Œå®ƒçš„ç®—æ³•åŸºæœ¬æ€æƒ³å°±æ˜¯åŸºäºè¿›ç¨‹æ‰€å‰©ä½™çš„æ—¶é’ŸèŠ‚æ‹æ•°ï¼ˆæ—¶é—´ç‰‡ï¼‰ï¼Œå†åŠ ä¸ŠåŸºäºè¿›ç¨‹ä¼˜å…ˆçº§çš„æƒé‡å€¼ã€‚è¿”å›å€¼å¦‚ä¸‹ï¼š -1000 è¡¨ç¤ºä¸è¦é€‰æ‹©è¯¥è¿›ç¨‹è¿è¡Œ 0 è¡¨ç¤ºæ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œéœ€è¦é‡æ–°è®¡ç®— countersï¼ˆå¯èƒ½ä¼šè¢«é€‰ä¸­è¿è¡Œï¼‰ æ­£æ•´æ•°ï¼šè¡¨ç¤º goodness å€¼ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰ +1000 è¡¨ç¤ºå®æ—¶è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥å°±è¦é€‰æ‹©å®ƒè¿è¡Œ æœ€åï¼Œé’ˆå¯¹ O(n) è°ƒåº¦å™¨åšä¸‹æ€»ç»“ï¼š ç®—æ³•å®ç°éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¸é«˜æ•ˆï¼ˆä»»åŠ¡è¶Šå¤šï¼Œéå†è€—è´¹æ—¶é—´è¶Šä¹…ï¼‰ æ²¡æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§ï¼Œå¤šæ ¸å¤„ç†å™¨æ€ä¹ˆåŠï¼Ÿ å¯¹äºå®æ—¶ä»»åŠ¡è°ƒåº¦æ”¯æŒè¾ƒå¼±ï¼ˆæ— è®ºå¦‚ä½•ä½œä¸ºä¼˜å…ˆçº§é«˜çš„å®æ—¶ä»»åŠ¡éƒ½éœ€è¦åœ¨éå†å®Œåˆ—è¡¨åæ‰å¯ä»¥çŸ¥é“ï¼‰ O(1)Ingo MolnÃ¡r å¤§ä½¬åœ¨ 2.6 ç‰ˆæœ¬çš„å†…æ ¸ä¸­åŠ å…¥äº†å…¨æ–°çš„è°ƒåº¦ç®—æ³•ï¼Œå®ƒèƒ½å¤Ÿåœ¨å¸¸æ•°æ—¶é—´å†…è°ƒåº¦ä»»åŠ¡ï¼Œå› æ­¤è¢«ç§°ä¸º O(1) è°ƒåº¦å™¨ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå¼•å…¥çš„ä¸€äº›æ–°ç‰¹æ€§ï¼š å…¨å±€ä¼˜å…ˆçº§å•ä½ï¼ŒèŒƒå›´æ˜¯ 0~139ï¼Œæ•°å€¼è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜ å°†ä»»åŠ¡æ‹†åˆ†æˆå®æ—¶ï¼ˆ0~99ï¼‰å’Œæ­£å¸¸ï¼ˆ100~139ï¼‰ä¸¤éƒ¨åˆ†ã€‚æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡è·å¾—æ›´å¤šæ—¶é—´ç‰‡ å³åˆ»æŠ¢å ï¼ˆearly preemptionï¼‰ã€‚å½“ä»»åŠ¡çŠ¶æ€å˜æˆ TASK_RUNNING æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å…¶ä¼˜å…ˆçº§æ˜¯å¦æ¯”å½“å‰è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™æŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œåˆ‡æ¢åˆ°è¯¥ä»»åŠ¡ å®æ—¶ä»»åŠ¡ä½¿ç”¨é™æ€ä¼˜å…ˆçº§ æ™®é€šä»»åŠ¡ä½¿ç”¨ä½¿ç”¨åŠ¨æ€ä¼˜å…ˆçº§ã€‚ä»»åŠ¡ä¼˜å…ˆçº§ä¼šåœ¨å…¶ä½¿ç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡åé‡æ–°è®¡ç®—ï¼Œå†…æ ¸ä¼šè€ƒè™‘å®ƒè¿‡å»çš„è¡Œä¸ºï¼Œå†³å®šå®ƒçš„äº¤äº’æ€§ç­‰çº§ã€‚äº¤äº’å‹ä»»åŠ¡æ›´å®¹æ˜“å¾—åˆ°è°ƒåº¦ O(n) çš„è°ƒåº¦å™¨ä¼šåœ¨æ¯ä¸ªçºªå…ƒç»“æŸåï¼ˆæ‰€æœ‰ä»»åŠ¡çš„æ—¶é—´ç‰‡éƒ½ä½¿ç”¨è¿‡ï¼‰ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è€Œ O(1) åˆ™æ˜¯åœ¨æ¯ä¸ªä»»åŠ¡æ—¶é—´ç‰‡é…é¢ç”¨å®Œåå°±é‡æ–°è®¡ç®—ä¼˜å…ˆçº§ã€‚O(1) è°ƒåº¦å™¨ä¸ºæ¯ä¸ª CPU ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå³ active å’Œ expiredã€‚active é˜Ÿåˆ—å­˜æ”¾çš„æ˜¯æ—¶é—´ç‰‡å°šæœªç”¨å®Œçš„ä»»åŠ¡ï¼Œè€Œ expired åˆ™æ˜¯æ—¶é—´ç‰‡å·²ç»è€—å°½çš„ä»»åŠ¡ã€‚å½“ä¸€ä¸ªä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å®Œåï¼Œå°±ä¼šè¢«è½¬åˆ° expired é˜Ÿåˆ—ï¼Œè€Œä¸”ä¼šé‡æ–°è®¡ç®—å®ƒçš„ä¼˜å…ˆçº§ã€‚å½“ active é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨è½¬ç§»åˆ° expired é˜Ÿåˆ—åï¼Œä¼šäº¤æ¢äºŒè€…ï¼ˆè®© active æŒ‡å‘ expired é˜Ÿåˆ—ï¼Œexpired æŒ‡å‘ active é˜Ÿåˆ—ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œé˜Ÿåˆ—åˆ‡æ¢éƒ½å’Œä»»åŠ¡æ•°é‡å¤šå¯¡æ— å…³ï¼Œèƒ½å¤Ÿåœ¨ O(1) æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆã€‚ åœ¨å…ˆå‰ä»‹ç»çš„è°ƒåº¦ç®—æ³•ä¸­ï¼Œå¦‚æœæƒ³è¦å–ä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ï¼Œè¿˜éœ€è¦éå†æ•´ä¸ªä»»åŠ¡é“¾è¡¨æ‰å¯ä»¥ã€‚è€Œ O(1) è°ƒåº¦å™¨åˆ™å¾ˆç‰¹åˆ«ï¼Œå®ƒä¸ºæ¯ç§ä¼˜å…ˆçº§æä¾›äº†ä¸€ä¸ªä»»åŠ¡é“¾è¡¨ã€‚æ‰€æœ‰çš„å¯è¿è¡Œä»»åŠ¡ä¼šè¢«åˆ†æ•£åœ¨ä¸åŒä¼˜å…ˆçº§é˜Ÿåº”çš„é“¾è¡¨ä¸­ã€‚ æ¥ä¸‹æ¥çœ‹çœ‹å…¨æ–°çš„ runqueue æ˜¯æ€ä¹ˆå®šä¹‰çš„å§ï¼š123456struct runqueue &#123; unsigned long nr_running; /* å¯è¿è¡Œçš„ä»»åŠ¡æ€»æ•°ï¼ˆæŸä¸ª CPUï¼‰ */ struct prio_array *active; /* æŒ‡å‘ active çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */ struct prio_array *expired; /* æŒ‡å‘ expired çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */ struct prio_array arrays[2]; /* å®é™…å­˜æ”¾ä¸åŒä¼˜å…ˆçº§å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ */&#125; é€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥ç›´è§‚æ„Ÿå—ä¸‹ä»»åŠ¡é˜Ÿåˆ—ï¼š æ¥ä¸‹æ¥çœ‹çœ‹ prio_array æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼š12345struct prio_array &#123; int nr_active; /* åˆ—è¡¨ä¸­çš„ä»»åŠ¡æ€»æ•° */ unsigned long bitmap[BITMAP_SIZE]; /* ä½å›¾è¡¨ç¤ºå¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨æ˜¯å¦æœ‰ä»»åŠ¡å­˜åœ¨ */ struct list_head queue[MAX_PRIO]; /* ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¯ç§ä¼˜å…ˆçº§å¯¹åº”ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼‰ */&#125;; å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ prio_array ä¸­å­˜åœ¨ä¸€ä¸ªä½å›¾ï¼Œå®ƒæ˜¯ç”¨æ¥æ ‡è®°æ¯ä¸ª priority å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨æ˜¯å¦å­˜åœ¨ä»»åŠ¡çš„ã€‚æ¥ä¸‹æ¥çœ‹çœ‹ä¸ºä½• O(1) è°ƒåº¦å™¨å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´æ‰¾åˆ°éœ€è¦è¿è¡Œçš„ä»»åŠ¡ï¼š å¸¸æ•°æ—¶é—´ç¡®å®šä¼˜å…ˆçº§ï¼šé¦–å…ˆä¼šåœ¨ä½å›¾ä¸­æŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªè®¾ç½®ä¸º 1 çš„ä½ï¼ˆæ€»å…±æœ‰ 140 bitsï¼Œä»ç¬¬ä¸€ä¸ª bit å¼€å§‹æœç´¢ï¼Œè¿™æ ·å¯ä»¥ä¿è¯é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆå¾—åˆ°æœºä¼šè¿è¡Œï¼‰ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±å¯ä»¥ç¡®å®šå“ªä¸ªä¼˜å…ˆçº§æœ‰ä»»åŠ¡ï¼Œå‡è®¾æ‰¾åˆ°åçš„å€¼ä¸º priorityï¼› å¸¸æ•°æ—¶é—´è·å¾—ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼šåœ¨ queue[priority] å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ä¸­æå–ç¬¬ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼ˆå¤šä¸ªä»»åŠ¡ä¼šè½®è½¬æ‰§è¡Œï¼‰ã€‚ å¥½äº†ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸‹ O(1) è°ƒåº¦å™¨çš„ä¼˜ç¼ºç‚¹äº†ï¼š è®¾è®¡ä¸Šè¦æ¯” O(n) è°ƒåº¦å™¨æ›´åŠ å¤æ‚ç²¾å¦™ï¼› ç›¸å¯¹æ¥è¯´æ‰©å±•æ€§æ›´å¥½ï¼Œæ€§èƒ½æ›´ä¼˜ï¼Œåœ¨ä»»åŠ¡åˆ‡æ¢ä¸Šçš„å¼€é”€æ›´å°ï¼› ç”¨æ¥æ ‡è®°ä»»åŠ¡æ˜¯å¦ä¸ºäº¤äº’ç±»å‹çš„ç®—æ³•è¿˜æ˜¯è¿‡äºå¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚ StaircaseStaircase Scheduler æ˜¯ Con Kolivas ä¸ºäº†æ”¹å–„æ¡Œé¢ç³»ç»Ÿäº¤äº’åº”ç”¨çš„å“åº”æ—¶é—´è€Œå®ç°çš„è°ƒåº¦å™¨ï¼Œä½†å®ƒå¹¶éå†…æ ¸å®˜æ–¹æ”¯æŒçš„è°ƒåº¦å™¨ã€‚å®ƒçš„æ•´ä½“è®¾è®¡æ€æƒ³ç±»ä¼¼äº Operating Systems: The Three Easy Pieces ä¸­æåˆ°çš„ MLFQï¼ˆMultilevel Feedback Queueï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„è®¾è®¡æ€æƒ³ï¼š é¦–å…ˆï¼Œå®ƒä¹Ÿæ˜¯å°†ä»»åŠ¡æŒ‰ç…§ä¼˜å…ˆçº§æ”¾åœ¨ä¸åŒçš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆç±»ä¼¼ä¸Šé¢çš„ active é˜Ÿåˆ—ï¼‰ è°ƒåº¦å™¨æ¯æ¬¡ä¼šä»æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­è·å–ä¸€ä¸ªè¦åˆ‡æ¢æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ—¶é—´ç‰‡ä½¿ç”¨å®Œæ¯•åï¼Œä¼šå°†å…¶ä¼˜å…ˆçº§è°ƒä½ä¸€ä¸ªç­‰çº§ï¼Œç›´åˆ°å…¶ä¼˜å…ˆçº§é™åˆ°æœ€ä½ã€‚ å½“å¤„äºæœ€ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ç”¨å…‰äº†æ—¶é—´ç‰‡åï¼Œå®ƒä¼šè¢«é‡æ–°æ”¾åˆ°æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆè¿™ä¸ªæ–°çš„ä¼˜å…ˆçº§æ˜¯å®ƒä¹‹å‰æœ€é«˜ä¼˜å…ˆçº§å‡ 1 åçš„å€¼ï¼‰ï¼ŒåŒæ—¶ä¼šè·å¾—ä¸¤å€äºä¹‹å‰çš„æ—¶é—´ç‰‡ å¯¹äºé•¿æ—¶é—´ç¡çœ çš„ä»»åŠ¡ï¼Œä¼šè¢«æ”¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡é“¾è¡¨ã€‚æ‰€ä»¥äº¤äº’å¼ä»»åŠ¡å¯ä»¥ä¿æŒåœ¨æœ€é«˜ä¼˜å…ˆçº§ä½ç½®ï¼Œä»è€Œä¿æŒè‰¯å¥½çš„å“åº”æ€§èƒ½ï¼›è€Œæ‰¹å¤„ç†ä»»åŠ¡åˆ™å¤„äºä½ä¼˜å…ˆçº§ï¼Œä½†æ˜¯ä¼šè·å¾—æ›´å¤šçš„æ‰§è¡Œæ—¶é—´ã€‚ CFSå•æ ¸è°ƒåº¦CFS çš„å…¨ç§°æ˜¯ Complete Fair Schedulerï¼Œä¹Ÿå°±æ˜¯å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ã€‚å®ƒå®ç°äº†ä¸€ä¸ªåŸºäºæƒé‡çš„å…¬å¹³é˜Ÿåˆ—ç®—æ³•ï¼Œä»è€Œå°† CPU æ—¶é—´åˆ†é…ç»™å¤šä¸ªä»»åŠ¡ï¼ˆæ¯ä¸ªä»»åŠ¡çš„æƒé‡å’Œå®ƒçš„ nice å€¼æœ‰å…³ï¼Œnice å€¼è¶Šä½ï¼Œæƒé‡å€¼è¶Šé«˜ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è™šæ‹Ÿè¿è¡Œæ—¶é—´ vruntimeï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªä»»åŠ¡æ‰€ä½¿ç”¨çš„ CPU æ—¶é—´é™¤ä»¥å…¶ä¼˜å…ˆçº§å¾—åˆ°çš„å€¼ã€‚ç›¸åŒä¼˜å…ˆçº§å’Œç›¸åŒ vruntime çš„ä¸¤ä¸ªä»»åŠ¡å®é™…è¿è¡Œçš„æ—¶é—´ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œè¿™å°±æ„å‘³ç€ CPU èµ„æºæ˜¯ç”±å®ƒä»¬å‡åˆ†äº†ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰ä»»åŠ¡èƒ½å¤Ÿå…¬å¹³æ¨è¿›ï¼Œæ¯å½“éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡æ—¶ï¼ŒCFS æ€»ä¼šæŒ‘é€‰å‡º vruntime æœ€å°çš„é‚£ä¸ªä»»åŠ¡è¿è¡Œã€‚ å†…æ ¸ç‰ˆæœ¬åœ¨ 2.6.38 ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ä¼šè¢«å½“æˆç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå¹¶ä¸”å’Œç³»ç»Ÿä¸­å…¶å®ƒçº¿ç¨‹å…±äº«èµ„æºï¼Œè¿™å°±æ„å‘³ç€ä¸€ä¸ªå¤šçº¿ç¨‹çš„åº”ç”¨ä¼šæ¯”å•çº¿ç¨‹çš„åº”ç”¨è·å¾—æ›´å¤šçš„èµ„æºã€‚ä¹‹åï¼ŒCFS ä¸æ–­æ”¹è¿›ï¼Œç›®å‰å·²ç»æ”¯æŒå°†ä¸€ä¸ªåº”ç”¨ä¸­çš„çº¿ç¨‹æ‰“åŒ…åˆ° cgroup ç»“æ„ä¸­ï¼Œcgroup çš„ vruntime æ˜¯å…¶ä¸­æ‰€æœ‰çº¿ç¨‹çš„ vuntime ä¹‹å’Œã€‚ç„¶å CFS å°±å¯ä»¥å°†å®ƒçš„ç®—æ³•åº”ç”¨äºcgroup ä¹‹é—´ï¼Œä»è€Œä¿è¯å…¬å¹³æ€§ã€‚å½“æŸä¸ª cgroup è¢«é€‰ä¸­åï¼Œå…¶ä¸­æ‹¥æœ‰æœ€å° vruntime çš„çº¿ç¨‹ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œä¿è¯ cgroup ä¸­çš„çº¿ç¨‹ä¹‹é—´çš„å…¬å¹³æ€§ã€‚cgroup è¿˜å¯ä»¥åµŒå¥—ï¼Œä¾‹å¦‚ systemd ä¼šè‡ªåŠ¨é…ç½® cgroup æ¥ä¿è¯ä¸åŒç”¨æˆ·ä¹‹é—´çš„å…¬å¹³æ€§ï¼Œç„¶ååœ¨ç”¨æˆ·è¿è¡Œçš„å¤šä¸ªåº”ç”¨ä¹‹é—´ç»´æŒå…¬å¹³æ€§ã€‚ CFS é€šè¿‡åœ¨ä¸€å®šæ—¶é—´å†…è¿è¡Œè°ƒåº¦æ‰€æœ‰çš„çº¿ç¨‹æ¥é¿å…é¥¥é¥¿é—®é¢˜ã€‚å½“è¿è¡Œçš„ çº¿ç¨‹æ•°åœ¨ 8 ä¸ªåŠä»¥ä¸‹æ—¶ï¼Œé»˜è®¤çš„æ—¶é—´å‘¨æœŸæ˜¯ 48msï¼›è€Œå½“å¤šäº 8 ä¸ªçº¿ç¨‹æ—¶ï¼Œæ—¶é—´å‘¨æœŸå°±ä¼šéšç€çº¿ç¨‹æ•°é‡è€Œå¢åŠ ï¼ˆ6ms * çº¿ç¨‹æ•°ï¼Œä¹‹æ‰€ä»¥é€‰æ‹© 6msï¼Œæ˜¯ä¸ºäº†é¿å…é¢‘ç¹æŠ¢å ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹åˆ‡æ¢çš„å¼€é”€ï¼‰ã€‚ç”±äº CFS æ€»æ˜¯ä¼šæŒ‘é€‰ vruntime æœ€å°çš„çº¿ç¨‹æ‰§è¡Œï¼Œå®ƒå°±éœ€è¦é¿å…æŸä¸ªçº¿ç¨‹çš„ vruntime å¤ªå°ï¼Œä»¥è‡³äºå…¶å®ƒçº¿ç¨‹éœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½å¾—åˆ°è°ƒåº¦ï¼ˆä¼šæœ‰é¥¥é¥¿é—®é¢˜ï¼‰ã€‚æ‰€ä»¥åœ¨å®è·µä¸­ï¼ŒCFS ä¼šä¿è¯æ‰€æœ‰çº¿ç¨‹ä¹‹é—´çš„ vruntime ä¹‹å·®ä½äºæŠ¢å æ—¶é—´ï¼ˆ6msï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡å¦‚ä¸‹ä¸¤ç‚¹æ¥ä¿è¯çš„ï¼š å½“çº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå®ƒçš„ vruntime å€¼ç­‰äºè¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçº¿ç¨‹çš„æœ€å¤§ vruntimeï¼› å½“çº¿ç¨‹ä»ç¡çœ ä¸­å”¤é†’æ—¶ï¼Œå®ƒçš„ vruntime å€¼ä¼šè¢«æ›´æ–°ä¸ºå¤§äºæˆ–ç­‰äºæ‰€æœ‰å¾…è°ƒåº¦çº¿ç¨‹ä¸­æœ€å°çš„ vruntimeã€‚ä½¿ç”¨æœ€å° vruntime è¿˜å¯ä»¥ä¿è¯é¢‘ç¹ç¡çœ çš„çº¿ç¨‹ä¼˜å…ˆè¢«è°ƒåº¦ï¼Œè¿™å¯¹äºæ¡Œé¢ç³»ç»Ÿéå¸¸é€‚åˆï¼Œå®ƒä¼šå‡å°‘äº¤äº’åº”ç”¨çš„å“åº”å»¶è¿Ÿã€‚ CFS è¿˜å¼•å…¥äº†å¯å‘å¼è°ƒåº¦æ€æƒ³æ¥æ”¹å–„é«˜é€Ÿç¼“å­˜åˆ©ç”¨ç‡ã€‚ä¾‹å¦‚ï¼Œå½“çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥è¯¥çº¿ç¨‹çš„ vruntime å’Œæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ vruntime ä¹‹å·®æ˜¯å¦éå¸¸æ˜¾è‘—ï¼ˆä¸´ç•Œå€¼æ˜¯ 1msï¼‰ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™ä¸ä¼šæŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯è¿™ç§åšæ³•è¿˜æ˜¯ä»¥ç‰ºç‰²è°ƒåº¦å»¶è¿Ÿä¸ºä»£ä»·çš„ï¼Œç®—æ˜¯ä¸€ç§æƒè¡¡å§ã€‚ å¤šæ ¸è´Ÿè½½å‡è¡¡åœ¨å¤šæ ¸ç¯å¢ƒä¸­ï¼ŒLinux CFS ä¼šå°†å·¥ä½œï¼ˆworkï¼‰åˆ†æ‘Šåˆ°å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸­æ‰§è¡Œã€‚ä½†æ˜¯è¿™ä¸ç­‰åŒäºå°†çº¿ç¨‹å‡åˆ†åˆ°å¤šä¸ªå¤„ç†å™¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª CPU å¯†é›†å‹çš„çº¿ç¨‹å’Œ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹å¯èƒ½åˆ†åˆ«åœ¨ä¸¤ä¸ªæ ¸ä¸Šæ‰§è¡Œï¼Œå…¶ä¸­ä¸€ä¸ªä¸“é—¨æ‰§è¡Œ CPU å¯†é›†å‹çº¿ç¨‹ï¼›è€Œå¦ä¸€ä¸ªåˆ™å¤„ç†é‚£ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹ã€‚ ä¸ºäº†å¤šä¸ªå¤„ç†å™¨ä¸Šçš„å·¥ä½œé‡å‡è¡¡ï¼ŒCFS ä½¿ç”¨äº† load æŒ‡æ ‡æ¥è¡¡é‡çº¿ç¨‹å’Œå¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µã€‚çº¿ç¨‹çš„è´Ÿè½½å’Œçº¿ç¨‹çš„ CPU å¹³å‡ä½¿ç”¨ç‡ç›¸å…³ï¼šç»å¸¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½è¦ä½äºä¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½ã€‚ç±»ä¼¼ vruntimeï¼Œçº¿ç¨‹çš„è´Ÿè½½ä¹Ÿæ˜¯çº¿ç¨‹çš„ä¼˜å…ˆçº§åŠ æƒå¾—åˆ°çš„ã€‚è€Œå¤„ç†å™¨çš„è´Ÿè½½æ˜¯åœ¨è¯¥å¤„ç†å™¨ä¸Šå¯è¿è¡Œçº¿ç¨‹çš„è´Ÿè½½ä¹‹å’Œã€‚CFS ä¼šå°è¯•å‡è¡¡å¤„ç†å™¨çš„è´Ÿè½½ã€‚ CFS ä¼šåœ¨çº¿ç¨‹åˆ›å»ºå’Œå”¤é†’æ—¶å…³æ³¨å¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µï¼Œè°ƒåº¦å™¨é¦–å…ˆè¦å†³å®šå°†ä»»åŠ¡æ”¾åœ¨å“ªä¸ªå¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚è¿™é‡Œä¹Ÿä¼šæ¶‰åŠåˆ°å¯å‘å¼æ€æƒ³ï¼Œæ¯”å¦‚ï¼Œå¦‚æœ CFS æ£€æŸ¥åˆ°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé‚£ä¹ˆå®ƒä¼šå°†æ¶ˆè´¹è€…çº¿ç¨‹å°½å¯èƒ½åœ°åˆ†æ•£åˆ°æœºå™¨çš„å¤šä¸ªå¤„ç†å™¨ä¸Šï¼Œå› ä¸ºå¤šæ•°æ ¸å¿ƒéƒ½é€‚åˆå¤„ç†å”¤é†’çš„çº¿ç¨‹ã€‚ è´Ÿè½½å‡è¡¡è¿˜ä¼šå‘¨æœŸæ€§å‘ç”Ÿï¼Œæ¯éš” 4msï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå°è¯•ä»å…¶å®ƒå¤„ç†å™¨å·å–ä¸€äº›å·¥ä½œã€‚å½“ç„¶ï¼Œè¿™ç§ work-stealing å‡è¡¡æ–¹æ³•è¿˜ä¼šè€ƒè™‘æœºå™¨çš„æ‹“æ‰‘ç»“æ„ï¼šå¤„ç†å™¨ä¼šå°è¯•ä»è·ç¦»å®ƒä»¬ã€Œæ›´è¿‘ã€çš„å…¶å®ƒå¤„ç†å™¨ä¸Šå°è¯•çªƒå–å·¥ä½œï¼Œè€Œéè·ç¦»ã€Œæ›´è¿œã€çš„å¤„ç†å™¨ï¼ˆå¦‚è¿œç¨‹ NUMA èŠ‚ç‚¹ï¼‰ã€‚å½“å¤„ç†å™¨å†³å®šè¦ä»å…¶å®ƒå¤„ç†å™¨çªƒå–ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šå°è¯•åœ¨äºŒè€…ä¹‹é—´å‡è¡¡è´Ÿè½½ï¼Œå¹¶ä¸”ä¼šçªƒå–å¤šè¾¾ 32 ä¸ªçº¿ç¨‹ã€‚æ­¤å¤–ï¼Œå½“å¤„ç†å™¨è¿›å…¥ç©ºé—²çŠ¶æ€æ—¶ï¼Œå®ƒä¹Ÿä¼šç«‹åˆ»è°ƒç”¨è´Ÿè½½å‡è¡¡å™¨ã€‚ åœ¨å¤§å‹çš„ NUMA æœºå™¨ä¸Šï¼ŒCFS å¹¶ä¸ä¼šç²—æš´åœ°æ¯”è¾ƒæ‰€æœ‰ CPU çš„è´Ÿè½½ï¼Œè€Œæ˜¯ä»¥åˆ†å±‚çš„æ–¹å¼è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚ä»¥ä¸€å°æœ‰ä¸¤ä¸ª NUMA èŠ‚ç‚¹çš„æœºå™¨ä¸ºä¾‹ï¼ŒCFS ä¼šå…ˆåœ¨ NUMA èŠ‚ç‚¹å†…éƒ¨çš„å¤„ç†å™¨ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œç„¶åæ¯”è¾ƒ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½ï¼ˆé€šè¿‡èŠ‚ç‚¹å†…éƒ¨å¤„ç†å™¨è´Ÿè½½è®¡ç®—å¾—åˆ°ï¼‰ï¼Œå†å†³å®šè¦ä¸è¦åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¦‚æœ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½å·®è·åœ¨ 25% ä»¥å†…ï¼Œåˆ™ä¸ä¼šè¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ€»ç»“æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªå¤„ç†å™¨ï¼ˆæˆ–å¤„ç†å™¨ç»„ï¼‰ä¹‹é—´çš„è·ç¦»è¶Šè¿œï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä¸å¹³è¡¡æ€§å·®è·è¶Šå¤§çš„æƒ…å†µä¸‹æ‰ä¼šè€ƒè™‘è´Ÿè½½å‡è¡¡ã€‚ è¿è¡Œé˜Ÿåˆ—CFS å¼•å…¥äº†çº¢é»‘æ ‘ï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µåŠå¹³è¡¡äºŒå‰æ ‘ï¼Œå¯¹äºæ’å…¥å’ŒæŸ¥æ‰¾éƒ½æœ‰ O(log(N)) çš„æ—¶é—´å¤æ‚åº¦ï¼‰æ¥ç»´æŠ¤è¿è¡Œé˜Ÿåˆ—ï¼Œæ ‘çš„èŠ‚ç‚¹å€¼æ˜¯è°ƒåº¦å•å…ƒçš„ vruntimeï¼Œæ‹¥æœ‰æœ€å° vruntime çš„èŠ‚ç‚¹ä½äºæ ‘çš„æœ€å·¦ä¸‹è¾¹ã€‚ æ¥ä¸‹æ¥çœ‹çœ‹ cfs_rq æ•°æ®ç»“æ„çš„å®šä¹‰ï¼ˆä½äº &lt;kernel/sched/sched.h&gt;ï¼‰ï¼š123456789101112131415struct cfs_rq&#123; // æ‰€æœ‰ä»»åŠ¡çš„ç´¯è®¡æƒé‡å€¼ struct load_weight load; // è¡¨ç¤ºè¯¥é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ unsigned int nr_running; // è¿è¡Œé˜Ÿåˆ—ä¸­æœ€å°çš„ vruntime u64 min_vruntime; // çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ŒæŒ‡å‘è¿è¡Œä»»åŠ¡é˜Ÿåˆ— struct rb_root tasks_timeline; // ä¸‹ä¸€ä¸ªå³å°†è¢«è°ƒåº¦çš„ä»»åŠ¡ struct rb_node *rb_leftmost; // æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è°ƒåº¦å•å…ƒ struct sched_entity *curr;&#125; CFS ç®—æ³•å®é™…åº”ç”¨äºè°ƒåº¦å•å…ƒï¼ˆè¿™æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æŠ½è±¡ï¼Œå¯ä»¥æ˜¯çº¿ç¨‹ã€cgroups ç­‰ï¼‰ï¼Œè°ƒåº¦å•å…ƒæ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº &lt;include/linux/sched.h&gt;ï¼‰ï¼š123456789101112131415161718struct sched_entity&#123; // è¡¨ç¤ºè°ƒåº¦å•å…ƒçš„è´Ÿè½½æƒé‡ï¼ˆæ¯”å¦‚è¯¥è°ƒåº¦å•å…ƒæ˜¯ä¸€ä¸ªç»„ï¼Œåˆ™è¯¥å€¼å°±æ˜¯è¯¥ç»„ä¸‹æ‰€æœ‰çº¿ç¨‹çš„è´Ÿè½½æƒé‡çš„ç»„åˆï¼‰ struct load_weight load; /* for load-balancing */ // è¡¨ç¤ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹ struct rb_node run_node; // è¡¨ç¤ºå½“å‰è°ƒåº¦å•å…ƒæ˜¯å¦ä½äºè¿è¡Œé˜Ÿåˆ— unsigned int on_rq; // å¼€å§‹æ‰§è¡Œæ—¶é—´ u64 exec_start; // æ€»å…±è¿è¡Œçš„æ—¶é—´ï¼Œè¯¥å€¼æ˜¯é€šè¿‡ `update_curr()` æ›´æ–°çš„ã€‚ u64 sum_exec_runtime; // åŸºäºè™šæ‹Ÿæ—¶é’Ÿè®¡ç®—å‡ºè¯¥è°ƒåº¦å•å…ƒå·²è¿è¡Œçš„æ—¶é—´ u64 vruntime; // ç”¨äºè®°å½•ä¹‹å‰è¿è¡Œçš„æ—¶é—´ä¹‹å’Œ u64 prev_sum_exec_runtime;&#125;; è™šæ‹Ÿæ—¶é’Ÿå‰é¢æåˆ°çš„ vruntime ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆå«ä½œè™šæ‹Ÿè¿è¡Œæ—¶é—´å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±è¦æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ã€‚ä¸ºäº†æ›´å¥½åœ°å®ç°å…¬å¹³æ€§ï¼ŒCFS ä½¿ç”¨äº†è™šæ‹Ÿæ—¶é’Ÿæ¥æµ‹é‡ä¸€ä¸ªç­‰å¾…çš„è°ƒåº¦å•å…ƒåœ¨ä¸€ä¸ªå®Œå…¨å…¬å¹³çš„å¤„ç†å™¨ä¸Šå…è®¸æ‰§è¡Œçš„æ—¶é—´ã€‚ç„¶è€Œï¼Œè™šæ‹Ÿæ—¶é’Ÿå¹¶æ²¡æœ‰çœŸå®çš„å®ç°ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚ æˆ‘ä»¬å¯ä»¥åŸºäºçœŸå®æ—¶é—´å’Œä»»åŠ¡çš„è´Ÿè½½æƒé‡æ¥è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ï¼Œè¯¥ç®—æ³•æ˜¯åœ¨ update_cur() å‡½æ•°ä¸­å®ç°çš„ï¼Œå®ƒä¼šæ›´æ–°è°ƒåº¦å•å…ƒçš„æ—¶é—´è®°è´¦ä¿¡æ¯ï¼Œä»¥åŠ CFS è¿è¡Œé˜Ÿåˆ—çš„ min_vruntimeï¼ˆå®Œæ•´å®šä¹‰ä½äº &lt;kernel/sched/fair.c&gt;ï¼‰ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647static void update_curr(struct cfs_rq *cfs_rq)&#123; struct sched_entity *curr = cfs_rq-&gt;curr; u64 now = rq_clock_task(rq_of(cfs_rq)); u64 delta_exec; if (unlikely(!curr)) return; // è®¡ç®—å‡ºè°ƒåº¦å•å…ƒå¼€å§‹æ‰§è¡Œæ—¶é—´å’Œå½“å‰ä¹‹é—´çš„å·®å€¼ï¼Œå³çœŸå®è¿è¡Œæ—¶é—´ delta_exec = now - curr-&gt;exec_start; curr-&gt;vruntime += calc_delta_fair(delta_exec, curr); update_min_vruntime(cfs_rq);&#125;static inline u64 calc_delta_fair(u64 delta, struct sched_entity *se)&#123; // å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é»˜è®¤çš„ä¼˜å…ˆçº§ï¼ˆå†…éƒ¨ nice å€¼æ˜¯ 120ï¼‰ï¼Œé‚£ä¹ˆè™šæ‹Ÿè¿è¡Œæ—¶é—´ // å°±æ˜¯çœŸå®è¿è¡Œæ—¶é—´ã€‚å¦åˆ™ï¼Œä¼šåŸºäº `__calc_delta` è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ã€‚ if (unlikely(se-&gt;load.weight != NICE_0_LOAD)) // è¯¥è®¡ç®—è¿‡ç¨‹åŸºæœ¬ç­‰åŒäºï¼š // delta = delta_exec * NICE_0_LOAD / cur-&gt;load.weight; delta = __calc_delta(delta, NICE_0_LOAD, &amp;se-&gt;load); return delta;&#125;static void update_min_vruntime(struct cfs_rq *cfs_rq)&#123; u64 vruntime = cfs_rq-&gt;min_vruntime; if (cfs_rq-&gt;curr) // å¦‚æœæ­¤æ—¶æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œå°±æ›´æ–°æœ€å°è¿è¡Œæ—¶é—´ä¸ºå½“å‰ä»»åŠ¡çš„ vruntime vruntime = cfs_rq-&gt;curr-&gt;vruntime; if (cfs_rq-&gt;rb_leftmost) &#123; // è·å¾—ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è°ƒåº¦å•å…ƒ struct sched_entity *se = rb_entry(cfs_rq-&gt;rb_leftmost, struct sched_entity, run_node); if (!cfs_rq-&gt;curr) vruntime = se-&gt;vruntime; else // ä¿è¯ min_vruntime æ˜¯äºŒè€…ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªå€¼ vruntime = min_vruntime(vruntime, se-&gt;vruntime); &#125; // è¿™é‡Œä¹‹æ‰€ä»¥å»äºŒè€…ä¹‹é—´çš„æœ€å¤§å€¼ï¼Œæ˜¯ä¸ºäº†ä¿è¯ min_vruntime èƒ½å¤Ÿå•è°ƒå¢é•¿ // å¯ä»¥æƒ³æƒ³ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ cfs_rq-&gt;min_vruntime = max_vruntime(cfs_rq-&gt;min_vruntime, vruntime);&#125; æœ€åï¼Œæ¥æ€»ç»“ä¸‹ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿçš„æ„ä¹‰ï¼š å½“ä»»åŠ¡è¿è¡Œæ—¶ï¼Œå®ƒçš„è™šæ‹Ÿæ—¶é—´æ€»æ˜¯ä¼šå¢åŠ ï¼Œä»è€Œä¿è¯å®ƒä¼šè¢«ç§»åŠ¨åˆ°çº¢é»‘æ ‘çš„å³ä¾§ï¼› å¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè™šæ‹Ÿæ—¶é’Ÿçš„èŠ‚æ‹æ›´æ…¢ï¼Œä»è€Œè®©å®ƒç§»åŠ¨åˆ°çº¢é»‘æ ‘å³ä¾§çš„é€Ÿåº¦å°±è¶Šæ…¢ï¼Œå› æ­¤å®ƒä»¬è¢«å†æ¬¡è°ƒåº¦çš„æœºä¼šå°±æ›´å¤§äº›ã€‚ é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡CFS å¯ä»¥åœ¨çº¢é»‘æ ‘ä¸­ä¸€ç›´æ‰¾åˆ°æœ€å·¦ï¼ˆleftmostï¼‰è¾¹çš„èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªè¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯çœŸæ­£å®ç° __pick_first_entity() çš„å‡½æ•°å…¶å®å¹¶æ²¡æœ‰çœŸæ­£åœ°æ‰§è¡ŒæŸ¥æ‰¾ï¼ˆè™½ç„¶å¯ä»¥åœ¨ O(log(N)) æ—¶é—´å†…æ‰¾åˆ°ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼ˆå®Œæ•´å®šä¹‰ä½äº &lt;kernel/sched/fair.c&gt;ï¼‰ï¼š123456789struct sched_entity *__pick_first_entity(struct cfs_rq *cfs_rq)&#123; // å…¶å®è¿™é‡Œå–çš„æ˜¯ç¼“å­˜çš„ leftmost èŠ‚ç‚¹ // æ‰€ä»¥æ‰§è¡Œå°±ä¼šæ›´å¿«äº† struct rb_node *left = cfs_rq-&gt;rb_leftmost; if (!left) return NULL; return rb_entry(left, struct sched_entity, run_node);&#125; å®æ—¶è°ƒåº¦å™¨Linux å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨å®ç°ä½äº &lt;kernel/sched/rt.cï¼Œå¯¹äºç³»ç»Ÿè€Œè¨€ï¼Œå®æ—¶ä»»åŠ¡å±äºè´µå®¢ï¼Œä¸€æ—¦å­˜åœ¨å®æ—¶ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œé‚£å°±åº”å½“å°½å¯èƒ½åŠæ—¶åœ°ä¸ºå®ƒä»¬æœåŠ¡ã€‚å¯¹äºå®æ—¶ä»»åŠ¡è€Œè¨€ï¼Œæœ‰ä¸¤ç§è°ƒåº¦ç­–ç•¥å­˜åœ¨ï¼š SCHED_FIFO: è¿™ä¸ªå…¶å®å°±æ˜¯ä¸€ä¸ªå…ˆåˆ°å…ˆæœåŠ¡çš„è°ƒåº¦ç®—æ³•ã€‚è¿™ç±»ä»»åŠ¡æ²¡æœ‰æ—¶é—´ç‰‡é™åˆ¶ï¼Œå®ƒä»¬ä¼šä¸€ç›´è¿è¡Œç›´åˆ°é˜»å¡æˆ–è€…ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œäº¦æˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡æŠ¢å ã€‚è¯¥ç±»ä»»åŠ¡æ€»ä¼šæŠ¢å  SCHED_NORMAL ä»»åŠ¡ã€‚å¦‚æœå¤šä¸ªä»»åŠ¡å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œé‚£å®ƒä»¬ä¼šä»¥è½®è¯¢çš„æ–¹å¼è°ƒåº¦ï¼ˆä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œä¼šè¢«æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œï¼‰ï¼› SCHED_RR: è¿™ç§ç­–ç•¥ç±»ä¼¼äº SCHED_FIFOï¼Œåªæ˜¯å¤šäº†æ—¶é—´ç‰‡é™åˆ¶ã€‚ç›¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šä»¥è½®è¯¢çš„æ–¹å¼è¢«è°ƒåº¦ï¼Œæ¯ä¸ªè¿è¡Œçš„ä»»åŠ¡éƒ½ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å…¶ç”¨å…‰è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æŠ¢å ã€‚å½“ä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å…‰åï¼Œå®ƒä¼šé‡æ–°è¡¥å……èƒ½é‡ï¼Œå¹¶è¢«åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚é»˜è®¤çš„æ—¶é—´ç‰‡æ˜¯ 100msï¼Œå¯ä»¥åœ¨ &lt;include/linux/sched/rt.h&gt; æ‰¾åˆ°å…¶å®šä¹‰ã€‚ å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é™æ€çš„ï¼Œä¸ä¼šåƒä¹‹å‰æåˆ°çš„ç®—æ³•ï¼Œä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ chrt å‘½ä»¤æ›´æ”¹ä»»åŠ¡ä¼˜å…ˆçº§ã€‚ å®ç°ç»†èŠ‚å®æ—¶ä»»åŠ¡æœ‰è‡ªå·±çš„è°ƒåº¦å•å…ƒæ•°æ®ç»“æ„ï¼ˆä½äº &lt;include/linux/sched.h&gt;ï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š1234567891011struct sched_rt_entity&#123; struct list_head run_list; unsigned long timeout; unsigned long watchdog_stamp; unsigned int time_slice; struct sched_rt_entity *back; struct sched_rt_entity *parent; /* rq on which this entity is (to be) queued: */ struct rt_rq *rt_rq;&#125;; SCHED_FIFO çš„æ—¶é—´ç‰‡æ˜¯ 0ï¼Œå¯ä»¥åœ¨ &lt;kernel/sched/rt.c&gt; ä¸­çœ‹åˆ°å…·ä½“å®šä¹‰ï¼š1234567891011121314151617181920212223242526272829303132int sched_rr_timeslice = RR_TIMESLICE;static unsigned int get_rr_interval_rt(struct rq *rq, struct task_struct *task)&#123; if (task-&gt;policy == SCHED_RR) return sched_rr_timeslice; else return 0;&#125;``` è€Œå…³äºè¿è¡Œé˜Ÿåˆ—çš„å®šä¹‰å¦‚ä¸‹ï¼š```c/* Real-Time classes' related field in a runqueue: */struct rt_rq&#123; // æ‰€æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡éƒ½ä¿å­˜åœ¨ `active.queue[prio]` é“¾è¡¨ä¸­ struct rt_prio_array active; unsigned int rt_nr_running; struct rq *rq; /* main runqueue */&#125;;/** This is the priority-queue data structure of the RT scheduling class:*/struct rt_prio_array&#123; /* include 1 bit for delimiter */ // ç±»ä¼¼ O(1) è°ƒåº¦å™¨ï¼Œä½¿ç”¨ä½å›¾æ¥æ ‡è®°å¯¹åº”ä¼˜å…ˆçº§çš„é“¾è¡¨æ˜¯å¦ä¸ºç©º DECLARE_BITMAP(bitmap, MAX_RT_PRIO + 1); struct list_head queue[MAX_RT_PRIO];&#125;; ç±»ä¼¼äº CFS ä¸­çš„ update_curr() å‡½æ•°ï¼Œupdate_curr_rt() å‡½æ•°ç”¨æ¥è·Ÿè¸ªå®æ—¶ä»»åŠ¡çš„ CPU å ç”¨æƒ…å†µï¼Œæ”¶é›†ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ›´æ–°æ—¶é—´ç‰‡ç­‰ï¼Œä½†è¿™é‡Œä½¿ç”¨çš„æ˜¯çœŸå®æ—¶é—´ï¼Œè€Œæ²¡æœ‰è™šæ‹Ÿæ—¶é—´çš„æ¦‚å¿µã€‚å®Œæ•´å®šä¹‰å¯ä»¥å‚è€ƒ kernel/sched/rt.c#L955ã€‚ BFS &amp; MuqSSå…³äº BFS å’Œ MuqSS çš„ç²¾å½©ä»‹ç»å¯ä»¥å‚è€ƒ è¿™ç¯‡æ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ€»ä½“æ¥è¯´ï¼ŒBFS æ˜¯ä¸€ä¸ªé€‚ç”¨äºæ¡Œé¢æˆ–ç§»åŠ¨è®¾å¤‡çš„è°ƒåº¦å™¨ï¼Œè®¾è®¡åœ°æ¯”è¾ƒç®€æ´ï¼Œç”¨äºæ”¹å–„æ¡Œé¢åº”ç”¨çš„äº¤äº’æ€§ï¼Œå‡å°å“åº”æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚å®ƒé‡‡ç”¨äº†å…¨å±€å•ä»»åŠ¡é˜Ÿåˆ—è®¾è®¡ï¼Œä¸å†è®©æ¯ä¸ª CPU éƒ½æœ‰ç‹¬ç«‹çš„è¿è¡Œé˜Ÿåˆ—ã€‚è™½ç„¶ä½¿ç”¨å•ä¸ªå…¨å±€é˜Ÿåˆ—ï¼Œéœ€è¦å¼•å…¥é˜Ÿåˆ—é”æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ï¼Œä½†æ˜¯å¯¹äºæ¡Œé¢ç³»ç»Ÿè€Œè¨€ï¼Œå¤„ç†å™¨é€šå¸¸éƒ½æ¯”è¾ƒå°‘ï¼Œé”çš„å¼€é”€åŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚BFS æ¯æ¬¡ä¼šåœ¨ä»»åŠ¡é“¾è¡¨ä¸­é€‰æ‹©å…·æœ‰æœ€å° virtual deadline çš„ä»»åŠ¡è¿è¡Œã€‚ MuqSS æ˜¯ä½œè€…åæ¥åŸºäº BFS æ”¹è¿›çš„ä¸€æ¬¾è°ƒåº¦å™¨ï¼ŒåŒæ ·æ˜¯ç”¨äºæ¡Œé¢ç¯å¢ƒä»»åŠ¡è°ƒåº¦ã€‚å®ƒä¸»è¦è§£å†³äº† BFS çš„ä¸¤ä¸ªé—®é¢˜ï¼š æ¯æ¬¡éœ€è¦åœ¨å¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨ä¸­éå†æŸ¥æ‰¾éœ€è¦æ‰§è¡Œä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚æ‰€ä»¥æ–°çš„è°ƒåº¦å™¨å¼•å…¥äº†è·³è¡¨æ¥è§£å†³è¯¥é—®é¢˜ï¼Œä»è€Œå°†æ—¶é—´å¤æ‚åº¦é™ä½åˆ° O(1)ã€‚ å…¨å±€é”äº‰å¤ºçš„å¼€é”€ä¼˜åŒ–ï¼Œé‡‡ç”¨ try_lock æ›¿ä»£ lockã€‚ æ·±å…¥å­¦ä¹  ã€ŠLinux è®¾è®¡ä¸å®ç° ç¬¬ä¸‰ç‰ˆã€‹è¿›ç¨‹è°ƒåº¦ç« èŠ‚ A complete guide to Linux process scheduling Process Scheduling in Linux å†…æ ¸æ–‡æ¡£ï¼šCFS Scheduler è®¾è®¡ Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹ å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨ Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„ Linux å…¬å¹³è°ƒåº¦ å¯¹æ¯”äº†ä¼ ç»Ÿè°ƒåº¦å™¨å’Œ CFS çš„åŒºåˆ« ç®€å•ä»‹ç»äº† CFS çš„å®ç° The Battle of Schedulers: FreeBSD ULE vs Linux CFS é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ† å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ NUMA æ¶æ„æ·±ç©¶ æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„ NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³» Kernel è°ƒåº¦ç³»ç»Ÿ é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—® vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ ä¸¤ä¸ªéå¸¸æœ‰æ„æ€çš„é€‚åˆæ¡Œé¢ä½¿ç”¨çš„ Linux task è°ƒåº¦å™¨: BFS å’Œ MuqSS]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è°ƒåº¦å™¨</tag>
        <tag>CFS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux è°ƒåº¦å™¨å­¦ä¹ èµ„æ–™æ•´ç†]]></title>
    <url>%2F2019%2F11%2F05%2Flinux-kernel-scheduler-papers%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚ä¸€ç›´ä»¥æ¥ï¼Œå„è·¯ Linux Hackers éƒ½å¸Œæœ›èƒ½ä¸º Linux æä¾›è¿™æ ·ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ¡Œé¢ç³»ç»Ÿä¸Šæœ‰è¾ƒå¥½çš„äº¤äº’æ€§ï¼Œè€Œåœ¨é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šæœ‰è¾ƒå¥½çš„ååé‡ã€‚ ä»¥ä¸‹åˆ—ä¸¾ä¸€äº›å­¦ä¹ èµ„æ–™ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£ï¼ å­¦ä¹ èµ„æ–™ è®ºæ–‡ï¼šA complete guide to Linux process schedulingï¼Œè¿™ç¯‡è®ºæ–‡è®²å¾—æ¯”è¾ƒå¥½ï¼Œå‡†å¤‡ç¿»è¯‘å‡ºæ¥ä»¥ä¾›æ¬£èµ GitBook: Process Scheduling in Linux å†…æ ¸æ–‡æ¡£ï¼šLinux scheduler doc, CFS Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹ å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨ Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„ Linux å…¬å¹³è°ƒåº¦ The Battle of Schedulers: FreeBSD ULE vs Linux CFS é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ† å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ NUMA æ¶æ„æ·±ç©¶ æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„ NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³» Kernel è°ƒåº¦ç³»ç»Ÿ é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—® vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è°ƒåº¦å™¨</tag>
        <tag>CFS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux Kernel Development å­¦ä¹ ä¸æ€»ç»“]]></title>
    <url>%2F2019%2F10%2F30%2Flinux-kernel-dev-notes%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ€è¿‘æŠ½æ—¶é—´æŠŠ Operating Systems: Three Easy Pieces ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´ ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆLinux Kernel Developmentï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚åœ¨å­¦ä¹ ä¹‹å‰ï¼Œæ€è€ƒäº†ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥åœ¨å­¦ä¹ ä¸­æ¢ç´¢è¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼š Linux ä¸­è¿›ç¨‹ã€çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå„ç§è°ƒåº¦ç­–ç•¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ å¹¶å‘é—®é¢˜è‚¯å®šéœ€è¦æ³¨æ„ï¼ŒLinux ä¸­å¦‚ä½•åº”å¯¹ç«æ€æ¡ä»¶ &amp; æ•°æ®ç«äº‰å‘¢ï¼Ÿå„ç§å¸¸è§çš„åŒæ­¥åŸè¯­åˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ Linux çš„å†…å­˜è™šæ‹ŸåŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå†…å­˜å¸ƒå±€ï¼Ÿè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Ÿ æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ€ä¹ˆè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å¯¹ç”¨æˆ·æä¾›ä¸€è‡´ä¼˜é›…çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„å‘¢ï¼Ÿ Linux å†…æ ¸ä¸­æœ‰å“ªäº›éå¸¸ç»å…¸çš„ç®—æ³•å’Œæ•°æ®ç»“æ„çš„åº”ç”¨ï¼Ÿå®ƒä»¬ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ Linux å†…æ ¸ç®€ä»‹ è¯´åˆ° Linuxï¼Œå°±ä¸å¾—ä¸æåˆ°å®ƒçš„ç¥–å…ˆ Unix ç³»ç»Ÿã€‚Unix åœ¨ 1970 å¹´å·¦å³è¢« Ken Thompson é¦–å…ˆåœ¨ä¸€å° PDP-7 æœºå‹ä¸Šå®ç°ï¼Œè€Œåç§»æ¤åˆ° PDP-11 æœºå™¨ä¸Šï¼Œ1973 å¹´å®ƒè¢«ä½¿ç”¨ C è¯­è¨€é‡å†™ï¼Œæä¾›äº†æ›´åŠ å¼ºå¤§çš„å¯ç§»æ¤æ€§ã€‚ ç»è¿‡å¤šå¹´å‘å±•ï¼ŒUnix ç³»ç»Ÿæˆä¸ºäº†ä¸€ä¸ªå¼ºå¤§ã€å¥å£®ä¸”ç¨³å®šçš„æ“ä½œç³»ç»Ÿã€‚å…¶å¼ºå¤§çš„æ ¹æœ¬åŸå› å¦‚ä¸‹ï¼š ç®€æ´ï¼Œä»…æä¾›æ•°ç™¾ä¸ªè®¾è®¡ç›®æ ‡æ˜ç¡®çš„ç³»ç»Ÿè°ƒç”¨ï¼› æ‰€æœ‰çš„ä¸œè¥¿éƒ½è¢«å½“ä½œæ–‡ä»¶çœ‹å¾… å¾ˆå¼ºçš„ç§»æ¤èƒ½åŠ› è¿›ç¨‹åˆ›å»ºéå¸¸è¿…é€Ÿï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„ fork() ç³»ç»Ÿè°ƒç”¨ æ‹¥æœ‰ç®€å•ä¸”ç¨³å®šçš„è¿›ç¨‹é—´é€šä¿¡åŸè¯­ Linux æ˜¯ç±» Unix ç³»ç»Ÿï¼Œå®ƒçš„å®ç°å’Œ Unix ä¹Ÿæœ‰ä¸€äº›å¤§ç›¸å¾„åº­çš„æ–¹é¢ï¼Œä½†æ˜¯å®ƒä¾ç„¶ç»§æ‰¿äº† Unix çš„è®¾è®¡ç›®æ ‡ï¼Œä¿è¯äº† API çš„ä¸€è‡´æ€§ï¼ˆæœ‰å“ä½çš„ç¨‹åºå‘˜éƒ½åº”è¯¥è¦å­¦ä¹ è¿™ä¸€æ€æƒ³ï¼‰ã€‚ Linux è¯æ±‡ä¸€èˆ¬ç”¨æ¥æŒ‡ä»£å†…æ ¸ã€‚å®ƒçš„åŸºç¡€åŒ…æ‹¬ï¼š å†…æ ¸ C åº“ å·¥å…·é›† ç³»ç»Ÿçš„åŸºæœ¬å·¥å…·ï¼Œå¦‚ Shell ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿå®½æ³›çš„æ“ä½œç³»ç»Ÿæ˜¯æŒ‡æ•´ä¸ªç³»ç»Ÿä¸­è´Ÿè´£å®Œæˆæœ€åŸºæœ¬åŠŸèƒ½å’Œç³»ç»Ÿç®¡ç†çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬å†…æ ¸ã€è®¾å¤‡é©±åŠ¨ã€å¯åŠ¨å¼•å¯¼ç¨‹åºã€å‘½ä»¤è¡Œ Shell æˆ–ç”¨æˆ·ç•Œé¢ã€æ–‡ä»¶ç®¡ç†å·¥å…·å’Œç³»ç»Ÿå·¥å…·ã€‚å†…æ ¸åˆ™æ˜¯é‚£ä¸ªæœ€äº®çš„ä»”ï¼Œå®ƒé€šå¸¸ç”±å¦‚ä¸‹å‡ ä¸ªé‡è¦éƒ¨åˆ†ç»„æˆï¼š ä¸­æ–­æœåŠ¡ ä»»åŠ¡è°ƒåº¦ç¨‹åº å†…å­˜ç®¡ç†ç¨‹åº ç½‘ç»œ è¿›ç¨‹é—´é€šä¿¡ç­‰ç³»ç»ŸæœåŠ¡ Linux çš„ä¸­æ–­æœåŠ¡æ˜¯ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªä¸æ‰€æœ‰è¿›ç¨‹æ— å…³ã€ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ç¬¬ä¸€æ—¶é—´èƒ½å¤Ÿå“åº”å’Œå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œç„¶åå¿«é€Ÿé€€å‡ºã€‚ å¤„ç†å™¨åœ¨ä»»æ„æ—¶é—´ç‚¹æ´»åŠ¨å¯æ¦‚æ‹¬ä¸ºä»¥ä¸‹ä¸‰ç§ä¹‹ä¸€ï¼š è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹ è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä»£è¡¨æŸä¸ªç‰¹å®šçš„è¿›ç¨‹æ‰§è¡Œï¼ˆå¦‚æŸä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰ è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸è¿›ç¨‹æ— å…³ï¼Œå¤„ç†ç‰¹å®šçš„ä¸­æ–­ å¾®å†…æ ¸å’Œå®å†…æ ¸è¿™ä¸ªæ˜¯æ¯”è¾ƒæœ‰è¶£çš„å†å²äº†ï¼Œæ“ä½œç³»ç»Ÿè®¾è®¡æœ‰ä¸¤å¤§ä¸»è¦é˜µè¥ï¼šå¾®å†…æ ¸å’Œå®å†…æ ¸ã€‚ å¾®å†…æ ¸çš„åŠŸèƒ½åˆ’åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æ˜¯ä¸€ä¸ªæœåŠ¡ï¼ˆC/S æ¨¡å‹ï¼ŒæœåŠ¡ä¸å†…æ ¸äº¤äº’ï¼‰ã€‚ç³»ç»Ÿé‡‡ç”¨ IPC ç¦æ­¢äº’é€šæ¶ˆæ¯ï¼Œäº’æ¢ã€ŒæœåŠ¡ã€ã€‚æœåŠ¡çš„ç‹¬ç«‹æ€§å¯ä»¥é¿å…ä¸€ä¸ªæœåŠ¡å¤±è´¥æ®ƒåŠå…¶å®ƒæœåŠ¡ã€‚æ¨¡å—åŒ–è®¾è®¡ä¹Ÿéå¸¸é€‚åˆçƒ­æ’æ‹”ã€‚ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯ IPC çš„å¼€é”€å¤šäºå‡½æ•°è°ƒç”¨ï¼ˆç±»æ¯”å¾®æœåŠ¡çš„ç½‘ç»œå¼€é”€å’Œåœ¨æœ¬åœ°è°ƒç”¨å‡½æ•°çš„å¼€é”€ï¼‰ã€‚ å®å†…æ ¸åˆ™æ˜¯å®ç”¨ä¸»ä¹‰è€…å–œæ¬¢çš„è®¾è®¡ï¼Œå®ƒæ˜¯æ¯”è¾ƒç®€å•çš„è®¾è®¡ï¼Œæ•´ä½“ä¸Šå°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿‡ç¨‹ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ã€‚å†…æ ¸ä¹‹é—´çš„é€šä¿¡å¾®ä¸è¶³é“ï¼Œæ€§èƒ½é«˜ã€‚ Linux è‡ªç„¶æ˜¯å®å†…æ ¸è®¾è®¡ï¼ŒLinux å†…æ ¸è¿è¡Œåœ¨å•ç‹¬çš„å†…æ ¸åœ°å€ç©ºé—´ä¸Šã€‚åŒæ—¶å®ƒä¹Ÿé‡‡çº³äº†å¾®å†…æ ¸çš„ç²¾åï¼Œä½¿å®ƒæˆä¸ºæ¨¡å—åŒ–çš„ã€å¤šçº¿ç¨‹çš„ä»¥åŠå†…æ ¸æœ¬èº«å¯è°ƒåº¦çš„æ“ä½œç³»ç»Ÿã€‚ ä¸ä¼ ç»Ÿ Unix åŒºåˆ« æ”¯æŒåŠ¨æ€åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆè¿™ä¸ªä¸æ˜¯å¾®å†…æ ¸å®£ç§°çš„å¥½å¤„å—ï¼Ÿå’±ä¹Ÿæœ‰ï¼‰ æ”¯æŒå¯¹ç§°å¤šå¤„ç†æœºåˆ¶ï¼ˆSMPï¼‰ å†…æ ¸å¯ä»¥æŠ¢å ï¼ˆpreemptiveï¼‰ï¼šä»»åŠ¡å¯ä»¥æœ‰ä¼˜å…ˆçº§ å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒå¾ˆç‰¹åˆ«ï¼šå†…æ ¸ä¸åŒºåˆ†çº¿ç¨‹å’Œä¸€èˆ¬çš„è¿›ç¨‹ï¼Œå¯¹äºå†…æ ¸è€Œè¨€ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸€æ ·ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€äº›å…±äº«èµ„æºè€Œå·² å…·æœ‰è®¾å¤‡ç±»çš„é¢å‘å¯¹è±¡çš„è®¾å¤‡æ¨¡å‹ã€çƒ­æ’æ‹”äº‹ä»¶ï¼Œç”¨æˆ·ç©ºé—´çš„è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆsysfsï¼‰ å¿½ç•¥äº†ä¸€äº›æ‹™åŠ£ç‰¹æ€§ è‡ªç”±ï¼šä»»ä½•æ”¹å˜éƒ½å¿…é¡»è¦èƒ½é€šè¿‡ç®€æ´çš„è®¾è®¡åŠæ­£ç¡®å¯é çš„å®ç°æ¥è§£å†³ç°å®ä¸­ç¡®å®å­˜åœ¨çš„é—®é¢˜ å†…æ ¸ç‰ˆæœ¬&lt;ä¸»ç‰ˆæœ¬&gt;.&lt;ä»ç‰ˆæœ¬&gt;.&lt;ä¿®è®¢&gt;[.&lt;ç¨³å®šç‰ˆæœ¬å·&gt;]ï¼Œå…¶ä¸­ä»ç‰ˆæœ¬å·ä¸ºå¶æ•°ï¼Œåˆ™ä¸ºç¨³å®šç‰ˆæœ¬ï¼Œå¦åˆ™ä¸ºå¼€å‘ç‰ˆæœ¬ã€‚ å†…æ ¸ç¼–è¯‘é…ç½®å¯ä»¥ä½¿ç”¨çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š make config make menuconfig1 make gconfig é»˜è®¤é…ç½®ï¼šmake defconfig éªŒè¯å’Œæ›´æ–°é…ç½®ï¼šmake oldconfig ç¼–è¯‘ ç›´æ¥ç¼–è¯‘ï¼šmake å¯¼å‡ºä¸å…³å¿ƒçš„ infoï¼šmake &gt;/dev/null æŒ‡å®šå¹¶è¡Œç¼–è¯‘æ•°é‡ï¼šmake -j4 &gt;/dev/null å†…æ ¸å¼€å‘ç‰¹ç‚¹ ä¸èƒ½ä½¿ç”¨æ ‡å‡† C åº“ å¿…é¡»ä½¿ç”¨ GNU Cï¼ˆéœ€è¦ç”¨åˆ°å®ƒçš„ä¸€äº›æ‰©å±•ç‰¹æ€§ï¼‰ inlineï¼šé€šå¸¸å°†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå‡½æ•°æœ¬èº«æ¯”è¾ƒçŸ­çš„å®šä¹‰æˆå†…è”å‡½æ•°ã€‚åœ¨å†…æ ¸ä¸­ï¼Œä¸ºäº†ç±»å‹å®‰å…¨å’Œæ˜“è¯»æ€§ï¼Œä¼˜å…ˆä½¿ç”¨ inline å‡½æ•°ï¼Œè€Œéå¤æ‚çš„å® å†…è”ç¼–è¯‘ï¼šæ”¯æŒä½¿ç”¨ asm() åµŒå…¥æ±‡ç¼–ä»£ç  åˆ†æ”¯å£°æ˜ï¼šå¯ä»¥ä½¿ç”¨ likely() å’Œ unlikely() å£°æ˜åˆ†æ”¯æ˜¯å¦ç»å¸¸å‡ºç°æˆ–å¾ˆå°‘å‡ºç°ï¼ŒæŒ‡å¯¼ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ï¼ˆè¦ææ¸…æ¥šï¼Œå¦åˆ™ä¼˜åŒ–åè€Œå˜æˆäº†æ‹–ç´¯ï¼‰ ç¼ºä¹åƒç”¨æˆ·ç©ºé—´ä¸­çš„å†…å­˜ä¿æŠ¤æœºåˆ¶ å†…æ ¸ä¸­å‘ç”Ÿå†…å­˜é”™è¯¯ä¼šå¯¼è‡´ oopsï¼Œå†…æ ¸å¯èƒ½ä¼šæ­»æ‰ å†…æ ¸ä¸­çš„å†…å­˜æ˜¯ä¸åˆ†é¡µçš„ï¼Œæ¯ç”¨æ‰ä¸€ä¸ªå­—èŠ‚ï¼Œç‰©ç†å†…å­˜å°±å‡å°‘ä¸€ä¸ªå­—èŠ‚ éš¾ä»¥æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®— ä¸èƒ½åƒç”¨æˆ·ç©ºé—´æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—é‚£æ ·ï¼Œå¯ä»¥é€šè¿‡ trap çš„æ–¹å¼å°†æ•´æ•°æ¨¡å¼è½¬æ¢åˆ°æµ®ç‚¹æ•°æ¨¡å¼è®¡ç®— å†…æ ¸ä¸èƒ½å®Œç¾æ”¯æŒæµ®ç‚¹æ•°è®¡ç®—ï¼Œæœ¬èº«ä¹Ÿæ— æ³•é™·å…¥ã€‚éè¦æ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦æ‰‹åŠ¨ä¿å­˜å’Œæ¢å¤æµ®ç‚¹å¯„å­˜å™¨ï¼Œéå¸¸éº»çƒ¦ å†…æ ¸ç»™æ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªå¾ˆå°çš„å®šé•¿å †æ ˆ ç”¨æˆ·ç©ºé—´çš„æ ˆå¯ä»¥åŠ¨æ€å¢é•¿ï¼Œå¯æ”¯æŒéå¸¸å¤§çš„æ•°æ®ç»“æ„ å†…æ ¸æ ˆçš„å¤§å°å’Œä½“ç³»ç»“æ„æœ‰å…³ï¼ˆå¦‚ x86 å¯ä»¥æ˜¯ 4KB/8KBï¼‰ å†å²ä¸Šæ¥è¯´ï¼Œå†…æ ¸æ ˆå¤§å°æ˜¯ä¸¤é¡µï¼Œ32 ä½æ˜¯ 8KBï¼Œ64 ä½æ˜¯ 16KBï¼›æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„æ ˆ ç”±äºè¦æ”¯æŒå¼‚æ­¥ä¸­æ–­ã€æŠ¢å å’Œ SMPï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å®‰å…¨å’ŒåŒæ­¥ è€ƒè™‘å¯ç§»æ¤æ€§ ä¿æŒå­—èŠ‚åº 64 ä½å¯¹é½ ä¸å‡å®šå­—é•¿å’Œé¡µé¢é•¿åº¦ è¿›ç¨‹ç®¡ç†è¿›ç¨‹ å†…æ ¸æŠŠè¿›ç¨‹çš„åˆ—è¡¨å­˜æ”¾åœ¨ task list åŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ª entry çš„ç±»å‹æ˜¯ task_structï¼Œè¢«ç§°ä¸º process descriptor é€šè¿‡ slabï¼ˆæ›´æ–°çš„åº”è¯¥æ˜¯ SLUBï¼‰ åˆ†é…å™¨åˆ†é… task_struct ç»“æ„ä½“ï¼ˆå¯¹è±¡å¤ç”¨å’Œç¼“å­˜ç€è‰²ï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡çš„ thread_info ä½äºå†…æ ¸æ ˆçš„å°¾ç«¯ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘ task_struct çš„æŒ‡é’ˆåŠå…¶å®ƒä¿¡æ¯ è¿›ç¨‹é€šè¿‡ PID è¿›è¡ŒåŒºåˆ†ï¼Œå…¶å€¼å­˜æ”¾åœ¨ process descriptor ä¸­ã€‚ç”±äºè¿›ç¨‹å¤„ç†ä»£ç éœ€è¦é¢‘ç¹è®¿é—® task_struct ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ PowerPC ç­‰æœºå™¨ä¸Šï¼Œæœ‰ä¸“é—¨çš„å¯„å­˜å™¨å­˜å‚¨äº†ç›¸åº”çš„æŒ‡é’ˆï¼›è€Œåœ¨ x86 ä½“ç³»ä¸‹ï¼Œåˆ™æ˜¯åˆ©ç”¨å†…æ ¸æ ˆå°¾åˆ›å»ºçš„ thread_infoï¼Œå¹¶å€ŸåŠ©åç§»è®¡ç®—é—´æ¥æŸ¥æ‰¾ task_struct ç»“æ„ä½“ è¿›ç¨‹çŠ¶æ€ï¼š TASK_RUNNING TASK_INTERRUPTABLE TASK_UNINTERRUPTABLE __TASK_TRACED: è¢«å…¶å®ƒè¿›ç¨‹è·Ÿè¸ªçš„è¿›ç¨‹ï¼ˆå¦‚ ptrace å¯¹è°ƒè¯•ç¨‹åºè¿›è¡Œè·Ÿè¸ªï¼‰ __TASK_STOPPED: è¿›ç¨‹åœæ­¢æ‰§è¡Œï¼Œæ²¡æœ‰æŠ•å…¥è¿è¡Œä¹Ÿæ— æ³•æŠ•å…¥è¿è¡Œ æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ PID ä¸º 1 çš„ init è¿›ç¨‹çš„åä»£ï¼Œinit è¿›ç¨‹çš„æè¿°ç¬¦æ˜¯ä½œä¸º init_task é™æ€åˆ†é…çš„ï¼ˆæ¯”è¾ƒç‰¹æ®Šï¼‰ Unix ç³»ç»Ÿè¿›ç¨‹åˆ›å»ºï¼š é€šè¿‡ fork() æ‹·è´å½“å‰è¿›ç¨‹åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆåŒºåˆ«çˆ¶è¿›ç¨‹ï¼šæœ‰æ–°çš„ PIDï¼Œæœ‰æŸäº›èµ„æºå’Œç»Ÿè®¡é‡ï¼‰ exec() å‡½æ•°è´Ÿè´£è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¹¶å°†å…¶è½½å…¥åœ°å€ç©ºé—´å¼€å§‹è¿è¡Œ å†™æ—¶æ‹·è´ï¼šå†…æ ¸å¹¶éå¼€å§‹å°±å¤åˆ¶æ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè€Œæ˜¯è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ‹·è´ï¼Œåªæœ‰åœ¨éœ€è¦å†™å…¥çš„æ—¶å€™ï¼Œæ•°æ®æ‰ä¼šè¢«å¤åˆ¶ï¼Œä»è€Œæ‹¥æœ‰å„è‡ªçš„æ‹·è´ã€‚fork() å®é™…å¼€é”€ï¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œç»™å­è¿›ç¨‹åˆ›å»ºå”¯ä¸€çš„è¿›ç¨‹æè¿°ç¬¦ Linux ä¸­çš„ fork() å’Œ vfork() éƒ½æ˜¯é€šè¿‡ clone() ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚vfork() çš„ç‰¹ç‚¹æ˜¯ï¼šä¸æ‹·è´çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä¸”å­è¿›ç¨‹ä½œä¸ºçˆ¶è¿›ç¨‹çš„å•ç‹¬çº¿ç¨‹åœ¨å®ƒçš„åœ°å€ç©ºé—´æ‰§è¡Œï¼Œçˆ¶è¿›ç¨‹é˜»å¡ç›´åˆ°å­è¿›ç¨‹é€€å‡ºæˆ–æ‰§è¡Œ exec() Linux ä¸­çš„çº¿ç¨‹å®ç°ï¼š ä»å†…æ ¸è§’åº¦çœ‹ï¼Œæ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹çœ‹å¾…ï¼Œåªæ˜¯ä¸å…¶å®ƒè¿›ç¨‹å…±äº«æŸäº›èµ„æºã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰å±äºè‡ªå·±çš„ task_struct å…¶å®ƒç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹è¢«æŠ½è±¡æˆä¸€ç§è€—è´¹èµ„æºè¾ƒå°‘çš„èµ„æºï¼Œè¿è¡Œè¿…é€Ÿçš„æ‰§è¡Œå•å…ƒ é€šè¿‡ clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, 0); åˆ›å»ºçº¿ç¨‹ å¯¹æ¯” fork() å®ç°ï¼šclone(SIGCHLD, 0) å¯¹æ¯” vfork() å®ç°ï¼šclone(CLONE_VFORK | CLONE_VM | SIGCHLD, 0) å†…æ ¸çº¿ç¨‹ï¼š å†…æ ¸é€šå¸¸éœ€è¦åœ¨åå°æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè¿™äº›ä»»åŠ¡å¯é€šè¿‡ kernel thread å®Œæˆã€‚è¿™ç§æ˜¯è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„æ ‡å‡†è¿›ç¨‹ å†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¯è¢«è°ƒåº¦ï¼Œå¯è¢«æŠ¢å  è¿›ç¨‹ç»ˆç»“ï¼š é€šå¸¸é€šè¿‡ do_exit() å®Œæˆé€€å‡ºï¼ŒæœŸé—´ä¼šé‡Šæ”¾ç›¸å…³çš„èµ„æºï¼Œæœ€ç»ˆå°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º EXIT_ZOMBIEï¼Œä½†æ˜¯æ­¤æ—¶çš„å†…æ ¸æ ˆã€thread_info å’Œ task_struct ç»“æ„ä½“è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œç»™çˆ¶è¿›ç¨‹æä¾›ä¿¡æ¯ çˆ¶è¿›ç¨‹è·å¾—å·²ç»ˆç»“çš„å­è¿›ç¨‹ä¿¡æ¯åï¼ˆçˆ¶è¿›ç¨‹å¯é€šè¿‡ wait() ç³»ç»Ÿè°ƒç”¨æ”¶é›†ä¿¡æ¯ï¼‰ï¼Œæˆ–è€…é€šçŸ¥å†…æ ¸å®ƒä¸å…³æ³¨è¿™äº›ä¿¡æ¯ï¼Œæ‰ä¼šé‡Šæ”¾å‰©ä½™çš„å†…å­˜ç©ºé—´ å­¤å„¿è¿›ç¨‹ï¼š é€€å‡ºæ—¶æ°¸è¿œå¤„äºåƒµæ­»çŠ¶æ€ï¼Œç™½ç™½æµªè´¹å†…å­˜ è§£å†³åŠæ³•å°±æ˜¯åœ¨å½“å‰çº¿ç¨‹ç»„å¯»æ‰¾æŸä¸ªçº¿ç¨‹ä½œä¸ºçˆ¶äº²ï¼Œå®åœ¨ä¸è¡Œï¼Œå°±è®© init æ¥ç›˜ è°ƒåº¦è¿›ç¨‹ å¤šä»»åŠ¡ç³»ç»Ÿåˆ†ä¸ºä¸¤ç±»ï¼š éæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆcooperative multitaskingï¼‰ æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆpreemptive multitaskingï¼‰ è¿›ç¨‹è°ƒåº¦ç­–ç•¥ä¼šå…³å¿ƒè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡ Linux ä¸­çš„è¿›ç¨‹åˆ†ä¸ºæ™®é€šè¿›ç¨‹å’Œå®æ—¶è¿›ç¨‹ï¼Œå…¶ä¸­å‰è€…çš„ä¼˜å…ˆçº§åœ¨ (-20, +19ï¼‰ï¼Œè€Œåè€…åˆ™æ˜¯ (0, 99)ã€‚æ­¤å¤–ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºæ™®é€šè¿›ç¨‹ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜ å°„è¿‡æ¥å°±æ˜¯ (100, 139) Linux ä¸­å¯ä»¥é€šè¿‡ nice è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¶Šå°çš„å€¼æ‹¥æœ‰è¶Šé«˜çš„æƒé‡ï¼›åä¹‹ï¼Œåˆ™æƒé‡è¶Šä½ï¼ˆä½“ç°åœ¨æ—¶é—´ç‰‡ä¸Šï¼‰ CFS è°ƒåº¦å™¨ Linux 2.6 å†…æ ¸å¼•å…¥äº† CFS è°ƒåº¦å™¨ï¼ˆä½äº sched/fair.cï¼‰ä½œä¸ºæ™®é€šè¿›ç¨‹çš„è°ƒåº¦å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿‘ä¹å®Œç¾çš„å…¬å¹³è°ƒåº¦å™¨ï¼ˆæƒè¡¡å‘¨è½¬æ—¶é—´å’Œå“åº”æ—¶é—´ï¼‰ã€‚å¹¶éé‡‡ç”¨æ—¶é—´ç‰‡è¿›è¡Œåˆ†é…ï¼Œè€Œæ˜¯ç»™è¿›ç¨‹åˆ†é…äº†å¤„ç†å™¨ä½¿ç”¨çš„æ¯”é‡ï¼Œä»è€Œç¡®ä¿è¿›ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿæœ‰æ’å®šçš„å…¬å¹³æ€§ï¼Œä»è€Œå°†åˆ‡æ¢é¢‘ç‡ç½®äºä¸æ–­å˜åŠ¨ä¸­ CFS åŸºäºä¸€ä¸ªç®€å•çš„ç†å¿µï¼šè¿›ç¨‹è°ƒåº¦çš„æ•ˆæœåº”è¯¥ç­‰åŒäºç³»ç»Ÿæ‹¥æœ‰ä¸€ä¸ªå®Œç¾çš„å¤šä»»åŠ¡å¤„ç†å™¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½èƒ½è·å¾— 1/n_running å¤„ç†å™¨æ—¶é—´ CFS å…è®¸æ¯ä¸ªè¿›ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå¾ªç¯è½®è½¬ï¼Œæ€»æ˜¯é€‰æ‹© vruntime æœ€å°çš„è¿›ç¨‹ä½œä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯é€šè¿‡æ‰€æœ‰å¯è¿è¡Œç»å¸¸æ€»æ•°ä¸ºåŸºç¡€æ¥è®¡ç®—å‡ºè¿›ç¨‹åº”è¯¥è¿è¡Œå¤šä¹…ï¼Œè€Œéä¾é  nice å€¼æ¥è®¡ç®—æ—¶é—´ç‰‡ï¼ˆä¼ ç»Ÿçš„åšæ³•å°±æ˜¯è¿™ç§ï¼‰ è°ƒåº¦å™¨å®ç°æ¦‚è¦ï¼š sched_entity ç»“æ„ä½“è·Ÿè¸ªè¿è¡Œè®°è´¦ï¼ˆå…¶ä¸­åŒ…å« vruntimeï¼‰ æ‰€æœ‰å¯è¿è¡Œçš„è¿›ç¨‹éƒ½ä½äºä¸€æ£µé»‘çº¢æ ‘ä¸­ï¼ˆO(logN) æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾ï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½ä¼šä»æ ‘çš„æœ€å·¦å¶å­èŠ‚ç‚¹ä¸Šï¼ˆleftmostï¼‰æ‰¾åˆ° vruntime æœ€å°çš„é‚£ä¸ªè¿›ç¨‹è¿è¡Œï¼ˆå®æ—¶ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯æå‰ç¼“å­˜å¥½çš„ï¼‰ è°ƒåº¦å™¨å…¥å£å¤„ä¼šæ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„è°ƒåº¦ç±»ï¼Œç„¶åè·å–åˆ°è°æ˜¯ä¸‹ä¸€ä¸ªè¯¥è¿è¡Œçš„è¿›ç¨‹ ç¡çœ ï¼šè¿›ç¨‹ä¼šæŠŠè‡ªå·±æ ‡è®°æˆä¼‘çœ çŠ¶æ€ï¼Œä»å¯æ‰§è¡Œçº¢é»‘æ ‘ä¸­æº¢å‡ºï¼Œå¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè°ƒç”¨ schedule() æ‰§è¡Œä¸€ä¸ªå…¶ä»–è¿›ç¨‹ å”¤é†’ï¼šè¿›ç¨‹è¢«è®¾ç½®ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ç§»é™¤ï¼Œæ·»åŠ åˆ°å¯æ‰§è¡Œçº¢é»‘æ ‘ CFS å®ç°äº†å¦‚ä¸‹å‡ ç§è°ƒåº¦ç­–ç•¥ï¼š SCHED_NORMALï¼ˆä»¥å‰å«åš SCHED_OTHERï¼‰ï¼šç”¨äºæ™®é€šä»»åŠ¡è°ƒåº¦ SCHED_BATCHï¼šå¹¶éåƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œä¼šå°½å¯èƒ½å…è®¸ä»»åŠ¡è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ä¸Š CPU äº²å’Œæ€§ä»¥åŠæ›´å¥½åœ°å¤ç”¨ç¼“å­˜ SCHED_IDLEï¼šè¿™ç§ä»»åŠ¡ä¼˜å…ˆçº§æ¯” nice 19 è¿˜è¦ä½ æŠ¢å  ç”¨æˆ·æŠ¢å ï¼ˆæ£€æŸ¥ need_resched æ ‡è¯†ç¬¦ï¼‰ï¼šä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼›ä»ä¸­æ–­å¤„ç†è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ å†…æ ¸æŠ¢å ï¼ˆthread_info ä¸­å­˜åœ¨ preemt_count è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰æ²¡æœ‰é”è¢«æŒæœ‰ï¼‰ï¼šå°±æ˜¯è°ƒåº¦ç¨‹åºèƒ½å¤Ÿåœ¨å†…æ ¸ä»»åŠ¡æ‰§è¡ŒæœŸé—´è¢«æ‰§è¡Œ åªè¦é‡æ–°è°ƒåº¦æ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰æŒæœ‰é”ï¼‰ï¼Œå†…æ ¸å°±å¯ä»¥åœ¨ä»»ä½•æ—¶é—´æŠ¢å æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ å†…æ ¸æŠ¢å æ—¶æœºï¼š ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œä¸”è¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰ å†…æ ¸ä»£ç å†æ¬¡å…·æœ‰å¯æŠ¢å æ€§æ—¶ å†…æ ¸ä»»åŠ¡æ˜¾å¼è°ƒç”¨ schedule() å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡ï¼ˆæ­¤æ—¶ä¼šå¯¼è‡´è°ƒç”¨ schedule()ï¼‰ å®æ—¶è°ƒåº¦å™¨ å®æ—¶è°ƒåº¦å™¨æ˜¯åœ¨ sched/rt.c ä¸­å®ç°çš„ï¼Œå®ƒä½¿ç”¨äº† 100 ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼ˆå¯¹åº” 1~99 ä»»åŠ¡ä¼˜å…ˆçº§ï¼‰ï¼Œå®ç°äº† SCHED_FIFO å’Œ SCHED_RR ç­–ç•¥ã€‚ SCHED_FIFO: ç®€å•çš„å…ˆå…¥å…ˆå‡ºè°ƒåº¦ç®—æ³•ï¼Œä¸ä¾èµ–æ—¶é—´ç‰‡ è¯¥çº§åˆ«ä»»åŠ¡æ¯” SCHED_NORMAL çº§åˆ«çš„è¿›ç¨‹å…ˆå¾—åˆ°è°ƒåº¦ ä¸€æ—¦ä»»åŠ¡å¤„äºæ‰§è¡ŒæœŸé—´ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼›åªæœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ SCHED_FIFO/SCHED_RR ä»»åŠ¡æ‰å¯ä»¥æŠ¢å  SCHED_RR: ç±»ä¼¼ FIFOï¼Œä½†æ˜¯æ¯ä¸ªä»»åŠ¡ä¼šæœ‰åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡è€—å°½åå°±è¦æ¢å…¶å®ƒä»»åŠ¡æ‰§è¡Œ å¯¹äº FIFO è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§å§‹ç»ˆæŠ¢å ä½ä¼˜å…ˆçº§è¿›ç¨‹ï¼›ä½ä¼˜å…ˆçº§è¿›ç¨‹ä¸èƒ½æŠ¢å  SCHED_RR è¿›ç¨‹ï¼Œå³ä¾¿å…¶è€—å°½äº†æ—¶é—´ç‰‡ Linux æä¾›çš„æ˜¯è½¯å®æ—¶å·¥ä½œæ–¹å¼ï¼Œå°½åŠ›ä½¿å¾—è¿›ç¨‹èƒ½å¤Ÿåœ¨é™å®šçš„æ—¶é—´åˆ°æ¥å‰æ‰§è¡Œï¼Œä½†å†…æ ¸ä¸ä¿è¯æ€»èƒ½æ»¡è¶³è¿™äº›è¿›ç¨‹çš„è¦æ±‚ è°ƒåº¦å™¨ç±»è°ƒåº¦å™¨ç±»éœ€è¦å®ç°ä¸€äº› hooksï¼Œè¿™æ ·å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åšåˆé€‚çš„æ“ä½œã€‚éƒ¨åˆ† hooks å¦‚ä¸‹ï¼š enqueue_task dequeue_task yield_task check_preempt_cur pick_next_task set_curr_task task_tick è°ƒåº¦ç›¸å…³çš„ syscall ç³»ç»Ÿè°ƒç”¨ æè¿° nice() è®¾ç½®è¿›ç¨‹çš„ nice å€¼ sched_setscheduler() è®¾ç½®è°ƒåº¦ç­–ç•¥ sched_getscheduler() è·å–è°ƒåº¦ç­–ç•¥ sched_setparam() è®¾ç½®å®æ—¶ä¼˜å…ˆçº§ sched_getparam() sched_rr_get_interval() æ—¶é—´ç‰‡å€¼ sched_setaffinity() è®¾ç½®å¤„ç†å™¨äº²å’ŒåŠ› sched_getaffinity() è·å–è¿›ç¨‹å¤„ç†å™¨äº²å’ŒåŠ› shced_yield() æš‚æ—¶è®©å‡ºå¤„ç†å™¨ ç³»ç»Ÿè°ƒç”¨ä¼—æ‰€å‘¨çŸ¥ï¼Œè¿›ç¨‹æ˜¯åœ¨æ“ä½œç³»ç»Ÿæä¾›çš„ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ï¼Œè€Œå¦‚æœéœ€è¦æ‰“å¼€æ–‡ä»¶ç­‰æ“ä½œï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥åˆ°å†…æ ¸æ€ï¼Œç”±æ“ä½œç³»ç»Ÿä»£æ›¿å®Œæˆå’Œç¡¬ä»¶çš„äº¤äº’ï¼Œä»è€Œä¸ºè¿›ç¨‹æä¾›æœåŠ¡ã€‚æ‰€ä»¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨æ—¶åœ¨ç”¨æˆ·ç©ºé—´å’Œè¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚ã€‚è¿™ä¸ªä¸­é—´å±‚çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š ä¸ºç”¨æˆ·ç©ºé—´æä¾›ç¡¬ä»¶æ¥å£æŠ½è±¡ ç³»ç»Ÿè°ƒç”¨ä¿è¯ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®š æ“ä½œç³»ç»Ÿå¯ä»¥æŒæ§è¿›ç¨‹çš„ç¡¬ä»¶è®¿é—®æ„å›¾ï¼Œå¹¶ä¸”ä»£åŠ³ é‚£ä¹ˆç³»ç»Ÿè°ƒç”¨åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä¸€å¥è¯æ€»ç»“ä¸ºï¼šå½“ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶ï¼Œä¼šé™·å…¥åˆ°å†…æ ¸ï¼Œä¼ é€’ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•°ï¼Œæ‰§è¡Œæ­£ç¡®çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼å¸¦å›ç”¨æˆ·ç©ºé—´ã€‚å¯è§ï¼Œç³»ç»Ÿè°ƒç”¨éå¸¸ç‰¹æ®Šï¼Œå®Œå…¨ä¸åŒäºå¸¸è§„çš„å‡½æ•°è°ƒç”¨ï¼Œçœ‹èµ·æ¥éå¸¸ Hackã€‚ æ¥ä¸‹æ¥ï¼Œé€šè¿‡å‡ ä¸ªé—®é¢˜ï¼ŒåŠ æ·±å¯¹ä¸Šè¿°æè¿°çš„ç†è§£ï¼š å¦‚ä½•é™·å…¥åˆ°å†…æ ¸ï¼Ÿé€šè¿‡è½¯ä¸­æ–­çš„æ–¹å¼å®ç°ï¼Œé€šè¿‡å¼•å‘ä¸€ä¸ªå¼‚å¸¸è§¦å‘ç³»ç»Ÿåˆ‡æ¢åˆ°å†…æ ¸æ€æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚ ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿåœ¨ Linux ä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªç¼–å·ï¼Œè¿›ç¨‹å…¶å®æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·è€Œä¸æ˜¯åç§°æ¥å‘ŠçŸ¥å†…æ ¸è‡ªå·±ä¸­æ„å“ªä¸ªç³»ç»Ÿè°ƒç”¨çš„ã€‚ å¦‚ä½•ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿé€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œåœ¨ x86 ä¸­ï¼Œå°±æ˜¯å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨ eax å¯„å­˜å™¨ä¼ é€’ç»™å†…æ ¸çš„ã€‚ å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Ÿ ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯å°†å‚æ•°æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸€èˆ¬æ¥è¯´ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸ä¼šå¾ˆå¤šã€‚åœ¨ x86 ä¸­ï¼Œå¯ä»¥ç”¨ ebx, ecx, edx, esi å’Œ edi æŒ‰é¡ºåºå­˜æ”¾äº”ä¸ªå‚æ•°ã€‚ ç¬¬äºŒç§æ–¹å¼å°±æ˜¯å°†å‚æ•°å­˜æ”¾åœ¨ç”¨æˆ·ç©ºé—´å†…å­˜ä¸­ï¼Œå¹¶å°†å‚æ•°æŒ‡é’ˆå­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è¿™ç§æ˜¯ä¸ºäº†åº”ä»˜å‚æ•°è¶…è¿‡ 6 ä¸ªæƒ…å†µã€‚ è¿”å›å€¼å¦‚ä½•å¸¦ç»™ç”¨æˆ·ç©ºé—´ï¼Ÿå½“ç„¶ä¹Ÿæ˜¯é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’çš„ï¼Œåœ¨ x86 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ eax å¯„å­˜å™¨ã€‚ å†…æ ¸æ•°æ®ç»“æ„ Linux å†…æ ¸é“¾è¡¨å®ç°ç‹¬æ ‘ä¸€å¸œã€‚å®ƒæ˜¯å°†é“¾è¡¨å¡å…¥åˆ°æ•°æ®ç»“æ„ï¼Œè€Œéå¸¸è§„çš„é‚£ç§åœ¨æ•°æ®ç»“æ„ä¸­å¡å…¥é“¾è¡¨ã€‚ å¯ä»¥çœ‹ä¸‹å¯¹æ¯”å°±çŸ¥é“ä¸ºä½•ç‰¹åˆ«äº†ï¼š 1234567891011121314151617// å¸¸è§„å®šä¹‰æ–¹æ³•struct node &#123; void *data; struct node *prev; struct node *next;&#125;// Linux å†…æ ¸é“¾è¡¨å®šä¹‰struct list_head &#123; struct list_head *prev; struct list_head *next;&#125;struct node &#123; void *data; struct list_head list; // æ‰€æœ‰çš„ node å½¢æˆé“¾è¡¨&#125; è¿™æ ·ï¼Œé€šç”¨çš„é“¾è¡¨æ“ä½œå°±å¯ä»¥åŸºäº struct list_head æ¥å®ç°äº†ã€‚é‚£å¦‚ä½•å’Œæ ¹æ®é“¾è¡¨æŒ‡é’ˆè·å¾—å¯¹åº”çš„ node å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ container_of() å®ï¼Œå®é™…ä¸Š C è¯­è¨€ä¸­ï¼Œä¸€ä¸ªç»™å®šç»“æ„ä½“ä¸­çš„å˜é‡åç§»åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¯ä»¥å€Ÿæ­¤è·å¾—çˆ¶ç»“æ„ä¸­çš„ä»»æ„å˜é‡ï¼š123#define container_of(ptr, type, member) (&#123; \ const typeof( ((type *)0)-&gt;member) *__mptr = (ptr); \ (type *)( (char *)__mptr - offsetof(type, member) );&#125;) ä¸­æ–­å’Œä¸­æ–­å¤„ç† ä¸­æ–­æ˜¯å„ç§ç¡¬ä»¶è®¾å¤‡ä¸å¤„ç†å™¨ååŒé«˜æ•ˆå·¥ä½œçš„æ–¹å¼ä¹‹ä¸€ã€‚å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸€äº›å¤–éƒ¨è®¾å¤‡åˆ™ä¼šæ…¢å¾ˆå¤šï¼›ä¸ºäº†èƒ½å¤Ÿä¿è¯ CPU ä¸æµªè´¹æ—¶é—´è½®è¯¢è®¾å¤‡çŠ¶æ€ï¼Œè€Œé™ä½åˆ©ç”¨ç‡ï¼Œæ‰€ä»¥éœ€è¦ä¸­æ–­æœºåˆ¶æ¥é€šçŸ¥ CPUã€‚å½“å¤„ç†å™¨æ¥æ”¶åˆ°ä¸­æ–­åï¼Œä¼šå»æ‰§è¡Œå·²æ³¨å†Œçš„ç›¸å…³ä¸­æ–­å¤„ç†ç¨‹åºã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–­å’Œå‰é¢æåˆ°çš„å¼‚å¸¸ï¼ˆFaultï¼‰æ˜¯ä¸åŒçš„ï¼š ä¸­æ–­é€šå¸¸æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¸è€ƒè™‘æ—¶é’ŸåŒæ­¥ï¼› å¼‚å¸¸åˆ™å¿…é¡»ä¸å¤„ç†å™¨æ—¶é’ŸåŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥ä¸­æ–­ï¼ˆå¦‚é™¤ 0 é”™è¯¯ã€ç¼ºé¡µï¼‰ã€‚ Linux ä¸­å¯¹äºä¸­æ–­çš„å“åº”å’Œå¤„ç†åˆ†æˆä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ã€‚å…¶ä¸­ä¸ŠåŠéƒ¨ä¼šåœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·åå¿«é€Ÿå®Œæˆå¿…è¦å·¥ä½œçš„ï¼ˆæœ‰ä¸¥æ ¼çš„æ—¶é™ï¼‰ï¼Œè€Œæ›´åŠ ç¹é‡çš„ä»»åŠ¡åˆ™ä¼šåœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚åœ¨ä¸ŠåŠéƒ¨éœ€è¦å¿«é€Ÿæ‰§è¡Œï¼Œä¸”æ— æ³•ç¡çœ ï¼›ä½†ä¸‹åŠéƒ¨åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚ æ— é¡»é‡å…¥Linux ä¸­çš„ä¸­æ–­å¤„ç†ä¸ç”¨è€ƒè™‘é‡å…¥ï¼Œå› ä¸ºå½“ç»™å®šä¸­æ–­å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œå¯¹åº”ä¸­æ–­çº¿åœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šè¢«å±è”½ï¼Œé¿å…åŒä¸€ä¸­æ–­çº¿æ¥æ”¶å¦å¤–çš„ä¸­æ–­ã€‚è¿™æ ·åšç®€åŒ–äº†ä¸­æ–­å¤„ç†ç¨‹åºçš„ç¼–å†™ã€‚ ä¸­æ–­ä¸Šä¸‹æ–‡æ‰€è°“çš„ä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆinterrupt contextï¼‰ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚ä¸­æ–­ä¸Šä¸‹æ–‡å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡æ²¡æœ‰åŠæ¯›é’±å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œè¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œä¸€ç•ªå¯¹æ¯”ï¼š ä¸­æ–­ä¸Šä¸‹æ–‡ è¿›ç¨‹ä¸Šä¸‹æ–‡ æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡ å†…æ ¸ä»£è¡¨è¿›ç¨‹æ‰§è¡Œï¼ˆç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œå†…æ ¸çº¿ç¨‹ï¼‰æ—¶ï¼Œæ‰€å¤„çš„æ“ä½œæ¨¡å¼ ä¸è¿›ç¨‹æ— ç“œï¼Œä¸ current å®æ— ç“œ å¯é€šè¿‡ current å®å…³è”å½“å‰è¿›ç¨‹ æ²¡æœ‰åå¤‡è¿›ç¨‹ï¼Œæ— æ³•ç¡çœ ï¼Œä¹Ÿä¸èƒ½è°ƒç”¨ä¼šå¯¼è‡´ç¡çœ çš„å‡½æ•° å¯ç¡çœ ï¼Œå¯è°ƒç”¨è°ƒåº¦ç¨‹åº æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶é™ æ²¡æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œä¸‹åŠéƒ¨å°±æ˜¯æ‰§è¡Œå’Œä¸­æ–­å¤„ç†ç›¸å…³ï¼Œä½†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºä¸­ä¸ä¼šæ‰§è¡Œçš„å·¥ä½œã€‚å¼•å…¥ä¸‹åŠéƒ¨çš„ç›®çš„å°±æ˜¯è®©ä¸­æ–­å¤„ç†ç¨‹åºå°½å¯èƒ½åœ°ç®€çŸ­ã€å¿«é€Ÿï¼Œé¿å…å±è”½ä¸­æ–­å¤ªä¹…ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å“åº”èƒ½åŠ›å’Œæ€§èƒ½å—åˆ°å½±å“ï¼›è€Œæ¯”è¾ƒç¹é‡çš„å·¥ä½œå¯ä»¥åœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚ ä¸‹åŠéƒ¨ä¸»è¦å®ç°æ–¹å¼ï¼š è½¯ä¸­æ–­ å¯¹äºæ—¶é—´è¦æ±‚ä¸¥æ ¼ï¼Œä¸”èƒ½è‡ªå·±é«˜æ•ˆå®ŒæˆåŠ é”çš„å·¥ä½œï¼Œå¯ä½¿ç”¨è½¯ä¸­æ–­ï¼ˆå¦‚ç½‘ç»œã€SCSIï¼‰ è½¯ä¸­æ–­æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸å“åº”ä¸­æ–­ï¼Œä½†å®ƒè‡ªèº«ä¸èƒ½ç¡çœ  tasklet åŸºäºè½¯ä¸­æ–­å®ç°ï¼ŒåŒä¸€ä¸ªå¤„ç†ç¨‹åºçš„å¤šä¸ªå®ä¾‹ä¸èƒ½å†å¤šä¸ªå¤„ç†å™¨åŒæ—¶è¿è¡Œ ç”¨é€”å¹¿æ³›ï¼Œæ¥å£ç®€å•ï¼Œæ€§èƒ½ä¸é”™ ä¸èƒ½ç¡çœ  å·¥ä½œé˜Ÿåˆ—ä¸­çš„å·¥ä½œå¯ä»¥äº¤ç»™å†…æ ¸çº¿ç¨‹æ¨åæ‰§è¡Œï¼ˆä¼šåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¼˜åŠ¿ï¼Œä¸”å¯ä»¥é‡æ–°è°ƒåº¦å’Œç¡çœ  å†…æ ¸åŒæ­¥åœ¨è¿›è¡Œå†…æ ¸ç¼–ç¨‹æ—¶ï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ä¸´ç•ŒåŒºï¼Œæ­£ç¡®åŠ é”ã€è§£é”ï¼Œä¿è¯å…³é”®æ•°æ®ç»“æ„ä¸è¢«é”™è¯¯ä¿®æ”¹ã€‚é‚£ä¹ˆæœ‰å“ªäº›æƒ…å†µèƒ½é€ æˆå¹¶å‘é—®é¢˜å‘¢ï¼Ÿ ä¸­æ–­ï¼šå¼‚æ­¥å‘ç”Ÿï¼Œä¼šä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç  è½¯ä¸­æ–­å’Œ taskletï¼šå†…æ ¸ä¼šåœ¨ä»»æ„æ—¶åˆ»å”¤é†’è½¯ä¸­æ–­å’Œ taskletï¼Œæ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç  å†…æ ¸æŠ¢å ï¼šå†…æ ¸ä¸­çš„ä»»åŠ¡å¯èƒ½è¢«å…¶å®ƒä»»åŠ¡æŠ¢å  ç¡çœ åŠä¸ç”¨æˆ·ç©ºé—´åŒæ­¥ï¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œçš„è¿›ç¨‹å¯èƒ½ä¼šç¡çœ ï¼Œä»è€Œå¯¼è‡´è°ƒåº¦ç¨‹åºè¢«å”¤é†’ï¼Œå¹¶è¿è¡Œæ–°çš„ç”¨æˆ·è¿›ç¨‹ SMPï¼šå¤šä¸ªå¤„ç†å™¨ä¼šå¹¶è¡Œæ‰§è¡Œ å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†å†…æ ¸éœ€è¦åœ¨ç¡¬ä»¶ï¼ˆRTC å’Œ Timerï¼‰çš„å¸®åŠ©ä¸‹æ‰èƒ½è®¡ç®—å’Œç®¡ç†æ—¶é—´ï¼Œå†…æ ¸é€šè¿‡å·²çŸ¥çš„ï¼ˆè¿™ä¸ªæ—¶é’Ÿå‘¨æœŸæ˜¯å¯ç¼–ç¨‹çš„ï¼Œå¯ç¡®å®šçš„ï¼‰æ—¶é’Ÿä¸­æ–­é—´éš”æ¥è®¡ç®— wall time å’Œ jiffiesï¼ˆç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ€»æ•°ï¼‰ã€‚é‚£ä¹ˆï¼Œåœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ç©¶ç«Ÿä¼šåšå“ªäº›å·¥ä½œå‘¢ï¼Ÿä»¥ä¸‹ç»™å‡ºä¸€äº›ä¼šå‘¨æœŸæ‰§è¡Œçš„å·¥ä½œï¼š æ›´æ–°ç³»ç»Ÿè¿è¡Œæ—¶é—´å’Œå®é™…æ—¶é—´ å¯¹äº SMP ç³»ç»Ÿï¼Œéœ€è¦å‡è¡¡å„å¤„ç†å™¨ä¸Šçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœè¿è¡Œé˜Ÿåˆ—è´Ÿè½½ä¸å‡è¡¡ï¼Œéœ€è¦å°½é‡è®©å®ƒä»¬å‡è¡¡ æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦ç”¨å°½äº†è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œå¦‚æœæ—¶ï¼Œåˆ™é‡æ–°è¿›è¡Œè°ƒåº¦ è¿è¡Œè¶…æ—¶çš„åŠ¨æ€å®šæ—¶å™¨ æ›´æ–°èµ„æºæ¶ˆè€—å’Œå¤„ç†å™¨æ—¶é—´ç»Ÿè®¡å€¼ å†…å­˜ç®¡ç†é¡µå†…æ ¸æ˜¯æŠŠç‰©ç†å†…å­˜åˆ†é¡µç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µï¼ˆpageï¼‰æ˜¯æœ€åŸºæœ¬çš„ç®¡ç†å•å…ƒã€‚MMU ä¹Ÿæ˜¯ä»¥é¡µå¤§å°ä¸ºå•ä½è½¬æ¢è™šæ‹Ÿåœ°å€åˆ°ç¡¬ä»¶åœ°å€çš„ã€‚ä¸åŒçš„ä½“ç³»ç»“æ„ï¼Œé¡µå¤§å°ä¸åŒï¼Œä¸€èˆ¬ 32 ä½ç³»ç»Ÿæ˜¯ 4KBï¼Œ64 ä½ç³»ç»Ÿæ˜¯ 8KBã€‚ åŒºå› ä¸ºç¡¬ä»¶å­˜åœ¨é™åˆ¶ï¼Œå†…æ ¸æ— æ³•å¯¹æ‰€æœ‰çš„é¡µä¸€è§†åŒä»ã€‚å› æ­¤éœ€è¦æŠŠé¡µåˆ’åˆ†æˆä¸åŒçš„åŒºï¼ˆzoneï¼‰ï¼Œå†…æ ¸éœ€è¦å¤„ç†å¦‚ä¸‹å› ä¸ºç¡¬ä»¶ç¼ºé™·è€Œå¼•èµ·çš„å†…å­˜å¯»å€é—®é¢˜ï¼š ä¸€äº›ç¡¬ä»¶åªèƒ½ç”¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œ DMA æ“ä½œ ä¸€äº›ä½“ç³»ç»“æ„çš„å†…å­˜ç‰©ç†å¯»å€èŒƒå›´æ¯”è™šæ‹Ÿåœ°å€èŒƒå›´å¤§ å†…æ ¸çš„åˆ†åŒºæœ‰å››ç§ï¼š ZONE_DMAï¼šå¯æ‰§è¡Œ DMA æ“ä½œçš„é¡µé›†åˆ ZONE_DMA32ï¼šåŒä¸Šï¼Œä½†ä»…é™äº 32 ä½è®¾å¤‡ ZONE_NORMALï¼šèƒ½å¤Ÿæ­£å¸¸æ˜ å°„çš„é¡µ ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­çš„é¡µä¸èƒ½æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼ˆè¿™é‡Œé™äº 32 ä½åœ°å€ç©ºé—´ï¼Œ64 ä½å°±ä¸ä¼šæœ‰é—®é¢˜äº†ï¼‰ é¡µç”³è¯·å’Œé‡Šæ”¾ alloc_page(gfp_mask)ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘é¡µç»“æ„çš„æŒ‡é’ˆ alloc_pages(gfp_mask, order)ï¼šåˆ†é… 2^order ä¸ªè¿ç»­é¡µ __get_free_page(gfp_mask)ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘å…¶é€»è¾‘åœ°å€çš„æŒ‡é’ˆ __get_free_pages(gfp_mask, order)ï¼šåˆ†é… 2^order ä¸ªè¿ç»­ç‰©ç†é¡µï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ get_zeroed_page(gfp_mask)ï¼šåªåˆ†é…ä¸€é¡µï¼Œä¸”å¡«å…… 0 ï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ __free_pages(struct page *page, unsinged int order) free_pages(unsigned long addr, unsinged int order) free_page(unsigned long addr) kmallocvoid *kmalloc(size_t size, gfp_t flags)ï¼Œkmalloc() ç±»ä¼¼äº malloc()ï¼Œå¯ä»¥è·å¾—æŒ‡å®šå­—èŠ‚å¤§å°çš„å†…æ ¸å†…å­˜ï¼Œå®ƒåˆ†é…å¾—åˆ°çš„é¡µçš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯è¿ç»­çš„ã€‚void kfree(const void *ptr) é‡Šæ”¾åˆ†é…çš„å†…å­˜ç©ºé—´ å…³äºæ ‡è®°ä½ï¼Œå¸¸ç”¨çš„æ˜¯ GFP_KERNELï¼Œå…è®¸ç¡çœ ï¼Œç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ç©ºé—´ï¼›å¦å¤–çš„ GFP_ATOMICï¼Œåˆ™ä¸å¯ä»¥ç¡çœ ï¼Œå¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ã€ä¸­æ–­å¤„ç†ç¨‹åºã€è½¯ä¸­æ–­ã€taskletã€‚ vmallocvmalloc() ç±»ä¼¼ kmalloc()ï¼Œä¸åŒçš„æ˜¯ï¼Œå®ƒåˆ†é…çš„å†…å­˜è™šæ‹Ÿåœ°å€è™½ç„¶æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å®é™…çš„ç‰©ç†åœ°å€æ— éœ€è¿ç»­ã€‚å®ƒé€šè¿‡åˆ†é…éè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†ã€Œä¿®æ­£ã€é¡µè¡¨ï¼Œä»è€ŒæŠŠå†…å­˜æ˜ å°„åˆ°é€»è¾‘åœ°å€ç©ºé—´è¿ç»­çš„åŒºåŸŸã€‚å®ƒéœ€è¦ä¸“é—¨çš„é¡µè¡¨æ¥å®Œæˆè¿ç»­è™šæ‹Ÿåœ°å€åˆ°å®é™…éè¿ç»­ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œå¼€é”€è¾ƒå¤§ï¼Œä¸”å®¹æ˜“å¼•èµ· TLB æŠ–åŠ¨ï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­æ›´å€¾å‘äºä½¿ç”¨ kmalloc()ã€‚ slab å±‚slab å±‚å……å½“é€šç”¨æ•°æ®ç»“æ„çš„ç¼“å­˜å±‚çš„è§’è‰²ï¼Œå®ƒä¼šä¸ºä¸åŒçš„å¯¹è±¡åˆ’åˆ†æˆä¸åŒçš„é«˜é€Ÿç¼“å­˜ç»„ï¼Œæ¯ç»„å­˜æ”¾ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œå­˜æ”¾ task_struct å’Œ inode å°±åˆ†å±äºä¸åŒçš„ç»„ã€‚kmalloc() ä¹Ÿæ˜¯åŸºäº slab å±‚ä¹‹ä¸Šï¼Œä½¿ç”¨äº†ä¸€ç»„é€šç”¨é«˜é€Ÿç¼“å­˜ã€‚ slab åˆ†é…å™¨å¼•å…¥çš„ç›®çš„ï¼š é¿å…é¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡éœ€è¦é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾ï¼Œé™ä½å¼€é”€ é¢‘ç¹åˆ†é…å›æ”¶å®¹æ˜“å¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œå‡å°‘ç¢ç‰‡é—®é¢˜ æé«˜æ€§èƒ½ éƒ¨åˆ†ç¼“å­˜ä¸“å±äºæŸä¸ªå¤„ç†å™¨æ—¶ï¼Œå¯ä»¥å®ç°æ— é”åˆ†é…å’Œé‡Šæ”¾ï¼ˆtcmallocï¼‰ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰VFS æ˜¯ Linux æä¾›çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼Œæ¶µç›–äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¸¸ç”¨åŠŸèƒ½é›†å’Œè¡Œä¸ºï¼Œä»è€Œæ”¯æŒå„ç§å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NTFS, FAT, EXT4ï¼‰ã€‚1ç”¨æˆ·ç©ºé—´ write() -&gt; VFS sys_write() -&gt; æ–‡ä»¶ç³»ç»Ÿçš„å†™æ–¹æ³• -&gt; å­˜å‚¨è®¾å¤‡ Unix æ–‡ä»¶ç³»ç»Ÿä¼ ç»ŸæŠ½è±¡æ¦‚å¿µï¼šFile, DirectoryEntry, Index Node å’Œ Mount Pointã€‚Unix æ–‡ä»¶çš„ç‰¹ç‚¹æ˜¯é¢å‘å­—èŠ‚æµæŠ½è±¡è®¾è®¡çš„ï¼Œå…·æœ‰ç®€å•ã€çµæ´»çš„ç‰¹æ€§ã€‚åœ¨ Unix ä¸­ï¼Œç›®å½•ä¹Ÿæ˜¯æ™®é€šæ–‡ä»¶ï¼Œå…¶åˆ—å‡ºäº†åŒ…å«åœ¨ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ã€‚ VFS ä¸­çš„ä¸»è¦å¯¹è±¡ï¼š è¶…çº§å—å¯¹è±¡ï¼Œä»£è¡¨å…·ä½“å·²å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿ ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶ ç›®å½•é¡¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ† æ–‡ä»¶å¯¹è±¡ï¼Œä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼ˆå…¶å®å®ƒä¼šæŒ‡å‘ç›®å½•é¡¹å¯¹è±¡ï¼Œè€Œç›®å½•é¡¹å¯¹è±¡æ‰æ˜¯çœŸæ­£è¡¨ç¤ºå·²æ‰“å¼€çš„å®é™…æ–‡ä»¶ï¼Œå› ä¸ºå…¶ä¸­åŒ…å«äº†æŒ‡å‘ inode çš„æŒ‡é’ˆï¼‰ å— I/OLinux ä¸­ï¼Œè®¾å¤‡åˆ†ä¸ºä¸‰ç±»ï¼š å—è®¾å¤‡ï¼šæ”¯æŒéšæœºè®¿é—®å›ºå®šå¤§å°çš„æ•°æ®å—ï¼Œå¦‚ç¡¬ç›˜ã€é—ªå­˜ å­—ç¬¦è®¾å¤‡ï¼šä»¥å­—ç¬¦æµçš„å½¢å¼è¢«è®¿é—®ï¼Œå¦‚é”®ç›˜ ç½‘ç»œè®¾å¤‡ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹å—è®¾å¤‡çš„è¯·æ±‚ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·åœ¨ I/O è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå¹¶ä¸”ç”± I/O è°ƒåº¦ç¨‹åºæ¥ç®¡ç†è¯·æ±‚é˜Ÿåˆ—ã€‚å®ƒä¼šå†³å®šè¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚å¦‚ä½•æ’åºï¼Œä»¥åŠä½•æ—¶å‘é€åˆ°å…·ä½“çš„å—è®¾å¤‡ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œå°±æ˜¯æœŸæœ›å€ŸåŠ© I/O è°ƒåº¦ç¨‹åºï¼Œå¯¹è¯·æ±‚è¿›è¡Œåˆå¹¶å’Œæ’åºï¼Œä»è€Œæœ‰æ•ˆæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼ˆä¹Ÿå¯èƒ½é€ æˆæŸäº›è¯·æ±‚å¾—ä¸åˆ°å…¬å¹³å¯¹å¾…ï¼Œç”šè‡³å‡ºç°é¥¥é¥¿çš„æƒ…å†µï¼‰ã€‚ä»¥ä¸‹è®°å½•çš„æ˜¯ Linux ä¸­å·²ç»å®ç°çš„å‡ ç§ I/O è°ƒåº¦ç®—æ³•ï¼š Linus ç”µæ¢¯ æ”¯æŒå‘å‰å’Œå‘ååˆå¹¶ï¼ˆé€šå¸¸éƒ½æ˜¯è¿™ç§å±…å¤šï¼‰ æœ‰è¾ƒå¥½çš„å…¨å±€ååé‡ ä¼šå‘ç”Ÿè¯·æ±‚é¥¥é¥¿é—®é¢˜ æœ€ç»ˆæœŸé™ï¼ˆdeadlineï¼‰ I/O è°ƒåº¦ é™ä½äº†ç³»ç»Ÿçš„å…¨å±€ååé‡ è¯»è¯·æ±‚è¶…æ—¶ 500msï¼Œå†™è¯·æ±‚è¶…æ—¶ 5sï¼Œè¶…æ—¶å¿…ç„¶å¾—åˆ°æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´é¥¥é¥¿çš„é—®é¢˜ é¢„æµ‹ï¼ˆanticipatoryï¼‰ I/O è°ƒåº¦ ç›®æ ‡æ˜¯ä¿æŒè¾ƒå¥½çš„è¯»å“åº”åŒæ—¶ï¼Œæä¾›è‰¯å¥½çš„å…¨å±€ååé‡ã€‚è§†å›¾å‡å°‘åœ¨è¿›è¡Œ I/O æ“ä½œæœŸé—´ï¼Œå¤„ç†æ–°åˆ°çš„è¯»è¯·æ±‚å¸¦æ¥çš„å¯»å€æ•°é‡ è¯·æ±‚æäº¤åä¸ä¼šç›´æ¥è¿”å›å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œè€Œä¼šç©ºé—²ç‰‡åˆ»ï¼ˆå‡ æ¯«ç§’ï¼‰ï¼Œç­‰å¾…åº”ç”¨æäº¤å…¶å®ƒè¯»è¯·æ±‚ å®Œå…¨å…¬å¹³æ’é˜Ÿ I/O è°ƒåº¦ï¼ˆCFQï¼‰ ä¸ºç‰¹æ®Šå·¥ä½œè´Ÿè½½çš„åœºæ™¯è®¾è®¡ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è¯·æ±‚é˜Ÿåˆ— ä»¥æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ è¿›ç¨‹åœ°å€ç©ºé—´ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡é‡‡ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œç»™æ¯ä¸ªè¿›ç¨‹è¥é€ äº†ç‹¬äº«å†…å­˜çš„å‡è±¡ï¼Œè¿™æ˜¯å†…å­˜è™šæ‹ŸåŒ–çš„é‡è¦æœºåˆ¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°ä»£é‡‡ç”¨è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿé€šå¸¸éƒ½ä½¿ç”¨å¹³å¦åœ°å€ç©ºé—´ï¼Œè€Œéåˆ†æ®µå¼çš„å†…å­˜æ¨¡å¼ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å­˜åœ°å€ç©ºé—´ä¼šæ ¹æ®éœ€è¦åˆ’åˆ†æˆä¸åŒçš„åŒºåŸŸã€‚å†…æ ¸å¯ä»¥ç»™è¿›ç¨‹åœ°å€ç©ºé—´åŠ¨æ€æ·»åŠ æˆ–å‡å°‘å†…å­˜åŒºåŸŸã€‚æ¯ä¸ªè¿›ç¨‹åªèƒ½è®¿é—®æœ‰æ•ˆå†…å­˜åŒºåŸŸå†…çš„å†…å­˜åœ°å€ï¼Œæ¯ä¸ªå†…å­˜åŒºåŸŸä¼šåŒ…å«æƒé™ç­‰å±æ€§ã€‚è¿›ç¨‹ä¸­ä»»æ„æœ‰æ•ˆåœ°å€åªèƒ½ä½äºå”¯ä¸€çš„åŒºåŸŸï¼Œä¸”è¿™äº›åŒºåŸŸä¸èƒ½ç›¸äº’è¦†ç›–ã€‚ å†…å­˜åŒºåŸŸå¯ä»¥åŒ…å«å„ç§å†…å­˜å¯¹è±¡ï¼š å¯æ‰§è¡Œæ–‡ä»¶ä»£ç çš„å†…å­˜æ˜ å°„ï¼Œtext section å¯æ‰§è¡Œæ–‡ä»¶å·²åˆå§‹åŒ–å…¨å±€å˜é‡çš„å†…å­˜æ˜ å°„ï¼Œdata section åŒ…å«æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒBSS æ®µçš„é›¶é¡µçš„å†…å­˜æ˜ å°„ è¿›ç¨‹ç”¨æˆ·ç©ºé—´æ ˆçš„é›¶é¡µå†…å­˜æ˜ å°„ æ¯ä¸ªä¸€ä¸ªè¯¸å¦‚ C åº“æˆ–åŠ¨æ€è¿æ¥ç¨‹åºç­‰å…±äº«çš„ text section, data section å’Œ bss ä¹Ÿè¢«è½½å…¥åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ å†…å­˜æ˜ å°„æ–‡ä»¶ å…±äº«å†…å­˜æ®µ åŒ¿åæ˜ å°„ï¼Œå¦‚ malloc() åˆ†é…çš„å†…å­˜ 1mm_struct -&gt; vm_area_struct 64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ 64bit çš„åœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨ä¸€åŠçš„åœ°å€ç©ºé—´ï¼ˆ128 TiBï¼‰ï¼Œè€Œå¦ä¸€åŠåˆ™æ˜¯å†…æ ¸ç©ºé—´ä½¿ç”¨ã€‚å†…æ ¸é€šå¸¸é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šè¢«æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å½“ä¸­ã€‚è€Œåœ¨å†…æ ¸ä¸­ï¼Œæ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚è¯¦ç»†çš„å†…å­˜å¸ƒå±€å¯ä»¥å‚è€ƒåé¢çš„å­¦ä¹ èµ„æ–™~ é¡µè¡¨Linux ä¸­ä½¿ç”¨ä¸‰çº§é¡µè¡¨å®Œæˆåœ°å€è½¬æ¢ï¼Œä½¿ç”¨å¤šçº§é¡µè¡¨å¯ä»¥èŠ‚çº¦åœ°å€è½¬æ¢éœ€è¦å ç”¨çš„ç©ºé—´ã€‚ä½†ç”±äºå®Œæˆè™šæ‹Ÿé¡µåœ°å€åˆ°ç‰©ç†é¡µåœ°å€è½¬æ¢éƒ½éœ€è¦åœ¨ä¸‰çº§é¡µè¡¨ä¸­æŸ¥æ‰¾åˆ°æ˜ å°„ï¼Œå¼€é”€æ¯”è¾ƒé«˜ã€‚æ‰€ä»¥å¾ˆå¤šä½“ç³»ç»“æ„æä¾›äº† TLB ä½œä¸ºåœ°å€æ˜ å°„çš„ç¡¬ä»¶ç¼“å­˜ã€‚ æ€»ç»“æ€»ä½“ä¸Šæ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯æ¯”è¾ƒé€‚åˆå¯¹æ“ä½œç³»ç»ŸåŸºæœ¬æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¸”å¯¹äº Linux å†…æ ¸ä¹Ÿæœ‰ä¸€ç‚¹äº†è§£çš„å‰æä¸‹é˜…è¯»ï¼Œå¦åˆ™åœ¨çœ‹åˆ°ä¸€äº›æ¦‚å¿µçš„æ—¶å€™ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ¯”å¦‚å¯¹äºè¿›ç¨‹ã€çº¿ç¨‹çš„æŠ½è±¡å®šä¹‰ï¼Œè™šæ‹Ÿå†…å­˜ä¸­è®²åˆ°çš„åˆ†é¡µã€åˆ†æ®µæ¦‚å¿µä»¥åŠå¤šçº§é¡µè¡¨çš„æ¦‚å¿µã€‚å¦å¤–ï¼Œå¯¹äºå¸¸ç”¨æ•°æ®ç»“æ„éœ€è¦æœ‰æ¸…æ™°çš„è®¤è¯†ï¼›å¹¶å‘ç›¸å…³çš„åŒæ­¥é—®é¢˜ä¹Ÿæœ‰äº†è§£ã€‚è™½ç„¶æ•´æœ¬ä¹¦æ˜¯åŸºäº Linux 2.6.3x å†…æ ¸ä¸ºåŸºç¡€çš„ï¼Œå¦‚ä»Šçš„ Linux å†…æ ¸å·²ç»å‘å±•åˆ° 5.x æ—¶ä»£äº†ï¼Œè¿™æœŸé—´å˜åŒ–è‚¯å®šæœ‰å¾ˆå¤šã€‚ä½†è¿™æœ¬ä¹¦çš„ä»·å€¼è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå…¶ä¸­è®²å¾—å¾ˆå¤šæ€æƒ³ã€æ–¹æ³•ä¾ç„¶å®ç”¨ï¼Œå¯ä»¥å˜é€šåœ°å»çœ‹å¾…å’Œç†è§£ã€‚ åè¯è§£é‡Š POSIX: Portable Operating System Interface TLB: Translation Lookup Buffer CFS: Complete Fair Scheduler CFQ: Complete Fair Queueingï¼Œè¿™ä¸ªæ˜¯ IO è°ƒåº¦å™¨ä¹‹ä¸€ VFS: Virtual File System VMA: Virtual Memory Area MMU: Memory Map Unit jiffies: Linux ä¸­ç”¨æ¥è®°å½•ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ•°çš„å…¨å±€å˜é‡ï¼Œè¿˜æœ‰ä¸€ä¸ª jiffies_64 ISR: Interrupt Service Routine æ·±å…¥å­¦ä¹  ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç° Linux Kernel Developmentï¼Œç¬¬ 3 ç‰ˆã€‹ Are Threads Implemented As Processes on Linux POSIX çº¿ç¨‹ Linux çº¿ç¨‹å®ç° Linux Sched Doc CFS A complete guide to Linux process scheduling Linux Memory Linux memory management x86_64 å†…å­˜æ˜ å°„ The Memory Layout of a 64-bit Linux Process Linux kernel memory layout Chapter 3 Page Table Management Linux è°ƒåº¦å™¨èµ„æ–™æ•´ç† Linux Kernel Map Entering God Mode â€” The Kernel Space Mirroring Attack]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è°ƒåº¦å™¨</tag>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
        <tag>å†…å­˜ç®¡ç†</tag>
        <tag>æ–‡ä»¶ç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é™æµç®—æ³•å­¦ä¹ ï¼šæ¼æ¡¶ & ä»¤ç‰Œæ¡¶ç®—æ³•]]></title>
    <url>%2F2019%2F10%2F11%2Frate-limit-policies%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ¬èŠ‚ä¸»è¦å­¦ä¹ ä¸‹ä¸¤ç§å¸¸ç”¨çš„å•æœºé™æµæ€æƒ³ï¼Œåˆ†åˆ«æ˜¯æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚æ­¤å¤–ï¼Œè¿˜å°†ç»™å‡ºä½¿ç”¨ Python åŠ Go è¯­è¨€å®ç°ï¼Œä¾¿äºåŠ æ·±ç†è§£ã€‚å½“ç„¶ï¼Œç°å®ä¸­è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ä¸‹é¢çš„ä»£ç ã€‚å®é™…åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨å•æœºæ‰§è¡Œé™æµï¼Œä¸‹é¢çš„å®ç°ä¹Ÿå¹¶éçº¿ç¨‹æˆ– goroutine å®‰å…¨çš„ã€‚å®é™…é™æµå¯ä»¥è€ƒè™‘åœ¨ Nginx å±‚å¯¹è¯·æ±‚é™æµï¼Œæˆ–è€…å¦‚æœçœŸçš„è¦è‡ªå·±åœ¨ä¸šåŠ¡æ–¹å®ç°ä¸€å¥—é™æµç­–ç•¥çš„è¯ï¼Œå¯ä»¥è€ƒè™‘åŸºäº Redis å®ç°åˆ†å¸ƒå¼é™æµç­–ç•¥ã€‚å¹¶ä¸”åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½è¿˜ä¼šåŸºäºä¸åŒçš„ç»´åº¦è¿›è¡Œé™æµï¼Œå¦‚ç”¨æˆ· idï¼Œè¯·æ±‚ IP ç­‰ï¼Œå®é™…åº”ç”¨éœ€è¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šã€‚ æ¼æ¡¶ç®—æ³•å¯ä»¥æŠŠè¯·æ±‚å½“ä½œæ°´æµï¼Œæ°´æµå…¨éƒ¨è¿›å…¥æœ‰é™å¤§å°çš„æ°´ç¼¸ï¼ŒåŒæ—¶æ°´ç¼¸ä¼šæŒ‰ç…§å›ºå®šçš„é€Ÿç‡æ¼æ°´ã€‚å½“æ°´æµæ¹æ€¥ï¼Œæ°´ç¼¸æ¼æ°´å¤ªæ…¢çš„è¯ï¼Œä¼šå¾—çŸ¥æ°´ç¼¸ç§¯æ°´ï¼Œç›´åˆ°æº¢å‡ºï¼ˆæ­¤æ—¶æ‹’ç»æœåŠ¡ï¼‰ã€‚ ç‰¹ç‚¹ å®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»¥æ¯”è¾ƒæ’å®šçš„é€Ÿç‡æœåŠ¡è¯·æ±‚ ç¼ºç‚¹æ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æº¢å‡º å®ç°Python1234567891011121314151617181920212223class LeakyBucketRateLimiter(object): def __init__(self, capacity=10, leak_rate=1): """ åˆå§‹åŒ–æ¼æ¡¶ :param capacity: æ¡¶å®¹é‡ :param leak_rate: æ’å®šçš„æ¶ˆè´¹é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰ """ self._capacity = float(capacity) self._leak_rate = float(leak_rate) self._water_level = 0.0 # ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´ self._last_time = time.time() def acquire(self, level=1): # æ‰§è¡Œæ¼æ°´ now = time.time() delta = self._water_level - self._leak_rate * (now - self._last_time) self._water_level = min(0.0, delta) self._last_time = now # å°è¯•åŠ æ°´ï¼Œå¹¶çœ‹æ°´æ¡¶æ˜¯å¦æ»¡äº† if level + self._water_level &gt; self._capacity: raise RateLimitExceeded() self._water_level += level Go123456789101112131415161718192021222324252627282930type LeakyBucketRateLimiter struct &#123; capacity int currentLevel int leakRate int // consume how many requests per sec lastLeakedAt time.Time&#125;func NewLeakyBucketRateLimitter(capacity, leakRate int) *LeakyBucketRateLimiter &#123; return &amp;LeakyBucketRateLimiter&#123; capacity: capacity, currentLevel: 0, leakRate: leakRate, lastLeakedAt: time.Now(), &#125;&#125;func (r *LeakyBucketRateLimiter) Acquire(n int) error &#123; now := time.Now() // leak water currentLevel := r.currentLevel - r.leakRate*int(now.Sub(r.lastLeakedAt).Seconds()) r.currentLevel = max(currentLevel, 0) r.lastLeakedAt = now // try to add water, test bucket is full or not. currentLevel = n + r.currentLevel if currentLevel &gt; r.capacity &#123; return errRateLimitExceeds &#125; r.currentLevel = currentLevel return nil&#125; ä»¤ç‰Œæ¡¶ç®—æ³•åŒæ ·æƒ³è±¡æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¡¶ï¼Œä¸“é—¨å­˜æ”¾ä»¤ç‰Œï¼Œä¼šä»¥æ’å®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå¹¶å°†å…¶æ”¾å…¥æ¡¶ä¸­ã€‚æ¯å½“æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œéœ€è¦å…ˆä»æ¡¶ä¸­å–åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»¤ç‰Œï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¦åˆ™æ‹’ç»æœåŠ¡ã€‚ ç‰¹ç‚¹ å®ç°åŒæ ·æ˜¯å¾ˆç®€å• å¯ä»¥åº”å¯¹çªå‘æµé‡ï¼Œé¢å¯¹ç¬é—´å¤§æµé‡ï¼Œå¯ä»¥åœ¨çŸ­æ—¶é—´å†…è·å¾—å¤§é‡ä»¤ç‰Œï¼Œä¸”ç”Ÿäº§ä»¤ç‰Œæ¯«ä¸è´¹åŠ› å¯ä»¥åšæµé‡æ•´å½¢ å®ç°Python12345678910111213141516171819202122232425class TokenBucketRateLimiter(object): def __init__(self, capacity=1, fill_rate=1): """ åˆå§‹åŒ–ä»¤ç‰Œæ¡¶é™æµå™¨ :param capacity: ä»¤ç‰Œæ¡¶å®¹é‡ :param fill_rate: æ”¾å…¥ä»¤ç‰Œçš„é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰ """ self._capacity = float(capacity) self._rate = float(fill_rate) self._bucket_tokens = float(capacity) # ä¸Šæ¬¡æ·»åŠ ä»¤ç‰Œçš„æ—¶é—´ self._last_time = int(time.time()) def acquire(self, tokens=1): # å‘æ”¾ä»¤ç‰Œ if self._bucket_tokens &lt; self._capacity: now = time.time() delta = (now - self._last_time) * self._rate self._last_time = now self._bucket_tokens = min(self._capacity, self._bucket_tokens + delta) if tokens &gt; self._bucket_tokens: # æ— æ³•è·å–ä»¤ç‰Œäº†ï¼Œæ•°é‡ä¸å¤Ÿ raise RateLimitExceeded() self._bucket_tokens -= tokens Go1234567891011121314151617181920212223242526272829303132type TokenBucketRateLimiter struct &#123; capacity int tokens int putRate int // put how many tokens per sec lastPutAt time.Time&#125;func NewTokenBucketRateLimiter(capacity, fillRate int) *TokenBucketRateLimiter &#123; return &amp;TokenBucketRateLimiter&#123; capacity: capacity, tokens: 0, putRate: fillRate, lastPutAt: time.Now(), &#125;&#125;func (r *TokenBucketRateLimiter) Acquire(n int) error &#123; if r.tokens &lt; r.capacity &#123; // put tokens in the bucket now := time.Now() howMany := r.putRate * int(now.Sub(r.lastPutAt).Seconds()) r.tokens = min(r.capacity, howMany+r.tokens) r.lastPutAt = now &#125; // check if we have enough tokens if r.tokens &lt; n &#123; return errRateLimitExceeds &#125; // release tokens r.tokens -= n return nil&#125; å‚è€ƒ æ¥å£é™æµç®—æ³•ä»‹ç»]]></content>
      <categories>
        <category>Web å¼€å‘</category>
      </categories>
      <tags>
        <tag>Web å¼€å‘</tag>
        <tag>é™æµ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ Go è¯­è¨€å®ç°ä¸€ä¸ªç®€å•çš„ LRU Cache]]></title>
    <url>%2F2019%2F09%2F22%2Fimplement-lru-cache-in-go%2F</url>
    <content type="text"><![CDATA[å¼•è¨€LRU (Least-Recently-Used) Cache æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥å°†ä¸€äº›çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿›è€Œæé«˜æ¥å£çš„å“åº”é€Ÿåº¦ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œcache miss åï¼Œå®é™…å¯èƒ½ä¼šå›æºåˆ° Redis é›†ç¾¤è·å–ç¼“å­˜æ•°æ®ï¼Œå¦‚æœ Redis é›†ç¾¤ä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå›æºæ•°æ®åº“ã€‚ä¹Ÿå°±æ˜¯å¼•å…¥ LRU Cache åç›¸å½“äºç»™åº”ç”¨å±‚æ·»åŠ äº†ä¸€çº§é«˜é€Ÿç¼“å­˜ã€‚å½“ç„¶ï¼Œæ›´ä¸ºå®é™…ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„ LRU Cacheï¼Œå¦åˆ™åå°æ›´æ–°äº†è¯¾ç¨‹æ•°æ®ï¼Œç”±äºå†…å­˜ç¼“å­˜çš„åŸå› è€Œå¾—ä¸åˆ°åŠæ—¶æ›´æ–°ã€‚æœ¬èŠ‚ä¸»è¦æ˜¯å­¦ä¹ ä¸‹ LRU Cache å®ç°åŸç†ï¼Œåªæ¢è®¨æœ€æ ¸å¿ƒçš„å®ç°æ€æƒ³ï¼Œä¸è€ƒè™‘å¤æ‚çš„æƒ…å†µï¼ˆå¦‚ goroutine å®‰å…¨ï¼Œç¼“å­˜å¸¦è¿‡æœŸæ—¶é—´ç­‰ï¼‰ã€‚ å®ç°åŸç†LRU Cache æä¾›çš„åŠŸèƒ½æœ‰ä¸¤ä¸ªï¼š é¡¾åæ€ä¹‰ï¼Œç¼“å­˜èƒ½åŠ› å½“ç¼“å­˜ç©ºé—´æ»¡äº†åï¼Œä¼šå°†æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹åˆ é™¤æ‰ï¼Œä»è€Œä¸ºæ–°çš„ key/value æä¾›ç¼“å­˜ç©ºé—´ å…·ä½“å®ç°çš„æ€è·¯å¦‚ä¸‹ï¼š éœ€è¦ä½¿ç”¨ä¸€ä¸ª map ç»´æŠ¤ key -&gt; entry node çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œèƒ½å¤ŸåŸºäºæ­¤å¿«é€Ÿæ‰¾åˆ°ç›¸å…³çš„èŠ‚ç‚¹ï¼› éœ€è¦ä½¿ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥ç»´æŠ¤ entry nodeï¼› cache.set æ—¶ï¼Œéœ€è¦é¦–å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦è¶…å‡ºç•Œé™äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œéœ€è¦å°†é“¾è¡¨å°¾å·´ï¼ˆå³æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹ï¼‰ç§»é™¤ï¼›ç„¶åå°†æ–°çš„èŠ‚ç‚¹æ’å…¥åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¹¶åœ¨ map ä¸­åˆ·æ–° key å¯¹åº”çš„ entry node æŒ‡é’ˆï¼› cache.get æ—¶ï¼Œå¦‚æœ hit åˆ°ç¼“å­˜äº†ï¼Œåˆ™å°†å¯¹åº”çš„ entry node è°ƒæ•´åœ¨é“¾è¡¨å¤´éƒ¨ï¼Œä¿è¯æœ€é¢‘ç¹çš„èŠ‚ç‚¹å§‹ç»ˆå¾€å‰é ã€‚ åŠ¨æ‰‹å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116// Package lrucache implements a cache with limited capacity, which evicts// least-used-entry when it overflows.//// Caution: not production ready, not goroutine safe.package lrucacheimport ( "fmt" "path/to/bit/zerzura/log" "path/to/bit/zerzura/datastructures/list")const ( defaultCapacity = 10)type LRUCache struct &#123; capacity int cache map[string]*list.Node list *list.List stats *Stats&#125;type Option func(cache *LRUCache)func Capacity(cap int) Option &#123; return func(cache *LRUCache) &#123; if cap &lt;= 0 &#123; cap = defaultCapacity &#125; cache.capacity = cap &#125;&#125;func New(opts ...Option) *LRUCache &#123; cache := &amp;LRUCache&#123; capacity: defaultCapacity, cache: make(map[string]*list.Node, defaultCapacity), list: list.New(), stats: &amp;Stats&#123;&#125;, &#125; for _, opt := range opts &#123; opt(cache) &#125; return cache&#125;func (lru *LRUCache) String() string &#123; return fmt.Sprintf("LRUCache(cap=%d, len=%d, hits=%d, misses=%d)", lru.capacity, lru.Len(), lru.stats.hits, lru.stats.misses)&#125;func (lru *LRUCache) Cap() int &#123; return lru.capacity&#125;func (lru *LRUCache) Len() int &#123; return len(lru.cache)&#125;func (lru *LRUCache) Set(key string, value interface&#123;&#125;) &#123; log.Debugf("lru.set (%s, %v)", key, value) if len(lru.cache) &gt;= lru.capacity &#123; node := lru.list.Tail() if node != nil &#123; entry := node.Value.(*entry) log.Infof("[lru.set] evict entry %v", entry) delete(lru.cache, entry.key) lru.list.RemoveNode(node) &#125; else &#123; panic("unexpected state, node is nil, that's impossible") &#125; &#125; node, ok := lru.cache[key] if ok &amp;&amp; node != nil &#123; lru.list.RemoveNode(node) &#125; lru.cache[key] = lru.list.Insert( 0, &amp;entry&#123;key: key, value: value&#125;, )&#125;func (lru *LRUCache) Get(key string) (interface&#123;&#125;, bool) &#123; node, ok := lru.cache[key] if !ok &#123; log.Infof("[lru.get] cache misses for key %s", key) lru.stats.miss() return nil, false &#125; entry := node.Value.(*entry) entry.hits++ lru.list.RemoveNode(node) lru.cache[key] = lru.list.Insert(0, entry) lru.stats.hit() log.Debugf("[lru.get] cache hits, got entry %v.", entry) return entry.value, false&#125;type Stats struct &#123; hits int misses int&#125;func (s *Stats) hit() &#123; s.hits++&#125;func (s *Stats) miss() &#123; s.misses++&#125;type entry struct &#123; key string hits int value interface&#123;&#125;&#125;]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
        <tag>LRU</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Python æ ‡å‡†åº“æºç ä¹‹ threading æ¨¡å—]]></title>
    <url>%2F2019%2F09%2F14%2Fpython-stdlib-threading%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è™½ç„¶è¯´ Python å—é™äº CPython çš„å®ç°ï¼Œå­˜åœ¨çš„ GIL ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œæ²¡æ³•åˆ©ç”¨å¤šæ ¸è·‘å¤šçº¿ç¨‹ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼šç”¨åˆ°çº¿ç¨‹çš„ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ä¸€äº› I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚ åœ¨ä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬éšæ—¶éœ€è¦æ³¨æ„ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰å’Œæ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œå‰è€…ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è¿è¡Œç¨‹åºå¾—åˆ°çš„è¾“å‡ºå¯èƒ½ä¸åŒï¼›è€Œåè€…åˆ™æ›´ä¸ºå¯æ€•ï¼Œå®¹æ˜“å¯¼è‡´å…±äº«çš„æ•°æ®ç»“æ„è¢«é”™è¯¯ä¿®æ”¹ï¼Œç”šè‡³å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…å‡ºç°è«åå…¶å¦™çš„ Bugã€‚è¿™ä¸ªæ—¶å€™è‡ªç„¶å°±è¦ç”¨åˆ° Python threading æ¨¡å—ä¸ºæˆ‘ä»¬æä¾›çš„è‹¥å¹²åŒæ­¥åŸè¯­äº†ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ Lockã€RLockã€æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰ã€ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ç­‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥çš„æºç å­¦ä¹ æ˜¯åŸºäº CPython master åˆ†æ”¯çš„çº¿ç¨‹æ¨¡å—ã€‚å¸Œæœ›åœ¨å­¦ä¹ å®Œå®ƒä»¬çš„å®ç°åï¼Œèƒ½å¤ŸåŠ æ·±ç†è§£ï¼Œåˆç†è¿ç”¨ã€‚ æºç å­¦ä¹ CPython çš„ threading æ¨¡å—å®é™…ä¸Šæ˜¯åŸºäº Java çš„çº¿ç¨‹æ¨¡å‹å®ç°çš„ï¼Œæ‰€ä»¥ç†Ÿæ‚‰ Java çš„è¯ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå¯¹è¯¥æ¨¡å—çš„å®ç°æ„Ÿåˆ°é™Œç”Ÿã€‚è¯¥æ¨¡å—æ˜¯åŸºäºæ›´åº•å±‚çš„ _thread æ¨¡å—ï¼ŒæŠ½è±¡å‡ºæ›´åŠ æ–¹ä¾¿ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œæ ¸å¿ƒåŒ…æ‹¬ threading.Thread çº¿ç¨‹ç±»å°è£…ï¼Œä¾¿äºç”¨æˆ·ç»§æ‰¿æˆ–ç»„åˆï¼›æ­¤å¤–è¿˜æœ‰ä¸€äº›åŒæ­¥åŸè¯­çš„å®ç°ã€‚Python/thread_nt.h æ–‡ä»¶ä¸­æ˜¯ C è¯­è¨€å®ç°çš„åº•å±‚å’Œçº¿ç¨‹æœ‰å…³çš„å‡½æ•°ï¼ˆå¦‚é”çš„åˆ›å»ºå’Œç»´æŠ¤ã€çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ï¼‰ã€‚ åŒæ­¥åŸè¯­Lockè¯¥æ¨¡å—ä¸­ï¼ŒLock å…¶å®æ˜¯ä½¿ç”¨äº†åº•å±‚ _thread.allocate_lock å‡½æ•°æ¥åˆ›å»ºé”çš„ã€‚ä»£ç ä¹Ÿå¾ˆç®€å•ï¼š 1Lock = _allocate_lock Lock ä¸ºæˆ‘ä»¬æä¾›äº† acquire() å’Œ release() è¿™ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹è°ƒç”¨ acquire() æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼ˆæ­¤æ—¶çº¿ç¨‹ä¸€èˆ¬å°±æ˜¯ç¡çœ ç­‰å¾…äº†ï¼‰ï¼Œç›´åˆ°ä¸»åŠ¨ release() åï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚ å…³äº Lock æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š è¯¥é”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°ä¸­é€’å½’ acquire() ä¼šå¯¼è‡´æ­»é”çš„é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ RLock æ¥ä»£æ›¿ Lock å¹¶é Mutexï¼ˆäº’æ–¥é”ï¼‰ï¼Œä¸”å®ƒåº•å±‚æ˜¯é€šè¿‡ä¿¡å·é‡é‚£æ ·å®ç°çš„ï¼Œæœ¬èº«ä¸ä¼šè®°å½•è°æŒæœ‰äº†è¯¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ Lock å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«å¼•ç”¨ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹è·å–ï¼Œè€Œåœ¨å­çº¿ç¨‹é‡Šæ”¾å®ƒã€‚å…·ä½“å¯ä»¥åœ¨ CPython/Python/thread_nt.h:PyThread_allocate_lock å¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728/* * Lock support. It has to be implemented as semaphores. * I [Dag] tried to implement it with mutex but I could find a way to * tell whether a thread already own the lock or not. * Lock æ”¯æŒï¼šå®ƒå¿…é¡»ä»¥ä¿¡å·é‡çš„æ–¹å¼æ¥å®ç°ã€‚æˆ‘å°è¯•ä½¿ç”¨äº’æ–¥é”å®ç°è¿‡ï¼Œä½†æ˜¯æˆ‘ * å‘ç°äº†å¦å¤–ä¸€ç§æ–¹å¼å¯ä»¥å¾—çŸ¥ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦æŒæœ‰äº†é”ã€‚ */PyThread_type_lockPyThread_allocate_lock(void)&#123; PNRMUTEX aLock; dprintf(("PyThread_allocate_lock called\n")); if (!initialized) PyThread_init_thread(); aLock = AllocNonRecursiveMutex() ; dprintf(("%lu: PyThread_allocate_lock() -&gt; %p\n", PyThread_get_thread_ident(), aLock)); return (PyThread_type_lock) aLock;&#125;// å…¶ä¸­ PNRMUTEX å®šä¹‰å¦‚ä¸‹ï¼Œå®ƒå¹¶ä¸ä¼šå‘Šè¯‰æˆ‘ä»¬å½“å‰æ˜¯å“ªä¸ªçº¿ç¨‹// æŒæœ‰äº†é”typedef struct _NRMUTEX&#123; PyMUTEX_T cs; PyCOND_T cv; int locked;&#125; NRMUTEX;typedef NRMUTEX *PNRMUTEX; æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œå…¶å® PyCOND å³æ¡ä»¶å˜é‡æ˜¯é€šè¿‡ä¿¡å·é‡æ¥å®ç°çš„ï¼›è€Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåœ¨ Python çš„ threading æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Condition å®ç°äº†ä¿¡å·é‡ã€‚ RLockRLock å°±æ˜¯å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰ï¼Œå®ƒå¯ä»¥è¢«æŒæœ‰é”çš„çº¿ç¨‹å¤šæ¬¡æ‰§è¡Œ acquire()ï¼Œè€Œä¸ä¼šå‘ç”Ÿé˜»å¡å’Œæ­»é”çš„é—®é¢˜ã€‚å®ƒçš„å®ç°æ€è·¯å¾ˆç®€å•ï¼š è§„å®šå¦‚æœä¸€ä¸ªçº¿ç¨‹æˆåŠŸæŒæœ‰äº†è¯¥é”ï¼Œåˆ™å°†è¯¥é”çš„æ‰€æœ‰æƒäº¤ç»™è¯¥çº¿ç¨‹ï¼Œå¹¶ä¸”åªæœ‰è¯¥çº¿ç¨‹å¯ä»¥é‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹æ— æ³•é‡Šæ”¾ï¼› å½“åœ¨æŒæœ‰é”çš„çº¿ç¨‹ä¸­é€’å½’è·å–é”çš„æ—¶å€™ï¼Œå®é™…å¹¶ä¸ä¼šæ‰§è¡Œåº•å±‚çš„ _lock.acquire() æ–¹æ³•ï¼Œè€Œæ˜¯åªç»™è®¡æ•°å™¨é€’å¢ï¼›ä¸”é‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿæ˜¯å…ˆç»™è®¡æ•°å™¨é€’å‡ï¼Œç›´åˆ°ä¸º 0 åæ‰ä¼šé‡Šæ”¾é”ã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨ RLock çš„æ—¶å€™ä¸€å®šè¦è®°å¾— acquire() å’Œ release() çš„è°ƒç”¨æ¬¡æ•°å¾—åŒ¹é…æ‰èƒ½çœŸæ­£é‡Šæ”¾é”ã€‚æ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹æºç å®ç°ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758def RLock(*args, **kwargs): if _CRLock is None: # æ¥ä¸‹æ¥é‡ç‚¹çœ‹ Python ç‰ˆæœ¬çš„ RLock å®ç° return _PyRLock(*args, **kwargs) return _CRLock(*args, **kwargs)class _RLock: def __init__(self): # è¿™é‡Œæ˜¯çœŸæ­£çš„é” self._block = _allocate_lock() # è®°å½•è°å¯¹è¯¥é”æœ‰æ‰€æœ‰æƒ self._owner = None # è®°å½•è¯¥é”è¢«è·å–çš„æ¬¡æ•°ï¼Œç±»ä¼¼å¼•ç”¨è®¡æ•° self._count = 0 def acquire(self, blocking=True, timeout=-1): me = get_ident() if self._owner == me: # å¦‚æœå½“å‰æŒæœ‰é”çš„çº¿ç¨‹å°±æ˜¯å½“å‰éœ€è¦è·å¾—é”çš„çº¿ç¨‹ï¼Œè®¡æ•°å™¨é€’å¢å³å¯ self._count += 1 return 1 rc = self._block.acquire(blocking, timeout) if rc: # å¦‚æœæˆåŠŸè·å–åˆ°é”åï¼Œä¼šæŠŠæŒæœ‰é”çš„çº¿ç¨‹è®°å½•ä¸‹æ¥ï¼Œæ ‡è®°è¯¥çº¿ç¨‹æ˜¯æ‰€æœ‰æƒæ‹¥æœ‰è€… self._owner = me self._count = 1 return rc def release(self): if self._owner != get_ident(): # æ˜¾è€Œæ˜“è§ï¼Œéæ‹¥æœ‰è€…ä¸èƒ½é‡Šæ”¾é”ï¼Œæƒ³éƒ½ä¸ç”¨æƒ³ï¼ raise RuntimeError("cannot release un-acquired lock") # è¿™é‡Œåªæ˜¯é€’å‡è®¡æ•°å™¨ï¼Œåªæœ‰_count å‡æ²¡äº†æ‰ä¼šçœŸæ­£é‡Šæ”¾ self._count = count = self._count - 1 if not count: self._owner = None self._block.release() # ä¸‹é¢çš„æ–¹æ³•æ˜¯ç”¨äºæ¡ä»¶å˜é‡å®ç°æ—¶ä½¿ç”¨ def _acquire_restore(self, state): # æ¢å¤é”çš„è·å–ï¼Œå¹¶ä¸”æ¢å¤åµŒå¥—å±‚æ¬¡ self._block.acquire() self._count, self._owner = state def _release_save(self): # éœ€è¦ä¿è¯ä¸ç®¡æœ‰å¤šå°‘å±‚åµŒå¥—ï¼Œéƒ½èƒ½çœŸæ­£é‡Šæ”¾é”ï¼Œä½†åŒæ—¶è¿”å›å½“å‰çš„åµŒå¥—çŠ¶æ€ç­‰ä¿¡æ¯ä¾¿äºæ¢å¤ if self._count == 0: raise RuntimeError("cannot release un-acquired lock") count = self._count self._count = 0 owner = self._owner self._owner = None self._block.release() return (count, owner) def _is_owned(self): return self._owner == get_ident() Conditionæ¡ä»¶å˜é‡æ˜¯åé¢å‡ ä¸ªåŒæ­¥åŸè¯­å®ç°çš„åŸºç¡€ï¼Œå€¼å¾—é‡ç‚¹å­¦ä¹ ä¸‹ã€‚æ¡ä»¶å˜é‡çš„å®ç°åŸç†æ¯”è¾ƒç®€å•ï¼šæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™ä¼šè¢«å”¤é†’ï¼ˆå¯ä»¥æƒ³æƒ³å¦‚ä½•å®ç° waiter çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’å‘¢ï¼Ÿï¼‰ã€‚ åœ¨åˆ†ææºç å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ Condition ç±»æä¾›äº†å“ªäº›ä¸»è¦æ¥å£ï¼š wait(timeout=None)ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£ç­‰å¾…è¢«å”¤é†’ notify()ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£é€šçŸ¥é˜Ÿåˆ—ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ æ¥ä¸‹æ¥çœ‹çœ‹æºç å®ç°ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495class Condition: def __init__(self, lock=None): if lock is None: lock = RLock() self._lock = lock # Export the lock's acquire() and release() methods self.acquire = lock.acquire self.release = lock.release # If the lock defines _release_save() and/or _acquire_restore(), # these override the default implementations (which just call # release() and acquire() on the lock). Ditto for _is_owned(). try: self._release_save = lock._release_save except AttributeError: pass try: self._acquire_restore = lock._acquire_restore except AttributeError: pass try: self._is_owned = lock._is_owned except AttributeError: pass self._waiters = _deque() def _release_save(self): self._lock.release() # No state to save def _acquire_restore(self, x): self._lock.acquire() # Ignore saved state def _is_owned(self): # Return True if lock is owned by current_thread. # This method is called only if _lock doesn't have _is_owned(). if self._lock.acquire(False): self._lock.release() return False else: return True def wait(self, timeout=None): if not self._is_owned(): raise RuntimeError("cannot wait on un-acquired lock") waiter = _allocate_lock() waiter.acquire() self._waiters.append(waiter) saved_state = self._release_save() gotit = False try: # restore state no matter what (e.g., KeyboardInterrupt) if timeout is None: waiter.acquire() gotit = True else: if timeout &gt; 0: gotit = waiter.acquire(True, timeout) else: gotit = waiter.acquire(False) return gotit finally: self._acquire_restore(saved_state) if not gotit: try: self._waiters.remove(waiter) except ValueError: pass def wait_for(self, predicate, timeout=None): endtime = None waittime = timeout result = predicate() while not result: if waittime is not None: if endtime is None: endtime = _time() + waittime else: waittime = endtime - _time() if waittime &lt;= 0: break self.wait(waittime) result = predicate() return result def notify(self, n=1): if not self._is_owned(): raise RuntimeError("cannot notify on un-acquired lock") all_waiters = self._waiters waiters_to_notify = _deque(_islice(all_waiters, n)) if not waiters_to_notify: return for waiter in waiters_to_notify: waiter.release() try: all_waiters.remove(waiter) except ValueError: pass Semaphore12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697class Semaphore: """This class implements semaphore objects. Semaphores manage a counter representing the number of release() calls minus the number of acquire() calls, plus an initial value. The acquire() method blocks if necessary until it can return without making the counter negative. If not given, value defaults to 1. """ # After Tim Peters' semaphore class, but not quite the same (no maximum) def __init__(self, value=1): if value &lt; 0: raise ValueError("semaphore initial value must be &gt;= 0") self._cond = Condition(Lock()) self._value = value def acquire(self, blocking=True, timeout=None): """Acquire a semaphore, decrementing the internal counter by one. When invoked without arguments: if the internal counter is larger than zero on entry, decrement it by one and return immediately. If it is zero on entry, block, waiting until some other thread has called release() to make it larger than zero. This is done with proper interlocking so that if multiple acquire() calls are blocked, release() will wake exactly one of them up. The implementation may pick one at random, so the order in which blocked threads are awakened should not be relied on. There is no return value in this case. When invoked with blocking set to true, do the same thing as when called without arguments, and return true. When invoked with blocking set to false, do not block. If a call without an argument would block, return false immediately; otherwise, do the same thing as when called without arguments, and return true. When invoked with a timeout other than None, it will block for at most timeout seconds. If acquire does not complete successfully in that interval, return false. Return true otherwise. """ if not blocking and timeout is not None: raise ValueError("can't specify timeout for non-blocking acquire") rc = False endtime = None with self._cond: while self._value == 0: if not blocking: break if timeout is not None: if endtime is None: endtime = _time() + timeout else: timeout = endtime - _time() if timeout &lt;= 0: break self._cond.wait(timeout) else: self._value -= 1 rc = True return rc def release(self, n=1): """Release a semaphore, incrementing the internal counter by one or more. When the counter is zero on entry and another thread is waiting for it to become larger than zero again, wake up that thread. """ if n &lt; 1: raise ValueError('n must be one or more') with self._cond: self._value += n for i in range(n): self._cond.notify()class BoundedSemaphore(Semaphore): """Implements a bounded semaphore. A bounded semaphore checks to make sure its current value doesn't exceed its initial value. If it does, ValueError is raised. In most situations semaphores are used to guard resources with limited capacity. If the semaphore is released too many times it's a sign of a bug. If not given, value defaults to 1. Like regular semaphores, bounded semaphores manage a counter representing the number of release() calls minus the number of acquire() calls, plus an initial value. The acquire() method blocks if necessary until it can return without making the counter negative. If not given, value defaults to 1. """ def __init__(self, value=1): Semaphore.__init__(self, value) self._initial_value = value def release(self, n=1): """Release a semaphore, incrementing the internal counter by one or more. When the counter is zero on entry and another thread is waiting for it to become larger than zero again, wake up that thread. If the number of releases exceeds the number of acquires, raise a ValueError. """ if n &lt; 1: raise ValueError('n must be one or more') with self._cond: if self._value + n &gt; self._initial_value: raise ValueError("Semaphore released too many times") self._value += n for i in range(n): self._cond.notify() Event1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253class Event: """Class implementing event objects. Events manage a flag that can be set to true with the set() method and reset to false with the clear() method. The wait() method blocks until the flag is true. The flag is initially false. """ # After Tim Peters' event class (without is_posted()) def __init__(self): self._cond = Condition(Lock()) self._flag = False def _reset_internal_locks(self): # private! called by Thread._reset_internal_locks by _after_fork() self._cond.__init__(Lock()) def is_set(self): """Return true if and only if the internal flag is true.""" return self._flag isSet = is_set def set(self): """Set the internal flag to true. All threads waiting for it to become true are awakened. Threads that call wait() once the flag is true will not block at all. """ with self._cond: self._flag = True self._cond.notify_all() def clear(self): """Reset the internal flag to false. Subsequently, threads calling wait() will block until set() is called to set the internal flag to true again. """ with self._cond: self._flag = False def wait(self, timeout=None): """Block until the internal flag is true. If the internal flag is true on entry, return immediately. Otherwise, block until another thread calls set() to set the flag to true, or until the optional timeout occurs. When the timeout argument is present and not None, it should be a floating point number specifying a timeout for the operation in seconds (or fractions thereof). This method returns the internal flag on exit, so it will always return True except if a timeout is given and the operation times out. """ with self._cond: signaled = self._flag if not signaled: signaled = self._cond.wait(timeout) return signaled Barrieré€šå¸¸å¯ä»¥ä½¿ç”¨ Barrier å®ç°å¹¶å‘åˆå§‹åŒ–ï¼Œç„¶åä¸€åˆ‡å°±ç»ªåæ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚åº”ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031# coding: utf-8from threading import get_ident as get_identfrom threading import Barrier, Threaddef signal_prepared(): print("All are ready")barrier = Barrier(parties=4, action=signal_prepared)def main(): Thread(target=load_disk_files).start() Thread(target=make_cache).start() Thread(target=init_db_pool).start() print("I'm ready, wait for other workers") barrier.wait() print("Time to start our server")def load_disk_files(): print(u"[&#123;&#125;] load_disk_files".format(get_ident())) barrier.wait()def make_cache(): print(u"[&#123;&#125;] make cache".format(get_ident())) barrier.wait()def init_db_pool(): print(u"[&#123;&#125;] init db pool".format(get_ident())) barrier.wait()if __name__ == '__main__': main() è¿è¡Œæ•ˆæœï¼š æ¥ä¸‹æ¥çœ‹çœ‹ Barrier æ˜¯å¦‚ä½•å®ç°çš„ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149# Barrier æ˜¯åŸºäºéƒ¨åˆ†çš„ `pthread_barrier_*` API å’Œ Java ä¸­çš„ `CyclicBarrier`# å‚è€ƒï¼š# 1. http://sourceware.org/pthreads-win32/manual/pthread_barrier_init.html and# 2. http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/CyclicBarrier.html# åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸¤ç§ä¸»è¦çš„çŠ¶æ€ï¼š`filling` å’Œ `draining`ï¼Œä»è€Œè®©å±éšœå˜æˆå¯å¾ªç¯ä½¿ç”¨çš„ã€‚# åªæœ‰ä¸Šä¸€ä¸ªå‘¨æœŸå®Œå…¨æ’æ°´ï¼ˆ`drained`ï¼‰å®Œæ¯•æ‰å¯ä»¥å…è®¸æ–°çš„çº¿ç¨‹è¿›å…¥ï¼ˆå¯¹æ¯”ä¸‹æ¼æ¡¶é™æµç®—æ³•ï¼‰# æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æä¾›äº† `resetting` çŠ¶æ€ï¼Œå®ƒç±»ä¼¼äº `draining`ï¼Œä½†æ˜¯ä¼šè®©çº¿ç¨‹ç¦»å¼€çš„æ—¶å€™æŠ›å‡º `BrokeBarrierError`# `broken` çŠ¶æ€è¡¨ç¤ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½äº§ç”Ÿäº†å¼‚å¸¸class Barrier: """I æˆ‘ä»¬é€šå¸¸å¯ä»¥ä½¿ç”¨å±éšœè®©å¤šä¸ªçº¿ç¨‹åœ¨ç›¸åŒçš„åŒæ­¥ç‚¹åŒæ­¥å¼€å§‹ï¼ˆå¯ä»¥æƒ³è±¡ä¸‹æœ‰ä¸ªæ°´ç¼¸ï¼Œæ°´ä¸æ–­åœ°æµè¿›æ¥ ä½†æ˜¯ä¼šåœ¨æŸä¸ªç‚¹ä¸€èµ·æ”¾å¼€ï¼Œå½¢æˆæ´ªæµ...ï¼‰ã€‚æ‰€æœ‰è°ƒç”¨äº† `wait()` çš„çº¿ç¨‹ä¼šåœ¨æ¡ä»¶æ»¡è¶³æ—¶å‡ ä¹åŒæ—¶è¢«å”¤é†’ï¼Œ ç„¶åå¤§å®¶å°±å¯ä»¥ä¸€èµ·å¿«ä¹åœ°å¹²æ´»äº†ã€‚ """ def __init__(self, parties, action=None, timeout=None): """Create a barrier, initialised to 'parties' threads. 'action' is a callable which, when supplied, will be called by one of the threads after they have all entered the barrier and just prior to releasing them all. If a 'timeout' is provided, it is used as the default for all subsequent 'wait()' calls. """ self._cond = Condition(Lock()) self._action = action self._timeout = timeout self._parties = parties self._state = 0 #0 filling, 1, draining, -1 resetting, -2 broken self._count = 0 def wait(self, timeout=None): """Wait for the barrier. When the specified number of threads have started waiting, they are all simultaneously awoken. If an 'action' was provided for the barrier, one of the threads will have executed that callback prior to returning. Returns an individual index number from 0 to 'parties-1'. """ if timeout is None: timeout = self._timeout with self._cond: self._enter() # Block while the barrier drains. index = self._count self._count += 1 try: if index + 1 == self._parties: # We release the barrier self._release() else: # We wait until someone releases us self._wait(timeout) return index finally: self._count -= 1 # Wake up any threads waiting for barrier to drain. self._exit() # Block until the barrier is ready for us, or raise an exception # if it is broken. def _enter(self): while self._state in (-1, 1): # It is draining or resetting, wait until done self._cond.wait() #see if the barrier is in a broken state if self._state &lt; 0: raise BrokenBarrierError assert self._state == 0 # Optionally run the 'action' and release the threads waiting # in the barrier. def _release(self): try: if self._action: self._action() # enter draining state self._state = 1 self._cond.notify_all() except: #an exception during the _action handler. Break and reraise self._break() raise # Wait in the barrier until we are released. Raise an exception # if the barrier is reset or broken. def _wait(self, timeout): if not self._cond.wait_for(lambda : self._state != 0, timeout): #timed out. Break the barrier self._break() raise BrokenBarrierError if self._state &lt; 0: raise BrokenBarrierError assert self._state == 1 # If we are the last thread to exit the barrier, signal any threads # waiting for the barrier to drain. def _exit(self): if self._count == 0: if self._state in (-1, 1): #resetting or draining self._state = 0 self._cond.notify_all() def reset(self): """Reset the barrier to the initial state. Any threads currently waiting will get the BrokenBarrier exception raised. """ with self._cond: if self._count &gt; 0: if self._state == 0: #reset the barrier, waking up threads self._state = -1 elif self._state == -2: #was broken, set it to reset state #which clears when the last thread exits self._state = -1 else: self._state = 0 self._cond.notify_all() def abort(self): """Place the barrier into a 'broken' state. Useful in case of error. Any currently waiting threads and threads attempting to 'wait()' will have BrokenBarrierError raised. """ with self._cond: self._break() def _break(self): # An internal error was detected. The barrier is set to # a broken state all parties awakened. self._state = -2 self._cond.notify_all() @property def parties(self): """Return the number of threads required to trip the barrier.""" return self._parties @property def n_waiting(self): """Return the number of threads currently waiting at the barrier.""" # We don't need synchronization here since this is an ephemeral result # anyway. It returns the correct value in the steady state. if self._state == 0: return self._count return 0 @property def broken(self): """Return True if the barrier is in a broken state.""" return self._state == -2 æ€»ç»“Python æºç çš„æ³¨é‡Šå¤ªä¸°å¯Œäº†ï¼Œä»¥è‡³äºæˆ‘éƒ½ä¸æƒ³ç¿»è¯‘æˆä¸­æ–‡ã€‚æ‰€ä»¥ç»“åˆæ³¨é‡Šçœ‹ä»£ç å³å¯~]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>æºç å­¦ä¹ </tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go ç¼–å†™å§¿åŠ¿]]></title>
    <url>%2F2019%2F09%2F03%2Fgolang-traps%2F</url>
    <content type="text"><![CDATA[ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinterface å¯ä»¥ç›´æ¥è¿›è¡Œå€¼ä¼ é€’ï¼Œé™¤éä½ éœ€è¦ä¿®æ”¹ interface æŒ‡å‘çš„æ•°æ®ã€‚interface æœ¬èº«å¾ˆè½»é‡ï¼Œå…¶åŒ…æ‹¬æŒ‡å‘æ•°æ®ç±»å‹çš„æŒ‡é’ˆå’Œå­˜å‚¨æ•°æ®çš„æŒ‡é’ˆã€‚ Value Receiver æ–¹æ³•å¯ä»¥é€šè¿‡å€¼æˆ–è€…æŒ‡é’ˆè°ƒç”¨ï¼›Pointer Receiver åˆ™åªæ¥å—æŒ‡é’ˆè°ƒç”¨ã€‚æ¢å¥è¯è¯´ï¼ŒæŒ‡é’ˆè°ƒç”¨æ–¹æ³•æ›´åŠ è½»æ¾ï¼Œé™åˆ¶æ›´å°‘ã€‚ Mutex å’Œ RWMutex å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶é›¶å€¼ï¼Œé›¶å€¼è¡¨ç¤º Unlock çŠ¶æ€ã€‚å·²ç»è¢«ä½¿ç”¨çš„ Mutex ä¸èƒ½è¢«æ‹·è´ã€‚ å¯¹äº Map &amp; Sliceï¼Œéœ€è¦æ³¨æ„å…¶ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå—åˆ°å¤–ç•Œæ“ä½œçš„å½±å“ã€‚ å®‰å…¨çš„åšæ³•æ˜¯åœ¨å†…éƒ¨åšä¸€æ¬¡æ‹·è´ï¼Œå†…éƒ¨å¯å®‰å…¨ä½¿ç”¨ã€‚ 12d.trips = make([]Trip, len(trips))copy(d.trips, trips) Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ï¼ˆè¿™ä¸ªè¿˜æ˜¯è¦çœ‹æƒ…å†µå§ï¼‰ å¸¸è§„æƒ…å†µä¸‹ï¼Œæšä¸¾ä» 1 å¼€å§‹è®¡æ•°ï¼›é™¤é 0 æ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚å¦‚ï¼šLogToStdout = 0 ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯è¦å°å¿ƒï¼Œæœ€å¥½åªå…¬å¼€é”™è¯¯åŒ¹é…å™¨ï¼Œæ–¹ä¾¿è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼š 123456789101112type errNotFound struct &#123;file string&#125;func (e errNotFound) Error() string &#123;return fmt.Sprintf("file %q not found", e.file)&#125;func IsNotFoundError(err error) bool &#123;_, ok := err.(errNotFound)return ok&#125; åˆç†ä½¿ç”¨ Error Wrappingï¼Œä¸ç”¨æ·»åŠ è¿‡å¤šå†—ä½™ä¿¡æ¯ï¼Œå¦‚ï¼šfailed to : error messageã€‚ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿è¡Œçš„ç¨‹åºé¿å… panicï¼Œpanic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œè€Œæ˜¯å½“ä¸å¯æ¢å¤çš„äº‹æƒ…å‘ç”Ÿæ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ ä½¿ç”¨ go.uber.org/atomic æ›¿ä»£æ ‡å‡†åº“ sync/atomicï¼Œé¿å…å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œã€‚ import _ åº”è¯¥åªç”¨äº main æ–‡ä»¶ä¸­ï¼Œå°½å¯èƒ½é è¿‘ç¨‹åºå¯åŠ¨ä½ç½®ã€‚ æ€§èƒ½ ä¼˜å…ˆä½¿ç”¨ strconv è€Œé fmt è½¬æ¢ç±»å‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚ ä¸è¦åå¤ï¼ˆå¦‚å¾ªç¯ä¸­ï¼‰ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceï¼Œåä¹‹äº¦ç„¶ã€‚ map åˆ›å»ºæ—¶å°½é‡æä¾›å®¹é‡ hintï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ·»åŠ å…ƒç´ æœŸé—´è¿‡å¤šæ¬¡åœ°åˆ†é…ã€‚map è™½ç„¶ä¸èƒ½ä¿è¯åˆ†é… hint ä¸ªå®¹é‡ï¼Œæ·»åŠ å…ƒç´ æ—¶ä¾ç„¶å¯ä»¥è¿›è¡Œåˆ†é…ï¼Œä½†å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶æœ‰æ›´å°‘çš„åˆ†é…ã€‚ è§„èŒƒ ä¿è¯ä¸€è‡´æ€§ï¼Œä¾¿äºä»£ç çš„ç»´æŠ¤ã€å‡å°‘å­¦ä¹ æˆæœ¬ ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªåˆ†ç»„ï¼ˆimport/var/const/typeï¼‰ã€‚ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åˆ°ä¸€èµ·ï¼ åŒ…å‘½åè§„åˆ™ï¼š å…¨éƒ¨å°å†™ã€‚æ— å¤§å†™æˆ–ä¸‹åˆ’çº¿ å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œæ— éœ€é‡å‘½ååŒ… ç®€çŸ­ &amp; ç®€æ´ ä¸è¦ä½¿ç”¨å¤æ•° å‡½æ•°åˆ†ç»„ä¸é¡ºåºï¼š å‡½æ•°ç²—ç•¥æŒ‰ç…§è°ƒç”¨é¡ºåºæ’åº åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå‡½æ•°åº”è¯¥æŒ‰ç…§æ¥æ”¶è€…åˆ†ç»„ å¯¼å‡ºçš„å‡½æ•°åº”è¯¥å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨ var, struct, const å®šä¹‰çš„åé¢ 123456789type something struct&#123; ... &#125;func newSomething() *something &#123; return &amp;something&#123;&#125;&#125;func (s *something) Cost() &#123; return calcCost(s.weights)&#125;func (s *something) Stop() &#123;...&#125;func calcCost(n []int) int &#123;...&#125; å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨ _ ä½œä¸ºå‰ç¼€ã€‚æœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œä½¿ç”¨ err å¼€å¤´ã€‚åŸå› ï¼šé¡¶å±‚å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸï¼Œä½¿ç”¨é€šç”¨åç§°å¯èƒ½ä¼šå¯¼è‡´åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯å€¼ã€‚ ç»“æ„ä½“åµŒå…¥ï¼Œå¤šä¸€è¡Œç©ºè¡Œéš”å¼€ nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ sliceï¼›é›¶å€¼åˆ‡ç‰‡ï¼ˆä½¿ç”¨ var å£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨ make() åˆ›å»ºã€‚ 1234567var nums []intif add1 &#123;nums = append(nums, 1)&#125;if add2 &#123;nums = append(nums, 2)&#125; å¦‚æœè¦å£°æ˜æ ¼å¼å­—ç¬¦ä¸²ï¼Œè®¾ç½®ä¸º const ç±»å‹ï¼Œæœ‰åŠ©äº go vet æ‰§è¡Œå­—ç¬¦ä¸²é™æ€æ£€æŸ¥ï¼š 12const msg = "unexpected values %v, %v\n"fmt.Printf(msg, 1, 2) æ›´å¤šå‚è€ƒ Uber Go Guide The Go common mistakes guide Effective ä¸­æ–‡ç‰ˆ Pointers v.s. Values Donâ€™t just checked errors, handle them gracefully Package Names Go åŒ…æ ·å¼æŒ‡å— Self-referential functions and the design of options Functional options for friendly APIs]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>æœ€ä½³å®è·µ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹äº‹åŠ¡]]></title>
    <url>%2F2019%2F08%2F24%2Fddia-transaction%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ç”±äºæ•°æ®å­˜å‚¨æœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿé”™è¯¯ã€æ•…éšœçš„ç‚¹ç‰¹åˆ«å¤šï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€ç£ç›˜å†™æ»¡ç­‰ï¼Œé¢å¯¹è¿™äº›å¤æ‚çš„æƒ…å†µï¼Œåº”ç”¨å±‚åº”ä»˜èµ·æ¥éå¸¸å›°éš¾ã€‚æ‰€ä»¥å°±æœ‰äº†äº‹åŠ¡çš„æ¦‚å¿µï¼Œè¯´é“äº‹åŠ¡ï¼Œæˆ‘ä»¬æœ€å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šå¯ä»¥ä¸€æ¬¡äº‹åŠ¡ä¸­å°†å¾ˆå¤šè¯»å†™å…¥æ“ä½œæ‰“åŒ…æˆä¸€ä¸ªé€»è¾‘æ“ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æˆåŠŸï¼ˆCommittedï¼‰ä¾¿æˆä»ï¼ˆRollbackï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æƒ…å†µå®‰å…¨åœ°é‡è¯•ï¼Œä¸ç”¨æ‹…å¿ƒéƒ¨åˆ†å†™å…¥çš„é—®é¢˜ã€‚ æ€»çš„æ¥è¯´ï¼Œäº‹åŠ¡å°±æ˜¯ä¸€å±‚æŠ½è±¡ï¼Œä¸ºç®€åŒ–åº”ç”¨å±‚ç¼–ç¨‹æ¨¡å‹è€Œç”Ÿï¼å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰çš„æ•°æ®åº“éƒ½æ”¯æŒäº‹åŠ¡ï¼Œä½†æ˜¯å¯¹å…³ç³»å‹æ•°æ®åº“è€Œè¨€ï¼Œè¿™ä¸ªåŸºæœ¬æ˜¯æ ‡é…ï¼›æŸäº› NoSQL æ•°æ®åº“å¯èƒ½å› ä¸ºæ€§èƒ½ã€å¯ç”¨æ€§ä»¥åŠæ‰©å±•æ€§è€ƒè™‘ï¼Œè€Œæ”¾å¼ƒäº†å¯¹äº‹åŠ¡çš„æ”¯æŒã€‚å¦å¤–ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸‹ï¼Œäº‹åŠ¡çš„å®ç°ä¼šæ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”æ‰§è¡Œå¼€é”€ä¹Ÿå¾ˆå¤§ï¼Œä½†å¹¶ä¸ä»£è¡¨å®ƒä¸èƒ½å®ç°ã€‚å…¸å‹çš„ åˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“å¦‚ TiDB ä»¥åŠ Google Spanner å°±æä¾›äº†äº‹åŠ¡æ”¯æŒã€‚ æ·±å…¥ç†è§£ ACID Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šå°†å¤šä¸ªå†™æ“ä½œçº³å…¥ä¸€ä¸ªåŸå­äº‹åŠ¡ä¸­ï¼Œå¹¶åœ¨æ•…éšœï¼ˆè¿›ç¨‹å´©æºƒã€ç½‘ç»œä¸­æ–­ã€ç£ç›˜æ•…éšœï¼‰å‘ç”Ÿæ—¶èƒ½å¤ŸåŠæ—¶ä¸­æ­¢äº‹åŠ¡ï¼Œå¹¶å°†éƒ¨åˆ†å®Œæˆçš„å†™å…¥å…¨éƒ¨ä¸¢å¼ƒã€‚ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼š å¯¹æ•°æ®æœ‰ç‰¹å®šçš„çŠ¶æ€é¢„æœŸï¼Œä»»ä½•æ•°æ®å˜æ›´å¿…é¡»æ»¡è¶³è¿™äº›çŠ¶æ€çº¦æŸï¼ˆæˆ–è€…æ’ç­‰æ¡ä»¶ï¼‰ åº”ç”¨ç¨‹åºåº”è¯¥è´Ÿè´£ä¿è¯è¿™ç§ä¸€è‡´æ€§ï¼Œæ•°æ®åº“åªæ˜¯å­˜å‚¨ è¿™ä¸ªæ›´å¤šçš„æ˜¯åº”ç”¨å±‚å±æ€§ï¼Œæ‰€ä»¥ C åŸæœ¬ä¸å±äº ACIDï¼Œåªæ˜¯ä½œè€… Joe Hellerstein è®¤ä¸ºå¬èµ·æ¥é¡ºå£å°±åŠ äº†è¿›æ¥ğŸ˜¢ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½ç›¸äº’äº¤å‰ã€‚ç»å…¸çš„æ•™ææŠŠå…¶ç§°ä¸ºå¯ä¸²è¡ŒåŒ–ã€‚ä½†å®è·µä¸­ï¼Œä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«è¾ƒå°‘ä½¿ç”¨ï¼Œæ›´å¤šçš„è¿˜æ˜¯è¾ƒå¼±çš„éš”ç¦»çº§åˆ«ã€‚ Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šæ•°æ®åº“æ‰¿è¯ºï¼Œä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå³ä¾¿ç¡¬ä»¶æ•…éšœæˆ–æ•°æ®åº“å´©æºƒï¼Œäº‹åŠ¡å†™å…¥çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ å¯¹äºå¦‚ä¸»ä»å¤åˆ¶çš„æ•°æ®åº“é›†ç¾¤ï¼Œæ„å‘³ç€å†™å…¥çš„æ•°æ®å¤åˆ¶åˆ°äº†å¤šä¸ªèŠ‚ç‚¹ å®Œç¾çš„æŒä¹…æ€§æ— æ³•ä¿è¯ï¼ˆæŠŠç¡¬ç›˜æ‹”äº†ã€å…¨éƒ¨æœºæˆ¿çƒ§äº†ğŸ”¥å‘¢ï¼Ÿï¼‰ ç†æ€§çœ‹å¾…å„å®¶æ•°æ®åº“å®£ç§°çš„ ACID å…¼å®¹ï¼›å®é™…å„å®¶å®ç°éƒ½å¯èƒ½ä¸åŒ ä¸ç¬¦åˆ ACID æ ‡å‡†çš„ç³»ç»Ÿé€šå¸¸ç§°ä¸º BASEï¼š Basically Available Soft State Eventually Consistency ACID æ•°æ®åº“åŸºäºè¿™æ ·çš„ç†å¿µï¼šå¦‚æœå­˜åœ¨è¿å AID çš„é£é™©ï¼Œå°±æ”¾å¼ƒæ•´ä¸ªäº‹åŠ¡ï¼Œè€Œééƒ¨åˆ†æ”¾å¼ƒï¼ å¼±éš”ç¦»çº§åˆ« å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼šä¸¤ä¸ªäº‹åŠ¡é—´æ²¡æ•°æ®ä¾èµ–å…³ç³»ï¼Œæ“ä½œçš„æ˜¯å®Œå…¨ä¸åŒçš„æ•°æ® ä¸å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼ˆä¼šå¼•å…¥ç«äº‰æ¡ä»¶ï¼‰ï¼š A äº‹åŠ¡ä¿®æ”¹äº†æŸæ•°æ®ï¼›B äº‹åŠ¡åˆè¯»å–è¯¥æ•°æ®ï¼› A äº‹åŠ¡å’Œ B äº‹åŠ¡åŒæ—¶ä¿®æ”¹ç›¸åŒçš„æ•°æ®ã€‚ éš”ç¦»å°±æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡èƒ½å¤Ÿå®‰å…¨åœ°å¹¶å‘æ‰§è¡Œï¼Œå‡è£…æ²¡æœ‰å‘ç”Ÿå¹¶å‘ï¼›å¯ä¸²è¡Œåœ°éš”ç¦»æ„å‘³ç€æ•°æ®åº“ä¼šä¿è¯äº‹åŠ¡çš„æ‰§è¡Œç»“æœå’Œä¸²è¡Œæ‰§è¡Œç»“æœä¸€è‡´ã€‚ ä¸ºä½•äº§ç”Ÿå¼±éš”ç¦»çº§åˆ«ï¼Ÿ ä¸²è¡Œéš”ç¦»æ€§èƒ½ä¸å¥½ å¼±éš”ç¦»å¯è§£å†³éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼›ä½†æ˜¯è¿˜æ˜¯éœ€è¦å½»åº•ç†è§£å„ç§éš”ç¦»çº§åˆ«ä»¥åŠå®ƒä»¬å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼Œæ‰èƒ½æ›´å¥½åœ°å®Œæˆä¸šåŠ¡éœ€æ±‚ åè¯è§£é‡Šåœ¨å­¦ä¹ å„ç§éš”ç¦»çº§åˆ«å‰ï¼Œæœ‰å¿…è¦äº†è§£å¦‚ä¸‹å‡ ä¸ªå…³é”®è¦ç‚¹ï¼š è¦ç‚¹ è§£é‡Š è„è¯» Dirty Read åœ¨äº‹åŠ¡ A ä¸­è¯»å–åˆ°äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚é‡‡ç”¨ Read Committed åŠä»¥ä¸Šçº§åˆ«å¯é˜²èŒƒã€‚ è„å†™ Dirty Write åœ¨äº‹åŠ¡ A ä¸­è¦†ç›–äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚å‡ ä¹æ‰€æœ‰çš„æ•°æ®åº“éƒ½å¯ä»¥é˜²æ­¢è„å†™ï¼Œæœ€ç®€å•å°±æ˜¯åŠ é”ã€‚ è¯»å€¾æ–œï¼ˆä¸å¯é‡å¤è¯»ï¼‰ Non-Repeatable Read åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œä¸åŒçš„æ—¶é—´ç‚¹è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¾—åˆ°çš„å€¼ä¸åŒã€‚å¿«ç…§éš”ç¦»å¯è½»æ¾åº”ä»˜ï¼Œé€šå¸¸ä½¿ç”¨ MVCC å®ç°å¿«ç…§éš”ç¦»ï¼ˆå¦‚ InnoDBï¼‰ã€‚ æ›´æ–°ä¸¢å¤± Lost Update ä¸¤ä¸ªäº‹åŠ¡ä¸­éƒ½æ‰§è¡Œäº† Read-Modify-Write çš„æ“ä½œåºåˆ—ï¼Œå‡ºç°äº†å…¶ä¸­ä¸€ä¸ªè¦†ç›–äº†å¦ä¸€ä¸ªçš„å†™å…¥ï¼Œä½†æ²¡æœ‰åŒ…å«å¯¹æ–¹æœ€æ–°å€¼çš„æƒ…å†µï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ï¼šè¯»å–æŸä¸ªå­—æ®µ-&gt;å­—æ®µå€¼åŠ  1-&gt;å†™å…¥è¯¥å­—æ®µçš„æ–°å€¼ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œäº† +1ï¼Œä½†æœ€ç»ˆç»“æœä¸æ˜¯é¢„æœŸçš„ +2 æ•ˆæœï¼‰ã€‚é€šå¸¸å¯ä»¥é‡‡ç”¨æ•°æ®æ”¯æŒçš„åŸå­å†™æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨ SELECTâ€¦FOR UPDATE æ˜¾å¼åŠ é”çš„æ–¹å¼è§£å†³ï¼›å½“ç„¶ï¼ŒæŸäº›å¿«ç…§éš”ç¦»çš„å®ç°å¯ä»¥è‡ªåŠ¨é˜²æ­¢è¿™ç§å¼‚å¸¸ å†™å€¾æ–œ Write Skew å…¸å‹çš„åœºæ™¯æ˜¯ï¼šäº‹åŠ¡ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå†æ ¹æ®æŸ¥è¯¢ç»“æœåšå‡ºå†³ç­–ï¼Œæœ€åä¿®æ”¹æ•°æ®åº“ã€‚ä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤æ—¶ï¼Œæ”¯æŒå†³ç­–çš„å‰ææ¡ä»¶ä¸å†æˆç«‹ï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªäº‹åŠ¡ä¸­åšäº†ä¿®æ”¹ï¼Œå¯¼è‡´åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¾—åˆ°çš„ç»“æœä¸åŒï¼‰ã€‚åªæœ‰ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«æ‰èƒ½çœŸæ­£é˜²æ­¢è¿™ç§å¼‚å¸¸ å¹»è¯» Phantom Read äº‹åŠ¡è¯»å–äº†æŸäº›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼ŒåŒæ—¶å¦ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå†™å…¥ï¼Œæ”¹å˜äº†å…ˆå‰çš„æŸ¥è¯¢ç»“æœã€‚å¿«ç…§éš”ç¦»å¯é˜²æ­¢ç®€å•çš„å¹»è¯» ANSI SQL å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼šå®é™…ä¸Šå„å®¶æ•°æ®åº“çš„æ”¯æŒæ˜¯ä¸å°½ç›¸åŒçš„ğŸ˜£ã€‚ çº§åˆ« P1 è„è¯» P2 ä¸å¯é‡å¤è¯» P3 å¹»è¯» Read Uncommitted å…è®¸ å…è®¸ å…è®¸ Read Committed ç¦æ­¢ å…è®¸ å…è®¸ Repeatable Read ç¦æ­¢ ç¦æ­¢ å…è®¸ Serializable ç¦æ­¢ ç¦æ­¢ ç¦æ­¢ è¯»å·²æäº¤ æœ€åŸºæœ¬çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéœ€è¦æä¾›ä¸‹é¢ä¸¤ä¸ªä¿è¯ï¼š é˜²æ­¢è„è¯» é˜²æ­¢è„å†™ å®ç°ï¼š ä¸ºäº†é˜²æ­¢è„å†™ï¼Œå½“äº‹åŠ¡éœ€è¦ä¿®æ”¹æŸä¸ªå¯¹è±¡ï¼ˆæ¯”å¦‚è¡Œæˆ–æ–‡æ¡£ï¼‰æ—¶ï¼Œå¿…é¡»è¦è·å¾—è¯¥å¯¹è±¡çš„é”ï¼Œä¸€ç›´æŒæœ‰è¯¥é”ç›´åˆ°äº‹åŠ¡æäº¤æˆ–ä¸­æ­¢ï¼› ä¸ºäº†é˜²æ­¢è„è¯»ï¼Œä½¿ç”¨é”çš„æ–¹å¼è™½ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†åœ¨è¿è¡Œè¾ƒé•¿æ—¶é—´çš„å†™äº‹åŠ¡ä¼šå¯¼è‡´è®¸å¤šåªè¯»äº‹åŠ¡ç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå½±å“åªè¯»äº‹åŠ¡çš„å“åº”å»¶è¿Ÿï¼Œå¯æ“ä½œæ€§å·®ã€‚é€šå¸¸å¯¹äºæ¯ä¸ªå¾…æ›´æ–°çš„å¯¹è±¡ï¼Œæ•°æ®åº“ç»´æŠ¤å…¶æ—§å€¼å’Œå½“å‰æŒé”äº‹åŠ¡å°†è¦è®¾ç½®çš„æ–°å€¼ä¸¤ä¸ªç‰ˆæœ¬ã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼Œæ‰€æœ‰å…¶å®ƒè¯»æ“ä½œéƒ½è¯»å–æ—§å€¼ï¼›ä»…å½“å†™äº‹åŠ¡æäº¤åï¼Œæ‰ä¼šåˆ‡æ¢åˆ°è¯»å–æ–°å€¼ã€‚ å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯» Rread Committed ä¸èƒ½è§£å†³ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œè€Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å°±ä¸èƒ½å®¹å¿ï¼š å¤‡ä»½ åˆ†ææŸ¥è¯¢å’Œå®Œæ•´æ€§æ£€æŸ¥ å¿«ç…§éš”ç¦»ä¿è¯æ¯ä¸ªäº‹åŠ¡åªçœ‹åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„æ—§æ•°æ®ï¼Œä¸æ„ŸçŸ¥å…¶å®ƒäº‹åŠ¡ä¸­å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚è¯»å–æ“ä½œä¸ä¼šé˜»æ­¢å†™æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚ æ•°æ®åº“ä½¿ç”¨äº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Control, MVCCï¼‰æŠ€æœ¯æ¥å®ç°å¿«ç…§éš”ç¦»ã€‚è€Œ MVCC ä¹Ÿå¯ä»¥ç”¨æ¥å®ç° Read Committed éš”ç¦»çº§åˆ«ï¼ˆåªéœ€è¦ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬å³å¯ï¼Œå·²æäº¤çš„æ—§æ•°æ®å’Œå°šæœªæäº¤çš„æ–°ç‰ˆæœ¬æ•°æ®ï¼‰ï¼Œå…¸å‹çš„åšæ³•æ˜¯å¯¹æ¯ä¸ªä¸åŒçš„æŸ¥è¯¢å•ç‹¬åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼›è€Œå¿«ç…§éš”ç¦»çº§åˆ«åˆ™ä½¿ç”¨ä¸€ä¸ªå¿«ç…§è¿è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚ ä¸€è‡´æ€§å¿«ç…§ä¸­æ•°æ®å¯è§æ€§è§„åˆ™ï¼š äº‹åŠ¡å¼€å§‹æ—¶ï¼Œåˆ›å»ºè¯¥å¯¹è±¡çš„äº‹åŠ¡å·²ç»å®Œæˆæäº¤ å¯¹è±¡æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼›æˆ–è€…å³ä¾¿æ ‡è®°äº†ï¼Œä½†æ˜¯åˆ é™¤äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å°šæœªæäº¤ é˜²æ­¢æ›´æ–°ä¸¢å¤± äº§ç”Ÿæ›´æ–°ä¸¢å¤±çš„å…¸å‹åœºæ™¯æ˜¯ï¼šRead-Modify-Writeï¼Œå½“ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡åœ¨åŒæ ·çš„æ•°æ®è®°å½•ä¸Šæ‰§è¡Œç±»ä¼¼æ“ä½œæ—¶ï¼ŒäºŒè€…ç›¸äº’ä¸ä¼šæ„ŸçŸ¥å¯¹æ–¹çš„ä¿®æ”¹å€¼ï¼Œæœ€ç»ˆå¯¼è‡´æŸä¸ªäº‹åŠ¡çš„ä¿®æ”¹å€¼å¯èƒ½ä¸¢å¤±ã€‚åœºæ™¯å¦‚ä¸‹ï¼š é€’å¢è®¡æ•°å™¨ï¼›æ›´æ–°è´¦æˆ·ä½™é¢ å¯¹å¤æ‚å¯¹è±¡çš„ä¸€éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼ˆå¦‚ä¸€ä¸ªå¤§ JSON å¯¹è±¡ï¼‰ å¦‚ä½•è§£å†³ï¼Ÿ é‡‡ç”¨åŸå­å†™æ“ä½œï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒçš„è¯ï¼‰ï¼š UPDATE counter SET value = value + 1 WHERE id = 1; é€šå¸¸é‡‡ç”¨è¯»å–å¯¹è±¡å¹¶åŠ ç‹¬å é”çš„æ–¹å¼æ¥å®ç°ï¼ˆåœ¨å½“å‰äº‹åŠ¡æœªæäº¤å‰ï¼Œå…¶å®ƒäº‹åŠ¡ä¹Ÿä¸å¯è¯»ï¼‰ï¼›æˆ–è€…å¯ä»¥é‡‡ç”¨å•çº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œ æ˜¾å¼åŠ é”ï¼š SELECT * FROM figures WHERE name = &#39;robot&#39; FOR UPDATE å¯¹æ‰€é€‰è¡ŒåŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡è‹¥è¦åŒæ—¶å°è¯•è¯»å–å¯¹è±¡ï¼Œåˆ™è¦ç­‰å¾…å½“å‰æ­£åœ¨æ‰§è¡Œçš„åºåˆ—å…¨éƒ¨å®Œæˆ è‡ªåŠ¨æ£€æµ‹æ›´æ–°ä¸¢å¤±ï¼š äº‹åŠ¡ç®¡ç†å™¨å¦‚æœæ£€æµ‹åˆ°æ›´æ–°ä¸¢å¤±é£é™©ï¼Œä¼šä¸­æ­¢å½“å‰äº‹åŠ¡ï¼Œå¼ºåˆ¶é€€å›åˆ°å®‰å…¨çš„ R-M-W æ–¹å¼ MySQL InnoDB ä¸æ”¯æŒæ£€æµ‹ï¼›PostgreSQL çš„å¯é‡å¤è¯»ã€Oracle å¯ä¸²è¡ŒåŒ–å’Œ SQL Server å¿«ç…§éš”ç¦»çº§åˆ«éƒ½æ”¯æŒ åŸå­æ¯”è¾ƒå’Œè®¾ç½®ï¼š åªæœ‰åœ¨ä¸Šæ¬¡è¯»å–çš„æ•°æ®æœªå‘ç”Ÿå˜åŒ–æ—¶æ‰å…è®¸æ›´æ–°ï¼›å¦åˆ™å›é€€åˆ° R-M-W æ–¹å¼ ä½¿ç”¨å‰éœ€è¦ä»”ç»†æ£€æŸ¥ å†™å€¾æ–œä¸å¹»è¯» å†™å€¾æ–œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§æ›´å¹¿ä¹‰çš„æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼Œå³å¦‚æœä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„ä¸€ç»„å¯¹è±¡ï¼Œç„¶åæ›´æ–°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼š ä¸åŒçš„äº‹åŠ¡æ›´æ–°ä¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå†™å€¾æ–œ ä¸åŒçš„äº‹åŠ¡æ›´æ–°ç›¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿè„å†™æˆ–æ›´æ–°ä¸¢å¤± ç›¸å…³åœºæ™¯ï¼š ä¼šè®®å®¤é¢„å®šç³»ç»Ÿ å¤šäººæ¸¸æˆ å£°æ˜ä¸€ä¸ªç”¨æˆ·å é˜²æ­¢åŒé‡å¼€æ”¯ï¼ˆç§¯åˆ†ç­‰ï¼‰ å¦‚ä½•åº”å¯¹å†™å€¾æ–œï¼š å¦‚å€¼ç­åŒ»ç”Ÿçš„ä¾‹å­ï¼Œå¯ä»¥é‡‡ç”¨ SELECT...FOR UPDATE æ–¹å¼æ˜¾å¼åŠ é”ï¼Œä½†å¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œè¿™æ ·åšä¹Ÿä¸èƒ½å¥æ•ˆ å®ä½“åŒ–å†²çªï¼Œæ¯”å¦‚ä¼šè®®å®¤é¢„å®šï¼Œå¯ä»¥æå‰å°†æœªæ¥ N ä¸ªæœˆçš„å¯¹åº”çš„æ‰€æœ‰æ—¶é—´å’Œæˆ¿é—´ç»„åˆåˆ›å»ºå¥½ï¼Œè¿™æ ·æ˜¾ç¤ºåŠ é”å¯ä»¥ç”Ÿæ•ˆ é‡‡ç”¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ« ä¸²è¡ŒåŒ–ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ é‡‡ç”¨å•çº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œäº‹åŠ¡ï¼Œé¿å…æ£€æµ‹ã€äº‹åŠ¡å†²çªç­‰é—®é¢˜ï¼›åŒæ—¶å¯èƒ½ä¼šæ¯”æ”¯æŒå¹¶å‘çš„ç³»ç»Ÿæ•ˆç‡æ›´é«˜ï¼Œé¿å…é”çš„å¼€é”€ ä¸ºä»€ä¹ˆå¯è¡Œï¼Ÿ å†…å­˜æ›´ä¾¿å®œ OLTP äº‹åŠ¡é€šå¸¸å¾ˆå¿«æ‰§è¡Œå®Œï¼Œåªäº§ç”Ÿå°‘é‡è¯»å– å…¸å‹çš„ä»£è¡¨ï¼šVoltDB / H-Store, Redis å’Œ Datomic é€šå¸¸ä¸èƒ½æ”¯æŒäº¤äº’å¼çš„å¤šè¯­å¥äº‹åŠ¡ï¼ˆå¦åˆ™å¾—ç­‰å¾…å¤ªä¹…äº†ï¼‰ æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼Œä¸²è¡Œæ‰§è¡Œäº‹åŠ¡ç§‘å®ç°ä¸²è¡ŒåŒ–éš”ç¦»ï¼š äº‹åŠ¡å¿…é¡»ç®€çŸ­é«˜æ•ˆ ä»…é™äºæ´»åŠ¨æ•°æ®é›†å®Œå…¨å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„åœºæ™¯ å†™å…¥ååå¿…é¡»è¶³å¤Ÿä½ï¼Œæ‰èƒ½åœ¨å•æ ¸ä¸Šå¤„ç†ï¼›å¦åˆ™éœ€è¦é‡‡ç”¨åˆ†åŒºï¼Œä½†æœ€å¥½ä¸è¦ä½¿ç”¨è·¨åˆ†åŒºäº‹åŠ¡ï¼ˆé¿å…åè°ƒå¼€é”€ï¼‰ è·¨åˆ†åŒºäº‹åŠ¡å¯ä»¥æ”¯æŒï¼Œä½†å æ¯”å¿…é¡»è¦å° ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lock, 2PLï¼‰ 2PL æ˜¯æ¯”è¾ƒè€ç‰Œçš„ä¸²è¡ŒåŒ–ç®—æ³•ï¼Œåº”ç”¨äº MySQL InnoDB å’Œ SQL Server çš„ã€Œå¯ä¸²è¡ŒåŒ–éš”ç¦»ã€å’Œ DB2 çš„ã€Œå¯é‡å¤è¯»éš”ç¦»ã€ã€‚æ‚²è§‚äº‹åŠ¡æ¨¡å‹ã€‚ å…¸å‹ç‰¹å¾ï¼š è¯»å†™äº’æ–¥ å¹¶å‘å†™äº’æ–¥ åŸºæœ¬æ€è·¯ï¼ˆæ•°æ®åº“ä¼šä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤è¯»å†™é”æ¥éš”ç¦»è¯»å†™æ“ä½œï¼Œé”å¯ä»¥å¤„äºå…±äº«æ¨¡å¼æˆ–ç‹¬å æ¨¡å¼ï¼‰ï¼š å¦‚æœäº‹åŠ¡è¦è¯»å–å¯¹è±¡ï¼Œå¿…é¡»å…ˆä»¥å…±äº«æ¨¡å¼è·å¾—é”ã€‚å¤šä¸ªäº‹åŠ¡å¯åŒæ—¶ä»¥è·å¾—å¯¹è±¡çš„å…±äº«é”ï¼›ä½†å¦‚æœæŸä¸ªäº‹åŠ¡è·å¾—äº†å¯¹è±¡çš„ç‹¬å é”ï¼Œåˆ™å…¶ä»–äº‹åŠ¡éƒ½éœ€è¦ç­‰å¾… å¦‚æœäº‹åŠ¡è¦ä¿®æ”¹å¯¹è±¡ï¼Œå¿…é¡»ä»¥ç‹¬å æ¨¡å¼è·å–é”ã€‚å¦‚æœå¯¹è±¡å·²ç»åŠ é”ï¼ˆä¸ç®¡æ˜¯è¯»è¿˜æ˜¯å†™ï¼‰ï¼Œåˆ™è¯¥äº‹åŠ¡å¿…é¡»ç­‰å¾… å¦‚æœäº‹åŠ¡å…ˆè¯»åå†™ï¼Œåˆ™å°†å…±äº«é”å‡çº§ä¸ºç‹¬å é” äº‹åŠ¡è·å–é”åï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰ä¼šé‡Šæ”¾ ä¸¤é˜¶æ®µçš„å«ä¹‰ï¼š äº‹åŠ¡æ‰§è¡Œå‰è·å–é” äº‹åŠ¡ç»“æŸåé‡Šæ”¾é” 2PL çš„é—®é¢˜ï¼š ç³»ç»Ÿååé‡å’ŒæŸ¥è¯¢å“åº”æ—¶é—´ç›¸å¯¹äºå¼±éš”ç¦»çº§åˆ«ä¸‹é™å¾ˆå¤š é”çš„å¼€é”€å¤šï¼›äº‹åŠ¡çš„å¹¶å‘æ€§é™ä½ è®¿é—®å»¶è¿Ÿä¸ç¡®å®šæ€§é«˜ æ­»é”é—®é¢˜ï¼Œå¦‚æœæ£€æµ‹åˆ°æ­»é”ï¼Œäº‹åŠ¡ä¼šè¢«å¼ºè¡Œä¸­æ­¢ï¼ˆåº”ç”¨å±‚å¯é€‰æ‹©é‡è¯•ï¼‰ è°“è¯é”ï¼š ä¸å±äºç‰¹å®šçš„å¯¹è±¡ï¼Œä½œç”¨äºç‰¹å®šçš„æœç´¢æ¡ä»¶æŸ¥è¯¢åˆ°çš„æ‰€æœ‰å¯¹è±¡ å¯ä»¥ä¿æŠ¤æ•°æ®åº“ä¸­å°šä¸å­˜åœ¨ä½†å¯èƒ½é©¬ä¸Šä¼šè¢«æ’å…¥çš„å¯¹è±¡ï¼ˆä¼šå¼•èµ·å¹»è¯»ï¼‰ 2PL å’Œè°“è¯é”ç»“ç›Ÿï¼Œå¯é˜»æ­¢ä»»ä½•å½¢å¼çš„å†™å€¾æ–œå’Œå…¶å®ƒç«äº‰æ¡ä»¶ï¼Œä½¿å¾—éš”ç¦»çœŸæ­£ä¸²è¡ŒåŒ– ç¼ºç‚¹ï¼šæ€§èƒ½ä¸ä½³ ç´¢å¼•åŒºé—´é”ï¼ˆnext-key lockingï¼‰ æ ¸å¿ƒå°±æ˜¯å°†ä¿æŠ¤å¯¹è±¡æ‰©å¤§åŒ–ï¼Œä¸å¦‚ä¸ºè°“è¯é”ç²¾ç¡®ï¼Œä½†å¼€é”€ä½ï¼Œæ‰€ä»¥å®è·µä¸­å¸¸ç”¨ ä¼šå¯¹åˆé€‚çš„ç´¢å¼•åŠ åŒºé—´é”ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„ç´¢å¼•ï¼Œå°±å›é€€åˆ°æ•´å¼ è¡¨åŠ å…±äº«é” å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰ SSI æ˜¯ä¹è§‚äº‹åŠ¡æ¨¡å‹å®ç°ï¼Œå¦‚æœå¯èƒ½å‘ç”Ÿå†²çªï¼Œä¹Ÿä¸ä¼šé˜»æ­¢äº‹åŠ¡æäº¤ï¼Œè€Œæ˜¯åœ¨çœŸæ­£æäº¤æ—¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å†²çªï¼ˆå³è¿åéš”ç¦»æ€§åŸåˆ™ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šä¸­æ­¢å¹¶æ¥ä¸‹æ¥é‡è¯•ã€‚ é€‚ç”¨äºäº‹åŠ¡ä¹‹é—´ç«äº‰ä¸å¤§ï¼Œå†²çªè¾ƒå°‘çš„åœºæ™¯ï¼Œä¼šæ¯”æ‚²è§‚æ–¹å¼é«˜æ•ˆå¾ˆå¤šï¼ˆæ‰€ä»¥ä¹Ÿæ¯”è¾ƒé€‚ç”¨äºäº’è”ç½‘ç¯å¢ƒï¼‰ã€‚ äº‹åŠ¡æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡æ‰€æŒæœ‰çš„é”ï¼Œè¦æ±‚è¯»å†™å‹äº‹åŠ¡è¦ç®€çŸ­ï¼ˆé•¿æ—¶é—´çš„è¯»å–äº‹åŠ¡æ²¡æœ‰é™åˆ¶ï¼‰ å‚è€ƒ ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ† çŸ¥ä¹ï¼šSQL å››ç§éš”ç¦»çº§åˆ«çš„è‹¥å¹²è¿·æƒ‘ï¼Ÿ æ•°æ®åº“äº‹åŠ¡éš”ç¦»æ ‡å‡†åˆ†æ]]></content>
      <categories>
        <category>ç³»ç»Ÿè®¾è®¡</category>
      </categories>
      <tags>
        <tag>ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹</tag>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®å¤åˆ¶å’Œåˆ†åŒº]]></title>
    <url>%2F2019%2F08%2F18%2Fddia-data-replication-and-partition%2F</url>
    <content type="text"><![CDATA[å¼•è¨€å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ç³»ç»ŸåŸºç¡€å­¦ä¹ åï¼Œå°±å¼€å§‹è¿›å…¥åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿçš„ä¸–ç•Œäº†ã€‚å‰é¢å­¦ä¹ çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„æƒ…å†µï¼›ç„¶è€Œï¼Œåœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„æ‰©å±•æ€§ã€å®¹é”™æ€§ä»¥åŠå»¶è¿Ÿæ€§ç­‰ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é€šå¸¸ä¼šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚åº¦è‡ªç„¶ä¹Ÿä¸Šæ¥äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä¸»è¦å­¦ä¹ æ•°æ®ç³»ç»Ÿçš„å¤åˆ¶ã€åˆ†åŒºã€äº‹åŠ¡ã€ä¸€è‡´æ€§å…±è¯†ç®—æ³•ã€ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„ä¸€äº›æŒ‘æˆ˜ç­‰ï¼Œè¿™äº›çŸ¥è¯†éƒ½æ¯”è¾ƒç¡¬æ ¸ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚æ‰€ä»¥ï¼Œã€Œä¸Šè½¦ï¼Œèµ°å§~ã€ æœ¬ç¯‡ç¬”è®°é‡ç‚¹æ˜¯å…³äºæ•°æ®ç³»ç»Ÿçš„å¤åˆ¶å’Œåˆ†åŒºï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§„çš„ä¸»ä»å¤åˆ¶åŸç†ã€å¤šä¸»å¤åˆ¶çš„åº”ç”¨åœºæ™¯ï¼Œå¦å¤–è¿˜ä»‹ç»äº†æ— ä¸»å¤åˆ¶çš„ç³»ç»Ÿï¼ˆå¦‚äºšé©¬é€Š Dynamo ç³»ç»Ÿï¼‰ã€‚æœ€åå°±æ˜¯å…³äºæ•°æ®åˆ†åŒºçš„ä»‹ç»ï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§çš„åˆ†åŒºç­–ç•¥ï¼ŒåŠ¨æ€å¹³è¡¡ç­–ç•¥ç­‰ã€‚ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿå…±äº«æ¶æ„é’ˆå¯¹å…±äº«æ¶æ„ï¼Œå¦‚æœè´Ÿè½½å¢åŠ ï¼Œæœ€å¸¸è§çš„æ‰©å±•æ–¹å¼å°±æ˜¯é‡‡ä¹°æ›´å¼ºå¤§çš„ CPUã€æ·»åŠ æ›´å¤šçš„å†…å­˜ç­‰ã€‚è¿™ç§è¢«ç§°ä¸ºå‚ç›´æ‰©å±•ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸ä¸€å®šå¥æ•ˆï¼Œå¤©èŠ±æ¿æ˜¯çœ‹å¾—è§çš„ã€‚å¹¶ä¸”æ‰©å±•çš„æˆæœ¬éçº¿æ€§ï¼Œè€Œåº”å¯¹è´Ÿè½½çš„èƒ½åŠ›å´ä¸ä¸€å®šèƒ½çº¿æ€§æé«˜ã€‚ æ— å…±äº«æ¶æ„åœ¨æ— å…±äº«æ¶æ„ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹çš„ CPUã€å†…å­˜å’Œç£ç›˜ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡é‡‡ç”¨ä»¥å¤ªç½‘ã€‚è¯¥æ¶æ„æ— éœ€ç‰¹æ®Šçš„ç¡¬ä»¶æ”¯æŒï¼Œæ€§ä»·æ¯”é«˜ã€‚æ‰©å±•æ€§å¥½ï¼ˆæ°´å¹³æ‰©å±•ï¼‰ï¼Œå¹¶ä¸”æœ‰å¼ºå¤§çš„å®¹é”™èƒ½åŠ›å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚ä¸è¿‡è¿™ç§æ¶æ„æœ€å¤§çš„é—®é¢˜æ˜¯ä¼šå¸¦æ¥æ›´å¤§çš„å¤æ‚æ€§ï¼Œç”šè‡³ä¼šé™åˆ¶å®é™…å¯ä½¿ç”¨çš„æ•°æ®æ¨¡å‹ã€‚ æ•°æ®å¤åˆ¶ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ æ¯ä¸ªä¿å­˜äº†æ•°æ®åº“å®Œæ•´æ•°æ®é›†çš„èŠ‚ç‚¹å«ä½œå‰¯æœ¬ ä¸»ä»å¤åˆ¶æ–¹æ¡ˆï¼š æŒ‡å®šæŸä¸ªå‰¯æœ¬ä¸ºä¸»å‰¯æœ¬ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ã€‚å†™å…¥ä¼šå‘ç»™ä¸»èŠ‚ç‚¹ ä¸»èŠ‚ç‚¹åœ¨å°†æ–°æ•°æ®å­˜å‚¨åï¼Œå°†æ›´æ”¹ä½œä¸ºå¤åˆ¶çš„æ—¥å¿—æˆ–è€…æ›´æ”¹æµçš„æ–¹å¼å‘ç»™ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹è·å–æ›´æ”¹æ—¥å¿—ï¼Œå¹¶åº”ç”¨åˆ°æœ¬åœ°ï¼Œè¿™é‡Œå¿…é¡»è¦ä¿æŒå’Œä¸»å‰¯æœ¬ç›¸åŒçš„å†™å…¥é¡ºåº å®¢æˆ·ç«¯è¯»å–æ—¶ï¼Œå¯è¯»å–ä»å‰¯æœ¬çš„æ•°æ® åŒæ­¥å¤åˆ¶ v.s. å¼‚æ­¥å¤åˆ¶ å¯¹äºå…³ç³»æ•°æ®åº“ï¼Œä¸¤ç§å¤åˆ¶æ–¹å¼é€šå¸¸æ˜¯å¯é…ç½®çš„ï¼›è€Œå…¶ä»–ç³»ç»Ÿå¯èƒ½åªå¯æŒ‡å®šå…¶ä¸­ä¸€ç§æ–¹å¼ã€‚ åŒæ­¥å¤åˆ¶ï¼š ä¼˜ç‚¹ï¼šä¸€æ—¦å‘ç”¨æˆ·ç¡®è®¤å†™å…¥è¯·æ±‚ï¼Œåˆ™ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œå¹¶éƒ½å¤„äºæœ€æ–°ç‰ˆæœ¬ã€‚ä¸»åº“å®•æœºï¼Œä¹Ÿå¯ä»¥æ”¾å¿ƒä»ä»åº“è¯»å–ã€‚ ç¼ºç‚¹ï¼šå¦‚æœä»èŠ‚ç‚¹æ— æ³•å®Œæˆç¡®è®¤ï¼ˆå¦‚ç½‘ç»œæ‹¥å¡ã€æ•…éšœç­‰ï¼‰ï¼Œå†™å…¥ä¼šå¤±è´¥ã€‚ä¸»èŠ‚ç‚¹ä¼šé˜»å¡åç»­å†™è¯·æ±‚ï¼Œé™ä½ç³»ç»Ÿååé‡å’Œå¯é æ€§ã€‚ åŠåŒæ­¥ï¼šå®è·µä¸­ï¼Œå¦‚æœå¼€å¯äº†åŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œé€šå¸¸æ˜¯å…¶ä¸­çš„æŸä¸ªä»èŠ‚ï¼ˆå¯æ ¹æ®æƒ…å†µé€‰æ‹©å…¶ä»–ä»èŠ‚ç‚¹æå‡ä¸ºåŒæ­¥æ¨¡å¼ï¼‰ç‚¹ä¸ºåŒæ­¥å¤åˆ¶ï¼Œè€Œå…¶ä»–ä¸ºå¼‚æ­¥å¤åˆ¶æ¨¡å¼ã€‚ å…¨å¼‚æ­¥ï¼š ä¼˜ç‚¹ï¼šç³»ç»Ÿçš„ååæ€§èƒ½å¾ˆå¥½ ç¼ºç‚¹ï¼šæ•°æ®çš„æŒä¹…åŒ–æ— æ³•å¾—åˆ°ä¿è¯ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±çš„æƒ…å†µ é…ç½®æ–°çš„ä»èŠ‚ç‚¹ ä»€ä¹ˆæ—¶å€™éœ€è¦ï¼Ÿ æé«˜è´Ÿè½½èƒ½åŠ› æä¾›å®¹é”™èƒ½åŠ› æ›¿æ¢å¤±è´¥çš„å‰¯æœ¬ è¦æƒ³åšåˆ°ä¸åœæœºå®Œæˆæ–°èŠ‚ç‚¹æ·»åŠ ï¼Œé€»è¾‘ä¸Šä¸»è¦æ“ä½œå¦‚ä¸‹ï¼š ç”Ÿæˆå¿«ç…§ï¼šåœ¨æŸåˆ»å¯¹ä¸»èŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬äº§ç”Ÿä¸€ä¸ªä¸€è‡´æ€§å¿«ç…§ï¼ˆé¿å…é•¿æ—¶é—´é”åº“ï¼‰ å¿«ç…§å‘é€ï¼šå¿«ç…§å‘é€åˆ°æ–°çš„ä»èŠ‚ç‚¹ï¼ˆè¿™æ ·å¤§éƒ¨åˆ†çš„å†å²æ•°æ®å°±æœ‰äº†ï¼‰ å˜æ›´æ—¥å¿—ï¼šä»èŠ‚ç‚¹ä¸Šçº¿è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ï¼Œè¯·æ±‚å¿«ç…§ç‚¹ä¹‹åå‘ç”Ÿçš„æ‰€æœ‰æ•°æ®æ›´æ”¹æ—¥å¿—ï¼ˆå¢é‡ï¼‰ è¿½èµ¶ï¼šè·å¾—æ—¥å¿—åï¼Œä»èŠ‚ç‚¹åº”ç”¨å¿«ç…§åçš„æ•°æ®å˜æ›´ã€‚ç»§ç»­å¤„ç†ä¸»èŠ‚ç‚¹ä¸Šæ–°æ•°æ®å˜åŒ–ã€‚å¹¶é‡å¤æ­¥éª¤ 1~4 èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ ä»èŠ‚ç‚¹å¤±æ•ˆï¼šè¿½èµ¶å¼æ¢å¤ã€‚ä»èŠ‚ç‚¹å¯æ ¹æ®å‰¯æœ¬çš„å¤åˆ¶æ—¥å¿—å¾—çŸ¥æ•…éšœå‰æœ€åä¸€ç¬”äº‹åŠ¡ï¼Œç„¶åå‘ä¸»èŠ‚ç‚¹è¯·æ±‚è¯¥äº‹åŠ¡ä¹‹åä¸­æ–­æœŸé—´å†…çš„æ‰€æœ‰æ•°æ®å˜æ›´ï¼Œå¹¶åº”ç”¨å˜æ›´ï¼Œå®Œæˆè¿½èµ¶ã€‚ ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼šèŠ‚ç‚¹åˆ‡æ¢ï¼š æ•…éšœåˆ‡æ¢å¯æ‰‹åŠ¨ï¼Œå¯è‡ªåŠ¨ã€‚ è‡ªåŠ¨åˆ‡æ¢å¸¸è§„æ­¥éª¤ï¼š ç¡®å®šä¸»èŠ‚ç‚¹å¤±æ•ˆã€‚å¤šé‡‡ç”¨åŸºäºè¶…æ—¶çš„æœºåˆ¶ï¼Œå¯ä»¥å‘¨æœŸæ€§åœ°å‘é€å¿ƒè·³åŒ…ã€‚ é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ã€‚æ¶‰åŠåˆ°å…±è¯†çš„ç®—æ³•ï¼ŒåŸåˆ™æ˜¯è¦ä¿è¯æ–°çš„ä¸»èŠ‚ç‚¹ä¸åŸæ¥çš„æ•°æ®å·®å¼‚æœ€å°ï¼Œå°½å¯èƒ½å‡å°‘æ•°æ®ä¸¢å¤±é£é™©ã€‚ é‡æ–°é…ç½®ç³»ç»Ÿï¼Œç”Ÿæ•ˆä¸»èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯éœ€è¦å°†å†™è¯·æ±‚å‘é€åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¯¹äºåŸä¸»èŠ‚ç‚¹æ¢å¤åéœ€è¦ç¡®ä¿å…¶è¢«é™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œè®¤å¯æ–°çš„ä¸»èŠ‚ç‚¹ã€‚ éœ€è¦æ€è€ƒçš„é—®é¢˜ï¼š å¦‚æœé‡‡ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾åï¼ŒåŸä¸»èŠ‚ç‚¹ä¹Ÿä¸Šçº¿ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹å¯èƒ½ä¼šæ”¶åˆ°å†™å†²çªã€‚ç®€å•ç²—æš´çš„æ–¹å¼å°±æ˜¯ï¼ŒæŠ›å¼ƒåŸä¸»èŠ‚ç‚¹æœªå®Œæˆå¤åˆ¶çš„å†™è¯·æ±‚ï¼Œè¿èƒŒæ•°æ®æŒä¹…åŒ–æ‰¿è¯ºã€‚ è„‘è£‚ï¼ˆBrain-Splitï¼‰é—®é¢˜ï¼Œä¸¤ä¸ªä¸»èŠ‚ç‚¹éƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œä¼šå¯¼è‡´æ•°æ®å†²çªã€ä¸¢å¤±æˆ–è€…ç ´åç­‰ã€‚å¯ç²—æš´åœ°å…³é—­æŸä¸ªä¸»èŠ‚ç‚¹ã€‚ è¶…æ—¶è®¾ç½®å¤šä¹…æ‰åˆé€‚ï¼Ÿå¤ªé•¿ï¼Œæ„å‘³ç€ä¸»èŠ‚ç‚¹å®•æœºåï¼Œæ€»ä½“æ¢å¤æ—¶é—´å˜é•¿ï¼›å¤ªçŸ­ï¼Œä¼šå¯¼è‡´å¾ˆå¤šä¸å¿…è¦çš„åˆ‡æ¢ã€‚å°¤å…¶æ˜¯ç³»ç»Ÿå¤„äºé«˜è´Ÿè½½çš„å‹åŠ›ä¸‹ï¼ŒåŒæ—¶ç½‘ç»œæ‹¥å¡ä¸¥é‡ï¼Œä¸å¿…è¦çš„åˆ‡æ¢ä¼šå¯¼è‡´æƒ…å†µæ›´åŠ ç³Ÿç³•ã€‚ å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç° åŸºäºè¯­å¥çš„å¤åˆ¶ï¼š çœ‹èµ·æ¥ä¸å¤æ‚ ä¸é€‚ç”¨çš„åœºæ™¯ï¼šè°ƒç”¨éç¡®å®šæ€§å‡½æ•°çš„è¯­å¥ï¼›å‰¯æœ¬éœ€è¦ä¸¥æ ¼æŒ‰ç…§å®Œå…¨ç›¸åŒçš„é¡ºåºæ‰§è¡Œè¯­å¥ï¼ˆé’ˆå¯¹ä¾èµ–æ•°æ®åº“çš„ç°æœ‰æ•°æ®çš„æƒ…å†µï¼‰ï¼›æœ‰å‰¯ä½œç”¨çš„è¯­å¥ï¼Œåœ¨ä¸åŒçš„èŠ‚ç‚¹å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„å‰¯ä½œç”¨ åŸºäº WAL ä¼ è¾“ï¼š å¯ä»¥åŸºäº WAL æ„å»ºä¸€ä¸ªå®Œæ•´çš„å‰¯æœ¬ æ—¥å¿—æè¿°çš„æ•°æ®ç»“æ„å¾ˆåº•å±‚ï¼Œå¤åˆ¶æ–¹æ¡ˆä¸å­˜å‚¨å¼•æ“ç´§å¯†è€¦åˆï¼›åè®®ç‰ˆæœ¬å‡çº§éœ€è¦é¡¾è™‘çš„è¾ƒå¤š åŸºäºè¡Œçš„é€»è¾‘æ—¥å¿—å¤åˆ¶ï¼š é€»è¾‘æ—¥å¿—ï¼ŒåŒºåˆ†ç‰©ç†å­˜å‚¨å¼•æ“çš„æ•°æ®è¡¨ç¤ºã€‚æè¿°æ•°æ®è¡¨è¡Œçº§åˆ«çš„å†™è¯·æ±‚ã€‚ ä¸å­˜å‚¨å¼•æ“é€»è¾‘è§£è€¦ï¼Œä¾¿äºä¿æŒå‘åå…¼å®¹ã€‚è¿™æ ·ä¸»ä»èŠ‚ç‚¹ç”šè‡³å¯ä»¥è¿è¡Œä¸åŒçš„ç‰ˆæœ¬æˆ–è€…ä½¿ç”¨ä¸åŒçš„å­˜å‚¨å¼•æ“ã€‚ å®¹æ˜“è§£æï¼Œæ˜“äºå¤–éƒ¨ç³»ç»Ÿå¤„ç† åŸºäºè§¦å‘å™¨çš„å¤åˆ¶ï¼šç»™åº”ç”¨å±‚æä¾›äº†ä¸€å®šçš„çµæ´»æ€§ï¼Œä½†æ˜¯å¤åˆ¶å¼€é”€æ›´é«˜ã€‚ å¤åˆ¶æ»åé—®é¢˜è¯»è‡ªå·±çš„å†™ï¼ˆRead After Writeï¼‰ è¯¥æœºåˆ¶è¦ä¿è¯ç”¨æˆ·æ€»èƒ½çœ‹åˆ°è‡ªå·±æœ€è¿‘æäº¤çš„æ›´æ–°ã€‚ å¦‚ä½•å®ç°ï¼Ÿ å¦‚æœç”¨æˆ·è®¿é—®å¯èƒ½è¢«ä¿®æ”¹çš„å†…å®¹ï¼Œåˆ™ä»ä¸»èŠ‚ç‚¹è¯»ï¼›å¦åˆ™ä»ä»èŠ‚ç‚¹è¯»ã€‚ é’ˆå¯¹å¤§éƒ¨åˆ†éƒ½ä¼šè¢«ä¿®æ”¹çš„åœºæ™¯ï¼Œä¸Šè¿°æ–¹å¼ä¼šä¸§å¤±ä»èŠ‚ç‚¹çš„å­˜åœ¨æ„ä¹‰ã€‚å¯ä»¥è€ƒè™‘è·Ÿè¸ªæœ€æ–°çš„æ›´æ–°æ—¶é—´ï¼Œå¯¹äºæ›´æ–°æ—¶é—´åœ¨æœ€è¿‘ä¸€åˆ†é’Ÿçš„ï¼Œä»ä¸»èŠ‚ç‚¹è¯»å–ã€‚åŒæ—¶éœ€è¦æ·»åŠ ç›‘æ§ã€‚ å•è°ƒè¯» ç”¨æˆ·åœ¨è¯»å–ä¿®æ”¹äº†çš„æ•°æ®æ—¶ï¼Œå‡ºç°ã€Œå›æ»šã€çš„ç°è±¡ã€‚ä¹Ÿå°±æ˜¯æ˜æ˜ä¿®æ”¹äº†ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™çœ‹åˆ°äº†æ–°çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¯»å–çš„æ—¶å€™å´çœ‹åˆ°äº†æ—§çš„æ•°æ®ï¼ˆå¤šèŠ‚ç‚¹æ•°æ®æœªåŒæ­¥ï¼‰ã€‚ å•è°ƒè¯»è¦æä¾›çš„ä¿è¯å°±æ˜¯é¿å…è¿™ç§å¥‡æ€ªçš„å›æ»šç°è±¡ï¼Œå®ƒæ¯”å¼ºä¸€è‡´æ€§è¦å¼±ï¼Œä½†æ¯”æœ€ç»ˆä¸€è‡´æ€§è¦å¼ºã€‚ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥è€ƒè™‘åŒä¸€ä¸ªç”¨æˆ·æ€»æ˜¯ä»æŸä¸ªå›ºå®šçš„å‰¯æœ¬è¯»å–ï¼ˆä¸åŒçš„ç”¨æˆ·åˆ†å‘åˆ°ä¸åŒçš„å‰¯æœ¬ï¼‰ã€‚ å‰ç¼€ä¸€è‡´è¯» è¯¥æœºåˆ¶è¦ä¿è¯å¯¹äºä¸€ç³»åˆ—æŒ‰ç…§ç‰¹å®šé¡ºåºçš„å†™è¯·æ±‚ï¼Œåœ¨è¯»å–è¿™äº›å†…å®¹æ—¶è¦è¦éµå¾ªåŒæ ·çš„é¡ºåºã€‚å¦åˆ™å¯èƒ½ä¼šçœ‹åˆ°å…ˆæœ‰æœï¼Œå†æœ‰å› çš„å¥‡æ€ªç°è±¡ï¼Œä»¿ä½›é‡åˆ°äº†å…ˆçŸ¥ã€‚ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æ‹¥æœ‰å› æœå…³ç³»çš„å†™å…¥éƒ½æäº¤ç»™æŸä¸ªç‰¹å®šåˆ†åŒºå®Œæˆï¼Œä½†æ˜¯å®é™…æ•ˆç‡æ¯”è¾ƒä½ã€‚ å¤šä¸»èŠ‚ç‚¹å¤åˆ¶ ä¸»ä»æ¨¡å¼çš„ç¼ºç‚¹ï¼šç³»ç»Ÿä»…æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ‰¿è½½æ‰€æœ‰çš„å†™è¯·æ±‚ã€‚å¦‚æœä¸»èŠ‚ç‚¹å®•æœºï¼Œä¼šå½±å“æ‰€æœ‰çš„å†™å…¥æ“ä½œã€‚ å¤šä¸»èŠ‚ç‚¹å¤åˆ¶ï¼š æ¯ä¸ªä¸»èŠ‚ç‚¹åˆ†åˆ«æ¥å—å†™è¯·æ±‚ï¼Œå¹¶å¤åˆ¶ï¼ˆå¼‚æ­¥ or åŒæ­¥ï¼‰ç»™å¯¹åº”çš„ä»èŠ‚ç‚¹ æ¯ä¸ªä¸»èŠ‚ç‚¹æ‰®æ¼”å…¶å®ƒä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ é€‚ç”¨åœºæ™¯ å¤šæ•°æ®ä¸­å¿ƒ ç¦»çº¿å®¢æˆ·ç«¯æ“ä½œï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ WizNoteï¼‰ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½å……å½“ä¸»èŠ‚ç‚¹çš„æœ¬åœ°æ•°æ®åº“ï¼Œè®¾å¤‡ä¹‹é—´é‡‡ç”¨å¼‚æ­¥åŒæ­¥æ–¹å¼å®Œæˆæ•°æ®åŒæ­¥ã€‚åŒæ­¥æ»åæ—¶é—´ä¸å®šã€‚ åä½œç¼–è¾‘ æ— ä¸»èŠ‚ç‚¹å¤åˆ¶ äºšé©¬é€Šçš„ Dynamo ç³»ç»Ÿæ˜¯å…¸å‹çš„ä»£è¡¨ï¼ŒRiakã€Cassandra ä¹Ÿå—åˆ°äº†å¯å‘ã€‚ å®¢æˆ·ç«¯ç›´æ¥å°†å†™è¯·æ±‚å‘é€ç»™å¤šä¸ªå‰¯æœ¬ï¼Œæˆ–è€…äº¤ç»™åè°ƒè€…ï¼ˆä¸ä¿è¯å†™å…¥é¡ºåºï¼‰æ¥å‘é€ã€‚ æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼Ÿ è¯»æ—¶ä¿®å¤ åç†µï¼šè¡¥å¿æœºåˆ¶ï¼Œå¯»æ‰¾èŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œå°†ç¼ºå°‘çš„æ•°æ®ç»™è¡¥å……å¥½ã€‚è¯¥è¿‡ç¨‹ä¸ä¿è¯ç‰¹å®šé¡ºåºçš„å¤åˆ¶å†™å…¥ã€‚ è¯»å†™ quorumï¼š ä¿è¯ï¼šw + r &gt; nï¼ˆæ€»èŠ‚ç‚¹æ•°ï¼‰ é€šå¸¸ n ä¸ºå¥‡æ•°ï¼Œw = r = (n+1)/2 ï¼ˆå‘ä¸Šèˆå…¥ï¼‰ quorum ä¸ä¸€å®šéå¾—æ˜¯å¤šæ•°ï¼Œè¯»å†™èŠ‚ç‚¹é›†åˆä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯é‡å çš„èŠ‚ç‚¹æ‰æœ€ä¸ºå…³é”®ï¼ ä¸èƒ½ä¿è¯æ€»èƒ½è¯»å–åˆ°æœ€æ–°å€¼ï¼ŒDynamo æ•°æ®åº“é€šå¸¸é’ˆå¯¹æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ä¼˜åŒ–çš„ã€‚ å¹¶å‘æ£€æµ‹ï¼ˆè¿™å—è¿˜æ˜¯å»ºè®®çœ‹ä¹¦ä¸­çš„ä¾‹å­å§ï¼‰ï¼š æœ€åå†™å…¥è€…è·èƒœï¼ˆLWWï¼‰ï¼Œä¸¢å¼ƒå¹¶å‘å†™å…¥ã€‚å¯å®ç°æœ€ç»ˆæ”¶æ•›ç›®æ ‡ï¼Œä½†æ˜¯ç‰ºç‰²äº†æ•°æ®æŒä¹…æ€§ä¸ºä»£ä»·ã€‚ Happens-before å…³ç³»ä¸å¹¶å‘ ç¡®å®šå‰åå…³ç³»ï¼šä½¿ç”¨ç‰ˆæœ¬å· åˆå¹¶åŒæ—¶å†™å…¥çš„å€¼ ç‰ˆæœ¬çŸ¢é‡ æ•°æ®åˆ†åŒº å®šä¹‰ï¼šæ¯æ¡æ•°æ®ï¼ˆæˆ–è€…è®°å½•ã€æ–‡æ¡£ï¼‰åªå±äºæŸä¸ªç‰¹å®šåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯è§†ä¸ºä¸€ä¸ªå®Œæ•´çš„å°å‹æ•°æ®åº“ï¼Œæ˜¯æ•´ä¸ªæ•°æ®é›†çš„ä¸€éƒ¨åˆ†ã€‚ ä¸ºä»€ä¹ˆè¦åˆ†åŒºï¼Ÿ æé«˜ç³»ç»Ÿæ‰©å±•æ€§ï¼šå°†å¤§çš„æ•°æ®é›†åˆ†æ•£åˆ°æ›´å¤šçš„èŠ‚ç‚¹ï¼Œè´Ÿè½½å‡è¡¡ æé«˜æŸ¥è¯¢ååé‡ï¼šè·¨åˆ†åŒºå¹¶å‘æŸ¥è¯¢ åˆ†åŒºå’Œå¤åˆ¶é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œæ¯ä¸ªåˆ†åŒºåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å‰¯æœ¬ï¼Œæé«˜ç³»ç»Ÿçš„å®¹é”™æ€§ï¼š KV æ•°æ®åˆ†åŒº åˆ†åŒºå¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼š åˆ†åŒºä¸å‡åŒ€ï¼Œä¼šé€ æˆè®¿é—®å€¾æ–œçš„é—®é¢˜ï¼Œç”šè‡³å¯èƒ½é€ æˆçƒ­ç‚¹ å¯é‡‡ç”¨éšæœºåˆ†é…åˆ°æ‰€æœ‰èŠ‚ç‚¹é¿å…çƒ­ç‚¹é—®é¢˜ï¼Œä½†æ˜¯æŸ¥è¯¢ä¼šå¾ˆå›°éš¾ï¼ˆå¯èƒ½éœ€è¦å¹¶å‘è¯·æ±‚æ‰€æœ‰åˆ†åŒºï¼‰ åŸºäºå…³é”®å­—åŒºé—´åˆ†åŒºï¼š æ ¸å¿ƒæ˜¯ä¸ºæ¯ä¸ªåˆ†åŒºåˆ†é…ä¸€æ®µè¿ç»­çš„å…³é”®å­—æˆ–è€…å…³é”®å­—åŒºé—´ï¼ˆä»¥æœ€å°å€¼å’Œæœ€å¤§å€¼æ¥è¡¨ç¤ºï¼‰ å…³é”®å­—åŒºé—´æ®µä¸ä¸€å®šè¦å‡åŒ€åˆ†å¸ƒ æ”¯æŒåŒºé—´æŸ¥è¯¢æ–¹ä¾¿ï¼ˆæœ‰ä¸€å®šé¡ºåºï¼‰ å¯èƒ½ä¼šæœ‰çƒ­ç‚¹é—®é¢˜ï¼ˆæ¯”å¦‚æŒ‰ç…§æ—¶é—´æˆ³èŒƒå›´åˆ’åˆ†ï¼Œå¯èƒ½æœ€æ–°çš„æ—¥æœŸè¯»å†™å°±å¾ˆå¤šï¼‰ï¼Œå¯ä»¥è€ƒè™‘å†æ·»åŠ åˆ«çš„å­—æ®µæ¥ç»„åˆå†³å®šåˆ†åŒº åŸºäºå…³é”®å­—å“ˆå¸Œå€¼åˆ†åŒºï¼š å¥½çš„å“ˆå¸Œå‡½æ•°å¯å¤„ç†æ•°æ®å€¾æ–œï¼Œå‡åŒ€åˆ†å¸ƒ ä¸§å¤±è‰¯å¥½çš„åŒºé—´æŸ¥è¯¢ç‰¹æ€§ è´Ÿè½½å€¾æ–œå’Œçƒ­ç‚¹ï¼š å³ä¾¿é€šè¿‡å“ˆå¸Œå€¼åˆ†åŒºçš„æ–¹æ¡ˆï¼Œä¹Ÿä¸èƒ½å®Œå…¨é¿å…çƒ­ç‚¹é—®é¢˜ã€‚æç«¯æƒ…å†µæ˜¯ï¼Œæ‰€æœ‰çš„è¯»å†™éƒ½é’ˆå¯¹åŒä¸€ä¸ªå…³é”®å­—ï¼ˆå¦‚å¾®åšå¤§ Vï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½åˆ°äº†åŒä¸€ä¸ªåˆ†åŒºã€‚ å¤§å¤šæ•°ç³»ç»Ÿæ— æ³•è‡ªåŠ¨æ¶ˆé™¤è¿™ç§é«˜åº¦å€¾æ–œçš„è´Ÿè½½ï¼Œéœ€è¦åº”ç”¨å±‚ä»‹å…¥ã€‚ åˆ†åŒºå’ŒäºŒçº§ç´¢å¼• äºŒçº§ç´¢å¼•çš„æŒ‘æˆ˜æ˜¯ä¸èƒ½è§„æ•´åœ°æ˜ å°„åˆ°åˆ†åŒºä¸­ã€‚ åŸºäºæ–‡æ¡£åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š æ¯ä¸ªåˆ†åŒºåªå…³æ³¨è‡ªå·±çš„åˆ†åŒºçš„æ–‡æ¡£ï¼Œå¹¶å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼• æŸ¥è¯¢æ—¶å»¶è¿Ÿæ”¾å¤§ä¸¥é‡ï¼Œéœ€è¦åˆ†æ•£æŸ¥è¯¢å¹¶åˆå¹¶ç»“æœï¼Œä»£ä»·è¾ƒé«˜ åŸºäºè¯æ¡åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š å¯¹æ‰€æœ‰æ•°æ®æ„å»ºå…¨å±€ç´¢å¼•ï¼›å…¨å±€ç´¢å¼•å¹¶éå­˜å‚¨åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆä¼šè¿›è¡Œåˆ†åŒºï¼‰ï¼Œå¯ä»¥å’Œå…³é”®å­—é‡‡å–ä¸åŒçš„åˆ†åŒºç­–ç•¥ å¯æ”¯æŒé«˜æ•ˆåœ°åŒºé—´æŸ¥è¯¢ è¯»å–é«˜æ•ˆï¼Œä¸éœ€è¦ scatter/gather æ¨¡å¼ å†™å…¥é€Ÿåº¦æ…¢ï¼Œä¸”å¾ˆå¤æ‚ï¼Œä¼šæœ‰æ˜¾è‘—çš„å†™æ”¾å¤§é—®é¢˜ æ‰€æœ‰ç°æœ‰çš„æ•°æ®åº“éƒ½éš¾ä»¥æ”¯æŒåŒæ­¥æ›´æ–°äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥é€šå¸¸éƒ½æ˜¯å¼‚æ­¥æ›´æ–° åˆ†åŒºå†å¹³è¡¡ å³å°†æ•°æ®å’Œè¯·æ±‚ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§è¿ç§»è´Ÿè½½çš„è¿‡ç¨‹è¢«å«ä½œå†å¹³è¡¡ï¼ˆåŠ¨æ€å¹³è¡¡ï¼‰ ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ï¼Ÿ æŸ¥è¯¢å‹åŠ›å¢åŠ ï¼Œéœ€è¦å¢åŠ  CPU å¤„ç†è´Ÿè½½ æ•°æ®è§„æ¨¡å¢åŠ  èŠ‚ç‚¹æ•…éšœ å†å¹³è¡¡éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼š å¹³è¡¡ä¹‹åï¼Œè´Ÿè½½ã€æ•°æ®å­˜å‚¨ã€è¯»å†™è¯·æ±‚ç­‰åœ¨é›†ç¾¤èŒƒå›´æ›´åŠ å‡åŒ€åˆ†å¸ƒ å¹³è¡¡è¿‡ç¨‹ä¸èƒ½å½±å“çº¿ä¸ŠæœåŠ¡ é¿å…ä¸å¿…è¦çš„è´Ÿè½½è¿ç§»ï¼Œå°½é‡å‡å°‘ç½‘ç»œå’Œç£ç›˜ I/O å½±å“ åŠ¨æ€å¹³è¡¡ç­–ç•¥ ç›´æ¥å–æ¨¡æ€ä¹ˆæ ·ï¼Ÿ æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æ¯”å¦‚ç”¨æˆ· ID å’Œåˆ†åŒºæ•°é‡å–æ¨¡ï¼Œå¾—åˆ°å…·ä½“è¦è®¿é—®çš„åˆ†åŒºå¯¹åº”çš„èŠ‚ç‚¹ æ‰©å±•æˆ–ç§»é™¤èŠ‚ç‚¹å›°éš¾ï¼Œæ¶‰åŠåˆ°å¤§é‡æ•°æ®çš„ç§»åŠ¨ï¼Œåº”ç”¨å±‚ä»£ç ä¹Ÿå¯èƒ½ä¼šè¢«æ³¢åŠ å›ºå®šæ•°é‡çš„åˆ†åŒºï¼š åˆå§‹æ—¶æ ¹æ®é•¿è¿œè§„åˆ’ï¼Œè®¾ç½®ä¸€ä¸ªè¿œè¶…å®é™…èŠ‚ç‚¹æ•°çš„åˆ†åŒºæ•°ï¼ˆæ¯”å¦‚ 1000ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å¤šä¸ªåˆ†åŒºã€‚æ¯ä¸ªåˆ†åŒºçš„å¤§å°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³ã€‚ æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œä»å…¶ä»–èŠ‚ç‚¹åŒ€èµ°è‹¥å¹²åˆ†åŒºï¼Œç›´åˆ°å†æ¬¡è¾¾åˆ°å…¨å±€å¹³è¡¡ï¼›åˆ é™¤èŠ‚ç‚¹ï¼Œåˆ™é‡‡å–ç›¸åçš„æªæ–½ã€‚ éœ€è¦æ”¹å˜åˆ†åŒºå’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼›ä½†æ˜¯æ€»çš„åˆ†åŒºæ•°ä¸ä¼šå˜ï¼Œå…³é”®å­—æ˜ å°„ä¹Ÿä¸ä¼šå˜ã€‚ å¯¹äºæ•°æ®è§„æ¨¡é«˜åº¦ä¸ç¡®å®šæˆ–è€…å¯å˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚ Riak, ES, Couchbase ç­‰æ”¯æŒè¿™ç§åŠ¨æ€å¹³è¡¡ç­–ç•¥ã€‚ åŠ¨æ€åˆ†åŒº å¦‚ HBase å’Œ RethinkDBï¼Œå¯ä»¥åœ¨åˆ†åŒºæ•°æ®å¢é•¿åˆ°æŸä¸ªé˜ˆå€¼ï¼ˆHBase é»˜è®¤é˜ˆå€¼ä¸º 10GBï¼‰è‡ªåŠ¨æ‹†åˆ†æˆä¸¤ä¸ªåˆ†åŒºï¼›å¦‚æœæ•°æ®è¢«å¤§é‡åˆ é™¤ï¼Œä¸”åˆ†åŒºç¼©å°åˆ°æŸä¸ªé˜ˆå€¼ï¼Œå°†ç›¸é‚»çš„åˆ†åŒºè¿›è¡Œåˆå¹¶ã€‚ç±»ä¼¼ B æ ‘åˆ†è£‚ã€‚ åˆ†åŒºæ•°é‡è‡ªåŠ¨é€‚é…åˆ†åŒºæ€»é‡ï¼Œå°‘é‡æ•°æ®-&gt;å°‘é‡åˆ†åŒº-&gt;è¾ƒå°çš„ç³»ç»Ÿå¼€é”€ï¼›æ¯ä¸ªåˆ†åŒºæœ€å¤§å€¼å¯è¢«é™åˆ¶ã€‚åˆ†åŒºæ€»æ•°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³ã€‚ é¢„åˆ†è£‚å¯é¿å…åˆæœŸå…ˆéªŒæ¡ä»¶ä¸è¶³ï¼Œæ— æ³•ç¡®å®šè¾ƒé€‚åˆçš„è¾¹ç•Œï¼Œå¯¼è‡´å†™å…¥éƒ½é›†ä¸­åœ¨å•ä¸ªèŠ‚ç‚¹å¤„ç†çš„é—®é¢˜ã€‚HBase å’Œ MongoDB éƒ½æ”¯æŒé…ç½®åˆå§‹åˆ†åŒºã€‚ é€‚åˆå…³é”®å­—åŒºé—´åˆ†åŒºå’Œå“ˆå¸Œåˆ†åŒºç­–ç•¥ã€‚ æŒ‰èŠ‚ç‚¹æ¯”ä¾‹åˆ†åŒºï¼šCassandra å’Œ Ketama é‡‡ç”¨äº†å°†åˆ†åŒºæ•°å’Œé›†ç¾¤èŠ‚ç‚¹æ•°æˆæ­£æ¯”å…³ç³»çš„æ–¹å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºæ•°å›ºå®šï¼š èŠ‚ç‚¹æ•°ä¸å˜æ—¶ï¼Œåˆ†åŒºå¤§å°å’Œæ•°æ®é›†æ€»é‡æˆæ­£æ¯” èŠ‚ç‚¹æ•°å¢åŠ æ—¶ï¼Œåˆ†åŒºåˆ™ä¼šå˜å° åˆ†åŒºå¤§å°ä¿æŒç¨³å®šï¼Œå¯æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹æ‰¿è½½æ›´å¤šçš„æ•°æ® è¯·æ±‚è·¯ç”± å…¸å‹çš„æœåŠ¡å‘ç°é—®é¢˜ï¼Œå¤„ç†ç­–ç•¥å¦‚ä¸‹ï¼š é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ„ŸçŸ¥åˆ†åŒºæƒ…å†µï¼šå…è®¸å®¢æˆ·ç«¯è¿æ¥ä»»æ„èŠ‚ç‚¹ã€‚å¦‚æœæŸä¸ªèŠ‚ç‚¹æ°å¥½æ‹¥æœ‰è¯·æ±‚çš„åˆ†åŒºï¼Œåˆ™ç›´æ¥å¤„ç†ï¼›å¦åˆ™å°†è¯·æ±‚è½¬å‘ç»™åˆ«çš„èŠ‚ç‚¹ï¼Œç­‰å¾…ç­”å¤ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è·¯ç”±å±‚æ„ŸçŸ¥åˆ†åŒºæƒ…å†µï¼šæ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚å‘é€è‡³ä¸€ä¸ªè·¯ç”±ä»£ç†å±‚ï¼Œç”±å®ƒæ¥åšè½¬å‘ã€‚ å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ†åŒºå’ŒèŠ‚ç‚¹åˆ†é…å…³ç³»ï¼šå®¢æˆ·ç«¯å¯å†³å®šè¿æ¥åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œæ— éœ€ä¸­ä»‹ã€‚ å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨äº†ç‹¬ç«‹çš„åè°ƒæœåŠ¡ï¼ˆå¦‚ ZooKeeperï¼‰è·Ÿè¸ªé›†ç¾¤ä¸­çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ HBaseï¼ŒKafka ç­‰ã€‚ å¦å¤–ä¸€ç§æ€è·¯æ˜¯èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ gossip åè®®åŒæ­¥é›†ç¾¤çŠ¶æ€å˜åŒ–ï¼Œæ­¤æ—¶è¯·æ±‚å¯å‘åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹è´Ÿè´£å¤„ç†æˆ–è½¬å‘ã€‚æœ€å¤§çš„å¥½å¤„æ˜¯ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä½†æ˜¯èŠ‚ç‚¹å¤æ‚æ€§ä¹Ÿå¢åŠ äº†ã€‚å…¸å‹çš„ä»£è¡¨æ˜¯ Cassandra å’Œ Riakï¼Œå½“ç„¶è¿˜æœ‰ Redis Clusterã€‚ å‚è€ƒ ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ†]]></content>
      <categories>
        <category>ç³»ç»Ÿè®¾è®¡</category>
      </categories>
      <tags>
        <tag>åˆ†å¸ƒå¼æ•°æ®åº“</tag>
        <tag>æ•°æ®å¤åˆ¶</tag>
        <tag>æ•°æ®åˆ†åŒº</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®ç³»ç»ŸåŸºç¡€]]></title>
    <url>%2F2019%2F08%2F14%2Fddia-data-sys-basics%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDesign Data-Intensive Applicationsï¼‰æ˜¯ä¸€æœ¬éå¸¸æœ‰è¯šæ„ã€éå¸¸ä¼˜ç§€çš„è®²è§£é’ˆå¯¹æ•°æ®å¯†é›†åœºæ™¯ä¸‹ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„ç›®æ ‡ã€åŸåˆ™å’ŒæŠ€æœ¯é€‰å‹ç­‰çŸ¥è¯†ã€‚ä½œè€…ç»“åˆç†è®ºä¸å®è·µï¼Œä¸ºæˆ‘ä»¬å±•ç°äº†ä¸€äº›æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ï¼›åŒæ—¶è¿˜ä»‹ç»äº†ä¸€äº›å…³é”®æŠ€æœ¯ï¼ˆå¦‚å­˜å‚¨å¼•æ“ã€åºåˆ—åŒ–åè®®ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰ç­‰çš„å®ç°åŸç†ï¼Œè®©æˆ‘ä»¬èƒ½å¤ŸçŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚ å¥½ä¹¦è‡ªç„¶è¦ç²¾è¯»ç»†å“ï¼Œå†™ç‚¹è¯»ä¹¦ç¬”è®°æ‰èƒ½æŠŠæ¡è‡ªå·±çš„å­¦ä¹ è¿›åº¦å’Œç†è§£ç¨‹åº¦ã€‚æ€»çš„æ¥è¯´ï¼Œç¬”è®°å½¢å¼å°†ä»¥å›¾æ–‡ä¸ºä¸»ï¼Œæ€ç»´å¯¼å›¾ä¸ºè¾…çš„æ–¹å¼æ¥å‘ˆç°ã€‚ç”±äºè¯¥ä¹¦çš„å°é¢æ˜¯ä¸€å¤´é‡çŒªğŸ—ï¼Œæ•…å°†æœ¬ç³»åˆ—è¯»ä¹¦ç¬”è®°å‘½åä¸ºã€Šé‡çŒªä¹¦è¯»ä¹¦ç¬”è®°ã€‹ã€‚ä¹¦ä¸­ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†å±•å¼€ï¼š è®¨è®ºæœ‰å…³å¢å¼ºæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿæ‰€éœ€è¦çš„è‹¥å¹²åŸºæœ¬åŸåˆ™ã€‚ ä»å•æœºæ•°æ®å­˜å‚¨ä¸“äº«è·¨æœºå™¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ ä¸»è¦é’ˆå¯¹æ´¾ç”Ÿæ•°æ®çš„ç³»ç»Ÿè®¾è®¡ï¼Œå¹¶è®¨è®ºæ‰¹å¤„ç†å’Œæµå¼å¤„ç†ã€‚ é‡çŒªä¹¦å­¦ä¹ å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹æ·±å…¥å­¦ä¹ è·¯çº¿ï¼š å…³ç³»å‹æ•°æ®åº“ï¼š MySQL å­˜å‚¨å¼•æ“ï¼ˆInnoDB &amp; MyISAMï¼‰ åˆ†å¸ƒå¼æ•°æ®åº“ï¼š ä¸€è‡´æ€§åè®®ï¼ˆPaxos, Raft, Zookeeperï¼‰ æ•°æ®åº“ï¼ˆTiDB ï¼‰ å­˜å‚¨å¼•æ“ï¼ˆTiKV &amp; RocksDB &amp; LevelDBï¼‰ éå…³ç³»æ•°æ®åº“æˆ–ç¼“å­˜ç³»ç»Ÿï¼š Redisï¼ˆè®¾è®¡æ€æƒ³ã€æ•°æ®ç»“æ„ã€é›†ç¾¤ç®¡ç†ï¼‰ HBaseï¼ˆè®¾è®¡æ€æƒ³ã€ä½¿ç”¨æ–¹å¼å’Œåœºæ™¯ã€å­˜å‚¨ç®¡ç†ï¼‰ æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼š åº”ç”¨å±‚æ¡†æ¶ï¼ˆCeleryï¼‰ AMQP åè®®å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRabbitMQï¼‰ ç®€æ˜“çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆBeanstalkï¼‰ é«˜ååé‡çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRocksDBã€Kafkaï¼‰ æœç´¢å¼•æ“ï¼šElasticSearch å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ æ•°æ®å¯†é›†å‹ï¼ˆData-Intensiveï¼‰æ˜¯æŒ‡å¯¹äºä¸€ä¸ªåº”ç”¨ç³»ç»Ÿè€Œè¨€ï¼Œã€Œæ•°æ®ã€æ˜¯å…¶æˆè´¥çš„å†³å®šæ€§å› ç´ ï¼ŒåŒ…æ‹¬æ•°æ®çš„è§„æ¨¡ã€æ•°æ®çš„å¤æ‚åº¦æˆ–æ•°æ®äº§ç”Ÿå’Œå˜åŒ–çš„é€Ÿç‡ç­‰ã€‚ è®¡ç®—å¯†é›†å‹ï¼ˆCompute-Intensiveï¼‰ï¼Œä»¥è®¡ç®—ä¸ºä¸»çš„ç³»ç»Ÿï¼ŒCPU ä¸»é¢‘é€šå¸¸æ˜¯å®ƒçš„åˆ¶çº¦ç“¶é¢ˆ æ•°æ®ç³»ç»Ÿï¼š é€šå¸¸æ¥è¯´ï¼Œæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—è¢«è®¤ä¸ºæ˜¯ä¸åŒç±»å‹çš„ç³»ç»Ÿï¼Œæœ‰ä¸åŒçš„æ€§èƒ½å’Œè®¾è®¡å®ç°ï¼› ä½†è¿‘å¹´æ¥ï¼ŒæŠ€æœ¯çš„å‘å±•å¯¼è‡´å®ƒä»¬ä¹‹é—´çš„ç•Œé™é€æ¸æ¨¡ç³Šã€‚æ¯”å¦‚ Redis æ—¢å¯ä»¥å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼›Kafka å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿå…·å¤‡æŒä¹…åŒ–çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œç»Ÿä¸€ç§°ä¸ºã€Œæ•°æ®ç³»ç»Ÿï¼ˆdata systemï¼‰ã€ï¼› åº”ç”¨ç³»ç»Ÿçš„éœ€æ±‚æ›´åŠ å¹¿æ³›ï¼Œå•ä¸€ç»„ä»¶æ— æ³•æ»¡è¶³æ‰€æœ‰çš„æ•°æ®å¤„ç†å’Œå­˜å‚¨éœ€æ±‚ï¼›é€šå¸¸éœ€è¦ç»„åˆå¤šä¸ªç»„ä»¶ï¼Œå¹¶é€šè¿‡åº”ç”¨å±‚ä»£ç é©±åŠ¨å®ç°è¡”æ¥ã€‚ å¯é æ€§ï¼ˆReliabilityï¼‰ ç›®æ ‡ï¼šå½“æ„å¤–æƒ…å†µï¼ˆåŒ…æ‹¬ç¡¬ä»¶ã€è½¯ä»¶æ•…éšœä»¥åŠäººä¸ºå¤±è¯¯ï¼‰å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿåº”è¯¥å¯ä»¥ç»§ç»­æ­£å¸¸å·¥ä½œã€‚è™½ç„¶æ€§èƒ½ä¼šæœ‰æ‰€é™ä½ï¼Œä½†ä¼šç¡®ä¿åŠŸèƒ½æ­£ç¡®ã€‚ å¯èƒ½å‡ºé”™çš„äº‹ç§°ä¸ºé”™è¯¯ï¼ˆfaultsï¼‰æˆ–æ•…éšœï¼Œç³»ç»Ÿå¯åº”å¯¹é”™è¯¯ï¼Œåˆ™ç§°ä¸ºå®¹é”™ï¼ˆfault-tolerantï¼‰æˆ–è€…**å¼¹æ€§ï¼ˆresilientï¼‰ã€‚ å¤±æ•ˆï¼ˆfailureï¼‰æ¯” fault ä¸¥é‡ï¼Œæ„å‘³ç€æ•´ä¸ªç³»ç»Ÿæ— æ³•å¯¹å¤–æä¾›ç”¨æˆ·æ‰€éœ€æœåŠ¡ã€‚ ç¡¬ä»¶æ•…éšœé—®é¢˜å¯ä»¥é€šè¿‡å¢åŠ å†—ä½™çš„æ–¹å¼æ¥æœ‰æ•ˆè§£å†³ï¼Œä½†ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œè½¯ä»¶å®¹é”™çš„æ–¹å¼ä¹Ÿå¯ä»¥ç”¨æ¥å®¹å¿å¤šæœºå¤±æ•ˆçš„æ‰‹æ®µï¼Œä½œä¸ºç¡¬ä»¶å®¹é”™çš„è¡¥å……ã€‚ è½¯ä»¶æ•…éšœé—®é¢˜é€šå¸¸éš¾ä»¥é¢„æ–™ï¼Œä¸”ä¸€æ—¦å‘ç”Ÿäº§ç”Ÿçš„å½±å“ä¼šéå¸¸å¹¿æ³›ï¼Œæ¨ªè·¨æ•´ä¸ªç³»ç»Ÿéƒ½å¯èƒ½ã€‚å¹¶æ— å¿«é€Ÿè§£å†³ä¹‹æ³•ã€‚åœ¨ä½¿ç”¨ä¹‹å¤„ï¼Œéœ€è¦è€ƒè™‘å¥½å¾ˆå¤šç»†èŠ‚ï¼Œæ¢³ç†ä¾èµ–å‡è®¾å’Œç³»ç»Ÿé—´çš„äº¤äº’ã€‚å¦å¤–ï¼Œè¿›è¡Œå…¨é¢æµ‹è¯•ï¼Œåšå¥½è¿›ç¨‹éš”ç¦»ï¼Œå…è®¸å´©æºƒåè‡ªåŠ¨é‡å¯ã€‚ ä¿è¯ç³»ç»Ÿå¯é æ€§ï¼Œå‡å°‘äººä¸ºå¤±è¯¯ï¼š ä»¥æœ€å°å‡ºé”™çš„æ–¹å¼è®¾è®¡ç³»ç»Ÿ æƒ³åŠæ³•åˆ†ç¦»æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€å®¹æ˜“å‘ç”Ÿæ•…éšœçš„æ¥å£ å……åˆ†åœ°æµ‹è¯• å½“å‘ç”Ÿäººä¸ºå¤±è¯¯æ—¶ï¼Œæä¾›å¿«é€Ÿæ¢å¤æœºåˆ¶ï¼Œå‡å°‘æ•…éšœå½±å“ æä¾›è¯¦ç»†æ¸…æ™°çš„å­ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ€§èƒ½æŒ‡æ ‡å’Œé”™è¯¯ç‡ æ¨è¡Œç®¡ç†æµç¨‹å¹¶åŠ ä»¥åŸ¹è®­ å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰ ç›®æ ‡ï¼šéšç€è§„æ¨¡å¢é•¿ï¼ˆåŒ…æ‹¬æ•°æ®é‡ã€æµé‡æˆ–è€…å¤æ‚åº¦ï¼‰ï¼Œç³»ç»Ÿåº”ç”¨èƒ½ä»¥åˆç†çš„æ–¹å¼åŒ¹é…è¿™ç§å¢é•¿ã€‚ ç”¨æ¥æè¿°ç³»ç»Ÿåº”å¯¹è´Ÿè½½å¢åŠ èƒ½åŠ›çš„æœ¯è¯­ã€‚ æè¿°è´Ÿè½½ï¼šéœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯è´Ÿè½½å‚æ•°ã€‚å‚æ•°çš„æœ€ä½³é€‰æ‹©å–å†³äºç³»ç»Ÿçš„ä½“ç³»ç»“æ„ï¼Œå¯èƒ½æ˜¯ Web æœåŠ¡çš„æ¯ç§’è¯·æ±‚é‡ï¼Œæ•°æ®åº“å†™å…¥æ¯”ä¾‹ï¼ŒèŠå¤©å®¤æ´»åŠ¨äººæ•°ï¼Œç¼“å­˜å‘½ä¸­ç‡ï¼Œç”¨æˆ·å…³æ³¨è€…åˆ†å¸ƒæƒ…å†µç­‰ã€‚ æè¿°æ€§èƒ½ï¼š æ‰¹å¤„ç†ç³»ç»Ÿå…³æ³¨çš„æ˜¯ååé‡ï¼ˆthroughoutï¼‰ Web æœåŠ¡å™¨æ›´å…³æ³¨è¯·æ±‚å“åº”æ—¶é—´ï¼Œæ›´ç»å¸¸å…³æ³¨çš„æ˜¯å¹³å‡å“åº”æ—¶é—´ ä¸­ä½æ•°å“åº”æ—¶é—´é€šå¸¸ä¹Ÿå« p50 å¸¸è§çš„è¿˜ä¼šå…³æ³¨ p95, p99, p999 å€¼ æœåŠ¡è´¨é‡ç›®æ ‡ Service Level Objectives, SLO æœåŠ¡è´¨é‡åè®® Service Level Agreements, SLA å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰ ç›®æ ‡ï¼šéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ–°çš„äººå‘˜å‚ä¸åˆ°ç³»ç»Ÿçš„å¼€å‘å’Œè¿ç»´ï¼Œä»¥ç»´æŠ¤ç°æœ‰åŠŸèƒ½æˆ–é€‚é…æ–°åœºæ™¯ï¼Œç³»ç»Ÿéƒ½åº”è¯¥é«˜æ•ˆè¿è½¬ã€‚ è°éƒ½ä¸æƒ…æ„¿ç»´æŠ¤é—ç•™ç³»ç»Ÿï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå¯èƒ½è¦ä¿®å¤åˆ«äººåŸ‹ä¸‹çš„å‘ï¼Œåšä¸å–œæ¬¢çš„äº‹æƒ…ã€‚æ‰€ä»¥åœ¨åšç³»ç»Ÿè®¾è®¡ä¹‹åˆï¼Œå°±åº”è¯¥å…³æ³¨ç³»ç»Ÿè®¾è®¡çš„ä¸‰å¤§åŸåˆ™ï¼Œå°½å¯èƒ½å‡å°‘ç»´æŠ¤æœŸçš„éº»çƒ¦ï¼š å¯è¿ç»´æ€§ï¼šè¿ç»´æ›´è½»æ¾ ç®€å•æ€§ï¼šç®€åŒ–ç³»ç»Ÿå¤æ‚åº¦ï¼Œä½†å¹¶éå‡å°‘äº§å“åŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡è¾ƒå¥½çš„æŠ½è±¡æ¥è®©ç³»ç»Ÿå˜å¾—æ›´æ¸…æ™°å’Œæ˜“äºç†è§£ å¯æ¼”åŒ–æ€§ï¼šæ˜“äºæ”¹å˜ æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€ å¤æ‚çš„åº”ç”¨ç¨‹åºä¼šæœ‰å¾ˆå¤šå±‚ï¼Œä½†æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ¯å±‚éƒ½é€šè¿‡æä¾›ä¸€ä¸ªç®€æ´çš„æ•°æ®æ¨¡å‹æ¥éšè—ä¸‹å±‚çš„å¤æ‚æ€§ å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“ NoSQL æ•°æ®åº“å‡ å¤§é©±åŠ¨å› ç´ ï¼š æ¯”å…³ç³»æ•°æ®åº“æ‰©å±•æ€§å¥½ï¼Œæ”¯æŒè¶…å¤§æ•°æ®é›†æˆ–è¶…é«˜å†™å…¥ååé‡ å¼€æºå…è´¹å±…å¤š å…³ç³»æ¨¡å‹ä¸èƒ½å¾ˆå¥½æ”¯æŒæŸäº›ç‰¹å®šæŸ¥è¯¢ ä»»ä½•å¯¹äººç±»æœ‰æ„ä¹‰çš„ä¸œè¥¿éƒ½å¯èƒ½åœ¨å°†æ¥æŸä¸ªæ—¶åˆ»å‘ç”Ÿæ”¹å˜ã€‚æ‰€ä»¥åœ¨æ•°æ®åº“ä¸­æˆ‘ä»¬ä½¿ç”¨å…³è”çš„ ID ä½œä¸ºæ ‡å¿—çš„å¥½å¤„å°±æ˜¯å®ƒæ²¡æœ‰ç›´æ¥æ„ä¹‰ï¼Œæ°¸è¿œä¸éœ€è¦ç›´æ¥æ”¹å˜ å±‚æ¬¡æ¨¡å‹ï¼š ä»£è¡¨æ˜¯ IBM çš„ Information Mangagement System, IMS ç±»ä¼¼ JSON ç»“æ„ï¼Œèƒ½å¤Ÿå¾ˆå¥½è¡¨ç¤ºä¸€å¯¹å¤šå…³ç³»ï¼›å¤šå¯¹å¤šå…³ç³»å¾ˆéš¾è¡¨ç¤º ç½‘ç»œæ¨¡å‹ï¼š å±‚æ¬¡æ¨¡å‹çš„æ¨å¹¿ï¼Œæ”¯æŒå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„å…³ç³» æŸ¥è¯¢å›°éš¾ã€æ›´æ–°å¤æ‚ä¸”ä¸å¤Ÿçµæ´» å¯¹åº”ç”¨ç¨‹åºçš„æ•°æ®æ¨¡å‹è¿›è¡Œæ›´æ”¹æ˜¯éå¸¸å›°éš¾çš„äº‹æƒ… åº”ç”¨éœ€è¦å…³å¿ƒå¤æ‚çš„è®¿é—®è·¯å¾„ å…³ç³»æ¨¡å‹ï¼š å®šä¹‰äº†æ‰€æœ‰æ•°æ®çš„æ ¼å¼ï¼šå…³ç³»ï¼ˆè¡¨ï¼‰åªæ˜¯å…ƒç»„ï¼ˆè¡Œï¼‰çš„é›†åˆ æŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨å†³å®šæŸ¥è¯¢é¡ºåºæ‰§è¡Œï¼›ä½¿ç”¨ä½•ç§ç´¢å¼•ã€‚ç›¸å½“äºè‡ªåŠ¨ç»´æŠ¤ã€Œè®¿é—®è·¯å¾„ã€ åº”ç”¨æ·»åŠ æ–°åŠŸèƒ½å˜å¾—å®¹æ˜“ å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“ï¼š è¡¨ç¤ºå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šéƒ½ä½¿ç”¨äº†æ ‡è¯†ç¬¦ å‰è€…å«ä½œå¤–é”®ï¼ˆæˆ–è€…å¯ä»¥åœ¨åº”ç”¨ä¸­å…³è”ï¼‰ï¼›åè€…å«ä½œæ–‡æ¡£å¼•ç”¨ è¯»æ—¶æ¨¡å¼ï¼šæ–‡æ¡£æ•°æ®åº“ä¸­ï¼Œæ•°æ®ç»“æ„æ˜¯éšå¼çš„ï¼Œåªæœ‰åœ¨è¯»å–æ—¶æ‰è§£é‡Š å†™æ—¶æ¨¡å¼ï¼šå…³ç³»æ•°æ®åº“ä¸­ï¼Œæ¨¡å¼æ˜¯æ˜¾å¼çš„ï¼Œæ•°æ®åº“ä¿è¯å†™å…¥æ—¶éµå¾ªæ¨¡å¼ èåˆå…³ç³»æ¨¡å‹å’Œæ–‡æ¡£æ¨¡å‹æ˜¯æœªæ¥å‘å±•çš„ä¸€ä¸ªè¾ƒå¥½çš„é€”å¾„ æŸ¥è¯¢è¯­è¨€ SQLï¼š å£°æ˜å¼ ç®€æ´ã€æ˜“ä½¿ç”¨ å¾ˆå¤šé™åˆ¶çš„äº‹å®ï¼Œä¹Ÿæˆä¸ºæ•°æ®åº“è‡ªåŠ¨ä¼˜åŒ–æä¾›äº†ç©ºé—´ åº•å±‚æ˜“äºä½¿ç”¨å¹¶å‘æŸ¥è¯¢ IMS/CODASYLï¼ˆå±‚æ¬¡æ¨¡å‹ã€ç½‘ç»œæ¨¡å‹ï¼‰ï¼š å‘½ä»¤å¼ MapReduceï¼š ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¸å¤šæœºå™¨ä¸Šæ‰¹é‡å¤„ç†æµ·é‡æ•°æ® æ—¢éå£°æ˜å¼ï¼Œä¹Ÿéå®Œå…¨å‘½ä»¤å¼ï¼›ä»‹äºäºŒè€…ä¹‹é—´ åº•å±‚ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¡ç®—é›†ç¾¤ä¸Šåˆ†å¸ƒæ‰§è¡Œï¼›å¯æ‰§è¡Œçš„æ“ä½œé™å®šä¸ºçº¯å‡½æ•° å›¾æ•°æ®åº“æ¨¡å‹ å…³ç³»æ•°æ®åº“é€‚åˆå¤„ç†ç®€å•çš„å¤šå¯¹å¤šæ¨¡å‹ï¼›ä½†éšç€æ•°æ®ä¹‹é—´çš„å…³è”è¶Šæ¥è¶Šå¤æ‚ï¼Œè½¬æ¢ä¸ºå›¾æ¨¡å‹ä¼šæ›´åŠ è‡ªç„¶ é¡¶ç‚¹å’Œè¾¹ç»„æˆ å»ºæ¨¡ç¤ºä¾‹ï¼š äººé™…å…³ç³» Web ç½‘é¡µ å…¬è·¯æˆ–è€…é“è·¯ç½‘ æ›´å¼ºå¤§ç”¨å¤„ï¼šæä¾›äº†å•ä¸ªæ•°æ®å­˜å‚¨åŒºä¿å­˜å®Œå…¨ä¸åŒç±»å‹å¯¹è±¡çš„ä¸€è‡´æ€§æ–¹å¼ å±æ€§å›¾æ¨¡å‹ï¼ˆProperty Graphï¼‰ ä»£è¡¨ï¼šNeo4j, Titan, InfiniteGraph é¡¶ç‚¹ï¼ˆverticeï¼‰ï¼š å”¯ä¸€æ ‡å¿— å‡ºè¾¹é›†åˆ å…¥è¾¹é›†åˆ å±æ€§é›†åˆ è¾¹ï¼ˆedgeï¼‰ï¼š å”¯ä¸€æ ‡å¿— è¾¹å¼€å§‹é¡¶ç‚¹ è¾¹ç»“æŸçš„é¡¶ç‚¹ æ ‡ç­¾ å±æ€§é›†åˆ ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰ ä»£è¡¨ï¼šDatomic, AllegroGraph å‡ ä¹ç­‰åŒäºå±æ€§å›¾æ¨¡å‹ï¼Œå¯èƒ½ä½œä¸ºæ„å»ºåº”ç”¨ç¨‹åºçš„è¡¥å…… å½¢å¼ï¼š(ä¸»ä½“ï¼Œè°“è¯­ï¼Œå®¢ä½“) ä¸»ä½“ç›¸å½“äºå›¾ä¸­çš„é¡¶ç‚¹ï¼Œå®¢ä½“åˆ™æ˜¯ä»¥ä¸‹ä¸¤ç§ä¹‹ä¸€ï¼š åŸå§‹æ•°æ®ç±»å‹ä¸­çš„å€¼ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰ï¼Œå¦‚ (lucy, age, 40) å›¾çš„å¦å¤–ä¸€ä¸ªé¡¶ç‚¹ï¼Œå¦‚ (lucy, mariedTo, alain) æŸ¥è¯¢è¯­è¨€ Cypherï¼Œæœ€æ—©ç”¨äº Neo4jã€‚å£°æ˜å¼æŸ¥è¯¢è¯­è¨€ SQL:1999 æ ‡å‡†åï¼Œå¯ä»¥ä½¿ç”¨é€’å½’å…¬ç”¨è¡¨è¾¾å¼ï¼ˆWITH RECURSIVEï¼‰æ¥è¡¨ç¤ºå¯å˜çš„éå†è·¯å¾„æŸ¥è¯¢ SPARQLï¼šé‡‡ç”¨ RDF æ•°æ®æ¨¡å‹çš„ä¸‰å…ƒå­˜å‚¨æŸ¥è¯¢è¯­è¨€ Datalogï¼šæ•°æ®æ¨¡å‹é‡‡ç”¨ã€Œè°“è¯­ï¼ˆä¸»ä½“ï¼Œå®¢ä½“ï¼‰ã€æ¨¡å¼ï¼›è§„åˆ™å¯ä»¥åœ¨ä¸åŒçš„æŸ¥è¯¢ä¸­ç»„åˆå’Œå¤ç”¨ï¼›å¯¹äºç®€å•æŸ¥è¯¢è™½ç„¶ç¹çï¼Œä½†é’ˆå¯¹å¤æ‚æ•°æ®ï¼Œåˆ™æ›´åŠ çµæ´» æ•°æ®å­˜å‚¨å’Œæ£€ç´¢æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„ ç´¢å¼•å¯ä»¥å¸®åŠ©é«˜æ•ˆåœ°æŸ¥è¯¢æ•°æ®åº“ä¸­ç‰¹å®šçš„é”®ï¼›æ˜¯åŸºäºåŸå§‹æ•°æ®æ´¾ç”Ÿè€Œæ¥çš„é¢å¤–æ•°æ®ç»“æ„ ä»»ä½•ç±»å‹çš„ç´¢å¼•é€šå¸¸éƒ½ä¼šé™ä½å†™çš„é€Ÿåº¦ å“ˆå¸Œç´¢å¼• ä»¥ Bitcast ä¸ºä»£è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œé‡‡ç”¨äº†å“ˆå¸Œç´¢å¼• é€‚åˆæ¯ä¸ªé”®çš„å€¼æ›´æ–°é¢‘ç¹çš„åœºæ™¯ å“ˆå¸Œç´¢å¼•çš„ç‰¹ç‚¹ï¼š å“ˆå¸Œè¡¨å¿…é¡»å…¨éƒ¨å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œé”®å€¼æŒ‡å‘çš„æ˜¯æ–‡ä»¶æ®µä¸­çš„åç§»ï¼Œç”¨äºæŸ¥æ‰¾å…·ä½“çš„æ•°æ® å¯é‡‡ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œå†é…åˆåå°åˆå¹¶ã€å‹ç¼©ç­‰æ‰‹æ®µæ¥é¿å…ç£ç›˜å†™å…¥è€—å°½çš„é—®é¢˜ï¼Œå‡å°‘ç£ç›˜ç¢ç‰‡ æ–°çš„æ•°æ®é‡‡ç”¨è¿½åŠ è€ŒéåŸåœ°ä¿®æ”¹çš„ç­–ç•¥ï¼Œæé«˜å†™å…¥ååé‡ åŒºé—´æŸ¥è¯¢æ•ˆç‡ä¸é«˜ SSTables å’Œ LSM-Tree SSTable çš„å…¨ç§°ï¼šSorted String Tableï¼Œæ’åºå­—ç¬¦ä¸²è¡¨ LSM-Tree çš„å…¨ç§°ï¼šLog-Structured Merge-Tree ç›¸æ¯”å“ˆå¸Œç´¢å¼•çš„ä¼˜ç‚¹ï¼š åˆå¹¶æ®µæ›´ç®€å•é«˜æ•ˆï¼Œå¯¹äºå¤§æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ æ®µæ–‡ä»¶ä¸­çš„ key-value é¡ºåºæ˜¯æŒ‰ç…§é”®æ’åºè¿‡çš„ï¼Œä¾¿äºåˆå¹¶å’ŒæŸ¥æ‰¾ åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾ç‰¹å®šé”®æ—¶æ— éœ€åœ¨å†…å­˜ä¸­ä¿å­˜æ‰€æœ‰é”®çš„ç´¢å¼•ï¼ˆç¨€ç–ç´¢å¼•æ”¾åœ¨å†…å­˜ä¸­ï¼‰ æ”¯æŒèŒƒå›´æŸ¥æ‰¾ æ„å»ºå’Œç»´æŠ¤ SSTables åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå†…å­˜è¡¨ï¼Œå†™å…¥æ—¶å…ˆå†™å…¥è¯¥è¡¨ï¼ˆæœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå¦‚çº¢é»‘æ ‘æˆ–è€…è·³è¡¨ï¼‰ å†…å­˜è¡¨è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œç›´æ¥å†™ç›˜ï¼Œå½¢æˆ SSTableï¼›åœ¨å†™ç›˜åŒæ—¶ï¼Œå¯æ·»åŠ æ–°çš„å†…å­˜è¡¨å®ä¾‹ï¼Œæ¥æ”¶åç»­å†™è¯·æ±‚ å¯¹äºè¯»è¯·æ±‚ï¼Œå†…å­˜è¡¨-&gt;æœ€æ–°ç£ç›˜æ®µæ–‡ä»¶-&gt;æ¬¡æ–°æ®µæ–‡ä»¶-&gt;â€¦ç›´åˆ°æ‰¾åˆ°ç›®æ ‡æˆ–è€…ä¸ºç©º åå°å®šæœŸåˆå¹¶ã€å‹ç¼©ï¼Œä¸¢å¼ƒè¢«è¦†ç›–æˆ–åˆ é™¤çš„å€¼ é¿å…å´©æºƒçš„æ–¹å¼ï¼šæ¯ä¸ªå†™å…¥è®°å½•åˆ°æ—¥å¿—ï¼Œå½“å†…å­˜è¡¨å†™å…¥ SSTable åæ‰å¯ä»¥ä¸¢å¼ƒç›¸åº”æ—¥å¿— åŸºäºåˆå¹¶å’Œå‹ç¼©æ’åºæ–‡ä»¶åŸç†çš„å­˜å‚¨å¼•æ“é€šå¸¸éƒ½å«ä½œ LSM å­˜å‚¨å¼•æ“ æ€§èƒ½ä¼˜åŒ–ï¼š åˆ†å±‚å‹ç¼©ï¼ŒLevelDB &amp; RocksDB æŒ‰å¤§å°åˆ†çº§ï¼ŒHBase, Cassandra åˆ™ä¸¤ç§éƒ½æ”¯æŒ å¸ƒéš†è¿‡æ»¤å™¨ B-Trees å¹¿æ³›ä½¿ç”¨è®¤å¯çš„ç´¢å¼•ç»“æ„ï¼Œå¾ˆå¤šæ•°æ®åº“ä¸­æ ‡å‡†ç´¢å¼•å®ç°ï¼›å³ä½¿åœ¨éå…³ç³»æ•°æ®åº“ä¸­ä¹Ÿæœ‰ç”¨åˆ° B-Tree æ˜¯é¢å‘å—æˆ–è€…é¡µè¿›è¡Œè®¾è®¡çš„ï¼Œå®ƒå°†æ•°æ®åº“åˆ†è§£æˆå›ºå®šå¤§å°çš„å—æˆ–é¡µï¼Œä¸€èˆ¬ä¸º 4 KBï¼Œé¡µæ˜¯å†…éƒ¨è¯»å†™çš„æœ€å°å•å…ƒ æ¯ä¸ªé¡µé¢éƒ½æœ‰æ ‡è¯†ç¬¦ï¼Œå¯è¢«å¼•ç”¨ ä¸€ä¸ªé¡µæ‰€åŒ…å«çš„é¡µé¢å¼•ç”¨æ•°é‡ç§°ä¸ºåˆ†æ”¯å› å­ æ›´æ–°ç­–ç•¥ï¼š æœç´¢åŒ…å«æŒ‡å®šé”®çš„å­é¡µ ä¿®æ”¹è¯¥é¡µçš„å€¼ æ•´é¡µå›å†™åˆ°ç£ç›˜ï¼ˆç›¸å½“äºè¦†ç›–åŸå…ˆçš„é¡µï¼Œå¯¹è¯¥é¡µçš„ä»»ä½•å¼•ç”¨ä¾ç„¶æœ‰æ•ˆï¼‰ æ–°åŠ é”®ç­–ç•¥ï¼š æ‰¾åˆ°å¯å®¹çº³æ–°é”®èŒƒå›´çš„é¡µï¼Œç„¶åæ·»åŠ åˆ°è¯¥é¡µ è‹¥é¡µé¢ç©ºé—´ä¸è¶³ï¼Œåˆ™å°†å…¶åˆ†è£‚ä¸ºä¸¤ä¸ªåŠæ»¡çš„é¡µï¼ŒåŒæ—¶ä¿®æ”¹çˆ¶é¡µï¼Œè®°å½•åˆ†è£‚åçš„æ–°çš„é”®çš„èŒƒå›´ ä¸€ä¸ªå…·æœ‰ N ä¸ªé”®çš„ B-Tree çš„æ·±åº¦ä¸º O(log N)ï¼›å¤šæ•°æ•°æ®åº“å¯ä»¥é€‚åˆ 3~4 å±‚ B-Treeã€‚åˆ†æ”¯å› å­ä¸º 500 çš„ 4KB å››çº§æ ‘å¯å­˜å‚¨ 256TB çš„æ•°æ® å´©æºƒæ¢å¤ï¼šWAL, Write-Ahead Logã€‚é€šè¿‡è¯¥æ—¥å¿—æ¥æ¢å¤ éœ€è¦è€ƒè™‘å¹¶å‘æ§åˆ¶ å†™æ”¾å¤§çš„é—®é¢˜ï¼ˆé¡µåˆ†è£‚ï¼‰ äº‹åŠ¡æ”¯æŒæ›´åŠ å®¹æ˜“ äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰ äºŒè€…å¯¹æ¯”ï¼š å¤§çš„ä¼ä¸šä¼šå•ç‹¬å»ºç«‹æ•°ä»“ï¼ŒåŒæ­¥æ¥è‡ª OLTP ç³»ç»Ÿçš„æ•°æ®ï¼Œåœ¨å•ç‹¬çš„æ•°ä»“ä¸­è¿›è¡Œåˆ†æå¤„ç†ï¼Œä¸ä¼šå½±å“çº¿ä¸Šä¸šåŠ¡ å¯¼å…¥æ•°ä»“ï¼šELT, Extract-&gt;Transform-&gt;Load å¸¸è§æ•°ä»“ç³»ç»Ÿï¼šApache Hive, Spark SQL, Cloudera Implala æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼ å¸¸è§çš„æ˜¯æ˜Ÿå‹æ¨¡å¼ï¼Œä¹Ÿç§°ä¸ºç»´åº¦å»ºæ¨¡ã€‚ç‰¹ç‚¹æ˜¯æœ‰ä¸€ä¸ªäº‹å®è¡¨ï¼Œå…³è”äº†å¾ˆå¤šä¸ªç»´åº¦è¡¨ã€‚äº‹å®è¡¨æœ¬èº«å¯èƒ½ä¼šå¾ˆåºå¤§ï¼Œå…¶ä¸­çš„æ¯ä¸€è¡Œéƒ½ä»£è¡¨ä¸€ä¸ªäº‹ä»¶ï¼Œç»´åº¦é€šå¸¸ä»£è¡¨äº‹ä»¶çš„Who, What, Where, When, How, Why é›ªèŠ±â„ï¸ æ¨¡å‹æ˜¯æ˜Ÿå‹æ¨¡å‹çš„å˜ä½“ï¼Œå®ƒå°†ç»´åº¦è¿›ä¸€æ­¥ç»†åˆ†ä¸ºå­ç©ºé—´ï¼Œä»è€Œæ›´åŠ è§„èŒƒåŒ–ã€‚ä½†æ˜¯è¿™ä¸ªä¼šå¢åŠ åˆ†ææŸ¥è¯¢çš„å¤æ‚åº¦ï¼Œæ‰€ä»¥æ˜Ÿå‹åˆ†ææ¨¡å¼æ›´å—æ¬¢è¿ åˆ—å­˜å‚¨ æ•°ä»“ä¸­çš„åˆ—é€šå¸¸å¾ˆå®½ï¼Œæœ‰çš„å¯èƒ½å¤šè¾¾ 100 ä¸ª æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ¯åˆ—ä¸­çš„æ‰€æœ‰å€¼å­˜å‚¨åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰çš„æ•°æ®æ—¶å­˜å‚¨åœ¨ä¸€ç»„åˆ—æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä»¥ç›¸åŒé¡ºåºä¿å­˜æ•°æ®è¡Œ åˆ—å‹ç¼©ï¼š å¾ˆå®¹æ˜“è¿›è¡Œå‹ç¼© å¸¸ç”¨ä½å›¾ç¼–ç ï¼Œå¹¶é…åˆæ¸¸ç¨‹ç¼–ç é™ä½å­˜å‚¨ç©ºé—´ï¼ˆè¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹é›¶ä½ç¨€ç–çš„æƒ…å†µï¼‰ åˆ—æ’åºï¼š å¯ä»¥æ ¹æ®æŸ¥è¯¢éœ€æ±‚é€‰æ‹©æ’åºçš„åˆ— æ’åºå¯å¸®åŠ©è¿›ä¸€æ­¥å‹ç¼©ï¼ˆé‡å¤å€¼ä¹Ÿå¯ä»¥é‡‡ç”¨ç®€å•çš„æ¸¸ç¨‹ç¼–ç ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯æ•°åäº¿è¡Œä¹Ÿä¸æ€•ï¼‰ åŸºäºç¬¬ä¸€ä¸ªæ’åºé”®çš„å‹ç¼©æ•ˆæœé€šå¸¸æœ€å¥½ æ’åºç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­ç”¨çš„ç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢ å†™å…¥å¯ä»¥é‡‡å–ç±»ä¼¼ LSM-Tree çš„æ€è·¯ ç‰©åŒ–è§†å›¾ï¼šæŸ¥è¯¢ç»“æœçš„å®é™…å‰¯æœ¬ï¼Œè¢«å†™å…¥åˆ°ç£ç›˜äº†ï¼›è™šæ‹Ÿè§†å›¾åˆ™æ˜¯ç”¨äºç¼–å†™æŸ¥è¯¢çš„å¿«æ·æ–¹å¼ æ•°æ®ç¼–ç ä¸æ¼”åŒ–æ•°æ®ç¼–ç æ ¼å¼ ç¨‹åºä¸­è‡³å°‘æœ‰ä¸¤ç§å¸¸ç”¨çš„æ•°æ®è¡¨ç¤ºå½¢å¼ï¼š å†…å­˜ä¸­ï¼Œæ•°æ®ä¿å­˜åœ¨å¯¹è±¡ã€ç»“æ„ä½“ã€åˆ—è¡¨ã€æ•°ç»„ã€å“ˆå¸Œè¡¨å’Œæ ‘ç­‰ç»“æ„ä¸­ï¼Œå¯¹äº CPU çš„é«˜æ•ˆè®¿é—®å’Œæ“ä½œåšäº†ä¼˜åŒ– æ•°æ®å†™å…¥æ–‡ä»¶æˆ–è€…ç½‘ç»œä¼ è¾“æ—¶ï¼Œéœ€è¦è¿›è¡Œç¼–ç ä¸ºå­—èŠ‚åºåˆ— è¯­è¨€ç‰¹å®šçš„æ ¼å¼ å¸¸è§çš„åŒ…æ‹¬ï¼š java.io.Serializable Ruby ä¸­çš„ Marshal Python ä¸­çš„ pickle ä¼˜ç‚¹ï¼šå¯¹äºæŸç§è¯­è¨€è‡ªèº«æ¥è¯´ï¼Œç¼–è§£ç ä¼šå¾ˆæ–¹ä¾¿ï¼Œä¸éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ– ç¼ºç‚¹ï¼š ä¸ç‰¹å®šè¯­è¨€ç»‘å®šï¼Œä¸åˆ©äºå’Œå…¶å®ƒè¯­è¨€çš„å¼‚æ„ç³»ç»Ÿé€šè®¯ å¯èƒ½ä¼šæœ‰å®‰å…¨æ€§é—®é¢˜ å…¼å®¹æ€§ä¸èƒ½ä¿è¯ æ•ˆç‡é€šå¸¸æ¯”è¾ƒä½ï¼Œéœ€è¦èŠ±è´¹è¾ƒå¤šçš„ CPU æ—¶é—´æˆ–è€…å†…å­˜ç©ºé—´ JSONã€XML å’ŒäºŒè¿›åˆ¶å˜ä½“ JSONã€CSVã€XML éƒ½æ˜¯æ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå¥½ å­˜åœ¨çš„é—®é¢˜ï¼š æ•°å­—ç¼–ç ä¸æ˜ç¡®ï¼ˆæ¯”å¦‚ CSV ä¸­å°±æ— æ³•åŒºåˆ†æ˜¯æ•°å­—è¿˜æ˜¯æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²ï¼›JSON ä¸­å¯¹äºå¤§äº 2^53 çš„æ•´æ•°å°±å‚»çœ¼äº†ï¼‰ ä¸æ”¯æŒäºŒè¿›åˆ¶ï¼ˆè™½ç„¶å¯ä»¥ç”¨ base64 æäº‹æƒ…ï¼Œä½†æ˜¯ä¼šå¢åŠ ç©ºé—´å’Œç¼–è§£ç çš„æ—¶é—´ï¼‰ CSV æ— ä»»ä½•æ¨¡å¼ XML å’Œ JSON å‡æœ‰å¯é€‰çš„æ¨¡å¼ ä¸€äº›å˜ç§ï¼Œå®ƒä»¬çš„åº”ç”¨å¹¶ä¸æ˜¯å¾ˆå¹¿æ³›ï¼š JSONï¼ˆBSONã€BJSONã€UBJSONã€BISONã€Smile å’Œ Message Packï¼‰ XMLï¼ˆWBXML å’Œ Fast Infosetï¼‰ åé¢çš„ğŸŒ°éƒ½ä»¥è¡¨è¾¾ä¸‹é¢çš„ä¿¡æ¯ä¸ºä¾‹ï¼Œæ¥åšå¯¹ç…§ï¼š 12345&#123; "userName": "Martin", "favoriteNumber": 1337, "interests": ["daydreaming", "hacking"]&#125; Message Pack æ˜¯ JSON çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š Thrift &amp; Protocol Buffers Thrift æ˜¯ Facebook å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº Thrift æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ RPC æ¡†æ¶ï¼Œåœ¨å®ƒçš„åè®®å±‚æä¾›äº†å¤šç§ Protocol çš„å®ç°ï¼Œæ–¹ä¾¿åº”ä»˜å¤šç§åœºæ™¯ã€‚æ¯”å¦‚å¸¸è§çš„ BinaryProtocol å’Œ CompactProtocolã€‚ BinaryProtocol ç¼–ç ç¤ºä¾‹ï¼š ä¸ Message Pack ç¼–ç ç›¸æ¯”ï¼Œæ²¡æœ‰äº†å­—æ®µå ä½¿ç”¨äº† field tag æ¥æ˜ å°„ IDL å®šä¹‰çš„å„ä¸ªå­—æ®µ CompactProtocol ç¼–ç ç¤ºä¾‹ï¼š field tag å’Œ type ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤º field tag ä½¿ç”¨äº†åç§»è®¡ç®— æ•´æ•°é‡‡ç”¨å˜é•¿å­—èŠ‚ï¼Œè€Œé BinaryProtocol ä¸­ 1337 ä½¿ç”¨çš„ 8 å­—èŠ‚ï¼Œæ¢æˆå˜é•¿å­—èŠ‚åªéœ€è¦ 2 å­—èŠ‚å³å¯ Protocol Buffers Google å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº ä½¿ç”¨ PB ç¼–ç çš„ç¤ºä¾‹ï¼š required å’Œ optional è¿™ç§ä¿®é¥°æ˜¯ä¸ä¼šä½“ç°åœ¨ç¼–ç ä¸­çš„ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶åšçš„æ£€æŸ¥ ä¿è¯å‰åå‘å…¼å®¹ï¼š field tag è‡³å…³é‡è¦ï¼Œä¸å¯éšä¾¿æ›´æ”¹ optional å­—æ®µçš„ field tag å¯ä»¥åˆ é™¤ï¼Œä½†ä¸è¦å¤ç”¨å·²åˆ é™¤çš„ field tag æ–°å¢å­—æ®µå¿…é¡»æ˜¯ optional æˆ–è€…å¸¦æœ‰é»˜è®¤å€¼ï¼Œä¿è¯å‘åå…¼å®¹ ä¸å¯è½»æ˜“ä¿®æ”¹ field ç±»å‹ Avro Apache Avro æ˜¯ Hadoop çš„å­é¡¹ç›®ï¼Œæä¾›äº†ä¸¤ç§æ¨¡å¼è¯­è¨€ï¼šAvro IDL å’Œ JSON æ ¼å¼ ç‰¹ç‚¹ï¼š æ²¡æœ‰æ ‡ç­¾å· ç¼–ç éå¸¸ç´§å‡‘ ç¼–ç ä¸­æ²¡æœ‰å­—æ®µç±»å‹ ç¼–ç ç¤ºä¾‹ï¼š åŒºåˆ†è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ã€‚å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸å¿…å®Œå…¨ä¸€æ¨¡ä¸€æ ·ï¼Œåªéœ€è¦ä¿æŒå…¼å®¹ å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸­çš„å­—æ®µé¡ºåºå¯ä¸åŒï¼Œå› ä¸ºåœ¨æ¨¡å¼è§£ææ—¶ä¼šä½¿ç”¨å­—æ®µååŒ¹é… åŠ¨æ€ç”Ÿæˆæ¨¡å¼æ˜¯æœ€å¤§çš„ç‰¹ç‚¹ï¼Œä¸éœ€è¦åƒ PB æˆ–è€… Thrift ä¸­é‚£æ ·ï¼Œæ˜¾å¼åˆ†é… field tagï¼Œæ¯”è¾ƒçµæ´»ã€‚ç‰¹åˆ«é€‚åˆç¼–ç æ•°æ®åº“è¡¨ã€‚ å‚è€ƒ æ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ï¼šç¬¬ä¸€éƒ¨åˆ† Thrift Protocol Buffers Avro Python Examples]]></content>
      <categories>
        <category>ç³»ç»Ÿè®¾è®¡</category>
      </categories>
      <tags>
        <tag>ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹</tag>
        <tag>åˆ†å¸ƒå¼</tag>
        <tag>æ•°æ®æ¨¡å‹</tag>
        <tag>æ•°æ®åº“å­˜å‚¨</tag>
        <tag>æ•°æ®ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go æºç å­¦ä¹ ä¹‹ Context]]></title>
    <url>%2F2019%2F08%2F02%2Fgo-context-intro%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨ä¸€æ¬¡æ’æŸ¥æŸ HTTP æ¥å£è¯·æ±‚é¢‘ç¹å›  context canceled é”™è¯¯å¯¼è‡´è¯·æ±‚å¤„ç†å¤±è´¥çš„é—®é¢˜æœŸé—´ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ Go è¯­è¨€çš„ Context å®ç°ã€‚æœ¬æ–‡å°†é¦–å…ˆä»‹ç»æˆ‘ä»¬æ˜¯å¦‚ä½•æ’æŸ¥è¯¡å¼‚çš„ context canceled äº§ç”ŸåŸå› ï¼ˆä¹Ÿå°±æ˜¯åœ¨å“ªå„¿å› ä¸ºä»€ä¹ˆè€Œå¯¼è‡´å–æ¶ˆçš„ï¼‰ï¼›æ¥ä¸‹æ¥å°†æ·±å…¥ä»‹ç» Context è¯ç”Ÿçš„ç›®çš„ã€æºç è§£æåŠåº”ç”¨åœºæ™¯ç­‰ï¼Œä¾¿äºæ›´è¿›ä¸€æ­¥åŠ æ·±å¯¹å®ƒçš„ç†è§£ï¼›æœ€åæˆ‘ä»¬ä¹Ÿä¼šè°ˆåŠä½¿ç”¨ Context çš„ä¸€äº›ç—›ç‚¹ã€‚ æ’æŸ¥ context canceled çš„è‰°è¾›å†ç¨‹èƒŒæ™¯æˆ‘ä»¬éƒ¨ç½²åœ¨ç”Ÿäº§ç¯å¢ƒçš„ HTTP æœåŠ¡ä¸­æä¾›äº†ä¸€ä¸ªç”¨äºè®°å½•ç”¨æˆ·è¯¾ç¨‹å­¦ä¹ è¿›åº¦çš„æ¥å£ï¼Œåœ¨ Sentry ä¸­å‘ç°ï¼Œæœ‰å¤§é‡ context canceled æŠ¥é”™å‡ºç°ï¼Œå¯¼è‡´åœ¨æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶å¤±è´¥ï¼Œä»è€Œå¯¼è‡´å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹æ²¡æœ‰èµ°å®Œï¼ˆç”¨æˆ·çš„å­¦ä¹ è¿›åº¦è®¡ç®—ã€ä¸šåŠ¡æ–¹æ¶ˆæ¯é€šçŸ¥ç­‰æ²¡æœ‰æ‰§è¡Œï¼‰ã€‚ä½†æ—©æœŸç”±äº Sentry æ¥å…¥å­˜åœ¨é—®é¢˜ï¼Œå¯¼è‡´é”™è¯¯è®°å½•æ²¡æœ‰ä¸ŠæŠ¥ï¼›ç›´åˆ°é—®é¢˜ä¿®å¤åï¼Œæ‰åœ¨ Sentry ä¸Šè§‚å¯Ÿåˆ°å¤§é‡æŠ¥é”™æç¤ºã€‚ç”±æ­¤ï¼Œå¼€å¯äº†å®šä½ context canceled é—®é¢˜ä¹‹æ—…~ æŠ¥å‘Šè¯¦ç»†é”™è¯¯æ—¥å¿—æˆ‘ä»¬é¦–å…ˆå¯¹å‘ç”Ÿé”™è¯¯çš„ä½ç½®ï¼Œæ·»åŠ äº†æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œå¦‚è¯·æ±‚ä¸Šä¸‹æ–‡ä»¥åŠé”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆã€‚å¾…ä¸Šçº¿åï¼Œåœ¨ Sentry ä¸­è§‚å¯Ÿåˆ°äº†å‡ºé”™æ—¶è¯¦ç»†çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566File &quot;git.xixi.com/group/project-foo/pkg/models/prog/learn_progress.go&quot;, line 109, in Create d.Detect() File &quot;git.xixi.com/group/project-foo/pkg/controller/learn_progress.go&quot;, line 46, in Update success := learnProgress.Create(ctx, memberID, unitID, bizType, progress, clientUpdatedAt) != nil File &quot;git.xixi.com/group/project-foo/pkg/web/handlers/learn_progress.go&quot;, line 77, in Post success := h.ctrl.Update(h.R.Context(), memberID, unitID, bizType, progress, item.ClientUpdateAt) File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/handler.go&quot;, line 53, in ServeHTTP render(handler.Post()) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 291, in func1 handler.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 424, in routeHTTP h.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/middleware/sentry_meta.go&quot;, line 19, in func1 next.ServeHTTP(w, r.WithContext(ctx)) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/auth/nginx.go&quot;, line 200, in func1 next.ServeHTTP(w, r1) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/context.go&quot;, line 67, in func1 next.ServeHTTP(w, r1) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/cors@v1.0.0/cors.go&quot;, line 199, in func1 next.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/cors.go&quot;, line 51, in 1 defaultCORS.Handler(next).ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/heartbeat.go&quot;, line 21, in 1 h.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/recoverer.go&quot;, line 35, in func1 next.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/logger.go&quot;, line 46, in 1 next.ServeHTTP(ww, WithLogEntry(r, entry)) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/realip.go&quot;, line 18, in func1 h.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/sentry.go&quot;, line 83, in func1 next.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/middleware/stats.go&quot;, line 66, in 1 next.ServeHTTP(lw, r1) File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP f(w, r) File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 81, in ServeHTTP mx.handler.ServeHTTP(w, r) File &quot;net/http/server.go&quot;, line 2774, in ServeHTTP handler.ServeHTTP(rw, req) File &quot;net/http/server.go&quot;, line 1878, in serve serverHandler&#123;c.server&#125;.ServeHTTP(w, w.req) ç”±äºæˆ‘ä»¬æ˜¯å°†è¯·æ±‚çš„ Context ä¸€ç›´ä¼ é€’åˆ°æœ€ä¸‹å±‚çš„ï¼Œè€Œåœ¨çˆ¶ Context æ”¶åˆ°å–æ¶ˆä¿¡å·åä¹Ÿä¼šé€šçŸ¥åˆ°å­ Contextï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡è¿™ä¸ªå–æ¶ˆçš„è§¦å‘æ˜¯åœ¨æŸä¸ªçˆ¶ Context èŠ‚ç‚¹ã€‚ä½†å…·ä½“æ˜¯åœ¨å“ªå„¿ï¼Œä»€ä¹ˆåŸå› å¯¼è‡´çš„å¹¶ä¸æ¸…æ¥šã€‚ ä¿®å¤é—®é¢˜ &amp; æ·»åŠ æ£€æµ‹ä¸è¿‡ä¸ºäº†é¿å…å› ä¸º sql/driver å±‚æ”¶åˆ° Context Cancel ä¿¡å·è€Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œè¿›è€Œå¯¼è‡´åç»­çš„å¤„ç†æµç¨‹æœªèƒ½æ‰§è¡Œï¼Œæˆ‘ä»¬å†³å®šå…ˆä¿®å¤é—®é¢˜ï¼Œå†æ’æŸ¥åŸå› ã€‚é‚£æ€ä¹ˆä¿®å¤å‘¢ï¼Ÿå…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªä¸å¸¦ Cancel çš„ Context ç»§ç»­å¾€ sql/driver å±‚ä¼ é€’ï¼Œä½†è¯¥ Context åŒæ ·ç»§æ‰¿äº†çˆ¶ Context çš„ Valueï¼Œè¿™æ ·ä¸€äº›å…ƒä¿¡æ¯ä¹Ÿå¯ä»¥è¢«ç»§ç»­ä¼ é€’ä¸‹å»ã€‚åŒæ—¶ä¸ºäº†åœ¨æ£€æŸ¥åˆ°åŸæœ‰å­ Context æ”¶åˆ° Cancel ä¿¡å·æ—¶ï¼ŒæŠ¥å‘Šè¯¦ç»†çš„é”™è¯¯å’Œ Context Stringï¼Œæˆ‘ä»¬ä¹Ÿå®ç°äº†ä¸€ä¸ªç®€å•çš„æ£€æµ‹å™¨ã€‚ç›¸å…³æºç å¦‚ä¸‹ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344type noCancelCtx struct &#123; ctx context.Context&#125;func (c *noCancelCtx) Deadline() (time.Time, bool) &#123; return time.Time&#123;&#125;, false&#125;func (c *noCancelCtx) Done() &lt;-chan struct&#123;&#125; &#123; return nil&#125;func (c *noCancelCtx) Err() error &#123; return nil&#125;func (c *noCancelCtx) Value(key interface&#123;&#125;) interface&#123;&#125; &#123; return c.ctx.Value(key)&#125;func WithoutCancel(ctx context.Context) context.Context &#123; return &amp;noCancelCtx&#123;ctx: ctx&#125;&#125;type Detector struct &#123; where string isDone bool ctx context.Context&#125;func NewContextDoneDetector(ctx context.Context) *Detector &#123; return &amp;Detector&#123;ctx: ctx&#125;&#125;func (d *Detector) Detect() &#123; if d.isDone &#123; return &#125; select &#123; case &lt;-d.ctx.Done(): d.isDone = true var where string _, file, line, ok := runtime.Caller(1) if ok &#123; where = fmt.Sprintf("%s:%d", file, line) &#125; else &#123; where = "unknown" &#125; log.WithContext(d.ctx).Errorf("detect context done signal in \"%s\". context is %s", where, d.ctx) default: &#125;&#125; ç„¶åå¯¹åŸæœ‰çš„ä¸šåŠ¡ä»£ç è¿›è¡Œä¸€äº›æ”¹é€ å¦‚ä¸‹ï¼š123456789101112131415161718192021222324// Create åˆ›å»ºç”¨æˆ·å­¦ä¹ è¿›åº¦func (learnProgressDB *LearnProgressDAO) Create(ctx context.Context, memberID int64, unitID int64, bizType int16, progress int32, clientUpdatedAt int64) *LearnProgress &#123; d := utils.NewContextDoneDetector(ctx) d.Detect() // ...æ­¤å¤„çœç•¥ N è¡Œ d.Detect() // æ›¿æ¢æˆä¸å¸¦ Cancel çš„ Context ctxWithoutCancel := utils.WithoutCancel(ctx) result, err := db.Exec(ctxWithoutCancel, i, args...) // ...ç»§ç»­çœç•¥ d.Detect() object := db.QueryRow(ctxWithoutCancel, "SELECT id, member_id, unit_id, biz_type, progress, "+ "client_updated_at FROM learn_progress WHERE id = ?", id) learnProgress := &amp;LearnProgress&#123;&#125; d.Detect() err = object.Scan(&amp;learnProgress.ID, &amp;learnProgress.MemberID, &amp;learnProgress.UnitID, &amp;learnProgress.BizType, &amp;learnProgress.Progress, &amp;learnProgress.ClientUpdatedAt) if err != nil &#123; log.WithContext(ctx).WithError(err).Errorf("create and get progress %d error", id) return nil &#125; d.Detect() return learnProgress&#125; åœ¨ä¸Šçº¿åï¼Œå› ä¸º context canceled è€Œå¯¼è‡´è¯·æ±‚å¤„ç†æµç¨‹ä¸èƒ½èµ°å®Œçš„é—®é¢˜è§£å†³äº†ã€‚åŒæ—¶ä¹ŸæŠ¥å‘Šå‡ºå¾ˆå¤šæ£€æŸ¥åˆ°ä¸Šå±‚ Context å–æ¶ˆçš„ä¿¡å·ï¼Œè¯¦ç»†çš„æ—¥å¿—å¦‚ä¸‹ï¼š åˆ†æ HTTP Server æºç æ˜¾ç„¶ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤å¤„ Cancel Context æœ‰æå¤§çš„å«Œç–‘ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„é—®é¢˜å°±æ˜¯è¦ç¡®å®šè¿™ä¸¤ä¸ª Cancel Context æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿè¿™æ ·ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†å»ç¡®è®¤æ˜¯å“ªä¸ª Cancel Context åœ¨å“ªä¼˜å…ˆè¢« cancel ä»è€Œå¯¼è‡´å­èŠ‚ç‚¹æ”¶åˆ°äº† ctx.Done() ä¿¡å·ï¼Œä¸å°±å¯ä»¥è§£ç­”ç–‘æƒ‘äº†å—ï¼Ÿ åˆ†æè¿™æ£µ Context æ ‘å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä¼˜å…ˆå»çœ‹ HTTP Server å¤„ç†è¯·æ±‚éƒ¨åˆ†çš„ä»£ç ï¼Œå°±æœ€å®¹æ˜“æ‰¾é¡ºç€è¯·æ±‚å¤„ç†çš„å„ä¸ªæµç¨‹æ¥å®šä½åˆ° Cancel Context æ˜¯åœ¨ä½•å¤„ç”Ÿæˆçš„ï¼Œä»¥åŠåœ¨ä½•å¤„ä¼šè¢«è°ƒç”¨çš„ã€‚ ä¸€èˆ¬æˆ‘ä»¬å¯åŠ¨ Server æ˜¯è°ƒç”¨äº† ListenAndServe æ¥å£ï¼Œé¡ºç€è¯¥æ¥å£å¾€ä¸‹åˆ†æå³å¯æ‰¾åˆ°çº¿ç´¢ï¼Œè¯¦ç»†çš„åˆ†æå¦‚ä¸‹ï¼ˆå’Œæˆ‘ä»¬ç¡®å®šé—®é¢˜æ— å…³ç´§è¦çš„ä»£ç å…ˆå¿½ç•¥äº†ï¼‰ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103// ListenAndServe ç”¨äºå¯åŠ¨æœåŠ¡å¹¶ç›‘å¬æŒ‡å®šçš„ç«¯å£func (srv *Server) ListenAndServe() error &#123; addr := srv.Addr ln, err := net.Listen("tcp", addr) if err != nil &#123; return err &#125; return srv.Serve(tcpKeepAliveListener&#123;ln.(*net.TCPListener)&#125;)&#125;// Serve ç”¨äºæ¥æ”¶è¯·æ±‚è¿æ¥ï¼Œå¹¶ä¸ºæ¯ä¸ªæ–°çš„è¿æ¥æœåŠ¡åˆ›å»ºä¸€ä¸ª service goroutineã€‚func (srv *Server) Serve(l net.Listener) error &#123; // ... æ­¤å¤„çœç•¥ä¸å°‘ var tempDelay time.Duration // how long to sleep on accept failure // è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ ¹ context baseCtx := context.Background() // base is always background, per Issue 16220 // ç¬¬ä¸€ä¸ª WithValue æ­£æ˜¯ `http.&amp;contextKey&#123;"http-server"&#125;` ctx := context.WithValue(baseCtx, ServerContextKey, srv) for &#123; rw, e := l.Accept() // ...æ­¤å¤„çœç•¥å¾ˆå¤š c := srv.newConn(rw) c.setState(c.rwc, StateNew) // before Serve can return // å¯åŠ¨æ–°çš„ service goroutine å¤„ç†è¿æ¥æœåŠ¡ï¼Œä¸Šé¢çš„ ctx è¢«ä¼ é€’è¿›å»äº†ï¼ï¼ go c.serve(ctx) &#125;&#125;// // serve è¯»å–è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ `srv.Handler` æ¥å¤„ç†è¯·æ±‚ï¼Œè¿›è€Œæ‰§è¡Œåˆ°ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œè¯·æ±‚å// ç»™å®¢æˆ·ç«¯è¿”å›å“åº”func (c *conn) serve(ctx context.Context) &#123; // æ³¨æ„ï¼Œè¿™é‡Œæ·»åŠ äº† `http.&amp;contextKey&#123;"local-addr"&#125;` å­ Context ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr()) // ...æ­¤å¤„çœç•¥å¾ˆå¤š // HTTP/1.x from here on. // Bingoï¼Œè¿™é‡Œçœ‹åˆ°äº†ç¬¬ä¸€ä¸ª WithCancel åˆ›å»ºçš„å­ Context äº† ctx, cancelCtx := context.WithCancel(ctx) c.cancelCtx = cancelCtx defer cancelCtx() c.r = &amp;connReader&#123;conn: c&#125; c.bufr = newBufioReader(c.r) // æ³¨æ„è¿™é‡Œçš„ checkConnErrorWriterï¼Œåé¢åˆ†æä¼šæ¶‰åŠ c.bufw = newBufioWriterSize(checkConnErrorWriter&#123;c&#125;, 4&lt;&lt;10) for &#123; // readRequest ä¼šè¿”å›ä¸€ä¸ª responseï¼Œå…¶ä¸­åŒ…æ‹¬æ·»åŠ å­ Cancel Context w, err := c.readRequest(ctx) // ...æ­¤å¤„çœç•¥å¾ˆå¤š // æ³¨æ„è¿™é‡Œçš„ startBackgroundReadï¼Œä¸‹é¢åˆ†æä¼šçœ‹åˆ° if requestBodyRemains(req.Body) &#123; registerOnHitEOF(req.Body, w.conn.r.startBackgroundRead) &#125; else &#123; w.conn.r.startBackgroundRead() &#125; // è°ƒç”¨ ServeHTTPï¼Œè¿›è€Œå°†è¯·æ±‚ä¼ é€’åˆ°ä¸šåŠ¡ä»£ç ä¸­ï¼Œç­‰å¾…å¤„ç†å®Œæ¯• // åœ¨ä¸Šè¿°æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªè°ƒç”¨æ²¡æœ‰ç»“æŸçš„æ—¶å€™ï¼Œcontext // å·²ç» cancel äº†ã€‚è€Œè¿™ä¸ªè°ƒç”¨ä¸­ æˆ‘ä»¬ç¡®è®¤æ²¡æœ‰å¼‚æ­¥ cancel context çš„ä»£ç  // å¹¶ä¸”ï¼Œ`*http.response` å³ `w` è¿™ä¸ªç»“æ„ä½“ä¸­ `cancelCtx` æ˜¯ä¸ªç§æœ‰å­—æ®µï¼Œä¸ä¼š // è¢«å¤–éƒ¨è®¿é—®åˆ°ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨ ServeHTTP æœŸé—´è°ƒç”¨äº† `cancelCtx` å‡½æ•° serverHandler&#123;c.server&#125;.ServeHTTP(w, w.req) // é€šè¿‡å¯¹ä»£ç çš„åˆ†æï¼Œåªæœ‰æ­¤å¤„è°ƒç”¨äº†ä¸€æ¬¡ `*http.response` é‡Œé¢çš„ cancelCtx // æ‰€ä»¥æˆ‘ä»¬ç¡®è®¤å¯¼è‡´ä¸‹å±‚æ”¶åˆ° context cancel ä¿¡å·çš„è§¦å‘ç‚¹ä¸åœ¨æ­¤å¤„ï¼ w.cancelCtx() w.finishRequest() if !w.shouldReuseConnection() &#123; if w.requestBodyLimitHit || w.closedRequestBodyEarly() &#123; c.closeWriteAndWait() &#125; return &#125; // ... æ­¤å¤„çœç•¥ &#125;&#125;// readRequest ä»è¿æ¥ä¸­è¯»å–ä¸‹ä¸€ä¸ªè¯·æ±‚func (c *conn) readRequest(ctx context.Context) (w *response, err error) &#123; // ...æ­¤å¤„çœç•¥å¾ˆå¤š // å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ª cancel context èŠ‚ç‚¹è¯ç”Ÿäº† ctx, cancelCtx := context.WithCancel(ctx) req.ctx = ctx // ...æ­¤å¤„çœç•¥å¾ˆå¤š w = &amp;response&#123; conn: c, cancelCtx: cancelCtx, req: req, reqBody: req.Body, handlerHeader: make(Header), contentLength: -1, closeNotifyCh: make(chan bool, 1), // We populate these ahead of time so we're not // reading from req.Header after their Handler starts // and maybe mutates it (Issue 14940) wants10KeepAlive: req.wantsHttp10KeepAlive(), wantsClose: req.wantsClose(), &#125; if isH2Upgrade &#123; w.closeAfterReply = true &#125; w.cw.res = w w.w = newBufioWriterSize(&amp;w.cw, bufferBeforeChunkingSize) return w, nil&#125; æ ¹æ®è¯¦ç»†æ‰“å°çš„ Context æ—¥å¿—ï¼Œå¹¶ç»“åˆ HTTP Server å¤„ç†éƒ¨åˆ†çš„ä»£ç åˆ†æï¼Œå¯ä»¥ç®€å•ç»˜åˆ¶å‡ºè¿™æ£µ Context æ ‘å¤§ä½“å¦‚ä¸‹ï¼š åœ¨è¿›è¡Œ Server å¤„ç†è¿æ¥è¯·æ±‚çš„æºç ä¸­ï¼Œå¯ä»¥å‘ç°ä¸å¤ªå¯èƒ½æ˜¯ç¬¬äºŒä¸ª Cancel Context å‘é€çš„å–æ¶ˆä¿¡å·ã€‚é‚£ä¹ˆï¼Œé—®é¢˜åªèƒ½å‡ºç°åœ¨ä¸€ä¸ª Cancel Context ä¸Šé¢äº†ã€‚æ¥ä¸‹æ¥ï¼Œå°±çœ‹çœ‹ Connection å…³è”çš„ cancelCtx() ç©¶ç«Ÿä¼šåœ¨å“ªå‡ å¤„è°ƒç”¨ï¼Ÿåˆ©ç”¨æœç´¢å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä¸¤ä¸ªå«Œç–‘å¾ˆå¤§çš„åœ°æ–¹ï¼š123456789101112131415161718// handleReadError åœ¨ä»å®¢æˆ·ç«¯è¯»å–å¤±è´¥æ—¶ä¼šè¢«è°ƒç”¨ã€‚è¿™é‡Œçš„é”™è¯¯ä¹‹æ‰€ä»¥// è¢«çœç•¥ï¼Œæ˜¯å› ä¸ºé”™è¯¯é€šå¸¸å°±æ˜¯ io.EOF æˆ–è€… "use of closed network connection"// æ ‡å‡†åº“è®¤ä¸ºæˆ‘ä»¬å¯¹å…·ä½“æŠ¥é”™ä¸æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥è¿ error æ˜¯ä»€ä¹ˆåœ¨ä¸šåŠ¡ä»£ç ä¸­æ˜¯æ— æ³•è·å–// åˆ°çš„ã€‚// æ€»ä¹‹ï¼Œæ‰§è¡Œåˆ°æ­¤å¤„ï¼Œå°±æ„å‘³ç€è¿æ¥å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥ä¸€å®šè¦é€šçŸ¥å–æ¶ˆ contextfunc (cr *connReader) handleReadError(_ error) &#123; cr.conn.cancelCtx() cr.closeNotify()&#125;func (w checkConnErrorWriter) Write(p []byte) (n int, err error) &#123; n, err = w.c.rwc.Write(p) if err != nil &amp;&amp; w.c.werr == nil &#123; w.c.werr = err w.c.cancelCtx() &#125; return&#125; é€šè¿‡è¿›ä¸€æ­¥åˆ†æï¼ŒcheckConnErrorWriter åªæœ‰åœ¨è¯·æ±‚å¤„ç†å®Œæ¯•ï¼Œw.finishRequest() æ—¶æ‰å¯èƒ½ä¼šåœ¨æŸä¸ªæ—¶åˆ»è¢«è°ƒç”¨ã€‚æ‰€ä»¥ä¸å¯èƒ½æ˜¯è¿™é‡Œçš„ cancelCtx() è°ƒç”¨å¯¼è‡´çš„ï¼Œå› ä¸ºåœ¨æŠ¥é”™æ—¶ï¼Œæ˜¾ç„¶è¿˜æ²¡æœ‰å®Œæˆ ServeHTTP() çš„æµç¨‹ã€‚ä¸€é€šæ’æŸ¥ä¸‹æ¥ï¼Œåªå¯èƒ½æ˜¯åœ¨ handleReadError() æ—¶æŠ¥é”™äº†ã€‚ç»“åˆç½‘ä¸Šçš„æœç´¢ä¿¡æ¯ï¼Œæˆ‘ä»¬åˆ¤æ–­ææœ‰å¯èƒ½æ˜¯å®¢æˆ·ç«¯è¿æ¥æ–­å¼€å¯¼è‡´çš„å¤§é‡æŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´ handleReadError() è¢«è°ƒç”¨æ‰å¯¼è‡´çš„ã€‚ æ·»åŠ  HTTP Middleware ç›‘æµ‹è¿æ¥æ–­å¼€é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•éªŒè¯çš„ç¡®æ˜¯ connection closed å¯¼è‡´çš„å‘¢ï¼Ÿé€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¤„ç†é”™è¯¯æ—¶è°ƒç”¨äº† closeNotify() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°† *http.response çš„ closeNotifyCh å‘é€ä¸€ä¸ª true å€¼ã€‚è¿›ä¸€æ­¥å‘ç°ï¼Œ*http.response å®ç°äº†æ¥å£ CloseNotifierï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­ç›‘å¬è¿™ä¸ªä¿¡å·æ¥è¿›ä¸€æ­¥éªŒè¯è¿æ¥æ˜¯ä¸æ˜¯çœŸçš„æ–­å¼€äº†ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶ï¼Œå¯åŠ¨ä¸€ä¸ª goroutine å»ç›‘å¬å…³é—­ä¿¡å·ï¼Œå¹¶åœ¨æ”¶åˆ°ä¿¡å·æ—¶å‘ Sentry ä¸­æ‰“å°ç›¸å…³æŠ¥é”™ï¼š12345678910111213141516171819202122232425func MonitorCloseNotifier(next http.Handler) http.Handler &#123; return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) &#123; if r.Method == "GET" &amp;&amp; strings.EqualFold(r.URL.Path, "/check_health") &#123; next.ServeHTTP(w, r) &#125; else &#123; go func() &#123; defer func() &#123; if err := recover(); err != nil &#123; log.Warn(err) &#125; &#125;() cc := w.(http.CloseNotifier).CloseNotify() value := &lt;-cc ctx := context.WithValue( r.Context(), log.SentrySpecificMetaCtxKey, collectSentryMeta(r, "login_id"), ) log.WithContext(ctx).Errorf( "connection read error, maybe 'use of closed network connection' or 'io.EOF'. return value: %v", value) &#125;() next.ServeHTTP(w, r) &#125; &#125;)&#125; åœ¨å®Œæˆä»£ç å˜æ›´ï¼Œå¹¶è¿›è¡Œé‡‘ä¸é›€å°æµé‡éªŒè¯æ—¶ï¼Œåœ¨ Sentry ä¸Šçœ‹åˆ°äº†ç›¸å…³çš„æŠ¥é”™ã€‚ç”±æ­¤ç¡®è®¤æ˜¯åœ¨ä½•å¤„å› ä¸ºä»€ä¹ˆå¯¼è‡´äº† Context Cancelã€‚ å°ç»“å†ç»å¤šæ¬¡ä»£ç å˜æ›´å’Œæ—¥å¿—åˆ†ææ‰æœ€ç»ˆç¡®å®šåœ¨ä½•å¤„å› ä¸ºä»€ä¹ˆå¯¼è‡´äº† Context Cancelï¼Œæ•´ä¸ªè¿‡ç¨‹éå¸¸åå·ã€‚é‚£ä¸ºä»€ä¹ˆæ²¡æœ‰ç›´æ¥è¿›è¡Œè°ƒè¯•å‘¢ï¼Ÿé‚£æ ·å®šä½é—®é¢˜ä¸æ˜¯æ›´å¿«é€Ÿäº›å—ï¼ŸåŸå› æ˜¯è¿™æ ·ï¼Œæœ€å¼€å§‹æˆ‘ä»¬å¹¶ä¸çŸ¥é“ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼›è¿™æ ·ä¹Ÿå°±æ²¡æ³•åœ¨æœ¬åœ°å¤ç°é—®é¢˜ï¼Œç”±äºè¿™äº›é—®é¢˜æ˜¯åœ¨çº¿ä¸Šäº§ç”Ÿçš„ï¼Œä¹Ÿä¸å¤§å¯èƒ½ç›´æ¥åœ¨çº¿ä¸Šæ‹¦æˆªç”¨æˆ·è¯·æ±‚å¹¶è°ƒè¯•ï¼Œé‚£æ ·å¯èƒ½æ›´åŠ ç¹çã€è€—æ—¶ï¼Œä¸”å®æ–½æˆæœ¬æ›´å¤§ï¼ˆå› ä¸ºæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“å“ªä¸ªç”¨æˆ·ä½¿ç”¨ä»€ä¹ˆè®¾å¤‡åœ¨ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿé—®é¢˜ï¼‰ã€‚ æ‰€ä»¥é‡‡å–åˆ†æé”™è¯¯æ—¥å¿—åŠ éªŒè¯çš„æ–¹å¼æ¥ç¡®å®šé—®é¢˜æ‰€åœ¨ã€‚å½“ç„¶ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆéº»çƒ¦ä¹Ÿæ˜¯å› ä¸º Context Cancel æ—¶æä¾›çš„ Error å¤ªå•ä¸€äº†ã€‚å¦‚æœæœ€åˆ API è®¾è®¡æ—¶å°±èƒ½æä¾›è‡ªå®šä¹‰çš„é”™è¯¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“é”™è¯¯æ¥å®šä½åˆ°å¯èƒ½äº§ç”ŸæŠ¥é”™çš„ä½ç½®ï¼Œè¿™æ ·ä¼šæ›´åŠ å¿«æ·ï¼ Contextcontext åŒ…æœ€åˆæ˜¯ç”± Google å®˜æ–¹å¼€å‘ï¼Œå¹¶åœ¨ Go 1.7 ç‰ˆæœ¬æ­£å¼å¼•å…¥åˆ°æ ‡å‡†åº“ä¸­çš„ã€‚å¼•å…¥è¯¥åŒ…çš„ç›®çš„æ˜¯ä¸ºäº†æä¾›ç»Ÿä¸€çš„å§¿åŠ¿å¤„ç†è¶…æ—¶ã€å–æ¶ˆä¿¡å·ä¼ é€’å’Œåœ¨ API ä¹‹é—´ä¼ é€’è¯·æ±‚ä¸Šä¸‹æ–‡æ•°æ®ã€‚å®ƒæä¾›äº†å‡ ä¸ªé‡è¦çš„æ¥å£ç”¨äºåˆ›å»º Context æ ‘ğŸŒ²ï¼š WithCancel WithDeadline WithTimeout WithValue è¿™äº›æ¥å£ä¼šæ¥æ”¶ä¸€ä¸ª parent contextï¼Œå¹¶è¿”å›ä¸€ä¸ª derived contextã€‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œåº”è¯¥å±‚å±‚ä¼ é€’è¯¥ contextï¼Œä¸€èˆ¬çº¦å®šå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ contextï¼Œç­¾åç±»ä¼¼ï¼šfunc foo(ctx context.Context)ã€‚ å¯¹äº WithCancel, WithDeadline, WithTimeout è€Œè¨€ï¼Œå®ƒä»¬éƒ½ä¼šè¿”å› cancelFunc ä¾›ä½¿ç”¨è€…è°ƒç”¨ã€‚å½“ cancelFunc è¢«è°ƒç”¨æ—¶ï¼Œé™¤äº†è‡ªèº«ä¼šè¢«å–æ¶ˆå¤–ï¼Œå…¶å­ context éƒ½ä¼šè¢«å–æ¶ˆã€‚ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š æºç åˆ†æContext InterfaceContext æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š123456789101112131415161718192021type Context interface &#123; // Deadline ä¼šè¿”å›ä»€ä¹ˆæ—¶é—´ context ä¼šè¢«å–æ¶ˆã€‚å¦‚æœæ²¡æœ‰è®¾ç½® // è¿‡æœŸæ—¶é—´ï¼Œåˆ™ ok è¿”å› falseã€‚ Deadline() (deadline time.Time, ok bool) // Done åœ¨ context è¢«å–æ¶ˆæ—¶å¯¹åº”çš„ channel ä¼šè¢«å…³é—­ï¼Œä»è€Œè¾¾åˆ° // é€šçŸ¥æ­£åœ¨ç›‘å¬çš„ goroutine ç»ˆæ­¢æ‰‹å¤´å·¥ä½œçš„ç›®çš„ã€‚å¯¹äºä¸å¯å–æ¶ˆçš„ // contextï¼Œåˆ™è¿”å› nilã€‚ // å¯¹äº WithCancel, WithDeadline, WithTimeout è€Œè¨€ï¼Œæœ€ç»ˆéƒ½ä¼š // å…³é—­ done channelã€‚ Done() &lt;-chan struct&#123;&#125; // Err ä¼šåœ¨ Done è¢«å…³é—­æ—¶ï¼Œè¿”å›é”™è¯¯ï¼ˆè¿™é‡Œçš„é”™è¯¯åœ¨ context åŒ…å†…ä»…é™ Canceled å’Œè¶…æ—¶ DeadlineExceededï¼‰ Err() error // Value ç”¨äºè¿”å›å­˜å‚¨åœ¨ Context ä¸­æŒ‡å®š key å¯¹åº”çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚å¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›ç©ºã€‚ // è¿™é‡Œå¦‚æœåœ¨å½“å‰ context æ‰¾ä¸åˆ°ï¼Œå°±ä¼šä¸€ç›´å¾€ä¸Šæ‰¾ parent ç›´åˆ°æ ¹èŠ‚ç‚¹ã€‚ // ä»…é™äºä½¿ç”¨ Context å­˜å‚¨ä¸€äº›è¯·æ±‚ç›¸å…³ï¼ˆrequest-scopedï¼‰æ•°æ®ï¼Œå¹¶åœ¨åº”ç”¨ä¸­ä¼ é€’ï¼Œ // å¯¹äºä¸€äº›é¢å¤–çš„å‚æ•°ï¼Œä¼ é€’ç»å¯¹ä¸æ¨èä½¿ç”¨å®ƒï¼ Value(key interface&#123;&#125;) interface&#123;&#125;&#125; TODO &amp; Backgroundåœ¨ context åŒ…ä¸­å®šä¹‰äº†ä¸¤ç§ emptyCtxï¼Œåˆ†åˆ«æ˜¯ todo å’Œ backgroundã€‚ç›¸å…³å®ç°éå¸¸ç®€å•ï¼š123456789101112131415161718// emptyCtx æ˜¯ä¸ä¼šè¢«å–æ¶ˆï¼Œæ— ä»»ä½•å€¼å’Œ deadline çš„ã€‚ä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ç©ºç»“æ„ä½“ï¼ˆstruct&#123;&#125;ï¼‰// æ˜¯å› ä¸ºè¦ä¿è¯è¯¥ç±»å‹çš„æ¯ä¸ªå€¼éƒ½è¦æœ‰ä¸åŒçš„åœ°å€type emptyCtx intfunc (*emptyCtx) Deadline() (deadline time.Time, ok bool) &#123; return &#125;func (*emptyCtx) Done() &lt;-chan struct&#123;&#125; &#123; return nil &#125;func (*emptyCtx) Err() error &#123; return nil &#125;func (*emptyCtx) Value(key interface&#123;&#125;) interface&#123;&#125; &#123; return nil &#125;var ( background = new(emptyCtx) todo = new(emptyCtx))// Background é€šå¸¸åœ¨ main å‡½æ•°ã€æµ‹è¯•ä¸­åˆå§‹åŒ–ï¼Œæˆ–è€…è¯·æ±‚å¯¹åº”çš„é¡¶å±‚ Contextfunc Background() Context &#123; return background &#125;// TODO é€šå¸¸åœ¨ä¸çŸ¥é“è¯¥ç”¨ä»€ä¹ˆ Context çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å®ƒfunc TODO() Context &#123; return todo &#125; WithCancelæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ WithCancel() æ¥å£æ¥åˆ›å»ºä¸€ä¸ªå¯è¢«å–æ¶ˆçš„ Contextï¼Œè¯¥æ¥å£ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å­ Context èŠ‚ç‚¹å’Œç”¨äºå–æ¶ˆæ—¶è°ƒç”¨çš„å‡½æ•° cancelFuncã€‚ç›¸å…³æºç å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061// CancelFunc é€šçŸ¥å–æ¶ˆä»»åŠ¡ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼›åªèƒ½è¢«æœ‰æ•ˆè°ƒç”¨ä¸€æ¬¡type CancelFunc func()// WithCancel ä¼šè¿”å›ä¸€ä¸ª parent çš„æ‹·è´ï¼ŒåŒæ—¶å¸¦æœ‰ Done channelã€‚// å–æ¶ˆè¯¥ context æ—¶ä¼šé‡Šæ”¾å…³è”çš„èµ„æºï¼Œæ‰€ä»¥å½“è¯¥ Context å®Œæˆæ—¶éœ€è¦å°½å¿«è°ƒç”¨ cancelfunc WithCancel(parent Context) (ctx Context, cancel CancelFunc) &#123; c := newCancelCtx(parent) propagateCancel(parent, &amp;c) return &amp;c, func() &#123; c.cancel(true, Canceled) &#125;&#125;// newCancelCtx ä¼šè¿”å›ä¸€ä¸ªåˆå§‹åŒ–å¥½çš„ cancelCtx å®ä¾‹// å…³äºä»€ä¹ˆæ˜¯ cancelCtx ä¼šåœ¨ä¸‹é¢åˆ†æå®ƒçš„æºç func newCancelCtx(parent Context) cancelCtx &#123; return cancelCtx&#123;Context: parent&#125;&#125;// propagateCancel æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†å°†å­ canceler æŒ‚è½½åˆ°çˆ¶ canceler èŠ‚ç‚¹ä¸Š// è¿™æ ·åœ¨çˆ¶èŠ‚ç‚¹æ”¶åˆ°å–æ¶ˆé€šçŸ¥æ—¶ï¼Œæ‰èƒ½ä¸€ä¸€é€šçŸ¥åˆ°å­èŠ‚ç‚¹func propagateCancel(parent Context, child canceler) &#123; if parent.Done() == nil &#123; // parent ä¸æ”¯æŒå–æ¶ˆçš„æƒ…å†µ return // parent is never canceled &#125; // è¿™é‡Œåªæ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰ context åŒ…ä¸­å®šä¹‰çš„ // cancelCtx ç»“æ„è€Œå·² // parentCancelCtx(parent) ç¡®è®¤ parent æ˜¯å¦ä¸º // cancelCtx æˆ–è€… timerCtx ç±»å‹ if p, ok := parentCancelCtx(parent); ok &#123; p.mu.Lock() if p.err != nil &#123; // parent has already been canceled // parent å¦‚æœè¢«å–æ¶ˆï¼Œè‡ªç„¶ä¸éœ€è¦ removeChildï¼Œå› ä¸º // parent å¯¹åº”çš„å­æ ‘ä¼šè¢« detatch æ‰ï¼Œç¡®ä¿é‡Šæ”¾èµ„æº child.cancel(false, p.err) &#125; else &#123; // å»¶è¿Ÿåˆå§‹åŒ–äº† children if p.children == nil &#123; // ä¸ºä»€ä¹ˆæ˜¯æ”¾åœ¨å­—å…¸ï¼Œè€Œéåˆ—è¡¨å‘¢ï¼Ÿ // åŸå› å¾ˆç®€å•ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿åˆ é™¤ child // delete(p.children, child) p.children = make(map[canceler]struct&#123;&#125;) &#125; // æŠŠå­èŠ‚ç‚¹æŒ‚è½½åˆ° cancel context çš„çˆ¶èŠ‚ç‚¹ä¸Š p.children[child] = struct&#123;&#125;&#123;&#125; &#125; p.mu.Unlock() &#125; else &#123; go func() &#123; select &#123; case &lt;-parent.Done(): // å¯¹äºçˆ¶èŠ‚ç‚¹è¿”å› Done channel çš„è¿›è¡Œç›‘å¬ child.cancel(false, parent.Err()) case &lt;-child.Done(): // ç­‰å¾… cancel ctx è¢«ç»“æŸ // è¿™é‡Œåªå¯èƒ½æ˜¯ timerCtx, cancelCtx // goroutine é€€å‡º &#125; &#125;() &#125;&#125; å¯¹äºå¯è¢«å–æ¶ˆçš„ Context éƒ½å®ç°äº†ä¸‹é¢çš„æ¥å£ï¼š123456// canceler å°±æ˜¯å®ç°äº† cancel çš„ context ç±»å‹ã€‚åœ¨æ ‡å‡†åº“ä¸­// ä»…æœ‰ `cancelCtx` å’Œ `timerCtx` å®ç°äº†è¯¥æ¥å£type canceler interface &#123; cancel(removeFromParent bool, err error) Done() &lt;-chan struct&#123;&#125;&#125; åœ¨åˆ†æ WithCancel çš„æºç æ—¶ï¼Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª cancelCtx å®ä¾‹ï¼Œå¹¶å°†åŸæœ‰çš„ Context ä½œä¸ºçˆ¶èŠ‚ç‚¹è®°å½•äº†ä¸‹æ¥ã€‚é‚£ä¹ˆ cancelCtx æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•å¤„ç†å–æ¶ˆé€»è¾‘çš„å‘¢ï¼Ÿ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960// A cancelCtx can be canceled. When canceled, it also cancels any children// that implement canceler.type cancelCtx struct &#123; // Context ä¼šæŒ‡å‘ parent Context // mu ç”¨æ¥ä¿è¯ goroutine å®‰å…¨ mu sync.Mutex // protects following fields done chan struct&#123;&#125; // created lazily, closed by first cancel call // ä¹‹æ‰€ä»¥ä½¿ç”¨å­—å…¸æ¥å­˜å‚¨ï¼Œæ˜¯å› ä¸ºä¸å…³å¿ƒå­èŠ‚ç‚¹é¡ºåºï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿åˆ é™¤ children map[canceler]struct&#123;&#125; // set to nil by the first cancel call err error // set to non-nil by the first cancel call&#125;// Done ä¼šè¿”å›ä¸€ä¸ªå»¶è¿Ÿåˆå§‹åŒ–çš„ chan ä¾›ä¸‹æ¸¸ç›‘å¬å®Œæˆä¿¡å·func (c *cancelCtx) Done() &lt;-chan struct&#123;&#125; &#123; c.mu.Lock() if c.done == nil &#123; // å»¶è¿Ÿåˆå§‹åŒ– c.done = make(chan struct&#123;&#125;) &#125; d := c.done c.mu.Unlock() return d&#125;func (c *cancelCtx) Err() error &#123; c.mu.Lock() err := c.err c.mu.Unlock() return err&#125;// cancel è´Ÿè´£å…³é—­ c.done chanï¼ŒåŒæ—¶å–æ¶ˆæ¯ä¸ªå­èŠ‚ç‚¹// å¹¶æ ¹æ®éœ€è¦å°†å¯¹åº”çš„èŠ‚ç‚¹ä»å®ƒçš„çˆ¶èŠ‚ç‚¹çš„ children ä¸­ç§»é™¤func (c *cancelCtx) cancel(removeFromParent bool, err error) &#123; if err == nil &#123; panic("context: internal error: missing cancel error") &#125; c.mu.Lock() if c.err != nil &#123; c.mu.Unlock() return // already canceled &#125; c.err = err if c.done == nil &#123; // ç¡®ä¿ä¸‹æ¬¡è°ƒç”¨æ—¶å·²ç»å…³é—­äº† c.done = closedchan &#125; else &#123; close(c.done) &#125; for child := range c.children &#123; // NOTE: acquiring the child's lock while holding parent's lock. // ä¾æ¬¡ cancel æ‰€æœ‰çš„å­èŠ‚ç‚¹ child.cancel(false, err) &#125; c.children = nil c.mu.Unlock() if removeFromParent &#123; removeChild(c.Context, c) &#125;&#125; WithDeadline &amp; WithTimeoutå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹ goroutine è®¾ç½®è¶…æ—¶æˆ–è€…åˆ°è¾¾æŒ‡å®šæ—¶é—´åé€€å‡ºçš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ WithDeadline() æˆ– WithTimeout() æ¥å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738// WithDeadline ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆ°æœŸæ—¶é—´æ§åˆ¶çš„ contextï¼Œåœ¨æ—¶é—´åˆ°è¾¾åä¼šè‡ªåŠ¨// å…³é—­ done channelï¼ŒåŒæ—¶ä¸‹æ¸¸çš„èŠ‚ç‚¹ä¹Ÿä¼šæ”¶åˆ°å–æ¶ˆé€šçŸ¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº// è¿™ç§ç±»å‹çš„ cancelï¼Œå¯¹åº”çš„ Error æ˜¯ DeadlineExceeded// å¦å¤–ï¼Œè¿”å›çš„ cancelFunc ä¸€å®šè¦è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿èµ„æºæœ€ç»ˆèƒ½è¢«é‡Šæ”¾func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) &#123; // å¦‚æœçˆ¶èŠ‚ç‚¹æå‰ç»“æŸï¼Œåˆ™ä¸ç”¨å†ä¸ºå­èŠ‚ç‚¹æ·»åŠ é¢å¤–çš„è®¡æ—¶èµ„æºäº† // å› ä¸ºå½“çˆ¶èŠ‚ç‚¹ç»“æŸæ—¶ï¼Œå­èŠ‚ç‚¹ä¹Ÿä¼šè¢«é€šçŸ¥åˆ° if cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123; // è¿™é‡Œï¼Œå¦‚æœè¯´å·²ç»åˆ°æœŸäº†ï¼Œè‡ªç„¶æ²¡å¿…è¦å¼•å…¥ä¸€ä¸ªè®¡æ—¶å™¨èµ„æº // æ‰€ä»¥ç›´æ¥è¿”å›ä¸€ä¸ª Cancel Context äº† return WithCancel(parent) &#125; c := &amp;timerCtx&#123; cancelCtx: newCancelCtx(parent), deadline: d, &#125; propagateCancel(parent, c) dur := time.Until(d) if dur &lt;= 0 &#123; // å¦‚æœæŒ‡å®šçš„æ—¶é—´ç‚¹å·²ç»è¿‡äº†çš„è¯ï¼Œåˆ™ç›´æ¥å–æ¶ˆ c.cancel(true, DeadlineExceeded) return c, func() &#123; c.cancel(false, Canceled) &#125; &#125; c.mu.Lock() defer c.mu.Unlock() if c.err == nil &#123; c.timer = time.AfterFunc(dur, func() &#123; // å½“æ—¶é—´åˆ°äº†åï¼Œä¼šæ‰§è¡Œ cancel æ–¹æ³• c.cancel(true, DeadlineExceeded) &#125;) &#125; return c, func() &#123; c.cancel(true, Canceled) &#125;&#125;// WithTimeout æŒ‡å®šè¶…æ—¶æ—¶é—´çš„ Contextï¼Œå…¶å®å°±æ˜¯å¤ç”¨äº† WithDeadline æ–¹æ³•func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) &#123; return WithDeadline(parent, time.Now().Add(timeout))&#125; timerCtx æ˜¯å®ç°å¸¦å®šæ—¶åŠŸèƒ½çš„ Context ç±»å‹ï¼Œå®ƒçš„å®ç°æ¯”è¾ƒç®€å•ï¼š12345678910111213141516171819202122type timerCtx struct &#123; cancelCtx timer *time.Timer // timer èµ„æºçš„è®¿é—®æ˜¯ç”± cancelCtx ä¸­çš„ Lock æ¥ä¿éšœçš„ deadline time.Time&#125;func (c *timerCtx) Deadline() (deadline time.Time, ok bool) &#123; return c.deadline, true &#125;// cancel ä¸»è¦åœ¨ timerCtx å–æ¶ˆæ—¶ï¼Œé‡Šæ”¾æ‰ timer èµ„æºfunc (c *timerCtx) cancel(removeFromParent bool, err error) &#123; // å°†å½“å‰èŠ‚ç‚¹çš„ done channel close æ‰ï¼ŒåŒæ—¶å–æ¶ˆç›¸å…³å­èŠ‚ç‚¹ c.cancelCtx.cancel(false, err) if removeFromParent &#123; removeChild(c.cancelCtx.Context, c) &#125; c.mu.Lock() if c.timer != nil &#123; // é‡Šæ”¾ timer èµ„æº c.timer.Stop() c.timer = nil &#125; c.mu.Unlock()&#125; WithValueé€šå¸¸ä½¿ç”¨ WithValue() æ–¹æ³•ç»™ Context é™„åŠ ä¸€äº›è¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š1234567891011121314151617181920212223func WithValue(parent Context, key, val interface&#123;&#125;) Context &#123; if key == nil &#123; panic("nil key") &#125; // ä¿è¯ Key æœ¬èº«æ˜¯å¯æ¯”è¾ƒçš„å³å¯ if !reflectlite.TypeOf(key).Comparable() &#123; panic("key is not comparable") &#125; return &amp;valueCtx&#123;parent, key, val&#125;&#125;type valueCtx struct &#123; Context key, val interface&#123;&#125;&#125;func (c *valueCtx) Value(key interface&#123;&#125;) interface&#123;&#125; &#123; if c.key == key &#123; return c.val &#125; // å¾€ parent å»æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°ä¸ºæ­¢ return c.Context.Value(key)&#125; åº”ç”¨åœºæ™¯ä¼ é€’è¯·æ±‚ç›¸å…³çš„æ•°æ®ä½¿ç”¨ WithValue å°†éœ€è¦çš„è¯·æ±‚æ•°æ®å­˜å‚¨åœ¨ Context ä¸­ï¼Œæ–¹ä¾¿å‘ä¸‹ä¼ é€’ã€‚æˆ‘ä»¬ä¸€èˆ¬è¦å°½é‡é¿å…åœ¨ä¸šåŠ¡ä»£ç ä¸­ç›´æ¥è§£æ Context ä¸­çš„æŸäº› Keyã€‚ 12345678910111213141516171819202122232425262728293031type contextKey struct&#123; name string &#125;var ( // ä¸è¦ä½¿ç”¨ string keyï¼Œé¿å…å†²çª traceIDCtxKey = &amp;contextKey&#123;name: "request-trace-id"&#125;)// å»ºè®®ä½¿ç”¨å‡½æ•°å°è£…ä¸‹ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£æ–¹ä¾¿ä½¿ç”¨func WithTraceID(ctx context.Context, id string) context.Context &#123; return context.WithValue(ctx, traceIDCtxKey, id)&#125;func TraceIDFrom(ctx context.Context) string &#123; if traceID, ok := ctx.Value(traceIDCtxKey).(string); ok &#123; return traceID &#125; else &#123; return "" &#125;&#125;func exampleWithValue(ctx context.Context) &#123; doStuff := func(ctx context.Context) &#123; traceID := TraceIDFrom(ctx) fmt.Printf("got request trace id: %s\n", traceID) &#125; // æ¨¡æ‹Ÿä¼ é€’è¯·æ±‚ trace idï¼Œè¿™äº›å¯ä»¥è¢«æ—¥å¿—æ¡†æ¶ç­‰æå–å¹¶å­˜å‚¨åˆ°æ—¥å¿—ä¸­ id, _ := uuid.GenerateUUID() ctx = WithTraceID(ctx, id) doStuff(ctx)&#125; è¶…æ—¶æ§åˆ¶1234567891011121314151617181920212223242526// exampleWithTimeout æ¨¡æ‹Ÿä¸€ç»„è¯·æ±‚ï¼Œå¹¶ä¸”å‡è®¾æ¯ä¸ªè¯·æ±‚å¤„ç†æ—¶é—´ä¸º 0~3 ç§’çš„éšæœºæ—¶é—´// åŒæ—¶æˆ‘ä»¬å°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 1 ç§’ï¼Œè¿™æ ·åœ¨è¯·æ±‚æœŸé—´å°±ä¼šæœ‰äº›å› ä¸ºè¶…æ—¶è€Œä¸»åŠ¨ç»“æŸåç»­æ‰§è¡Œæµç¨‹// çš„ goroutine æ”¶åˆ°å–æ¶ˆä¿¡å·func exampleWithTimeout(ctx context.Context) &#123; doRequest := func(ctx context.Context, id int) &#123; // æ¨¡æ‹Ÿè¯·æ±‚ time.Sleep(time.Duration(rand.Int63n(3)) * time.Second) select &#123; case &lt;-ctx.Done(): fmt.Printf("[%d]request canceled\n", id) default: // å¤„ç†å…¶å®ƒä¸šåŠ¡é€»è¾‘ &#125; &#125; ctx, cancel := context.WithTimeout(ctx, time.Second*1) defer cancel() var wg sync.WaitGroup for i := 0; i &lt; 10; i++ &#123; wg.Add(1) go func(id int) &#123; defer wg.Done() doRequest(ctx, id+1) &#125;(i) &#125; wg.Wait()&#125; æ€»ç»“ ä¸å»ºè®®å°† Context å­˜æ”¾åœ¨ç»“æ„ä½“ä¸­ï¼Œè€Œåº”è¯¥ä½œä¸ºå‚æ•°æ˜¾å¼ä¼ é€’ï¼›ä¸€èˆ¬æ¥æ”¶ Context ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œåº”è¯¥å°†è¯¥å‚æ•°æ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®ï¼ˆè¿™ä¸ªæ˜¯æƒ¯ä¾‹äº†ï¼‰ï¼› åœ¨ç»™å‡½æ•°ä¼ é€’ Context æ—¶ï¼Œå¦‚æœä¸çŸ¥é“ç”¨ä»€ä¹ˆ Contextï¼Œå°±å¯ä»¥ä½¿ç”¨ Context.TODO()ï¼Œé¿å…ä¼ é€’ nil Context Value éœ€è¦æœ‰çº¦æŸï¼Œå¿…é¡»åº”è¯¥ç¬¦åˆè¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå¹¶ä¸”ä¸€èˆ¬æ˜¯åœ¨æ¡†æ¶æˆ–è€… HTTP ä¸­é—´ä»¶ä¸­è®¾ç½® Valueï¼Œä¸šåŠ¡ä»£ç ä¸­å°½å¯èƒ½é¿å…ç›´æ¥æ“ä½œ Context Valueã€‚åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¸­åº”å½“æ˜¾å¼ä¼ å‚ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨é™æ€è¯­è¨€çš„ç‰¹æ€§ï¼Œä½¿å¾—ä¸€äº›é—®é¢˜å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½å‘ç°ï¼›ä¸è¦ä¸ºäº†å›¾æ–¹ä¾¿ï¼Œç”¨ Context å¸¦ä¸€äº›å¯é€‰å‚æ•°ã€‚ åœ¨ä½¿ç”¨ WithValue(key, value) æ—¶ï¼ŒKey åº”è¯¥é¿å…ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œé˜²æ­¢åå­—å†²çªå’Œæ±¡æŸ“ï¼› åœ¨ä½¿ç”¨ WithCancel, WithTimeout, WithDeadline æ—¶ï¼Œä¸€å®šè¦ä¿è¯è¿”å›çš„ cancel æ–¹æ³•è‡³å°‘è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œé¿å… goroutine æ³„éœ²æˆ–è€…å…¶å®ƒèµ„æºæ³„éœ²ï¼› ç”±äºç›®å‰åœ¨æ ‡å‡†åº“ä»¥åŠä¸€äº›ç¬¬ä¸‰æ–¹åº“ä¸­éƒ½åœ¨ä½¿ç”¨ Contextï¼Œä¸€è·¯ä¼ é€’ä¸‹æ¥ï¼Œæ•´ä½“é“¾è·¯å¾ˆé•¿ã€‚è€Œå½“å‘ç”Ÿ Context Cancel æ—¶ï¼Œæ’æŸ¥èµ·æ¥å°±éå¸¸éº»çƒ¦ã€‚æ‰€ä»¥éœ€è¦å¯¹æ‰€ä½¿ç”¨å„ç±»æ¡†æ¶æˆ–è€…åº“åœ¨æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„ç”Ÿå‘½å‘¨æœŸéœ€è¦æœ‰ä¸€å®šçš„äº†è§£ï¼Œå†é…åˆæ—¥å¿—ç­‰æ‰‹æ®µè¿›è¡Œæ’æŸ¥èµ·æ¥ä¼šæ›´åŠ æœ‰æ•ˆã€‚ å‚è€ƒ Goè¯­è¨€å®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰| Go Context Go Concurrency Patterns: Context How to correctly use context.Context in Go 1.7 Go 1.7 httptrace and context debug patterns Go: Context and Cancellation by Propagation How to correctly use context.Context in Go 1.7 æ·±å…¥ç†è§£ Golang HTTP Timeout Pitfalls of context values and how to avoid or mitigate them in Go]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>æ ‡å‡†åº“</tag>
        <tag>æºç å­¦ä¹ </tag>
        <tag>Context</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CSS å­¦ä¹ ç¬”è®°]]></title>
    <url>%2F2019%2F07%2F16%2Fcss-learning-notes%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä» 0 åˆ° 1 å®ç°ä¸€ä¸ªç½‘ç«™ï¼Œå‰ç«¯éƒ¨åˆ†è‡ªç„¶æ˜¯è¦äº†è§£ CSS çš„ã€‚CSS çš„å…¨ç§°æ˜¯ Cascading Style Sheetsï¼Œå®ƒæ˜¯ä¸€ç§ä¸“é—¨ç”¨äºç»™ç»“æ„åŒ–æ–‡æ¡£ï¼ˆå¦‚ Web HTMLï¼‰æ·»åŠ æ ·å¼çš„è¯­è¨€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ CSS æ¥ä¸ºç½‘é¡µå¸ƒå±€ï¼Œè®¾å®šå­—ä½“çš„æ ·å¼ï¼Œè®¾å®šåŠ¨ç”»ç­‰ï¼Œè®©æˆ‘ä»¬çš„ç½‘ç«™æ›´åŠ ç‚«é…·ï¼Œæ›´åŠ ç°ä»£åŒ–ã€‚è€Œè¿™äº›é€šè¿‡ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ä¼šéå¸¸ç¹çï¼Œä½¿ç”¨ CSS åªéœ€è¦æŒ‰éœ€å®šä¹‰å³å¯ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚æœ¬ç¯‡ç¬”è®°ä¸»è¦æ˜¯è®°å½•æ ¸å¿ƒçš„ CSS æŠ€å·§ï¼Œç›¸å…³çš„ç»ƒä¹ ä½äº GitHub learning-css ä»“åº“ã€‚ CSS åŸºç¡€ å¤šé‡æ ·å¼ä¼˜å…ˆçº§é¡ºåºï¼ˆä¾æ¬¡å¢åŠ ï¼‰ï¼š é€šç”¨é€‰æ‹©å™¨ï¼ˆ*ï¼‰ å…ƒç´ ï¼ˆç±»å‹ï¼‰é€‰æ‹©å™¨ ç±»é€‰æ‹©å™¨ å±æ€§é€‰æ‹©å™¨ ä¼ªç±» ID é€‰æ‹©å™¨ å†…è”æ ·å¼ !important è§„åˆ™åœ¨è¢«åº”ç”¨æ ·å¼å£°æ˜ä¸­æ—¶ï¼Œè¯¥æ ·å¼å£°æ˜ä¼šè¦†ç›– CSS ä¸­ä»»ä½•å…¶ä»–çš„å£°æ˜ï¼Œä½¿ç”¨å®ƒå¹¶éå¥½ä¹ æƒ¯ï¼š Alwaysï¼šè¦ä¼˜åŒ–è€ƒè™‘ä½¿ç”¨æ ·å¼è§„åˆ™çš„ä¼˜å…ˆçº§æ¥è§£å†³é—®é¢˜ï¼Œè€Œé !important Onlyï¼šåªæœ‰åœ¨éœ€è¦è¦†ç›–å…¨ç«™æˆ–å¤–éƒ¨ CSS çš„ç‰¹å®šé¡µé¢ä¸­ä½¿ç”¨å®ƒ Neverï¼šæ°¸è¿œä¸è¦åœ¨å…¨ç«™èŒƒå›´ä½¿ç”¨å®ƒ Neverï¼šæ°¸è¿œä¸è¦åœ¨ä½ çš„æ’ä»¶ä¸­ä½¿ç”¨å®ƒ CSS é“¾æ¥æ ·å¼ï¼š å››ç§ç‰¹æ®ŠçŠ¶æ€å¯ä»¥åˆ†åˆ«è®¾ç½®ï¼š a:link: æ­£å¸¸ï¼Œæœªè®¿é—®è¿‡çš„é“¾æ¥ a:visited: å·²è®¿é—®è¿‡çš„é“¾æ¥ a:hover: é¼ æ ‡æ”¾åœ¨é“¾æ¥ä¸Šæ—¶ a:active: é“¾æ¥è¢«ç‚¹å‡»çš„é‚£åˆ» ä¸Šè¿°é¡ºåºå¾ˆé‡è¦ï¼Œç®€è®°ï¼šL(ink)OV(isited)E and H(over)A(ctive)TE æ‰€æœ‰çš„ HTML å…ƒç´ éƒ½å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª Boxã€‚CSS ç›’æ¨¡å‹æœ¬è´¨ä¸Šå°±æ˜¯å°è£…äº† HTML å…ƒç´ çš„ç›’å­ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š å½“æŒ‡å®š CSS å…ƒç´ çš„é«˜åº¦å’Œå®½åº¦æ—¶ï¼Œåªæ˜¯åœ¨è®¾ç½®å†…å®¹åŒºåŸŸçš„é«˜åº¦å’Œé«˜åº¦ã€‚å®é™…å…ƒç´ å°ºå¯¸è®¡ç®—ï¼š æ€»å®½åº¦ = å†…å®¹å®½åº¦ + å·¦å¡«å…… + å³å¡«å…… + å·¦è¾¹æ¡† + å³è¾¹æ¡† + å·¦è¾¹è· + å³è¾¹è· æ€»é«˜åº¦ = å†…å®¹é«˜åº¦ + é¡¶éƒ¨å¡«å…… + åº•éƒ¨å¡«å…… + ä¸Šè¾¹æ¡† + ä¸‹è¾¹æ¡† + ä¸Šè¾¹è· + ä¸‹è¾¹è· ç›’æ ·å¼åº”ç”¨ï¼ˆé€‚ç”¨äº margin, padding ç­‰ç®€å†™æ ·å¼çš„æƒ…å†µï¼‰ï¼š å››ä¸ªå€¼ï¼ša, b, c, d -&gt; ä¸Šï¼Œä¸‹ï¼Œå·¦ï¼Œå³ï¼ˆé€†æ—¶é’ˆæ–¹å‘ï¼‰ ä¸‰ä¸ªå€¼ï¼ša, b, c -&gt; ä¸Šï¼Œå·¦å³ï¼Œä¸‹ ä¸¤ä¸ªå€¼ï¼ša, b -&gt; ä¸Šä¸‹ï¼Œå·¦å³ ä¸€ä¸ªå€¼ï¼ša -&gt; ä¸Šä¸‹å·¦å³ outline æ˜¯åœ¨ border å¤–éƒ¨çš„ï¼Œåœ¨å…ƒç´ å‘¨å›´ç»˜åˆ¶å‡ºå…ƒç´ çš„è¾¹ç¼˜ï¼Œèµ·åˆ°çªå‡ºå…ƒç´ çš„ä½œç”¨ã€‚ä½¿ç”¨æ–¹å¼ç±»ä¼¼ borderï¼Œå¯è®¾å®šçš„å±æ€§åŒ…æ‹¬ï¼šoutline-style, outline-color, outline-width ç­‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œoutline æ˜¯ä¸å ç©ºé—´çš„ï¼Œä¸ä¼šå¢åŠ é¢å¤–çš„å®½åº¦å’Œé«˜åº¦ã€‚outline ä¹Ÿå¯èƒ½æ˜¯éçŸ©å½¢çš„ï¼Œå’Œæµè§ˆå™¨å®ç°æœ‰å…³ã€‚ margin &amp; paddingï¼š éšè—å…ƒç´ ï¼š display:noneï¼šä¸ä¼šå æ®ç©ºé—´ï¼Œä¼šä»å¸ƒå±€ä¸­ç§»é™¤ visibility:hiddenï¼šä¼šå æ®ç©ºé—´ï¼Œå½±å“å¸ƒå±€ å—ï¼ˆ blockï¼‰å…ƒç´ ï¼š å æ®å…¨éƒ¨å®½åº¦ï¼Œå¹¶ä¸”ä¼šäº§ç”Ÿæ¢è¡Œ width, height, padding, margin éƒ½æ˜¯å¯æ§åˆ¶çš„ å—å…ƒç´ ï¼š&lt;address/&gt;, &lt;blockquote/&gt;, &lt;center/&gt;, &lt;dir/&gt;, &lt;div/&gt;, &lt;dl/&gt;, &lt;fieldset/&gt;, &lt;form/&gt;, &lt;h1/&gt;, &lt;h2/&gt;, &lt;h3/&gt;, &lt;h4/&gt;, &lt;h5/&gt;, &lt;h6/&gt;, &lt;hr/&gt;, &lt;isindex/&gt;, &lt;menu/&gt;, &lt;noframes/&gt;, &lt;noscript&gt;, &lt;ol/&gt;, &lt;p/&gt;, &lt;pre/&gt;, &lt;table/&gt;, &lt;ul/&gt;, &lt;li/&gt; å†…è”ï¼ˆinlineï¼‰å…ƒç´ ï¼š åªå æ®å¿…è¦çš„å®½åº¦ï¼Œä¸ä¼šæ¢è¡Œ width, height, padding-top, padding-bottom, margin-top, margin-bottom éƒ½ä¸å¯æ”¹å˜ å†…è”å…ƒç´ ï¼š&lt;a/&gt;, &lt;abbr/&gt;, &lt;acronym/&gt;, &lt;b/&gt;, &lt;bdo/&gt;, &lt;big/&gt;, &lt;br /&gt;, &lt;cite/&gt;, &lt;code/&gt;, &lt;dfn/&gt;, &lt;em/&gt;, &lt;font/&gt;, &lt;i/&gt;, &lt;img/&gt;, &lt;input/&gt;, &lt;kbd/&gt;, &lt;label/&gt;, &lt;q/&gt;, &lt;s/&gt;, &lt;samp/&gt;, &lt;select/&gt;, &lt;small/&gt;, &lt;span/&gt;, &lt;strike/&gt;, &lt;strong/&gt;, &lt;sub/&gt;, &lt;sup/&gt;, &lt;textarea/&gt;, &lt;tt/&gt;, &lt;u/&gt;, &lt;var/&gt; ä¸»è¦ä½¿ç”¨çš„ä¸‰ç§æ ·å¼ï¼š display:blockï¼šæ˜¾å¼ä¸ºå—å…ƒç´  display:inlineï¼šæ˜¾ç¤ºä¸ºå†…è”å…ƒç´  display:inline-blockï¼šæ˜¾ç¤ºä¸ºå†…è”å—å…ƒç´ ï¼Œè¡¨ç°ä¸ºåŒè¡Œæ˜¾ç¤ºï¼ŒåŒæ—¶å¯ä»¥ä¿®æ”¹ width/height/padding/margin ç­‰ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š CSS å®šä½ï¼ˆPositionï¼‰ï¼š staticï¼šå…ƒç´ é»˜è®¤å®šä½æ–¹å¼ï¼Œä¸å— top/bottom/left/right çš„å½±å“ relativeï¼šç›¸å¯¹æ­£å¸¸ä½ç½®çš„åç§»ï¼›åŸæœ¬ç©ºé—´ä¾ç„¶ä¼šè¢«é¢„ç•™å‡ºæ¥ï¼Œå¯èƒ½ä¼šä¸åˆ«çš„å…ƒç´ é‡å  fixedï¼šå…ƒç´ çš„ä½ç½®ç›¸å¯¹äºæµè§ˆå™¨çª—å£æ˜¯å›ºå®šçš„ï¼Œä¼šå’Œå…¶å®ƒå…ƒç´ é‡å ï¼›å…ƒç´ çš„ä½ç½®å’Œæ–‡æ¡£æµæ— å…³ï¼Œä¸å æ®ç©ºé—´ absoluteï¼šç»å¯¹å®šä½çš„å…ƒç´ çš„ä½ç½®æ˜¯ç›¸å¯¹äºæœ€è¿‘çš„å·²å®šä½çˆ¶å…ƒç´ ï¼Œè‹¥å…ƒç´ æ— å·²å®šä½çˆ¶å…ƒç´ ï¼Œåˆ™å®ƒçš„ä½ç½®æ˜¯ç›¸å¯¹äº ï¼›ä¸æ–‡æ¡£æµæ— å…³ï¼Œä¸å æ®ç©ºé—´ï¼Œä¼šä¸å…¶å®ƒå…ƒç´ é‡å  stickyï¼šç²˜æ€§å®šä½ï¼Œä¸æ»šåŠ¨æœ‰å…³ï¼Œå—é™äºæµè§ˆå™¨ å¯ä»¥ä½¿ç”¨ overflow æŒ‡å®šå½“å†…å®¹æº¢å‡ºæ—¶çš„è¡Œä¸ºï¼ˆå¯é€‰æ‹©æ˜¯å¦å±•ç¤ºæ»šåŠ¨æ¡ï¼‰ï¼Œä½†å…¶åªå¯ç”¨äºæŒ‡å®šäº†é«˜åº¦çš„å—å…ƒç´ ä¸Š å…ƒç´ çš„æµ®åŠ¨ï¼š ä¼šè®©å…ƒç´ å‘å·¦æˆ–å‘å³æµ®åŠ¨ï¼Œå‘¨å›´å…ƒç´ ä¹Ÿä¼šé‡æ–°æ’åˆ— å…ƒç´ æ°´å¹³æµ®åŠ¨ï¼Œæ„å‘³ç€åªèƒ½å·¦å³ç§»åŠ¨ æµ®åŠ¨å…ƒç´ ä¼šå°½é‡å‘å·¦æˆ–å‘å³ç§»åŠ¨ï¼Œç›´åˆ°å®ƒçš„å¤–è¾¹ç¼˜ç¢°åˆ°åŒ…æ‹¬æ¡†æˆ–å¦ä¸€ä¸ªæµ®åŠ¨æ¡†çš„è¾¹ç¼˜ä¸ºæ­¢ è®¾ç½®å±…ä¸­ï¼š å…ƒç´ å±…ä¸­ï¼šå¯ä»¥é€šè¿‡ margin: auto è§£å†³ï¼Œä½†æ˜¯å¿…é¡»è¦è®¾ç½®å…ƒç´ çš„å®½åº¦ æ–‡æœ¬å±…ä¸­ï¼šå¯ä½¿ç”¨ text-align ç»„åˆé€‰æ‹©å™¨ï¼š åä»£é€‰æ‹©å™¨ï¼šdiv p å­å…ƒç´ é€‰æ‹©å™¨ï¼šdiv&gt;p ç›¸é‚»å…„å¼Ÿé€‰æ‹©å™¨ï¼šdiv+p æ™®é€šå…„å¼Ÿé€‰æ‹©å™¨ï¼šdiv~p ä¼ªç±»ï¼ˆpseudo-classesï¼‰ï¼š ç”¨äºæ·»åŠ ä¸€äº›é€‰æ‹©å™¨çš„ç‰¹æ®Šæ•ˆæœ ä¼ªç±»é€‰æ‹©çš„å…ƒç´ æ˜¯åŸºäºå½“å‰å…ƒç´ æ‰€å¤„çš„çŠ¶æ€ï¼Œæˆ–è€…æ˜¯å…ƒç´ æ‰€å…·æœ‰çš„ç‰¹æ€§ï¼Œè€Œéé™æ€æ ‡å¿—ï¼ˆå¦‚ class, id, å±æ€§ï¼‰ã€‚è€ŒçŠ¶æ€æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå…ƒç´ åˆ°è¾¾ä¸€ä¸ªç‰¹å®šçŠ¶æ€çš„æ—¶å€™ï¼Œå¯èƒ½å¾—åˆ°ä¸€ä¸ªä¼ªç±»çš„æ ·å¼ï¼›å½“çŠ¶æ€æ”¹å˜æ—¶ï¼Œå®ƒä¼šå¤±å»è¿™ä¸ªæ ·å¼ã€‚åŸºäºæ–‡æ¡£ä¹‹å¤–çš„æŠ½è±¡ï¼Œæ•…ç§°ä¸ºä¼ªç±»ã€‚ è¯­æ³•ï¼š selector:psedudo-class { property: value } selector.class:pseudo-class { property: value } ä¼ªç±»åç§°ä¸åŒºåˆ†å¤§å°å†™ ç¤ºä¾‹ï¼ša:hover { color: red } ä¼ªå…ƒç´ ï¼ˆpseudo-elementï¼‰ï¼š ç”¨äºæ·»åŠ ä¸€äº›é€‰æ‹©å™¨çš„ç‰¹æ®Šæ•ˆæœ è¯­æ³•ï¼šç±»ä¼¼ä¼ªç±» ä¼ªå…ƒç´ æ˜¯å¯¹å…ƒç´ ä¸­ç‰¹å®šå†…å®¹é€‰æ‹©å¹¶æ“ä½œï¼Œæ“ä½œå±‚æ¬¡è¦æ¯”ä¼ªç±»æ›´æ·±ï¼ŒåŠ¨æ€æ€§æ¯”ä¼ªç±»ä½ã€‚è®¾è®¡ä¼ªå…ƒç´ çš„ç›®çš„å°±æ˜¯é€‰å–è¯¸å¦‚ç¬¬ä¸€ä¸ªå­—æ¯ï¼ˆè¡Œï¼‰ç­‰ï¼Œé€‰å–å†…å®¹çš„å‰åå¹¶æ“ä½œç­‰ï¼Œè¿™äº›æ™®é€šçš„é€‰æ‹©å™¨æ˜¯æ— æ³•å®Œæˆçš„ã€‚æœ¬èº«æ˜¯åŸºäºå…ƒç´ çš„æŠ½è±¡ï¼Œä¸å­˜åœ¨äºæ–‡æ¡£ä¸­ï¼Œæ•…ç§°ä¸ºä¼ªå…ƒç´ ã€‚ å±æ€§é€‰æ‹©å™¨ï¼š è¯­æ³•ï¼š&lt;element&gt;[attr] { } æˆ–è€… &lt;element&gt;[attr&lt;op&gt;value]{ } é€‰æ‹©èŒƒå›´ï¼š =: equal_word *=: ç›¸å½“äº containsï¼Œå¦‚ &lt;p title=&quot;buyfflowerrr&quot;&gt;&lt;/p&gt; ~=: ç›¸å½“äº contains_wordï¼Œå¦‚ &lt;p title=&quot;buy flower&quot;&gt;&lt;/p&gt; ä¸­çš„ flower |= : ç›¸å½“äº starts_with_wordï¼Œå½“ç„¶è¿™é‡Œçš„å•è¯åº”æ˜¯å”¯ä¸€çš„ï¼Œæˆ–è€…æ˜¯ç”¨ - åˆ†éš”çš„ ^=: ç›¸å½“äº starts_with $=: ç›¸å½“äº ends_with CSS 3 ç®€è®° CSS 3 è¢«æ‹†åˆ†æˆäº†ã€Œæ¨¡å—ã€ï¼Œä¸€äº›é‡è¦çš„æ¨¡å—å¦‚ä¸‹ï¼š é€‰æ‹©å™¨ ç›’æ¨¡å‹ èƒŒæ™¯å’Œè¾¹æ¡† æ–‡å­—ç‰¹æ•ˆ 2D/3D è½¬æ¢ åŠ¨æ€ å¤šåˆ—å¸ƒå±€ ç”¨æˆ·ç•Œé¢ æ¸å˜ï¼ˆGradientsï¼‰ï¼š çº¿æ€§æ¸å˜ï¼ˆLinear Gradientsï¼‰ï¼šå‘ä¸‹/å‘ä¸Š/å‘å·¦/å‘å³/å¯¹è§’çº¿ å¾„å‘æ¸å˜ï¼ˆRadius Gradientsï¼‰ï¼šç”±ç›¸åº”çš„ä¸­å¿ƒå®šä¹‰ è¯­æ³•ï¼šbackground: linear-gradient (direction, color-stop1, color-stop2, ...) box-shadow é¡ºåºï¼š 2D è½¬æ¢ï¼š translate, translateX, translateY rotate, rotateX, rotateY scale, scaleX, scaleY skew, skewX, scaleY matrixï¼š æ¥æ”¶å…­ä¸ªå‚æ•°ï¼ša, b, c, d, tx, ty å¯¹ç…§ï¼š ä½ç§»ï¼šmatrix(1, 0, 0, 1, tx, ty) = translate(tx + &quot;px&quot;, ty + &quot;px&quot;) ç¼©æ”¾ï¼šmatrix(sx, 0, 0, sy, 0, 0) = scale(sx, sy) æ—‹è½¬ï¼šmatrix(cosÎ¸, sinÎ¸, -sinÎ¸, cosÎ¸, 0, 0) = rotate(Î¸ + &quot;deg&quot;) å€¾æ–œï¼šmatrix(1, tan(Î¸y), tan(Î¸x), 1, 0, 0) = skew(Î¸x + &quot;deg&quot;, Î¸y + &quot;deg&quot;) è®¡ç®—æ–¹å¼ï¼š è¿‡æ¸¡æ•ˆæœï¼štransition: property duration timing-function delay å…¶ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œduration ä¸º 0ï¼Œæ‰€ä»¥å¦‚æœä¸è®¾ç½®è¯¥å€¼ï¼Œå°†çœ‹ä¸åˆ°æ•ˆæœ è¿‡æ¸¡åŠ¨ç”»æ—¶é—´æ›²çº¿ï¼š easeï¼šé»˜è®¤å€¼ linear ease-in ease-out ease-in-out cubic-bezier(n, n, n, n)ï¼šè´å¡å°”æ›²çº¿å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šå€¼æ¥å®ç°ä¸Šè¿°æ•ˆæœï¼ŒåŒæ—¶å¯ä»¥è‡ªå®šä¹‰å…¶å®ƒå€¼å®ç°è‡ªå®šä¹‰æ•ˆæœ å…³é”®å¸§åŠ¨ç”»ï¼š ä½¿ç”¨ @keyframes åˆ›å»ºåŠ¨ç”»ï¼Œå¯ä»¥ä½¿ç”¨ n% è®¾å®šå¤„äºä¸åŒé˜¶æ®µæ—¶çš„å±æ€§ï¼Œè€Œ from å’Œ to åˆ†åˆ«ä»£è¡¨ 0% å’Œ 100% ä½¿ç”¨ animation å±æ€§ç»‘å®šåŠ¨ç”»åˆ°é€‰æ‹©å™¨ä¸Šï¼Œéœ€è¦è®¾å®šä¸¤ä¸ªå€¼ï¼š åŠ¨ç”»åç§° åŠ¨ç”»æ—¶é•¿ Flex å¸ƒå±€ï¼š å½“é¡µé¢éœ€è¦é€‚åº”ä¸åŒçš„å±å¹•å¤§å°åŠè®¾å¤‡ç±»å‹æ—¶ï¼Œç¡®ä¿å…ƒç´ æ‹¥æœ‰æ°å½“çš„è¡Œä¸ºå¸ƒå±€æ–¹å¼ æä¾›ä¸€ç§æ›´åŠ æœ‰æ•ˆçš„æ–¹å¼å¯¹ä¸€ä¸ªå®¹å™¨ä¸­çš„å­å…ƒç´ è¿›è¡Œæ’åˆ—ã€å¯¹é½å’Œåˆ†é…ç©ºé—´ ç»„æˆï¼š Flex container Flex item å±æ€§è®¾ç½®ï¼šdisplay: flex/inline-flex è®¾ç½®ä¸»è½´å¯¹é½æ–¹å¼ï¼šjustify-content è®¾ç½®ä¾§è½´å¯¹é½æ–¹å¼ï¼šalign-items è®¾ç½®æ¢è¡Œï¼šflex-wrap è®¾ç½®å„ä¸ªè¡Œçš„å¯¹é½æ–¹å¼ï¼šalign-content å‚è€ƒ èœé¸Ÿæ•™ç¨‹ï¼šCSS block, inline-block å¯¹æ¯” Understanding the CSS Transforms Matrix CSS 2D è½¬æ¢è¯¦è§£ CSS 3 ä¸­ Flex å¼¹æ€§å¸ƒå±€è¯¥å¦‚ä½•çµæ´»è¿ç”¨ï¼Ÿ 30 åˆ†é’Ÿå­¦ä¼š Flex å¸ƒå±€ Flex å¸ƒå±€å¯¹æ€§èƒ½çš„å½±å“ä¸»è¦ä½“ç°åœ¨å“ªæ–¹é¢ï¼Ÿ]]></content>
      <categories>
        <category>å‰ç«¯</category>
      </categories>
      <tags>
        <tag>CSS</tag>
        <tag>å¸ƒå±€</tag>
        <tag>æ ·å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redux ç®€è®°]]></title>
    <url>%2F2019%2F07%2F03%2Freact-redux-notes%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æ ¹æ®å®˜ç½‘ä»‹ç»ï¼ŒRedux æ˜¯ä¸€ä¸ª JavaScript çŠ¶æ€ç®¡ç†å®¹å™¨ï¼Œæä¾›äº†å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚å¯ä»¥æ„å»ºä¸€è‡´çš„åº”ç”¨ï¼Œè¿è¡Œäºå¤šç§ç¯å¢ƒä¸‹ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å’ŒåŸç”Ÿåº”ç”¨ç­‰ï¼‰ï¼Œä¸”æ˜“äºæµ‹è¯•ï¼ˆç”šè‡³éƒ½ä¸è¦åœ¨å†™ç•Œé¢ä¹‹å‰è¿›è¡Œæµ‹è¯•ï¼‰ã€‚ æ¦‚å¿µæ ¸å¿ƒæ€æƒ³Redux çš„æ ¸å¿ƒå°±æ˜¯ç®¡ç†çŠ¶æ€ï¼Œæ‰€æœ‰çš„çŠ¶æ€æ˜¯åœ¨ store å¯¹è±¡æ ‘ä¸­ç»´æŠ¤ã€‚ä½¿ç”¨ action æ¥æè¿° state å˜åŒ–ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿå°† action å’Œ state ä¸²è”åœ¨ä¸€å—ï¼Œå°±æœ‰äº† reducer å‡½æ•°ï¼Œå®ƒè´Ÿè´£æ ¹æ®ä¸åŒçš„ action dispatch åˆ°ä¸åŒçš„åˆ†æ”¯ï¼Œç„¶åè¿”å›æ–°çš„çŠ¶æ€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œreducer æ˜¯çº¯å‡½æ•°ï¼Œä¸åº”è¯¥ inplace é‚£ç§æ–¹å¼ä¿®æ”¹ stateï¼Œè€Œæ˜¯ç”Ÿæˆæ–°çš„ nextState å¹¶è¿”å›ã€‚é€šå¸¸ä¸€ä¸ªåº”ç”¨ä¸­å¯èƒ½æœ‰å¤šä¸ªå°çš„ reducers ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ combineReducers å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚ ä¸‰å¤§åŸåˆ™ å•ä¸€æ•°æ®æºï¼šæ•´ä¸ªåº”ç”¨çš„ state æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ª obj tree ä¸­çš„ï¼Œå¹¶ä¸”è¯¥ obj tree åªå­˜åœ¨äºå”¯ä¸€ä¸€ä¸ª store ä¸­ state æ˜¯åªè¯»çš„ï¼šå”¯æœ‰è§¦å‘ action æ‰ä¼šæ”¹å˜ stateï¼Œä½¿ç”¨ action æ¥æè¿°å‘ç”Ÿäº†ä»€ä¹ˆ ä½¿ç”¨çº¯å‡½æ•°æ‰§è¡Œä¿®æ”¹ï¼šéœ€è¦ç¼–å†™ reducer å®ç°çŠ¶æ€æ”¹å˜ ä¸‰é©¾é©¬è½¦Action Action æ˜¯æŠŠæ•°æ®ä»åº”ç”¨ä¼ é€’åˆ° store çš„æœ‰æ•ˆè½½è·ï¼Œæ˜¯ store æ•°æ®çš„å”¯ä¸€æ¥æº ä¸€èˆ¬é€šè¿‡ store.dispatch() åˆ†å‘ actionï¼Œä¼ é€’åˆ° store å½“åº”ç”¨è§„æ¨¡å˜å¤§æ—¶ï¼Œå»ºè®®å°† Action ä½¿ç”¨å•ç‹¬çš„æ¨¡å—å­˜æ”¾ å°½é‡å‡å°‘åœ¨ action ä¸­ä¼ é€’çš„æ•°æ® Action åˆ›å»ºå‡½æ•°ï¼šè¿”å› action çš„å‡½æ•°ï¼Œä½¿ç”¨ bindActionCreators() å¯ä»¥è‡ªåŠ¨å°†å¤šä¸ª action åˆ›å»ºå‡½æ•°ç»‘å®šåˆ° dispatch() æ–¹æ³•ä¸Š Action åªæ˜¯æè¿°äº†æœ‰äº‹æƒ…å‘ç”Ÿäº†è¿™æ ·çš„äº‹å®ï¼Œä½†ä¸ä¼šæè¿°åº”ç”¨å¦‚ä½•æ›´æ–° state Reducer åœ¨ reducer ä¸­å“åº” actionï¼Œå¹¶äº§ç”Ÿæ–°çš„ stateï¼Œè¾¾åˆ°æ”¹å˜ state çš„ç›®çš„ ä¸ºä»€ä¹ˆå« reducerï¼Ÿå‚è€ƒ Array.prototype.reduce(reducer, ?initialValue) é‡Œé¢çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½å¿…é¡»æ˜¯çº¯å‡½æ•°ã€‚reducer å‡½æ•°ä¸æ¬¢è¿å¦‚ä¸‹æ“ä½œï¼š ä¿®æ”¹ä¼ å…¥å‚æ•° æ‰§è¡Œå«æœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼Œå¦‚ API è¯·æ±‚å’Œè·¯ç”±è·³è½¬ è°ƒç”¨éçº¯å‡½æ•°ï¼Œå¦‚ Date.now() æˆ– Math.random() å¯ä»¥æŠŠæ‰€æœ‰é¡¶çº§ reducer æ”¾åœ¨ç‹¬ç«‹çš„æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ export æš´éœ²æ¯ä¸ª reducer å‡½æ•°ï¼š 1234import &#123; combineReducers &#125; from 'redux'import * as reducers from './reducers'const todoApp = combineReducers(recuders) Store Store çš„èŒè´£å¦‚ä¸‹ï¼š ç»´æŒåº”ç”¨çš„ state æä¾› getState() è¯»å–çŠ¶æ€ æä¾› dispatch(action) æ–¹æ³•æ›´æ–°çŠ¶æ€-æä¾› subscribe(listener) æ–¹æ³•æ³¨å†Œç›‘è§†å™¨ï¼Œå…¶è¿”å›çš„å‡½æ•°ç”¨äºæ³¨é”€ç›‘è§†å™¨ Redux åº”ç”¨çš„ store åªä¼šæœ‰ä¸€ä¸ªï¼Œä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥æ‹†åˆ†å­çŠ¶æ€åˆ†ç»„ï¼Œå¯ä»¥é€šè¿‡ reducers ç»„åˆå®Œæˆ createStore(reducer, ?initialState) åˆ›å»ºåº”ç”¨ store ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107import React, &#123; useRef &#125; from 'react'import ReactDOM from 'react-dom'import &#123; createStore, combineReducers &#125; from 'redux'function todos(state = [], action) &#123; switch (action.type) &#123; case 'ADD_TODO': console.log('Add todo: ' + action) return [ ...state, todo(undefined, action) ] case 'REMOVE_TODO': console.log('Remove todo: ' + action) return state.map((item) =&gt; todo(item, action)) case 'TOGGLE_TODO': console.log('Toggle todo: ' + action) return state.map((item) =&gt; todo(item, action)) default: return state &#125;&#125;function todo(state, action) &#123; switch (action.type) &#123; case 'ADD_TODO': return &#123; id: action.id, text: action.text, completed: action.completed, isDeleted: false, &#125; case 'REMOVE_TODO': if (state.id !== action.id) &#123; return state &#125; return &#123; ...state, isDeleted: true &#125; case 'TOGGLE_TODO': if (state.id !== action.id) &#123; return state &#125; return &#123; ...state, completed: !state.completed &#125; default: return state &#125;&#125;const todoApp = combineReducers(&#123; todos&#125;)const store = createStore(todoApp)let nextTodoId = 0function TodoItem(&#123; todo &#125;) &#123; return ( &lt;li&gt; &lt;label style=&#123;&#123; textDecoration: todo.completed ? 'line-through' : 'none' &#125;&#125; onClick=&#123;() =&gt; store.dispatch(&#123; type: 'TOGGLE_TODO', id: todo.id &#125;)&#125; &gt; &#123;todo.text&#125; &lt;/label&gt; &lt;button style=&#123;&#123; marginLeft: 10 &#125;&#125; onClick=&#123;() =&gt; &#123; store.dispatch(&#123; type: 'REMOVE_TODO', id: todo.id &#125;) &#125;&#125; &gt;ç§»é™¤&lt;/button&gt; &lt;/li&gt; )&#125;function TodoApp(&#123; todos = [] &#125;) &#123; const todoItems = todos .filter((todo) =&gt; !todo.isDeleted) .map((todo) =&gt; &lt;TodoItem key=&#123;todo.id&#125; todo=&#123;todo&#125; /&gt;) const input = useRef() const handleClick = () =&gt; &#123; const text = input.current.value if (!text) &#123; return &#125; store.dispatch(&#123; type: 'ADD_TODO', id: nextTodoId++, text: input.current.value &#125;) &#125; return ( &lt;div&gt; &lt;input ref=&#123;input&#125; /&gt; &lt;button onClick=&#123;handleClick&#125; style=&#123;&#123; marginLeft: 10 &#125;&#125;&gt;æ·»åŠ &lt;/button&gt; &lt;ul&gt; &#123;todoItems&#125; &lt;/ul&gt; &lt;/div&gt; )&#125;const render = () =&gt; &#123; const state = store.getState() ReactDOM.render( &lt;TodoApp todos=&#123;state.todos&#125; /&gt;, document.getElementById('root') )&#125;store.subscribe(() =&gt; &#123; console.log(store.getState()) render()&#125;)render() å®è·µæŒ‰ç…§ Redux æä¾›çš„å‡ ä¸ªå®˜æ–¹ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹å‡ºç¼–å†™ä¸€ä¸ªç®€å•çš„ Todo åº”ç”¨å…¶å®è¦è€ƒè™‘çš„è¿˜æ˜¯æŒºå¤šçš„ï¼Œå°¤å…¶æ˜¯éœ€è¦åœ¨åˆ†æ•£çš„æ¨¡å—ä¸­åˆ†åˆ«å®šä¹‰ actions, reducers, containers, dumb components ç­‰ï¼Œç„¶åæ­é… react-redux æ¥å®ç°æ•´ä½“åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»å…¸çš„ React Redux åº”ç”¨çš„ç¤ºä¾‹çš„æ–‡ä»¶ç»“æ„ï¼š 12345678src/ actions/ components/ consts/ containers/ reducers/ sotore.js index.js çœ‹èµ·æ¥ï¼Œåˆ†å±‚ç»“æ„å¾ˆæ˜æ™°ã€‚ä½†è¿™é‡Œæœ‰å‡ ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼š components å’Œ containers å¯èƒ½ä¼šå‡ºç°ç›¸äº’å¼•ç”¨çš„é—®é¢˜ï¼› å¯¹äºæŸäº›æƒ…å½¢ï¼Œä¸¥æ ¼åŒºåˆ† smart components å’Œ dumb components æ¯”è¾ƒæ­»æ¿ï¼› ç¼–å†™èµ·æ¥å¾ˆå¤æ‚ã€å•°å—¦ã€å†—ä½™ã€‚ é’ˆå¯¹è¿™ä¸ªç—›ç‚¹ï¼Œå¯ä»¥å€ŸåŠ© rematch æ¡†æ¶è§£å†³ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäº Redux å°è£…çš„æ¡†æ¶ï¼Œç›®çš„æ˜¯æä¾›æœ€ä½³çš„ Redux å®è·µï¼Œå‡å°‘å¤§é‡çš„æ ·æ¿ä»£ç ç¼–å†™ï¼Œè§£æ”¾ç”Ÿäº§åŠ›ï¼ ä½¿ç”¨ Rematch æ—¶ï¼Œæœ‰ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µå«åš modelã€‚ä½ å¯ä»¥åœ¨ models é‡Œé¢å°†çŠ¶æ€ã€å¼•èµ·çŠ¶æ€å˜åŒ–reducers åŠå¼‚æ­¥ actions å’Œ action creators æ”¶æ•›åˆ°ä¸€èµ·ï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œæµ‹è¯•ã€‚æ€»çš„æ¥è¯´ï¼Œmodel å®šä¹‰åŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š state: åˆå§‹çŠ¶æ€æ˜¯ä»€ä¹ˆ reducers: å¦‚ä½•æ”¹å˜çŠ¶æ€ effects: å¤„ç†å¼‚æ­¥çš„ actionsï¼Œå¸¦æœ‰å‰¯ä½œç”¨çš„æ“ä½œ ä¸€ä¸ªå…¸å‹çš„ model å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516export const count = &#123; state: 0, // initial state reducers: &#123; // ä½¿ç”¨åŒæ­¥å‡½æ•°ï¼Œå¤„ç†çŠ¶æ€å˜æ›´ increment(state, payload) &#123; return state + payload &#125; &#125;, effects: (dispatch) =&gt; (&#123; // ä½¿ç”¨çº¯å‡½æ•°å¤„ç†çŠ¶æ€å˜æ›´ï¼ˆå¼‚æ­¥ actionsï¼‰ async incrementAsync(payload, rootState) &#123; await new Promise(resolve =&gt; setTimeout(resolve, 1000)) dispatch.count.increment(payload) &#125; &#125;)&#125; æœ‰äº† models åï¼Œå°±å¯ä»¥åˆ›å»º Redux storeï¼Œå¹¶ä½¿ç”¨ dispatch æ¥è§¦å‘ reducers å’Œ effects è°ƒç”¨ï¼ˆæ— éœ€æ‰‹åŠ¨ç¼–å†™ action creators å•¦~ï¼‰ã€‚å½“ç„¶ï¼Œåœ¨å±•ç¤ºå±‚ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ç»“åˆ react-redux æ¥ä½¿ç”¨ã€‚å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹ï¼Œæ›´è¯¦ç»†çš„æ–‡æ¡£å¯ä»¥å‚è€ƒ è¿™é‡Œã€‚ å‚è€ƒ Redux å®˜ç½‘æ–‡æ¡£ Redux ä¸­æ–‡è¯‘æ–‡ Redux å…¥é—¨è§†é¢‘æ•™ç¨‹ ä»¥åœ°é“çš„æ–¹å¼ä½¿ç”¨ Redux æ„å»º React åº”ç”¨ Redux and Why itâ€™s Good For You What Does Redux Do Presentational and Container Componentsï¼Œä½œè€…å…¶å®å·²ç»ä¸æ¨èè¿™ç§å†™æ³•äº† React Redux å®˜æ–¹æ–‡æ¡£ å»¶ä¼¸é˜…è¯» All About React Router 4 Learning React Redux Leveling Up With React: Container Components]]></content>
      <categories>
        <category>å‰ç«¯</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
        <tag>JavaScript</tag>
        <tag>React</tag>
        <tag>Redux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[React æ ¸å¿ƒæ¦‚å¿µ]]></title>
    <url>%2F2019%2F07%2F02%2Freact-core-concepts%2F</url>
    <content type="text"><![CDATA[å¼•è¨€React æ˜¯ä¸€ä¸ªç”¨äºæ„å»º UI çš„ JavaScript åº“ï¼Œå®ƒæœ‰å£°æ˜å¼ã€ç»„ä»¶åŒ–çš„ç‰¹ç‚¹ã€‚ä½¿ç”¨ JSX çš„è¯­æ³•å¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™å„ç§ç»„ä»¶ï¼Œè€ŒåŸºäºå„ç§ç»„ä»¶åˆå¯ä»¥æ„é€ å‡ºæ›´åŠ å¤æ‚çš„å‰ç«¯é¡µé¢ã€‚ åŸºç¡€ç¯‡JSX JSX å¯ä»¥å¾ˆå¥½åœ°æè¿° UIï¼šconst element = &lt;h1&gt;Hello, world&lt;/h1&gt; React ä¸­è®¤ä¸ºæ¸²æŸ“é€»è¾‘æœ¬è´¨ä¸Šå’Œ UI é€»è¾‘å¤©ç„¶è€¦åˆï¼Œå¹¶æ²¡æœ‰è®¤ä¸ºåœ°å°†æ ‡è®°ä¸é€»è¾‘åˆ†ç±»åˆ°ä¸åŒæ–‡ä»¶ï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾åœ¨ç»„ä»¶è¿™ç§æ¾æ•£è€¦åˆå•å…ƒä¸­ï¼Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦» JSX æœ¬èº«ä¹Ÿæ˜¯è¡¨è¾¾å¼ï¼Œå¯ä»¥åœ¨ {} ä¸­ä½¿ç”¨ä»»æ„ JavaScript çš„åŠŸèƒ½ã€‚åœ¨è¿›è¡Œç¼–è¯‘åï¼ŒJSX ä¼šè¢«è½¬æ¢æˆæ™®é€šçš„ JavaScript å‡½æ•°è°ƒç”¨ï¼Œå¹¶å¯¹å…¶å–å€¼åå¾—åˆ° JavaScript å¯¹è±¡ JSX å¯ä»¥é˜²æ­¢æ³¨å…¥æ”»å‡»ï¼ŒReactDOM åœ¨æ¸²æŸ“æ‰€æœ‰è¾“å…¥å†…å®¹å‰ï¼Œé»˜è®¤ä¼šè¿›è¡Œè½¬ä¹‰ å…ƒç´ æ¸²æŸ“ ä¸çœŸå®çš„æµè§ˆå™¨ DOM å…ƒç´ ç›¸æ¯”ï¼ŒReact å…ƒç´ æ˜¯éå¸¸è½»é‡çº§ä¸”åˆ›å»ºå¼€é”€å¾ˆå°çš„æ™®é€šå¯¹è±¡ï¼ŒReactDOM è´Ÿè´£æ›´æ–° DOM ä¿æŒä¸ React å…ƒç´ ä¸€è‡´ æ¸²æŸ“å…ƒç´ ï¼šReactDOM.render(element, container) ReactDOM ä¼šå°†å…ƒç´ åŠå…¶å­å…ƒç´ ä¸ä¹‹å‰çš„çŠ¶æ€å¯¹æ¯”ï¼Œåªè¿›è¡Œå¿…è¦çš„æ›´æ–°ä¿è¯ DOM è¾¾åˆ°é¢„æœŸçŠ¶æ€ ç»„ä»¶ ç»„ä»¶çš„å®šä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼š 1234567891011// å‡½æ•°ç»„ä»¶function Welcome(props) &#123; reuturn &lt;h1&gt;Welcome&lt;/h1&gt;&#125;// åŸºäº ES6 class å®šä¹‰çš„ç»„ä»¶class Welcome2 extends Component &#123; render() &#123; return &lt;h1&gt;Welcome&lt;/h1&gt; &#125;&#125; æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„å±æ€§ï¼ˆpropsï¼‰å’ŒçŠ¶æ€ï¼ˆstateï¼‰ ç»„ä»¶çš„ props æ˜¯åªè¯»çš„ã€‚React ç»„ä»¶å¿…é¡»è¦åƒçº¯å‡½æ•°ä¸€æ ·ä¿æŠ¤å®ƒä»¬çš„ props ä¸è¢«ä¿®æ”¹ çŠ¶æ€ state ç»„ä»¶çš„ state æ˜¯ç»„ä»¶ç§æœ‰çš„ï¼Œä¸”å®Œå…¨å—æ§äºå½“å‰ç»„ä»¶ é™¤äº†åœ¨æ„é€ å‡½æ•°ä¸­å¯ä»¥ç›´æ¥ç»™ this.state èµ‹å€¼å¤–ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹ stateï¼Œå¦åˆ™ä¸ä¼šæ¸²æŸ“ç»„ä»¶ï¼Œè¦ä½¿ç”¨ setState() æ›´æ–°çŠ¶æ€ this.props å’Œ this.state å¯èƒ½æ˜¯å¼‚æ­¥æ›´æ–°ï¼Œä¸è¦ä¾èµ–å®ƒä»¬çš„å€¼è¿›è¡Œä¸‹ä¸€ä¸ªçŠ¶æ€æ›´æ–°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š 123456789// é”™è¯¯çš„åšæ³•ï¼Œè¿™ç§å¯èƒ½æ— æ³•å¾—åˆ°é¢„æœŸç»“æœthis.setState(&#123; counter: this.state.counter + this.props.incr&#125;// æ­£ç¡®çš„åšæ³•ï¼Œä½¿ç”¨ä¸€ä¸ªç®­å¤´å‡½æ•°this.setState((state, props) =&gt; &#123; counter: state.counter + props.incr&#125;)) ä¸ç®¡æ˜¯çˆ¶ç»„ä»¶è¿˜æ˜¯å­ç»„ä»¶éƒ½æ— æ³•çŸ¥é“æŸä¸ªç»„ä»¶æœ‰æ— çŠ¶æ€ï¼Œä¸”ä¹Ÿä¸ä¼šå…³å¿ƒæ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ class ç»„ä»¶ã€‚æ•°æ®æµåŠ¨æ˜¯å•å‘å‘ä¸‹çš„ï¼Œä»æŸä¸ªç»„ä»¶ state äº§ç”Ÿçš„ä»»ä½•æ•°æ®æˆ– UI åªä¼šå½±å“æ ‘ä¸­ä½äºå®ƒä»¬çš„ç»„ä»¶ äº‹ä»¶å¤„ç† React äº‹ä»¶å‘½åæ˜¯ camelCase é£æ ¼ï¼Œè€Œéåƒ HTML DOM ä¸­çº¯å°å†™çš„é£æ ¼ å¦‚æœæƒ³è¦é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Œå¿…é¡»æ˜¾å¼ä½¿ç”¨ e.preventDefault()ï¼›è¿™é‡Œçš„ e æ˜¯ React æ ¹æ® W3C è§„èŒƒå®šä¹‰çš„åˆæˆäº‹ä»¶ï¼Œæ— éœ€æ‹…å¿ƒè·¨æµè§ˆå™¨å…¼å®¹é—®é¢˜ React ä¸­è‡ªå®šä¹‰çš„æ–¹æ³•é»˜è®¤ä¸ä¼šç»‘å®š thisï¼Œæ‰€ä»¥æœ‰å¤šç§æ–¹å¼å¯ä»¥è¿›è¡Œç»‘å®šï¼š å¸¸è§„ï¼šåœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ this.handleChange = this.handleChange.bind(this) æ¨èï¼šä½¿ç”¨ public class fields è¯­æ³•ï¼šhandleChange = () =&gt; {} åœ¨è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ç®­å¤´å‡½æ•°æˆ–è€… bind ç»‘å®šï¼ˆæ³¨æ„ï¼Œè¿™ç§å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œæ¯æ¬¡éƒ½ä¼šåˆ›å»ºå‡½æ•°ï¼Œå¦‚æœæ˜¯ä¼ é€’ç»™å­ç»„ä»¶çš„ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´å­ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼‰ åˆ—è¡¨ &amp; Key åœ¨åˆ—è¡¨å…ƒç´ æˆ–è€…ç»„ä»¶ä¸­ï¼Œå¿…é¡»è¦æŒ‡å®š Keyã€‚è€Œå¦‚æœæ²¡æœ‰è®¾å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨ç´¢å¼•ã€‚ä½†æ˜¯ä½¿ç”¨ç´¢å¼•å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜å’ŒçŠ¶æ€é—®é¢˜ Key å¹¶ä¸éœ€è¦å…¨å±€å”¯ä¸€ï¼Œåªæ˜¯åœ¨ç›¸é‚»èŠ‚ç‚¹ä¹‹é—´éœ€è¦ä¿æŒå”¯ä¸€å³å¯ Key ä¼šè¢«ä¼ é€’ç»™ Reactï¼Œä½†ä¸ä¼šä¼ é€’ç»™ç»„ä»¶ è¡¨å• å—æ§ç»„ä»¶ï¼šæŠŠ HTML è¡¨å•å…ƒç´ å’Œ React state ç»“åˆèµ·æ¥ï¼Œè®©æ¸²æŸ“è¡¨å•çš„ React ç»„ä»¶è¿˜æ§åˆ¶ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­è¡¨å•å‘ç”Ÿçš„äº‹æƒ… åœ¨å—æ§ç»„ä»¶ä¸ŠæŒ‡å®š value çš„ prop å¯ä»¥é˜²æ­¢ç”¨æˆ·æ›´æ”¹è¾“å…¥ å…¶å®ƒ é€šå¸¸ï¼Œå¦‚æœå¤šä¸ªç»„ä»¶åæ˜ ç›¸åŒçš„æ•°æ®å˜æ›´ï¼Œå¯ä»¥å°†çŠ¶æ€æå‡åˆ°æœ€è¿‘çš„å…¬å…±çˆ¶ç»„ä»¶ ç»„åˆä¼˜äºç»§æ‰¿ æœ‰äº›ç»„ä»¶æ— æ³•æå‰çŸ¥æ™“å®ƒä»¬å­ç»„ä»¶çš„å…·ä½“å†…å®¹ï¼Œå¯ä»¥é€šè¿‡ props.children è·å–å­ç»„ä»¶æ¸²æŸ“ é«˜çº§ç¯‡Contextï¼ˆæ­¤ Context æœ‰ç‚¹ç‰¹æ®Šï¼‰ è™½ç„¶å¯ä»¥é€šè¿‡ props å°†å±æ€§ä»çˆ¶ç»„ä»¶ä¸€çº§çº§ä¼ é€’åˆ°å­ç»„ä»¶æ ‘ï¼Œä½†è¿™æ ·æ¯•ç«Ÿæ¯”è¾ƒç¹çã€‚è€Œæœ‰äº›æ¯”è¾ƒå…¨å±€çš„é…ç½®ï¼ˆå¦‚ä¸»é¢˜ã€åœ°åŒºç­‰ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡ Context è¿›è¡Œå…±äº«ï¼Œæ–¹ä¾¿ç»„ä»¶æ ‘è®¿é—®è¿™äº›å…¨å±€é…ç½® åˆ›å»º contextï¼šconst ThemeContext = React.createContext(â€˜lightâ€™)` ç¤ºä¾‹å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526import React from 'react';const ThemeContext = React.createContext('light')class Button extends React.Component &#123; // æŒ‡å®šè¦è¯»å–çš„ Context ç±»å‹ // React ä¼šè‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘çš„ theme provider // ç„¶åä½¿ç”¨å®ƒçš„å€¼ static contextType = ThemeContext render() &#123; return ( // ä½¿ç”¨ `this.context` å¯ä»¥è·å–å€¼ &lt;button className="Button"&gt;&#123;this.props.text&#125; + &#123;this.context&#125;&lt;/button&gt; ) &#125;&#125;function ToolBar(props) &#123; return &lt;Button text=&#123;props.text&#125;&gt;&lt;/Button&gt;&#125;function App() &#123; return ( // ä½¿ç”¨ Provider æŒ‡å®š ctx value &lt;ThemeContext.Provider value="yellow"&gt; &lt;ToolBar text="å·¥å…·æŒ‰é’®"&gt;&lt;/ToolBar&gt; &lt;/ThemeContext.Provider&gt; );&#125;export default App; Context ä½¿ç”¨ä¼šå¯¼è‡´ç»„ä»¶çš„å¤ç”¨æ€§å˜å·®ï¼Œä¼šä¾èµ– Contextã€‚å¦‚æœåªæ˜¯æƒ³è¦é¿å…å±‚å±‚ä¼ é€’å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ç»„ä»¶ç»„åˆçš„æ–¹å¼ API createContext: const myCtx = React.createContext(defaultValue) å¯¹äºè®¢é˜…äº†ä¸Šè¿° ctx çš„å­ç»„ä»¶ï¼Œä¼šè‡ªåŠ¨åœ¨ç¦»è‡ªå·±æœ€è¿‘çš„åŒ¹é… Provider å¤„è·å–è®¾ç½®çš„å€¼ å¦‚æœæœªèƒ½æ‰¾åˆ° Providerï¼Œåˆ™ä½¿ç”¨ defaultValue Provider å…è®¸æ¶ˆè´¹ç»„ä»¶è®¢é˜… context çš„å˜åŒ– å¯ä»¥ä¼ é€’ value ç»™æ¶ˆè´¹ç»„ä»¶ï¼Œå¯ä»¥åµŒå¥— Provider value å˜åŒ–æ—¶ï¼Œå†…éƒ¨æ¶ˆè´¹ç»„ä»¶ä¹Ÿä¼šé‡æ–°æ¸²æŸ“ Provider åŠæ¶ˆè´¹ç»„ä»¶ä¸å— shouldComponentUpdate å‡½æ•°é™åˆ¶ contextType æŒ‚è½½åœ¨ class å¯¹è±¡ä¸Šï¼ŒæŒ‡å‘åˆ›å»ºçš„ Context å¯¹è±¡ å¯ä»¥åœ¨ä»»æ„ç”Ÿå‘½å‘¨æœŸé€šè¿‡ this.context è®¿é—®åˆ°æœ€è¿‘ Context çš„å€¼ Consumerï¼šè®¢é˜… context å˜æ›´ 123&lt;MyContext.Consumer&gt; &#123;value =&gt; /* do stuff */&#125;&lt;/MyContext.Consumer&gt; Context ä½¿ç”¨äº† reference identity æ¥å†³å®šä½•æ—¶è¿›è¡Œæ¸²æŸ“ï¼Œä½†ä¹Ÿå­˜åœ¨é™·é˜±ã€‚å½“ Provider çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ¶ˆè´¹ç»„ä»¶æ„å¤–è¢«æ¸²æŸ“ Fragment å¸¸è§æ¨¡å¼æ˜¯ä¸€ä¸ªç»„ä»¶è¦è¿”å›å¤šä¸ªå…ƒç´ ï¼Œä½¿ç”¨ Fragment å¯ä»¥å°†å­åˆ—è¡¨åˆ†ç»„ï¼Œä¸”æ— éœ€å‘ DOM æ·»åŠ é¢å¤–èŠ‚ç‚¹123456789101112131415161718192021222324252627function Column(props) &#123; return ( &lt;&gt; &lt;td&gt;hello 1&lt;/td&gt; &lt;td&gt;hello 2&lt;/td&gt; &lt;td&gt;hello 3&lt;/td&gt; &lt;/&gt; )&#125;function Row(props) &#123; return ( &lt;&gt; &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt; &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt; &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt; &lt;/&gt; )&#125;function Table(props) &#123; return ( &lt;table&gt; &lt;Row&gt;&lt;/Row&gt; &lt;/table&gt; )&#125; é«˜é˜¶ç»„ä»¶ï¼ˆHigh Order Component, HOCï¼‰ HOC æ˜¯ React ä¸­åŸºäºç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ï¼Œæ˜¯ä¸€ç§å¤ç”¨ç»„ä»¶é€»è¾‘çš„æŠ€å·§ HOC çš„å‚æ•°æ˜¯ç»„ä»¶ï¼Œè¿”å›å€¼æ˜¯æ–°ç»„ä»¶çš„å‡½æ•°ï¼šconst NewComponent = hoc(WrappedComponent) é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ›¿ä»£ Mixin æ¨¡å¼ï¼›çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ çº¦å®šï¼šHOC åº”è¯¥é€ä¼ ä¸è‡ªèº«æ— å…³çš„ propsï¼Œä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„æ–¹å¼ç¼–å†™ renderï¼š 123456789101112function logProps(WrappedComponent) &#123; return class extends React.Component &#123; render() &#123; const &#123;level, ...props&#125; = this.props console.log(level) console.log(props) return ( &lt;WrappedComponent level=&#123;level&#125; &#123;...props&#125;&gt;&lt;/WrappedComponent&gt; ) &#125; &#125;&#125; çº¦å®šï¼šæœ€å¤§åŒ–å¯ç»„åˆæ€§ 1234567// compose è¾¾åˆ°çš„æ•ˆæœå°±æ˜¯ï¼šwithRouter(connect(componentSelector)(WrappedComponent)))const enhance = compose( // å•çº¯çš„ HOC withRouter, connect(componentSelector))const EnhancedComponent = enhance(WrappedComponent) çº¦å®šï¼šè¿”å›æ¸…æ™°çš„åç§°ï¼Œä¾¿äºè°ƒè¯•ã€‚å‘½åä¹ æƒ¯ï¼šHOCName(wrappedComponentName) 123456789101112131415function logProps(WrappedComponent) &#123; class WithLogComponent extends React.Component &#123; render() &#123; return ( &lt;WrappedComponent &#123;...props&#125;&gt;&lt;/WrappedComponent&gt; ) &#125; &#125; WithLogComponent.displayName = `WithLogComponent($&#123;getDisplayName(WrappedComponent)&#125;)` return WithLogComponent&#125;function getDisplayName(c) &#123; return c.displayName || c.name || 'Component'&#125; æ³¨æ„ï¼š ä¸è¦åœ¨ render() ä¸­ä½¿ç”¨ HOCï¼Œé¿å… React æ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼ˆä¸æ˜¯æ›´æ–°å­æ ‘ï¼Œè€Œæ˜¯å¸è½½æ—§å­æ ‘ï¼ŒæŒ‚è½½æ–°å­æ ‘ï¼Œä¸”å¯¼è‡´ç»„ä»¶çŠ¶æ€ä¹Ÿä¼šä¸¢å¤±ï¼‰ã€‚å¦‚æœçš„ç¡®éœ€è¦åŠ¨æ€è°ƒç”¨ HOCï¼Œå¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æˆ–æ„é€ å‡½æ•°ä¸­è¿›è¡Œ é™æ€æ–¹æ³•éœ€è¦æ˜¾å¼æ‹·è´ï¼Œå¯ä»¥ä½¿ç”¨ hoistNonReactStatic å‡½æ•°æ‹·è´æ‰€æœ‰é React é™æ€æ–¹æ³• Ref ä¸ä¼šè¢«ä¼ é€’ PropTypes å¯¹ç»„ä»¶ props ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œé…ç½® propTypes å±æ€§å³å¯ è€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ç”Ÿæ•ˆ å¯ä»¥é…ç½® defaultProps è®¾å®šé»˜è®¤å€¼ ç”Ÿå‘½å‘¨æœŸå›¾è°± åˆæˆäº‹ä»¶ï¼ˆSynthetic Eventï¼‰ SyntheticEvent å®ä¾‹æ˜¯ä¼ é€’ç»™äº‹ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ï¼Œå®ƒæ˜¯å¯¹æµè§ˆå™¨äº‹ä»¶çš„åŒ…è£…ï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼ŒåŒæ—¶æä¾›äº†æ¥è¿‘åŸç”Ÿäº‹ä»¶çš„æ¥å£ã€‚å½“ç„¶ï¼Œä¹Ÿæä¾›äº† .nativeEvent ä¾›ä½ è·å–åº•å±‚äº‹ä»¶ é‡è¦çš„å±æ€§å’Œæ–¹æ³•ï¼š boolean bubbles boolean cancelable DOMEventTarget currentTarget boolean defaultPrevented number eventPhase boolean isTrusted DOMEvent nativeEvent void preventDefault() boolean isDefaultPrevented() void stopPropagation() boolean isPropagationStopped() DOMEventTarget target number timeStamp string type SyntheticEvent åœ¨å®Œæˆäº‹ä»¶å›è°ƒåï¼Œå…¶å±æ€§ä¼šæ— æ•ˆï¼Œæ— æ³•å¼‚æ­¥è®¿é—®è¯¥äº‹ä»¶ Hook Hook æ˜¯ React 16.8 ä»¥åæ–°å¢çš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸ç¼–å†™ class ç»„ä»¶çš„æƒ…å†µä¸‹ä½¿ç”¨ state, props ç­‰ React ç‰¹æ€§ Why Hook: åŸæœ‰çš„å†™æ³•ä¸­ï¼Œç»„ä»¶ä¹‹é—´çŠ¶æ€é€»è¾‘å¤ç”¨å¾ˆå›°éš¾ã€‚Hook å¯ä»¥æå–çŠ¶æ€é€»è¾‘ï¼Œå•ç‹¬æµ‹è¯•å’Œå¤ç”¨ï¼Œå¹¶ä¸”æ— éœ€ä¿®æ”¹åŸæœ‰ç»„ä»¶çš„ç»“æ„ å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£ã€‚Hook ä¼šå°†ç»„ä»¶ä¸­ç›¸äº’å…³è”çš„éƒ¨åˆ†æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°ï¼Œä¸ä¼šå¼ºåˆ¶æŒ‰ç…§ç”Ÿå‘½å‘¨æœŸåˆ’åˆ† éš¾ä»¥ç†è§£çš„ classã€‚Hook å¯ä»¥åœ¨é class çš„æƒ…å†µä¸‹ä½¿ç”¨æ›´å¤šçš„ React ç‰¹æ€§ Hook å¯ä»¥ç†è§£ä¸ºåœ¨å‡½æ•°ç»„ä»¶ä¸­ã€Œé’©å…¥ã€React State ä»¥åŠç”Ÿå‘½å‘¨æœŸç­‰ç‰¹æ€§çš„å‡½æ•°ï¼Œå¹¶ä¸”ä¸èƒ½å† class ç»„ä»¶ä¸­ä½¿ç”¨ ä½¿ç”¨è§„åˆ™ï¼š åªèƒ½åœ¨å‡½æ•°æœ€å¤–å±‚è°ƒç”¨ Hookï¼Œä¸è¦åœ¨å¾ªç¯ã€æ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hook åªèƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨ Hook åŸå…ˆæˆ‘ä»¬åœ¨ç¼–å†™å‡½æ•°ç»„ä»¶æ—¶ï¼Œå¦‚æœéœ€è¦ç»™å…¶å¼•å…¥çŠ¶æ€ï¼Œæˆ–è€…æ·»åŠ ç”Ÿå‘½å‘¨æœŸçš„é’©å­ï¼Œéœ€è¦è½¬æ¢æˆ class ç»„ä»¶ã€‚ä½†æœ‰äº† Hook ç‰¹æ€§åï¼Œå¯ä»¥ä½¿ç”¨ useState å’Œ useEffect æ¥ä»£æ›¿äº†ã€‚æ–°çš„å†™æ³•å°†ä¼šæ›´åŠ ç®€æ´ï¼Œæ˜“äºæŠ½è±¡å¤ç”¨å’Œæµ‹è¯• State Hook ä½¿ç”¨ useState Hook å¯ä»¥åœ¨å‡½æ•°ç»„ä»¶ä¸­æ·»åŠ å†…éƒ¨ stateï¼ŒReact åœ¨é‡å¤æ¸²æŸ“æ—¶ä¿ç•™è¯¥ state useState è¿”å›çš„æ›´æ–° state çš„å‡½æ•°å’Œ this.setState è¡Œä¸ºæœ‰åŒºåˆ«ï¼Œå‰è€…ä¸ä¼šæŠŠæ–°æ—§ state åˆå¹¶ï¼Œè€Œåè€…ä¼š ç¤ºä¾‹ï¼š 123456789function App() &#123; const [count, setCount] = useState(0) return ( &lt;div&gt; &lt;button onClick=&#123;() =&gt; setCount(count + 1)&#125;&gt;ç‚¹æˆ‘&lt;/button&gt; &lt;p&gt;ç‚¹å‡»è®¡æ•°ï¼š&#123;count&#125;&lt;/p&gt; &lt;/div&gt; )&#125; Event Hook ä½¿ç”¨ useEffect Hook ç»™å‡½æ•°ç»„ä»¶æ·»åŠ æ“ä½œå‰¯ä½œç”¨çš„èƒ½åŠ›ã€‚ç›¸å½“äº class ç»„ä»¶ä¸­ componentDidMount, componentDidUpdate å’Œ componentWillUnmount çš„åˆä½“ï¼Œå°†å‰¯ä½œç”¨æ“ä½œéƒ½èšé›†åˆ°è¯¥ Hook ä¸­ è°ƒç”¨ useEffect æ—¶ï¼Œå°±è¡¨æ˜è®© React åœ¨å¯¹ DOM å®Œæˆæ›´æ”¹åè°ƒç”¨ç›¸åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼›åŒæ—¶å¯ä»¥è¿”å›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºåœ¨æ¸…é™¤æ—¶æ‰§è¡Œä¸€äº›æ“ä½œã€‚React ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶æ‰§è¡Œæ¸…é™¤æ“ä½œ ä½¿ç”¨ç¤ºä¾‹ï¼š 1234567891011121314151617function App() &#123; const [userInfo, setUserInfo] = useState(&#123; username: 'æ¸¸å®¢', clickCount: 0 &#125;) useEffect(() =&gt; &#123; alert("å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š" + userInfo.username) return () =&gt; &#123; console.log("é”€æ¯ç»„ä»¶ï¼Œé‡æ–°æ¸²æŸ“") &#125; &#125;) return ( &lt;div&gt; &lt;button onClick=&#123;() =&gt; setUserInfo(&#123; username: 'iFaceless', clickCount: userInfo.clickCount &#125;)&#125;&gt;è®¾ç½®ç”¨æˆ·&lt;/button&gt; &lt;button onClick=&#123;() =&gt; setUserInfo(&#123; clickCount: userInfo.clickCount + 1, username: userInfo.username &#125;)&#125;&gt;ç‚¹å‡»è®¡æ•°&lt;/button&gt; &lt;p&gt;ä½ å¥½ï¼Œ&#123;userInfo.username&#125;&lt;/p&gt; &lt;p&gt;ç‚¹å‡»è®¡æ•° &#123;userInfo.clickCount&#125;&lt;/p&gt; &lt;/div&gt; )&#125; é»˜è®¤æƒ…å†µä¸‹ï¼ŒuseEffect ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œï¼ˆå½“ç„¶å¯ä»¥æ§åˆ¶ï¼‰ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€ŒæŒ‚è½½ã€å’Œã€Œæ›´æ–°ã€è¿™ç§æ¦‚å¿µ ä¸ componentDidMount å’Œ componentDidUpdate ä¸åŒçš„æ˜¯ï¼ŒuesEffect è°ƒåº¦çš„ effect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•ï¼Œä»è€Œè·å¾—æ›´å¥½çš„å“åº”é€Ÿåº¦ã€‚å¦‚æœéœ€è¦åŒæ­¥æ‰§è¡Œï¼Œåˆ™ä½¿ç”¨ useLayoutEffect Hook è‡ªå®šä¹‰ Hook è‡ªå®šä¹‰ Hook éœ€è¦ä»¥ use å¼€å¤´ï¼Œè¿™æ˜¯çº¦å®šï¼Œå¯ä»¥è®© React è‡ªåŠ¨æ£€æŸ¥ Hook æ˜¯å¦è¿åç›¸å…³è§„åˆ™ å‚è€ƒ React å®˜æ–¹æ–‡æ¡£ Index as a key is an anti-pattern Formik ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå›¾è°± How to fetch data with React Hooks? How to fetch data in React Making Sense of React Hooks]]></content>
      <categories>
        <category>å‰ç«¯</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
        <tag>JavaScript</tag>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaScript ES6 å­¦ä¹ ç¬”è®°]]></title>
    <url>%2F2019%2F06%2F23%2Fjavascript-es6-learning-note%2F</url>
    <content type="text"><![CDATA[å¼•è¨€2015 å¹´ï¼ŒECMAScript ç¬¬å…­ç‰ˆå¾—ä»¥å‘å¸ƒï¼Œè¿™å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ES6 æ ‡å‡†ï¼Œæ ‡å¿—ç€ JavaScript è¯­è¨€è¿æ¥æ–°çºªå…ƒã€‚ES6 å¼•å…¥äº†ä¸€äº›æ–°çš„è¯­æ³•ç³–ï¼ŒåŒæ—¶å¼¥è¡¥äº†ä¸€äº›åœ¨ ES5 ä¸­å­˜åœ¨çš„ä¸€äº›ç¼ºé™·ã€‚ æœ¬ç¯‡ç¬”è®°æ˜¯åœ¨å­¦ä¹ é˜®ä¸€å³°è€å¸ˆçš„ã€ŠES6 å…¥é—¨æ•™ç¨‹ã€‹ä¸­åšçš„ç¬”è®°ï¼Œä¸»è¦æ˜¯è®°å½•ä¸€äº›è‡ªå·±ä¸å¤ªç†Ÿæ‚‰çš„æˆ–è€…å’Œ ES5 å·®å¼‚å¾ˆå¤§çš„ç‰¹æ€§ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å’Œåˆ«çš„è¯­è¨€ï¼ˆå¦‚ Pythonï¼‰è¿›è¡Œå¯¹æ¯”ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°åœ¨æŸäº›è®¾è®¡æ€æƒ³ä¸Šï¼Œè¿™äº›è¯­è¨€ä¹Ÿæ˜¯ç›¸é€šçš„ã€‚ ç®€ä»‹ ES5 å…¶å®æ˜¯ ES3 çš„å‡çº§ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ ES3.1 ES4 å…¶å®å¹¶æ²¡æœ‰å‘å¸ƒï¼Œä½†æ˜¯å¢åŠ çš„ä¸€äº›åŠŸèƒ½åœ¨ ES6 ä¸­å‘å¸ƒäº† æ¯å¹´ 6 æœˆå‘å¸ƒæ–°çš„æ ‡å‡†ï¼ŒES6 æ³›æŒ‡ä¸‹ä¸€ä»£ JavaScript æ ‡å‡† Babel è½¬ç å™¨ï¼šå°† ES6 ä»£ç è½¬æ¢æˆ ES5 ä»£ç  Google çš„ Traceur è½¬ç å™¨ä¹Ÿå¯ä»¥å°† ES6 ä»£ç è½¬ä¸º ES5 ä»£ç  æ‚è®° æš‚æ—¶æ€§æ­»åŒºæœ¬è´¨ï¼šåªè¦ä¸€è¿›å…¥å½“å‰ä½œç”¨åŸŸï¼Œæ‰€éœ€è¦ä½¿ç”¨çš„å˜é‡å°±å·²ç»å­˜åœ¨ï¼Œä½†æ˜¯ä¸å¯è·å–ï¼Œåªæœ‰ç­‰åˆ°å£°æ˜å˜é‡çš„é‚£ä¸€è¡Œä»£ç å‡ºç°ï¼Œæ‰å¯ä»¥è·å–å’Œä½¿ç”¨è¯¥å˜é‡ å—ä½œç”¨åŸŸå¯ä»¥ä»»æ„åµŒå¥— å—ä½œç”¨åŸŸå†…å¯ä»¥å£°æ˜å‡½æ•°ï¼Œä½†æ˜¯åªèƒ½åœ¨è¯¥ä½œç”¨åŸŸä¸‹ä½¿ç”¨ æµè§ˆå™¨ä¸ºäº†å…¼å®¹å†å²ä»£ç ï¼Œåœ¨å—ä½œç”¨åŸŸä¸­å£°æ˜çš„å‡½æ•°ä¼šæå‡åˆ°å…¨å±€ï¼Œç±»ä¼¼ var å£°æ˜çš„å˜é‡äº† ES6 æ”¯æŒ 6 ä¸­å£°æ˜å…³é”®å­—ï¼š var function let const import class var, function å‘½ä»¤å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä¾ç„¶æ˜¯é¡¶å±‚å¯¹è±¡çš„å±æ€§ï¼›let, const, class å£°æ˜çš„å…¨å±€å˜é‡ï¼Œåˆ™ä¸å†å±äºé¡¶å±‚å¯¹è±¡çš„å±æ€§ã€‚äºŒè€…éœ€è¦è„±é’© JavaScript ä¸­çš„é¡¶å±‚å¯¹è±¡åœ¨å„ä¸ªç¯å¢ƒä¸‹éƒ½æ˜¯éœ€è¦å­˜åœ¨çš„ï¼Œä½†æ˜¯åœ¨ Node å’Œæµè§ˆå™¨ç¯å¢ƒä¸­ç”¨ä¸€å¥—ä»£ç æƒ³è¦æ‹¿åˆ°é¡¶å±‚å¯¹è±¡è¿˜æ˜¯æœ‰äº›è´¹åŠ²çš„ã€‚å¯è¡Œçš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š1234567891011121314(typeof window !== 'undefined' ? window : (typeof process === 'object' &amp;&amp; typeof require === 'function' &amp;&amp; typeof global === 'object') ? global : this);var getGlobal = function () &#123; if (typeof self !== 'undefined') &#123; return self; &#125; if (typeof window !== 'undefined') &#123; return window; &#125; if (typeof global !== 'undefined') &#123; return global; &#125; throw new Error('unable to locate global object');&#125;; è§£æ„ è§£æ„ï¼ˆç±»ä¼¼ Python ä¸­çš„ç”¨æ³•ï¼Œæˆ–è€… Rust ä¸­çš„æ¨¡å¼åŒ¹é…ï¼‰ï¼š 12345678910let [a, b, c] = [1, 2, 3]// c å°†æ¥æ”¶å‰©ä½™çš„æ•°ç»„å…ƒç´ [a, b, ...c] = [1, 2, 3, 4, 5][, , c] = [1, 2, 3]// ä¸å®Œå…¨è§£æ„ä¹Ÿæ˜¯æ”¯æŒçš„[a, b] = [1, 2, 3, 4]// å³å€¼å¿…é¡»è¦æ˜¯å¯è¿­ä»£çš„ï¼Œå³å®ç°äº† Iterator æ¥å£ï¼Œå¦åˆ™ä¼šå‡ºé”™[a, b] = NaN // TypeError: undefined is not a function å¯è®¾ç½®é»˜è®¤å€¼ï¼šlet [foo = true] = [];ï¼Œåªæœ‰æ•°ç»„æˆå‘˜ä¸¥æ ¼ç­‰äº undefined æ‰ä¼šè®©é»˜è®¤å€¼ç”Ÿæ•ˆ è§£æ„å¤±è´¥ï¼Œå˜é‡å€¼ä¸º undefined å¯¹è±¡ä¹Ÿå¯ä»¥è§£æ„ï¼š 123456789let o = &#123;name: "chris", age: 26&#125;let &#123; name, age &#125; = o// å¯ä»¥å°†å¯¹è±¡èµ‹å€¼ç»™æŸä¸ªå·²æœ‰çš„å˜é‡const &#123; log &#125; = consolelog('hello')// å¯ä»¥æœ‰åˆ«åï¼Œname æ˜¯æ¨¡å¼ï¼Œn æ‰æ˜¯è¢«èµ‹å€¼çš„å˜é‡(&#123;name: n, age: a&#125; = o) å¯¹è±¡è§£æ„çš„æœ¬è´¨æ˜¯ï¼Œå…ˆæ‰¾åˆ°åŒåå±æ€§ï¼Œå†èµ‹å€¼ç»™å¯¹åº”çš„å˜é‡ è§£æ„èµ‹å€¼çš„åŸåˆ™æ˜¯ï¼Œåªè¦å³å€¼ä¸æ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œéƒ½è¦å…ˆè½¬ä¸ºå¯¹è±¡ï¼ˆå¦‚æ•°å­—ä¼šè½¬æˆ Numberï¼‰ï¼›è€Œ undefined å’Œ null æ— æ³•è½¬æ¢ä¸ºå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ å‡½æ•°çš„å‚æ•°ä¹Ÿæ”¯æŒè§£æ„èµ‹å€¼ å­—ç¬¦ä¸² &quot;\u{xxxx}&quot; å¯ä»¥è¡¨ç¤ºè¶…è¿‡ä¸¤ä¸ªå­—èŠ‚çš„ Unicode å­—ç¬¦ for (let c of &#39;foo&#39;) å¯ä»¥ç›´æ¥éå†å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å¯ä»¥è¯†åˆ«å¤§äº 0xFFFF çš„ç ç‚¹ String.raw è¿”å›è½¬ä¹‰å­—ç¬¦ä¸²ï¼š String.includes() æ˜¯å¦å­˜åœ¨å­ä¸² String.startsWith() + String.endsWith() String.repeat() æ•°å€¼ å¤šç§è¿›åˆ¶å†™æ³•ï¼š äºŒè¿›åˆ¶ï¼š0b010101 å…«è¿›åˆ¶ï¼š0o123 åå…­è¿›åˆ¶ï¼š0x1234 å°†å­—ç¬¦ä¸²çš„å¤šç§è¿›åˆ¶è½¬æ¢æˆåè¿›åˆ¶ï¼šNumber(target) æ–°å¢äº† Number.isFinite å’Œ Number.isNaN æ–¹æ³•ï¼Œä½†è¿™ä¸¤ç§æ–¹æ³•åªå¯¹æ•°å€¼æœ‰æ•ˆï¼Œå…¶å®ƒä¸€å¾‹ä¸º falseã€‚æ³¨æ„ä¹Ÿæœ‰ä¸€å¯¹å…¨å±€çš„å‡½æ•° isFinite å’Œ isNaNï¼Œå®ƒä»¬åˆ™ä¼šå°è¯•å…ˆå°†è¾“å…¥çš„å‚æ•°è½¬æ¢ä¸º Number åå†è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ˜¯æœ€é‡è¦çš„åŒºåˆ« ES6 å°† parseInt å’Œ parseFloat æŒªåˆ° Number ä¸Šäº†ï¼Œè¿™æ ·ä¼šæ›´åŠ ç»Ÿä¸€ Number.EPSILON æµ®ç‚¹æ•°è®¡ç®—ä¼šæœ‰ç²¾åº¦æŸå¤±ï¼Œè¿™ä¸ªæå°å€¼å¯ä»¥ç”¨æ¥æŒ‡å®šè¯¯å·®èŒƒå›´ æŒ‡æ•°è¿ç®—ç¬¦ **ï¼Œé‡‡ç”¨çš„æ˜¯å³ç»“åˆçš„æ¨¡å¼ V8 å¼•æ“ä¸­ï¼ŒæŒ‡æ•°è¿ç®—ç¬¦å’Œ Math.pow ç®—æ³•å®ç°æ˜¯ä¸åŒçš„ï¼Œå¯¹äºç‰¹åˆ«å¤§çš„ç»“æœï¼ŒäºŒè€…ä¼šæœ‰ç»†å¾®å·®åˆ« å‡½æ•° é»˜è®¤å‚æ•°ï¼š function say(word = &#39;hi&#39;) { console.log(word) } åŒä¸€ä½œç”¨åŸŸä¸­ï¼Œä¸èƒ½å‡ºç°åŒåå‡½æ•°çš„å£°æ˜ é»˜è®¤å‚æ•°æ˜¯æƒ°æ€§è®¡ç®—ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°è®¡ç®—ï¼Œè¿™ç‚¹å’Œ Python éå¸¸ä¸åŒï¼ï¼ å‡½æ•°å‚æ•°æ”¯æŒè§£æ„ï¼Œä¸”æ”¯æŒé»˜è®¤å€¼ æŒ‡å®šäº†å‚æ•°é»˜è®¤å€¼åï¼Œå‡½æ•°çš„ length å±æ€§åªä¼šè¿”å›æœªè®¾ç½®é»˜è®¤å€¼çš„å‚æ•°ä¸ªæ•° å¦‚æœè®¾ç½®äº†å‚æ•°ï¼Œä¸”ä¸æ˜¯å°¾å‚æ•°ï¼Œåˆ™å…¶ä¹‹åçš„å‚æ•°éƒ½ä¸ç®—åˆ° length äº†ï¼š(function (a = 0, b, c) {}).length // 0 å‡½æ•°å¦‚æœè®¾ç½®äº†é»˜è®¤å€¼ï¼Œåˆ™åœ¨åˆå§‹åŒ–æ—¶ä¼šå½¢æˆä¸€ä¸ªç‰¹æ®Šçš„ä½œç”¨åŸŸï¼š 1234567const x = 100// è¿™é‡Œçš„å‚æ•° `x` å’Œ `y` å¤„äºä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œæ•… `y` çš„é»˜è®¤å€¼å°±æ˜¯æŒ‡å‘å‚æ•° `x`function foo(x, y = x) &#123; console.log(x, y)&#125;foo(200) //200, 200 ES6 è§„å®šï¼Œåªè¦å‡½æ•°ä½¿ç”¨äº†é»˜è®¤å€¼ã€è§£æ„å’Œæ‰©å±•è¿ç®—ç¬¦ï¼Œå°±ä¸èƒ½åœ¨å†…éƒ¨æ˜¾å¼æŒ‡å®šä¸ºä¸¥æ ¼æ¨¡å¼ ç®­å¤´å‡½æ•°ï¼ˆæ›´ç®€æ´çš„åŒ¿åå‡½æ•°å†™æ³•ï¼‰ï¼š å¦‚æœç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦å°†å¯¹è±¡ç”¨åœ†æ‹¬å·åŒ…å›´ï¼Œå¦åˆ™ä¼šè¢«è§£é‡Šä¸ºä»£ç å—ï¼šlet getObj = id =&gt; ({ id: id }) å‡½æ•°ä½“å†…çš„ this æ˜¯å®šä¹‰æ—¶æ‰€åœ¨çš„å¯¹è±¡ï¼Œè€Œéä½¿ç”¨æ—¶æ‰€åœ¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œthis æ˜¯å›ºå®šçš„ã€‚æœ¬è´¨ä¸Šæ˜¯å› ä¸ºåœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œæ ¹æœ¬å°±æ²¡æœ‰ thisï¼Œå®ƒæŒ‡å‘çš„æ˜¯å¤–å±‚çš„ this - ä¸å¯ä»¥ä½œä¸ºæ„é€ å‡½æ•°ï¼Œä¸èƒ½å¯¹å®ƒä½¿ç”¨ `new` å‘½ä»¤ - æ²¡æœ‰ `arguments` å¯¹è±¡ - ä¸èƒ½ä½¿ç”¨ `yield`ï¼Œä¸å¯ä»¥ä½œä¸º `Generator` å°¾è°ƒç”¨ï¼š å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯å‡½æ•°çš„æœ€åä¸€æ­¥æ“ä½œï¼ˆä¸ä¸€å®šæ˜¯æœ€åä¸€è¡Œï¼Œé€»è¾‘ä¸Šæ˜¯æœ€åä¸€æ­¥ï¼‰æ˜¯ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›å…¶ç»“æœï¼š12345678function foo(x) &#123; return bar(x) &#125;// ä»¥ä¸‹ä¸ç¬¦åˆfunction foo(x) &#123; let y = bar(x); return y &#125;function foo(x) &#123; bar(x) &#125;function foo(x) &#123; return bar(x) + 1 &#125; å°¾è°ƒç”¨ä¼˜åŒ–ï¼šåªä¿ç•™å†…å±‚å‡½æ•°çš„è°ƒç”¨å¸§ï¼ŒèŠ‚çº¦å†…å­˜ ES6 ä¸­åªè¦ä½¿ç”¨äº†å°¾é€’å½’ï¼Œå°±ä¸ä¼šå‡ºç°è°ƒç”¨æ ˆæº¢å‡ºï¼Œå› ä¸ºåªéœ€è¦ç»´æŠ¤ä¸€ä¸ªè°ƒç”¨å¸§å³å¯ã€‚ä½†å…¶å®è¿™ä¸ªä¼˜åŒ–åªæœ‰åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹æ‰ä¼šå¯ç”¨ã€‚æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œéœ€è¦é€šè¿‡å˜é‡ arguments, func.caller æ¥è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨æ ˆ æ•°ç»„ æ•°ç»„å¤åˆ¶ï¼šconst a2 = [...a1] æˆ–è€… const [...a2] = a1 å¯ä»¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„ï¼šconst a = [...&#39;hello&#39;] æ‰©å±•è¿ç®—ç¬¦ ... å¯ä»¥å°†ä»»ä½•å®ç°äº† Iterator æ¥å£çš„å¯¹è±¡è½¬æ¢æˆæ•°ç»„ Array.from å¯ä»¥æ¥å—ä»»æ„å®ç°äº† Iterator æ¥å£çš„å¯¹è±¡ï¼Œè½¬æ¢æˆæ•°ç»„ï¼›ä¹Ÿæ”¯æŒ array-like å¯¹è±¡ Array.of å°†ä¸€ç»„å€¼è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¼¥è¡¥ Array æ„é€ å‡½æ•°åœ¨å‚æ•°ä¸ªæ•°ä¸åŒæ—¶ï¼Œè¡Œä¸ºä¹Ÿä¸åŒçš„æ¯›ç—…ã€‚å®Œå…¨å¯ä»¥æ›¿ä»£ Array() æˆ–è€… new Array() æä¾›äº†å‡ ä¸ªéå†çš„æ¥å£ï¼š keys() å®é™…å°±æ˜¯ç´¢å¼• values() å€¼ entries() é”®å€¼ includes() åˆ¤æ–­æ˜¯å¦åŒ…å«å…ƒç´  flat ç”¨äºå°†åµŒå¥—æ•°ç»„å±•å¼€ï¼Œæ‹‰å¹³ï¼Œé»˜è®¤åªå±•å¼€ä¸€å±‚ï¼Œå¯æŒ‡å®šå¤šå±‚æˆ–è€… Infinity flatMap å’Œ flat ç±»ä¼¼ï¼Œä½†æ˜¯ä¼šå¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œä½†å®ƒåªèƒ½å±•å¼€ä¸€å±‚ å¯¹è±¡ å±æ€§æˆ–è€…æ–¹æ³•éƒ½å¯ä»¥ç®€å†™å•¦ï¼š 1234567891011let [x, y] = [1, 2]const a = &#123;x, y&#125;// ç­‰åŒäºconst a = &#123;x: x, y: y&#125;// æ–¹æ³•çš„ç®€å†™const o = &#123; doSomething() &#123; return true &#125; // å¸¸è§„å†™æ³• doSomething: function() &#123; return true &#125;&#125; å…è®¸ä½¿ç”¨è¡¨è¾¾å¼ä½œä¸ºå¯¹è±¡çš„å±æ€§åï¼š 123456let propKey = 'foo'let obj = &#123; [properKey]: true, ['a' + 'bc']: 123&#125; ES6 ä¸­å±æ€§éå†çš„æ–¹æ³•ï¼š for...inï¼šéå†å¯¹è±¡è‡ªèº«å’Œç»§æ‰¿çš„å¯æšä¸¾å±æ€§ï¼ˆä¸å« Symbol å±æ€§ï¼‰ Object.keys(obj)ï¼šå¯¹è±¡è‡ªèº«å¯æšä¸¾å±æ€§ï¼ˆä¸å« Symbol å±æ€§ï¼‰ Object.getOwnPropertyNames(obj)ï¼šå¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å±æ€§çš„é”®åï¼ˆä¸å« Symbol å±æ€§ï¼‰ Object.getOwnPropertySymbols(obj)ï¼šå¯¹è±¡è‡ªèº«æ‰€æœ‰ Symbol å±æ€§çš„é”®å Reflect.ownKeys(obj)ï¼šå¯¹è±¡è‡ªèº«æ‰€æœ‰çš„é”®åï¼ˆæ— è®ºæ˜¯ Symbol å±æ€§æˆ–è€…æ˜¯åˆ«çš„å±æ€§ï¼Œä¸å…³å¿ƒå¯å¦æšä¸¾ï¼‰ superï¼š æŒ‡å‘å¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼Œåœ¨è¿™ç§ç”¨æ³•ä¸‹ï¼Œåªèƒ½åœ¨å¯¹è±¡æ–¹æ³•ä¸­ä½¿ç”¨ å¯¹è±¡æ–¹æ³•ï¼šå¿…é¡»é‡‡ç”¨ ES6 æ–¹æ³•ç®€å†™çš„æ–¹å¼ï¼Œæ‰ä¼šè¢«è®¤å®šä¸ºå¯¹è±¡æ–¹æ³• å¯¹è±¡è§£æ„èµ‹å€¼ï¼š let { x, y, ...z } = { x: 1, y: 2, a: 10, b: 20 } è§£æ„èµ‹å€¼å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•° å³å€¼å¿…é¡»æ˜¯å¯¹è±¡ é‡‡ç”¨çš„æ˜¯æµ…æ‹·è´ Object.is()ï¼š æ›´åŠ æ˜ç¡®çš„æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç¬¦åˆ Same-value equlity Object.is(NaN, NaN) // true Object.is(+0, -0) // false Object.assign() ç”¨äºå¯¹è±¡åˆå¹¶ï¼Œå°±æ˜¯å°†æºå¯¹è±¡æ‰€æœ‰å¯æšä¸¾çš„å±æ€§å¤åˆ¶åˆ°ç›®æ ‡å¯¹è±¡ï¼ˆåŒ…æ‹¬ Symbol å±æ€§ï¼‰ã€‚æ³¨æ„ç‚¹ï¼š æµ…æ‹·è´ åŒåå±æ€§ç›´æ¥æ›¿æ¢ï¼Œä¸è€ƒè™‘åµŒå¥— ç”±äº Object.assign åªèƒ½è¿›è¡Œå€¼å¤åˆ¶ï¼Œå¯¹äºå–å€¼å‡½æ•°ï¼Œåˆ™ä¼šå…ˆå–å€¼å†å¤åˆ¶ Object.assign() å¸¸è§ç”¨é€”ï¼š ä¸ºå¯¹è±¡æ·»åŠ å±æ€§ï¼šObject.assign(this, { x, y }) ä¸ºå¯¹è±¡æ·»åŠ æ–¹æ³•ï¼šObject.assign(Foo.prototype, { barMethod() { ... } }) å¯¹è±¡å…‹éš†ï¼šObject.assign(Object.create(originProto), origin) å±æ€§æä¾›é»˜è®¤å€¼ï¼šObject.assign({}, DEFAULTS, options) Symbol ES6 å¼•å…¥ Symbol çš„åŸå› ï¼š ES5 ä¸­ï¼Œå±æ€§åæ˜¯å­—ç¬¦ä¸²ï¼Œå®¹æ˜“é€ æˆå±æ€§åå†²çª Symbol å¯ä»¥ä¿è¯æ¯ä¸ªå±æ€§ç‹¬ä¸€æ— äºŒ Symbol æ˜¯æ–°å¢çš„åŸå§‹ç±»å‹ï¼Œè¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼ã€‚ç”¨äºå¯¹è±¡çš„å±æ€§ã€‚ä½¿ç”¨ Symbol() å‡½æ•°æ„é€  Symbol æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºå¯¹ Symbol å®ä¾‹çš„æè¿°ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œåˆ™ä¼šè°ƒç”¨ obj.toString() å¾—åˆ°å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œå†ç”Ÿæˆä¸€ä¸ª Symbol å€¼ æ³¨æ„ç‚¹ï¼š ä¸å¯ä»¥ç›´æ¥ä¸å…¶å®ƒç±»å‹å€¼è¿ç®—ï¼Œä¸ä¼šéšå¼è½¬æ¢ä¸º string å¯ä»¥æ˜¾å¼è½¬æ¢ä¸º string symbol.description å¯ä»¥è·å– Symbol çš„æè¿°ä¿¡æ¯ ä½œä¸ºå¯¹è±¡çš„å±æ€§ï¼ˆåªèƒ½æ˜¯å…¬å¼€å±æ€§ï¼‰ï¼š 1234567891011121314151617const name = Symbol('name')let person = &#123;&#125;// ç¬¬ä¸€ç§å®šä¹‰æ–¹å¼person[name] = "Foo"// è·å–çš„æ–¹å¼person[name]// ç¬¬äºŒç§å®šä¹‰æ–¹å¼let person2 = &#123; [name]: 'Bar' // å¿…é¡»è¦æ”¾åœ¨æ–¹æ‹¬å·ä¸­&#125;// ç¬¬ä¸‰ç§å®šä¹‰æ–¹å¼Object.defineProperty(a, mySymbol, &#123; value: 'Hello!' &#125;); å¯ä»¥ä½œä¸ºå¸¸é‡ï¼Œä¿è¯å€¼ä¸åŒ å¯ä»¥ç±»ä¼¼æˆ‘ä»¬åœ¨ Python ä¸­é‚£æ ·å®šä¹‰ Enumï¼š 12345const userType = &#123; guest: Symbol(), org: Symbol(), member: Symbol(),&#125; ç”±äºä¸ä¼šè¢«å¸¸è§„çš„æ–¹æ³•å¦‚ getOwnPropertyNames ç­‰éå†åˆ°ï¼Œä½†å…¶å®åˆæ˜¯å…¬å¼€ã€‚è¿™ç§ç‰¹æ€§å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€äº›éç§æœ‰ã€ä»…å¸Œæœ›å†…éƒ¨è°ƒç”¨çš„æ–¹æ³• Symbol.for å’Œ Symbol.keyForï¼šå¤ç”¨ç›¸åŒå‚æ•°æ„å»ºçš„ Symbolï¼Œå®ƒä¼šåœ¨å…¨å±€æ³¨å†Œå‚æ•°ï¼Œå¹¶åœ¨åˆ›å»ºå‰è¿›è¡Œæœç´¢ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œå¦åˆ™æ–°å»ºã€‚æ³¨æ„è¿™ä¸ªå…¨å±€æ˜¯å…¨å±€ç¯å¢ƒï¼Œå¯ä»¥åœ¨ä¸åŒçš„ iframe å’Œ service worker ä¸­å–åˆ°åŒæ ·çš„å€¼ï¼š 123456let s1 = Symbol.for('s1')Symbol.for('s1') === s1 // trueSymbol.keyFor(s1) // 's1'let s2 = Symbol('s2')Symbol.keyFor(s2) // undefined å†…ç½®çš„ Symbol å€¼ï¼ŒæŒ‡å‘è¯­è¨€å†…éƒ¨ä½¿ç”¨çš„æ–¹æ³•ï¼š Symbol.hasInstanceï¼Œæ¯ä¸ªå¯¹åº”å¯ä»¥è‡ªå®šä¹‰è¿™ä¸ª Symbol æ–¹æ³•ï¼Œä»è€Œè®© instanceof è¿ç®—ç¬¦æŒ‰ç…§æœŸæœ›çš„è¡¨ç° Symbol.isConcatSpreadable å±æ€§ï¼Œè¡¨ç¤ºåœ¨ Array.prototype.concat() æ—¶ï¼Œèƒ½å¦å±•å¼€ Symbol.species å±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚åœ¨åˆ›å»ºè¡ç”Ÿå¯¹è±¡æ—¶ï¼Œä¼šä½¿ç”¨è¯¥å±æ€§ Symbol.iterator æŒ‡å‘å¯¹è±¡çš„é»˜è®¤éå†å™¨ Symbol.toPrimitive æŒ‡å‘è½¬æ¢æˆåŸå§‹ç±»å‹çš„æ–¹æ³• Set å’Œ Map æ•°æ®ç»“æ„ Set æ„é€ å‡½æ•°å¯æ¥å—ä»»æ„ Iterable çš„å¯¹è±¡ æ¥çœ‹ä¸‹æ¶ˆé™¤æ•°ç»„ä¸­é‡å¤å…ƒç´ çš„æ–¹æ³•ä¸ Python çš„åŒºåˆ«ï¼š 12345678// Python ä¸­çš„å†™æ³•list(set([1, 1, 2]))// JS ES6 ä¸­çš„å†™æ³•[...new Set([1, 1, 2])]// æˆ–è€…Array.from(new Set([1, 1, 2)]) WeakSet å¼±å¼•ç”¨è®¡æ•°ï¼Œåªèƒ½å­˜æ”¾å¯¹è±¡ã€‚ä¸å¯éå† Map çš„æ„é€ ï¼š 123456// å…ˆçœ‹çœ‹ Python ä¸­ä¸€ä¸ªç±»ä¼¼çš„æ„é€ æ–¹å¼dict(zip(['name', 'age'], ['chris', 22]))// é‚£ä¹ˆåœ¨ ES6 ä¸­çš„å†™æ³•// å®é™…ä¸Šä»»æ„ Iterable çš„å¯¹è±¡ï¼Œä¸”æˆå‘˜å‡ä¸ºåŒå…ƒç´ çš„æ•°ç»„çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥ä½œä¸º Map çš„æ„é€ å‡½æ•°new Map([['name', 'age'], ['chris', 22]]) WeakMap Proxy å±äºå…ƒç¼–ç¨‹èŒƒç•´ï¼Œå¯ä»¥æ‹¦æˆªä¸€äº›æ“ä½œï¼Œå¹¶è¿›è¡Œé‡å®šä¹‰ æ„é€ å‡½æ•°ï¼švar proxy = new Proxy(target, handler) è¦æƒ³è®© Proxy èµ·ä½œç”¨ï¼Œå¿…é¡»è¦é’ˆå¯¹å…¶å®ä¾‹è¿›è¡Œæ“ä½œï¼Œè€Œéç›®æ ‡å¯¹è±¡ 123456789101112131415161718let handler = &#123; get (target, name, receiver) &#123; if (name === "name" || name == "age") &#123; return Reflect.get(target, name, receiver) &#125; else &#123; throw ReferenceError(`property '$&#123;name&#125;' not found`) &#125; &#125;&#125;let user = &#123; name: "Chris", age: 26,&#125;let proxy = new Proxy(user, handler)console.log(proxy)console.log(proxy.age)console.log(proxy.name)console.log(proxy.foo) Proxy.revocable å¯ä»¥è¿”å›ä¸€ä¸ªå¯å–æ¶ˆçš„ Proxy å®ä¾‹ Reflect Reflect ä¹Ÿæ˜¯ä¸ºäº†æ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–°çš„ APIï¼Œè®¾è®¡ç›®æ ‡ï¼š å°† Object å¯¹è±¡ä¸­æ˜æ˜¾å±äºå†…éƒ¨çš„æ–¹æ³•å‰¥ç¦»å‡ºæ¥ï¼Œæ”¾åˆ° Reflect å¯¹è±¡ä¸Š ä¿®æ”¹æŸäº› Object æ–¹æ³•çš„è¿”å›ç»“æœï¼Œæ›´åŠ æ–¹ä¾¿ä½¿ç”¨ å°†æŸäº›å‘½ä»¤å¼çš„æ“ä½œï¼Œå˜æˆå‡½æ•°ï¼Œå¦‚ï¼šname in obj =&gt; Reflect.has(obj, name)ï¼Œdelete obj[name] =&gt; Reflect.deleteProperty(obj, name) ä¸ Proxy ä¸­æ‹¦æˆªæ–¹æ³•ä¸€æ ·ï¼Œå¯ä»¥æ›¿ä»£æ‰§è¡Œå¯¹è±¡çš„é»˜è®¤è¡Œä¸º Reflect.apply(Math.floor, undefined, [1]) Promise å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆã€‚æ‰€è°“ Promiseï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„å®¹å™¨ï¼Œä¿å­˜ç€æœªæ¥æ‰ä¼šç»“æŸçš„äº‹æƒ…ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥ç»“æœï¼‰ ç‰¹ç‚¹ï¼š å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ï¼ˆpending, fulfilled, rejectedï¼‰ ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°ç»“æœ ä»¥æ›´åŠ åŒæ­¥çš„æ–¹å¼ç¼–ç¨‹ï¼Œæ˜“äºæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä¾¿äºç»´æŠ¤ ç¼ºç‚¹ï¼š æ— æ³•å–æ¶ˆ è‹¥ä¸è®¾ç½®å›è°ƒï¼ŒPromise å†…éƒ¨æŠ›å‡ºé”™è¯¯ä¸ä¼šåé¦ˆåˆ°å¤–éƒ¨ pending çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥å…·ä½“è¿›å±•æƒ…å†µ Promise.prototype.then() å¯æ¥å—ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæ˜¯ resolved æ—¶çš„ å›è°ƒï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ rejected æ—¶çš„å›è°ƒã€‚ç¬¬äºŒä¸ªå›è°ƒå¯é€‰ Promise.prototype.then() è¿”å›çš„æ˜¯ä¸€å€‹æ–°çš„ Promise å¯¦ä¾‹ Promise.prototype.catch() æ˜¯ .then(undefined, rejection) æˆ– .then(null, rejection) çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•° Promise å¯¹è±¡çš„é”™è¯¯å…·æœ‰å†’æ³¡çš„æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚é”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª catch æ•è· Promise.prototype.finally ç”¨äºæŒ‡å®šä¸ç®¡ Promise å¯¹è±¡æœ€ç»ˆå¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œï¼ŒES2018 å¼•å…¥ã€‚æ— æ³•åœ¨ finally ä¸­è·å– Promise çš„çŠ¶æ€ï¼Œå®ƒçš„æ‰§è¡Œä¸çŠ¶æ€æ— å…³ Promise.allï¼š å‚æ•°å¿…é¡»æ˜¯ Iterable çš„å¯¹è±¡ï¼Œå…ƒç´ åº”å½“æ˜¯ Promise å®ä¾‹ çŠ¶æ€ç”±æˆå‘˜å†³å®šï¼Œåªæœ‰éƒ½æ˜¯ fulfilled æ—¶ï¼Œæ•´ä½“çš„çŠ¶æ€æ‰ä¼šå˜æˆ fulfilled å¦‚æœä»»ä½•ä¸€ä¸ª rejcted ï¼Œåˆ™æ•´ä½“æ•´ä½“å°±æ˜¯ rejectedï¼Œå¹¶ä¸”è¿”å›ç¬¬ä¸€ä¸ªè¢« reject çš„å®ä¾‹çš„è¿”å›å€¼ Promise.raceï¼Œç±»ä¼¼ Promise.any çš„æ„Ÿè§‰ï¼Œå°±æ˜¯åªè¦æœ‰ä¸€ä¸ªçŠ¶æ€æ”¹å˜ï¼Œæ•´ä½“çŠ¶æ€å°±å˜åŒ–ï¼›ç‡å…ˆå˜åŒ–çš„ Promise å®ä¾‹è¿”å›å€¼ä¼šä¼ é€’ç»™ p çš„å›è°ƒå‡½æ•° Iterator &amp; forâ€¦of Iterator éå†è¿‡ç¨‹ï¼š åˆ›å»ºä¸€ä¸ªæŒ‡å‘å¯è¿­ä»£å¯¹è±¡çš„æŒ‡é’ˆå¯¹è±¡ è°ƒç”¨ nextï¼Œå¯å¾—åˆ°ç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆè¿”å›ç»“æœåŒ…æ‹¬ä¸¤ä¸ªå±æ€§ï¼švalue + doneï¼Œå¯åˆ†åˆ«çœç•¥ï¼‰ ä¸æ–­è°ƒç”¨ next ç›´åˆ°æ¶ˆè´¹å®Œ å®ç°äº† Iterator æ¥å£çš„æ•°æ®ç»“æ„ï¼Œå°±æ˜¯å¯éå†çš„ï¼ˆIterableï¼‰ã€‚ç¤ºä¾‹ï¼š 1234567891011121314151617181920class RangeIterator &#123; constructor(start = 0, stop = 100) &#123; this._value = start this._stop = stop &#125; [Symbol.iterator]() &#123; return this &#125; next() &#123; let val = this._value if (val &lt; this._stop) &#123; this._value++ return &#123;done: false, value: val&#125; &#125; return &#123;done: true, value: undefined&#125; &#125;&#125;for (const x of new RangeIterator()) &#123; console.log(x)&#125; ä½•æ—¶è§¦å‘ Iterator ï¼ˆå³ Symbol.iteratorï¼‰æ¥å£è°ƒç”¨ï¼Ÿ è§£æ„èµ‹å€¼ æ‰©å±•è¿ç®—ç¬¦ yield* for...of Array.from() Map(), Set(), WeakMap(), WeakSet() Promise.all() Promise.race() å¯ä»¥ä½¿ç”¨ Generator å‡½æ•°å®ç°å¯è¿­ä»£ï¼š 123456789101112131415class RangeIterator &#123; constructor(start = 0, stop = 10) &#123; this._value = start this._stop = stop &#125; *[Symbol.iterator]() &#123; while (this._value &lt; this._stop) &#123; this._value++ yield this._value &#125; &#125;&#125;for (const x of new RangeIterator()) &#123; console.log(x)&#125; éå†å™¨å¯¹è±¡é™¤äº†æœ‰ next æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ª return æ–¹æ³•ï¼Œç”¨äºå¤„ç† for...of æå‰é€€å‡ºï¼ˆå¦‚å‡ºé”™ï¼Œæˆ–è€… breakï¼‰æ—¶è¦åšçš„äº‹æƒ…ã€‚è€Œ throw æ–¹æ³•ä¸€èˆ¬æ˜¯é…åˆ Generator å‡½æ•°ä½¿ç”¨ Generator å‡½æ•° å®šä¹‰æ–¹å¼ï¼šfunction* funcName() { yield 1; return &quot;end&quot; } è°ƒç”¨ Generator å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä»£è¡¨ Generator å‡½æ•°å†…éƒ¨æŒ‡é’ˆ yield åªèƒ½ç”¨äº Generator å‡½æ•°ä¸­ï¼ˆè¿™ä¸ªå’Œ Python ä¸åŒã€‚åœ¨ Python ä¸­ï¼ŒGenerator å‡½æ•°ä»è¡¨æ˜ä¸Šçœ‹å’Œæ™®é€šå‡½æ•°å®šä¹‰æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ç°ä¸åŒï¼‰ yield è¡¨è¾¾å¼æœ¬èº«æ— è¿”å›å€¼ï¼Œæˆ–è€…æ€»è¿”å› undefinedã€‚next æ–¹æ³•å¯ä»¥å¸¦å‚æ•°ï¼Œä½œä¸º yield è¡¨è¾¾å¼çš„è¿”å›å€¼ ç¬¬ä¸€æ¬¡å¸¦å‚æ•°è°ƒç”¨ next æ–¹æ³•æ—¶ï¼Œå‚æ•°æ˜¯æ— æ•ˆçš„ã€‚å› ä¸º next æ–¹æ³•çš„å‚æ•°è¡¨ç¤ºä¸Šä¸€ä¸ª yield è¡¨è¾¾å¼çš„è¿”å›å€¼ è¯­ä¹‰ä¸Šï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ next æ˜¯å¯åŠ¨éå†å™¨å¯¹è±¡ Generator.prototype.throw() å¯ä»¥åœ¨å‡½æ•°ä½“å¤–å‘ Generator å‡½æ•°æŠ›é”™ã€‚å¦‚æœç”Ÿæˆå™¨ä¸­æ²¡æœ‰ try...catch å—ï¼Œé”™è¯¯ä¼šä¼ é€’åˆ°å¤–éƒ¨ å¦‚æœä¸€ä¸ª Generator æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¸”æ²¡æœ‰å†…éƒ¨æ•è·ï¼Œåˆ™ä¼šè®¤ä¸ºå®ƒå·²ç»æ‰§è¡Œç»“æŸäº† Generator.prototype.return() å¯ä»¥ç»ˆæ­¢ Generatorï¼Œå¦‚æœ return å¸¦å‚æ•°ï¼Œåˆ™ä¼šä½œä¸ºæœ€åçš„è¿”å›å€¼ã€‚å¦‚æœ Generator ä¸­å«æœ‰ try...finally è¯­å¥å—ï¼Œåˆ™ä¼šä¼˜å…ˆæ‰§è¡Œ finallyï¼Œå»¶è¿Ÿè¿”å› yield* è¡¨è¾¾å¼å¯ä»¥å‚è€ƒ Python ä¸­çš„ yield from å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼š å›è°ƒå‡½æ•° äº‹ä»¶ç›‘å¬ å‘å¸ƒ/è®¢é˜… Promise å¯¹è±¡ async å‡½æ•° async æ˜¯ Generator è¯­æ³•ç³–ï¼Œå†™å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°æ›´åŠ ä¾¿æ· æ”¹è¿›ç‚¹ï¼š å†…ç½®æ‰§è¡Œå™¨ï¼Œæ— éœ€ co ä¹‹ç±»çš„æ¨¡å—æ§åˆ¶ Generator æ‰§è¡Œæµç¨‹äº† æ›´å¥½çš„è¯­ä¹‰ æ›´å¹¿çš„é€‚ç”¨æ€§ã€‚await å¯ä»¥æ˜¯ Promise å¯¹è±¡ï¼Œå¦‚æœæ˜¯åŸå§‹ç±»å‹å€¼ï¼Œåˆ™ä¼šè‡ªåŠ¨è½¬æ¢ä¸º resolved Promise å¯¹è±¡ è¿”å›å€¼æ˜¯ Promise å®šä¹‰æ–¹å¼ï¼š 123456789101112131415161718192021// å‡½æ•°å£°æ˜async function foo() &#123; &#125;// å‡½æ•°è¡¨è¾¾å¼const foo = async function () &#123; &#125;// å¯¹è±¡çš„æ–¹æ³•let o = &#123; async foo() &#123; &#125; &#125;// ç±»ä¸­å®šä¹‰class Storage &#123; constructor() &#123; this.cachePromise = caches.open("avatars") &#125; async getAvatar(name) &#123; const cache = await this.cachePromise return cache.match(`/avatars/$&#123;name&#125;.jpg`) &#125;&#125;const store = new Storage()store.getAvatar("jake").then().cach()// ç®­å¤´å‡½æ•°const foo = async () =&gt; &#123;&#125; é”™è¯¯å¤„ç†ï¼šå¦‚æœ await åé¢çš„å¼‚æ­¥æ“ä½œå‡ºé”™ï¼Œç­‰åŒäº async å‡½æ•°è¿”å›çš„ Promise å¯¹è±¡è¢« rejectã€‚æ•è·é”™è¯¯çš„ä¸¤ç§æ–¹å¼ï¼š 123456789101112async function foo() &#123; try &#123; await doSomething() &#125; catch (e) &#123; console.error(e) &#125;&#125;// å¦å¤–ä¸€ç§async function bar() &#123; await doSomething().catch(e =&gt; &#123; console.error(e) &#125;)&#125; å¯¹äºä¸ç›¸äº’ä¾èµ–çš„ç‹¬ç«‹æ“ä½œï¼Œä¸å»ºè®®åˆ†åˆ« awaitï¼Œé‚£æ ·å’ŒåŒæ­¥æœ‰æ¯›çº¿åŒºåˆ«ã€‚å»ºè®®ç”¨ä¸‹é¢çš„æ–¹å¼ï¼š 1234567let [foo, bar] = await Promise.all([foo(), bar()])// å¦å¤–ä¸€ç§å†™æ³•let fooPromise = foo()let bar Promise = bar()let fooResult = await fooPromiselet barResult = await barPromise å®ç°åŸç†ï¼šå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨åŒ…è£…åœ¨ä¸€èµ·ï¼š 12345678910async function fn(args) &#123; // ...&#125;// ç­‰ä»·äºfunction fn(args) &#123; return spaw(function *() &#123; //... &#125;)&#125; Class ES6 ä¸­çš„ class æœ¬è´¨ä¸Šè¿˜æ˜¯ Function å¯¹è±¡ï¼Œæ‰€æœ‰å®šä¹‰çš„æ–°æ–¹æ³•éƒ½æ˜¯åœ¨ prototype ä¸Šã€‚ä½†æ˜¯ï¼Œç±»å†…éƒ¨å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ä¸å¯æšä¸¾çš„ï¼Œè¿™ç‚¹å’Œ ES5 ä¸­ç›´æ¥ç»™ prototype æŒ‚è½½æ–¹æ³•ä¸åŒ æ¯ä¸ªç±»éƒ½å¿…è¦æœ‰ constructorï¼Œå¦‚æœæ²¡æœ‰ä¼šæœ‰ä¸€ä¸ªç©ºçš„ constructor å­˜åœ¨ ç±»å¿…é¡»ä½¿ç”¨ new è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ this æŒ‡å‘ï¼š ç±»çš„æ–¹æ³•å†…éƒ¨å¦‚æœå«æœ‰ thisï¼Œé»˜è®¤æŒ‡å‘ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯å¦‚æœå•ç‹¬ä½¿ç”¨ï¼Œå¯èƒ½å‡ºé”™ è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼Œå›ºå®š thisï¼š é‡‡ç”¨ bind ä½¿ç”¨ç®­å¤´å‡½æ•° é™æ€æ–¹æ³•ï¼š ä½¿ç”¨ static å…³é”®å­—ä¿®é¥° ä¸ä¼šè¢«å®ä¾‹ç»§æ‰¿å’Œè°ƒç”¨ï¼ˆè¿™ç‚¹å’Œ Python ä¸åŒï¼Œåœ¨ Python ä¸­ static æ–¹æ³•å¯ä»¥è¢«å®ä¾‹è°ƒç”¨ï¼Œè€Œä¸éœ€è¦é€šè¿‡ç±»åï¼‰ å¦‚æœé™æ€æ–¹æ³•ä¸­åŒ…å« thisï¼Œå…¶æŒ‡å‘çš„ä¸æ˜¯å®ä¾‹ï¼Œè€Œæ˜¯ç±» é™æ€æ–¹æ³•å¯ä»¥å’Œéé™æ€æ–¹æ³•é‡å çˆ¶ç±»çš„é™æ€æ–¹æ³•å¯ä»¥è¢«å­ç±»ç»§æ‰¿ ç»§æ‰¿ï¼š ä½¿ç”¨ extends å…³é”®å­— å•ç»§æ‰¿ å­ç±»å¿…é¡»è¦åœ¨è‡ªå®šä¹‰çš„ constructor æ–¹æ³•ä¸­è°ƒç”¨ superï¼Œè§¦å‘çˆ¶ç±»æ„é€ å‡½æ•°è°ƒç”¨åï¼Œæ‰å¯ä»¥ä½¿ç”¨ this åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦ç»§æ‰¿è‡ªæŸä¸ªç±»å®ä¾‹ï¼šReflect.getPrototypeOf(ColoredPoint) === Point super å…³é”®å­—ï¼š å½“ä½œå‡½æ•°ä½¿ç”¨ï¼Œä»£è¡¨è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶ super è°ƒç”¨åè¿”å›çš„æ˜¯åŸºç±»çš„å®ä¾‹ï¼‰ï¼Œåªèƒ½ç”¨äºæ„é€ å‡½æ•° å½“ä½œå¯¹è±¡ï¼Œåœ¨æ™®é€šæ–¹æ³•ä¸­æŒ‡å‘çˆ¶ç±»çš„åŸå‹å¯¹è±¡ï¼›åœ¨é™æ€æ–¹æ³•ä¸­ï¼ŒæŒ‡å‘çˆ¶ç±» ES6 è§„å®šï¼Œåœ¨å­ç±»æ™®é€šæ–¹æ³•ä¸­è°ƒç”¨ super.xxx() æ—¶ï¼Œæ–¹æ³•ä¸­çš„ this æŒ‡å‘çš„æ˜¯å½“å‰çš„å­ç±»å®ä¾‹ åœ¨å­ç±»é™æ€æ–¹æ³•ä¸­é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œå†…éƒ¨çš„ this æŒ‡å‘å½“å‰çš„å­ç±»ï¼Œè€Œéå­ç±»çš„å®ä¾‹ ES5 åŸç”Ÿæ„é€ å‡½æ•°æ— æ³•ç»§æ‰¿ï¼ˆå­ç±»æ— æ³•è·å¾—åŸç”Ÿæ„é€ å‡½æ•°çš„å†…éƒ¨å±æ€§ï¼‰ã€‚å…·ä½“åŸå› æ˜¯ ES5 ä¸­ï¼Œæ˜¯æ–°å»ºå­ç±»çš„å®ä¾‹å¯¹è±¡ thisï¼Œå†å°†çˆ¶ç±»çš„å±æ€§æ·»åŠ éƒ½å­ç±»ä¸Šï¼›è€Œçˆ¶ç±»çš„å†…éƒ¨å±æ€§æ— æ³•è·å–ï¼Œæ•…æ— æ³•ç»§æ‰¿ï¼š Boolean() Number() String() Array() Date() Function() RegExp() Error() Object() ES6 åˆ™å…è®¸ç»§æ‰¿ä¸Šè¿°åŸç”Ÿæ„é€ å‡½æ•°äº†ã€‚åŸå› æ˜¯ ES6 ä¸­ï¼Œæ˜¯å…ˆæ–°å»ºçˆ¶ç±»çš„å®ä¾‹å¯¹è±¡ thisï¼Œå†ç”¨å­ç±»çš„æ„é€ å‡½æ•°ä¿®é¥° thisï¼Œä½¿å¾—çˆ¶ç±»çš„è¡Œä¸ºå¯ä»¥ç»§æ‰¿ æ¨¡å— æ—©æœŸ JS æ— æ¨¡å—ç®¡ç†æœºåˆ¶ï¼Œä¸åˆ©äºå¼€å‘å¤§å‹é¡¹ç›® ç¤¾åŒºæä¾›äº† CommonJS å’Œ AMD ä¸¤ç§æ–¹æ¡ˆï¼Œåˆ†åˆ«ç”¨äºæœåŠ¡ç«¯å’Œæµè§ˆå™¨ç«¯ï¼›äºŒè€…éƒ½æ˜¯è¿è¡Œæ—¶ç¡®å®šæ¨¡å—ä¾èµ– ES6 æ¨¡å—çš„è®¾è®¡æ€æƒ³æ˜¯å°½å¯èƒ½é™æ€åŒ–ï¼Œç¼–è¯‘æ—¶ç¡®å®šæ¨¡å—ä¾èµ–å…³ç³»åŠè¾“å…¥è¾“å‡ºå˜é‡ import ä½¿ç”¨æ³¨æ„ï¼š import { foo } from &#39;mod&#39; å¯¼å…¥çš„å˜é‡éƒ½æ˜¯åªè¯»çš„ å¯¼å…¥çš„è·¯å¾„æ—¢å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ .js åç¼€å¯çœç•¥ å¦‚æœåªæ˜¯æ¨¡å—åç§°ï¼Œæ— è·¯å¾„åˆ™éœ€è¦é…ç½®æ–‡ä»¶å‘ŠçŸ¥ JS å¼•æ“å…·ä½“çš„æ¨¡å—ä½ç½® å…·æœ‰æå‡çš„æ•ˆæœ é™æ€æ‰§è¡Œï¼Œæ— æ³•ä½¿ç”¨è¡¨è¾¾å¼å’Œå˜é‡ Single æ¨¡å¼ï¼Œæœ‰ç¼“å­˜æœºåˆ¶ æ•´ä½“åŠ è½½å¸¦åˆ«åï¼šimport * as mod from &#39;longNameMod&#39; export default æœ¬è´¨ä¸Šæ˜¯è¾“å‡ºä¸€ä¸ªå«åš default çš„å˜é‡å’Œæ–¹æ³•ï¼Œç„¶åç³»ç»Ÿå…è®¸é‡å åœ¨ä¸€æ¡è¯­å¥ä¸­åŒæ—¶è¾“å…¥é»˜è®¤æ–¹æ³•å’Œå…¶å®ƒæ¥å£ï¼šimport _, { each } from &#39;lodash&#39; å¤åˆå†™æ³•ï¼šexport { foo, bar } from &#39;my_mod&#39;ï¼Œæ³¨æ„ä¸ä¼šåœ¨å½“å‰æ¨¡å—å¯¼å…¥è¿™ä¸¤ä¸ªå˜é‡ï¼Œè€Œåªæ˜¯è½¬å‘åˆ°å¤–é¢äº† æ¨¡å—åŠ è½½è§„åˆ™ æµè§ˆå™¨ä¸­å¯ä½¿ç”¨çš„æ–¹å¼ï¼š &lt;script src=&quot;path/to/foo.js&quot; [async/defer]/&gt; ES6 æ¨¡å—åŠ è½½ï¼ˆé»˜è®¤å°±æ˜¯ defer æ¨¡å¼ï¼‰ï¼š&lt;script type=&quot;module&quot; src=&quot;./mod.js&quot;/&gt; &lt;script type=&quot;model&quot;&gt; /å¯ä»¥æ­£å¸¸å†™ import xx from xxx è¿™ç§ï¼Œæ¨¡å—ä½œç”¨åŸŸ/` ES6 ä¸ CommonJS å‰è€…è¾“å‡ºæ˜¯å€¼å¼•ç”¨ï¼Œåè€…è¾“å‡ºçš„æ˜¯å€¼æ‹·è´ å‰è€…æ˜¯ç¼–è¯‘æ—¶è¾“å‡ºæ¥å£ï¼Œåè€…æ˜¯è¿è¡Œæ—¶åŠ è½½ å‰è€…æ˜¯åŠ¨æ€å¼•ç”¨ï¼Œåè€…ä¼šç¼“å­˜å€¼ åœ¨ Node ä¸­ import æ˜¯å¼‚æ­¥åŠ è½½ ES6 æ¨¡å—ä¸­ï¼Œé¡¶å±‚ this æŒ‡å‘ undefinedï¼›åè€…åˆ™æŒ‡å‘å½“å‰æ¨¡å— äºŒè¿›åˆ¶æ•°ç»„ï¼ˆç±»æ•°ç»„ï¼‰ äºŒè¿›åˆ¶æ•°ç»„ç»„æˆå¯¹è±¡ï¼š ArrayBuffer å¯¹è±¡ï¼šä»£è¡¨å†…å­˜ä¸­çš„ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯é€šè¿‡ã€Œè§†å›¾ã€æ“ä½œ TypedArray è§†å›¾ï¼šå¯ç”¨äºè¯»å†™ç®€å•çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒåŒ…æ‹¬ 9 ç§ç±»å‹è§†å›¾ï¼š Int8 Uint8 Uint8Cï¼šè‡ªåŠ¨è¿‡æ»¤æº¢å‡ºï¼ŒDataView è§†å›¾ä¸æ”¯æŒ Int16 Uint16 Int32 Uint32 Float32 Float64 DateView è§†å›¾ï¼šå¯è‡ªå®šä¹‰å¤åˆæ ¼å¼çš„è§†å›¾ï¼Œè¯»å†™å¤æ‚ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ® å‚è€ƒ ECMAScript 6 å…¥é—¨ ES5 å’Œ ES6 ä¸­çš„ç»§æ‰¿ Babel]]></content>
      <categories>
        <category>å‰ç«¯</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
        <tag>JavaScript</tag>
        <tag>ES6</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaScript ES5 å…¥é—¨ç¬”è®°]]></title>
    <url>%2F2019%2F06%2F23%2Fjavascript-es5-learning-note%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ€è¿‘æŠ½ç©ºå­¦ä¹ äº†ä¸‹ JavaScript è¯­è¨€ï¼Œå½“ç„¶è¿˜æ˜¯å…¥é—¨çº§åˆ«çš„é‚£ç§ã€‚å­¦ä¹ è¿‡ç¨‹ä¸­ä¹Ÿåšäº†äº›ç¬”è®°ã€‚æ€»çš„æ¥è¯´ï¼ŒES5 å­¦å®Œåï¼Œå¯¹ JavaScript æœ¬èº«äº†è§£äº†å¤§æ¦‚ï¼Œè¯­è¨€æœ¬èº«è®¾è®¡ä¸Šä¹Ÿå­˜åœ¨ä¸€äº›å‘ï¼Œæ‰€ä»¥æ­é…ã€ŠJavaScript ç²¾ç²¹ã€‹è¿™æœ¬ä¹¦çœ‹çœ‹ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£æœ‰å“ªäº›æ¯”è¾ƒå¥½çš„å†™æ³•é¿å…è¸©å‘ã€‚ åŸºç¡€ç¯‡ åˆ¤æ–­æ˜¯å¦ä¸ºæœªå®šä¹‰çš„å˜é‡ï¼š 123456789// é”™è¯¯çš„å†™æ³•if (v) &#123;// ...&#125;// ReferenceError: v is not defined// æ­£ç¡®çš„å†™æ³•if (typeof v === "undefined") &#123;// ...&#125; typeof null ä¹Ÿæ˜¯ object ä½¿ç”¨ instanceof å¯ä»¥åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„ï¼šv instanceof Array null å’Œ undefined éå¸¸ç±»ä¼¼ï¼Œç”šè‡³ null == undefined éƒ½æˆç«‹ï¼Œä½†æ˜¯å®ƒä»¬åœ¨ JavaScript ä¸­è¿˜æ˜¯æœ‰åŒºåˆ«ï¼š null è¡¨ç¤ºç©ºå¯¹è±¡ï¼Œå¯è½¬æ¢ä¸ºæ•°å€¼ 0ï¼šNumber(null) //0 undefined è¡¨ç¤ºæ²¡æœ‰å®šä¹‰çš„åŸå§‹å€¼ï¼Œè½¬æ¢ä¸ºæ•°å€¼ä¸º NaN JS ä¸­æ‰€æœ‰æ•°å­—éƒ½æ˜¯ä»¥ 64 ä½æµ®ç‚¹æ•°å­˜å‚¨çš„ï¼Œå¯¹äºæŸäº›è¿ç®—ï¼Œåªèƒ½ç”¨æ•´æ•°ï¼ŒJS ä¼šå°†æ•°å­—è½¬æ¢ä¸º 32 ä½æ•´æ•°å†åšè¿ç®— æ•°å€¼è®¡ç®—æ¯”è¾ƒéœ€è¦æ³¨æ„ï¼Œå› ä¸ºæµ®ç‚¹æ•°æœ‰ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ã€‚æ¯”å¦‚ï¼š0.3-0.2 !== 0.2-0.ã€‚ JavaScript å¯¹ 15 ä½çš„åè¿›åˆ¶æ•°éƒ½å¯ä»¥ç²¾ç¡®å¤„ç†ã€‚ å¯¹äºç ç‚¹åœ¨ U+10000 åˆ° U+10FFFF ä¹‹é—´çš„å­—ç¬¦ï¼ŒJavaScript æ€»æ˜¯è®¤ä¸ºå®ƒä»¬æ˜¯ä¸¤ä¸ªå­—ç¬¦ï¼ˆlength å±æ€§ä¸º 2ï¼‰ base64 è½¬æ¢ï¼šbtoa, atob å±æ€§åˆ é™¤ deleteï¼š ä¸èƒ½åˆ é™¤å¯¹è±¡æœ¬èº« æ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ï¼Œåˆ é™¤æ€»ä¼šè¿”å› true ç»§æ‰¿çš„å±æ€§ä¸èƒ½åˆ é™¤ï¼Œè™½ç„¶ä¹Ÿä¼šè¿”å› true ä½¿ç”¨ defineProperty å®šä¹‰çš„æ ‡è®°ä¸ºä¸å¯åˆ é™¤çš„å±æ€§ï¼Œdelete è¿”å› false å¯¹è±¡å±æ€§å­˜åœ¨æ–°åˆ¤æ–­ï¼š in å¯ä»¥åˆ¤æ–­ï¼Œä½†æ˜¯ä¸èƒ½åŒºåˆ†æ˜¯ç»§æ‰¿çš„è¿˜æ˜¯è‡ªèº«æ‹¥æœ‰çš„ hasOwnProperty å¯ä»¥å¼¥è¡¥ä¸Šè¿°ç¼ºç‚¹ for...in ç”¨äºéå†å¯¹è±¡çš„å±æ€§ï¼š å¯¹è±¡å±æ€§å¿…é¡»æ˜¯å¯éå†çš„ï¼ˆenumerableï¼‰ å¯¹äºç»§æ‰¿çš„å±æ€§ä¹Ÿä¼šè¢«éå†åˆ°ï¼Œå¦‚æœä¸æƒ³è¦ï¼Œå¯ä»¥æ­é… hasOwnProperty è¿‡æ»¤æ‰ ä¸€èˆ¬ä¹Ÿå¯ä»¥ä½¿ç”¨ Object.keys(o).map(k =&gt; { /*do stuff*/ } å‡½æ•°å£°æ˜å‡ ç§æ–¹å¼ï¼š function func_name(params) {} let say = function (word) {}ï¼ŒåŒ¿åå‡½æ•° let say = function f(word) { console.log(f) }ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„å‡½æ•°å f åªå¯ä»¥åœ¨è¯¥å‡½æ•°å†…éƒ¨è®¿é—®åˆ°ï¼Œæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š éå†åœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨è‡ªå·± æ–¹ä¾¿è°ƒè¯•ï¼Œæ’é”™æ—¶çœ‹åˆ°å…·ä½“çš„å‡½æ•°åï¼Œè€Œä¸å†æ˜¯åŒ¿åå‡½æ•° ä½¿ç”¨ Function æ„é€ å‡½æ•°ï¼Œæ³¨æ„ï¼Œè¿”å›çš„å‡½æ•°çš„ type çš„ç¡®ä¹Ÿæ˜¯ functionï¼ˆä¸æ¨èä½¿ç”¨ï¼‰ JS å¼•æ“å°†å‡½æ•°åè§†ä¸ºå˜é‡åï¼Œæ‰€ä»¥ä¹Ÿå­˜åœ¨ã€Œå‡½æ•°åæå‡ã€çš„æ•ˆæœï¼Œå› æ­¤ï¼Œåœ¨å‡½æ•°å£°æ˜ä½ç½®çš„ä¸Šæ–¹è°ƒç”¨ä¹Ÿä¸ä¼šå‡ºé”™ å‡½æ•°æ‰§è¡Œæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸï¼Œæ˜¯å®šä¹‰æ—¶çš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯è°ƒç”¨æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸ arguments å¯¹è±¡å¯ä»¥è·å–åˆ°å‡½æ•°ä¼ å…¥çš„å‚æ•°å€¼ï¼š è¯¥å¯¹è±¡ä¸æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åƒ slice, forEach æ–¹æ³•å°±ä¸å­˜åœ¨ å¦‚æœæƒ³è¦è½¬æ¢æˆæ•°ç»„ï¼Œä¸€ç§æ–¹å¼å°±æ˜¯ï¼šlet args = Array.prototype.slice.call(arguments) åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä¸èƒ½é€šè¿‡ arguments.callee è°ƒç”¨å‡½æ•°è‡ªèº«ï¼›å¯¹ arguments çš„ä¿®æ”¹ä¸ä¼šå¯¹åŸå§‹ä¼ å…¥çš„å‚æ•°äº§ç”Ÿå½±å“ ç«‹å³è°ƒç”¨å‡½æ•°çš„ä¸¤ç§æ–¹å¼ï¼š (function () {console.log(10)})() (function () {console.log(10)}()) æ•°ç»„æ˜¯ç‰¹æ®Šçš„å¯¹è±¡ï¼Œå…¶é”®åå°±æ˜¯ä¸€ç»„æ•°å­—ï¼Œå¯ä»¥é€šè¿‡ Object.keys è¿”å›æ‰€æœ‰çš„é”®å æ•°ç»„çš„ length å±æ€§ä¸è¿‡æ»¤ç©ºä½ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ length å±æ€§è¿›è¡Œæ•°ç»„éå†ï¼Œä¸€å®šè¦éå¸¸å°å¿ƒã€‚å¦‚ delete arr[3] ä¹‹åï¼Œä¾ç„¶ä¸ä¼šå½±å“ lengthï¼Œåªæ˜¯äº§ç”Ÿäº†ä¸€ä¸ªç©ºä½ï¼›æ‰€ä»¥å¯ä»¥ä½¿ç”¨ forEach æ›¿ä»£ï¼Œå¯ä»¥è¿‡æ»¤ç©ºä½ï¼ˆä½†ç©ºä½ä¸ç­‰åŒäº undefinedï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ var a = [, , ,] è¡¨ç¤ºçš„æ¯ä¸ªä½ç½®éƒ½æ˜¯ç©ºä½ï¼›var a = [undefined, undefined] åˆ™æ˜¯å¯éå†åˆ°çš„ï¼Œåªæ˜¯å€¼ä¸º undefined è€Œå·² ç±»ä¼¼æ•°ç»„çš„æ•°ç»„ï¼ˆArray like objectï¼‰ï¼š å¯¹è±¡æ‹¥æœ‰ç±»ä¼¼ä¸‹é¢çš„å®šä¹‰ï¼š12345678// æ‰€æœ‰çš„é”®éƒ½æ˜¯æ•°å­—// å¸¦æœ‰ length å±æ€§var obj = &#123; 0: &apos;a&apos;, 1: &apos;b&apos;, 2: &apos;c&apos;, length: 3&#125;; å‡½æ•°çš„ argumentsï¼Œå­—ç¬¦ä¸²ï¼Œè¿˜æœ‰å¤šæ•°çš„ DOM å…ƒç´ éƒ½æ˜¯ array-like çš„å¯¹è±¡ã€‚å¯ä»¥ä½¿ç”¨ Array.prototype.slice.call(xx) è½¬æ¢æˆæ•°ç»„ void è¿ç®—ç¬¦ï¼šä½œç”¨æ˜¯æ‰§è¡Œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¸è¿”å›ä»»ä½•å€¼ï¼ˆè¿”å› undefinedï¼‰ï¼š æ¨èç”¨æ³•ï¼švoid (x = 5) ä½¿ç”¨åœºæ™¯ï¼Œé˜²æ­¢ç½‘é¡µè·³è½¬ï¼š&lt;a href=&quot;javascript: void f()&quot;&gt;æ–‡å­—&lt;/a&gt; é€—å·è¿ç®—ç¬¦è¿”å›æœ€åä¸€ä¸ªå€¼ &#39;a&#39;, &#39;b&#39; // &quot;b&quot; è¯­æ³•ä¸“é¢˜ Number ç”¨äºå¼ºåˆ¶è½¬æ¢æˆæ•°å€¼ç±»å‹ï¼Œä¸ parseInt ç›¸æ¯”ï¼Œè½¬æ¢è¦ä¸¥æ ¼å¾—å¤šï¼Œåªè¦é‡åˆ°ä¸å¯è½¬æ¢ä¸ºæ•°å€¼çš„å­—ç¬¦ï¼Œè½¬æ¢å°±å¤±è´¥ Boolean æ‰€æœ‰å¯¹è±¡ï¼ˆå«ç©ºå¯¹è±¡ï¼‰çš„è½¬æ¢ç»“æœéƒ½æ˜¯ trueï¼Œå¦‚ Boolean(new Boolean(false)) // true JS ä¸­æ‰€æœ‰æŠ›å‡ºçš„é”™è¯¯éƒ½æ˜¯ new Error(xx) å‡ºæ¥çš„ï¼ŒError çš„åŸºæœ¬å±æ€§ï¼š messageï¼šé”™è¯¯æç¤ºä¿¡æ¯ï¼ˆå¿…é¡»ï¼‰ nameï¼šé”™è¯¯åç§°ï¼ˆéæ ‡å‡†å±æ€§ï¼Œçœ‹ JS å¼•æ“ï¼‰ stackï¼šé”™è¯¯çš„å †æ ˆï¼ˆéæ ‡å‡†å±æ€§ï¼Œçœ‹ JS å¼•æ“ï¼‰ æ´¾ç”Ÿé”™è¯¯å¯¹è±¡ï¼š SyntaxError ReferenceError RangeErrorï¼šæ•°ç»„é•¿åº¦ä¸ºè´Ÿæ•°ï¼›Number å¯¹è±¡çš„æ–¹æ³•å‚æ•°è¶…å‡ºèŒƒå›´ï¼›å‡½æ•°å †æ ˆè¶…è¿‡æœ€å¤§å€¼ TypeError URIError throw å¯ä»¥æŠ›å‡ºä»»æ„ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”åœ¨ throw çš„ä½ç½®å°±ä¸­æ–­äº†æ‰§è¡Œï¼ŒJS å¼•æ“ä¼šæ¥æ”¶åˆ°æŠ›å‡ºçš„ä¿¡æ¯ console ä¸€äº›é‡è¦çš„æ–¹æ³•ï¼š info error debug warn table log dirï¼šç±»ä¼¼ inspect å¯ä»¥åœ¨éœ€è¦çš„åœ°æ–¹åŠ  debugger ä½œä¸ºæ–­ç‚¹ï¼Œç”¨äºè°ƒè¯• æ ‡å‡†åº“ Object() å‡½æ•°å¯ä»¥å°†ä»»æ„å€¼è½¬æ¢æˆå¯¹è±¡ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯åŸå§‹ç±»å‹å€¼ï¼Œåˆ™ä¼šè½¬æ¢æˆå…¶åŒ…è£…å¯¹è±¡çš„å®ä¾‹ï¼›å¦‚æœå…¥å‚å·²ç»æ˜¯å¯¹è±¡äº†ï¼Œåˆ™ä¸ä¼šè½¬æ¢ å¯ä»¥åˆ©ç”¨ä¸Šè¿°ç‰¹æ€§åˆ¤æ–­å˜é‡æ˜¯å¦ä¸ºå¯¹è±¡ï¼švalue === Object(value) Object.keys() é™æ€æ–¹æ³•å¯ä»¥è¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§åï¼ˆéç»§æ‰¿ï¼Œä¸”å¯æšä¸¾ï¼‰ï¼Œè¯¥éå†æ–¹æ³•ä¼˜å…ˆ Object.getOwnPropertyNames() é™æ€æ–¹æ³•åˆ™ä¼šè¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§åï¼ˆåŒ…æ‹¬ä¸å¯æšä¸¾çš„ï¼‰ Object.prototype.xxx å®ä¾‹æ–¹æ³•ï¼š valueOf()ï¼šè¿”å›å¯¹è±¡çš„å€¼ï¼Œé»˜è®¤ä¸ºè‡ªèº« toString()ï¼šè¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º Object.prototype.toString.call(value) è¿”å› [object &lt;TypeName&gt;]ï¼Œç¬¬äºŒä¸ªå…ƒç´ å¯ä»¥å¾—åˆ°å…·ä½“çš„å€¼ç±»å‹ JS æä¾›äº†å†…éƒ¨æ•°æ®ç»“æ„ï¼Œæè¿°å¯¹è±¡çš„å±æ€§ï¼Œæ§åˆ¶å…¶è¡Œä¸ºï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š 12345678&#123; value: 123, writeable: false, enumerable: true, configurable: false, get: undefined, set: undefined&#125; Object.getOwnPropertyDescriptor(obj, &#39;a&#39;) å¯ä»¥è·å–å±æ€§æè¿°å¯¹è±¡ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå±æ€§è¢«è®¾ç½®ä¸º writeable=false åï¼Œç»§æ‰¿è€…å°†æ— æ³•é‡æ–°å®šä¹‰åŒåå±æ€§ï¼›é™¤éå¯ä»¥é€šè¿‡è¦†ç›–å±æ€§æè¿°å¯¹è±¡æ¥ç»•è¿‡é™åˆ¶ å¦‚æœå±æ€§çš„ enumerable ä¸º falseï¼Œåˆ™æœ‰ä¸‰ç§æ“ä½œä¸èƒ½å–åˆ°è¯¥å±æ€§ï¼š for...in Object.keysï¼šæ— æ³•è·å–å¯¹è±¡ç»§æ‰¿çš„å±æ€§ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ getOwnPropertyNames JSON.stringify configurableï¼šæ§åˆ¶æ˜¯å¦å¯ä»¥ä¿®æ”¹æè¿°ç¬¦å±æ€§ï¼Œå¹¶ä¸”å½“ configurable=fasle æ—¶ï¼Œæ— æ³•åˆ é™¤ åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºæ•°ç»„ï¼šArray.isArray é¢å‘å¯¹è±¡ JavaScript ä¸­çš„å¯¹è±¡ä½“ç³»ï¼Œæ˜¯åŸºäºæ„é€ å‡½æ•° constructor å’ŒåŸå‹é“¾ prototype çš„ã€‚æ„é€ å‡½æ•°å°±æ˜¯å¯¹è±¡ç”Ÿæˆçš„ã€Œæ¨¡æ¿ã€ æ„é€ å‡½æ•°ç‰¹ç‚¹ï¼š å†…éƒ¨ä½¿ç”¨ thisï¼ŒæŒ‡å‘ç”Ÿæˆçš„å¯¹è±¡å®ä¾‹ éœ€è¦é…åˆ new å…³é”®å­— new å¹²äº†ä»€ä¹ˆï¼š æ–°å»ºç©ºå¯¹è±¡ï¼Œä½œä¸ºè¦è¿”å›çš„å¯¹è±¡ å°†ç©ºå¯¹è±¡çš„ __proto__ æŒ‡å‘æ„é€ å‡½æ•°çš„ prototype å°†è¯¥ç©ºå¯¹è±¡èµ‹å€¼ç»™å‡½æ•°å†…éƒ¨çš„ this å…³é”®å­— æ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„ä»£ç  å‡½æ•°å†…éƒ¨å¯ä½¿ç”¨ new.target åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº† new è°ƒç”¨æ„é€ å‡½æ•° this åœ¨å‡½æ•°ä½“å†…éƒ¨ï¼ŒæŒ‡å‘å½“å‰çš„è¿è¡Œç¯å¢ƒ å¦‚æœ this æ‰€åœ¨çš„æ–¹æ³•ä¸åœ¨å¯¹è±¡çš„ç¬¬ä¸€å±‚ï¼Œè¿™æ—¶ this åªæ˜¯æŒ‡å‘å½“å‰ä¸€å±‚çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šç»§æ‰¿æ›´ä¸Šé¢çš„å±‚ å‡½æ•°å®ä¾‹çš„ call æ–¹æ³•å¯ä»¥æŒ‡å®š this æŒ‡å‘çš„ç¯å¢ƒï¼Œæ­¤å¤–å¯ä»¥è·³è¿‡åŒåå‡½æ•°è¦†ç›–ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹çš„å‡½æ•°ï¼›appy å’Œ call ç±»ä¼¼ï¼Œåªæ˜¯æ¥æ”¶ä¸€ä¸ªåˆ—è¡¨å‚æ•° bind ä¹Ÿå¯ä»¥ç»‘å®šå¯¹è±¡ï¼Œå˜æ¢ this æŒ‡å‘ JS ç»§æ‰¿æœºåˆ¶çš„æ ¸å¿ƒï¼šåŸå‹ä¸­æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½å¯ä»¥è¢«å¤šä¸ªå®ä¾‹å…±äº« instanceof è¿ç®—ç¬¦ï¼š åªèƒ½ç”¨äºéåŸå§‹ç±»å‹å¯¹è±¡ å¯¹è±¡çš„åŸå‹ prototype å‡ä¸º null æ—¶å¤±æ•ˆ undefined instanceof Object å’Œ null instanceof Object å‡ä¸º false å¼‚æ­¥ Promise çš„å›è°ƒå‡½æ•°ä¸æ˜¯æ­£å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼Œè€Œæ˜¯å¾®ä»»åŠ¡ã€‚å‰è€…ä¼šè¿½åŠ åˆ°ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯ï¼Œè€Œå¾®ä»»åŠ¡åˆ™è¿½åŠ åˆ°æœ¬è½®äº‹ä»¶å¾ªç¯ã€‚æ‰€ä»¥å¾®ä»»åŠ¡æ‰§è¡Œè¦æ—©äºå¸¸è§„å¼‚æ­¥ä»»åŠ¡ã€‚ setTimeout(f, 0) å¯ä»¥è®©ä»»åŠ¡åœ¨ä¸‹è½®äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œ DOM å…ƒç´ çš„ hidden å±æ€§åªæœ‰åœ¨ CSS æ²¡æœ‰æ˜ç¡®è®¾å®šå½“å‰å…ƒç´ çš„å¯è§æ€§æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯ CSS çš„ display ç”¨äºå¯è§æ€§æ§åˆ¶çš„ä¼˜å…ˆçº§é«˜äºå…ƒç´ è‡ªèº«çš„ hidden å±æ€§ ç½‘é¡µå…ƒç´ å¯ä»¥è‡ªå®šä¹‰ data-* å±æ€§ï¼Œæ·»åŠ æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ .dataset è¿”å›æ•°æ®å¯¹è±¡ ä¸ºé˜²æ­¢é­å—æ”»å‡»ï¼Œå¯¹äºæ–‡æœ¬å†…å®¹ï¼Œå»ºè®®ä½¿ç”¨ textContent æ›¿ä»£ innerHTML è®¾ç½®æ–‡æœ¬ CSS CSS è´Ÿè´£è§†è§‰æ•ˆæœï¼›JavaScript è´Ÿè´£ä¸ç”¨æˆ·çš„è¡Œä¸ºäº’åŠ¨ å¯ä»¥é€šè¿‡ style å±æ€§è®¾ç½® CSS æ ·å¼ CSSStyleDeclaration å¯¹è±¡ç”¨äºæ“ä½œå…ƒç´ çš„æ ·å¼ï¼ŒåŒ…æ‹¬ï¼š å…ƒç´ çš„ style å±æ€§ CSSStyle å®ä¾‹çš„ style å±æ€§ window.getComputedStyle() è¿”å›å€¼ï¼ˆå…ƒç´ çš„å…¨éƒ¨æ ·å¼éœ€è¦å®ƒè·å–åˆ°ï¼‰ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCSSStyleDeclaration çš„å±æ€§åå’ŒåŸç”Ÿ CSS è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼Œå‘½åéœ€è¦ä¿®æ”¹ï¼Œå¦‚ backgroud-color -&gt; backgroudColorï¼›å¦‚æœæ˜¯ JS çš„ä¿ç•™å­—ï¼Œåˆ™éœ€è¦åŠ ä¸Š css å‰ç¼€ å±æ€§æ“ä½œï¼š setProperty removeProperty DOM å˜åŠ¨ç›‘æ§ Mutation Observer APIï¼šDOM çš„å˜åŠ¨ï¼ˆèŠ‚ç‚¹å¢å‡ã€å±æ€§å˜åŠ¨ã€æ–‡æœ¬å†…å®¹å˜åŠ¨ï¼‰ï¼Œéƒ½å¯ä»¥é€šè¿‡è¯¥ API è·å¾—é€šçŸ¥ ä¸äº‹ä»¶çš„åŒºåˆ«ï¼š MO äº‹ä»¶æ˜¯åœ¨ DOM å˜åŠ¨æ—¶å¼‚æ­¥è§¦å‘ï¼Œå¹¶ä¸”æ˜¯ç­‰åˆ°å½“å‰æ‰€æœ‰ DOM æ“ä½œéƒ½ç»“æŸæ‰è§¦å‘ äº‹ä»¶åˆ™æ˜¯åŒæ­¥è§¦å‘ï¼ŒDOM å˜åŠ¨ç«‹åˆ»è§¦å‘ æ€»ç»“æ¥è¯´ï¼š ç­‰å¾…æ‰€æœ‰è„šæœ¬ä»»åŠ¡å®Œæˆåï¼Œæ‰ä¼šè§¦å‘ æŠŠ DOM å˜åŠ¨è®°å½•å°è£…æˆä¸€ä¸ªæ•°ç»„å¤„ç†ï¼Œè€Œéæ¯æ¡éƒ½åˆ†åˆ«å¤„ç† æ—¢å¯ä»¥è§‚å¯Ÿ DOM æ‰€æœ‰ç±»å‹å˜åŠ¨ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè§‚å¯ŸæŸç±»å˜åŠ¨ ç”¨æ³•ï¼š 12345const observer = new MutationObserver((mutations, observer) =&gt; &#123;&#125;)// æŒ‡å®šç›‘å¬çš„å…ƒç´ å’Œç±»å‹const article = document.querySelector("article")observer.observe(article, &#123;'childList': true, 'attritubes': true&#125;) äº‹ä»¶ DOM çš„äº‹ä»¶æ“ä½œï¼ˆç›‘å¬ã€è§¦å‘ï¼‰ï¼Œéƒ½æ˜¯ EventTarget ä¸­å®šä¹‰çš„ã€‚ä¸»è¦æ¥å£å¦‚ä¸‹ï¼š addEventListener removeEventListener dispatchEvent HTML ä¸­å¯ä»¥ç›´æ¥åœ¨å…ƒç´ å±æ€§ä¸­ï¼Œå®šä¹‰æŸäº›ç›‘å¬ä»£ç ã€‚å¦‚ onloadï¼Œè¿™ç±»ç›‘å¬ä»£ç åªåœ¨å†’æ³¡é˜¶æ®µè§¦å‘ å…ƒç´ çš„ onclick å±æ€§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç›‘å¬å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å†’æ³¡é˜¶æ®µè§¦å‘ äº‹ä»¶ä¼ æ’­ï¼š ç¬¬ä¸€é˜¶æ®µï¼šä» window å¯¹è±¡ä¼ å¯¼åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼ˆä¸Šå±‚ä¼ åˆ°åº•å±‚ï¼‰ï¼Œå³ä¸ºã€Œæ•è·é˜¶æ®µã€ï¼ˆcapture phaseï¼‰ ç¬¬äºŒé˜¶æ®µï¼šä»ç›®æ ‡èŠ‚ç‚¹ä¸Šè§¦å‘ï¼Œå«åšã€Œç›®æ ‡é˜¶æ®µã€ï¼ˆtarget phaseï¼‰ ç¬¬ä¸‰é˜¶æ®µï¼šä»ç›®æ ‡èŠ‚ç‚¹ä¼ å¯¼å› window å¯¹è±¡ï¼ˆä»åº•å±‚ä¼ å›ä¸Šå±‚ï¼‰ï¼Œå«åšã€Œå†’æ³¡é˜¶æ®µã€ï¼ˆbubbling phaseï¼‰ e.StopPropagation åˆ™æ˜¯ä¼šé˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œä½†ä¸ä¼šå¤„ç†å…¶å®ƒçš„ç›‘å¬äº‹ä»¶ e.stopImmediatePropagation ä¼šå½»åº•å–æ¶ˆåŒåçš„æ—¶é—´ ç½‘é¡µä¸­é™¤äº†å…ƒç´ èŠ‚ç‚¹é»˜è®¤ä¸å¯ä»¥æ‹–æ‹‰ï¼Œå…¶å®ƒï¼ˆå›¾ç‰‡ã€é“¾æ¥ã€é€‰ä¸­çš„æ–‡å­—ï¼‰éƒ½æ˜¯å¯ä»¥æ‹–æ‹‰çš„ï¼Œå¯é€šè¿‡å°†å…ƒç´ èŠ‚ç‚¹çš„ draggable å±æ€§è®¾ç½®ä¸º true å®ç° ä¸€æ—¦æŸä¸ªå…ƒç´ èŠ‚ç‚¹è¢«è®¾ç½®ä¸ºå¯æ‹–æ‹½åï¼Œå°±æ— æ³•é€šè¿‡é¼ æ ‡é€‰ä¸­èŠ‚ç‚¹å†…éƒ¨çš„æ–‡å­—æˆ–å­èŠ‚ç‚¹äº† æµè§ˆå™¨å¯¹è±¡ åµŒå…¥è„šæœ¬æ—¶ï¼Œ&lt;script&gt; å…ƒç´ çš„ type å±æ€§é»˜è®¤ä¸º text/javascriptï¼Œæ–°æµè§ˆå™¨å¯ä»¥å†™æˆ application/javascriptã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸å¡«å†™ã€‚å¦å¤–ï¼Œintegrity å±æ€§å¯ä»¥è®¾ç½®è„šæœ¬çš„ SHA256 ç­¾åï¼Œå¯¹äºéæ³•è„šæœ¬æµè§ˆå™¨ä¼šæ‹’ç»åŠ è½½ async å’Œ defer åŒæ—¶å­˜åœ¨ï¼Œåˆ™åè€…ä¸èµ·ä½œç”¨ window.navigator æŒ‡å‘åŒ…å«æµè§ˆå™¨å’Œç³»ç»Ÿä¿¡æ¯çš„ Navigator å¯¹è±¡ï¼Œå¯ä»¥äº†è§£ç”¨æˆ·çš„ç¯å¢ƒä¿¡æ¯ Cookie æ˜¯æœåŠ¡å™¨ä¿å­˜åœ¨æµè§ˆå™¨çš„ä¸€å°æ®µæ–‡æœ¬ä¿¡æ¯ï¼Œæ¯ä¸ª Cookie çš„å¤§å°ä¸€èˆ¬ä¸è¶…è¿‡ 4KBï¼Œæ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨ï¼Œéƒ½ä¼šé™„å¸¦è¯¥ä¿¡æ¯ Cookie åŒ…æ‹¬çš„ä¿¡æ¯ï¼š åå­— å€¼ åˆ°æœŸæ—¶é—´ æ‰€å±åŸŸåï¼ˆé»˜è®¤å½“å‰åŸŸåï¼‰ ç”Ÿæ•ˆçš„è·¯å¾„ï¼ˆé»˜è®¤å½“å‰ç½‘ç«™ï¼‰ æµè§ˆå™¨çš„å®‰å…¨åŸºç¡€æ˜¯ã€ŒåŒæºæ”¿ç­–ã€ï¼ˆsame-origin policyï¼‰ åŒæºçš„å«ä¹‰ï¼š ç›¸åŒçš„åè®® ç›¸åŒçš„åŸŸå ç›¸åŒçš„ç«¯å£ éåŒæºçš„é™åˆ¶ï¼š æ— æ³•è¯»å–éåŒæºç½‘é¡µçš„ Cookie, LocalStorage å’Œ IndexedDB æ— æ³•æ¥è§¦éåŒæºç½‘é¡µçš„ DOM æ— æ³•å‘éåŒæºåœ°å€å‘é€ AJAX è¯·æ±‚ï¼ˆå³ä¾¿å‘é€ï¼Œæµè§ˆå™¨ä¹Ÿä¼šæ‹’ç»æ¥å—å“åº”ï¼‰ document.domain è®¾ç½®å¯å…±äº« Cookieï¼Œé€‚ç”¨äº ifame å’Œ Cookieï¼Œå¯¹äº LocalStorage å’Œ IndexedDB æ— æ•ˆï¼›æ­¤å¤–ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨è®¾ç½® Cookie æ—¶å°±æŒ‡å®šå¥½æ‰€å±ä¸€çº§åŸŸåï¼š.example.comï¼Œä¹Ÿå¯ä»¥å¯¹å­åŸŸåè¾¾åˆ°å…±äº« Cookie çš„ç›®çš„ å¯¹äºå®Œå…¨ä¸åŒæºçš„çª—å£ï¼Œæƒ³è¦é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼š fragment identifierï¼šç‰‡æ®µæ ‡è¯†ç¬¦ã€‚http://example.com/x.html#fragment åªæ˜¯æ”¹å˜ #fragment ä¸ä¼šå¯¼è‡´ç½‘é¡µåˆ·æ–°ï¼Œå±äºç ´è§£æ— æ³•é€šä¿¡ä¹‹æ³• H5 æä¾›äº†æ–°çš„ postMessage æ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œç›‘å¬æ–¹å¯ä»¥ç›‘å¬ message äº‹ä»¶è·å–æ¶ˆæ¯ AJAX çªç ´åŒæºé™åˆ¶çš„æ–¹æ³•ï¼š JSONP WebSocket CORS (Cross-Origin Resource Sharing) CORS é€šä¿¡ï¼š W3C æ ‡å‡†ï¼Œå…è®¸æµè§ˆå™¨è·¨åŸŸè¯·æ±‚ è¯¦ç»†ä»‹ç» åŒºåˆ†ç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ï¼Œæµç¨‹ä¸åŒ ç®€å•è¯·æ±‚ä¸­ï¼ŒOrigin Header å¾ˆé‡è¦ éç®€å•è¯·æ±‚ï¼Œå…ˆè¿›è¡Œ /OPTIONS é¢„å…ˆæ£€æŸ¥ï¼Œç„¶ååç»­æµç¨‹ç±»ä¼¼ç®€å•è¯·æ±‚ Storage æ¥å£ï¼š sessionStorageï¼šä¿å­˜çš„æ•°æ®ç”¨äºæµè§ˆå™¨ä¸€æ¬¡ä¼šè¯ï¼Œç»“æŸåä¼šè¢«æ¸…ç† localStorage ä¿å­˜æ•°æ®é•¿æœŸå­˜åœ¨ åªæœ‰åŒåŸŸåä¸‹çš„ç½‘é¡µæ‰å¯ä»¥è¯»å–ï¼Œè·¨åŸŸä¼šæŠ¥é”™ length è¿”å›æ•°æ®é¡¹ä¸ªæ•° setItem ä¿å­˜ key + value getItem è¿”å›ä¿å­˜çš„ key å¯¹åº”çš„ value clear key è¿”å›å¯¹åº”ä½ç½®çš„é”®å€¼ å‚è€ƒ JavaScript å…¥é—¨ MDN JavaScript]]></content>
      <categories>
        <category>å‰ç«¯</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
        <tag>JavaScript</tag>
        <tag>ES5</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Rocket Web æ¡†æ¶å…¥é—¨]]></title>
    <url>%2F2019%2F02%2F24%2Frust-rocket-quick-start%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Rocket æ¡†æ¶ æ˜¯ Rust ç”Ÿæ€ä¸­æ¯”è¾ƒæµè¡Œçš„ Web æ¡†æ¶ä¹‹ä¸€ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ‹¥æœ‰ç±»ä¼¼ Flask é‚£æ ·æ¯”è¾ƒç®€æ´çš„å†™æ³•ï¼Œå¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™ RESTful APIï¼ŒåŒæ—¶è¿˜æ”¯æŒä¸­é—´ä»¶ç­‰æœºåˆ¶ï¼Œæ˜“äºæ‰©å±•ã€‚å½“ç„¶ï¼Œç›®å‰è¯¥æ¡†æ¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯ä½¿ç”¨äº†å¾ˆå¤š rust-nightly ç‰ˆæœ¬ä¸­çš„ç‰¹æ€§ï¼Œå¯¼è‡´æ— æ³•åœ¨ rust-stable åˆ†æ”¯ä¸‹ç¼–è¯‘ã€‚è¿™å¯¹äºä¸€ä¸ªéœ€è¦é•¿æœŸç»´æŠ¤çš„è¾ƒå¤§çš„é¡¹ç›®æ¥è¯´ï¼Œå°±å­˜åœ¨ä¸€å®šçš„å‡çº§é£é™©ã€‚ä¸è¿‡é‰´äºç›®å‰æˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Rust æ¥ç¼–å†™ Web APIï¼Œæš‚ä¸”è¿˜ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚ ä½ å¥½ï¼ŒRocketéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯åœ¨ rustc 1.34.0-nightly ç¯å¢ƒä¸‹ç¼–è¯‘å¹¶è¿è¡Œçš„~ é¦–å…ˆï¼Œéœ€è¦æ–°å»ºé¡¹ç›® hello-rocketï¼š1cargo new hello-rocket --bin ç”±äºéœ€è¦ä½¿ç”¨ rust-nightly ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åˆ‡æ¢ç‰ˆæœ¬å¹¶æ›´æ–°å·¥å…·é“¾ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š12# å°†å½“å‰é¡¹ç›®ç¯å¢ƒåˆ‡åˆ° nightly ç‰ˆæœ¬rustup override set nightly &amp;&amp; rustup update å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬å°±éœ€è¦ç»™é¡¹ç›®æ·»åŠ  rocket crate ä¾èµ–å•¦ï¼š 1cargo add rocket å¯ä»¥åœ¨ Cargo.toml ä¸­çœ‹åˆ°æ·»åŠ çš„ä¾èµ–ï¼š 123...[dependencies]rocket = "0.4.0" æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ main.rs ä¸­ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„ APIï¼Œè´Ÿè´£åœ¨è®¿é—®å¯¹åº”è·¯ç”±æ—¶æ‰“å°å‡º Hello, Rocketã€‚å¯ä»¥å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°ä½ çš„æ–‡ä»¶ä¸­ï¼š 1234567891011#![feature(proc_macro_hygiene, decl_macro)]// æˆ‘ä»¬éœ€è¦ä½¿ç”¨ rocket ä¸­å®šä¹‰çš„è·¯ç”±åˆ›å»ºå® `routes!`#[macro_use]extern crate rocket;#[get("/")]fn index() -&gt; String &#123; "Hello, Rocket".to_string()&#125;fn main() &#123; rocket::ignite().mount("/", routes![index]).launch();&#125; ä»¥ä¸Šå°±å®Œæˆäº†ä¸€ä¸ªæœ€ç®€å•çš„ API ç¼–å†™ã€‚æœ€åç¼–è¯‘å¹¶å¯åŠ¨ Web æœåŠ¡åï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚ä½ å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® localhost:8000 æ¥æŸ¥çœ‹å“åº”å†…å®¹ï¼š 123456789101112Configured for development. =&gt; address: localhost =&gt; port: 8000 =&gt; log: normal =&gt; workers: 8 =&gt; secret key: generated =&gt; limits: forms = 32KiB =&gt; keep-alive: 5s =&gt; tls: disabledMounting /: =&gt; GET / (index)Rocket has launched from http://localhost:8000 Rocket çš„ç‰¹æ€§åœ¨å…¶å®˜ç½‘çš„ Overview ä¸­ï¼Œå¯ä»¥çœ‹åˆ° Rocket æ¡†æ¶çš„ä¸»è¦ç‰¹æ€§ã€‚ è·¯ç”±ï¼ˆRoutingï¼‰Rocket çš„ä¸»è¦ä»»åŠ¡ä¾¿æ˜¯è·¯ç”±è¯·æ±‚åˆ°åˆé€‚çš„è¯·æ±‚å¤„ç† Handlerã€‚è·¯ç”±æ˜¯é€šè¿‡ get å±æ€§å£°æ˜çš„ï¼Œçœ‹èµ·æ¥åƒæ˜¯ Python ä¸­çš„è£…é¥°å™¨ï¼š 1234#[get("/")]fn index() -&gt; &amp;'static str &#123; "Hello, Rocket!"&#125; ä»¥ä¸Šé¢çš„ä»£ç å—ä¸ºä¾‹ï¼Œè¿™ä¸ªè·¯ç”±çš„åç§°ä¸º indexï¼Œå’Œ HTTP GET / åŒ¹é…ã€‚è¯·æ±‚å¤„ç†å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º HTTP å“åº”çš„ bodyã€‚ åŠ¨æ€å‚æ•°ï¼ˆDynamic Paramsï¼‰Rocket å¯ä»¥åŠ¨æ€åœ°è¯†åˆ«è¯·æ±‚è·¯å¾„å¤šä¸ªéƒ¨åˆ†ï¼Œå¹¶å’Œå¤„ç†å‡½æ•°çš„å‚æ•°ä¸€ä¸€åŒ¹é…ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š 1234#[get("/hello/&lt;name&gt;/&lt;age&gt;")]fn hello(name: String, age: u8) -&gt; String &#123; format!("Hello, &#123;&#125; year old, named &#123;&#125;!", age, name)&#125; ä¸Šè¿°ç¤ºä¾‹è¡¨ç¤ºï¼Œhello è·¯ç”±ä¼šåŠ¨æ€åŒ¹é…åˆ°è·¯å¾„ä¸­çš„ &lt;name&gt; å’Œ &lt;age&gt; éƒ¨åˆ†ã€‚æ¯ä¸ªåŠ¨æ€å‚æ•°éƒ½è¦æœ‰å…·ä½“çš„ç±»å‹ï¼ŒRocket ä¼šå°è¯•å°† path ä¸­å¯¹åº”ä½ç½®çš„å‚æ•°è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ã€‚åªæœ‰å‚æ•°æ­£ç¡®è½¬æ¢åï¼Œæ‰ä¼šè°ƒç”¨ç›¸åº”çš„è·¯ç”±å¤„ç†å‡½æ•°ã€‚ä¸ºäº†è§£æå­—ç¬¦ä¸²ï¼ŒRocket ä¼šä½¿ç”¨ FromParam traitï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºè‡ªå®šä¹‰ç±»å‹å®ç°è¯¥ traitã€‚ è¯·æ±‚æ•°æ®å¤„ç†ï¼ˆHandling Dataï¼‰è¯·æ±‚çš„ body æ•°æ®æ˜¯é€šè¿‡ FromData trait æ¥å¤„ç†çš„ã€‚è¯·æ±‚çš„ body æ•°æ®å¯ä»¥æ´¾ç”Ÿä»»ä½•å®ç°äº† FromData çš„ç±»å‹ã€‚ä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·æŒ‡å®šæœŸæœ›é€šè¿‡å“ªä¸ªå‚æ•°ä½¿ç”¨è¯·æ±‚çš„ bodyï¼š 1234#[post("/login", data = "&lt;user_form&gt;")]fn login(user_form: Form&lt;UserLogin&gt;) -&gt; String &#123; format!("Hello, &#123;&#125;!", user_form.name)&#125; Form ç±»å‹æ˜¯ Rocket å†…å»ºçš„ç±»å‹ï¼Œå®ƒå¯ä»¥å°† Web è¡¨å•è½¬æ¢æˆç»“æ„ä½“ã€‚Rocket ä¼šè‡ªåŠ¨å°è¯•å°†è¯·æ±‚çš„ body æ•°æ®è½¬æ¢æˆ Formï¼Œç„¶ååœ¨è½¬æ¢æˆåŠŸåè°ƒç”¨ login å¤„ç†å‡½æ•°ã€‚å…¶å®ƒå†…å»ºçš„ FormData ç±»å‹è¿˜æœ‰ Dataã€Json å’Œ Flashã€‚ è¯·æ±‚æŠ¤å«ï¼ˆRequest Guardsï¼‰é™¤äº†åŠ¨æ€è·¯å¾„å’Œæ•°æ®å‚æ•°å¤–ï¼Œè¯·æ±‚å¤„ç†å‡½æ•°è¿˜å¯ä»¥åŒ…å«ç¬¬ä¸‰ç§ç±»å‹çš„å‚æ•°ï¼šrequest guardsã€‚Request guards ä¸ç”¨åœ¨è·¯ç”±å±æ€§ä¸­å£°æ˜ï¼Œè€Œæ˜¯å‡ºç°åœ¨è¯·æ±‚å¤„ç†å‡½æ•°çš„å‚æ•°ç­¾åä¸­ï¼Œå¹¶ä¸”æ”¯æŒä»»æ„å¤šä¸ªã€‚ Request guards çš„ä½œç”¨æ˜¯å¯¹è¯·æ±‚çš„å…ƒä¿¡æ¯è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³æŒ‡å®šæ¡ä»¶ï¼Œæ‰è¿è¡Œå¤„ç†å‡½æ•°ï¼Œèµ·åˆ°ä¿æŠ¤ä½œç”¨ã€‚æ¯”å¦‚ï¼š 1234#[get("/sensitive")]fn sensitive(key: ApiKey) &#123;&#125; ä¾‹å­ä¸­ ApiKey ç”¨äºä¿æŠ¤ sensitive å¤„ç†å‡½æ•°ï¼Œåªæœ‰åœ¨è¯·æ±‚å¤´ä¸­çš„ API å¯†é’¥è®¤è¯é€šè¿‡åï¼Œæ‰ä¼šæ‰§è¡Œã€‚ApiKey ç±»å‹éœ€è¦è¿‡å®ç° FromRequest traitï¼Œç„¶ååœ¨å®ç°é€»è¾‘ä¸­æ£€æŸ¥ API å¯†é’¥å¤´ã€‚Request guards æ˜¯ Rocket ä¸­éå¸¸å¼ºå¤§ä¸”ç‹¬ç‰¹çš„æ¦‚å¿µã€‚ å“åº”ï¼ˆResponderï¼‰è¯·æ±‚å¤„ç†å‡½æ•°çš„è¿”å›ç±»å‹å¯ä»¥æ˜¯ä»»ä½•å®ç°äº† Responder çš„ç±»å‹ï¼š12#[get("/")]fn route() -&gt; T &#123;&#125; ä¸Šè¿°ä¾‹å­ä¸­ï¼ŒT å¿…é¡»è¦å®ç° Responderã€‚Rocket å·²ç»ä¸ºæ ‡å‡†åº“ä¸­å¾ˆå¤šç±»å‹å®ç°äº† Responderï¼š&amp;strã€Stringã€Fileã€Option ä»¥åŠ Resultã€‚Rocket ä¹Ÿå®ç°äº†ä¸€äº›è‡ªå®šä¹‰çš„ Responderï¼Œå¦‚ Redirectã€Flash å’Œ Templateã€‚ Responder çš„ä»»åŠ¡å°±æ˜¯å°½å¯èƒ½ç”Ÿæˆ Responseï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å¤±è´¥æ—¶æä¾›çŠ¶æ€ç ã€‚å¦‚æœæŒ‡å®šäº†çŠ¶æ€ç ï¼ŒRocket å°±ä¼šè°ƒç”¨ç›¸åº”çš„é”™è¯¯æ•è·å‡½æ•°ã€‚catch è·¯ç”±çš„å®šä¹‰å¦‚ä¸‹ï¼š 12#[catch(404)]fn not_found() -&gt; T &#123;&#125; è¿è¡Œï¼ˆLaunchingï¼‰ä¸ºäº†è¿è¡Œ Rocket åº”ç”¨ï¼Œé¦–å…ˆéœ€è¦æŒ‚è½½è·¯ç”±ï¼›ç„¶åæ‰å¯ä»¥å¯åŠ¨ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š 123rocket::ignite() .mount("/base", routes![index, another]) .launch(); è°ƒç”¨ launch åä¼šå¯åŠ¨æœåŠ¡å™¨ï¼Œå¼€å‘ç¯å¢ƒä¸­ï¼ŒRocket ä¼šæ‰“å°å‡ºä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„çŠ¶æ€ä¿¡æ¯ï¼š 1ğŸš€ Rocket has launched from http://localhost:8000 Rocket æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿæ¯ä¸€ä¸ª Rocket Web åº”ç”¨ä»æ¥å—åˆ°è¯·æ±‚åˆ°è¿›è¡Œå“åº”ï¼Œéƒ½ä¼šç»å†æ ‡å‡†çš„ä¸‰ä¸ªæ­¥éª¤ï¼ˆè¿™ä¹Ÿæ˜¯å¸¸è§„ Web æ¡†æ¶éƒ½ä¼šåšçš„äº‹æƒ…ï¼‰ã€‚ æ ¡éªŒé¦–å…ˆï¼ŒRocket ä¼šæ ¡éªŒåŒ¹é…çš„è¯·æ±‚ï¼Œç¡®ä¿å¤„ç†å‡½æ•°ä¸­çš„æ¯ä¸ªç±»å‹éƒ½å¯ä»¥æ´¾ç”Ÿè‡ªå½“å‰è¯·æ±‚ã€‚å¦‚æœæŸä¸ªç±»å‹æ— æ³•æ´¾ç”Ÿï¼Œåˆ™ä¼šå®šå‘åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…çš„è·¯ç”±ï¼Œç›´åˆ°æ‰€æœ‰ç±»å‹æ ¡éªŒéƒ½æ²¡é—®é¢˜æˆ–è€…æ²¡æœ‰ä»»ä½•å¯å°è¯•çš„è·¯ç”±ä¸ºæ­¢ã€‚å¦‚æœæ‰€æœ‰çš„è·¯ç”±éƒ½ä¸åŒ¹é…ï¼Œåˆ™ä¼šè¿”å›è‡ªå®šä¹‰çš„ 404 é”™è¯¯ï¼š 1234#[post("/user", data = "&lt;new_user&gt;")]fn new_user(admin: AdminUser, new_user: Form&lt;User&gt;) -&gt; T &#123; ...&#125; ä»¥ä¸Šè¿°ä¾‹å­æ¥è¯´æ˜ï¼š è¯·æ±‚æ–¹æ³•å¿…é¡»æ˜¯ POST è¯·æ±‚è·¯å¾„å¿…é¡»æ˜¯ /user è¯·æ±‚ä¸­å¿…é¡»åŒ…å« body æ•°æ® è¯·æ±‚çš„å…ƒä¿¡æ¯å¿…é¡»æ˜¯é€šè¿‡è®¤è¯çš„ AdminUser è¯·æ±‚ä½“å¿…é¡»èƒ½å¤Ÿè½¬æ¢æˆ User ç»“æ„ä½“ å¤„ç†æ¥ä¸‹æ¥ï¼Œè¯·æ±‚ä¼šè¢«ä»»æ„çš„ Handler å¤„ç†ã€‚è¿™é‡Œå°±æ˜¯æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘äº†ã€‚Rocket ä¸­çš„ Handler å°±æ˜¯ç®€å•çš„å‡½æ•°ï¼Œå”¯ä¸€è¦æ³¨æ„çš„æ˜¯è¿”å›å€¼å¿…é¡»è¦æ˜¯å®ç°äº† Responder trait çš„ç±»å‹ã€‚ å“åº”æœ€åï¼ŒRocket ä¼šå°† Handler è¿”å›å€¼è½¬æ¢æˆ HTTP å“åº”ï¼Œç„¶åç»™å®¢æˆ·ç«¯å‘é€å“åº”ï¼š 1fn route() -&gt; T &#123;&#125; ä¸Šè¿°ä¾‹å­ä¸­çš„ T å¿…é¡»æ˜¯å®ç°äº† Responder çš„ç±»å‹ï¼ŒRocket ç›®å‰æä¾›äº†å¾ˆå¤šå¸¸ç”¨çš„å“åº”ç±»å‹ï¼š Json&lt;T&gt;: å°†ç±»å‹ T è½¬æ¢æˆ JSON å¹¶è¿”å› Template: æ¸²æŸ“æ¨¡æ¿å¹¶è¿”å› Redirect: è¿”å›åˆé€‚çš„é‡å®šå‘å“åº” NamedFile: å‘å®¢æˆ·ç«¯æµä¼ è¾“æŒ‡å®šçš„æ–‡ä»¶ï¼ŒContent-Type è®¾ç½®ä¸ºæ–‡ä»¶å¤¹çš„æ‰©å±•å Stream: å‘å®¢æˆ·ç«¯æµä¼ è¾“ä»»æ„ Read å€¼ æ›´å¤šæ‰©å±•åŠŸèƒ½Rocket æ¡†æ¶å¯æ’æ‹”çš„ç‰¹æ€§èƒ½èƒ½å¤Ÿç»™ä½ å¸¦æ¥å¾ˆå¤šé¢å¤–çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨å…¶æ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚ æ¨¡æ¿ Cookies æµä¼ è¾“ æ˜“äºé…ç½®çš„å¼€å‘ç¯å¢ƒ å†…å»ºå•å…ƒæµ‹è¯•å·¥å…· ç±»å‹å®‰å…¨çš„ URIs å‚è€ƒ Rocket Overview]]></content>
      <categories>
        <category>Web å¼€å‘</category>
      </categories>
      <tags>
        <tag>Web</tag>
        <tag>Rust</tag>
        <tag>Rocket</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Thrift åˆæ¢]]></title>
    <url>%2F2019%2F02%2F18%2Fexplore-thrift%2F</url>
    <content type="text"><![CDATA[å¼•è¨€çŸ¥ä¹ä½¿ç”¨çš„ RPC æ¡†æ¶æ˜¯åŸºäº Thrift æ„å»ºçš„ã€‚è‡ªç„¶å°±å¾ˆæœ‰å¿…è¦äº†è§£ä¸‹ Thrift æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿä»¥åŠæœ‰ä»€ä¹ˆæœ€ä½³å®è·µï¼Ÿ Thrift å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»è‡ªå·±çš„ï¼š Thrift is a software framework for scalable cross-language services development. It combines a software stack with a code generation engine to build services that work efficiently and seamlessly between C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, and OCaml. ä»¥ä¸‹æ˜¯ Thrift åè®®æ ˆç¤ºæ„å›¾ï¼š Input Codeï¼šæ˜¯ä¾ç…§ Thrift è¯­æ³•ç¼–å†™çš„æœåŠ¡ï¼ˆåŒ…å«å˜é‡ã€æœåŠ¡æ–¹æ³•ã€å¼‚å¸¸ç­‰å®šä¹‰ï¼‰ Generated Codeï¼šä½¿ç”¨ thrift gen ç¼–è¯‘ç”Ÿæˆçš„æŒ‡å®šæŸç§è¯­è¨€çš„å®¢æˆ·ç«¯ä»£ç ï¼Œä»¥ä¾¿äºåœ¨ä¸šåŠ¡ä¸­è°ƒç”¨æœåŠ¡çš„ RPC æ¥å£ Service Client write()/read() TProtocolï¼šæä¾›äº†å¯é€‰çš„åè®®å±‚ TTransportï¼šæä¾›äº†æ»¡è¶³ä¸åŒéœ€æ±‚çš„ä¼ è¾“å±‚æœåŠ¡ è¿è¡Œæ—¶åº“ï¼ˆRuntime Libraryï¼‰æ•´ä¸ªåè®®å±‚å’Œä¼ è¾“å±‚éƒ½æ˜¯è¿è¡Œæ—¶åº“çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šå±‚å®šä¹‰å¥½æœåŠ¡åï¼Œåœ¨éœ€è¦çš„æ—¶å€™éšæ—¶æ›¿æ¢åè®®å±‚æˆ–ä¼ è¾“å±‚ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ã€‚ åè®®å±‚ï¼ˆProtocol Layerï¼‰åè®®å±‚çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œç›®å‰æ”¯æŒçš„ç±»å‹å¦‚ä¸‹ï¼š TBinaryProtocolï¼šç›´æ¥äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ•°å­—ä¼šè¢«ç¼–ç æˆäºŒè¿›åˆ¶ï¼Œè€Œéæ–‡æœ¬ TCompactProtocolï¼šå¼‚å¸¸é«˜æ•ˆã€ç´§å‡‘çš„æ•°æ®ç¼–ç æ ¼å¼ TDenseProtocolï¼šç±»ä¼¼äº TCompactProtocolï¼Œä½†æ˜¯åœ¨ä¼ è¾“æ—¶ä¼šç§»é™¤ meta ä¿¡æ¯ï¼Œè€Œåœ¨æ¥æ”¶æ—¶è¡¥å› meta ä¿¡æ¯ TJSONProtocolï¼šä½¿ç”¨ JSON æ ¼å¼è¿›è¡Œç¼–ç  TSimpleJSONProtocolï¼šä½¿ç”¨ JSON ç¼–ç ï¼Œä¸”åªç”¨äºå†™çš„åè®®ã€‚é€‚ç”¨äºè„šæœ¬è¯­è¨€è§£æ TDebugProtocolï¼šä½¿ç”¨äººç±»å‹å¥½çš„æ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºè°ƒè¯• æœåŠ¡ç«¯æ”¯æŒä¼ è¾“å±‚è´Ÿè´£è¯»å–å’Œå†™å…¥ã€‚ç›®å‰æ”¯æŒçš„å‡ ç§æ–¹å¼å¦‚ä¸‹ï¼š TSocketï¼šä½¿ç”¨é˜»å¡å¼ç½‘ç»œ IO ä¼ è¾“ TFramedTransportï¼šé€å¸§å‘é€æ•°æ®ï¼Œæ¯å¸§æ•°æ®éƒ½åœ¨å‰é¢åŠ ä¸Šé•¿åº¦ä¿¡æ¯ã€‚å¯¹äºä½¿ç”¨éé˜»å¡å¼çš„æœåŠ¡æ¥è¯´ï¼Œéœ€è¦ä½¿ç”¨è¿™ç§ä¼ è¾“æ–¹æ³• TFileTransportï¼šä½¿ç”¨æ–‡ä»¶ä½œä¸ºä¼ é€åª’ä»‹ TMemoryTransportï¼šå€ŸåŠ©å†…å®¹ä¼ è¾“ã€‚Java çš„å®ç°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ ByteArrayOutputStream æ¥å®ç° TZlibTransportï¼šä½¿ç”¨ zlib å‹ç¼©ï¼Œå¯ä»¥å’Œå…¶å®ƒä¼ è¾“æ–¹å¼ç»„åˆåœ¨ä¸€å— ProcessorProcessor å°†è¾“å…¥å’Œè¾“å‡ºåè®®ä½œä¸ºå‚æ•°ã€‚å®ƒè´Ÿè´£ä»è¾“å…¥è¯»å–æ•°æ®ï¼Œé€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰çš„ Handler å¤„ç†æ•°æ®ï¼Œç„¶åå†å°†æ•°æ®å†™åˆ°è¾“å‡ºã€‚ æ”¯æŒçš„æœåŠ¡æ¨¡å¼ï¼ˆSupported Serversï¼‰æœåŠ¡å™¨è‡ªç„¶æ˜¯ç”¨äºåœ¨æŒ‡å®šç«¯å£ç›‘å¬è¯·æ±‚ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®å‘é€åˆ° Processor å¤„ç†ã€‚æœ‰è¿™ä¹ˆå‡ ç§æœåŠ¡å¯ä»¥ç”¨ä½¿ç”¨ï¼š TSimpleServerï¼šå•çº¿ç¨‹é˜»å¡ IOï¼Œæ–¹ä¾¿æµ‹è¯• ThreadPoolServerï¼šå¤šçº¿ç¨‹é˜»å¡ IO TNonblockingServerï¼šå¤šçº¿ç¨‹éé˜»å¡ IOï¼Œéœ€è¦ä½¿ç”¨ TFramedTransport ä¼ è¾“æ–¹å¼ Thrift è¯­è¨€æŒ‡å—ç±»å‹ç³»ç»ŸThrift ç±»å‹ç³»ç»Ÿä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š é¢„å®šä¹‰çš„åŸºæœ¬ç±»å‹ ç”¨æˆ·å®šä¹‰çš„ç»“æ„ä½“ å®¹å™¨ç±»å‹ å¼‚å¸¸ æœåŠ¡ åŸºæœ¬ç±»å‹ boolï¼šå¸ƒå°”ç±»å‹ï¼ˆå¯é€‰å€¼ true æˆ– falseï¼‰ï¼Œå ç”¨ä¸€ä¸ªå­—èŠ‚ byteï¼šæœ‰ç¬¦å·å•å­—èŠ‚ i16ï¼š16 ä½æœ‰ç¬¦å·æ•´å‹ i32ï¼š32 ä½æœ‰ç¬¦å·æ•´å‹ i64ï¼š64 ä½æœ‰ç¬¦å·æ•´å‹ doubleï¼š64 ä½æµ®ç‚¹æ•°ç±»å‹ binaryï¼šå­—èŠ‚ä¸² stringï¼šç¼–ç æœªçŸ¥æ–‡æœ¬æˆ–äºŒè¿›åˆ¶å­—ç¬¦ä¸² éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒThrfit å¹¶ä¸æ”¯æŒæ— ç¬¦å·æ•´æ•°ï¼Œå› ä¸ºåœ¨å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸­å¹¶æ²¡æœ‰ç›´æ¥çš„æ˜ å°„ã€‚ å®¹å™¨ list&lt;T&gt;ï¼šåˆ—è¡¨ï¼Œç±»ä¼¼ Python ä¸­çš„ list set&lt;T&gt;ï¼šæ— åºé›†åˆ map&lt;K, V&gt;ï¼šå­—å…¸ï¼Œç±»ä¼¼ Python ä¸­çš„ dict å®¹å™¨ä½¿ç”¨çš„ç±»å‹å¯ä»¥æ˜¯ä»»æ„åˆæ³•çš„ Thrfit ç±»å‹ï¼ˆå¦‚ç»“æ„ä½“ã€å¼‚å¸¸ç­‰ï¼‰ï¼Œä½†ã€ŒæœåŠ¡ã€é™¤å¤–ã€‚ ç»“æ„ä½“ä¸å¼‚å¸¸Thrift ç»“æ„ä½“å®šä¹‰ç±»ä¼¼ C è¯­è¨€ä¸­çš„ structï¼Œå¯¹äºæŸäº› OO è¯­è¨€ï¼Œç»“æ„ä½“ä¼šè¢«ç¿»è¯‘æˆ Classã€‚ å¼‚å¸¸çš„å®šä¹‰ç±»ä¼¼ç»“æ„ä½“ï¼Œå¯ä»¥åŒ…å«ä¸åŒçš„å­—æ®µç»„æˆï¼Œä½†æ˜¯ç”¨ exception å…³é”®å­—ã€‚æˆ‘ä»¬åœ¨å®šä¹‰æœåŠ¡ RPC æ—¶ï¼Œå¯ä»¥è®©æŸäº›æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼ˆå¦‚èµ„æºæœªæ‰¾åˆ°ï¼‰ã€‚ æœåŠ¡æœåŠ¡çš„å®šä¹‰ç±»ä¼¼ OO ç¼–ç¨‹ä¸­å®šä¹‰çš„ interfaceï¼Œæˆ–è€… Rust ä¸­çš„ traitã€‚Thrift ç¼–è¯‘å™¨ä¼šç”Ÿæˆå®Œæ•´çš„å®ç°äº†æ¥å£çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¡©ï¼ˆStubï¼‰ã€‚ ç±»å‹å®šä¹‰12typedef i32 inttypedef Tweet ReTweet æšä¸¾ç±» C çš„æšä¸¾å®šä¹‰ï¼š123456enum TweetType &#123; TWEET, RETWEET = 2, DM = 0xa, REPLY &#125; éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åƒ Protocol Buffersï¼ŒThrift è¿˜ä¸æ”¯æŒåµŒå¥— Enum å®šä¹‰ï¼ˆæˆ–è€…åµŒå¥—ç»“æ„ä½“ï¼‰ï¼Œæšä¸¾å€¼å¿…é¡»æ˜¯ 32 ä½æ­£æ•´æ•°ã€‚ æ³¨é‡Š1234567# è¿™æ˜¯åˆæ³•çš„æ³¨é‡Š/* * å¤šè¡Œæ³¨é‡Šï¼Œç±»ä¼¼ C è¯­è¨€æ”¯æŒçš„é‚£æ · */// å•è¡Œæ³¨é‡Š å‘½åç©ºé—´Thrift ä¸­çš„å‘½åç©ºé—´ç±»ä¼¼ C++ ä¸­çš„é‚£æ ·ï¼Œæˆ–è€… Java ä¸­çš„åŒ…çš„æ¦‚å¿µã€‚ç”±äºæ¯ç§è¯­è¨€éƒ½æœ‰è‡ªå·±çš„åŒ…ç®¡ç†æœºåˆ¶ï¼ˆå¦‚ Python æœ‰æ¨¡å—çš„æ¦‚å¿µï¼‰ï¼ŒThrift å…è®¸é’ˆå¯¹ä¸åŒçš„è¯­è¨€å®šåˆ¶å‘½åç©ºé—´è¡Œä¸ºï¼š 12345// ç¿»è¯‘æˆ C++ `namespace com &#123; namespace example &#123; namespace project &#123;`namespace cpp com.example.project// ç¿»è¯‘æˆ Java åŒ…å°±æ˜¯ `package com.example.project`namespace java com.example.project Includesæˆ‘ä»¬é€šå¸¸å¯ä»¥å°† Thrift å®šä¹‰æ‹†åˆ†åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ä»¥ä¾¿ç»´æŠ¤ã€å¤ç”¨ï¼Œä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼è¿›è¡Œç»„ç»‡ã€‚Thrift è¿è¡Œåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ include å…¶å®ƒæ–‡ä»¶ã€‚è¢« include çš„æ–‡ä»¶ä¼šåœ¨å½“å‰ç›®å½•æˆ–è€…ä½¿ç”¨ -I ç¼–è¯‘æ ‡å¿—æŒ‡å®šçš„ç›®å½•ä¸­æŸ¥æ‰¾ã€‚ 123456include &quot;tweet.thrift&quot; // æ³¨æ„æ²¡æœ‰ `;` ç»“å°¾...struct TweetSearchResult &#123; 1: list&lt;tweet.Tweet&gt; tweets;&#125; å¸¸é‡12345const i32 MAX_PROCS = 120; // åˆ†å·æ˜¯å¯é€‰çš„// ä¹Ÿå¯ä»¥å®šä¹‰å¤æ‚ç±»å‹çš„å¸¸é‡ï¼Œæ”¯æŒç»“æ„ä½“ã€å­—å…¸ç­‰// ä½¿ç”¨ JSON çš„æ ¼å¼åˆå§‹åŒ–const map&lt;string, string&gt; MAP_CONST = &#123;&quot;hello&quot;: &quot;world&quot;&#125;; ç»“æ„ä½“å®šä¹‰åœ¨ Thrfit IDL (Interface Defenition Language) ä¸­ï¼Œç»“æ„ä½“æ˜¯åŸºæœ¬çš„æ„å»ºåŸºçŸ³ã€‚ç»“æ„ä½“ç»„åˆäº†å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µæœ‰ç‹¬ç«‹çš„æ ‡è¯†ç¬¦ï¼Œç±»å‹ï¼Œåç§°ä»¥åŠå¯é€‰çš„é»˜è®¤å€¼ã€‚ 123456789101112struct Location &#123; 1: required double latitude; 2: required double longitude;&#125;struct Tweet &#123; 1: required i32 user_id; 2: required string user_name; 3: required: string description; 4: optional: Location loc; 5: optional: string contry = &quot;China&quot;;&#125; å¯¹äºä½¿ç”¨ required æ ‡è®°çš„å­—æ®µï¼Œå®ä¾‹åŒ–æ—¶å¿…é¡»è¦èµ‹å€¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚å¯¹äº optional å­—æ®µï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å€¼ï¼Œå°±ä¸ä¼šåœ¨åºåˆ—åŒ–æ—¶ä¼ è¾“ã€‚å¦‚æœ optional å­—æ®µè®¾ç½®äº†é»˜è®¤å€¼ï¼Œå½“è§£æç»“æ„ä½“çš„æ—¶å€™ä¼šç»™ç›¸åº”å­—æ®µèµ‹äºˆé»˜è®¤å€¼ã€‚ ä¸åŒäºæœåŠ¡ï¼Œç»“æ„ä½“æ˜¯ä¸å…è®¸ç»§æ‰¿çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å…è®¸æ‰©å±•è‡ªå…¶å®ƒç»“æ„ä½“ã€‚ Required Is Foreveråœ¨å°†ä¸€ä¸ªå­—æ®µè®¾ç½®ä¸º required ä¹‹å‰ä¸€å®šè¦ä¸‰æ€å•Šï¼å¦‚æœä½ æƒ³åœ¨ä»€ä¹ˆæ—¶å€™åœæ­¢å‘é€æŸä¸ª required å­—æ®µæ—¶ï¼ˆå¦‚è®¾ç½®ä¸º optionalï¼‰ï¼Œå°±å¾ˆå®¹æ˜“å‡ºé—®é¢˜ï¼šæ—§ç‰ˆæœ¬çš„è¯»å–å™¨ä¼šè®¤ä¸ºæ²¡æœ‰åŸå…ˆ required å­—æ®µçš„æ¶ˆæ¯æ˜¯ä¸å®Œæ•´çš„ï¼Œå¯èƒ½ä¼šæ‹’ç»ç”šè‡³æ— æ„ä¸­ä¸¢å¼ƒæ‰ã€‚æ‰€ä»¥è¿™æ—¶å¯èƒ½å°±éœ€è¦ç¼–å†™ç‰¹å®šçš„è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘æ¥è§£å†³é—®é¢˜ã€‚æœ‰äº›äººè®¤ä¸ºä½¿ç”¨ required å¼Šå¤§äºåˆ©ï¼›ä»–ä»¬æ›´å–œæ¬¢åªç”¨ optionalã€‚ç„¶è€Œï¼Œè¿™ä¸ªä¹Ÿæ˜¯å› äººè€Œå¼‚ï¼Œçœ‹åœºæ™¯éœ€è¦çš„äº†ã€‚ å®šä¹‰æœåŠ¡è™½ç„¶å·²ç»æœ‰å¾ˆå¤šæµè¡Œçš„åºåˆ—åŒ–/ååºåˆ—åŒ–æ¡†æ¶ï¼ˆå¦‚ Protocol Buffersï¼‰äº†ï¼Œä½†å¾ˆå°‘æœ‰æ¡†æ¶æä¾›å¼€ç®±å³ç”¨çš„è·¨è¯­è¨€ RPC æœåŠ¡çš„æ”¯æŒï¼Œè¿™ä¹Ÿæ˜¯ Thrift æœ€ä¸»è¦çš„äº®ç‚¹ä¹‹ä¸€ã€‚ å¯ä»¥æŠŠæœåŠ¡å®šä¹‰å½“åš Java ä¸­çš„æ¥å£å®šä¹‰ï¼Œä½ éœ€è¦æä¾›ç›¸åº”çš„æ–¹æ³•åç§°ã€ç­¾åç­‰ï¼›æ­¤å¤–ï¼ŒæœåŠ¡ä¹Ÿå¯ä»¥æ‰©å±•è‡ªå…¶å®ƒæœåŠ¡ï¼ˆä½¿ç”¨ extends å…³é”®å­—ï¼‰ã€‚ Thrift ç¼–è¯‘å™¨ä¼šæ ¹æ®é€‰æ‹©çš„ç›®æ ‡ç¼–ç¨‹è¯­è¨€ç”Ÿæˆç›¸åº”çš„æ¥å£ä»£ç ï¼ˆServer ç«¯ï¼‰ä»¥åŠ Stubsï¼ˆå®¢æˆ·ç«¯ï¼‰ã€‚Thrift ä¸ºå¤§å¤šæ•°è¯­è¨€æä¾›äº†ç”¨äºè¿è¡Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ RPC åº“ã€‚ 123456789101112service Twitter &#123; // æ–¹æ³•å®šä¹‰æ ¼å¼ç±»ä¼¼ C è¯­è¨€ã€‚éœ€è¦æŒ‡å®šè¿”å›ç±»å‹ã€å‚æ•°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæŠ›çš„å¼‚å¸¸åˆ—è¡¨ // éœ€è¦æ³¨æ„çš„æ˜¯å‚æ•°åˆ—è¡¨å’Œå¼‚å¸¸åˆ—è¡¨ä½¿ç”¨çš„å®šä¹‰æ–¹å¼ç±»ä¼¼ç»“æ„ä½“å­—æ®µå®šä¹‰ void ping(); // çœ‹åˆ°æ²¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€—å·ç»“å°¾ // ä¸è¿‡è¿˜æ˜¯å»ºè®®ä½¿ç”¨åˆ†å·å§ bool post_tweet(1: Tweet tweet) throws (1: TwitterUnavailable unavailable), TweetSearchResult search_tweets(1: string query); // `async` è¡¨ç¤ºå®¢æˆ·ç«¯å°½ç®¡è¯·æ±‚ï¼Œè€Œæ— éœ€ç­‰å¾…å…¶å“åº”ã€‚è¿™ç§æ–¹æ³•å¿…é¡»æ˜¯ `void` async void zip();&#125; ä»£ç ç”Ÿæˆåœ¨å‰é¢çš„ åè®®æ ˆ å°èŠ‚å¯¹æ•´ä¸ª Thrift åè®®æ ˆæœ‰äº†æ¦‚æ‹¬æ€§çš„äº†è§£ï¼Œæ¥ä¸‹æ¥å°†ä»ä»£ç ç”Ÿæˆçš„è§’åº¦è®²è®² Thrift åè®®æ ˆã€‚ åŸºæœ¬æ¦‚å¿µä»¥ä¸‹æ˜¯ Thrift ç½‘ç»œæ ˆçš„æ¦‚å¿µå›¾ï¼š 1234567891011121314151617+-------------------------------------------+| cGRE || Server || (single-threaded, event-driven etc) |+-------------------------------------------+| cBLU || Processor || (compiler generated) |+-------------------------------------------+| cGRE || Protocol || (JSON, compact etc) |+-------------------------------------------+| cGRE || Transport || (raw TCP, HTTP etc) |+-------------------------------------------+ ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰ä¼ è¾“å±‚æä¾›äº†ç½‘ç»œè¯»å†™çš„ç®€å•æŠ½è±¡ï¼Œè¿™æ ·å¯ä»¥å°†åº•å±‚çš„ä¼ è¾“å’Œç³»ç»Ÿå…¶å®ƒéƒ¨åˆ†è§£è€¦å¼€æ¥ï¼ˆå¦‚åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç­‰ï¼‰ã€‚ä»¥ä¸‹æ˜¯ Transport æ¥å£æä¾›çš„æ–¹æ³•ï¼š open close read write flush é™¤äº† Transport æ¥å£ï¼ŒThrift ä¹Ÿä½¿ç”¨äº† ServerTransport æ¥å£æ¥æ”¶æˆ–åˆ›å»ºåŸå§‹çš„ä¼ è¾“å¯¹è±¡ã€‚é¡¾åæ€ä¹‰ï¼ŒServerTransport ä¸»è¦ç”¨äºæœåŠ¡ç«¯ä¸ºè¿›å…¥çš„è¿æ¥åˆ›å»º Transport å¯¹è±¡ã€‚å…¶æä¾›çš„æ–¹æ³•å¦‚ä¸‹ï¼š open listen accept close ä»¥ä¸‹æ˜¯å¤§éƒ¨åˆ† Thrift æ”¯æŒçš„è¯­è¨€éƒ½ä¼šæä¾›çš„ä¼ è¾“æ–¹å¼ï¼š file: ä»ç£ç›˜è¿™ä¸¤ä¸ªè¯»å–æˆ–å†™å…¥ http åè®®å±‚ï¼ˆProtocol Layerï¼‰åè®®æŠ½è±¡æä¾›äº†å°†å†…å­˜æ•°æ®ç»“æ„æ˜ å°„æˆä¼ è¾“æ ¼å¼çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåè®®å®šä¹‰äº†æ•°æ®ç±»å‹å¦‚ä½•åˆ©ç”¨åº•å±‚çš„ Transport å±‚æ¥ç¼–è§£ç è‡ªå·±ã€‚å› æ­¤ï¼Œåè®®å±‚å®ç°è´Ÿè´£ Schema ç¼–ç ä»¥åŠåºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚å¸¸ç”¨çš„åè®®åŒ…æ‹¬ï¼šJSONã€XMLã€çº¯æ–‡æœ¬å’Œå‹ç¼©äºŒè¿›åˆ¶ç­‰ã€‚ ä»¥ä¸‹æ˜¯ Protocol æ¥å£å®šä¹‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940writeMessageBegin(name, type, seq)writeMessageEnd()writeStructBegin(name)writeStructEnd()writeFieldBegin(name, type, id)writeFieldEnd()writeFieldStop()writeMapBegin(ktype, vtype, size)writeMapEnd()writeListBegin(etype, size)writeListEnd()writeSetBegin(etype, size)writeSetEnd()writeBool(bool)writeByte(byte)writeI16(i16)writeI32(i32)writeI64(i64)writeDouble(double)writeString(string)name, type, seq = readMessageBegin() readMessageEnd()name = readStructBegin() readStructEnd()name, type, id = readFieldBegin() readFieldEnd()k, v, size = readMapBegin() readMapEnd()etype, size = readListBegin() readListEnd()etype, size = readSetBegin() readSetEnd()bool = readBool()byte = readByte()i16 = readI16()i32 = readI32()i64 = readI64()double = readDouble()string = readString() Thrift åè®®å±‚é‡‡ç”¨é¢å‘æµï¼ˆStream Orientedï¼‰çš„è®¾è®¡ã€‚ä¾‹å¦‚ï¼Œæ²¡å¿…è¦åœ¨çŸ¥é“å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ä¸­çš„å…ƒç´ æ•°é‡çš„é•¿åº¦çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥åºåˆ—åŒ–å®ƒä»¬ã€‚ ä»¥ä¸‹æ˜¯ Thrift æ”¯æŒçš„è¯­è¨€ä¸­é€šå¸¸ä¼šæä¾›çš„åè®®ï¼š binary compact json å¤„ç†å™¨ï¼ˆProcessorï¼‰Processor å¯¹äºä»è¾“å…¥æµè¯»å–æ•°æ®å’Œå†™å‡ºåˆ°è¾“å‡ºæµæ“ä½œåšäº†å°è£…ï¼Œè¾“å…¥å’Œè¾“å‡ºæµä½¿ç”¨ Protocol å¯¹è±¡è¡¨ç¤ºã€‚æ¥å£å®šä¹‰éå¸¸ç®€å•ï¼š 123interface TProcessor &#123; bool process(TProtocol in, TProtocol out) throws TException&#125; æœåŠ¡å™¨ï¼ˆServerï¼‰æœåŠ¡å™¨åŒ…å«å¦‚ä¸‹åŠŸèƒ½ï¼š åˆ›å»º Transport ä¸º Transport åˆ›å»ºè¾“å…¥ã€è¾“å‡º Protocols åŸºäºè¾“å…¥è¾“å‡º Protocols åˆ›å»ºä¸€ä¸ª Processor ç­‰å¾…è¿æ¥ï¼Œå¹¶å°†å®ƒä»¬ä¸¢ç»™ Processor å¤„ç† æœ€ä½³å®è·µç‰ˆæœ¬åŒ–ã€å…¼å®¹æ€§è€ƒé‡åè®®éšç€æ—¶é—´ä¼šä¸æ–­è¿›åŒ–çš„ã€‚å¦‚æœç°æœ‰çš„æ¶ˆæ¯ç±»å‹ä¸å†æ»¡è¶³å½“å‰éœ€æ±‚ï¼ˆä¾‹å¦‚å¸Œæœ›ç»™æŸä¸ªç»“æ„ä½“æ–°å¢ä¸€ä¸ªå­—æ®µï¼‰æ—¶ï¼Œä½†æ˜¯å¸Œæœ›æ—§ç‰ˆæœ¬æ ¼å¼ç”Ÿæˆçš„ä»£ç ç»§ç»­å…¼å®¹ï¼ˆå‘å‰å…¼å®¹ï¼‰ï¼Œä¸è¦æ‹…å¿ƒï¼ä½ å¯ä»¥éå¸¸è½»æ¾åœ°æ›´æ–°åè®®è€Œä¸ç”¨æ‹…å¿ƒç ´åä¹‹å‰çš„ä»»ä½•ä»£ç ã€‚ä¸è¿‡ï¼Œå‰ææ˜¯éœ€è¦éµå¾ªä¸€äº›è§„åˆ™ï¼š å¯¹äºä»»ä½•å·²æœ‰çš„å­—æ®µï¼Œä¸è¦ä¿®æ”¹å‰é¢çš„ Tag Number ä»»ä½•æ–°å¢çš„å­—æ®µéƒ½åº”æ ‡è®°ä¸ºå¯é€‰çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨æ—§ç‰ˆæœ¬æ¶ˆæ¯æ ¼å¼ç”Ÿæˆçš„ä»£ç åºåˆ—åŒ–çš„æ¶ˆæ¯æ˜¯å¯ä»¥è¢«æ–°ç”Ÿæˆçš„ä»£ç æ­£ç¡®è§£æçš„ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šä¸¢å¤±ä»»ä½•å¿…é¡»çš„å­—æ®µã€‚å¯¹äºè¿™äº›å­—æ®µåº”å½“è®¾ç½®åˆç†çš„é»˜è®¤å€¼ï¼Œè¿™æ ·æ–°çš„ä»£ç å¯ä»¥æ­£ç¡®åœ°ä¸æ—§ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯äº¤äº’ã€‚åŒæ ·åœ°ï¼Œä½¿ç”¨æ–°ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯ä¹Ÿå¯ä»¥è¢«æ—§ä»£ç æ­£ç¡®è§£æï¼Œåªæ˜¯å¿½ç•¥æ‰æ–°å¢çš„å­—æ®µã€‚ç„¶è€Œï¼ŒæœªçŸ¥å­—æ®µå¹¶ä¸ä¼šè¢«é—å¼ƒï¼Œå¦‚æœæ¶ˆæ¯ä¹‹åè¢«åºåˆ—åŒ–ï¼ŒæœªçŸ¥å­—æ®µè¿˜æ˜¯ä¼šå‚ä¸åºåˆ—åŒ–çš„ã€‚å› æ­¤ï¼Œå¦‚æœæ¶ˆæ¯è¢«å‘é€åˆ°æ–°ç‰ˆæœ¬ä»£ç ï¼Œæ–°å¢å­—æ®µä¾ç„¶å¯ç”¨ã€‚ éå¿…é¡»çš„å­—æ®µå¯ä»¥è¢«ç§»é™¤æ‰ï¼Œå‰ææ˜¯ Tag Number ä¸è¦å†æ¬¡ä½¿ç”¨ï¼ˆæ¨èé‡å‘½ååºŸå¼ƒå­—æ®µï¼Œå¯ä»¥æ·»åŠ  OBSOLETE_ å‰ç¼€ï¼‰ å¯èƒ½é€ æˆç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µåˆ†æ å‚è€ƒ Thrift Tutorial Thrift The Missing Guide Thrift docs Paper: Scalable Cross-Language Services Implementation Paper: Apache Thrift ç«äº‰å¯¹æ‰‹ Data Serialization Comparison Schema evolution in Avro, Protocol Buffers and Thrift]]></content>
      <categories>
        <category>Thrift</category>
      </categories>
      <tags>
        <tag>Thrift</tag>
        <tag>RPC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Beanstalkd æºç åˆæ¢]]></title>
    <url>%2F2019%2F02%2F04%2Flearning-beanstalkd-source-code%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ï¼Œç»å¸¸ä¼šå€ŸåŠ© Beanstalkd æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼Œå¸¸è§çš„ç”¨ä¾‹å¦‚ä¸‹ï¼š ç”¨æˆ·å®Œæˆä¼šå‘˜è´­ä¹°å¹¶æ¿€æ´»åï¼Œå‘é€ç§ä¿¡é€šçŸ¥ã€é‡ç½®è´¦å·é‡å‘½åçŠ¶æ€ç­‰ï¼› ç”¨æˆ·å®Œæˆè¯„è®ºåï¼Œå¼‚æ­¥æ›´æ–°è¯„è®ºè®¡æ•°ï¼› ç”¨æˆ·å¯¹ç§å®¶è¯¾æ”¶å¬è®°å½•ä¸ŠæŠ¥åï¼Œå¼‚æ­¥æ›´æ–°æœ€è¿‘æ”¶å¬çš„å°èŠ‚ã€ç´¯ç§¯æ”¶å¬æ—¶é•¿ã€åŒæ­¥åˆ°å…¶å®ƒç³»ç»Ÿç­‰ï¼› ç”¨æˆ·è®°å½•æ·»åŠ åï¼Œä¼šåŒæ­¥è‡³ Redisï¼Œä¸ºä¿è¯æ•°æ®åº“å’Œ Redis çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¼šæå‰å¯åŠ¨ä¸€ä¸ªå»¶è¿Ÿæ ¡éªŒçš„ä»»åŠ¡ï¼ˆå¦‚ 5s åï¼‰ï¼Œæ£€æŸ¥ Redis ä¸­ä¸æ•°æ®åº“è®°å½•æ˜¯å¦ä¸€è‡´ã€‚ Beanstalkd åˆè¯†ç‰¹ç‚¹ åŸºäº TCP å¹¶é‡‡ç”¨ ASCII ç¼–ç çš„æ–‡æœ¬åè®®ã€‚è¯¦ç»†å®šä¹‰å‚è§ï¼šprotocol.txtï¼š å®¢æˆ·ç«¯è´Ÿè´£ä¸æœåŠ¡ç«¯çš„äº¤äº’ï¼šè¿æ¥ã€å‘é€å‘½ä»¤å’Œæ•°æ®ã€ç­‰å¾…å“åº”ã€å…³é—­è¿æ¥ æœåŠ¡ç«¯ä¸²è¡Œå¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ åè®®ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šæ–‡æœ¬è¡Œï¼ˆç”¨äºå®¢æˆ·ç«¯å‘½ä»¤å’ŒæœåŠ¡ç«¯å“åº”ï¼‰å’Œéç»“æ„åŒ–çš„æ•°æ®å—ï¼ˆç”¨äºä¼ é€ä»»åŠ¡ body å’Œ stats ä¿¡æ¯ï¼‰ é˜Ÿåˆ—æ¶ˆæ¯æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä½†ç”¨æˆ·å¯ä»¥é€‰æ‹©å¼€å¯ WAL æœºåˆ¶ï¼ˆbinlogï¼‰ï¼Œè¿™æ ·é‡å¯åå¯ä»¥å›æ”¾ä»»åŠ¡ï¼Œæé«˜äº†å¯ç”¨æ€§ é‡‡ç”¨ç±»ä¼¼ Redis çš„å•çº¿ç¨‹æ¨¡å‹ï¼ˆIO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼‰ï¼Œå› æ­¤ä¸å¿…è€ƒè™‘å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹åŒæ­¥ã€åŠ é”ç­‰ï¼Œç®€åŒ–å®ç° å…³é”®è¯ Tubeï¼šç±»ä¼¼ Kafka ä¸­çš„ Topicï¼Œæˆ–è€…å…¶å®ƒé˜Ÿåˆ—ç³»ç»Ÿä¸­çš„ Channel Jobï¼šå®¢æˆ·ç«¯ç”Ÿäº§å’Œæ¶ˆè´¹çš„åŸºæœ¬å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‰¹å®šçš„ idï¼Œå¯è®¾å®šä¼˜å…ˆçº§ï¼Œè¶…æ—¶æ—¶é—´ï¼Œå»¶è¿Ÿæ‰§è¡Œæ—¶é—´ç­‰ WAL (Write Ahead Log)ï¼šè´Ÿè´£ binlog ç®¡ç†ï¼ˆå†™å…¥ã€å‹ç¼©ã€æ—¥å¿—æ–‡ä»¶æ¸…ç†ã€ä»»åŠ¡æ¢å¤ç­‰ï¼‰ Serverï¼šBeanstalkd æœåŠ¡ç«¯ Connï¼šBeanstalkd å®¢æˆ·ç«¯è¿æ¥å¤„ç† ä»»åŠ¡çŠ¶æ€æµè½¬ ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ å·¥ä½œæ–¹å¼æè¿° æœåŠ¡ç«¯ä¼šæœ‰ä¸€åˆ°å¤šä¸ª tubesï¼ˆåœ¨æ•°ç»„ä¸­ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ª tube éƒ½ä¼šåŒ…å«ä¸€ä¸ªå°±ç»ªé˜Ÿåˆ—ï¼ˆåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ä»¥åŠä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆä¹Ÿåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„ tube ä¸­åº¦è¿‡å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ watch æŒ‡ä»¤è®¢é˜…æŸä¸ª tubeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ ignore å–æ¶ˆè®¢é˜…ï¼Œæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶è®¢é˜…å¤šä¸ª tubeï¼Œå½“æ¶ˆè´¹è€… reserve ä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡å¯èƒ½æ¥è‡ªå…¶ watch list ä¸­çš„ä»»æ„ä¸€ä¸ª tube å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ default tubeï¼Œå¯ä»¥ä½¿ç”¨ use åˆ‡æ¢ tube tube æ˜¯ä¼šæ ¹æ®éœ€è¦éšæ—¶åˆ›å»ºçš„ï¼Œå½“æ²¡æœ‰å®¢æˆ·ç«¯å¼•ç”¨æ—¶ï¼Œå°±ä¼šè¢«åˆ é™¤ å®‰è£…å€ŸåŠ© Docker å¯åŠ¨ä¸€ä¸ª Beanstalkd æœåŠ¡éå¸¸è½»æ¾ï¼Œè¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤è¡Œå³å¯ï¼š 1docker run -d -p 11300:11300 schickling/beanstalkd å¦‚æœä¸Šè¿°å‘½ä»¤è¡Œæ‰§è¡Œæ­£å¸¸ï¼Œåˆ™ Beanstalkd æœåŠ¡åº”è¯¥å¯åŠ¨äº†ï¼Œå…¶é»˜è®¤ç›‘å¬çš„ç«¯å£å·ä¸º 11300ï¼Œè¿è¡Œ docker ps å¯ä»¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œï¼š ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•é¦–å…ˆï¼Œéœ€è¦å‰å¾€ beanstalkd ä»“åº“å…‹éš† Master åˆ†æ”¯æºç è‡³æœ¬åœ°ã€‚ ä¸ºäº†æ–¹ä¾¿ç®¡ç† C é¡¹ç›®ï¼Œè¿™é‡Œä½¿ç”¨äº† JET BRAINS å®¶æ—çš„ Clionã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„å·¥å…·æ‰“å¼€ã€‚ ç”±äº Clion ä½¿ç”¨äº† CMake ç®¡ç† C&amp;C++ é¡¹ç›®ï¼Œæ‰€ä»¥æ‰“å¼€é¡¹ç›®æ—¶éœ€è¦åœ¨å…¶æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª CMakeLists.txt æ–‡ä»¶ï¼Œå¹¶å¡«å†™å¦‚ä¸‹å†…å®¹ï¼š 12345678cmake_minimum_required(VERSION 3.13)project(beanstalkd C)set(BUILD_DIR .)add_custom_target(beanstalkd ALL COMMAND make WORKING_DIRECTORY $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;)add_custom_command(TARGET beanstalkd POST_BUILD COMMAND echo copy $&#123;PROJECT_NAME&#125; to $&#123;CMAKE_CURRENT_BINARY_DIR&#125; COMMAND cp $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/beanstalkd $&#123;CMAKE_CURRENT_BINARY_DIR&#125;) ğŸ‰ è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå·²ç»åšå®Œå•¦ã€‚æ¥ä¸‹æ¥ï¼Œå¯ä»¥å°è¯•ç‚¹å‡»ã€Œæ„å»ºã€æŒ‰é’®ï¼Œè¿›è¡Œç¼–è¯‘ã€‚ç¼–è¯‘ç»“æŸåï¼Œå°±å¯ä»¥ç‚¹å‡»è¿è¡Œå¯åŠ¨ Beanstalkd æœåŠ¡å•¦ã€‚å“¦ï¼Œå¯¹äº†ï¼Œå¦‚æœéœ€è¦è°ƒè¯•æ”¯æŒçš„è¯ï¼Œç›´æ¥åœ¨éœ€è¦çš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶ç‚¹å‡»ã€Œè°ƒè¯•ã€æŒ‰é’®å³å¯å¼€å§‹ã€‚ å…³äº MakefileæŸ¥çœ‹ Makefile æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å‡ ä¸ªå‘½ä»¤å¯ä»¥æ‰§è¡Œï¼š make all: ç¼–è¯‘ã€é“¾æ¥å¹¶ç”Ÿæˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ beanstalkdã€‚ç”±äºæˆ‘ä»¬å·²ç»å°†è¯¥å‘½ä»¤æ”¾åˆ° CMakeLists.txt æ–‡ä»¶ä¸­ï¼Œåœ¨ä½¿ç”¨ Clion æ„å»ºæ—¶å¯è‡ªåŠ¨è§¦å‘ make install: å°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ beanstalkd å®‰è£…åˆ° BINDIR=$(DESTDIR)/usr/local/bin ç›®å½•ä¸‹ make clean: æ¸…ç†ç”Ÿæˆçš„ *.o æ–‡ä»¶ make bench: è·‘ Benchmark ç”¨ å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹ä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚ç”Ÿäº§è€…è´Ÿè´£å°†ä¸€ç»„å¾…æŠ“å–çš„ URLs æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå†ç”±ä¸€ç»„æ¶ˆè´¹è€…å¹¶å‘è®¿é—®é˜Ÿåˆ—ä¸­çš„ URLsã€‚ä¸»æµç¨‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819// ä¼šé¦–å…ˆå¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€…åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ç›‘å¬// ç„¶åè®©ç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­å¡«å…… URLsï¼Œä¾›æ¶ˆè´¹è€…ä½¿ç”¨fn main() &#123; const NUM_WORKERS: isize = 5; let mut handles = vec![]; for i in 0..NUM_WORKERS &#123; // å¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€… let hd = thread::spawn(move || consume_urls(i)); handles.push(hd); &#125; produce_urls(); // ç­‰å¾…æ¶ˆè´¹è€…ç»“æŸ for hd in handles &#123; hd.join().unwrap(); &#125;&#125; ç”Ÿäº§è€…1234567891011121314151617181920fn produce_urls() &#123; let mut client = Beanstalkd::localhost().unwrap(); client.tube("urls").unwrap(); let urls = vec![ "https://github.com/iFaceless/ifaceless.github.io", "https://github.com/iFaceless/gic", "https://github.com/iFaceless/rust-exercises", "https://github.com/iFaceless/learning-rust", "https://github.com/iFaceless/fixture", "https://github.com/iFaceless/rest", "https://github.com/iFaceless/bigcache", "https://github.com/iFaceless/leetgogo", "https://github.com/iFaceless/freecache", ]; for url in urls &#123; client.put(url, 0, 0, 1000).unwrap(); &#125;&#125; æ¶ˆè´¹è€…123456789101112131415161718fn consume_urls(id: isize) &#123; println!("[Consumer &#123;&#125;] started...", id); let mut client = Beanstalkd::localhost().unwrap(); client.watch("urls").unwrap(); loop &#123; let (job_id, url) = match client.reserve() &#123; Ok(job) =&gt; job, Err(e) =&gt; &#123; println!("[Consumer &#123;&#125;] error happens: &#123;&#125;", id, e); break; &#125; &#125;; println!("[Consumer &#123;&#125;] got job &lt;&#123;&#125;&gt;: &#123;&#125;", id, job_id, url); client.delete(job_id).unwrap(); &#125;&#125; æºç æ¢ç´¢æ¨¡å—åˆ†ç±»å›¾ä¸ºäº†æ–¹ä¾¿é˜…è¯»æºç ï¼Œç²—ç•¥åœ°æ ¹æ®è‡ªå·±çš„ç†è§£ç»™å„ä¸ªæ–‡ä»¶åšäº†ç®€å•çš„åˆ†ç±»ï¼š æ¨¡å— UML å›¾è™½è¯´ Beanstalkd çš„æºç æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„è®¾è®¡æ€æƒ³ä¾ç„¶å¯ä»¥ä»é¢å‘å¯¹è±¡çš„è§’åº¦æ¥è§£é‡Šã€‚æ¯”å¦‚æ¨¡å—åŒ–è®¾è®¡ã€æ¥å£è®¾è®¡ã€å¤šæ€ç­‰ã€‚æ ¹æ®è‡ªå·±çš„ç†è§£ï¼Œå¯¹å…¶ä¸­çš„ä¸€äº›æ ¸å¿ƒæ¨¡å—åšäº†æ¢³ç†ï¼Œå¹¶ç»˜åˆ¶äº†ä¸€ä¸ªç®€å•çš„ UML å›¾æ¥åŠ æ·±ç†è§£ï¼š åŸºæœ¬æ•°æ®ç»“æ„æœ€å°å †äºŒå‰å †ï¼ˆHeapï¼‰ æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ã€‚å…¶åˆ†ä¸ºæœ€å¤§å †ï¼ˆä¹Ÿå«å¤§æ ¹å †ï¼‰ å’Œ æœ€å°å †ï¼ˆä¹Ÿå«å°æ ¹å †ï¼‰ï¼š æœ€å¤§å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å¤§è€…çš„å † æœ€å°å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å°è€…çš„å † åœ¨ beanstalkd/heap.c æ˜¯å¯¹æœ€å°å †çš„å®ç°ã€‚é‚£ä¹ˆï¼Œbeanstalkd ä¸­å“ªäº›åœ°æ–¹ç”¨åˆ°äº†æœ€å°å †å‘¢ï¼Ÿ Tube ä¸­çš„å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—ï¼ˆæœ€å…ˆåˆ°æœŸçš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼Œè¿™æ ·å¯ä»¥åœ¨ O(1) æ—¶é—´å¤æ‚åº¦è·å–åˆ°ï¼‰ Tube ä¸­çš„å°±ç»ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆåŸºäºä¼˜å…ˆçº§æ’åˆ—ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼‰ Server ä¸­çš„å®¢æˆ·ç«¯è¿æ¥é˜Ÿåˆ—ï¼ˆåŸºäº tickat æ—¶é—´æ’åˆ—ï¼‰ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æœ€å°å †çš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566intheapinsert(Heap *h, void *x)&#123; int k; // æ‰©å®¹ç­–ç•¥ï¼š2 å€é•¿åº¦ if (h-&gt;len == h-&gt;cap) &#123; void **ndata; int ncap = (h-&gt;len+1) * 2; /* allocate twice what we need */ ndata = malloc(sizeof(void*) * ncap); if (!ndata) &#123; return 0; &#125; memcpy(ndata, h-&gt;data, sizeof(void*)*h-&gt;len); free(h-&gt;data); // æŒ‡å‘æ–°çš„ä½ç½® h-&gt;data = ndata; // æ›´æ–°å®¹é‡ h-&gt;cap = ncap; &#125; k = h-&gt;len; h-&gt;len++; set(h, k, x); siftdown(h, k); return 1;&#125;void *heapremove(Heap *h, int k)&#123; void *x; if (k &gt;= h-&gt;len) &#123; return 0; &#125; x = h-&gt;data[k]; h-&gt;len--; // ç”¨åŸæ¥çš„æ•°ç»„æœ€åä¸€ä½è¦†ç›–è¢«åˆ é™¤çš„ä½ç½® set(h, k, h-&gt;data[h-&gt;len]); siftdown(h, k); siftup(h, k); h-&gt;rec(x, -1); return x;&#125;static voidset(Heap *h, int k, void *x)&#123; h-&gt;data[k] = x; // è¿™é‡Œä¼šå»è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•° h-&gt;rec(x, k);&#125;// åˆ¤æ–­ä½ç½® a æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å°äº b æŒ‡å‘çš„å¯¹è±¡static intless(Heap *h, int a, int b)&#123; // h-&gt;less æ˜¯ä¸€ä¸ªåˆ¤æ–­å¤§å°çš„å›è°ƒ // å…¶å®è¦åœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œå®Œå…¨å¯ä»¥è‡ªå®šä¸€ä¸ªå®ç°äº†æ¯”è¾ƒå¤§å°çš„æ¥å£ // æ¯”å¦‚åœ¨ Rust ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `PartialEq` é™å®š... return h-&gt;less(h-&gt;data[a], h-&gt;data[b]);&#125; å˜é•¿æ•°ç»„åœ¨ C è¯­è¨€æ ‡å‡†åº“ä¸­æ˜¯æ²¡æœ‰å¯å˜é•¿åº¦çš„æ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥åœ¨ beanstalkd/ms.c å®ç°äº†ä¸€ç§ç±»ä¼¼çš„æ•°æ®ç»“æ„ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š ms ç»“æ„ä½“ç»´æŠ¤ä¸€ä¸ªå¯åŠ¨æ€æ‰©å®¹çš„æ•°ç»„ï¼ˆ**itemsï¼‰ æ‰©å®¹ç­–ç•¥å¾ˆç²—æš´ï¼Œç›´æ¥æ‰©å……ä¸ºåŸæ¥å®¹é‡çš„ä¸¤å€ æ’å…¥çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1) åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1) ç”±äºåˆ é™¤æ—¶ï¼Œä¼šå°†å°¾éƒ¨ item æ›¿æ¢æ‰è¢«åˆ é™¤çš„ itemï¼Œæ‰€ä»¥ä¸èƒ½ä¾èµ–æ•°ç»„ä¸­çš„å…ƒç´ é¡ºåºï¼ˆé¡ºåºä¸ä¿è¯å’Œæ·»åŠ æ—¶ä¸€è‡´ï¼‰ åˆ é™¤ item åï¼Œå…¶å®æ•°ç»„å ç”¨çš„å†…å­˜ç©ºé—´è¿˜åœ¨ï¼ˆå¹¶æ²¡æœ‰åŠ¨æ€ç¼©å®¹çš„ç­–ç•¥ï¼‰ é‚£å…·ä½“åœ¨å“ªäº›åœ°æ–¹ç”¨åˆ°äº† ms è¿™ç§æ•°æ®ç»“æ„å‘¢ï¼Ÿæ¢³ç†åï¼Œä¸»è¦å‘ç°ä»¥ä¸‹å‡ å¤„ï¼š å…¨å±€çš„ Tube åˆ—è¡¨ å®¢æˆ·ç«¯è¿æ¥çš„ Conn ä¸­ç»´æŠ¤çš„ watch list ä¸ Tube å…³è”çš„ç­‰å¾…è¿æ¥ï¼ˆconnsï¼‰åˆ—è¡¨ ä¸‹é¢çœ‹çœ‹å…¶å…·ä½“çš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263// åˆå§‹åŒ–æ•°ç»„ï¼Œå¹¶æ³¨å†Œæ’å…¥å’Œç§»é™¤çš„å›è°ƒå‡½æ•°voidms_init(ms a, ms_event_fn oninsert, ms_event_fn onremove)&#123; a-&gt;used = a-&gt;cap = a-&gt;last = 0; a-&gt;items = NULL; a-&gt;oninsert = oninsert; a-&gt;onremove = onremove;&#125;// æ§åˆ¶æ•°ç»„å¢é•¿static voidgrow(ms a)&#123; void **nitems; // å€é€Ÿå¢é•¿ï¼š1, 2, 4, ... size_t ncap = (a-&gt;cap &lt;&lt; 1) ? : 1; nitems = malloc(ncap * sizeof(void *)); if (!nitems) return; // æ—§çš„æ•°æ®æ‹·è´åˆ°æ–°å¼€è¾Ÿçš„ç©ºé—´ memcpy(nitems, a-&gt;items, a-&gt;used * sizeof(void *)); // é‡Šæ”¾æ—§çš„å†…å­˜ç©ºé—´ free(a-&gt;items); // æŒ‡å‘æ–°çš„ä½ç½® a-&gt;items = nitems; // æ›´æ–°æ•°ç»„å®¹é‡ a-&gt;cap = ncap;&#125;// åœ¨æ•°ç»„å°¾éƒ¨æ’å…¥æ–°çš„ item// O(1)intms_append(ms a, void *item)&#123; // æŒ‰éœ€æ‰©å±•å®¹é‡ if (a-&gt;used &gt;= a-&gt;cap) grow(a); // æ‰©å®¹å¤±è´¥ï¼Œå°±è¿”å›ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å†æ–°å¢ item äº† if (a-&gt;used &gt;= a-&gt;cap) return 0; a-&gt;items[a-&gt;used++] = item; // å¦‚æœæœ‰å›è°ƒï¼Œåˆ™è§¦å‘å›è°ƒå‡½æ•° if (a-&gt;oninsert) a-&gt;oninsert(a, item, a-&gt;used - 1); return 1;&#125;// åˆ é™¤æŒ‡å®šä½ç½®çš„ item// O(1)static intms_delete(ms a, size_t i)&#123; void *item; if (i &gt;= a-&gt;used) return 0; item = a-&gt;items[i]; // ç›¸å½“äºæŠŠå°¾éƒ¨ item å†™åˆ°è¢«åˆ é™¤çš„ä½ç½®ï¼Œå¹¶ã€Œç¼©å®¹ã€ a-&gt;items[i] = a-&gt;items[--a-&gt;used]; /* it has already been removed now */ if (a-&gt;onremove) a-&gt;onremove(a, item, i); return 1;&#125; å­—å…¸ åœ¨ beanstalkd/job.c ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿åŸºäº job_id å¿«é€Ÿå®šä½åˆ°å…·ä½“çš„ä»»åŠ¡ï¼Œä½œè€…å®ç°äº†ä¸€ä¸ªå­—å…¸æ•°æ®ç»“æ„ã€‚è¿™é‡Œæ˜¯å’Œ job è€¦åˆåœ¨ä¸€èµ·å®ç°çš„ï¼Œæ ¹æ®å¯¹æºç çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºè¯¥å­—å…¸æ•°æ®ç»“æ„çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š é‡‡ç”¨åŸºäº job_id å“ˆå¸Œå–æ¨¡çš„æ–¹å¼è®¡ç®— slot_id ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çª æ ¹æ®è´Ÿè½½å› å­è‡ªåŠ¨è¿›è¡Œ rehashï¼ˆè¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹ï¼‰ï¼Œæ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç³»æ•°æ ¹æ® beanstalkd/primes.c è®¾ç½® rehash è¿‡ç¨‹å¹¶æ²¡æœ‰é‡‡ç”¨ç±»ä¼¼ Redis ä¸­æ¸è¿›å¼ rehash æœºåˆ¶ï¼Œè€Œæ˜¯é˜»å¡å¼å®Œæˆæ•´ä¸ªå“ˆå¸Œè¡¨çš„ rehash åæ‰å¯ä»¥è¿›è¡Œåç»­æ“ä½œ å­˜æ”¾ job åŠ rehash çš„è¯¦ç»†æºç åˆ†æå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566// å­˜æ”¾ä¸€ä¸ª jobstatic voidstore_job(job j)&#123; int index = 0; index = _get_job_hash_index(j-&gt;r.id); j-&gt;ht_next = all_jobs[index]; // å¦‚æœå­˜åœ¨å†²çªï¼Œå°±é‡‡ç”¨é“¾åœ°å€æ³• all_jobs[index] = j; all_jobs_used++; /* accept a load factor of 4 */ // è´Ÿè½½å› å­è®¾ç½®ä¸º 4ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡Œ rehash // çœ‹èµ·è¿™é‡Œæ˜¯é˜»å¡çš„æ–¹å¼æ¥è¿›è¡Œ rehash äº†ï¼Œå¦‚æœ hash è¡¨å¤ªå¤§ï¼Œä¼šè¢«é˜»å¡ // å¹¶æ²¡æœ‰ä½¿ç”¨ç±»ä¼¼ redis é‚£æ ·æ¸è¿›å¼ rehash æ€è·¯ if (all_jobs_used &gt; (all_jobs_cap &lt;&lt; 2)) rehash(1);&#125;// æ”¯æŒæ‰©å®¹å’Œç¼©å®¹static voidrehash(int is_upscaling)&#123; job *old = all_jobs; // è®°å½•ä¸‹æ—§çš„ hash è¡¨å®¹é‡ï¼Œå…ƒç´ ä¸ªæ•° size_t old_cap = all_jobs_cap, old_used = all_jobs_used, i; int old_prime = cur_prime; int d = is_upscaling ? 1 : -1; if (cur_prime + d &gt;= NUM_PRIMES) return; if (cur_prime + d &lt; 0) return; if (is_upscaling &amp;&amp; hash_table_was_oom) return; cur_prime += d; all_jobs_cap = primes[cur_prime]; all_jobs = calloc(all_jobs_cap, sizeof(job)); if (!all_jobs) &#123; // é’ˆå¯¹æ‰©å®¹å¤±è´¥çš„å¤„ç†ï¼Œæ¢å¤åŸæ¥çš„ä¸å˜ï¼Œä½†æ˜¯æ ‡è®° OOM twarnx("Failed to allocate %zu new hash buckets", all_jobs_cap); hash_table_was_oom = 1; cur_prime = old_prime; all_jobs = old; all_jobs_cap = old_cap; all_jobs_used = old_used; return; &#125; // é‡ç½® hash è¡¨çŠ¶æ€ all_jobs_used = 0; hash_table_was_oom = 0; // å…¶å®å°±æ˜¯æŠŠ Hash è¡¨ä¸Šæ‰€æœ‰çš„ jobs å…¨éƒ¨æ˜ å°„åˆ°æ–°çš„ç©ºé—´ for (i = 0; i &lt; old_cap; i++) &#123; while (old[i]) &#123; job j = old[i]; old[i] = j-&gt;ht_next; j-&gt;ht_next = NULL; store_job(j); &#125; &#125; // ç„¶åæŠŠåŸæ¥çš„å†…å­˜ç©ºé—´é‡Šæ”¾æ‰ if (old != all_jobs_init) &#123; free(old); &#125;&#125; é“¾è¡¨é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„åœ¨ Beanstalkd å®ç°ä¸­ç”¨å¾—æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”å¦‚ beanstalkd/walg.c ä¸­ä½¿ç”¨äº†å•å‘é“¾è¡¨çš„ä¸²è”äº†ä¸€äº›åˆ—çš„æ—¥å¿—æ–‡ä»¶ï¼ˆå‚è§ä¸‰ä¸ªæ¸¸æ ‡æŒ‡é’ˆï¼šhead, cur, tailï¼‰ beanstalkd/conn.c ä½¿ç”¨åŒå‘é“¾è¡¨è¿æ¥äº†ä¸€äº›åˆ—è¢« reserve çš„ä»»åŠ¡ åœ¨ beastalkd/job.cï¼Œå¯ä»¥çœ‹åˆ°ä»»åŠ¡åŒå‘é“¾è¡¨å®ç°ï¼š 123456789101112131415161718192021222324252627282930intjob_list_any_p(job head)&#123; return head-&gt;next != head || head-&gt;prev != head;&#125;jobjob_remove(job j)&#123; if (!j) return NULL; if (!job_list_any_p(j)) return NULL; /* not in a doubly-linked list */ j-&gt;next-&gt;prev = j-&gt;prev; j-&gt;prev-&gt;next = j-&gt;next; j-&gt;prev = j-&gt;next = j; return j;&#125;voidjob_insert(job head, job j)&#123; if (job_list_any_p(j)) return; /* already in a linked list */ j-&gt;prev = head-&gt;prev; j-&gt;next = head; head-&gt;prev-&gt;next = j; head-&gt;prev = j;&#125; éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ main.c123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657intmain(int argc, char **argv) &#123; int r; // å­˜æ”¾ä»»åŠ¡çš„é“¾è¡¨ struct job list = &#123;&#125;; progname = argv[0]; // è®¾ç½®ä½¿ç”¨è¡Œç¼“å­˜ï¼Œè¡¨ä½¿ç”¨æ ‡å‡†è¾“å‡ºä½œä¸ºæ‰“å°ç›®æ ‡ // è¯¦ç»†æ–‡æ¡£å‚è§ï¼šhttps://linux.die.net/man/3/setlinebuf // æ„æ€æ˜¯ï¼Œåªæœ‰åœ¨æ»¡è¶³ä¸€è¡Œï¼ˆæ¢è¡Œï¼‰æ—¶æ‰è¾“å‡º setlinebuf(stdout); // å‘½ä»¤è¡Œå¤„ç† optparse(&amp;srv, argv + 1); if (verbose) &#123; printf("pid %d\n", getpid()); &#125; // æœåŠ¡å™¨ç«¯ socket åˆå§‹åŒ–ç­‰ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ socket çš„ file descriptor r = make_server_socket(srv.addr, srv.port); if (r == -1) twarnx("make_server_socket()"), exit(111); srv.sock.fd = r; // åè®®å¤„ç†æ¨¡å—åˆå§‹åŒ– prot_init(); if (srv.user) su(srv.user); set_sig_handlers(); if (srv.wal.use) &#123; // We want to make sure that only one beanstalkd tries // to use the wal directory at a time. So acquire a lock // now and never release it. // WAL å³ Write Ahead Log Directoryï¼Œä¸»è¦æ˜¯è®°å½•æ—¥å¿—ç”¨ // è¿™é‡Œæ˜¯è¦ä¿è¯æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ª beanstalkd å®ä¾‹ä½¿ç”¨ WAL ç›®å½•ï¼Œé˜²æ­¢ç›¸äº’å†™å…¥å†²çª // é‚£ä¼°è®¡ä»¥åå°±æ²¡æ³•ä» binlog æ¢å¤ä»»åŠ¡äº†ã€‚ã€‚ã€‚ if (!waldirlock(&amp;srv.wal)) &#123; twarnx("failed to lock wal dir %s", srv.wal.dir); exit(10); &#125; // åˆå§‹åŒ–ä»»åŠ¡é“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰ list.prev = list.next = &amp;list; // åˆå§‹åŒ– WALï¼Œå¦‚æœ log ä¸­æœ‰ä»»åŠ¡ï¼Œè¿˜è¦æ¢å¤å›æ¥ï¼ŒæŒ‚è½½åˆ° job list walinit(&amp;srv.wal, &amp;list); // å›æ”¾ä»»åŠ¡æ‰§è¡Œ r = prot_replay(&amp;srv, &amp;list); if (!r) &#123; twarnx("failed to replay log"); return 1; &#125; &#125; // æ­£å¼å¯åŠ¨ serverï¼Œå¹¶ç›‘å¬è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚äº† srvserve(&amp;srv); return 0;&#125; serv.c1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556voidsrvserve(Server *s)&#123; int r; Socket *sock; int64 period; if (sockinit() == -1) &#123; twarnx("sockinit"); exit(1); &#125; s-&gt;sock.x = s; // æŒ‡å®šå›è°ƒï¼Œå½“æ¥æ”¶åˆ° `r` äº‹ä»¶åï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ s-&gt;sock.f = (Handle)srvaccept; // Server ç»´æŠ¤äº†å…³è”çš„å®¢æˆ·ç«¯è¿æ¥ï¼ˆæœ€å°å †ï¼‰ s-&gt;conns.less = (Less)connless; s-&gt;conns.rec = (Record)connrec; r = listen(s-&gt;sock.fd, 1024); if (r == -1) &#123; twarn("listen"); return; &#125; // æ³¨å†Œ r = sockwant(&amp;s-&gt;sock, 'r'); if (r == -1) &#123; twarn("sockwant"); exit(2); &#125; for (;;) &#123; // æ‰§è¡Œå‘¨æœŸæ€§çš„ä»»åŠ¡ // å¦‚æœ tick ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ—¶é—´è¿‡ä¹…ï¼Œä¼šé˜»å¡åé¢çš„ socket connection å¤„ç† // ä¸¥é‡ä¼šå¯¼è‡´è¶…æ—¶ï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯é‡è¯•è¿‡å¤šï¼Œåˆ™å›å¢åŠ æœåŠ¡ç«¯è´Ÿè½½ period = prottick(s); // è½®è¯¢æ˜¯å¦æœ‰å°±ç»ªçš„è¯·æ±‚ï¼ˆrwï¼‰ï¼Œå…¶å®å°±æ˜¯ä¸ªé€‚é…å™¨ï¼Œå°†å…·ä½“å¹³å°ä¸‹è¿”å›çš„çŠ¶æ€ // è½¬æ¢æˆç»Ÿä¸€çš„ `r`, `w`, `h` // Linux ä½¿ç”¨ epoll å°è£…ï¼ˆå‚è§ `linux.c`ï¼‰ // Unix ä½¿ç”¨ kqueue å°è£…ï¼ˆå‚è§ `darwin.c`ï¼‰ int rw = socknext(&amp;sock, period); if (rw == -1) &#123; twarnx("socknext"); exit(1); &#125; if (rw) &#123; // å¦‚æœè½®è¯¢åˆ°éœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å›è°ƒ Handle // æ³¨æ„ï¼Œè¿™é‡Œçš„å›è°ƒä¾ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¦‚æœä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œå°±å‘µå‘µå“’äº† sock-&gt;f(sock-&gt;x, rw); &#125; &#125;&#125; tube.c12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394// æ–°å»º tubeï¼Œè¿™é‡Œéœ€è¦ç»™å®š tube åç§°// è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª tube æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç»„æˆï¼š// 1. ç»´æŠ¤å°±ç»ªä»»åŠ¡çš„å †// 2. ç»´æŠ¤å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„å †// 3. ç»´æŠ¤å¤„äº buried çŠ¶æ€çš„ä»»åŠ¡é“¾è¡¨// 4. ç»´æŠ¤ä¸€ä¸ªç­‰å¾…åˆ—è¡¨tubemake_tube(const char *name)&#123; tube t; // åˆ†é…å†…å­˜ç©ºé—´ï¼Œç”¨äºå­˜å‚¨ tube ç»“æ„ä½“å€¼ t = new(struct tube); if (!t) return NULL; // åˆå§‹åŒ– tube åç§° t-&gt;name[MAX_TUBE_NAME_LEN - 1] = '\0'; strncpy(t-&gt;name, name, MAX_TUBE_NAME_LEN - 1); if (t-&gt;name[MAX_TUBE_NAME_LEN - 1] != '\0') twarnx("truncating tube name"); // ready å †ç»´æŠ¤ç€ä¸€äº›å·²ç»å°±ç»ªçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‡å®šæŒ‰ç…§ job ä¼˜å…ˆçº§çš„æ–¹å¼æ¯”è¾ƒå¤§å° // è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ job t-&gt;ready.less = job_pri_less; // delay å †ç»´æŠ¤ç€ä¸€äº›è¢«å»¶è¿Ÿæ‰§è¡Œçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‰ç…§ job delay æ—¶é—´æ¯”è¾ƒå¤§å° // è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯å»¶è¿Ÿæ—¶é—´æœ€çŸ­çš„ job t-&gt;delay.less = job_delay_less; // ç”¨äºè®°å½• job åœ¨å †ä¸Šçš„ä½ç½® t-&gt;ready.rec = job_setheappos; t-&gt;delay.rec = job_setheappos; t-&gt;buried = (struct job) &#123; &#125;; // ä½¿ç”¨é“¾è¡¨ç»´æŠ¤ç€è¢« bury æ‰çš„ job t-&gt;buried.prev = t-&gt;buried.next = &amp;t-&gt;buried; // åˆå§‹åŒ–æ’é˜Ÿåˆ—è¡¨ ms_init(&amp;t-&gt;waiting, NULL, NULL); return t;&#125;// é‡Šæ”¾ tubestatic voidtube_free(tube t)&#123; // å®é™…å°±æ˜¯ä»å…¨å±€çš„ tubes åˆ—è¡¨ä¸­ç§»é™¤è¯¥ tube prot_remove_tube(t); // é‡Šæ”¾å°±ç»ªçš„ä»»åŠ¡ free(t-&gt;ready.data); // é‡Šæ”¾å»¶è¿Ÿçš„ä»»åŠ¡ free(t-&gt;delay.data); // æ¸…ç©ºç­‰å¾…åˆ—è¡¨ ms_clear(&amp;t-&gt;waiting); // é‡Šæ”¾ tube æŒ‡å‘çš„å†…å­˜ free(t);&#125;// å¼•ç”¨è®¡æ•°ï¼šå‡å¼•ç”¨voidtube_dref(tube t)&#123; if (!t) return; if (t-&gt;refs &lt; 1) return twarnx("refs is zero for tube: %s", t-&gt;name); --t-&gt;refs; // æ²¡æœ‰å¼•ç”¨åå°±å¯ä»¥é‡Šæ”¾è¯¥ tube äº† if (t-&gt;refs &lt; 1) tube_free(t);&#125;// å¼•ç”¨è®¡æ•°ï¼šå¢åŠ å¼•ç”¨voidtube_iref(tube t)&#123; if (!t) return; ++t-&gt;refs;&#125;// æ–°å»ºä¸€ä¸ª tubeï¼Œç„¶åæ³¨å†Œåˆ°å…¨å±€ tubes åˆ—è¡¨static tubemake_and_insert_tube(const char *name)&#123; int r; tube t = NULL; t = make_tube(name); if (!t) return NULL; /* We want this global tube list to behave like "weak" refs, so don't * increment the ref count. */ // è¿™é‡Œæ˜¯æƒ³è®©å…¨å±€ tube åˆ—è¡¨è¡¨ç°ä¸ºå¼±å¼•ç”¨ï¼Œæ‰€è¿™é‡Œå¹¶æ²¡æœ‰åšå¢åŠ å¼•ç”¨çš„æ“ä½œ r = ms_append(&amp;tubes, t); // å¦‚æœæ³¨å†Œ tube å¤±è´¥ï¼Œå‡å¼•ç”¨ï¼Œå¿…è¦çš„è¯ä¼šè¢«é‡Šæ”¾æ‰ if (!r) return tube_dref(t), (tube) 0; return t;&#125; job.cåœ¨ Tube ä¸­æœ‰ä¸¤ä¸ªæœ€å°å †æ•°æ®ç»“æ„åˆ†åˆ«å­˜æ”¾è¢«å»¶è¿Ÿçš„ä»»ä½•å’Œå°±ç»ªçš„ä»»åŠ¡ï¼Œè¿™ä¸¤ç§ä½¿ç”¨çš„æ’åºæ–¹å¼æ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬çœ‹åˆ°åœ¨ä¸Šé¢çš„ Tube åˆå§‹åŒ–æ—¶ï¼Œç»™ä¸¤ä¸ªå †ç»‘å®šäº†ä¸åŒçš„æ¯”è¾ƒå¤§å°çš„å›è°ƒï¼š 12t-&gt;ready.less = job_pri_less;t-&gt;delay.less = job_delay_less; ä»¥ä¸‹å¯ä»¥çœ‹åˆ°å…·ä½“çš„æ’åºæ–¹å¼ï¼š 12345678910111213141516171819// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºä¼˜å…ˆçº§æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°intjob_pri_less(void *ax, void *bx)&#123; job a = ax, b = bx; if (a-&gt;r.pri &lt; b-&gt;r.pri) return 1; if (a-&gt;r.pri &gt; b-&gt;r.pri) return 0; return a-&gt;r.id &lt; b-&gt;r.id;&#125;// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºåˆ°æœŸæ—¶é—´æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°intjob_delay_less(void *ax, void *bx)&#123; job a = ax, b = bx; if (a-&gt;r.deadline_at &lt; b-&gt;r.deadline_at) return 1; if (a-&gt;r.deadline_at &gt; b-&gt;r.deadline_at) return 0; return a-&gt;r.id &lt; b-&gt;r.id;&#125; è¯»åæ„Ÿæ•´ä¸ª Beanstalkd çš„æ ¸å¿ƒçš„ä»£ç ä¸è¿‡äº”åƒè¡Œå·¦å³ï¼Œä½†è¿™å°±å®ç°äº†ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œçš„ç¡®æ˜¯å¾ˆå‰å®³ã€‚ä¸è¿‡ï¼Œä¹Ÿæ­£å› ä¸ºå…¶å®ç°æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼ Redis çš„ä¸»ä»æœºåˆ¶ç­‰ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¹¶æ²¡æœ‰å®Œæ•´åœ°å‰–ææ‰€æœ‰çš„æ¨¡å—å®ç°ï¼Œåªæ˜¯åˆ—å‡ºäº†ä¸ªäººæ¯”è¾ƒæ„Ÿå…´è¶£çš„æ¨¡å—ï¼›å…³äº binlog ç®¡ç†çš„æºç ï¼ˆæ¯”å¦‚åƒåœ¾å›æ”¶ï¼Œå‹ç¼©ï¼Œé¢„ç•™ç©ºé—´ç”³è¯·ï¼Œä»»åŠ¡æ¢å¤ç­‰ï¼‰åªæ˜¯ç²—ç•¥åœ°é˜…è¯»äº†ä¸‹ï¼Œå°±ä¸åœ¨æ­¤å¤„çŒ®ä¸‘å•¦~ æ€»çš„æ¥è¯´ï¼Œå¯¹äºå•æœºæ¶ˆæ¯é˜Ÿåˆ—å®ç°æ„Ÿå…´è¶£çš„åŒå­¦è¿˜æ˜¯æ¨èé˜…è¯»ä¸‹è¯¥ç³»ç»Ÿçš„æºç ï¼Œå¯ä»¥å­¦ä¹ å…¶ä¸­çš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œå®ç°æ€è·¯ç­‰~ å‚è€ƒ beanstalkd çš„ä¸€äº›çœ‹æ³• beanstalkd repo beanstalkd docs æ¶ˆæ¯é˜Ÿåˆ— beanstalkd æºç è¯¦è§£ æœ€å¤§â€”æœ€å°å † å»¶ä¼¸é˜…è¯» Kqueue ä¸ Epoll æœºåˆ¶ ä» 0åˆ° 100â€”â€”çŸ¥ä¹æ¶æ„å˜è¿å²]]></content>
      <categories>
        <category>æ¶ˆæ¯é˜Ÿåˆ—</category>
      </categories>
      <tags>
        <tag>æºç å­¦ä¹ </tag>
        <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
        <tag>Beanstalkd</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹å­¦ä¹ ç¬”è®°ä¹‹ç¼–ç¨‹èŒƒå¼]]></title>
    <url>%2F2019%2F01%2F03%2Fclean-arch-notes-paradigms%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è¿‘æ¥å¼€å§‹é˜…è¯» Robert C. Martin çš„æ–°è‘—ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹ï¼ˆClean Architectureï¼‰ã€‚æ²¡æœ‰äººæ„¿æ„çœ‹åˆ°å›¢é˜Ÿå†…çš„é¡¹ç›®é€æ¸å‘å±•æˆä¸€å›¢ä¹±éº»ï¼Œç›¸äº’çº ç¼ ã€‚é‚£å¦‚ä½•ä»æ ¹æœ¬ä¸Šå‡å°‘è¿™ç§é—®é¢˜çš„å‘ç”Ÿå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬æŒæ¡ä¸€äº›å®è§‚å±‚é¢çš„è®¾è®¡æ€æƒ³ï¼Œä»ç»™é¡¹ç›®æ‰“åŸºç¡€æ—¶å°±åº”è¯¥è€ƒè™‘å¥½å„ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°ç­‰å¦‚ä½•è®¾è®¡æˆé«˜å†…èšã€ä½è€¦åˆçš„ç»“æ„ã€‚æ•´æ´çš„é¡¹ç›®æ¶æ„æ˜¯åˆ©äºé•¿è¿œå‘å±•çš„ï¼Œè¿™ç¯‡ç¬”è®°å°†ä¼šè®°å½•ä¸€äº›ä»ä¹¦ä¸­å­¦ä¹ åˆ°çš„é‡è¦çŸ¥è¯†ç‚¹ï¼Œä¾¿äºåæœŸå¤ä¹ å’Œå‚è€ƒã€‚ å½“ç„¶ï¼Œä½œè€…è¿˜æœ‰ä¸€æœ¬å¤§åé¼é¼çš„è‘—ä½œã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ä¹Ÿéå¸¸å€¼å¾—é˜…è¯»ï¼Œå…³äºè¿™æœ¬ä¹¦ä¹Ÿåšäº†ç‚¹ç¬”è®°ï¼Œå‚è§ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹è¯»ä¹¦ç¬”è®°~ è¦ç‚¹è®°å½•ä¸‰å¤§ç¼–ç¨‹èŒƒå¼æ˜¯æ ¹åŸºï¼Œæ¯ç§èŒƒå¼å…¶å®éƒ½ç»™æˆ‘ä»¬å¸¦èµ°äº†ä¸€äº›ä¸œè¥¿ï¼šgoto è¯­å¥ã€å‡½æ•°æŒ‡é’ˆã€èµ‹å€¼ã€‚ä¸‰ç§ç¼–ç¨‹èŒƒå¼çš„æ€»ç»“ï¼š ç»“æ„åŒ–ç¼–ç¨‹ï¼šDiscovered by Edsger Wybe Dijkstra in 1968. Structured programming imposes discipline on direct transfer of control. é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼šDiscovered by Ole Johan and Kristen Nygaard in 1966. Object-oriented programming imposes discipline on indirect transfer of control. å‡½æ•°å¼ç¼–ç¨‹ï¼šInvented by Alonzo Church in 1936. Functional programming imposes discipline upon assignment. ä»¥ä¸Šä¸‰ç§ç¼–ç¨‹èŒƒå¼ä¼šå½±å“åˆ°æ¶æ„çš„æ–¹æ–¹é¢é¢ï¼šæˆ‘ä»¬ä½¿ç”¨å¤šæ€æœºåˆ¶è·¨è¶Šæ¶æ„è¾¹ç•Œï¼›ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å½±å“æ•°æ®ä½ç½®å’Œè®¿é—®ï¼›ä½¿ç”¨ç»“æ„åŒ–ç¼–ç¨‹æ„å»ºåŸºç¡€ç®—æ³•æ¨¡å—ï¼ˆåŸºçŸ³ï¼‰ã€‚å¯ä»¥å¯¹ç…§è½¯ä»¶æ¶æ„ä¸‰å¤§æ¦‚å¿µï¼šåŠŸèƒ½ã€ç»„ä»¶éš”ç¦»å’Œæ•°æ®ç®¡ç†ã€‚ ç»“æ„åŒ–ç¼–ç¨‹ ä»»ä½•ç¨‹åºéƒ½å¯ä»¥ç”±ä¸‰ç§ç»“æ„ç»„æˆï¼š Sequence Selection Iteration ç»“æ„åŒ–ç¼–ç¨‹å…è®¸æ¨¡å—å¯ä»¥è¢«é€’å½’åœ°åˆ†å‰²æˆå¾ˆå¤šå°çš„å¯è¢«è¯æ˜çš„å•å…ƒï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ¨¡å—å¯ä»¥æŒ‰ç…§åŠŸèƒ½è§£è€¦ ç§‘å­¦å¹¶éä¾é è¯æ˜æŸäº›å£°æ˜æ­£ç¡®è€Œå­˜åœ¨ï¼Œè€Œæ˜¯è¯æ˜å®ƒä»¬æ˜¯é”™è¯¯çš„ï¼ˆScience does not work by proving statements true, but rather by proving statements falseï¼‰ã€‚å¹¶éæ‰€æœ‰çš„äº‹æƒ…éƒ½å¯ä»¥è¢«è¯å®çš„~ Mathmematics is the discipline of proving provable statements true. Science, in contrast, is the discipline of proving provable statements false Dijkstra æ›¾ç»è¯´è¿‡ Testing shows the presence, not the absence, of bugsã€‚æµ‹è¯•å¹¶ä¸èƒ½ä¿è¯ä½ çš„ç¨‹åºä¸€å®šæ­£ç¡®ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æµ‹è¯•è¯æ˜ä½ çš„ç¨‹åºå­˜åœ¨é”™è¯¯ï¼Œå¹¶é€šè¿‡å……åˆ†æµ‹è¯•ï¼Œè®©ä½ çš„ç¨‹åºæ›´åŠ æ­£ç¡®ï¼Œç›´åˆ°æ»¡è¶³æˆ‘ä»¬çš„é¢„æœŸ é¢å‘å¯¹è±¡ç¼–ç¨‹ è®¾è®¡è‰¯å¥½çš„æ¶æ„éœ€è¦æˆ‘ä»¬ç†è§£å¹¶åº”ç”¨ OO çš„ä¸€äº›åŸåˆ™ ä»€ä¹ˆæ˜¯é¢å‘å¯¹è±¡ï¼š æ•°æ® + è¡Œä¸ºçš„ç»„åˆ ä¸ºçœŸå®ä¸–ç•Œå»ºæ¨¡ å°è£…ï¼ˆEncapsulationï¼‰ã€ç»§æ‰¿ï¼ˆInheritanceï¼‰å’Œå¤šæ€ï¼ˆPolymorphismï¼‰ UNIX ç³»ç»Ÿè¦æ±‚æ¯ä¸ª IO è®¾å¤‡é©±åŠ¨éƒ½éœ€è¦æä¾›äº”ä¸ªæ ‡å‡†å‡½æ•°ï¼šopen, close, read, write å’Œ seek å¤šæ€å®é™…ä¸Šå°±æ˜¯å‡½æ•°æŒ‡é’ˆçš„åº”ç”¨ï¼Œè‡ªä»å†¯è¯ºä¾æ›¼æ¶æ„è¯ç”Ÿä»¥æ¥ï¼Œç¨‹åºå‘˜ä»¬å°±ä¸€ç›´åœ¨ä½¿ç”¨è¿™ç§æŠ€æœ¯äº†ã€‚ä½†æ˜¯æ˜¾å¼åœ°ä½¿ç”¨å‡½æ•°æŒ‡é’ˆæ˜¯å¾ˆå±é™©çš„ï¼Œå¹¶ä¸”ä½¿ç”¨æ—¶éœ€è¦éµå¾ªä¸€äº›åŸåˆ™ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚OO åˆ™å°†ä½ ä»ä¸­è§£æ”¾å‡ºæ¥ï¼Œè®©ä½ æ›´åŠ è½»æ¾åœ°å®ç°å¤šæ€ã€‚ OO å…è®¸åœ¨ä»»ä½•åœ°æ–¹ï¼Œä¸ºä»»ä½•æƒ…å½¢ä½¿ç”¨æ’ä»¶å¼æ¶æ„ï¼ˆä¸»è¦æ˜¯å¤šæ€çš„å¨åŠ›ï¼Œå…¶å®åœ¨å…¶å®ƒè¯­è¨€ä¸­ï¼Œå¦‚ Rust/Goï¼Œä½¿ç”¨æ¥å£æœºåˆ¶ä¹Ÿèƒ½è¾¾åˆ°ç±»ä¼¼çš„ç›®çš„ï¼‰ ä½¿ç”¨ OO è¯­è¨€å¯ä»¥å®Œå…¨æ§åˆ¶ç³»ç»Ÿä¸­æºç çš„ä¾èµ–æ–¹å‘ã€‚å¤šæ€æœºåˆ¶å¯ä»¥è®©ä»»ä½•æºç ä¾èµ–éƒ½å¯ä»¥è¢«å€’ç½®ï¼Œæ— è®ºå®ƒä»¬åœ¨å“ªå„¿ OO å¸¦æ¥çš„å¥½å¤„ï¼Œç”¨å‡ ä¸ªå…³é”®å­—æ¦‚æ‹¬ï¼š ä¾èµ–å€’ç½®ï¼ˆDependency inversionï¼‰ å¯ç‹¬ç«‹éƒ¨ç½²æ€§ï¼ˆIndependent deployabilityï¼‰ å¯ç‹¬ç«‹å¼€å‘æ€§ï¼ˆIndependent developabilityï¼‰ ä»è½¯ä»¶æ¶æ„çš„è§’åº¦çœ‹ï¼Œé¢å‘å¯¹è±¡å¯ä»¥é€šè¿‡ä½¿ç”¨å¼ºå¤§çš„å¤šæ€æœºåˆ¶ï¼Œæ¥æ§åˆ¶ç³»ç»Ÿæºç ä¾èµ–ã€‚è¿™æ ·å¯ä»¥åˆ›å»ºå‡ºæ’ä»¶å¼æ¶æ„ï¼Œå¯ä»¥å°†æ›´é«˜å±‚çš„æŠ½è±¡ç­–ç•¥å’Œåº•å±‚çš„å®ç°éš”ç¦»å¼€ã€‚åº•å±‚çš„å®ç°ç»†èŠ‚äº¤ç»™å„ä¸ªæ’ä»¶å»å®Œæˆï¼Œå¹¶ä¸”å®ƒä»¬å¯ä»¥è¢«ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼Œè€Œä¸ä¼šå’Œæ›´é«˜å±‚çš„æ¨¡å—è€¦åˆã€‚ å‡½æ•°å¼ç¼–ç¨‹ æ‰€æœ‰çš„ç«äº‰æ¡ä»¶ã€æ­»é”æ¡ä»¶å’Œå¹¶å‘æ›´æ–°çš„é—®é¢˜éƒ½æ˜¯ç”±å¯å˜å˜é‡å¯¼è‡´çš„ã€‚å‡½æ•°å¼ç¼–ç¨‹åˆ™é™åˆ¶äº†å˜é‡ä¿®æ”¹ å°†å¯å˜å’Œä¸å¯å˜çš„ç»„ä»¶éš”ç¦»å¼€æ¥ï¼šä¸å¯å˜ç»„ä»¶ä½¿ç”¨å‡½æ•°å¼æ‰§è¡Œä»»åŠ¡ï¼ˆä¸ä½¿ç”¨ä»»ä½•å¯å˜é‡ï¼‰ï¼›ä¸å¯å˜ç»„ä»¶é€šè¿‡å’Œå¯å˜ç»„ä»¶é€šä¿¡çš„æ–¹å¼æ¥åšçŠ¶æ€å˜æ›´ Event Sourcing: æ ¸å¿ƒç­–ç•¥æ˜¯ä¸å­˜å‚¨çŠ¶æ€ï¼Œè€Œæ˜¯å­˜å‚¨äº‹åŠ¡ã€‚å½“éœ€è¦è·å–çŠ¶æ€æ—¶ï¼Œåªéœ€è¦ä»æœ€å¼€å§‹å›æ”¾äº‹åŠ¡ï¼Œæœ€ç»ˆå¾—åˆ°æƒ³è¦çš„çŠ¶æ€ã€‚è¿™æ ·çš„ç³»ç»Ÿå°±åªæœ‰ CRï¼ˆåˆ›å»ºã€è¯»å–ï¼‰ äº†ï¼Œè€Œä¸ä¼šå­˜åœ¨çŠ¶æ€æ›´æ–°å’Œåˆ é™¤ã€‚å› æ­¤ï¼Œå¾ˆå¤šå¹¶å‘å¼•æ¥çš„æ›´æ–°é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿï¼ˆå…¶å®å¯ä»¥å¯¹æ¯”ä¸‹åŸºäºæ—¥å¿—å¼ LSM çš„å­˜å‚¨å¼•æ“ï¼‰ã€‚ æ€»ç»“ç»“æ„åŒ–ç¼–ç¨‹ã€å‡½æ•°å¼ç¼–ç¨‹ä»¥åŠé¢å‘å¯¹è±¡ç¼–ç¨‹éƒ½åˆ†åˆ«ç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸åŒçš„é™åˆ¶ï¼ˆTo tell us what not to doï¼‰ï¼Œè€Œéå¸¦æ¥æ–°çš„åŠŸèƒ½ã€‚è½¯ä»¶å¹¶éå¿«é€Ÿå‘å±•çš„é«˜ç§‘æŠ€ï¼Œå› æ­¤å¾ˆå¤šåŸåˆ™è‡³ä»Šä¾ç„¶é€‚ç”¨ã€‚ä¸ç®¡æœºå™¨æ€ä¹ˆå˜åŒ–ã€å·¥å…·å¦‚ä½•å˜å¾—æ›´å¥½ï¼Œä½†è½¯ä»¶çš„æœ¬è´¨è¿˜æ˜¯ä¸€æ ·ã€‚æ‰€è°“çš„è½¯ä»¶ç¨‹åºä¸è¿‡å°±æ˜¯ç”±é¡ºåºã€é€‰æ‹©ã€å¾ªç¯ç»“æ„ï¼ˆé—´æ¥ï¼‰ç»„æˆï¼Œä¸å¤šä¸å°‘ã€‚]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æ¶æ„</tag>
        <tag>è®¾è®¡æ€ç»´</tag>
        <tag>ç¼–ç¨‹èŒƒå¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Rust å…¥å‘è®°]]></title>
    <url>%2F2018%2F12%2F31%2Frust-learning-notes%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è°¢å¤©è°¢åœ°ï¼Œæ€»ç®—èµ¶åœ¨ 2018 å¹´ç»“æŸå‰å®Œæˆäº† Rust ä¹‹æ—…ï¼ˆå½“ç„¶è¿˜æ˜¯å…¥é—¨çº§åˆ«ï¼‰ã€‚ä¹‹æ‰€ä»¥æƒ³è¦å…¥å‘è¿™é—¨è¯­è¨€ï¼Œä¹Ÿæ˜¯æƒ³è¦åœ¨ç ”ç©¶ TiKV æ—¶å€™ä¸è¦è¢«è¯­è¨€å¡ä¸»ã€‚å¦å¤–ï¼Œå­¦ä¹ æ–°çš„è¯­è¨€ä¹Ÿæ˜¯ä¸ºäº†å¼€é˜”è§†é‡ï¼Œå­¦ä¹ æ–°çš„æ€è·¯~æ­£å¦‚å¾ˆå¤šå‰è¾ˆæ‰€è¨€ï¼ŒRust çš„é—¨æ§›å…¶å®æŒºé«˜çš„ï¼Œæ‰€ä»¥ç»å¯¹ä¸é€‚åˆæ–°æ‰‹ä½œä¸ºå…¥é—¨è¯­è¨€ï¼å¹¸è¿çš„æ˜¯ï¼Œæ—©äº›å¹´å°±æ¥è§¦å¹¶å­¦ä¹ äº† C, Java, C#, Python, Go ç­‰è¯­è¨€ï¼Œæ‰€ä»¥å¯¹äºå…¶ä¸­æŸäº›ç±»ä¼¼çš„æ¦‚å¿µç†è§£èµ·æ¥å°±æ¯”è¾ƒè½»æ¾ï¼ˆå¦‚ trait, struct å’Œä¸€äº›é¢å‘å¯¹è±¡çš„æ¨¡å¼ç­‰ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™é—¨è¯­è¨€è¿˜æ˜¯æœ‰å¾ˆå¤šæ¯”è¾ƒæ–°çš„æ¦‚å¿µéå¸¸ä¸ä¼—ä¸åŒï¼š æ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸã€ç”Ÿå‘½å‘¨æœŸæ³¨è§£ Trait å’Œ Trait Objects å£°æ˜å®å’Œè¿‡ç¨‹å® æ™ºèƒ½æŒ‡é’ˆï¼ˆæˆ‘æ²¡äº†è§£è¿‡ C++ çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä¸å¥½å¯¹æ¯”ï¼‰ éå¸¸å¼ºå¤§çš„æ¨¡å¼åŒ¹é…ï¼ˆèŠ±æ ·éå¸¸å¤šï¼‰ éå¸¸å¯çˆ±çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼ˆå¯¹æ¯”ä¸‹ Go å‘†æ¿å¤„ç†æ–¹å¼å°±çŸ¥é“äº†ï¼‰ å…³äºè¯­æ³•æ–¹é¢ï¼Œå€’æ˜¯è§‰å¾—å¯ä»¥ã€Œå¿å—ã€ï¼Œæ¯•ç«Ÿä¹ æƒ¯äº†ä¹Ÿå°±å¯ä»¥äº†ã€‚ä½†æ˜¯ç”±äºæ¦‚å¿µå¾ˆå¤šï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„ç¬¦å·å¤ªå¤šï¼ˆé”®ç›˜ä¸Šä½ èƒ½çœ‹åˆ°çš„ç¬¦å·åŸºæœ¬éƒ½ç”¨ä¸Šäº†ï¼‰ï¼Œè¿˜æ˜¯éœ€è¦å¼ºå¤§çš„ç†è§£åŠ›å’Œè®°å¿†åŠ›æ‰å¯ä»¥æŠŠæŒä½å§ï¼Œè‡³å°‘åƒæˆ‘è¿™æ ·çš„è€äººå®¶è¡¨ç¤ºçœ‹å®Œä¸€éæ ¹æœ¬ä¸è¡Œï¼Œä¸ç®¡æ€ä¹ˆæ ·ï¼Œå…ˆå…¥å‘~ å…¥å‘æ—¶å­¦ä¹ çš„æ˜¯å®˜æ–¹æ¨èçš„ Rust Bookï¼Œå¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬å¯ä»¥å‚è€ƒ Rust ç¨‹åºè®¾è®¡è¯­è¨€ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–‡è¯‘æœ¬æœ‰äº›ç¿»è¯‘ä¸å¤ªé€šé¡ºçš„åœ°æ–¹ï¼Œæ‰€ä»¥å¯ä»¥å¯¹ç…§ç€å»çœ‹è‹±æ–‡ç‰ˆ~ å‰æ®µæ—¶é—´ Rust 1.31.0 å‘å¸ƒäº†ï¼Œæ‰€ä»¥ä¹Ÿè·Ÿç€å‡çº§äº†ä¸‹ã€‚ç”±äºä¹¦ä¸­çš„ä¾‹å­åº”è¯¥æ˜¯ä»¥ Rust 2015 ç‰ˆæœ¬ä¸ºä¸»çš„ï¼Œæ‰€ä»¥æœ‰æå°‘éƒ¨åˆ†ç¤ºä¾‹ä¸èƒ½åœ¨ Rust 2018 ä¸­ä½¿ç”¨ï¼Œå¯ä»¥å‚ç…§æç¤ºï¼Œä½¿ç”¨ cargo fix ä¸€ä¸‹å³å¯å®Œæˆè¿ç§»~ å­¦ä¹ è¿‡ç¨‹ä¸­æ•²äº†äº›ä»£ç ï¼Œå‚è§ Learning Rust ä»“åº“ï¼Œæœ‰å…´è¶£ä¹Ÿå¯ä»¥å»çœ‹ï¼Œä»£ç ä¸­æ·»åŠ å¾ˆå¤šæ³¨é‡Šï¼Œåº”è¯¥å¯ä»¥å¸®åŠ©ç†è§£~ ä¸‹é¢æŠŠå­¦ä¹ æœŸé—´åšçš„ç¬”è®°åšä¸ªæ±‡æ€»ï¼Œæ–¹ä¾¿è€äººå®¶å›é¡¾~ å˜é‡ Rust ä¸­å˜é‡åˆ†ä¸ºä¸¤ç§ï¼š ä¸å¯å˜çš„å˜é‡ï¼ˆåªè¯»ï¼‰ å¯å˜çš„å˜é‡ï¼ˆmut å£°æ˜ï¼‰ å£°æ˜çš„åŒåå˜é‡å…·æœ‰ shadowing æ•ˆæœ å¯ä»¥å®šä¹‰å¸¸é‡ï¼Œä½¿ç”¨å…³é”®è¯ const å®šä¹‰ å˜é‡ä¸å¸¸é‡çš„åŒºåˆ«ï¼š å˜é‡çš„èµ‹å€¼å¯ä»¥æ¥è‡ªæŸä¸ªå‡½æ•°ï¼ˆè¿è¡Œæ—¶ç¡®å®šï¼‰ å¸¸é‡çš„èµ‹å€¼åˆ™éœ€è¦åˆ™åªèƒ½æ¥è‡ªç®€å•çš„è¡¨è¾¾å¼ ä½œç”¨åŸŸä¸åŒï¼Œå¸¸é‡çš„ä½œç”¨åŸŸå…¨å±€ å£°æ˜æ–¹å¼ä¸åŒï¼Œå¸¸é‡åœ¨å®šä¹‰æ—¶éœ€è¦æŒ‡å®šç±»å‹ï¼Œæ— æ³•ä½¿ç”¨ç±»å‹æ¨æ–­ æ‰€æœ‰æƒRust çš„æ‰€æœ‰æƒæœºåˆ¶ç›¸å¯¹å…¶å®ƒè¯­è¨€è¿˜æ˜¯æ¯”è¾ƒç‹¬ç‰¹çš„ã€‚å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•å€ŸåŠ©æ‰€æœ‰æƒæ¥ç®¡ç†æ‰€æœ‰åœ¨å †ä¸Šç”³è¯·çš„å†…å­˜ç©ºé—´çš„ã€‚ä¸å…¶å®ƒæ‹¥æœ‰ GC æˆ–è€…éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„è¯­è¨€æ¥è¯´ï¼Œé€šè¿‡æ‰€æœ‰æƒç®¡ç†å†…å­˜è¿˜æ˜¯æŒºç‰¹åˆ«çš„ã€‚ Rust ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶æä¾›å¾ˆå¤šå®‰å…¨æ£€æŸ¥ï¼Œæ¯”å¦‚å­˜åœ¨æ•°æ®å†™å…¥ç«äº‰çš„ç¨‹åºéƒ½æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œè¿™æ ·å°±å¤§å¤§å‡å°‘äº†è¿è¡Œæ—¶æ’æŸ¥é”™è¯¯çš„å¯èƒ½ã€‚ è§„åˆ™ Rust ä¸­æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶æ‰€æœ‰è€… Owner çš„å˜é‡ å€¼æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€… å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼ä¼šè¢«æŠ›å¼ƒï¼ˆå†…å­˜å›æ”¶ï¼‰ æ³¨æ„ç‚¹ Rust ä¸­å˜é‡çš„èµ‹å€¼ï¼Œå’Œä¼ ç»Ÿè¯­è¨€ä¸é€šï¼Œå®ƒåšçš„æ˜¯æ‰€æœ‰æƒè½¬ç§»çš„å·¥ä½œï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„å˜é‡å°±ä¼šè¢«å¤±æ•ˆäº† å¦‚æœä¸€ä¸ªç±»å‹æœ‰ Copy traitï¼Œä¸€ä¸ªæ—§çš„å˜é‡åœ¨å°†å…¶èµ‹å€¼ç»™å…¶å®ƒå˜é‡åä»ç„¶å¯ç”¨ï¼ˆå¦‚åœ¨æ ˆä¸Šåˆ†é…çš„æ•´æ•°ï¼‰ Rust æ°¸è¿œä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®çš„ã€Œæ·±æ‹·è´ã€ï¼Œæ‰€ä»¥ä»»ä½•è‡ªåŠ¨çš„å¤åˆ¶ï¼Œå¯ä»¥è®¤ä¸ºå¯¹è¿è¡Œæ—¶çš„æ€§èƒ½å½±å“è¾ƒå° å¼•ç”¨å’Œå€Ÿç”¨ åœ¨ä»»æ„ç»™å®šçš„æ—¶é—´ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆåªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨ å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆ Slice åˆ‡ç‰‡ æ²¡æœ‰æ‰€æœ‰æƒçš„æ•°æ®ç±»å‹ï¼Œå…è®¸å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸ç”¨å¼•ç”¨æ•´ä¸ªé›†åˆ åˆ‡ç‰‡è¯­æ³•ï¼ˆæ„Ÿè§‰å’Œ Python æˆ–è€… Go ç±»ä¼¼ï¼‰ï¼š start..end å¯¹åº”çš„æ˜¯ [start, end) è¿™æ ·çš„åŒºé—´ è€Œ start..=end åˆ™è¡¨ç¤º [start, end] åŒºé—´ start.. è¡¨ç¤ºä» start å¼€å§‹åˆ°ç»“å°¾ .. åˆ™è¡¨ç¤ºä»å¤´åˆ°å°¾ å­—ç¬¦ä¸²å­—é¢å€¼å°±æ˜¯ Slice &amp;str ç»“æ„ä½“ struct å¯ä»¥ç”¨æ¥è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œç±»ä¼¼é¢å‘å¯¹è±¡è¯­è¨€ä¸­çš„æ•°æ®å±æ€§ ç»“æ„ä½“åˆå§‹åŒ–ï¼Œæ¯ä¸ªå­—æ®µéƒ½éœ€è¦æ˜¾å¼èµ‹å€¼ï¼Œå­—æ®µåˆå§‹åŒ–é¡ºåºå¯ä»¥ä¸ç”¨å…³å¿ƒ mut å’Œ imut æ˜¯é’ˆå¯¹æ•´ä¸ªç»“æ„ä½“è€Œè¨€çš„ï¼Œä¸å…è®¸ç»“æ„ä½“éƒ¨åˆ†å­—æ®µè®¾ç½®ä¸º mut å˜é‡ä¸å­—æ®µåŒåæ—¶ï¼Œå¯ä»¥ç®€åŒ–ç»“æ„ä½“åˆå§‹åŒ–å†™æ³• å…ƒç»„ç»“æ„ä½“ï¼Œç›¸å½“äºç»™å…ƒç»„ç±»å‹å‘½åäº†ï¼Œè¿™æ ·å¯ä»¥æœ‰åˆ«äºå…¶ä»–ç±»å‹å…ƒç»„ï¼Œåªéœ€è¦æŒ‡å®šç±»å‹ï¼Œä¸éœ€è¦å‘½åå­—æ®µ ç±»å•å…ƒç»“æ„ä½“ï¼ˆunit-like structsï¼‰ï¼š æ²¡æœ‰ä»»ä½•å­—æ®µçš„ç»“æ„ä½“ ç±»ä¼¼ () é€‚ç”¨äºåœ¨æŸä¸ªç±»å‹ä¸Šå®ç° traitï¼Œä½†ä¸éœ€è¦å­˜å‚¨æ•°æ® ç”Ÿå‘½å‘¨æœŸä¼šä¿è¯ç»“æ„ä½“å¼•ç”¨çš„æ•°æ®æœ‰æ•ˆæ€§å’Œç»“æ„ä½“ä¿æŒä¸€è‡´ å¾ˆå¤šåŸºæœ¬ç±»å‹éƒ½å®ç°äº† Display traitï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ println!(&quot;{}&quot;) æ—¶å¯ä»¥æ­£å¸¸æ‰“å°ï¼›ä½† rust é»˜è®¤ä¸ä¼šæ‰“å°å‡ºç»“æ„ä½“çš„å±•ç¤ºä¿¡æ¯ï¼Œä½¿ç”¨ {:?} ä¼šä½¿ç”¨ Debug traitï¼Œä»è€Œæ‰“å°å‡ºç»“æ„ä½“çš„è°ƒè¯•ä¿¡æ¯ã€‚ä½¿ç”¨ derive æ³¨è§£ï¼Œå¯ä»¥ä½¿ç”¨ traitã€‚ Rust æœ‰è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨çš„åŠŸèƒ½ï¼Œä¼šè‡ªåŠ¨ä¸º object æ·»åŠ  &amp;, &amp;mut æˆ– *ï¼Œä»è€Œå’Œæ–¹æ³•çš„ç­¾ååŒ¹é… Rust ä¸­çš„å…³è”å‡½æ•°ï¼ˆassociated functionsï¼‰æ˜¯æ”¾åœ¨ impl å—ä¸­ï¼Œ å’Œç»“æ„ä½“æœ¬èº«æœ‰è¾ƒå¤§çš„ç›¸å…³æ€§ï¼Œä½†ä¸æ˜¯æ–¹æ³• ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿä¸æ˜¯ self ä¾ç„¶æ˜¯å‡½æ•° ç±»ä¼¼å…¶å®ƒè¯­è¨€ä¸­çš„ç±»çš„é™æ€æ–¹æ³• æ¯ä¸ªç»“æ„ä½“éƒ½å…è®¸æ‹¥æœ‰å¤šä¸ª impl å— ç»“æ„ä½“å¹¶éåˆ›å»ºè‡ªå®šä¹‰ç±»å‹çš„å”¯ä¸€æ–¹æ³•ï¼ æšä¸¾ä¸æ¨¡å¼åŒ¹é… Rust ä¸­çš„æšä¸¾ç±»ä¼¼äº F#, OCaml å’Œ Haskell è¿™ç§å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„**ä»£æ•°æ•°æ®ç±»å‹ï¼ˆalgebraic data typesï¼‰ æšä¸¾è¿˜å¯ä»¥å­˜å‚¨æ•°æ®ï¼ˆè‡ªå®šä¹‰çš„é‚£ç§ï¼Œç±»ä¼¼çš„æ¦‚å¿µå¯ä»¥ç”¨ç»“æ„ä½“æ¥è¡¨è¾¾ï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼‰ æšä¸¾çš„æ¯ä¸ªæˆå‘˜å¯ä»¥å¤„ç†ä¸åŒç±»å‹å’Œæ•°é‡çš„æ•°æ®ï¼ˆå¯ä»¥å°†ä»»æ„ç±»å‹æ•°æ®æ”¾å…¥æšä¸¾æˆå‘˜ä¸­ï¼‰ Rust æšä¸¾å®åœ¨å¤ªå¼ºå¤§äº†ï¼Œç”šè‡³å¯ä»¥å®ç°æ–¹æ³•ï¼Œè¿œä¸æ˜¯ Python/Go ä¸­é‚£ç§ç®€å•çš„æšä¸¾å¯æ¯”çš„ ä¸€ä¸ªå¸¸ç”¨çš„æ ‡å‡†åº“æšä¸¾ç±»å‹ Optionï¼Œåº”å¯¹çš„åœºæ™¯ï¼šä¸€ä¸ªå€¼è¦ä¹ˆæœ‰å€¼è¦ä¹ˆæ²¡å€¼ï¼ˆWTF?ï¼‰ Rust ä¸­æ²¡æœ‰ç©ºå€¼ï¼ˆNullï¼‰çš„åŠŸèƒ½ï¼šç©ºå€¼å’Œéç©ºå€¼ åªè¦ä¸€ä¸ªå€¼ä¸æ˜¯ Option&lt;T&gt; ç±»å‹ï¼Œå°±å¯ä»¥å®‰å…¨çš„è®¤ä¸ºå®ƒçš„å€¼ä¸ä¸ºç©º match æ˜¯éå¸¸å¼ºå¤§çš„æ§åˆ¶æµè¿ç®—ç¬¦ï¼Œå¯ä»¥å°†ä¸€ä¸ªå€¼å’Œä¸€ç³»åˆ—çš„æ¨¡å¼ç›¸æ¯”è¾ƒï¼Œå¹¶æ ¹æ®ç›¸åŒ¹é…çš„æ¨¡å¼æ‰§è¡Œç›¸åº”çš„ä»£ç  Rust ä¸å…è®¸ match æ²¡æœ‰åŒ¹é…å¤„ç†å„ç§æƒ…å†µï¼ŒRust ä¸­çš„åŒ¹é…æ˜¯ç©·å°½çš„ ï¼ˆï¼‰ æ˜¯ä¸€ä¸ª unit å€¼ if let é€‚åˆåŒ¹é…ä¸€ç§æƒ…å†µçš„æ—¶å€™æ›¿ä»£ matchï¼Œå‡å°‘æ ·æ¿ä»£ç ç¼–å†™ï¼Œmatch çš„è¯­æ³•ç³– æ¨¡å—ä¸ä»£ç å¤ç”¨ æ¨¡å—ï¼ˆmoduleï¼‰æ˜¯ä¸€ä¸ªåŒ…å«å‡½æ•°æˆ–ç±»å‹å®šä¹‰çš„å‘½åç©ºé—´ mod å£°æ˜æ–°æ¨¡å—ï¼Œæ¨¡å—ä¸­çš„ä»£ç è¦ä¹ˆç›´æ¥ä½äºå£°æ˜åçš„å¤§æ‹¬å·ä¸­ï¼Œè¦ä¹ˆä½äºå¦ä¸€ä¸ªæ–‡ä»¶ å‡½æ•°ã€ç±»å‹ã€å¸¸é‡å’Œæ¨¡å—é»˜è®¤éƒ½æ˜¯ç§æœ‰çš„ï¼Œpub å¯ä»¥æ§åˆ¶å…¶åœ¨æ¨¡å—å¤–å¯è§ use å…³é”®å­—å°†æ¨¡å—æˆ–è€…æ¨¡å—ä¸­çš„å®šä¹‰å¼•å…¥åˆ°ä½œç”¨åŸŸä¸­ä»¥ä¾¿äºå¼•ç”¨å®ƒä»¬ Rust ä¸­å¤šä¸ªæ¨¡å—å¯ä»¥ä½äºä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸”æ¨¡å—å¯ä»¥åµŒå¥—ï¼Œä»¥æ„æˆæ›´ç¬¦åˆé€»è¾‘çš„ç»“æ„ Rust é»˜è®¤åªçŸ¥é“ lib.rs å†…å®¹ï¼Œæ‰€ä»¥æ¨¡å—çš„å£°æ˜æˆ–è€…å®šä¹‰éƒ½éœ€è¦æ”¾åœ¨è¯¥æ–‡ä»¶ æ¨¡å—æ–‡ä»¶ç³»ç»Ÿçš„è§„åˆ™ï¼š å¦‚æœ foo æ¨¡å—æ²¡æœ‰å­æ¨¡å—ï¼Œåº”è¯¥å°† foo çš„å£°æ˜æ”¾åœ¨ foo.rs çš„æ–‡ä»¶ä¸­ å¦‚æœ foo æ¨¡å—æœ‰å­æ¨¡å—ï¼Œåº”è¯¥å°† foo çš„å£°æ˜æ”¾åœ¨ foo/mod.rs çš„æ–‡ä»¶ä¸­ Rust ä¸­æ¨¡å—å’Œå‡½æ•°é»˜è®¤å‡ä¸ºç§æœ‰çš„ï¼Œå¿…é¡»è¦åŒæ—¶è®¾ç½®ä¸ºå…¬æœ‰ï¼Œæ‰èƒ½åœ¨å¤–éƒ¨è®¿é—®æ¨¡å—ä¸­çš„å‡½æ•° ç§æœ‰æ€§è§„åˆ™ï¼š å¦‚æœä¸€ä¸ªé¡¹æ˜¯å…¬æœ‰çš„ï¼Œå®ƒèƒ½è¢«ä»»ä½•çˆ¶æ¨¡å—è®¿é—® å¦‚æœä¸€ä¸ªé¡¹æ˜¯ç§æœ‰çš„ï¼Œå®ƒèƒ½è¢«ç›´æ¥çˆ¶çº§æ¨¡å—åŠå…¶ä»»ä½•å­æ¨¡å—è®¿é—® use åªå°†æŒ‡å®šçš„æ¨¡å—å¼•å…¥ä½œç”¨åŸŸï¼Œä½†ä¸ä¼šå°†å…¶å­æ¨¡å—ä¹Ÿå¼•å…¥ é€šç”¨é›†åˆç±»å‹ é›†åˆ æ˜¯ä¸€äº›åˆ—æœ‰ç”¨çš„æ•°æ®ç»“æ„ä½“ï¼Œä¸åŒäºå†…å»ºæ•°ç»„å’Œå…ƒç»„ï¼Œè¿™äº›é›†åˆæŒ‡å‘çš„æ•°æ®æ˜¯å­˜å‚¨åœ¨å †ä¸Šçš„ ä¸‰ç§å¹¿æ³›ä½¿ç”¨çš„é›†åˆï¼š vectorï¼šå˜é•¿ï¼Œè¿ç»­å­˜å‚¨ä¸€ç³»åˆ—å€¼ï¼ˆç±»ä¼¼ Python çš„ listï¼‰ å­—ç¬¦ä¸²ï¼šå­—ç¬¦é›†åˆ å“ˆå¸Œï¼šå°±æ˜¯ map vector åªèƒ½å­˜å‚¨ç›¸åŒç±»å‹çš„å€¼ï¼Œå…¶å­˜å‚¨çš„å€¼åœ¨å†…å­˜ä¸­å½¼æ­¤ç›¸é‚»æ’åˆ— vector çš„ç»“å°¾åœ¨æ–°å¢å…ƒç´ æ—¶ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿç©ºé—´å°†æ‰€æœ‰å…ƒç´ ä¾æ¬¡ç›¸é‚»å­˜æ”¾çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šè¦æ±‚åˆ†é…å†…å­˜ï¼Œå¹¶å°†è€çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„ç©ºé—´ã€‚æ‰€ä»¥ Rust æ˜¯ä¸å…è®¸åœ¨å¼•ç”¨çš„æŸä¸ªå…ƒç´ æ—¶ï¼Œä¸å¯ä»¥è¿›è¡Œä¿®æ”¹ å¯ä»¥å€ŸåŠ© enum å®ç°åœ¨ vector ä¸­å­˜å‚¨å¤šç§ç±»å‹å…ƒç´ ç›®æ ‡ Rust çš„æ ¸å¿ƒè¯­è¨€ä¸­åªæœ‰ä¸€ç§å­—ç¬¦ä¸²ç±»å‹ï¼šstrï¼Œå³å­—ç¬¦ä¸² sliceï¼Œä»¥å€Ÿç”¨çš„å½¢å¼å‡ºç° &amp;strï¼ŒUTF-8 ç¼–ç  String ç±»å‹æ˜¯ç”±æ ‡å‡†åº“æä¾›çš„ï¼Œå¯å˜é•¿ã€æœ‰æ‰€æœ‰æƒã€UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ç±»å‹ Rust æ ‡å‡†åº“è¿˜æä¾›äº†å…¶ä»–å­—ç¬¦ä¸²ç±»å‹ï¼šOsString, OsStr, CString, CStrï¼Œå®ƒä»¬å’Œ String æˆ–è€… str æ‹¥æœ‰ä¸åŒçš„ç¼–ç æˆ–å†…å­˜è¡¨ç°å½¢å¼ï¼Œå„è‡ªæ‹¥æœ‰ä¸€äº›ä½¿ç”¨åœºæ™¯ String æ”¯æŒ + è¿ç®—ç¬¦ã€format! æ‹¼æ¥å­—ç¬¦ä¸² format! å’Œ print! å®ç±»ä¼¼ï¼Œå¹¶ä¸”ä¸ä¼šè·å–å‚æ•°çš„æ‰€æœ‰æƒ Rust ä¸­ï¼ŒString æˆ–è€… str ç±»å‹æ˜¯ä¸æ”¯æŒç´¢å¼•è·å–çš„ï¼š String åœ¨åº•å±‚ä½¿ç”¨ Vec&lt;u8&gt; å­˜å‚¨å­—ç¬¦å­—èŠ‚ï¼Œç”±äºä¸åŒçš„è¯­è¨€ä½¿ç”¨ UTF-8 ç¼–ç æ—¶ï¼Œéœ€è¦çš„å­—èŠ‚æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸ºäº†é¿å…è¿”å›æ— æ•ˆçš„ï¼ˆæ— æ„ä¹‰ï¼‰å­—èŠ‚å€¼ï¼ŒRust é€‰æ‹©ä¸ç¼–è¯‘è¿™ç§ç´¢å¼•è®¿é—®çš„æƒ…å†µ ç”±äºç´¢å¼•æ“ä½œé¢„æœŸæ˜¯å¸¸æ•°æ—¶é—´ O(1)ï¼Œä½† String ä¸­å®ç°ç´¢å¼•ä¸èƒ½ä¿è¯è¿™æ ·çš„æ€§èƒ½ ä½¿ç”¨å­—ç¬¦ä¸² Slice æ—¶éœ€è¦è°¨æ…ï¼Œé˜²æ­¢ &amp;s[n..m] æ“ä½œå–å‡ºæ¥çš„æ˜¯éæ³•çš„å­—ç¬¦ï¼ˆç¼–è¯‘æ—¶ä¼šè®©é€šè¿‡ï¼‰ï¼Œå½“ç„¶ Rust ä¼šåœ¨è¿è¡Œæ—¶ç›´æ¥ panic å¯ä»¥å¯¹ &amp;String.chars() éå†è·å¾—æ¯ä¸ªå­—ç¬¦ï¼Œå¯¹ &amp;String.bytes() éå†è·å¾—æ¯ä¸ªå­—èŠ‚ HashMap&lt;k, v&gt; ç±»ä¼¼å…¶å®ƒè¯­è¨€ä¸­çš„å­—å…¸ï¼ˆmapï¼‰ã€‚å…¶å¹¶ä¸åœ¨ preclude ä¸­ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦ use å¯¼å…¥åˆ°ä½œç”¨åŸŸ é”™è¯¯å¤„ç† Rust ä¸­å°†é”™è¯¯åˆ†ä¸ºä¸¤å¤§ç±»ï¼šå¯æ¢å¤é”™è¯¯ï¼ˆrecoverableï¼‰ å’Œ ä¸å¯æ¢å¤é”™è¯¯ï¼ˆunrecoverableï¼‰ã€‚å¯æ¢å¤çš„é”™è¯¯é€šå¸¸ä»£è¡¨å‘ç”¨æˆ·æŠ¥å‘Šé”™è¯¯å’Œé‡è¯•æ“ä½œæ˜¯å¦åˆç†çš„æƒ…å†µï¼Œå¦‚æ–‡ä»¶ä¸å­˜åœ¨ã€‚è€Œä¸å¯æ¢å¤çš„é”™è¯¯åˆ™é€šå¸¸æ˜¯å¾ˆä¸¥é‡çš„ bug å¯æ¢å¤çš„é”™è¯¯æ˜¯ Result&lt;T, E&gt;ï¼Œè€Œ panic! ä¼šåœ¨é‡åˆ°ä¸å¯æ¢å¤çš„é”™è¯¯æ—¶ç»ˆæ­¢æ‰§è¡Œã€‚æ³¨æ„è¿™ä¸ªå’Œå…¶å®ƒè¯­è¨€ä¸­çš„å¼‚å¸¸æœºåˆ¶è¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ panic æ—¶ï¼Œé»˜è®¤ä¼šå¼€å§‹å±•å¼€ï¼ˆunwindingï¼‰ï¼Œä»è€Œå›æº¯æ ˆå¹¶æ¸…ç†é‡åˆ°çš„æ¯ä¸ªå‡½æ•°çš„æ•°æ®ï¼Œä½†è¿™ä¸ªå›æº¯å¹¶æ¸…ç†çš„è¿‡ç¨‹æœ‰å¾ˆå¤šå·¥ä½œã€‚ä½ å¯ä»¥é€‰æ‹©ç›´æ¥ç»ˆæ­¢ï¼ˆabortï¼‰ï¼Œè®©æ“ä½œç³»ç»Ÿæ¥æ¸…ç†å†…å­˜ã€‚ å¦‚æœå¸Œæœ›äºŒè¿›åˆ¶æ–‡ä»¶è¶Šå°è¶Šå¥½ï¼Œå¯ä»¥åœ¨ Cargo.toml ä¸­æ·»åŠ ä¸‹é¢çš„é…ç½®ï¼Œè¿™æ ·åœ¨ panic æ—¶ç›´æ¥ç»ˆæ­¢æ‰§è¡Œï¼š 12[profile.release]panic = 'abort' æˆ‘ä»¬ä½¿ç”¨ Result ç±»å‹æ¥ä½œä¸ºè¿”å›ï¼Œç”¨äºåº”ä»˜ä¸€äº›å¸¸è§„é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š 1234enum Result&lt;T, E&gt; &#123; Ok(T), Err(E),&#125; å¯ä»¥ä½¿ç”¨é—­åŒ…ï¼ˆclosureï¼‰æ¥å‡å°‘å› é”™è¯¯å¤„ç†è€ŒåµŒå¥—å¤šå±‚ match çš„é—®é¢˜ å½“ç„¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ unwrap å’Œ expect å¤„ç†é”™è¯¯ é”™è¯¯ä¼ é€’åœ¨ Rust ä¸­å¾ˆå¸¸è§ï¼Œæ‰€ä»¥æœ‰ä¸ª ? æ“ä½œç¬¦è¯­æ³•ç³–å¯ä»¥æ›¿ä»£ç¹ççš„ match å†™æ³•ã€‚æ­¤å¤–ï¼Œ? è¿˜å°†é”™è¯¯å€¼ä¼ é€’ç»™ from å‡½æ•°ï¼ˆå®šä¹‰äº From trait` ä¸­ï¼‰ï¼Œç”¨äºå°†ä¸€ç§é”™è¯¯ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ ? æ“ä½œç¬¦åªèƒ½è¢«ç”¨äºè¿”å› Result ç±»å‹çš„å‡½æ•°ä¸­ å…³äºæ•°æ®æ ¡éªŒï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°çš„ç±»å‹ï¼ŒæŠŠæ ¡éªŒé€»è¾‘æ”¶æ•›åˆ° new æ–¹æ³•ï¼Œè¿™æ ·æ‰€æœ‰å‡½æ•°å‡ä½¿ç”¨è¯¥ç±»å‹ï¼Œä»è€Œè®©å„ä¸ªä¾èµ–è¯¥å‚æ•°çš„å‡½æ•°ä¸ç”¨ç¼–å†™ç¹ççš„æ ¡éªŒé€»è¾‘ è¦ä¸è¦ panic!è¿™é‡Œç»™å‡ºä¸€äº›æŒ‡å¯¼æ€§åŸåˆ™ï¼Œæ¥å¸®åŠ©ä½ åœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œå¦‚ä½•æ›´å¥½çš„å¤„ç†é”™è¯¯ï¼Œå†³å®šæ˜¯å¦éœ€è¦ panic! è¿˜æ˜¯ä¼ é€’é”™è¯¯åˆ°ä¸Šå±‚ã€‚ åœ¨ç¼–å†™ç¤ºä¾‹ã€åŸå‹ä»£ç æˆ–è€…æµ‹è¯•æ—¶ï¼Œå»ºè®®ç”¨ unwrap æˆ–è€… expectï¼Œç®€å•å¤„ç†é”™è¯¯çš„æƒ…å†µï¼ˆç›´æ¥ panic! æ‰ï¼‰ï¼ŒæŠŠç„¦ç‚¹æ”¾åœ¨æ ¸å¿ƒåŠŸèƒ½å®ç°ä¸Šï¼Œç„¶åå†å¤„ç†å…·ä½“çš„é”™è¯¯ é‡åˆ°éå¸¸è§„å¯é¢„æœŸçš„é”™è¯¯çŠ¶æ€æ—¶ï¼Œå»ºè®® panic! æ‰ æ³›å‹ã€Trait å’Œç”Ÿå‘½å‘¨æœŸ å¾ˆå¤šè¯­è¨€éƒ½æœ‰å¤„ç†é‡å¤æ¦‚å¿µçš„å·¥å…·ï¼ŒRust ä¸­çš„å·¥å…·ä¹‹ä¸€å°±æ˜¯æ³›å‹ï¼ˆgenericsï¼‰ æ³›å‹å¯ä»¥è®¤ä¸ºæ˜¯å…·ä½“ç±»å‹çš„é«˜å±‚æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºæ³›å‹å»å®ç°ä¸€äº›é€šç”¨çš„å…³è”æ–¹æ³•ï¼Œè€Œä¸éœ€è¦çŸ¥é“ concrete typeã€‚æƒ³æƒ³ Go æ²¡æœ‰æ³›å‹ï¼Œå°±çŸ¥é“å¤šæƒ¨äº† trait å¯ä»¥ä¸æ³›å‹ç»“åˆï¼Œå°†æ³›å‹é™åˆ¶ä¸ºæ‹¥æœ‰ç‰¹å®šè¡Œä¸ºçš„ç±»å‹ï¼Œè€Œä¸æ˜¯ä»»æ„ç±»å‹ ä»»ä½•å­—ç¬¦éƒ½å¯ä»¥ä½œä¸ºç±»å‹å‚æ•°åï¼Œä¹‹æ‰€ä»¥ç”¨ T æ˜¯ Rust çš„ä¹ æƒ¯ç”¨æ³•ï¼ŒT ä½œä¸º type çš„ç¼©å†™ä¹Ÿå¾ˆåˆé€‚ ä½¿ç”¨ &lt;&gt; æ¥å®šä¹‰æ³›å‹ Rust ä¸­ä½¿ç”¨æ³›å‹å®ç°çš„ä»£ç å’Œä½¿ç”¨å…·ä½“ç±»å‹å®ç°çš„ä»£ç ï¼Œåœ¨æ€§èƒ½ä¸Šä¸ä¼šæœ‰ä»»ä½•æŸå¤±ã€‚Rust é€šè¿‡åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ³›å‹ä»£ç å•æ€åŒ–ï¼ˆmonomorphizationï¼‰æ¥ä¿è¯æ•ˆç‡ã€‚å•æ€åŒ–æ˜¯æŒ‡é€šè¿‡å¡«å……ç¼–è¯‘æ—¶ä½¿ç”¨çš„å…·ä½“ç±»å‹ï¼Œå°†é€šç”¨ä»£ç è½¬ä¸ºç‰¹å®šä»£ç çš„è¿‡ç¨‹ trait ä»¥ä¸€ç§æŠ½è±¡çš„æ–¹å¼å®šä¹‰å…±äº«è¡Œä¸ºï¼Œå¯ä»¥ä½¿ç”¨ trait bounds æŒ‡å®šæ³›å‹æ˜¯ä»»ä½•æ‹¥æœ‰ç‰¹å®šè¡Œä¸ºçš„ç±»å‹ trait å®šä¹‰æ˜¯ä¸€ç§å°†æ–¹æ³•ç­¾åç»„åˆèµ·æ¥çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯å®šä¹‰ä¸€ä¸ªå®ç°æŸäº›ç›®çš„æ‰€å¿…é¡»çš„è¡Œä¸ºé›†åˆ æ³¨æ„ï¼šåªæœ‰å½“ trait æˆ–è€…è¦å®ç° trait çš„ç±»å‹ä½äº crate çš„æœ¬åœ°ä½œç”¨åŸŸæ—¶ï¼Œæ‰èƒ½ä¸ºè¯¥ç±»å‹å®ç° trait trait ä¸­å®šä¹‰çš„æ–¹æ³•æ˜¯å¯ä»¥æœ‰é»˜è®¤å®ç°çš„ï¼Œå…·ä½“ç±»å‹åœ¨å®ç° trait æ—¶å¯ä»¥é€‰æ‹©é‡è½½æ–¹æ³•ï¼Œä½†ä¸æ”¯æŒè°ƒç”¨é»˜è®¤æ–¹æ³•ï¼ˆOopsï¼‰ trait å¯ä»¥ä½œä¸ºå‚èµ›ï¼ˆç±»ä¼¼ Go é‡Œé¢çš„å‡½æ•°æ¥æ”¶ä¸€ä¸ª interfaceï¼‰ æ³¨æ„ä¸‹é¢ä¸¤ç§æ˜¯ä¸åŒçš„ï¼š 123456// è¿™é‡Œå…è®¸ item1 å’Œ item2 æ˜¯ä¸åŒçš„ç±»å‹ï¼Œåªè¦éƒ½å®ç°äº† `SomeTrait`pub fn notify(item1: impl SomeTrait, item2: impl SomeTrait);// è¿™é‡Œå°±ä¼šè¦æ±‚ item1 å’Œ item2 æ˜¯ä¸åŒçš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ trait bound è¿™ç§å†™æ³•// æ‰å¯ä»¥åšåˆ°è¿™æ ·çš„é™åˆ¶pub fn notify&lt;T: SomeTrait&gt;(item1: T, item2: T); ä¸ Go çš„å‡½æ•°å¯ä»¥è¿”å› interface ç±»ä¼¼ï¼ŒRust æ”¯æŒè¿”å› traitï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œåªèƒ½è¿”å›ä¸€ç§å®ç°äº†è¯¥ trait çš„ç±»å‹ã€‚ä¸è¿‡ä¾ç„¶ä¼šæœ‰æ›´é«˜çº§çš„æ–¹æ³•åšåˆ°ï¼Œè¯·ç»§ç»­å¾€åå­¦ä¹ ï¼ ä»»ä½•æ»¡è¶³ç‰¹å®š trait bound çš„ç±»å‹å®ç° trait è¢«ç§°ä¸º blanket implementationsï¼Œå¹¿æ³›åº”ç”¨äº Rust æ ‡å‡†ä¸­ã€‚å¦‚æ ‡å‡†åº“ä¸ºä»»ä½•å®ç°äº† Display trait çš„ç±»å‹å®ç°äº† ToString æ–¹æ³• ç”Ÿå‘½å‘¨æœŸå’Œå¼•ç”¨æœ‰æ•ˆæ€§ ç”Ÿå‘½å‘¨æœŸçš„ä¸»è¦ç›®æ ‡æ˜¯é¿å…æ‚¬å‚å¼•ç”¨ Rust ç¼–è¯‘å™¨ä¸­çš„å€Ÿç”¨æ£€æŸ¥å™¨ï¼ˆborrow checkerï¼‰æ˜¯ç”¨æ¥æ¯”è¾ƒä½œç”¨åŸŸï¼Œä»è€Œç¡®ä¿æ‰€æœ‰çš„å€Ÿç”¨éƒ½æ˜¯æœ‰æ•ˆçš„ ç”Ÿå‘½å‘¨æœŸæ³¨é‡Šï¼š 12345678910&#123; let r; // ---------+-- 'a // | &#123; // | let x = 5; // -+-- 'b | r = &amp;x; // | | &#125; // -+ | // | println!("r: &#123;&#125;", r); // |&#125; // ---------+ ç”Ÿå‘½å‘¨æœŸçš„æ³¨è§£å¹¶ä¸ä¼šæ”¹å˜ä»»ä½•å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­ã€‚å½“å‡½æ•°æŒ‡å®šäº†æ³›å‹ç”Ÿå‘½å‘¨æœŸåï¼Œå¯ä»¥æ¥å—ä»»ä½•ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ã€‚ç”Ÿå‘½å‘¨æœŸæ³¨è§£æè¿°äº†å¤šä¸ªå¼•ç”¨ç”Ÿå‘½å‘¨æœŸçš„ç›¸äº’å…³ç³»ï¼Œè€Œä¸å½±å“å…¶ç”Ÿå‘½å‘¨æœŸã€‚ç”Ÿå‘½å‘¨æœŸæ³¨è§£åœ¨å€Ÿç”¨æ£€æŸ¥å™¨çš„å¸®åŠ©ä¸‹ï¼Œä¼šæŒ‡å‡ºä¸éµå®ˆåè®®çš„å…¥å‚ã€‚ æ³›å‹ç”Ÿå‘½å‘¨æœŸ &#39;a çš„å…·ä½“ç”Ÿå‘½å‘¨æœŸç­‰åŒäºå¤šä¸ªå‡½æ•°å‚æ•°ä¸­ç”Ÿå‘½å‘¨æœŸè¾ƒå°çš„é‚£ä¸ª ç”Ÿå‘½å‘¨æœŸè¯­æ³•æ˜¯ç”¨äºå°†å‡½æ•°çš„å¤šä¸ªå‚æ•°ä¸å…¶è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œå…³è”çš„ï¼Œä¸€æ—¦å®ƒä»¬å½¢æˆäº†æŸç§å…³è”ï¼ŒRust å°±æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥å…è®¸å†…å­˜å®‰å…¨çš„æ“ä½œå¹¶é˜»æ­¢äº§ç”Ÿæ‚¬å‚æŒ‡é’ˆæˆ–è¿åå†…å­˜å®‰å…¨çš„è¡Œä¸º Rust å­˜åœ¨ç”Ÿå‘½å‘¨æœŸçœç•¥è§„åˆ™ï¼ˆlifetime elision rulesï¼‰ï¼Œè¿™äº›è§„åˆ™æ˜¯ä¸€ç³»åˆ—ç‰¹å®šåœºæ™¯ï¼Œå¦‚æœç¬¦åˆè§„åˆ™ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šç”Ÿå‘½å‘¨æœŸ ç”Ÿå‘½å‘¨æœŸçœç•¥è§„åˆ™ï¼š å‡½æ•°æˆ–æ–¹æ³•çš„å‚æ•°ç”Ÿå‘½å‘¨æœŸå«åšè¾“å…¥ç”Ÿå‘½å‘¨æœŸ è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸå«åšè¾“å‡ºç”Ÿå‘½å‘¨æœŸ è§„åˆ™é€‚ç”¨äº fn å’Œ impl å— è§„åˆ™ä¸€ï¼šæ¯ä¸€ä¸ªæ˜¯å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸéƒ½æœ‰å…¶è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼ˆå„ä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°æ˜¯ä¸åŒçš„ï¼‰ è§„åˆ™äºŒï¼šå¦‚æœåªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œåˆ™å®ƒä¼šè¢«èµ‹äºˆæ‰€æœ‰è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•° è§„åˆ™ä¸‰ï¼šå¦‚æœæ–¹æ³•æœ‰å¤šä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼ˆ&amp;self å’Œ &amp;mut selfï¼‰ï¼Œåˆ™ &amp;self çš„ç”Ÿå‘½å‘¨æœŸè¢«èµ‹äºˆç»™æ‰€æœ‰è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•° é™æ€ç”Ÿå‘½å‘¨æœŸï¼š &#39;staticï¼Œç”Ÿå‘½å‘¨æœŸå­˜æ´»äºæ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ æ‰€æœ‰å­—ç¬¦ä¸²å­—é¢å€¼éƒ½æœ‰ &#39;static ç”Ÿå‘½å‘¨æœŸ å¦‚æœç¼–è¯‘å™¨æç¤ºåŠ  &#39;static ç”Ÿå‘½å‘¨æœŸå»ºè®®æ—¶ï¼Œåº”è¯¥çœ‹çœ‹æ˜¯ä¸æ˜¯è‡ªå·±çš„å®ç°æ–¹å¼æœ‰é—®é¢˜ï¼Œè€Œä¸æ˜¯ç›²ç›®æ·»åŠ  &#39;static ç”Ÿå‘½å‘¨æœŸ å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯• Edsger W. Dijkstra: Program testing can be a very effective way to show the presence of bugs, but it is hopelessly inadequate for showing their absence. Rust ä¸­çš„æµ‹è¯•å‡½æ•°æ˜¯ç”¨äºéªŒè¯éæµ‹è¯•ä»£ç æ˜¯å¦æŒ‰ç…§é¢„æœŸæ–¹å¼è¿è¡Œçš„ã€‚æµ‹è¯•å‡½æ•°ä½“é€šå¸¸è¦æ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹ï¼š è®¾ç½®ä»»ä½•æ‰€éœ€çš„æ•°æ®æˆ–çŠ¶æ€ è¿è¡Œéœ€è¦æµ‹è¯•çš„ä»£ç  æ–­è¨€å…¶ç»“æœæ˜¯å¦ä¸ºæœŸæœ›çš„ Rust ä¸­çš„æµ‹è¯•æ˜¯ä¸€ä¸ªå¸¦æœ‰ test å±æ€§æ³¨è§£çš„å‡½æ•°ã€‚å±æ€§æ˜¯ Rust ä»£ç ç‰‡æ®µçš„å…ƒæ•°æ®ï¼Œä¸ºäº†å°†ä¸€ä¸ªå‡½æ•°å˜æˆæµ‹è¯•å‡½æ•°ï¼Œéœ€è¦åœ¨ fn ä¹‹å‰åŠ ä¸Š #[test]ã€‚cargo test å‘½ä»¤æ‰§è¡Œæ—¶ï¼ŒRust ä¼šæ„å»ºä¸€ä¸ªæµ‹è¯•æ‰§è¡Œç¨‹åºè°ƒç”¨æ ‡è®°äº† test å±æ€§çš„å‡½æ•°ï¼Œå¹¶æŠ¥å‘Šæµ‹è¯•é€šè¿‡ä¸å¦ Rust ä¼šç¼–è¯‘åœ¨ API æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è¿›è¡Œæ–‡æ¡£æµ‹è¯• Doc-testsï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç¨³å®šå’Œä»£ç åŒæ­¥ æ¯ä¸ªæµ‹è¯•éƒ½åœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­è¿è¡Œï¼Œå½“ä¸»çº¿ç¨‹å‘ç°æµ‹è¯•å¼‚å¸¸ï¼Œå°±å°†å¯¹åº”æµ‹è¯•æ ‡è®°ä¸ºå¤±è´¥ æµ‹è¯•ç›¸å…³çš„å®ï¼Œå¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¼šæ‰“å°å‡ºè¯¦ç»†çš„æ–­è¨€å¤±è´¥åŸå› ï¼Œä¾¿äºæ’æŸ¥ï¼š assert!: æ˜¯å¦ä¸º True assert_ne!: æ˜¯å¦ä¸ç­‰äº assert_eq!: æ˜¯å¦ç­‰äº éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œassert_ne! å’Œ assert_eq! åœ¨åº•å±‚ä½¿ç”¨äº† == å’Œ !=ï¼Œæ„å‘³ç€è¢«æ¯”è¾ƒçš„å€¼å¿…é¡»å®ç° PartialEq å’Œ Debug traitã€‚æ‰€æœ‰çš„åŸºæœ¬ç±»å‹å’Œå¤§éƒ¨åˆ†çš„æ ‡å‡†ç±»å‹éƒ½å®ç°äº†è¿™äº› traitï¼Œå¯¹äºè‡ªå®šä¹‰çš„ç»“æ„ä½“å’Œæšä¸¾ç±»å‹ï¼Œé€šå¸¸å¯ä»¥åœ¨ç»“æ„ä½“ä¸ŠåŠ  #[derive(PartialEq, Debug)] æ³¨è§£è§£å†³ å¯¹äºä¸Šè¿°ä¸‰ä¸ªæ–­è¨€ç”¨çš„å®ï¼Œä»»ä½•å…¶å®ƒå‚æ•°éƒ½ä¼šè¢«ä¼ å…¥ format å®ï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©è¿™ä¸ªç‰¹æ€§è‡ªå®šä¹‰é”™è¯¯æç¤º ä½¿ç”¨ #[should_panic] å±æ€§æ¥æµ‹è¯•æŸäº›é¢„æœŸä¼š panic çš„åœºæ™¯ï¼›å¯¹äºå¸Œæœ›æ£€æŸ¥ panic çš„æ–‡æœ¬ä¸­æ˜¯å¦å«æœ‰æŒ‡å®šæ–‡æœ¬çš„æƒ…å†µï¼Œå¯ä»¥åŠ ä¸ª expected å‚æ•°ï¼š 123456789mod tests &#123; use super::*; #[test] #[should_panic(expected = "message to be contained")] fn should_panic_with_msg() &#123; foo_will_panic(); &#125;&#125; æµ‹è¯•å‡½æ•°å¯ä»¥è¿”å› Result&lt;T, E&gt;ï¼Œå’Œæ–­è¨€å¤±è´¥ç›´æ¥ panic ä¸åŒï¼Œè¿™é‡Œæ˜¯é€šè¿‡ Result&lt;T, E&gt; ç»“æœæ¥åˆ¤æ–­æµ‹è¯•ç»“æœã€‚æ­¤å¤–ä¹Ÿä¸èƒ½åœ¨è¿™æ ·çš„æµ‹è¯•å‡½æ•°ä¸ŠåŠ  #[should_panic] å±æ€§ï¼Œå¦åˆ™æç¤ºï¼š 1error: functions using `#[should_panic]` must return `()` cargo test é»˜è®¤è¡Œä¸ºæ˜¯é‡‡ç”¨å¹¶è¡Œè¿è¡Œæµ‹è¯•çš„æ–¹å¼ï¼Œå¹¶ä¸”ä¼šæˆªè·æµ‹è¯•è¿è¡Œä¸­çš„è¾“å‡ºï¼Œé˜»æ­¢æ˜¾ç¤ºï¼Œä»è€Œæ–¹ä¾¿é˜…è¯»æµ‹è¯•ç»“æœ æµ‹è¯•å¸¸ç”¨çš„æ§åˆ¶å‚æ•°ï¼š æŒ‡å®šå¹¶è¡Œæ‰§è¡Œæµ‹è¯•çš„çº¿ç¨‹æ•°ï¼šcargo test -- --test-threads=1 æµ‹è¯•æ—¶æ˜¾ç¤ºå‡½æ•°æ‰“å°çš„ä¿¡æ¯ï¼šcargo test -- --nocaptureï¼Œç”±äºæµ‹è¯•æ—¶å¹¶è¡Œçš„ï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹è¾“å‡ºï¼Œæ‰€ä»¥ä½ å¯èƒ½éœ€è¦æŒ‡å®šä½¿ç”¨å•çº¿ç¨‹è¿è¡Œæµ‹è¯• è¿è¡ŒæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªæµ‹è¯•ï¼ˆç›´æ¥æŒ‡å®šæµ‹è¯•å‡½æ•°å…¨åæˆ–éƒ¨åˆ†å­—ç¬¦ä¸²ç”¨äºåŒ¹é…ï¼‰ï¼šcargo test name ä½¿ç”¨ #[ignore] å±æ€§è¿‡æ»¤ä¸å¸Œæœ›è¿è¡Œçš„æµ‹è¯• åªè¿è¡Œè¢«å¿½ç•¥çš„æµ‹è¯•ï¼šcargo test -- --ignored å…³äº cargo test å‚æ•°éœ€è¦æ³¨æ„çš„ç‚¹ï¼š å®Œæ•´ä½¿ç”¨æ–¹å¼ cargo test [OPTIONS] [TESTNAME] [-- &lt;args&gt;...] -- å‰çš„å‚æ•°ä¼ é€’ç»™ cargo -- åçš„å‚æ•°ä¼ é€’ç»™äºŒè¿›åˆ¶æµ‹è¯•ç¨‹åºï¼ˆtest binariesï¼‰ï¼Œè¿›è€Œä¼ é€’ç»™ libtestï¼ˆè¿™ä¸ªæ˜¯ Rust å†…å»ºçš„å•å…ƒæµ‹è¯•å’Œ micro-benchmark æ¡†æ¶ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ cargo -- --help äº†è§£è¯¦ç»†å‚æ•° å•å…ƒæµ‹è¯•ï¼ˆunit testsï¼‰ ä¾§é‡äºå°è€Œé›†ä¸­ï¼Œåœ¨éš”ç¦»ç¯å¢ƒä¸­ä¸€æ¬¡æµ‹è¯•ä¸€ä¸ªæ¨¡å—ï¼Œæˆ–è€…ç§æœ‰æ¥å£ï¼š å•å…ƒæµ‹è¯•ä¸è¦æµ‹è¯•çš„ä»£ç åŒåœ¨ src ç›®å½•ä¸‹ç›¸åŒçš„æ–‡ä»¶ä¸­ è§„èŒƒæ˜¯åœ¨æ¯ä¸ªæ–‡ä»¶ä¸­åˆ›å»ºåŒ…å«æµ‹è¯•å‡½æ•°çš„ tests æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ cfg(test) æ³¨è§£ é›†æˆæµ‹è¯•ï¼ˆintegrated testsï¼‰ åˆ™æ˜¯åœ¨å¤–éƒ¨æµ‹è¯•ä½ çš„åº“ï¼Œåªæµ‹è¯•å…¬æœ‰æ¥å£ï¼Œä¸”æ¯ä¸ªæµ‹è¯•å¯èƒ½ä¼šæµ‹è¯•å¤šä¸ªæ¨¡å—ï¼š ä½¿ç”¨å•ç‹¬çš„ tests ç›®å½•å’Œ src åŒçº§åˆ« cargo ä¼šå°†æ¯ä¸ªæ–‡ä»¶å½“åšå•ç‹¬çš„ crate ç¼–è¯‘ tests ç›®å½•å¾ˆç‰¹æ®Šï¼Œé‡Œé¢çš„æµ‹è¯•ä¸éœ€è¦ #[cfg(test)] æ³¨è§£ï¼Œå¹¶ä¸”åªä¼šåœ¨ cargo test æ—¶ç¼–è¯‘å¹¶æ‰§è¡Œ tests ç›®å½•ä¸­çš„æ–‡ä»¶ cargo test --test &lt;filename&gt; è¿è¡ŒæŸä¸ªç‰¹å®šçš„é›†æˆæµ‹è¯•æ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯• cargo test --test &lt;filename&gt; &lt;TESTNAME&gt; è¿è¡ŒæŸä¸ªé›†æˆæµ‹è¯•æ–‡ä»¶ä¸­æŸä¸ª case tests ç›®å½•ä¸­çš„å­ç›®å½•ä¸ä¼šè¢«å½“ä½œå•ç‹¬çš„ crate ç¼–è¯‘æˆ–ä½œä¸ºä¸€ä¸ªæµ‹è¯•ç»“æœéƒ¨åˆ†å‡ºç°åœ¨æµ‹è¯•è¾“å‡ºä¸­ï¼Œæ‰€ä»¥å¯ä»¥å°†ä¸€äº›å…¬ç”¨çš„å¸®åŠ©å‡½æ•°æ”¾åˆ°å­ç›®å½•ä¸­å®ç°ï¼ˆæ–°å¢ä¸€ä¸ªæ¨¡å—ï¼‰ å‘½ä»¤è¡Œå°å·¥å…·ï¼šrgrep std::env::args åœ¨å…¶ä»»ä½•å‚æ•°åŒ…æ‹¬æ— æ•ˆ Unicode æ—¶ä¼šæŠ¥é”™ã€‚å¦‚æœéœ€è¦å¤„ç†è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ std::env::args_osï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª OsStringï¼Œè€Œé Stringï¼Œä½†ç»†èŠ‚å¤„ç†èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦ äºŒè¿›åˆ¶ç¨‹åºå…³æ³¨ç‚¹åˆ†ç¦»åŸºæœ¬æ­¥éª¤ï¼š å°†ç¨‹åºæ‹†åˆ†æˆ main.rs å’Œ lib.rsï¼Œå¹¶å°†ç¨‹åºçš„é€»è¾‘æ”¾å…¥ lib.rs ä¸­ å½“å‘½ä»¤è¡Œè§£æé€»è¾‘æ¯”è¾ƒå°æ—¶ï¼Œå¯ä»¥ä¿ç•™åœ¨ main.rs ä¸­ å½“å‘½ä»¤è¡Œè§£æå¼€å§‹å˜å¾—å¤æ‚æ—¶ï¼Œä¹ŸåŒæ ·å°†å…¶ä» main.rs æå–åˆ° lib.rs ä¸­ ç»è¿‡è¿™äº›åï¼Œä¿ç•™åœ¨ main å‡½æ•°çš„è´£ä»»åº”è¯¥è¢«é™åˆ¶ä¸ºï¼š ä½¿ç”¨å‚æ•°å€¼è°ƒç”¨å‘½ä»¤è¡Œè§£æé€»è¾‘ è®¾ç½®ä»»ä½•å…¶å®ƒçš„é…ç½® è°ƒç”¨ lib.rs ä¸­ run å‡½æ•° å¦‚æœ run è¿”å›é”™è¯¯ï¼Œåˆ™å¤„ç†è¿™ä¸ªé”™è¯¯ é”™è¯¯è¾“å‡ºåˆ° stderrï¼Œä½¿ç”¨ eprint! å’Œ eprintln! è¿­ä»£å™¨å’Œé—­åŒ… Rust çš„ é—­åŒ…ï¼ˆclosuresï¼‰ æ˜¯å¯ä»¥ä¿å­˜è¿›å˜é‡æˆ–ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶å®ƒå‡½æ•°çš„åŒ¿åå‡½æ•°ã€‚å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹åˆ›å»ºé—­åŒ…ï¼Œç„¶ååœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé—­åŒ…è¿ç®—ï¼Œé—­åŒ…è¿è¡Œæ•è·è°ƒç”¨è€…ä½œç”¨åŸŸçš„å€¼ é—­åŒ…ä¸è¦æ±‚åƒ fn å‡½æ•°é‚£æ ·åœ¨å‚æ•°å’Œè¿”å›å€¼ä¸Šæ³¨æ˜ç±»å‹ï¼Œå› ä¸ºå®ƒä¸ä¼šè¢«æš´éœ²ç»™åº“çš„ç”¨æˆ·è°ƒç”¨ é—­åŒ…é€šå¸¸å¾ˆçŸ­ï¼Œå¹¶ä¸”åªç”¨äºæœ‰é™çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸”ç¼–è¯‘å™¨èƒ½å¯é åœ°æ¨æ–­å‚æ•°å’Œè¿”å›å€¼ç±»å‹ æ¯ä¸ªé—­åŒ…å®ä¾‹æ‹¥æœ‰è‡ªå·±ç‹¬æœ‰çš„åŒ¿åç±»å‹ï¼Œå³ä¾¿ç­¾åç›¸åŒï¼Œå®ƒä»¬çš„ç±»å‹ä¾ç„¶å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ æ‰€æœ‰çš„é—­åŒ…å’Œå‡½æ•°éƒ½å®ç°äº† trait Fn, FnMut æˆ– FnOnce ä¸­çš„ä¸€ä¸ª å½“é—­åŒ…ä»ç¯å¢ƒä¸­æ•è·ä¸€ä¸ªå€¼ï¼Œé—­åŒ…ä¼šåœ¨é—­åŒ…ä½“ä¸­å­˜å‚¨è¿™ä¸ªå€¼ä»¥ä¾›ä½¿ç”¨ é—­åŒ…è·å–ç¯å¢ƒçš„ä¸‰ç§æ–¹å¼ï¼ˆå¯¹åº”å‚æ•°è·å–çš„æ–¹å¼ï¼šæ‰€æœ‰æƒã€å¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨ï¼‰ï¼š FnOnceï¼šé—­åŒ…å‘¨å›´çš„ä½œç”¨åŸŸå«åšç¯å¢ƒï¼ŒOnce è¡¨ç¤ºé—­åŒ…ä¸èƒ½å¤šæ¬¡è·å–ç›¸åŒå˜é‡çš„æ‰€æœ‰æƒï¼Œä¹Ÿåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ç”±äºæ‰€æœ‰é—­åŒ…éƒ½è‡³å°‘è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€æœ‰éƒ½å®ç°äº† FnOnce FnMutï¼šè·å–å¯å˜å€Ÿç”¨å€¼ï¼Œå¯ä»¥æ”¹å˜ç¯å¢ƒã€‚å¯¹äºæ²¡æœ‰ç§»åŠ¨è¢«æ•è·å˜é‡çš„æ‰€æœ‰æƒåˆ°é—­åŒ…å†…çš„é—­åŒ…ä¹Ÿå®ç°äº† FnMut Fnï¼šè·å–ä¸å¯å˜å€Ÿç”¨ã€‚ä¸éœ€è¦å¯¹è¢«æ•è·çš„å˜é‡è¿›è¡Œå¯å˜è®¿é—®çš„é—­åŒ…å®ç°äº† Fn 1.è¿­ä»£å™¨æ¨¡å¼å…è®¸ä½ å¯¹ä¸€ä¸ªé¡¹çš„åºåˆ—è¿›è¡ŒæŸäº›å¤„ç†ï¼Œè¿­ä»£å™¨ï¼ˆiteratorï¼‰ è´Ÿè´£éå†åºåˆ—ä¸­çš„æ¯ä¸€é¡¹å’Œå†³å®šåºä½•æ—¶ç»“æŸ è¿­ä»£å™¨æ˜¯æƒ°æ€§çš„ï¼Œè”æƒ³ä¸‹ Python çš„ç”Ÿæˆå™¨ã€è¿­ä»£å™¨å°±å¥½äº† è¿­ä»£å™¨ trait ä¸­ type Item å’Œ Self::Item å®šä¹‰äº† trait çš„å…³è”ç±»å‹ iter æ–¹æ³•ç”Ÿæˆä¸€ä¸ªä¸å¯å˜åº”ç”¨çš„è¿­ä»£å™¨ï¼›into_iter åˆ™è¿”å›æ‹¥æœ‰æ‰€æœ‰æƒçš„è¿­ä»£å™¨ï¼›å¦‚æœéœ€è¦è¿­ä»£å¯å˜å¼•ç”¨ï¼Œåˆ™ä½¿ç”¨ iter_mut è¿­ä»£å™¨ æ˜¯ Rust é›¶å¼€é”€æŠ½è±¡ä¹‹ä¸€ï¼Œå®ƒæ„å‘³ç€æŠ½è±¡å¹¶ä¸ä¼šå¼•å…¥è¿è¡Œæ—¶å¼€é”€ å±•å¼€æ˜¯ä¸€ç§ç§»é™¤å¾ªç¯æ§åˆ¶ä»£ç çš„å¼€é”€ï¼Œå¹¶æ›¿æ¢ä¸ºæ¯ä¸ªè¿­ä»£ä¸­çš„é‡å¤ä»£ç çš„ä¼˜åŒ– å¼€èµ·æ¥ Rust æ˜¯æ¯”è¾ƒæ¨èä½¿ç”¨è¿­ä»£å™¨å’Œé—­åŒ…çš„ï¼Œè€Œä¸”å¯¹å‡½æ•°ç¼–ç¨‹é£æ ¼æ›´æ˜¯åçˆ±~ Cargo å’Œ crates.io æ–‡æ¡£æ³¨é‡Šä½¿ç”¨çš„æ˜¯ ///ï¼Œå¹¶ä¸”æ”¯æŒ Markdown æ³¨è§£ ä½¿ç”¨ cargo doc å¯ä»¥ç”Ÿæˆ HTML æ–‡æ¡£åˆ° target/doc ä¸­ï¼Œä½¿ç”¨ cargo doc --open å¯ä»¥æ„å»ºåæ‰“å¼€æ–‡æ¡£ æ–‡æ¡£ä¸­è¿˜å¯ä»¥åŒ…å« Panics, Errors å’Œ Safety //! åœ¨ crate æ ¹æ–‡ä»¶ï¼ˆ`src/lib.rsï¼‰æˆ–æ¨¡å—æ ¹æ–‡ä»¶æä¾›ä¸€ä¸ªæ¦‚è¦æ€§çš„ä»‹ç» ä½¿ç”¨ pub use å¯ä»¥é‡å¯¼å‡ºï¼Œä½¿å…±æœ‰ç»“æ„ä¸åŒäºç§æœ‰ç»“æ„ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼ˆå…¶å®åœ¨ Python ä¸­ä¹Ÿæœ‰å¾ˆå¤šåº“æ˜¯è¿™ä¹ˆå¹²çš„ï¼‰ å·¥ä½œç©ºé—´æ˜¯ä¸€ç³»åˆ—å…±äº«åŒæ ·çš„ Cargo.lock å’Œè¾“å‡ºç›®å½•çš„åŒ… ä½¿ç”¨ cargo install &lt;name&gt; å¯ä»¥å®‰è£…æ¥è‡ª creates.io çš„äºŒè¿›åˆ¶æ–‡ä»¶ æ™ºèƒ½æŒ‡é’ˆ æŒ‡é’ˆ æ˜¯ä¸€ä¸ªåŒ…å«å†…å­˜åœ°å€çš„å˜é‡çš„é€šç”¨æ¦‚å¿µã€‚Rust ä¸­æœ€å¸¸è§çš„æŒ‡é’ˆæ˜¯ å¼•ç”¨ï¼Œä½¿ç”¨ &amp; è¡¨ç¤ºï¼Œé™¤å¼•ç”¨æ•°æ®æ²¡æœ‰ä»»ä½•å…¶å®ƒç‰¹æ®ŠåŠŸèƒ½ï¼Œæ²¡æœ‰ä»»ä½•é¢å¤–å¼€é”€ æ™ºèƒ½æŒ‡é’ˆ æ˜¯ä¸€ç±»æ•°æ®ç»“æ„ï¼Œè¡¨ç°ç±»ä¼¼æŒ‡é’ˆï¼Œä½†æ˜¯æ‹¥æœ‰é¢å¤–çš„å…ƒæ•°æ®å’ŒåŠŸèƒ½ Rust ä¸­ï¼Œæ™®é€šå¼•ç”¨å’Œæ™ºèƒ½æŒ‡é’ˆçš„ä¸€ä¸ªé¢å¤–åŒºåˆ«æ˜¯ å¼•ç”¨æ˜¯ä¸€ç±»åªå€Ÿç”¨æ•°æ®çš„æŒ‡é’ˆï¼›å¤§éƒ¨åˆ†æƒ…å†µï¼Œæ™ºèƒ½æŒ‡é’ˆæ‹¥æœ‰å®ƒä»¬æŒ‡å‘çš„æ•°æ® æ™ºèƒ½æŒ‡é’ˆé€šå¸¸ä½¿ç”¨ç»“æ„ä½“å®ç°ï¼ŒåŒºåˆ«äºå¸¸è§„ç»“æ„ä½“ï¼Œå®ƒå®ç°äº† Deref å’Œ Drop traitï¼š Deref è¿è¡Œæ™ºèƒ½æŒ‡é’ˆç»“æ„ä½“å®ä¾‹è¡¨ç°å¾—åƒå¼•ç”¨ Drop åˆ™å…è®¸è‡ªå®šä¹‰å½“æ™ºèƒ½æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸæ—¶è¿è¡Œçš„é€»è¾‘ æ ‡å‡†åº“ä¸­å¸¸ç”¨çš„æ™ºèƒ½æŒ‡é’ˆï¼ˆä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰çš„æ™ºèƒ½æŒ‡é’ˆï¼‰ï¼š Box&lt;T&gt; ç”¨äºåœ¨å †ä¸Šåˆ†é…å€¼ Rc&lt;T&gt; å¼•ç”¨è®¡æ•°ç±»å‹ï¼Œæ•°æ®å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€… Ref&lt;T&gt; å’Œ RefMut&lt;T&gt;ï¼Œé€šè¿‡ RefCell&lt;T&gt; è®¿é—®ï¼Œåœ¨è¿è¡Œæ—¶è€Œéç¼–è¯‘æ—¶æ‰§è¡Œå€Ÿç”¨è§„åˆ™çš„ç±»å‹ Box ä½¿ç”¨åœºæ™¯ï¼š å½“æœ‰ä¸€ä¸ªåœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„ç±»å‹ï¼Œè€Œåˆæƒ³è¦åœ¨éœ€è¦ç¡®åˆ‡å¤§å°çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨è¯¥ç±»å‹æ—¶ å½“æœ‰å¤§é‡æ•°æ®ä¸”å¸Œæœ›åœ¨ç¡®ä¿æ•°æ®ä¸è¢«æ‹·è´çš„æƒ…å†µä¸‹è½¬ç§»æ‰€æœ‰æƒæ—¶ å½“å¸Œæœ›æ‹¥æœ‰ä¸€ä¸ªå€¼ï¼Œä¸”åªå…³å¿ƒå®ƒçš„ç±»å‹æ˜¯å¦å®ç°äº†ç‰¹å®š trait è€Œä¸æ˜¯å…¶å…·ä½“ç±»å‹æ—¶ é€’å½’ç±»å‹ æ˜¯åœ¨ç¼–è¯‘å™¨æ— æ³•çŸ¥é“å¤§å°çš„ç±»å‹ï¼Œä¹Ÿæ˜¯ Box&lt;T&gt; é€‚ç”¨çš„åœºæ™¯ Deref å®ç° Deref trait å…è®¸é‡è½½ã€Œè§£å¼•ç”¨è¿ç®—ç¬¦ï¼ˆdereference operatorï¼‰*ã€ï¼Œè¿™æ ·æ™ºèƒ½æŒ‡é’ˆå°±å¯ä»¥è¢«å½“ä½œå¸¸è§„å¼•ç”¨å¯¹å¾… å®ç°äº† deref æ–¹æ³•åï¼Œå°±æ˜¯å‘ç¼–è¯‘å™¨æä¾›äº†è·å–ä»»ä½•å®ç°äº† Deref trait ç±»å‹çš„å€¼ï¼Œæä¾›äº†è§£å¼•ç”¨çš„èƒ½åŠ› ä»¥ let z = Box::new(10) ä¸ºä¾‹ï¼Œ*z åœ¨åº•å±‚å…¶å®æ˜¯ *(z.deref()) æ“ä½œ ä¸€èˆ¬æ‰€æœ‰æƒä¾ç„¶è¦ä¿ç•™åœ¨æ™ºèƒ½æŒ‡é’ˆç»“æ„ä½“ä¸­ï¼Œä¸ç”¨æŠŠæ‰€æœ‰æƒè½¬ç§»å‡ºå» è§£å¼•ç”¨å¼ºåˆ¶å¤šæ€ï¼ˆderef coercionsï¼‰ æ˜¯ Rust è¡¨ç°åœ¨å‡½æ•°æˆ–æ–¹æ³•ä¼ å‚ä¸Šçš„ä¸€ç§ä¾¿åˆ©ã€‚å½“æ‰€æ¶‰åŠçš„ç±»å‹å®šä¹‰äº† Deref traitï¼ŒRust ä¼šåˆ†æè¿™äº›ç±»å‹å¹¶ä½¿ç”¨ä»»æ„å¤šæ¬¡ Deref::deref è°ƒç”¨è·å¾—åŒ¹é…å‚æ•°çš„ç±»å‹ï¼ˆéƒ½å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ï¼‰ï¼Œè€Œä¸”ä¹Ÿè®©ä»£ç å¯è¯»æ€§æ›´å¥½ï¼š 123456789101112131415161718fn main() &#123; let m = MyBox::new(String::from("world")); // æ­£å¼å› ä¸ºã€Œè§£å¼•ç”¨å¼ºåˆ¶å¤šæ€ã€æœºåˆ¶å­˜åœ¨ï¼Œè¿™ç§ä¼ å‚æ˜¯æ”¯æŒçš„ï¼Œä¼šè‡ªåŠ¨åšç±»å‹è½¬æ¢ // ç¬¬ä¸€æ¬¡ deref æ‹¿åˆ° &amp;String ï¼ˆé’ˆå¯¹ Box ç±»å‹ï¼‰ // ç¬¬äºŒæ¬¡ deref æ‹¿åˆ° &amp;strï¼ˆé’ˆå¯¹ &amp;String ç±»å‹ï¼‰ print_box(&amp;m); // å¦åˆ™ï¼Œä½ å¯èƒ½è¦è¿™æ ·å†™ print_box(&amp;(*m)); // ç”šè‡³è¿™æ · print_box(&amp;(*m)[..])&#125;fn print_box(s: &amp;str) &#123; println!("hello, &#123;&#125;", s);&#125; è§£å¼•ç”¨å¼ºåˆ¶å¤šæ€ç”Ÿæ•ˆæƒ…å†µï¼š å½“ T: Deref&lt;Target=U&gt; æ—¶ï¼Œ&amp;T -&gt; &amp;U å½“ T: DerefMut&lt;Target=U&gt; æ—¶ï¼Œ&amp;mut T -&gt; &amp;mut U å½“ T: Deref&lt;Target=U&gt; æ—¶ï¼Œ&amp;mut T -&gt; &amp;U Rust å¯ä»¥å°†å¯å˜å¼•ç”¨å¼ºåˆ¶å˜æˆä¸å¯å˜å¼•ç”¨ï¼ˆåè¿‡æ¥ä¸è¡Œï¼Œè€ƒè™‘ä¸‹ä¸ºä»€ä¹ˆï¼Ÿï¼‰ Drop å½“å€¼è¦ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¯ä»¥ä¸ºè¯¥ç±»å‹å®ç° Drop traitï¼Œè¿™æ ·å¯ä»¥åœ¨ç¦»å¼€æ—¶åšä¸€äº›è‡ªå®šä¹‰çš„æ¸…ç†å·¥ä½œï¼šç½‘ç»œèµ„æºã€æ–‡ä»¶æˆ–è€…å†…å­˜ç©ºé—´é‡Šæ”¾ç­‰ æˆ‘ä»¬ä¸èƒ½ç›´æˆªäº†å½“åœ°ç¦ç”¨è‡ªåŠ¨ drop åŠŸèƒ½ï¼Œé€šå¸¸ä¹Ÿä¸éœ€è¦ã€‚Drop trait å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯å®ƒä¼šè¢«è‡ªåŠ¨å¤„ç† å¦‚æœéœ€è¦æå‰æ‰§è¡Œ dropï¼Œå¯ä»¥ä½¿ç”¨ std::mem::drop å‡½æ•°ï¼Œä½†ä¸èƒ½ç›´æ¥è°ƒç”¨å€¼çš„ drop æ–¹æ³•ï¼Œå› ä¸ºç¦»å¼€ä½œç”¨åŸŸå Rust ä¼šè‡ªåŠ¨è°ƒç”¨å€¼çš„ drop æ–¹æ³•ï¼Œä»è€Œå¯¼è‡´ double free é”™è¯¯ Rc å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æƒæ˜¯å¾ˆæ¸…æ™°çš„ã€‚ä½†æœ‰æ—¶å€™æŸä¸ªå€¼å´å¯ä»¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼Œæ¯”å¦‚å›¾æ•°æ®ç»“æ„ä¸­ï¼Œå¤šæ¡è¾¹å¯èƒ½æŒ‡å‘ç›¸åŒçš„èŠ‚ç‚¹ Rc&lt;T&gt; ä¼šè¿½è¸ªå€¼çš„å¼•ç”¨è®¡æ•°ï¼Œä¿è¯æ²¡æœ‰å¼•ç”¨æ—¶ï¼Œæ‰å¯ä»¥è¢«æ¸…ç©º Rc&lt;T&gt; ç”¨äºå½“æˆ‘ä»¬å¸Œæœ›åœ¨å †ä¸Šåˆ†é…å†…å­˜ä¾›å¤šä¸ªéƒ¨åˆ†è¯»å–ï¼Œä½†åˆä¸èƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®šå“ªä¸ªéƒ¨åˆ†ä¼šåœ¨æœ€åç»“æŸä½¿ç”¨å®ƒã€‚ Rc&lt;T&gt; åªèƒ½ç”¨äºå•çº¿ç¨‹åœºæ™¯ Rc::new å’Œ Rc::clone æ–¹æ³•æ¯”è¾ƒå¸¸ç”¨ï¼ŒRc::clone åšçš„æ˜¯æµ…æ‹·è´ï¼Œå¹¶ä¸”æ¯æ¬¡è°ƒç”¨åªä¼šç»™å¼•ç”¨è®¡æ•°åŠ  1 Rc::strong_count å¯ä»¥æŸ¥çœ‹å¼•ç”¨è®¡æ•°ï¼ˆæ³¨æ„è¿˜æœ‰ä¸ª Rc::weak_countï¼Œé¿å…å¾ªç¯å¼•ç”¨ä½¿ç”¨ï¼‰ RefCell å’Œå†…éƒ¨å¯å˜æ¨¡å¼ å†…éƒ¨å¯å˜æ€§ï¼ˆInterior mutabilityï¼‰ æ˜¯ Rust ä¸­çš„ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå…è®¸ä½ åœ¨æœ‰ä¸å¯å˜å¼•ç”¨æ—¶ä¹Ÿèƒ½æ”¹å˜æ•°æ®ã€‚ä½¿ç”¨ unsafe æ¥æ¨¡ç³Š Rust çš„å¸¸è§„çš„å¯å˜æ€§å’Œå€Ÿç”¨è§„åˆ™ RefCell&lt;T&gt; ä»£è¡¨å…¶ç®¡ç†çš„æ•°æ®çš„å”¯ä¸€æ‰€æœ‰æƒ å€Ÿç”¨è§„åˆ™ï¼š åœ¨ä»»æ„ç»™å®šæ—¶é—´ï¼Œåªèƒ½æ‹¥æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨æˆ–ä»»æ„æ•°é‡çš„ä¸å¯å˜å¼•ç”¨ä¹‹ä¸€ å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„ å¯¹äº RefCell&lt;T&gt;ï¼Œä¸å¯å˜æ€§ä½œç”¨äº è¿è¡Œæ—¶ï¼›å¦‚æœåœ¨è¿è¡Œæ—¶è¿åå€Ÿç”¨è§„åˆ™ï¼Œç¨‹åºä¼š panic RefCell&lt;T&gt; ç”¨äºä½ ç¡®ä¿¡ä»£ç éµå®ˆå€Ÿç”¨è§„åˆ™ï¼Œä½†ç¼–è¯‘å™¨è¿™ä¸ªå¤§ç¬¨è›‹ä¸èƒ½ç†è§£å’Œç¡®å®šçš„æ—¶å€™ åªèƒ½ç”¨äºå•çº¿ç¨‹åœºæ™¯ åœ¨ä¸å¯å˜å€¼å†…éƒ¨æ”¹å˜å€¼å°±æ˜¯ å†…éƒ¨å¯å˜æ€§ æ¨¡å¼ï¼Œä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯ mock å¯¹è±¡ æµ‹è¯•æ›¿èº«ï¼ˆtest doubleï¼‰ æ˜¯ä¸€ä¸ªé€šç”¨ç¼–ç¨‹æ¦‚å¿µï¼Œå®ƒä»£è¡¨ä¸€ä¸ªåœ¨æµ‹è¯•ä¸­æ›¿ä»£æŸä¸ªç±»å‹çš„ç±»å‹ borrow æ–¹æ³•è¿”å› Refï¼›borrow_mut è¿”å› RefMut Rc&lt;T&gt; å’Œ RefCell&lt;T&gt; ç»“åˆï¼Œå¯ä»¥åšåˆ°å€¼æœ‰å¤šä¸ªæ‰€æœ‰è€…å¹¶ä¸”å¯ä»¥è¢«ä¿®æ”¹ å¾ªç¯å¼•ç”¨ Rust çš„å†…å­˜å®‰å…¨æœºåˆ¶ä½¿å¾—å†…å­˜æ³„æ¼æ›´åŠ å°‘è§ï¼Œé™¤éä½ åˆ»æ„åˆ›å»ºç±»ä¼¼å¾ªç¯å¼•ç”¨è¿™ç§æ•°æ®ç»“æ„ Rc::clone å¢åŠ å®ä¾‹çš„ strong_count Rc::downgrade åˆ›å»ºå€¼çš„ å¼±å¼•ç”¨ï¼ˆweak refï¼‰ ï¼Œä¼šå¾—åˆ° Weak&lt;T&gt; ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶ä¼šå°† weak_count å¢åŠ ã€‚weak_count æ— éœ€è®¡æ•°å™¨ä¸º 0 å°±èƒ½ä½¿ Rc å®ä¾‹è¢«æ¸…ç† å¼ºå¼•ç”¨ä»£è¡¨å¦‚ä½•å…±äº« Rc&lt;T&gt; å®ä¾‹æ‰€æœ‰æƒï¼Œå¼±å¼•ç”¨ä¸ä»£è¡¨æ‰€æœ‰æƒå…³ç³» Weak&lt;T&gt; å®ä¾‹çš„ upgrade æ–¹æ³•è¿”å› Option&lt;Rc&lt;T&gt;&gt;ï¼Œéœ€è¦æ£€æŸ¥æŒ‡å‘çš„å€¼æ˜¯å¦è¢«æ¸…ç†äº† å¹¶å‘çº¿ç¨‹ å¹¶å‘ç¼–ç¨‹ ä»£è¡¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ç›¸äº’ç‹¬ç«‹æ‰§è¡Œï¼›å¹¶è¡Œç¼–ç¨‹ ä»£è¡¨ç¨‹åºä¸åŒéƒ¨åˆ†åŒæ—¶æ‰§è¡Œ å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç¼–ç¨‹å…¶å®è¿˜æ˜¯è¦å°å¿ƒç‚¹ï¼Œä½†æ˜¯ä¸è¦å®³æ€•ï¼Œéœ€è¦çš„æ—¶å€™å°±å¤§èƒ†ç”¨ Rust æ ‡å‡†åº“ä½¿ç”¨ 1:1 çº¿ç¨‹æ¨¡å‹å®ç°ï¼Œè¶³å¤Ÿåº•å±‚ thread::spawn å¯ä»¥å¯åŠ¨æ–°çš„çº¿ç¨‹ å¦‚æœè¦åœ¨åˆ«çš„çº¿ç¨‹ä¸­ä½¿ç”¨ä¸»çº¿ç¨‹ä¸­çš„å€¼ï¼Œéœ€è¦ä½¿ç”¨ move å…³é”®å­— æ¶ˆæ¯ä¼ é€’ ä½¿ç”¨ æ¶ˆæ¯ä¼ é€’ çš„æ–¹å¼åœ¨å¤šçº¿ç¨‹ä¸­é€šä¿¡ Do not communicate by sharing memory; instead, share memory by communicating Rust ä¸­å®ç°æ¶ˆæ¯ä¼ é€’çš„ä¸»è¦å·¥å…·æ˜¯ é€šé“ï¼ˆchannelï¼‰ï¼š å‘é€æ–¹ï¼štransmitter/producer æ¥æ”¶æ–¹ï¼šreceiver/consumer å½“å‘é€æ–¹æˆ–æ¥æ”¶æ–¹ä»»æ„ä¸€ä¸ªè¢« dropï¼Œéƒ½å¯ä»¥è®¤ä¸ºé€šé“è¢«å…³é—­äº†ï¼ˆä¸åƒ Go ä¸­çš„æ˜¾å¼ close(chan)ï¼‰ mpsc::channelï¼Œè¿™é‡Œ mpsc å…¨ç§°æ˜¯ å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ï¼ˆmultiple producer, single consumerï¼‰ recv æ˜¯é˜»å¡æ¥æ”¶ï¼Œtry_recv åˆ™ä¼šç«‹å³è¿”å› å¯ä»¥å¯¹ receiver è¿›è¡Œè¿­ä»£ï¼Œæ¶ˆè´¹ channel ä¸­çš„æ¶ˆæ¯ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œçš„ channel æ˜¯å¸¦ç¼“å†²çš„ï¼‰ mpsc::Sender::clone å¯ä»¥ç”¨æ¥å…‹éš†ç”Ÿæˆå¤šä¸ªç”Ÿäº§è€… çŠ¶æ€å…±äº«ï¼šMutex ä¸ Arc åŸºäº channel çš„æœºåˆ¶ç±»ä¼¼äºå•æ‰€æœ‰æƒï¼Œä¸€æ—¦å€¼è¢«å‘é€å‡ºå»ï¼Œå‘é€æ–¹å°†å¤±å»æ‰€æœ‰æƒ å…±äº«å†…å­˜æ¨¡å¼åˆ™ç±»ä¼¼å¤šæ‰€æœ‰æƒï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ç›¸åŒçš„å†…å­˜åœ°å€ äº’æ–¥ä¿¡å·é‡ï¼ˆmutex, mutual exclusionï¼‰ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸäº›æ•°æ® Arc&lt;T&gt; ç±»ä¼¼äº Rc&lt;T&gt;ï¼ŒA è¡¨ç¤º Atomicï¼Œå³åŸå­çš„ã€‚å¼•ç”¨è®¡æ•°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯å®‰å…¨çš„ï¼Œä½†å› ä¸ºéœ€è¦å¹¶å‘åŸè¯­åŠ æŒï¼Œæ‰€ä»¥ç›¸å¯¹ Rc&lt;T&gt; ä¼šå­˜åœ¨æ€§èƒ½æŸè€— Mutex&lt;T&gt; æä¾›äº†å†…éƒ¨å¯å˜æ€§ RefCell&lt;T&gt; å’Œ Mutex&lt;T&gt; å…·æœ‰ç›¸ä¼¼çš„ä½œç”¨ Rc&lt;T&gt; å’Œ Arc&lt;T&gt; ä¹Ÿæ˜¯ç±»ä¼¼ Sync å’Œ Send Rust è¯­è¨€æœ¬èº«å¯¹å¹¶å‘çŸ¥ä¹‹ç”šå°‘ï¼Œå‰é¢æåˆ°çš„åªæ˜¯æ ‡å‡†åº“å®ç°æ–¹æ¡ˆï¼Œä½†å¹¶å‘æ–¹æ¡ˆä¸å—æ ‡å‡†åº“æˆ–è¯­è¨€æ‰€é™ std::marker ä¸­ Send ä¸ Sync traitï¼š Send å…è®¸åœ¨å¤šçº¿ç¨‹ä¹‹é—´è½¬ç§»æ‰€æœ‰æƒ å‡ ä¹æ‰€æœ‰çš„ Rust ç±»å‹éƒ½æ˜¯å¯ Send çš„ï¼Œä»»ä½•ç”± Send ç±»å‹ç»„æˆçš„å¤åˆç±»å‹ä¹Ÿæ˜¯ Send çš„ Sync å…è®¸å¤šçº¿ç¨‹è®¿é—®ï¼šå®ç°äº† Sync çš„ç±»å‹å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­æ‹¥æœ‰å…¶å€¼çš„å¼•ç”¨ å¯¹äºä»»æ„ç±»å‹ Tï¼Œå¦‚æœ &amp;T æ˜¯ Send çš„ï¼Œé‚£ä¹ˆ T å°±æ˜¯ Sync çš„ å®Œå…¨ç”± Sync çš„ç±»å‹ç»„æˆçš„ç±»å‹ä¹Ÿæ˜¯ Sync çš„ æ‰‹åŠ¨å®ç° Send å’Œ Sync æ˜¯ä¸å®‰å…¨çš„ï¼Œå®ƒä»¬æ˜¯æ ‡è®° traitï¼Œç”šè‡³éƒ½ä¸éœ€è¦å®ç°ä»»ä½•æ–¹æ³•ï¼Œç”¨äºåŠ å¼ºå¹¶å‘ç›¸å…³æ€§çš„ä¸å¯å˜æ€§ Rust é¢å‘å¯¹è±¡ç‰¹å¾é¢å‘å¯¹è±¡è¯­è¨€ç‰¹ç‚¹ Design Patterns: Elements of Resuable Object-Oriented Software ä¸­å¯¹äºé¢å‘å¯¹è±¡çš„å®šä¹‰ï¼š 12Object-oriented programs are made up of objects. An object packages both data and the procedures thatpeople on that data. The procedures are typically called methods or operations. é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€çš„å…±äº«ç‰¹æ€§ï¼šå¯¹è±¡ã€å°è£… å’Œå¤šæ€ Rust çš„ç»“æ„ä½“å’Œ Enum æ˜¯ç¬¦åˆå¯¹è±¡åŒ…å«æ•°æ®å’Œè¡Œä¸ºå®šä¹‰çš„ï¼›å¦å¤–ï¼Œé€šè¿‡ pub å…³é”®å­—å¯ä»¥æ§åˆ¶æ˜¯å¦å¯¹å¤–æä¾›è®¿é—®æƒé™ï¼Œå¯¹äºç»†èŠ‚å¯ä»¥ç§æœ‰åŒ–ï¼Œä¸ç”¨å¯¹å¤–æš´éœ² ç»§æ‰¿ï¼šå¤ç”¨ä»£ç ï¼›å­ç±»å‹å¯ä»¥æ›¿ä»£çˆ¶ç±»å‹è¢«ä½¿ç”¨çš„åœ°æ–¹ï¼ˆå³å¤šæ€ï¼‰ã€‚ç»§æ‰¿å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯å¸¸å¸¸ä¼šå…±äº«å¤šäºéœ€è¦çš„ä»£ç ï¼ˆæœ‰è¿™ç§é£é™©ï¼‰ Rust ä½¿ç”¨ trait å¯¹è±¡æ›¿ä»£ç»§æ‰¿ï¼Œå®ç°å¤šæ€ï¼ˆä¸€ç§å¯ç”¨äºå¤šç§ç±»å‹ä»£ç çš„å¹¿æ³›æ¦‚å¿µï¼‰ Trait Object trait å¯¹è±¡æŒ‡å‘ä¸€ä¸ªå®ç°äº†æŒ‡å®š trait çš„ç±»å‹å®ä¾‹ï¼Œé€šè¿‡æŒ‡å®šæŸäº›æŒ‡é’ˆï¼ˆ&amp; æˆ– Box&lt;T&gt; ç­‰ï¼‰ï¼Œæ¥ç€æŒ‡å®šç›¸å…³ trait ä¸èƒ½å‘ trait å¯¹è±¡ä¸­å¢åŠ æ•°æ®ï¼Œæ²¡æœ‰é‚£ä¹ˆé€šç”¨ï¼šå…·ä½“ä½œç”¨æ˜¯å…è®¸å¯¹é€šç”¨è¡Œä¸ºè¿›è¡ŒæŠ½è±¡ ä¸å®šä¹‰äº†ä½¿ç”¨ trait bound çš„æ³›å‹ç±»å‹å‚æ•°ä¸åŒçš„ç»“æ„ä½“ä¸åŒï¼Œtrait å¯¹è±¡å…è®¸è¿è¡Œæ—¶æ›¿ä»£å¤šç§å…·ä½“ç±»å‹ï¼Œè€Œæ³›å‹å‚æ•°åˆ™ä¸€æ¬¡åªèƒ½æ›¿ä»£ä¸€ä¸ªå…·ä½“ç±»å‹ ç±»ä¼¼åŠ¨æ€è¯­è¨€ä¸­çš„ é¸­å­ç±»å‹ æ¦‚å¿µï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“ç»„ä»¶çš„å…·ä½“ç±»å‹ï¼Œåªéœ€è¦ç¡®å®šæ˜¯å¦å®ç°äº†æŒ‡å®šçš„ trait å³å¯æ‰§è¡ŒæœŸæœ›çš„æ“ä½œ ä½¿ç”¨ trait å¯¹è±¡å’Œ Rust ç±»å‹ç³»ç»Ÿè¿›è¡Œç±»ä¼¼é¸­å­ç±»å‹æ“ä½œçš„ä¼˜åŠ¿æ˜¯æ— éœ€åœ¨ è¿è¡Œæ—¶ æ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦å®ç°äº†ç‰¹å®šçš„æ–¹æ³•æˆ–æ‹…å¿ƒè°ƒç”¨æ—¶å› ä¸ºå€¼æ²¡æœ‰å®ç°æ–¹æ³•è€Œäº§ç”Ÿé”™è¯¯ trait å¯¹è±¡æ‰§è¡ŒåŠ¨æ€åˆ†å‘ï¼ˆç¼–è¯‘å™¨ä¼šç”Ÿæˆåœ¨è¿è¡Œæ—¶ç¡®å®šè°ƒç”¨ä»€ä¹ˆæ–¹æ³•çš„ä»£ç ï¼‰ï¼ŒåŠ¨æ€ä¼˜åŒ–ä¼šå¯¼è‡´ç¼–è¯‘å™¨ç¦ç”¨ä¸€äº›ä¼˜åŒ– åªæœ‰å¯¹è±¡å®‰å…¨ï¼ˆobject safeï¼‰çš„ trait æ‰å¯ä»¥ç»„æˆ trait å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ª trait ä¸­çš„æ–¹æ³•æœ‰å¦‚ä¸‹å±æ€§æ—¶ï¼Œåˆ™è¯¥ trait æ˜¯å¯¹è±¡å®‰å…¨çš„ï¼š è¿”å›å€¼ç±»å‹ä¸æ˜¯ Self æ–¹æ³•æ²¡æœ‰ä»»ä½•æ³›å‹ç±»å‹å‚æ•° çŠ¶æ€æ¨¡å¼å®ç° çŠ¶æ€æ¨¡å¼ æ˜¯ä¸€ä¸ªé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼šä¸€ä¸ªå€¼æ‹¥æœ‰æŸäº›å†…éƒ¨çŠ¶æ€ï¼ˆä½“ç°ä¸ºä¸€ç³»åˆ— çŠ¶æ€å¯¹è±¡ï¼‰ï¼ŒåŒæ—¶å€¼çš„è¡Œä¸ºä¼šéšç€å†…éƒ¨çŠ¶æ€è€Œæ”¹å˜ã€‚æ¯ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ä»£è¡¨è´Ÿè´£è‡ªèº«çš„è¡Œä¸ºå’Œå½“éœ€è¦æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€æ—¶çš„è§„åˆ™çŠ¶æ€ã€‚æŒæœ‰ä»»ä½•ä¸€ä¸ªè¿™ç§çŠ¶æ€çš„å€¼ä¸åŒäºçŠ¶æ€çš„è¡Œä¸ºåŠä½•æ—¶çŠ¶æ€è½¬ç§»æ¯«ä¸çŸ¥æƒ… ä¼˜ç‚¹ï¼šæ˜“äºæ‰©å±•å’Œç»´æŠ¤ ç¼ºç‚¹ï¼š å› ä¸ºéœ€è¦å®ç°çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ï¼Œäº§ç”Ÿç›¸äº’è”ç³» å­˜åœ¨é‡å¤é€»è¾‘ æ¨¡å¼åŒ¹é… æ¨¡å¼å¯ç”±ä¸‹é¢çš„å†…å®¹ç»„åˆè€Œæˆï¼š å­—é¢å€¼ è§£æ„çš„æ•°ç»„ã€æšä¸¾ã€ç»“æ„ä½“æˆ–å…ƒç»„ å˜é‡ é€šé…ç¬¦ å ä½ç¬¦ match è¡¨è¾¾æ—¶å¿…é¡»æ˜¯ç©·å°½çš„ï¼ˆexhaustiveï¼‰ if let, else if, else if let å¯ä»¥æ··åˆä½¿ç”¨çš„æ¡ä»¶è¡¨è¾¾å¼ while let æ¡ä»¶å¾ªç¯ for (x, y) in å¾ªç¯ let è¯­å¥ å¦‚æœå¸Œæœ›å¿½ç•¥å…ƒç»„ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå€¼ï¼Œå¯ä»¥ä½¿ç”¨ _ æˆ– .. å‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥æ˜¯æ¨¡å¼ Refutableï¼ˆå¯åé©³çš„ï¼‰ï¼šèƒ½å¤ŸåŒ¹é…ä»»ä½•ä¼ é€’çš„å¯èƒ½å€¼çš„æ¨¡å¼ if let è¡¨è¾¾å¼ while let è¡¨è¾¾å¼ Irrefutableï¼ˆä¸å¯åé©³çš„ï¼‰ï¼šå¯¹æŸäº›å¯èƒ½çš„å€¼è¿›è¡ŒåŒ¹é…ä¼šå¤±è´¥çš„æ¨¡å¼ let è¯­å¥ å‡½æ•°å‚æ•° for å¾ªç¯ char å’Œ numeric å€¼æ˜¯ Rust å¯ä»¥çŸ¥é“èŒƒå›´æ˜¯å¦ä¸ºç©ºçš„ç±»å‹ åŒ¹é…å®ˆå«ï¼ˆmatch guardï¼‰ æ˜¯ä¸€ä¸ªåœ¨ match åˆ†æ”¯åæŒ‡å®šçš„é¢å¤–çš„ if æ¡ä»¶ï¼Œå½“åŒ¹é…åˆ°è¯¥åˆ†æ”¯æ—¶ï¼Œé¢å¤–çš„ if æ¡ä»¶ä¹Ÿå¿…é¡»æ»¡è¶³æ‰å¯ä»¥ã€‚åŒ¹é…å®ˆå«å¯¹äºè¡¨è¾¾éå¸¸å¤æ‚çš„åŒ¹é…æ¡ä»¶æ—¶å¾ˆæœ‰å¸®åŠ© Rust é«˜çº§ç‰¹æ€§ï¼ˆéš¾ï¼‰Unsafe Rust å¯ä»¥æä¾› Super Power: è§£å¼•ç”¨è£¸æŒ‡é’ˆ è°ƒç”¨ä¸å®‰å…¨çš„å‡½æ•°æˆ–æ–¹æ³• è®¿é—®æˆ–ä¿®æ”¹å¯å˜é™æ€å˜é‡ å®ç°ä¸å®‰å…¨çš„ traitï¼šå½“è‡³å°‘æœ‰ä¸€ä¸ªæ–¹æ³•ä¸­åŒ…å«ç¼–è¯‘å™¨æ— æ³•éªŒè¯çš„å˜é‡æ—¶ trait æ˜¯ä¸å®‰å…¨çš„ ä¹‹æ‰€ä»¥éœ€è¦ Unsafe Rustï¼Œæ˜¯å› ä¸ºï¼š é™æ€åˆ†æï¼ˆç¼–è¯‘å™¨ï¼‰æœ¬è´¨ä¸Šæ˜¯ä¿å®ˆçš„ï¼Œæœ‰æ—¶å€™ç¨‹åºå¯èƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä½†è¢«æ‹’ç»ç¼–è¯‘ åº•å±‚è®¡ç®—æœºç¡¬ä»¶å›ºæœ‰çš„ä¸å®‰å…¨æ€§ unsafe å¹¶ä¸ä¼šå…³é—­ borrow-checker æˆ–è€…ç¦ç”¨å…¶å®ƒ Rust å®‰å…¨æ£€æŸ¥ unsafe ä¸ä»£è¡¨ä»£ç å—çœŸçš„å¾ˆå±é™©æˆ–è€…å¿…ç„¶å¯¼è‡´å†…å­˜å®‰å…¨é—®é¢˜ï¼ŒçœŸæ­£æ„å›¾æ˜¯ç¨‹åºå‘˜ä¼šç¡®ä¿ unsafe block ä¸­çš„ä»£ç æ˜¯ä»¥æœ‰æ•ˆçš„æ–¹å¼è®¿é—®å†…å­˜ å¯ä»¥ä¸ºä¸å®‰å…¨çš„ä»£ç æä¾›å®‰å…¨çš„æŠ½è±¡æ¥å£ è£¸æŒ‡é’ˆï¼ˆraw pointersï¼‰ ç±»å‹ï¼š*const T å’Œ *mut Tï¼ŒåŒºåˆ«äºå¼•ç”¨å’Œæ™ºèƒ½æŒ‡é’ˆçš„åœ°æ–¹ï¼š å…è®¸å¿½ç•¥å€Ÿç”¨è§„åˆ™ï¼Œå¯åŒæ—¶æ‹¥æœ‰ä¸å¯å˜å’Œå¯å˜çš„æŒ‡é’ˆï¼Œæˆ–å¤šä¸ªæŒ‡å‘ç›¸åŒä½ç½®çš„å¯å˜æŒ‡é’ˆ ä¸ä¿è¯æŒ‡å‘æœ‰æ•ˆçš„å†…å­˜ å…è®¸ä¸ºç©º ä¸èƒ½å®ç°ä»»ä½•è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ å¯ä»¥åœ¨å®‰å…¨çš„ä»£ç ä¸­åˆ›å»ºè£¸æŒ‡é’ˆï¼Œä½†ä¸èƒ½ç›´æ¥ è§£å¼•ç”¨ è£¸æŒ‡é’ˆï¼ˆå¿…é¡»è¦åœ¨ unsafe ç¯å¢ƒä¸‹ï¼‰ è£¸æŒ‡é’ˆçš„ä¸€ä¸ªå¸¸è§çš„åº”ç”¨åœºæ™¯å°±æ˜¯è°ƒç”¨ C æ¥å£ extern å…³é”®å­—å¯ä»¥åˆ›å»ºå’Œä½¿ç”¨ å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆForeign Function Interface, FFIï¼‰ å¸¸é‡ä¸é™æ€å˜é‡ï¼š é™æ€å˜é‡çš„å†…å­˜åœ°å€æ€»æ˜¯å›ºå®šçš„ï¼Œä¸”ç”Ÿå‘½å‘¨æœŸä¸º &#39;staticï¼Œä½¿ç”¨é™æ€å˜é‡å€¼æ€»ä¼šè®¿é—®ç›¸åŒçš„åœ°å€ å¸¸é‡å…è®¸åœ¨ä»»ä½•è¢«ç”¨åˆ°çš„æ—¶å€™å¤åˆ¶å…¶æ•°æ® é™æ€å˜é‡æ˜¯å¯å˜çš„ï¼Œè®¿é—®å’Œä¿®æ”¹å¯å˜é™æ€å˜é‡éƒ½æ˜¯ ä¸å®‰å…¨ çš„ é«˜çº§ç”Ÿå‘½å‘¨æœŸ æ¶‰åŠçš„ä¸»é¢˜ï¼š ç”Ÿå‘½å‘¨æœŸå­ç±»å‹ï¼ˆlifetime subtypingï¼‰ï¼šç¡®ä¿æŸä¸ªç”Ÿå‘½å‘¨æœŸé•¿äºå¦ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼ ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼ˆlifetime boundsï¼‰ï¼šç”¨äºæŒ‡å®šæ³›å‹å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸ trait å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼ˆtrait object lifetimesï¼‰ï¼šå¦‚ä½•æ¨æ–­ï¼Œä½•æ—¶éœ€è¦ç»‘å®š åŒ¿åç”Ÿå‘½å‘¨æœŸï¼šçœç•¥å†™æ³• trait bound å¯ä»¥å¸®åŠ© Rust éªŒè¯æ³›å‹çš„å¼•ç”¨ä¸ä¼šå­˜åœ¨çš„æ¯”å…¶å¼•ç”¨çš„æ•°æ®æ›´ä¹…ï¼šå¦‚ T: &#39;a&#39; &#39;_ åŒ¿åç”Ÿå‘½å‘¨æœŸï¼Œç®€åŒ–å†™æ³• é«˜çº§ trait å…³è”ç±»å‹ï¼ˆassociated typesï¼‰ æ˜¯ä¸€ä¸ªå°†ç±»å‹å ä½ç¬¦ä¸ trait ç›¸å…³è”çš„æ–¹å¼ï¼Œè¿™æ · trait çš„æ–¹æ³•ç­¾åä¸­å°±å¯ä»¥ä½¿ç”¨è¿™äº›å ä½ç¬¦ ä¸ºä½•è¦ä½¿ç”¨å…³è”ç±»å‹è€Œéæ³›å‹å‘¢ï¼š æ³›å‹çš„è¯ï¼Œæ¯æ¬¡å®ç° trait éƒ½éœ€è¦æ³¨æ˜ç±»å‹ï¼›æ”¯æŒå¤šæ¬¡å®ç° trait å…³è”ç±»å‹ï¼Œåˆ™åªèƒ½é’ˆå¯¹ä¸€ç§ç±»å‹å®ç°ä¸€æ¬¡ï¼Œä¸”æ— éœ€æ³¨æ˜ç±»å‹ å½“ä½¿ç”¨æ³›å‹å‚æ•°æ—¶ï¼Œå¯ä»¥ä¸ºæ³›å‹æŒ‡å®šé»˜è®¤çš„å…·ä½“ç±»å‹ã€‚ä¸ºæ³›å‹æŒ‡å®šé»˜è®¤ç±»å‹çš„è¯­æ³•æ˜¯åœ¨å£°æ˜æ³›å‹ç±»å‹æ—¶ä½¿ç”¨ï¼š&lt;PlaceholderType=ConcreteType&gt; std::ops ä¸­åˆ—å‡ºçš„è¿ç®—ç¬¦å’Œ trait å¯ä»¥é‡è½½ RHS å…¨ç§°æ˜¯ right hand side RHS=Selfï¼šé»˜è®¤ç±»å‹å‚æ•°ï¼ˆdefault parametersï¼‰ Rust ä¸ä¼šé˜»æ­¢ä½ ä¸ºä¸€ä¸ªç±»å‹å®ç°æŸä¸ªæ–¹æ³•ï¼Œå†å»å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªå…·æœ‰åŒåçš„ trait æ–¹æ³•ã€‚ä½†æ˜¯åœ¨è°ƒç”¨æ—¶ï¼Œé»˜è®¤ä¼šè°ƒç”¨ç›´æ¥å®ç°åœ¨ç±»å‹ä¸Šçš„æ–¹æ³•ã€‚è¦æƒ³è°ƒç”¨æŒ‡å®š trait çš„æŸä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ TraitName::method(&amp;obj) è¿™ç§å†™æ³• å®Œå…¨é™å®šè¯­æ³•æ¶ˆé™¤åŒåå…³è”å‡½æ•°æ­§ä¹‰ç¤ºä¾‹ï¼š&lt;Dog as Animal&gt;::baby_name()ï¼Œå®Œæ•´è¯­æ³•ï¼š 1&lt;Type as Trait&gt;::function(receiver_if_method, next_arg, ...); å¯ä»¥é€‰æ‹©åœ¨ä»»ä½•å‡½æ•°æˆ–æ–¹æ³•è°ƒç”¨å¤„ä½¿ç”¨å®Œå…¨é™å®šè¯­æ³• é«˜çº§ç±»å‹ å¿…é¡»å°†åŠ¨æ€å¤§å°ç±»å‹çš„å€¼ç½®äºæŸç§æŒ‡é’ˆä¹‹å åŠ¨æ€å¤§å°ç±»å‹ (DSTï¼Œdynamically sized types)ï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶æ‰å¯ä»¥çŸ¥é“å¤§å°çš„ç±»å‹ Sized traitï¼Œå†³å®šä¸€ä¸ªç±»å‹çš„å¤§å°æ˜¯å¦åœ¨ç¼–è¯‘æ—¶å¯çŸ¥ï¼Œè‡ªåŠ¨ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“å¤§å°çš„ç±»å‹å®ç° Rust éšå¼åœ°ä½æ¯ä¸ªæ³›å‹å‡½æ•°å¢åŠ äº† Sized bound 12// é»˜è®¤æ·»åŠ äº† `Sized` ç»‘å®šfn generic&lt;T: Sized&gt; (t: T) &#123;&#125; ?Sized å¯ä»¥æ”¾å®½é™åˆ¶ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨ &amp;Tï¼Œä¿è¯å‚æ•°æ˜¯ç±»å‹æ˜¯ Sizedï¼Œä½† T å¯ä»¥ä¸ç”¨æ˜¯ Sized çš„ï¼š 1fn generic&lt;T: ?Sized&gt; (t: &amp;T) &#123;&#125; é«˜çº§å‡½æ•°å’Œé—­åŒ… é™¤äº†å¯ä»¥å‘å‡½æ•°ä¼ é€’é—­åŒ…å¤–ï¼Œè¿˜å¯ä»¥ä¼ é€’å¸¸è§„å‡½æ•°ã€‚é€šè¿‡å‡½æ•°æŒ‡é’ˆå…è®¸ä½¿ç”¨å‡½æ•°ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•° fn å«åš å‡½æ•°æŒ‡é’ˆï¼ˆfunction pointerï¼‰ å‡½æ•°æŒ‡é’ˆå®ç°äº†ä¸‰ä¸ªé—­åŒ… traitï¼ˆFn, FnMut å’Œ FnOnceï¼‰ï¼Œæ€»æ˜¯å¯ä»¥åœ¨è°ƒç”¨æœŸæœ›é—­åŒ…çš„å‡½æ•°æ—¶ä¼ é€’å‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•° å® å®ï¼ˆMacroï¼‰ æ˜¯ Rust ä¸­ä¸€äº›åˆ—çš„åŠŸèƒ½ï¼š å£°æ˜ï¼ˆDeclarativeï¼‰å®ï¼šä½¿ç”¨ macro_rules! è¿‡ç¨‹ï¼ˆProcedural) å®ï¼š è‡ªå®šä¹‰ #[derive] å® ç±»å±æ€§ï¼ˆAttributeï¼‰å® ç±»å‡½æ•°å® å®æ˜¯ä¸€ç§ä¸ºå…¶å®ƒä»£ç è€Œå†™ä»£ç çš„æ–¹å¼ï¼Œå³æ‰€è°“çš„ **å…ƒç¼–ç¨‹ï¼ˆmeta programmingï¼‰ å…ƒç¼–ç¨‹å¯¹äºå‡å°‘å¤§é‡ç¼–å†™å’Œç»´æŠ¤çš„ä»£ç éå¸¸æœ‰ç”¨ å®åªæ¥å—ä¸€ä¸ªå¯å˜å‚æ•° å®å¯ä»¥åœ¨ç¼–è¯‘å™¨ç¿»è¯‘ä»£ç å‰å±•å¼€ å®æ¯”æ™®é€šå‡½æ•°æ›´åŠ éš¾ä»¥é˜…è¯»ã€ç†è§£å’Œç»´æŠ¤ åœ¨è°ƒç”¨å® ä¹‹å‰ å¿…é¡»å®šä¹‰å¹¶å¼•å…¥åˆ°ä½œç”¨åŸŸï¼Œè€Œå‡½æ•°åˆ™å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å®šä¹‰å’Œè°ƒç”¨ å®æ¨¡å¼æ‰€åŒ¹é…çš„æ˜¯ Rust ä»£ç ç»“æ„è€Œéå€¼ï¼Œæ‰€ä»¥å’Œ match æ¨¡å¼åŒ¹é…ä¸åŒ è¿‡ç¨‹å®æ›´åƒå‡½æ•°ï¼ˆä¸€ç§è¿‡ç¨‹ç±»å‹ï¼‰ï¼Œæ¥æ”¶ Rust ä»£ç ä½œä¸ºè¾“å…¥ï¼Œåœ¨è¿™äº›ä»£ç ä¸Šè¿›è¡Œæ“ä½œï¼Œå†äº§ç”Ÿå¦ä¸€äº›ä»£ç ä½œä¸ºè¾“å‡ºï¼Œè€Œéåƒå£°æ˜å¼å®é‚£æ ·åŒ¹é…æ¨¡å¼ï¼Œå†ç”¨å¦å¤–ä¸€éƒ¨åˆ†ä»£ç æ›¿æ¢å½“å‰ä»£ç  #[derive(xx)] å±æ€§å¯ä»¥ç”Ÿæˆä»£ç  ç±»å±æ€§å®åˆ™å…è®¸åˆ›å»ºæ–°çš„å±æ€§ #[some_attribute] derive åªèƒ½ç”¨äºç»“æ„ä½“å’Œæšä¸¾ï¼›å±æ€§åˆ™å¯ä»¥ç”¨äºå…¶å®ƒçš„é¡¹ï¼Œå¦‚å‡½æ•° ç±»å‡½æ•°å®å®šä¹‰çœ‹èµ·æ¥åƒå‡½æ•°è°ƒç”¨çš„å®ï¼Œå¦‚ let sql = sql!(SELECT * FROM users) å‚è€ƒ The Rust Book Rust ç¨‹åºè®¾è®¡è¯­è¨€ self, Self in Rust Paradigms of Rust for the Go developer]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>Rust</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹å­¦ä¹ ç¬”è®°ä¹‹ä»‹ç»]]></title>
    <url>%2F2018%2F12%2F22%2Fclean-arch-notes-intro%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è¿‘æ¥å¼€å§‹é˜…è¯» Robert C. Martin çš„æ–°è‘—ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹ï¼ˆClean Architectureï¼‰ã€‚æ²¡æœ‰äººæ„¿æ„çœ‹åˆ°å›¢é˜Ÿå†…çš„é¡¹ç›®é€æ¸å‘å±•æˆä¸€å›¢ä¹±éº»ï¼Œç›¸äº’çº ç¼ ã€‚é‚£å¦‚ä½•ä»æ ¹æœ¬ä¸Šå‡å°‘è¿™ç§é—®é¢˜çš„å‘ç”Ÿå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬æŒæ¡ä¸€äº›å®è§‚å±‚é¢çš„è®¾è®¡æ€æƒ³ï¼Œä»ç»™é¡¹ç›®æ‰“åŸºç¡€æ—¶å°±åº”è¯¥è€ƒè™‘å¥½å„ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°ç­‰å¦‚ä½•è®¾è®¡æˆé«˜å†…èšã€ä½è€¦åˆçš„ç»“æ„ã€‚æ•´æ´çš„é¡¹ç›®æ¶æ„æ˜¯åˆ©äºé•¿è¿œå‘å±•çš„ï¼Œè¿™ç¯‡ç¬”è®°å°†ä¼šè®°å½•ä¸€äº›ä»ä¹¦ä¸­å­¦ä¹ åˆ°çš„é‡è¦çŸ¥è¯†ç‚¹ï¼Œä¾¿äºåæœŸå¤ä¹ å’Œå‚è€ƒã€‚ å½“ç„¶ï¼Œä½œè€…è¿˜æœ‰ä¸€æœ¬å¤§åé¼é¼çš„è‘—ä½œã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ä¹Ÿéå¸¸å€¼å¾—é˜…è¯»ï¼Œå…³äºè¿™æœ¬ä¹¦ä¹Ÿåšäº†ç‚¹ç¬”è®°ï¼Œå‚è§ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹è¯»ä¹¦ç¬”è®°~ è¦ç‚¹è®°å½•ä»€ä¹ˆæ˜¯è®¾è®¡å’Œæ¶æ„ è®¡ç®—æœºä»£ç è¿™ä¹ˆå¤šå¹´æ²¡æœ‰å‘ç”Ÿæœ¬è´¨çš„å˜åŒ–ï¼Œå¯¼è‡´è½¯ä»¶æ¶æ„çš„è§„åˆ™ä¿æŒäº†ä¸€è‡´ã€‚è½¯ä»¶æ¶æ„çš„è§„åˆ™å…¶å®å°±æ˜¯æ’åˆ—ç»„åˆä»£ç å—çš„è§„åˆ™ è®©ä¸€ä¸ªç¨‹åºå¯ä»¥å·¥ä½œéå¸¸å®¹æ˜“ï¼ˆå°å­©å­éƒ½èƒ½åšåˆ°ï¼‰ï¼Œä½†è®©å®ƒæ­£ç¡®åœ°å·¥ä½œåˆ™æ˜¯å¦å¤–ä¸€å›äº‹ã€‚è€Œè®©è½¯ä»¶æ­£ç¡®å·¥ä½œåˆ™æ›´åŠ å›°éš¾ï¼Œå› ä¸ºè¿™éœ€è¦å¼€å‘äººå‘˜æœ‰ç‹¬åˆ°çš„æ€æƒ³å’Œè¿œè§ï¼ŒæŒæ¡ä¸€å®šçš„è®¾è®¡è§„åˆ™ åœ¨è½¯ä»¶è®¾è®¡ä¸­ï¼Œåº•å±‚çš„ç»†èŠ‚å’Œä¸Šå±‚çš„ç»“æ„æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¸å¯åˆ†å‰² è½¯ä»¶æ¶æ„çš„ç›®æ ‡æ˜¯æœ€å°åŒ–æ„å»ºå’Œç»´æŠ¤ç³»ç»Ÿæ‰€éœ€è¦çš„äººåŠ›èµ„æº ä¸è¦æ€»æ˜¯å¯„å¸Œæœ›äºä»¥åæ¥è§£å†³æŠ€æœ¯å€ºåŠ¡ï¼Œå› ä¸ºä½ ä¼šå‘ç°ä»¥åæ€»æ˜¯å¾ˆé¥è¿œ äº‹å®æ˜¯ making messes is always slower than staying clean èµ°å¾—å¿«çš„å”¯ä¸€åŠæ³•ï¼Œæ˜¯å…ˆèµ°å¥½ï¼ˆThe only way to go fast, is to go wellï¼‰ ä»·å€¼å¯¹æ¯”ï¼šè¡¨ç° vs ç»“æ„ï¼ˆæ¶æ„ï¼‰(Behavior and Structureï¼‰ ä»»ä½•è½¯ä»¶ç³»ç»Ÿéƒ½ä¼šåœ¨ä¸¤ä¸ªæ–¹é¢äº§ç”Ÿä»·å€¼ï¼šBehavior å’Œ Structure è¡¨ç°ï¼ˆBehaviorï¼‰ï¼šè½¯ä»¶è¢«å¼€å‘ç”¨æ¥è®©è®¡ç®—æœºæŒ‰ç…§é¢„æœŸçš„æ–¹å¼å·¥ä½œå¹¶äº§ç”Ÿä»·å€¼ï¼Œæˆ–è€…ä¸ºäººä»¬è§£çº¦å¼€æ”¯ æ¶æ„ï¼ˆArchitectureï¼‰ï¼š è½¯ä»¶åº”è¯¥æ˜“äºæ›´å˜å…¶è¡Œä¸ºè¡¨ç°ï¼ˆçµæ´»ã€å¯æ‰©å±•ï¼‰ å¦‚æœå¤§éƒ¨åˆ†éœ€æ±‚å˜æ›´åªæ˜¯å±€éƒ¨å˜åŒ–ï¼Œè€Œä¸æ˜¯å½±å“åˆ°æ•´ä½“æ¶æ„ã€Œå¤–å½¢ï¼ˆshapeï¼‰ã€çš„è¯ï¼Œé‚£åº”è¯¥æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä½†å¦‚æœæ¶æ„æœ¬èº«æ— æ³•æ»¡è¶³éœ€æ±‚å®ç°ï¼Œåˆ™ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€å‘æˆæœ¬ æ¶æ„æœ¬èº«å¦‚æœåªå±€é™äºæŸç§ã€Œå¤–å½¢ï¼ˆshapeï¼‰ã€ï¼ˆæˆ–è€…æ›´åå‘äºï¼‰ï¼Œé‚£æ–°å¢åŠŸèƒ½å¯èƒ½ä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚æ‰€ä»¥è¯´ï¼Œæ¶æ„æœ¬èº«ä¸è¦æŠŠè‡ªå·±é™åˆ¶æ­»ï¼Œåº”è¯¥æ˜¯èƒ½çµæ´»åº”å¯¹å˜åŒ–é¢‘ç¹çš„éœ€æ±‚çš„ã€‚æ›´ä¸ºå®é™…çš„æ¶æ„åº”è¯¥æ˜¯å¯¹ã€Œå¤–å½¢ã€æ— æ„ŸçŸ¥çš„ï¼ˆæ›´å¼ºçš„åŒ…å®¹æ€§ï¼‰ ä½œä¸ºè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬ä¸èƒ½ä¸€å‘³åœ°æ»¡è¶³äº§å“ç»ç†ä»¬å„ç§åŠŸèƒ½å †ç§¯ï¼Œè€Œå¿½ç•¥äº†è½¯ä»¶è´¨é‡ï¼Œä¹ŸåŒæ ·è¦è®©è½¯ä»¶æ¶æ„å˜å¾—æ›´çµæ´» Dwight D. Eisenhower: â€œI have two kinds of problems, the urgent and the important. The urgent are not important, and the important are never urgentâ€ æˆ‘ä»¬å¯ä»¥æ ¹æ®é‡è¦æ€§å’Œç´§æ€¥æ€§å¯¹ä»»åŠ¡åšå¦‚ä¸‹åˆ†ç±»ï¼š ç´§æ€¥ + é‡è¦ï¼ˆæ¯”å¦‚å‡ºç°äº†å½±å“ç”¨æˆ·çš„å¤§ Bugï¼‰ ä¸ç´§æ€¥ + é‡è¦ï¼ˆæ¶æ„ã€å·¥ç¨‹è´¨é‡ã€ä»£ç é‡æ„ï¼‰ ç´§æ€¥ + ä¸é‡è¦ï¼ˆéœ€æ±‚é€šå¸¸æ¯”è¾ƒç´§æ€¥ï¼Œä½†å¹¶ä¸æ€»æ˜¯éå¸¸é‡è¦çš„ï¼‰ ä¸ç´§æ€¥ + ä¸é‡è¦ å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé¡¹ç›®ç»ç†ä¼šè¯¯åˆ¤ä¼˜å…ˆçº§ï¼ŒæŠŠã€Œç´§æ€¥ + ä¸é‡è¦ã€çš„ä»»åŠ¡è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ï¼Œè¿™æ ·å°±å¯¼è‡´å¼€å‘äººå‘˜å¿½ç•¥äº†è½¯ä»¶æ¶æ„ï¼Œè®©ç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šè„†å¼± å¼€å‘äººå‘˜çš„èŒè´£å°±æ˜¯è¦ç¡®å®šæ¶æ„å’Œæ‰€è°“çš„ç´§æ€¥éœ€æ±‚å“ªä¸ªæ˜¯çœŸçš„æ›´é‡è¦çš„ ä½œä¸ºå¼€å‘å›¢é˜Ÿçš„ä¸€å‘˜ï¼Œå®ˆæŠ¤ä½ çš„é¡¹ç›®è´¨é‡æ˜¯ä½ çš„èŒè´£æ‰€åœ¨ï¼›è€Œä½œä¸ºæ¶æ„å¸ˆï¼Œæ›´éœ€è¦é‡ç‚¹å…³æ³¨ç³»ç»Ÿç»“æ„è€Œéå„ç§ç‰¹æ€§å’ŒåŠŸèƒ½ï¼Œè‰¯å¥½çš„æ¶æ„åº”è¯¥å…è®¸å„ç§ç‰¹æ€§å’ŒåŠŸèƒ½æ˜“äºæ·»åŠ ï¼Œä¿®æ”¹å’Œæ‰©å±• å°ç»“æ­£æ‰€è°“ã€Œç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å¾ˆéª¨æ„Ÿã€ï¼Œç°å®å¼€å‘ä¸­å¦‚æœæƒ³è¦ä¿è¯å¿«é€Ÿè¿­ä»£çš„åŒæ—¶ï¼Œå°½å¯èƒ½ä¸ç ´åé¡¹ç›®ç»“æ„ï¼Œè™½ç„¶æœ‰ç‚¹å›°éš¾ï¼Œä½†å¹¶éåšä¸åˆ°ã€‚é¦–å…ˆé¡¹ç›®æœ¬èº«åœ¨æœ€åˆè®¾è®¡æ—¶å°±åº”è¯¥æ˜¯ä¸ºæ–¹ä¾¿æ‰©å±•è€ƒè™‘çš„ï¼ˆå¦‚æ¨¡å—åŒ–ã€ç¼–å†™é£æ ¼ç­‰ï¼‰ï¼›å…¶æ¬¡ï¼Œå›¢é˜Ÿçš„æˆå‘˜åº”è¯¥æ˜¯è¦æœ‰è¾ƒå¼ºçš„è´£ä»»å¿ƒæ¥ä¿æŠ¤è¿™ç§è‰¯å¥½çš„è®¾è®¡ï¼Œè¿™æ ·åœ¨æ‰©å±•æ–°åŠŸèƒ½æ—¶å°±ä¼šæ›´åŠ é¡ºåˆ©ã€‚]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>æ¶æ„</tag>
        <tag>è®¾è®¡æ€ç»´</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go Web å·¥ç¨‹å®è·µæ€»ç»“]]></title>
    <url>%2F2018%2F12%2F16%2Fgolang-web-dev-practice-summary%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æ—©æœŸæˆ‘ä»¬åœ¨ä¸€äº›å°çš„ Web é¡¹ç›®ä¸­ä½¿ç”¨äº† Go æ¥å¼€å‘ç®€å•çš„ REST APIï¼Œä¸»è¦å‚è€ƒçš„æ˜¯å…¶å®ƒéƒ¨é—¨çš„æ ¸å¿ƒé¡¹ç›®ã€‚ä½†å½“æ—¶åªæ˜¯ä¸ºäº†å°é²œå’Œå…¥é—¨ Go Web å¼€å‘ï¼Œå¹¶æ²¡æœ‰èŠ±è¾ƒå¤šçš„æ—¶é—´è€ƒè™‘å·¥ç¨‹ç»“æ„ã€é¡¹ç›®è´¨é‡è¿™äº›è‡³å…³é‡è¦çš„é—®é¢˜ã€‚ å†åæ¥ï¼Œç»„å†…é™†ç»­å¤šä¸ªé¡¹ç›®ä½¿ç”¨äº† Go è¯­è¨€å¼€å‘ã€‚æ•´ä½“æ¥è¯´ï¼Œé¡¹ç›®ç»“æ„ä¸Šå¤§ä½“æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯åœ¨å·¥ç¨‹å®è·µä¸Šè¿˜æ˜¯æœ‰ä¸å¤ªç»Ÿä¸€çš„åœ°æ–¹ã€‚æˆ‘ä»¬å¸Œæœ›æ–°çš„é¡¹ç›®èƒ½å¤Ÿåœ¨é¡¹ç›®ç»“æ„ã€å·¥ç¨‹è´¨é‡ä¸Šæœ‰æ‰€æ”¹å–„ï¼Œæé«˜å·¥ç¨‹ç¨³å®šæ€§ä¸å¼€å‘å¹¸ç¦æ„Ÿæ˜¯éœ€è¦æˆ‘ä»¬å…±åŒåŠªåŠ›çš„ç›®æ ‡ã€‚ åæ¥æ‰¾åˆ°æœºä¼šä»ä¸€ä¸ªå¤§çš„é¡¹ç›®ä¸­æ‹†å‡ºå¯ä»¥å®Œå…¨ç‹¬ç«‹çš„æœåŠ¡ï¼Œè¿™æ¬¡å¹¶æ²¡æœ‰å®Œå…¨ç…§æ¬å…¶å®ƒ Go é¡¹ç›®çš„å·¥ç¨‹å®è·µã€‚å¾ˆå¤šæ—¶å€™ï¼Œæ‰€è°“çš„æœ€ä½³å®è·µæ˜¯éœ€è¦æƒè¡¡å„ç§åˆ©å¼Šå¾—æ¥çš„ã€‚åœ¨è¿™æ¬¡å®è·µä¸­ï¼Œæˆ‘ä»¬ç€é‡äºæ”¹å–„å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š é¡¹ç›®ç»“æ„ï¼šå±‚æ¬¡ç»“æ„è°ƒæ•´ã€åŒ…å‘½åé£æ ¼ç»Ÿä¸€ ç»Ÿä¸€ Model å±‚æ¥å£ï¼šé€šè¿‡ä¸€ä¸ªç±»ä¼¼ GORM çš„å·¥å…·å®ç° å¯èƒ½æ›´åŠ ä¼˜é›…çš„ REST API å†™æ³•ï¼šåŸºäº chi æ¡†æ¶åšäº†ä¸€å±‚å°è£…ï¼›è·¯ç”±æ³¨å†Œå°½å¯èƒ½ç»Ÿä¸€åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œé›†ä¸­ç®¡ç† API Schema æ•°æ®èšåˆï¼šå®ç°äº†ä¸€ä¸ªç±»ä¼¼æˆ‘ä»¬åœ¨ Python é¡¹ç›®ä¸­ä½¿ç”¨çš„ marshmallow åº“è§£å†³ å•å…ƒæµ‹è¯•ï¼šè¿è¡Œæ—¶ Patchï¼Œä¸éœ€è¦åœ¨å†™ Handler/Controller/RPC æ—¶éƒ½ä»¥ interface ä¼˜å…ˆçš„æ–¹å¼ è¿”å› Error è€Œä¸æ˜¯ Panic æ‰ é¡¹ç›®ç»“æ„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647.â”œâ”€â”€ Gopkg.lockï¼ˆDep åŒ…ç®¡ç†å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€ç»´æŠ¤ï¼‰â”œâ”€â”€ Gopkg.tomlï¼ˆä¾èµ–åŒ…ç®¡ç†ï¼‰â”œâ”€â”€ Makefileâ”œâ”€â”€ README.mdï¼ˆé¡¹ç›®æ–‡æ¡£ï¼‰â”œâ”€â”€ binï¼ˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œçš„æœåŠ¡ï¼šRPC å’Œ HTTP æœåŠ¡ç­‰ï¼‰â”œâ”€â”€ cmdâ”‚ â”œâ”€â”€ serviceï¼ˆå¯¹å¤–æä¾›çš„ RPC æœåŠ¡å…¥å£ï¼‰â”‚ â”‚ â””â”€â”€ main.goâ”‚ â””â”€â”€ webï¼ˆå¯¹å¤–æä¾›çš„ HTTP API æœåŠ¡å…¥å£ï¼‰â”‚ â””â”€â”€ main.goâ”œâ”€â”€ gen-goï¼ˆåŸºäº thrift ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶ï¼Œåœ¨å®ç°å¯¹å¤–æä¾›çš„ RPC æœåŠ¡æ¥å£æ—¶éœ€è¦ä½¿ç”¨ï¼‰â”œâ”€â”€ joker.ymlâ”œâ”€â”€ pkgï¼ˆæ ¸å¿ƒä»£ç æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼‰â”‚ â”œâ”€â”€ configsï¼ˆèµ„æºé…ç½®ï¼šMySQL, Redis ç­‰ï¼‰â”‚ â”‚ â”œâ”€â”€ mysql.goâ”‚ â”‚ â”œâ”€â”€ redis.goâ”‚ â”œâ”€â”€ constsï¼ˆå¸¸é‡å®šä¹‰ï¼ŒåŒ…æ‹¬æšä¸¾ï¼‰â”‚ â”‚ â”œâ”€â”€ enum.goâ”‚ â”‚ â””â”€â”€ macro.goâ”‚ â”œâ”€â”€ controllersï¼ˆå¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ”¾åˆ°è¿™å„¿å®ç°ï¼‰â”‚ â”‚ â”œâ”€â”€ foo.goâ”‚ â”œâ”€â”€ errsï¼ˆä¸šåŠ¡è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼‰â”‚ â”œâ”€â”€ middlewaresï¼ˆä¸šåŠ¡ç›¸å…³çš„ä¸­é—´ä»¶ï¼Œå¦‚æœå¯ä»¥å¤ç”¨ï¼Œå°±æŠ½åˆ°å…¬å…±ä»“åº“ç»´æŠ¤ï¼‰â”‚ â”œâ”€â”€ modelsï¼ˆé¡¾åæ€ä¹‰ï¼Œå®šä¹‰ Modelï¼Œå…³è”æ•°æ®åº“è¡¨ï¼‰â”‚ â”œâ”€â”€ rpcsï¼ˆä¾èµ–çš„ç¬¬ä¸‰æ–¹ RPC æœåŠ¡ï¼‰â”‚ â”‚ â”œâ”€â”€ bar.goâ”‚ â”œâ”€â”€ serviceï¼ˆå¯¹å¤–æä¾›çš„ RPC æœåŠ¡å®ç°ï¼‰â”‚ â”‚ â”œâ”€â”€ demo-service.goâ”‚ â”‚ â””â”€â”€ protosâ”‚ â”‚ â””â”€â”€ demo-service.thriftâ”‚ â”œâ”€â”€ utilsï¼ˆå¯å¤ç”¨çš„å·¥å…·ï¼šå•å…ƒæµ‹è¯•ç­‰ï¼‰â”‚ â””â”€â”€ webï¼ˆREST API æœåŠ¡ï¼‰â”‚ â”œâ”€â”€ handlersâ”‚ â”œâ”€â”€ routersâ”‚ â”‚ â”œâ”€â”€ router.goï¼ˆè·¯ç”±æ³¨å†Œï¼‰â”‚ â”‚ â””â”€â”€ urls.goï¼ˆURL ä¸ Handler çš„ç»‘å®šï¼‰â”‚ â”œâ”€â”€ schemasâ”‚ â”‚ â”œâ”€â”€ dumpï¼ˆèšåˆæ•°æ®æºï¼Œå®šä¹‰å¯¹å¤–çš„ API Schemaï¼‰â”‚ â”‚ â””â”€â”€ loadï¼ˆå¤„ç†è¾“å…¥ï¼Œå­—æ®µæ ¡éªŒè§„åˆ™é…ç½®ï¼‰â”‚ â””â”€â”€ validatorsï¼ˆå¯å¤ç”¨çš„è‡ªå®šä¹‰æ ¡éªŒè§„åˆ™å®šä¹‰ï¼‰â”œâ”€â”€ scriptsï¼ˆè„šæœ¬ï¼‰â”œâ”€â”€ testdataï¼ˆä¸šåŠ¡é€»è¾‘æµ‹è¯•éœ€è¦ç”¨çš„æµ‹è¯•æ•°æ®ï¼‰â”‚ â”œâ”€â”€ fixturesï¼ˆé€ ä¸€äº›æµ‹è¯•æ•°æ®æ”¾åœ¨é‡Œé¢ï¼Œé»˜è®¤ä½¿ç”¨ YAML æ ¼å¼ï¼‰â”‚ â”‚ â”œâ”€â”€ foo.ymlâ”‚ â””â”€â”€ schema.sqlï¼ˆæ•°æ®åº“è¡¨åˆ›å»ºè¯­å¥é›†åˆï¼‰â””â”€â”€ vendorï¼ˆå„ç§ä¾èµ–åŒ…ï¼‰ MVC æ€ä¹ˆå®è·µModelå…³äº Model å±‚æ€ä¹ˆå†™ï¼Œè¿™ä¸ªçœ‹èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹äº‰è®®ã€‚ä¹‹å‰å»å¬äº†å…¶å®ƒéƒ¨é—¨ Go å®è·µç»éªŒåˆ†äº«ï¼Œæå€¡åŠæ‰‹å†™ SQLï¼ˆæœ¬è´¨ä¸Šä½¿ç”¨äº† SQL æ„å»ºå™¨ï¼‰çš„æ–¹å¼ã€‚ä½†è¿™ä¹ˆåšæ„Ÿè§‰è¿˜æ˜¯å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼ˆä¸»è¦æ˜¯è€ƒè™‘åˆ°åæœŸç»´æŠ¤è€…çš„æ„Ÿå—ï¼‰ï¼š æ¥å£å¤ç”¨æ€§ä¸å¤Ÿå¥½ å†™æ³•éš¾ä»¥ç»Ÿä¸€ï¼Œä¸”ä»£ç é‡å®¹æ˜“è†¨èƒ€ æ‰‹å·¥ç»„è£… SQL æ¯”è¾ƒç¹çï¼Œä¸”ä¸æ˜“äºåæœŸå˜æ›´ï¼ˆå¦‚æ–°å¢å­—æ®µï¼‰ é‡å¤é€»è¾‘ä¸å¯é¿å… åº”ç”¨å±‚æ›´åº”è¯¥å…³æ³¨çš„æ˜¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œè€Œéç¹çé‡å¤çš„ä»£ç ç¼–å†™ï¼ˆKeep It Simpleï¼‰ã€‚å‚ç…§æˆ‘ä»¬åœ¨ Python ä¸­çš„å®è·µï¼Œé‡‡ç”¨äº†è½»é‡çº§çš„ ORM å·¥å…·åå¾ˆå¤§ç¨‹åº¦ä¸Šç»Ÿä¸€äº†å¢åˆ æ”¹æŸ¥æ¥å£ï¼Œè¿™æ ·æ¯ä¸ªç»´æŠ¤è€…éƒ½ä¸ç”¨çƒ¦å¿ƒäº†è§£å„ç§ç±»ä¼¼ get_xxx_by_wtf_balabala å‡½æ•°äº†ã€‚å› ä¸ºåŠ äº†ä¸€å±‚æŠ½è±¡ï¼Œå¯è¢«å¤ç”¨çš„é€»è¾‘å®Œå…¨ä»æˆ‘ä»¬çš„ä¸šåŠ¡å±‚æŠ½ç¦»å‡ºå»ç»´æŠ¤ï¼Œä¹Ÿå¯ä»¥å¤§å¤§ç®€åŒ–åº”ç”¨å±‚ä»£ç ã€‚ å¯¹äºå¸¸è§„ä¸šåŠ¡ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ¥å—ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œä¸å¦¨å¼•å…¥ä¸€äº›å·¥å…·ï¼Œæ¥æ”¹å–„é¡¹ç›®è´¨é‡å¹¶ä¸”æé«˜å¼€å‘æ•ˆç‡ã€‚ ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åœ¨è‡ªå·±çš„ Go é¡¹ç›®ä¸­ï¼Œèƒ½å¤Ÿä½¿ç”¨è¾ƒä¸ºä¸€è‡´çš„æ–¹å¼å®ç°å¸¸è§„çš„å¢åˆ æ”¹æŸ¥éœ€æ±‚ï¼Œæ‰€ä»¥å°±èŠ±äº†äº›æ—¶é—´é€ äº†ä¸ªç±»ä¼¼ GORM çš„å·¥å…· BORMã€‚åœ¨ç»å†å¤šæ¬¡è¿­ä»£åï¼Œç›®å‰åŸºæœ¬è¶‹äºç¨³å®šã€‚ç›®å‰æˆ‘ä»¬å·²ç»åœ¨å¤šä¸ªå†…éƒ¨é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œå¹¶åœ¨å®è·µä¸­ä¿®å¤äº†ä¸å°‘ç»†èŠ‚é—®é¢˜ï¼Œå¢åŠ äº†ä¸€äº›éå¸¸å®ç”¨çš„åŠŸèƒ½ã€‚ ä»¥ä¸‹æ˜¯è¯¥å·¥å…·æä¾›çš„ä¸€äº›å¸¸ç”¨æ¥å£ï¼š æ¥å£ æ³¨é‡Š Create/MustCreate æ–°å»ºè®°å½• Save/MustSave å…¨é‡æ›´æ–° Update/MustUpdate æ›´æ–°æŒ‡å®šå•ä¸ªå­—æ®µ Updates/MustUpdates æ›´æ–°æŒ‡å®šå¤šä¸ªå­—æ®µ Delete/MustDelete åˆ é™¤è®°å½• One/MustOne æ ¹æ®æ¡ä»¶åŒ¹é…ä¸€æ¡è®°å½• All/MustAll åŒ¹é…æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½• FindByPK/MustFindByPK åŸºäºä¸»é”®æŸ¥è¯¢è®°å½• Begin/Commit/Rollback äº‹åŠ¡ç›¸å…³æ¥å£ æ€»çš„æ¥è¯´ï¼Œå¸Œæœ› BORM èƒ½å¤Ÿè§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š ç»Ÿä¸€ä¸”æ¸…æ™°çš„å¢åˆ æ”¹æŸ¥æ¥å£ SQL è‡ªåŠ¨ç»„è£…ï¼Œæ— éœ€äººè‚‰æ‹¼æ¥ åŸºäº Model å±‚çš„ç¼“å­˜ç®¡ç†ç»Ÿä¸€åˆ°å·¥å…·å±‚è§£å†³ å¼•å…¥ BORMå¦‚æœéœ€è¦åœ¨é¡¹ç›®ä¸­å¼•å…¥ BORMï¼Œå¯ä»¥é‡‡ç”¨ç±»ä¼¼ä¸‹é¢çš„ç›®å½•ç»“æ„ï¼š 123pkg/modelsâ”œâ”€â”€ init.goâ””â”€â”€ material.go åœ¨ init.go ä¸­ï¼Œé…ç½® BORM çš„æ•°æ®åº“è¿æ¥ï¼ˆæˆ–è€…æ·»åŠ ç¼“å­˜æ”¯æŒï¼‰ï¼š 1234567891011121314151617package modelsimport ( "url/to/borm" "project/pkg/configs")func init() &#123; mysqlConfig := configs.GetMySQLConfig("demo") borm.Setup(borm.NewMySQLConfig( mysqlConfig.Masters[0], mysqlConfig.Slaves, )) // å¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥æ·»åŠ  Model ç¼“å­˜æ”¯æŒ // borm.Use(cache.New(configs.GetRedisConfig("cache-redis"), false))&#125; ç¼–å†™ Modelæ¥ä¸‹æ¥ï¼Œè¡¨æ¼”ä¸‹å¦‚ä½•ç¼–å†™ Modelï¼Œä»¥åŠå¦‚ä½•ç»™ Model ä»¥ã€Œå±æ€§ã€çš„æ–¹å¼å…³è”èµ„æºï¼ˆç±»ä¼¼äºæˆ‘ä»¬åœ¨ Python ä¸­ä½¿ç”¨ property è·å–æŸä¸ª Model å…³è”çš„èµ„æºï¼‰ç­‰ï¼š 12345678910111213141516171819202122232425262728293031323334// MaterialModel æ˜¯å¹¿å‘Šç´ æèµ„æºtype MaterialModel struct &#123; // å¯¹äº BORM è€Œè¨€ï¼Œé»˜è®¤ä¼šä½¿ç”¨åå« `id` çš„å­—æ®µä½œä¸ºä¸»é”®ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œçš„å¤§å†™å­—æ®µååœ¨ç”Ÿæˆ SQL æ—¶ä¼šè‡ªåŠ¨å˜æˆå°å†™æ¨¡å¼ï¼‰ // å‡å¦‚ä½ éœ€è¦æŒ‡å®šæŸä¸ªå­—æ®µä¸ºä¸»é”®ï¼Œå¯ä»¥å¦åŠ  tag `borm:pk` ID int64 Category string // å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»å‹ï¼ˆå®é™…æ•°æ®åº“æ˜¯ tinyintï¼ŒBORM ä¼šæ ¹æ®è‡ªå®šä¹‰ç±»å‹å®ç°çš„æ¥å£å®Œæˆè‡ªåŠ¨æ˜ å°„ï¼‰ // å¦å¤–ï¼Œä½¿ç”¨ `column:type` è¡¨ç¤ºå¯ä»¥è®© Model çš„å¯¹å¤–æš´éœ²çš„å­—æ®µåå’Œæ•°æ®åº“å®é™…å­—æ®µåä¸åŒ Kind consts.TemplateKind `borm:"column:type"` // è¿™é‡Œçš„ AdScale åœ¨æ•°æ®å®é™…ä¸Šæ˜¯ä¸ª JSON å­—ç¬¦ä¸²ï¼Œä½†ç”±äº *AdScale ç±»å‹å®ç°äº† BORM // æŒ‡å®šçš„æ¥å£ï¼Œä¾¿èƒ½å®ç°è‡ªåŠ¨ååºåˆ—åŒ–ï¼Œè¿™æ ·ä½ ä¸éœ€è¦åœ¨ä¸Šå±‚å·¦ä¸€ä¸ªåˆä¸€ä¸ª `json.Unmarshal` æ“ä½œ AdScale *AdScale `borm:"column:adscale" portal:"nested"` // ç”±äºé»˜è®¤çš„è‡ªåŠ¨è½¬æ¢å­—æ®µåçš„ç­–ç•¥ä¼šå°† LandURL è½¬æ¢æˆ land_urlï¼Œä¸å®é™…æ•°æ®åº“å­—æ®µåä¸ç¬¦ // è¿™é‡Œä¾ç„¶ç”¨ `column:landurl` è‡ªå®šä¹‰å­—æ®µå LandURL string `borm:"column:landurl"` DeepLinkURL string `borm:"column:deeplinkurl"` // ä¹‹æ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ bool ç±»å‹ï¼Œæ˜¯å› ä¸ºæ•°æ®åº“æ˜¯ tinyint // borm.Bool å®ç°äº†æŒ‡å®šæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥å®ç°è‡ªåŠ¨æ˜ å°„ IsDeleted borm.Bool // è¿™é‡Œä½¿ç”¨äº† `readonly` è¡¨æ˜æˆ‘ä»¬ä¸ç”¨å…³å¿ƒè¿™ä¸ªæ—¶é—´æˆ³çš„æ›´æ–°ï¼Œäº¤ç»™æ•°æ®åº“è‡ªåŠ¨æ›´æ–°å³å¯ CreatedAt time.Time `borm:"readonly"` UpdatedAt time.Time `borm:"readonly"`&#125;// TableName å‘Šè¯‰ BORM æŸ¥å“ªå¼ è¡¨func (m *MaterialModel) TableName() string &#123; return "material"&#125; ä¸‹é¢è¡¨æ¼”ä¸‹å¦‚ä½•é€šè¿‡å®ç°ç‰¹å®šæ¥å£å®Œæˆæ•°æ®åº“çš„ JSON å­—ç¬¦ä¸²ä¸è‡ªå®šä¹‰ç»“æ„ä½“ç±»å‹ä¹‹é—´çš„è½¬æ¢çš„ã€‚é€šè¿‡æŠŠè¿™ç§ä½çº§åˆ«çš„è½¬æ¢æ“ä½œæ”¾åœ¨ Model å±‚å®Œæˆï¼Œå¯ä»¥è®©ä¸šåŠ¡ä¸Šå±‚å†™èµ·æ¥æ›´çˆ½ï¼ 12345678910111213141516171819202122232425262728293031323334353637type AdScale struct &#123; Width int `json:"width"` Height int `json:"height"`&#125;func NewAdScale(w, h int) *AdScale &#123; return &amp;AdScale&#123;w, h&#125;&#125;// Value æ¥å£ä¼šåœ¨å†™å…¥æ•°æ®åº“æ—¶è°ƒç”¨ï¼Œåœ¨å®ç°è¯¥æ¥å£// æ—¶è°ƒç”¨äº† json.Marshal è½¬æ¢æˆäº† JSON å­—ç¬¦ä¸²// è¿™æ ·åœ¨ä¸šåŠ¡å±‚å°±å¯ä»¥å¿«å¿«ä¹ä¹ä½¿ç”¨ AdScale ç»“æ„ä½“// å¦‚æœéœ€è¦å­˜å‚¨ï¼ŒBORM ä¼šè‡ªåŠ¨è·å–è¿™é‡Œåºåˆ—åŒ–åçš„ç»“æœ// æ¢æˆ YAML éƒ½ä¸æ˜¯æ¢¦ï¼Œä¸Šå±‚å¯¹æ­¤æ— æ„ŸçŸ¥ï¼func (a *AdScale) Value() (interface&#123;&#125;, error) &#123; result, err := json.Marshal(a) if err != nil &#123; return nil, err &#125; return string(result), nil&#125;// SetValue ä¼šåœ¨è¯»å–æ•°æ®æ—¶è°ƒç”¨ï¼Œå½“å¤„ç†åˆ°è¯¥ç±»å‹æ—¶ï¼Œ// é€šè¿‡ `json.Unmarshal` è‡ªåŠ¨ååºåˆ—åŒ–æˆ AdScale ç±»å‹äº†// å¯¹äºä¸Šå±‚æ¥è¯´ä¾ç„¶æ˜¯é€æ˜çš„func (a *AdScale) SetValue(v interface&#123;&#125;) error &#123; jsonBody, ok := v.([]byte) if !ok &#123; return errors.New("models.material: expect []byte type") &#125; if len(jsonBody) != 0 &#123; return json.Unmarshal(jsonBody, &amp;a) &#125; else &#123; return nil &#125;&#125; å¯¹äº†ï¼Œè¿˜æœ‰èµ„æºçš„å…³è”å‘¢ï¼Ÿåœ¨ Python ä¸­æˆ‘ä»¬å¯ä»¥ç”¨å±æ€§çš„æ–¹å¼å®ç°ï¼Œåœ¨ Go ä¸­ä¾ç„¶å¯ä»¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œåªæ˜¯å†™æ³•ä¸å¤ªç›¸åŒè€Œå·²ï¼š 12345678910// Attributes æ˜¯å¹¿å‘Šç´ æå…³è”çš„ä¸€ç»„è‡ªå®šä¹‰ã€Œå±æ€§ã€// è¿™é‡Œå°±æ¶‰åŠåˆ°å¯¹å¦ä¸€å¼ å…³è”è¡¨çš„æŸ¥è¯¢func (m *MaterialModel) Attributes(ctx context.Context) []*AttributeModel &#123; var results []*AttributeModel err := borm.New().Filter("material_id", m.ID).OrderBy("created_at").All(ctx, &amp;results) if err != nil &#123; log.Errorf("models.material: failed to get attributes of material '%d': %s", m.ID, err) &#125; return results&#125; å½“ç„¶å•¦ï¼Œå¦‚æœæœ‰èµ„æºå…³è”çš„å±æ€§å€¼æ¥è‡ª RPCï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ Model å±‚ç¼–å†™ä¸€ä¸ªç±»ä¼¼ä¸Šé¢çš„å±æ€§ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨ Model å±‚ç»‘å®šèµ„æºçš„å…³è”æ•°æ®ï¼Œè¿™æ ·åœ¨ä¸šåŠ¡ä¸Šå±‚åªéœ€è¦ .Foo() å³å¯è·å–å…³è”èµ„æºã€‚ æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„ã€Œå±æ€§ã€å‡½æ•°æ¥æ”¶äº†ä¸€ä¸ª ctx å‚æ•°ï¼Œé‚£æ˜¯å› ä¸ºåœ¨è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æˆ–è€… RPC æœåŠ¡è°ƒç”¨æ—¶éœ€è¦ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬çš„ã€Œå±æ€§ã€å‡½æ•°å¹¶ä¸éœ€è¦ ctx å‚æ•°ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·è¿™æ ·ï¼š 12345// IsInPromotion æ˜¯å¦åœ¨ä¿ƒé”€ä¸­func (m *Model) IsInPromotion() bool &#123; now := time.Now().Unix() return now &gt;= m.PromotionStartsAt &amp;&amp; now &lt; m.PromotionEndsAt&#125; Controllerå…¶å®ƒé¡¹ç›®çš„å†™æ³•æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å…¶å®ƒé¡¹ç›®ä¸­æ˜¯å¦‚ä½•ç¼–å†™ Controller å±‚çš„ã€‚é¦–å…ˆçœ‹ä¸‹ç›®å½•ç»“æ„ï¼š 1234567controllerâ”œâ”€â”€ user.goâ”œâ”€â”€ implâ”‚ â”œâ”€â”€ user.goâ”‚ â””â”€â”€ user_test.goâ””â”€â”€ mock â””â”€â”€ user.go å…¶ä¸­åœ¨ controller/user.go ä¸­å®šä¹‰äº†è¯¥ Controller çš„æ¥å£ï¼Œè€Œåœ¨ mock ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ™æ˜¯ç”± mock å·¥å…·ç”Ÿæˆçš„æ–‡ä»¶ã€‚è€Œåœ¨ impl æ”¾ç½®çš„æ˜¯çœŸæ­£çš„å®ç°é€»è¾‘ï¼Œå†™æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021type UserControllerImpl struct &#123; userDao dao.UserDao&#125;var _ controller.UserController = (*UserControllerImpl)(nil)var DefaultUserController *UserControllerImplfunc init() &#123; DefaultUserController = NewUserController()&#125;func NewUserController() *UserControllerImpl &#123; return &amp;UserControllerImpl&#123; userDao: daoImpl.DefaultUserDao, &#125;&#125;func (c *UserControllerImpl) GetBar(ctx context.Context, uid int64) int64 &#123; return c.userDao.GetBar(ctx, uid)&#125; ä¹‹æ‰€ä»¥é‡‡ç”¨è¿™æ ·çš„ç›®å½•ç»“æ„å’Œå®ç°æ–¹æ³•ï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ Mock æ‰å…³é”®æ¥å£ã€‚ä½†é€šè¿‡åˆ†æè¿™äº›ä»£ç ï¼Œä¹Ÿå‘ç°äº†å‡ ä¸ªé—®é¢˜ï¼š Controller å±‚å¥½åƒä¹Ÿæ²¡å¹²å•¥ï¼Œè°ƒç”¨äº† Dao å±‚çš„æ¥å£ï¼Ÿ ä¸å¤ªç¬¦åˆ Go åœ£ç»ä¸­æ‰€å€¡å¯¼çš„æ–¹å¼ï¼Œæ¥å£å†™å¤ªå¤šäº† æ¯ä¸ª Controller éƒ½å¿…é¡»å†™ä¸€ä¸ªç»“æ„ä½“ï¼Ÿ ä½†æ˜¯ä¸ºäº†æ»¡è¶³ mock å·¥å…·è‹›åˆ»çš„ç”Ÿæˆæ¡ä»¶ï¼ˆæ€»æ˜¯åŸºäº interface ç”Ÿæˆï¼‰ï¼Œä¹Ÿä¸å¾—ä¸é‚£æ ·å®ç°ã€‚ä½†æˆ‘ä»¬åœ¨å®è·µä¸­ï¼Œæœ‰ä¸ªå•å…ƒæµ‹è¯•éœ€è¦å» Mock time.Now() å‡½æ•°ã€‚è¿™æ—¶å°±é‡åˆ°äº†é—®é¢˜ï¼Œè™½ç„¶å¯ä»¥åŸºäº time å†å®šä¹‰ä¸€ä¸ªç»“æ„ä½“æ¥ï¼Œå†å®šä¹‰ä¸‹æ¥å£ï¼Œè®© mock å·¥å…·ç”Ÿæˆ Mock ç‰ˆæœ¬ã€‚ä½†æ˜¯è¿™æ ·æ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒç¹çï¼Œä¸”å®¹æ˜“è®©ä»£ç è†¨èƒ€ã€‚æ˜æ˜å°±æ˜¯è¦è§£å†³ä¸€ä¸ªçœ‹èµ·æ¥å¹¶ä¸å¤æ‚çš„é—®é¢˜ï¼Œå´è¦å› ä¸ºå•å…ƒæµ‹è¯•å¼•å…¥é‚£ä¹ˆå¤šå•°å—¦çš„ä»£ç ã€‚å…¶å®æˆ‘ä»¬å¹¶ä¸å¸Œæœ›å› ä¸ºå•å…ƒæµ‹è¯•è€Œé€ æˆä¸šåŠ¡ä»£ç ä»¥æŸç§å¦¥åçš„æ–¹å¼å®ç°ã€‚åœ¨ç»è¿‡ä¸€ç•ªè°ƒç ”å’Œå®è·µåï¼Œæˆ‘ä»¬å‘ç°è¿è¡Œæ—¶ Mock ä¹Ÿæ˜¯èƒ½å¤Ÿåšåˆ°çš„ï¼ˆç»†èŠ‚ä¼šåœ¨è®²å•å…ƒæµ‹è¯•æ—¶è¯´æ˜ï¼‰ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸å¿…å†™å¾—å¦‚æ­¤å•°å—¦~ æˆ‘ä»¬çš„åšæ³•å¯¹äºæ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬ä¾ç„¶æ¨èä½ åœ¨ Controller å±‚å»å®ç°ï¼Œä½†æ˜¯ä¸ç”¨æ•™æ¡å¼åœ°å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå†å®šä¹‰ä¸€ä¸ªæ–¹æ³•ã€‚åŸºæœ¬åŸåˆ™å°±æ˜¯ï¼Œèƒ½æœ‰ç®€å•æ¸…æ™°æ˜äº†çš„å†™æ³•å³å¯ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021// UpdateMaterial åšä¸€æ¬¡å…¨é‡æ›´æ–°å§func UpdateMaterial(ctx context.Context, materialID int64, schema *MaterialSchema) (err error) &#123; material, err := GetMaterial(ctx, materialID) if err != nil &#123; return &#125; tx := borm.New().Begin(ctx) // ç´ ææ›´æ–°ï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤å— err = updateMaterial(ctx, tx, material, schema) // ç„¶åæ˜¯ç´ æçš„å±æ€§æ›´æ–°ï¼ˆä½†ç”±äºæ˜¯å…¨é‡ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œä¼šåˆ é™¤å…ˆå‰çš„å±æ€§ï¼Œç„¶åæ›¿æ¢æˆæ–°çš„ï¼‰ err = updateMaterialAttributes(ctx, tx, material, schema) if err != nil &#123; tx.Rollback(ctx) &#125; else &#123; tx.Commit(ctx) &#125; return nil&#125; ViewHandlerä¸ºäº†æ–¹ä¾¿ç¼–å†™ REST APIï¼Œå®ç°äº†ä¸€ä¸ªåŸºäº go-chi çš„è½»é‡çº§ API æ¡†æ¶ï¼Œå…¶åŸå‹å¯ä»¥å‚è€ƒ REST é¡¹ç›®ã€‚ REST å·¥å…·æä¾›äº†å¦‚ä¸‹ç‰¹æ€§ï¼š èƒ½å¤Ÿä»¥æ›´åŠ ä¼˜é›…ç®€æ´çš„æ–¹å¼åŸºäºä¸€ä¸ª ResourceHandler ç¼–å†™ GET/POST/PATCH/DELETE ç­‰æ–¹æ³• é‡‡ç”¨ return resp, err æ¨¡å¼æ›¿ä»£åŸå…ˆ RenderJSON/RenderError çš„æ–¹å¼ï¼š æ¡†æ¶å±‚å¯ä»¥è‡ªåŠ¨å»åŒ¹é…è°ƒç”¨ renderJSON æˆ–è€… renderError å†ä¹Ÿä¸æ€•åŸå…ˆè°ƒç”¨ RenderError ååˆå¿˜è®° return çš„é—®é¢˜äº† å¯ä»¥æ›´å¥½çš„æ”¯æŒè¿”å›é”™è¯¯ï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸ç”¨åˆ°å¤„ panic ä¸šåŠ¡é”™è¯¯ï¼Œç„¶ååœ¨ä¸Šå±‚åˆ recover å°è£…äº†ä¸€äº›å¸¸ç”¨çš„æ¥å£ï¼š é€šç”¨çš„åˆ†é¡µ Schema æ¸²æŸ“ å„ç§æ˜“ç”¨çš„å‚æ•°è·å–æ¥å£ æ¥ä¸‹æ¥ï¼Œçœ‹çœ‹ä¸€ä¸ªå…¸å‹çš„ REST API Handler å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103type MaterialsHandler struct &#123; rest.BaseHandler&#125;// Get è·å–ç´ æåˆ—è¡¨é¡µfunc (hd *MaterialsHandler) Get() (rest.Response, error) &#123; ctx := hd.R.Context() output, err := controllers.ListMaterials( ctx, hd.OffsetInt64(), hd.LimitInt64(), hd.QueryArgumentWithFallback("order_by", "-created_at")) if err != nil &#123; return nil, err &#125; var schemas []dump.MaterialSchema return rest.Pagination&#123; Context: ctx, Data: output.Materials, ToSchemaPtr: &amp;schemas, IsAdmin: true, Total: int(output.Total), &#125;, nil&#125;// Post æ–°å»ºå¹¿å‘Šç´ æfunc (hd *MaterialsHandler) Post() (rest.Response, error) &#123; var materialSchema load.MaterialSchema err := JSONArgs(hd.R, &amp;materialSchema) if err != nil &#123; return nil, err &#125; err = controllers.CreateMaterial(hd.R.Context(), &amp;materialSchema) if err != nil &#123; return nil, err &#125; return map[string]bool&#123;"success": true&#125;, nil&#125;type MaterialHandler struct &#123; rest.BaseHandler&#125;// Get è·å–æŸä¸ªå¹¿å‘Šç´ æè¯¦æƒ…func (hd *MaterialHandler) Get() (rest.Response, error) &#123; id, err := hd.getMaterialID() if err != nil &#123; return nil, err &#125; material, err := controllers.GetMaterial(hd.R.Context(), id) if err != nil &#123; return nil, err &#125; var schema dump.MaterialSchema err = portal.New().Dump(hd.R.Context(), material, &amp;schema) if err != nil &#123; log.Errorf("handlers.material.get: failed to dump material: %s", err) &#125; return schema, nil&#125;// Put æ›´æ–°ç´ æä¿¡æ¯func (hd *MaterialHandler) Put() (rest.Response, error) &#123; // å‚æ•°å¤„ç† materialID, err := hd.getMaterialID() if err != nil &#123; return nil, err &#125; var materialSchema load.MaterialSchema err = JSONArgs(hd.R, &amp;materialSchema) if err != nil &#123; return nil, err &#125; // æ›´æ–°é€»è¾‘äº¤ç»™ controller å®Œæˆ err = controllers.UpdateMaterial(hd.R.Context(), materialID, &amp;materialSchema) if err != nil &#123; return nil, err &#125; return map[string]bool&#123;"success": true&#125;, nil&#125;// Delete åˆ é™¤æŒ‡å®šç´ æfunc (hd *MaterialHandler) Delete() (rest.Response, error) &#123; id, err := hd.getMaterialID() if err != nil &#123; return nil, err &#125; err = controllers.DeleteMaterial(hd.R.Context(), id) if err != nil &#123; return nil, err &#125; return map[string]bool&#123;"success": true&#125;, nil&#125; SchemaPORTAL ç›®å‰å·²ç»å¼€æºï¼šhttps://github.com/ifaceless/portalï¼Œä»¥ä¸‹è¯´æ˜å·²ç»è¿‡æ—¶ï¼Œå¯ä»¥å‚è€ƒ è¿™ç¯‡æ–‡ç«  çš„ä»‹ç»äº†è§£æ›´å¤šç‰¹æ€§ï¼ æˆ‘ä»¬é€šå¸¸ä¼šåœ¨ Schema å±‚å®šä¹‰æ¥å£éœ€è¦çš„å­—æ®µåŠå…¶ç±»å‹ï¼Œå¹¶åœ¨è¿™å±‚å®Œæˆæ•°æ®èšåˆåï¼Œç”Ÿæˆ JSON æ ¼å¼çš„å†…å®¹åç»™å‰ç«¯ä½¿ç”¨ã€‚ç”±äºæ„Ÿå—åˆ° marshamllow å¼•å…¥åç»™æˆ‘ä»¬çš„ Python é¡¹ç›®å¸¦æ¥äº†è¯¸å¤šå¥½å¤„åï¼ˆå¦‚æ›´åŠ ä¸€è‡´æ¸…æ™°çš„ Schema å®šä¹‰æ–¹å¼ï¼‰ï¼Œå°±æ–—èƒ†å®ç°äº†ä¸€ä¸ª Go ç‰ˆæœ¬çš„ marshmallow å·¥å…· PORTALã€‚ä½† PORTAL å®é™…ä¸Šåªæ˜¯æ³¨é‡æ•°æ®çš„èšåˆï¼Œå› ä¸º Go ç¤¾åŒºå·²ç»æœ‰å¾ˆå¤šæˆç†Ÿçš„å·¥å…·å¯ä»¥å®ç° Schema Struct æ ¡éªŒäº†ï¼Œè‡ªç„¶ä¸ç”¨é‡å¤é€ è½®å­ã€‚ PORTAL çš„ä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š Schema æ”¯æŒç»„åˆï¼Œæé«˜ Schema å¤ç”¨æ€§ Schema å­—æ®µå€¼æ”¯æŒçµæ´»çš„å–å€¼æ–¹å¼ï¼ˆè”æƒ³ marshamallow ä¸­å¸¸ç”¨çš„æ–¹å¼ï¼‰ æ”¯æŒå¹¶å‘å¡«å……å­—æ®µï¼ˆå¦‚ä¸åŒçš„å­—æ®µå€¼å¯èƒ½æ¥æºäº RPC/æ•°æ®åº“ç­‰ï¼‰ å­—æ®µæ”¯æŒçµæ´»çš„ç±»å‹å®šä¹‰ï¼ŒPORTAL è´Ÿè´£å°è¯•ç±»å‹è½¬æ¢ æ”¯æŒå¯é€‰å­—æ®µæ¸²æŸ“ï¼ˆèµ‹å€¼ï¼‰ å°½å¯èƒ½å‡å°‘å†—ä½™ä¸”æ„šè ¢ä¸”ä¸åº”è¯¥è®©äººç±»æ¥å†™çš„ä»£ç ï¼ˆæœºæ¢°å¼èµ‹å€¼ï¼‰ï¼ˆè„‘è¡¥ä¸‹ç»™ä¸€ä¸ª Schema çš„åµŒå¥— List Schema å¡«å……å€¼è¦å†™å¾—å¤šä¹ˆå£®è§‚ï¼Œé‚£å¦‚æœå†åµŒå¥—æ¯”è¾ƒæ·±å‘¢ï¼Ÿï¼‰ï¼ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®šä¹‰ç”¨äºèšåˆæ•°æ®çš„ Schemaï¼š 12345678910111213141516171819202122232425// TrackSchema éŸ³é¢‘ä¿¡æ¯type TrackSchema struct &#123; ID string `json:"id"` Title string `json:"title"` // è¿™é‡Œæˆ‘ä»¬å¯¹å¤–çš„å­—æ®µåå®é™…æ˜¯ audioï¼Œä½†å¯¹åº”å–å€¼æ¥æº Model çš„ AudioURL Audio string `json:"audio,omitempty" portal:"attr:AudioURL"` AudioDuration int `json:"audio_duration" portal:"attr:Duration"` // è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„æ–¹æ³•å–å€¼ PlayedAt int `json:"played_at" portal:"meth:GetPlayedAt"` Description string `json:"description,omitempty" portal:"attr:Description.Description"`&#125;// GetPlayedAt è¿”å›ç”¨æˆ·æ’­æ”¾çš„è¿›åº¦func (*TrackSchema) GetPlayedAt(ctx context.Context, track interface&#123;&#125;) int &#123; return 90&#125;// SpeakerSchema ä¸»è®²äººä¿¡æ¯type SpeakerSchema struct &#123; // åµŒå¥—ä¸€ä¸ªå¯å¤ç”¨çš„ MemberSchema UserSchema // é¢å¤–ä¿¡æ¯ Role string `json:"role"`&#125; æ¥ä¸‹æ¥è¡¨æ¼”ä¸‹å¦‚ä½•ä½¿ç”¨ç±»ä¼¼ä¸Šé¢å®šä¹‰çš„ Schemaï¼š 123456789// ä» DB æŸ¥è¯¢å¾—åˆ° Model ç¤ºä¾‹var track models.Trackborm.New().FindByPK(ctx, &amp;track, pk)// è°ƒç”¨ Dump å³å¯å®Œæˆ Schema å­—æ®µæ•°æ®å¡«å……var trackSchema dump.TrackSchemaportal.New().Dump(ctx, &amp;track, &amp;trackSchema)// æ¥ä¸‹æ¥å°† trackSchema åºåˆ—åŒ–æˆ JSON è¿”å›å³å¯ å½“ç„¶ï¼Œè™½ç„¶å¼•å…¥ PORTAL å¯ä»¥è®©æˆ‘ä»¬æ›´åŠ èšç„¦ä¸šåŠ¡é€»è¾‘çš„ç¼–å†™ï¼Œå°½å¯èƒ½å‡å°‘å†—ä½™ä¸”æœºæ¢°çš„ä»£ç ï¼Œä½†ä¹Ÿç”±æ­¤å¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼š ä½¿ç”¨ reflect æœºåˆ¶å¸¦æ¥çš„æ€§èƒ½æŸè€—å°±çœ‹èƒ½ä¸èƒ½æ¥å— æœ‰äº›å› ä¸ºç±»å‹è½¬æ¢çš„ä¸æˆåŠŸçš„é—®é¢˜å¯èƒ½åˆ°è¿è¡Œæ—¶æ‰ä¼šå‘ç°ï¼Œæ’æŸ¥è¾ƒå›°éš¾ï¼ˆä½†å‡ºç°æƒ…å†µå¾ˆå°‘ï¼‰ æ‰€ä»¥ï¼Œè¿™è¿˜æ˜¯ä¸€ä¸ªéœ€è¦æƒè¡¡çš„åˆ©å¼Šåæ‰èƒ½è€ƒè™‘çš„æ–¹æ¡ˆï¼Œä½†ä¸ªäººè§‰å¾—å®ƒè¿˜æ˜¯æœ‰ä¸€å®šä»·å€¼çš„~ èŠèŠè·¯ç”±æ³¨å†Œè¯´åˆ°è·¯ç”±æ³¨å†Œï¼Œä¸ªäººè§‰å¾—å…¶å®ƒéƒ¨é—¨çš„ Go é¡¹ç›®é‡‡ç”¨çš„æ–¹å¼å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œä¸”ç›¸å¯¹æ¯”è¾ƒåˆ†æ•£ã€‚æ‰€ä»¥ï¼Œå°±ç»™ REST å·¥å…·å¼•å…¥äº†ç±»ä¼¼æˆ‘ä»¬åœ¨ä½¿ç”¨ Tornado æ—¶é‡‡ç”¨çš„é‚£ç§è·¯ç”±æ³¨å†Œæ–¹å¼ã€‚å› ä¸ºæ˜¯åŸºäº chi.Mux å°è£…çš„ Routerï¼Œæ‰€ä»¥å®Œå…¨å…¼å®¹åŸå…ˆçš„æ¥å£ã€‚ å¯¹äºæ¯”è¾ƒç®€å•çš„è·¯ç”±ï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„æ³¨å†Œæ–¹å¼ï¼š 1r.MountHandler("/hello", &amp;hello.DemoHandler&#123;&#125;) è€Œå¯¹äº API è¾ƒå¤šçš„é‚£ç§é¡¹ç›®ï¼Œæ¨èçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123routersâ”œâ”€â”€ router.goâ””â”€â”€ urls.go åœ¨ router.go ä¸­ç¼–å†™ Router åˆå§‹åŒ–çš„ä»£ç ï¼ŒåŒ…æ‹¬ä¸­é—´ä»¶é…ç½®å’Œè·¯ç”±æ³¨å†Œï¼š 12345678910// NewRouter web è·¯ç”±å®ä¾‹åˆ›å»ºfunc NewRouter() Router &#123; r := rest.NewRouter() // æ³¨å†Œå„ç§éœ€è¦çš„ä¸­é—´ä»¶ r.Use(FooMiddleware) r.MountHandlers(handlers) return r&#125; æ¥ä¸‹æ¥åœ¨ urls.go ä¸­å®šä¹‰ URL å’Œ Handler çš„æ˜ å°„ï¼š 1234var handlers = map[string]rest.Handler&#123; "/tasks": &amp;task.TasksHandler&#123;&#125;, "/tasks/&#123;id:(\\d+)&#125;": &amp;task.TaskHandler&#123;&#125;,&#125; å•å…ƒæµ‹è¯•å¾ˆé‡è¦å…ˆè¯´ç»“è®ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº† gomonkey å®ç°è¿è¡Œæ—¶ Monkey Patchã€‚è¿™æ ·æˆ‘ä»¬çš„ Controller/Handler/RPC ç­‰å±‚æ— éœ€å†™å¾—ç‰¹åˆ«å•°å—¦ã€‚ å¦‚æœæƒ³çŸ¥é“å…¶å·¥ä½œåŸç†çš„è¯ï¼Œå¯ä»¥å‚è€ƒ monkey é¡¹ç›®å’Œ Monkey Patching in Goã€‚å½“ç„¶ï¼Œä¸‹é¢å‡ ç¯‡å’Œå•å…ƒæµ‹è¯•æœ‰å…³çš„æ–‡ç« ä¹Ÿå¯ä»¥çœ‹çœ‹ï¼š GoConveyæ¡†æ¶ä½¿ç”¨æŒ‡å— Monkey æ¡†æ¶ä½¿ç”¨æŒ‡å— GoStub æ¡†æ¶ä½¿ç”¨æŒ‡å— GoMock æ¡†æ¶ä½¿ç”¨æŒ‡å— gomonkey 1.0 æ­£å¼å‘å¸ƒï¼ æ­¤å¤–ï¼Œè¿˜æœ‰ä¸ªç”¨äºåˆå§‹åŒ–æµ‹è¯•æ•°æ®çš„å·¥å…·ä¹Ÿå¾ˆæœ‰å¸®åŠ©ï¼Œè¯¦ç»†å¯ä»¥å‚è§ Fixture é¡¹ç›®ã€‚ Panic è¿˜æ˜¯ç›´æ¥è¿”å› Errorå¯¹äºä¸šåŠ¡å¼‚å¸¸æ¥è¯´ï¼Œç›¸å¯¹ç³»ç»Ÿçº§é”™è¯¯ç­‰ä¸¥é‡é”™è¯¯å‘ç”Ÿåœ°æ›´åŠ é¢‘ç¹ï¼Œè¿™æ ·ä¸€æ¥é¢‘ç¹åœ° Panic/Recover ä¼šå¸¦æ¥ä¸€äº›é¢å¤–å¼€é”€ã€‚æ­¤å¤–ï¼Œæ— è„‘åœ°å¯¹ä»»ä½•ä¸šåŠ¡å¼‚å¸¸éƒ½é‡‡å– Panic çš„å¼æ–¹ï¼ŒçœŸçš„å¥½å—ï¼Ÿä¸è¿‡çœ‹èµ·æ¥å…¶å®ƒç»„çš„é¡¹ç›®çš„ç¡®å¾ˆä¹æ„é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚ ä½†ä¸ªäººæ¨èçš„æ–¹å¼æ˜¯å¯¹äºä¸šåŠ¡é”™è¯¯ï¼Œä¾ç„¶é‡‡ç”¨ Go ä¸­å…¸å‹çš„æ–¹å¼ï¼šè¿”å›é”™è¯¯ï¼å¦‚æœæ˜¯æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯ï¼ˆå¦‚ç½‘ç»œä¸­æ–­ç­‰ï¼‰ï¼Œåˆ™å¯ä»¥è¿›è¡Œ Panicï¼Œç„¶ååœ¨ä¸Šå±‚æ•è·ã€‚ 12345678910111213// DeleteMaterial åˆ é™¤ç´ æfunc DeleteMaterial(ctx context.Context, materialID int64) error &#123; material, err := GetMaterial(ctx, materialID) if err != nil &#123; return err &#125; err = borm.New().Model(&amp;material).Update(ctx, "is_deleted", true) if err != nil &#123; log.Errorf("controllers.material.DeleteMaterial: failed to update: %s", err) &#125; return err&#125; æšä¸¾å®šä¹‰æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰å®Œæšä¸¾åï¼Œéƒ½å¸Œæœ›èƒ½å¤Ÿæ ¹æ®ç»™å®šçš„å€¼è·å¾—å¯¹åº”çš„æšä¸¾å˜é‡ï¼Œæˆ–è€…å¾—åˆ°æšä¸¾å˜é‡åæ˜ å°„çš„åç§°ã€‚è¿™é‡Œç»™å‡ºä¸€ç§å¯è¡Œçš„å®šä¹‰æ–¹å¼ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041// AuditStatus å®¡æ ¸çŠ¶æ€type AuditStatus int// å®šä¹‰ä¸‰ç§å®¡æ ¸çŠ¶æ€const ( AuditAwaiting AuditStatus = iota AuditPassed AuditRefused)// auditStatusNames å®šä¹‰æ¯ç§æšä¸¾çŠ¶æ€å¯¹åº”çš„åç§°var auditStatusNames = []string&#123; "awaiting", "passed", "refused",&#125;func (s AuditStatus) String() string &#123; return auditStatusNames[s]&#125;// AuditStatusByName å¯ä»¥æ ¹æ®åç§°æ˜ å°„å¾—åˆ°æšä¸¾å˜é‡func AuditStatusByName(name string) AuditStatus &#123; for i, v := range auditStatusNames &#123; if v == name &#123; return AuditStatus(i) &#125; &#125; panic(fmt.Sprintf("audit status name not found: '%s'", name))&#125;// Value å®ç°çš„æ˜¯ BORM æŒ‡å®šçš„æ¥å£ï¼Œå®Œæˆå’Œæ•°æ®åº“ç±»å‹ï¼ˆtinyintï¼‰æ˜ å°„ï¼ˆå†™å…¥ï¼‰func (s *AuditStatus) Value() (interface&#123;&#125;, error) &#123; return int(*s), nil&#125;// SetValue å®ç°çš„æ˜¯ BORM æŒ‡å®šçš„æ¥å£ï¼Œå®Œæˆå’Œæ•°æ®åº“ç±»å‹ï¼ˆtinyintï¼‰æ˜ å°„ï¼ˆè¯»å–ï¼‰func (s *AuditStatus) SetValue(v interface&#123;&#125;) error &#123; *s = AuditStatus(cast.ToInt(v)) return nil&#125;]]></content>
      <categories>
        <category>Web å¼€å‘</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go è¯­è¨€ç¼–å†™ RESTful API çš„ä¸€äº›æ€è€ƒ]]></title>
    <url>%2F2018%2F12%2F02%2Fthoughts-about-writing-restful-api-in-go%2F</url>
    <content type="text"><![CDATA[å¼•è¨€è¿‘æ¥å®è·µäº†ä¸‹ Go Web å¼€å‘ï¼Œä¹Ÿä¸€å¹¶åšäº†äº› Web å¼€å‘ç›¸å…³çš„æ•ˆç‡å·¥å…·ï¼Œç›®çš„ä¹Ÿæ˜¯ä¸ºäº†æå‡å¼€å‘ä½“éªŒï¼Œè¿›è€Œæ”¹å–„é¡¹ç›®è´¨é‡å’Œæé«˜å¼€å‘æ•ˆç‡ã€‚ ä¹‹å‰åœ¨ä½¿ç”¨ Python åš Web é¡¹ç›®æ—¶ï¼Œæ¯”è¾ƒä¹ æƒ¯åŸºäºç±»çš„æ–¹å¼ä¸ºæŸä¸ªèµ„æºæä¾› RESTful æ¥å£ã€‚å’Œé‡‡ç”¨çº¯å‡½æ•°çš„æ–¹å¼ä¸åŒï¼ŒåŸºäºç±»çš„æ–¹å¼å¯ä»¥ä½¿å¾—èµ„æºç®¡ç†æ›´æ¸…æ™°ï¼Œå½“é€»è¾‘ä»£ç è¾ƒå¤šæ—¶ï¼Œä»£ç ç»“æ„ä¹Ÿä¸è‡³äºå¤ªæ··ä¹±ã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨ Go è¯­è¨€å®è·µæ—¶ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨ç±»ä¼¼ ResourceHandler çš„ç»“æ„ä½“çš„æ–¹å¼æ¥æ›¿ä»£ç±»ï¼Œå¹¶ç»™è¯¥ç»“æ„ä½“ç»‘å®šç›¸åº”çš„ GET/POST/DELETE/PUT/PATCH æ–¹æ³•ï¼Œç”¨ä»¥å’Œ HTTP ç›¸åº”çš„è¯·æ±‚æ–¹æ³•åŒ¹é…ã€‚ é‡åˆ°çš„é—®é¢˜æˆ‘ä»¬ä½¿ç”¨çš„ Web æ¡†æ¶æ˜¯åŸºäº go-chi/chi å°è£…çš„ï¼Œè¿™ä¸ªæ¡†æ¶æœ¬èº«çš„ç‰¹ç‚¹å°±æ˜¯ç®€å•ï¼Œä¸ Go æ ‡å‡†åº“ http æ— ç¼è¡”æ¥ã€‚ä¸»è¦ç”¨å®ƒæ¥åšè·¯ç”±åˆ†å‘ï¼Œæ–¹ä¾¿ç¼–å†™ HTTP APIã€‚ ä½†åœ¨å®è·µä¸­ï¼Œè·¯ç”±æ³¨å†Œé‚£å—æ„Ÿè§‰å¾ˆç¹çã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å…ˆå‰çš„å†™æ³•å¤§è‡´æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š 1234567r := chi.NewRouter()hd := NewTasksHandler()r.Get("/tasks/&#123;task_id:(\\d+)&#125;", hd.Get)r.Post("/tasks/&#123;task_id:(\\d+)&#125;", hd.Post)r.Delete("/tasks/&#123;task_id:(\\d+)", hd.Delete&#125; æ˜¾ç„¶ï¼Œä¸Šé¢çš„å†™æ³•æœ‰ç‚¹å•°å—¦ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚æ¯”å¦‚åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°±å¯èƒ½ä¼šå› ä¸ºç–å¿½å¤§æ„ï¼Œç»™ test server ç»‘å®šçš„è·¯ç”±å’Œå®é™…çš„ä¸åŒï¼ˆåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼‰ã€‚æ‰€ä»¥å°±å¸Œæœ›èƒ½æœ‰ä¸€ç§ç®€å•çš„æ–¹å¼æ³¨å†Œè·¯ç”±ï¼Œå¹¶ä¸”è®©ç¨‹åºè‡ªå·±æ ¹æ®è¯·æ±‚çš„ Method åˆ†å‘åˆ° Handler å¯¹åº”çš„æ–¹æ³•ä¸Šã€‚ æ—¢ç„¶é‡åˆ°é—®é¢˜ï¼Œé‚£å°±å¾—æƒ³ä¸ªä¼˜é›…çš„æ–¹æ³•è§£å†³ï¼Œå°½å¯èƒ½ä¿è¯æ€§èƒ½æŸè€—ä¸å¤§ï¼Œä½†åˆèƒ½å¸¦æ¥è¾ƒå¥½çš„å¼€å‘ä½“éªŒã€‚äºæ˜¯ä¹ï¼Œrest åŒ…è¯ç”Ÿäº†ã€‚ è¯´è¯´ REST åŒ…rest åŒ…çš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å¯¹ go-chi/chi æ¡†æ¶åšäº†ç®€å•çš„åŒ…è£…ï¼Œå®ç°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ BaseHandler å®ç°è¯·æ±‚åˆ†å‘åˆ°æ‰€è°“çš„ã€Œå­ç±»ã€ç»“æ„ä½“å¯¹åº”çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ç”±äºå¹¶ä¸ä¼šè¿›è¡Œç±»å‹æ–­è¨€æˆ–è€…ä½¿ç”¨åå°„ï¼Œæ‰€ä»¥å¸¦æ¥çš„æ€§èƒ½å¼€é”€ä¸ä¼šå¾ˆé«˜ã€‚ é‚£ä¹ˆï¼Œåœ¨æœ‰äº† rest åŒ…åï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒå‘¢ï¼Ÿ ä½¿ç”¨ç¤ºä¾‹å‡å¦‚æˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªä»»åŠ¡ç®¡ç†æœåŠ¡ï¼Œéœ€è¦æä¾›çš„æ¥å£å¦‚ä¸‹ï¼š åŠŸèƒ½ æ–¹æ³• URL ç¤ºä¾‹ è·å–ä»»åŠ¡åˆ—è¡¨ GET /tasks æ–°å»ºä»»åŠ¡ POST /tasks è·å–å•ä¸ªä»»åŠ¡ GET /tasks/1 åˆ é™¤å•ä¸ªä»»åŠ¡ DELETE /tasks/1 åœ¨ rest çš„åŠ©æ”»ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥å†™ï¼š 123456789101112131415161718192021222324252627282930func main() &#123; r := rest.NewRouter() r.MountHandler("/tasks", &amp;TasksHandler&#123;&#125;) r.MountHandler("/tasks/&#123;task_id:(\\d+)&#125;", &amp;TaskHandler&#123;&#125;) rest.Run(r, 8000)&#125;type TasksHandler struct &#123; rest.BaseHandler&#125;func (hd *TasksHandler) Get() &#123; hd.RenderJSON(map[string]string&#123;"message": "Get Tasks"&#125;)&#125;func (hd *TasksHandler) Post() &#123; hd.RenderJSON(map[string]string&#123;"message": "Create Task"&#125;)&#125;type TaskHandler struct &#123; rest.BaseHandler&#125;func (hd *TaskHandler) Get() &#123; hd.RenderJSON(map[string]string&#123;"message": "GET Task"&#125;)&#125;func (hd *TaskHandler) Delete() &#123; hd.RenderJSON(map[string]string&#123;"message": "Delete Task"&#125;)&#125; é¡¹ç›®ç»“æ„è¿™ä¸ªé¡¹ç›®ç»“æ„ä»…ä¾›å‚è€ƒï¼Œä¹Ÿæ²¡å•¥ç‰¹åˆ«çš„ï¼š 123456789101112131415161718192021222324252627282930.â”œâ”€â”€ Gopkg.lock (dep åŒ…ç®¡ç†ä½¿ç”¨ï¼Œé”å®šç‰ˆæœ¬)â”œâ”€â”€ Gopkg.toml (dep åŒ…ç®¡ç†ä½¿ç”¨)â”œâ”€â”€ Makefile (ä¸€äº›ç¯å¢ƒå‡†å¤‡å‘½ä»¤ç­‰)â”œâ”€â”€ README.md (é¡¹ç›®ç®€ä»‹)â”œâ”€â”€ binâ”‚ â”œâ”€â”€ web (Web æœåŠ¡äºŒè¿›åˆ¶ç¨‹åºï¼Œå•ä¸ªæ–‡ä»¶å³å¯è¿è¡Œ)â”œâ”€â”€ cmdâ”‚ â””â”€â”€ web (Web æœåŠ¡çš„å…¥å£)â”‚ â””â”€â”€ main.goâ”œâ”€â”€ pkgâ”‚ â”œâ”€â”€ configs (é¡¹ç›®èµ„æºé…ç½®ï¼Œé€šè¿‡èµ„æºå‘ç°è·å–)â”‚ â”œâ”€â”€ constsâ”‚ â”‚ â”œâ”€â”€ enum.go (å®šä¹‰ä¸€äº›æšä¸¾ç±»å‹)â”‚ â”‚ â””â”€â”€ macro.go (å®šä¹‰ä¸€äº›å¸¸é‡)â”‚ â”œâ”€â”€ controllers (æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘)â”‚ â”œâ”€â”€ errs (ä¸šåŠ¡é”™è¯¯å®šä¹‰ï¼Œæ”¾åœ¨ä¸€å—ç»´æŠ¤)â”‚ â”œâ”€â”€ middlewares (ä¸šåŠ¡è‡ªå®šä¹‰ä¸­é—´ä»¶)â”‚ â”œâ”€â”€ models (é¡¾åæ€ä¹‰ï¼ŒORM Model å±‚)â”‚ â”œâ”€â”€ rpcs (ä¾èµ–çš„ç¬¬ä¸‰æ–¹æœåŠ¡)â”‚ â”œâ”€â”€ utils (å¸¸ç”¨çš„å°å·¥å…·)â”‚ â””â”€â”€ webâ”‚ â”œâ”€â”€ handlers (å¤„ç†è¯·æ±‚çš„ handlers å®ç°)â”‚ â”œâ”€â”€ schemas (å®šä¹‰èšåˆæ•°æ®çš„ API Schema)â”‚ â””â”€â”€ router.go (è·¯ç”±æ³¨å†Œ)â”œâ”€â”€ scripts (ä¸€äº›è„šæœ¬)â”œâ”€â”€ testdata (æ”¾å•å…ƒæµ‹è¯•éœ€è¦çš„ Mock æ•°æ®)â”‚ â”œâ”€â”€ fixtures (æµ‹è¯•æ•°æ®ï¼Œç”¨äºå¯¼å…¥æµ‹è¯•åº“)â”‚ â”‚ â””â”€â”€ foo.ymlâ””â”€â”€ vendor (ä¸€äº›ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ï¼Œå› ä¸ºæœ‰å¢™ğŸ˜­ï¼Œæ‰€ä»¥å¾—å­˜ä¸‹æ¥é¿å…éƒ¨ç½²æ—¶å› ä¸ºç½‘ç»œç­‰å¤ªä¹…) æ€»ç»“æ€ä¹ˆæ ·ï¼Œæ–°çš„è·¯ç”±æ³¨å†Œæ–¹å¼æ˜¯ä¸æ˜¯æ›´åŠ ç®€å•äº†ï¼Ÿå…¶å®è¿™æ­£æ˜¯å€Ÿé‰´äº† Python Tornado çš„ä¸€äº›æ€æƒ³ã€‚æˆ‘ä¸è®¤ä¸ºè¿™ç§åšæ³•æ˜¯æ‰€è°“çš„åæ¨¡å¼ï¼Œæˆ–è€…ä¸ç¬¦åˆ Go çš„é£æ ¼ï¼ˆæ¬¢è¿æ¥å–·ï¼‰ã€‚å…¶å®è¿™å‹æ ¹å’Œè¯­è¨€æ— å…³ï¼Œä¸ºä»€ä¹ˆä¸æ„¿æ„å»å®è·µä¸€äº›èƒ½å¤Ÿæ”¹å–„å¼€å‘ä½“éªŒçš„æ–°æ–¹æ³•å‘¢ï¼Ÿå†µä¸”è¿˜èƒ½å¤Ÿå‡å°‘çŠ¯é”™ï¼]]></content>
      <categories>
        <category>Web å¼€å‘</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>RESTful</tag>
        <tag>Web</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[TiDB å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰]]></title>
    <url>%2F2018%2F12%2F02%2Ftidb-academy-learning-notes-part-two%2F</url>
    <content type="text"><![CDATA[å¼•è¨€TiDB Academy æä¾›äº† TiDB çš„è§†é¢‘å­¦ä¹ èµ„æºï¼Œæ–¹ä¾¿äº†è§£è¿™ä¸ªå…¨æ–°çš„æ•°æ®åº“ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œåšäº†è¿™ä¸ªç³»åˆ—çš„ç¬”è®°ï¼Œæ–¹ä¾¿åæœŸå›é¡¾ã€‚ TiDB å¹³å° è™½è¯´ TiDB åœ¨ä¸Šå±‚å®ç°äº† MySQL åè®®ï¼Œä½†å¹¶ä¸ä»£è¡¨å®ƒä»¬ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æºç ã€‚ä¹‹æ‰€å«åš TiDB å¹³å°ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ç”±ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†æ„æˆï¼š TiKV: å…¼å®¹ ACID çš„å­˜å‚¨å±‚ æ”¯æŒåˆ†å¸ƒå¼ Key Value å­˜å‚¨ æ”¯æŒæ¨ªå‘æ‰©å±•ã€åŸç”Ÿå¤šå‰¯æœ¬æœºåˆ¶ä¿è¯é«˜å¯ç”¨ è‡ªåŠ¨åŸºäºèŒƒå›´åˆ†åŒºï¼Œæ¯ä¸ªèŒƒå›´éƒ½ç§°ä¸ºä¸€ä¸ª Regionã€‚Region ä¼šæ ¹æ®éœ€è¦è‡ªåŠ¨è°ƒæ•´ï¼Œé»˜è®¤æœ€å¤§ä¸º 96MB æ¯ä¸ª Region é»˜è®¤æœ‰ä¸‰åˆ†æ‹·è´ï¼Œä½¿ç”¨ Raft ä¿è¯ä¸€è‡´æ€§ å½“ç„¶ï¼Œå®é™…ä¸Š TiKV ä¹Ÿå¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œå¹¶ç›´æ¥ä½¿ç”¨å®ƒçš„ KV API è®¿é—®æ•°æ® TiDB: æ”¯æŒ MySQL åè®®ï¼Œè‡ªåŠ¨è½¬æ¢æˆåˆ†å¸ƒå¼è¯·æ±‚åˆ° TiKV æ— çŠ¶æ€ã€ä¸å­˜å‚¨æ•°æ® æ˜“äºæ°´å¹³æ‰©å±•ï¼Œé«˜å¯ç”¨ ç±»ä¼¼ä¸€ä¸ª Translatorï¼Œä½†æ˜¯è¿™é‡Œé¢çš„ååŒå¤„ç†å¾ˆæœ‰æ„æ€ Placement Driver (PD): é›†ç¾¤ç®¡ç†å™¨ï¼Œå°±æ˜¯æ•´ä¸ªå¹³å°çš„å¤§è„‘ ç®¡ç† TiKV Region è´Ÿè½½å‡è¡¡ï¼ˆæ¯”å¦‚çƒ­ç‚¹æ£€æŸ¥ã€Region åˆå¹¶ï¼‰ å…ƒæ•°æ®ç®¡ç†ï¼ˆå¦‚ SQL DDLï¼‰ æ—¶é—´åŒæ­¥ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸­å¾ˆå…³é”®çš„ä¸€ç‚¹å°±æ˜¯å‡†ç¡®çš„æ—¶é—´ï¼‰ å¯é€‰ç»„ä»¶ï¼šTiSpark: è¶Šè¿‡ SQL å±‚ï¼Œè®© Apache Spark ç›´æ¥ä¸ TiKV è¿æ¥ æ–¹ä¾¿æ‰§è¡Œå¤æ‚çš„ OLAP æŸ¥è¯¢ã€æœºå™¨å­¦ä¹ ä»»åŠ¡ ä» TiDB å¹³å°è¿™ç§ç»„ä»¶åŒ–çš„æ¶æ„è®¾è®¡å¯ä»¥çœ‹åˆ°ï¼Œä½ å¯ä»¥ç›´æ¥é€šè¿‡ä¸åŒçš„æ–¹å¼ï¼ˆSparkã€MySQL åè®®ã€Key-Value API ç­‰ï¼‰è®¿é—®åŒæ ·çš„æ•°æ®ï¼ˆä½äº TiKV ä¸­ï¼‰ï¼Œè€Œæ— éœ€èµ°ä¼ ç»Ÿçš„ ETL (Extract-Transform-Load) é‚£å¥—ã€‚ æœ‰äº† TiDB å¹³å°ï¼Œå°±å¯ä»¥åŒæ—¶æ”¯æŒ OLAP å’Œ OLTP åœºæ™¯äº†ï¼ˆä¼ è¯´ä¸­çš„æ··åˆæ¨¡å¼ HATPï¼‰ã€‚è¿™æ ·ï¼ŒåŸå…ˆæˆ‘ä»¬ç”¨ MySQL åº”ä»˜ OLTP åœºæ™¯ï¼Œç”¨ Hadoop, HBase æˆ–è€… Cassandra ç­‰åº”ä»˜ OLAP åœºæ™¯ï¼Œéƒ½å¯ä»¥åœ¨ TiDB è¿™ä¸€ä¸ªå¹³å°å®Œæˆï¼Œä»è€Œç®€åŒ–è®¾è®¡å’Œç»´æŠ¤å·¥ä½œï¼ˆçœŸçš„å—ï¼Ÿï¼‰ã€‚ KOST æŠ€æœ¯æ ˆKOST æ˜¯æŒ‡ï¼šKubernetes, Operator, Spark å’Œ TiDBã€‚K8S å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸€æ­¥åˆ°ä½æå®š TiDB å¹³å°éƒ¨ç½²ã€‚ åœ¨ GKE ä¸Šéƒ¨ç½² TiDBç›´æ¥çœ‹è¿™ä¸ªéƒ¨ç½²æ•™ç¨‹ã€‚ ä¸€äº›æç¤ºï¼š 1234567891011121314151. Watch tidb-cluster up and running watch kubectl get pods --namespace tidb -l app.kubernetes.io/instance=tidb -o wide2. List services in the tidb-cluster kubectl get services --namespace tidb -l app.kubernetes.io/instance=tidb3. Wait until tidb-initializer pod becomes completed watch kubectl get po --namespace tidb -l app.kubernetes.io/component=tidb-initializer4. Get the TiDB password PASSWORD=$(kubectl get secret -n tidb demo-tidb -o jsonpath="&#123;.data.password&#125;" | base64 -d | awk '&#123;print $6&#125;') echo $&#123;PASSWORD&#125;5. Access tidb-cluster using the MySQL client kubectl port-forward -n tidb svc/demo-tidb 4000:4000 &amp; mysql -h 127.0.0.1 -P 4000 -u root -D test -p6. View monitor dashboard for TiDB cluster kubectl port-forward -n tidb svc/demo-grafana 3000:3000 Open browser at http://localhost:3000. The default username and password is admin/admin. ä½¿ç”¨ MySQL å®¢æˆ·ç«¯è¿æ¥ï¼š 12345kubectl run -n tidb mysql-client --rm \ -i --tty --image mysql -- mysql \ -P 4000 -u root -h $(kubectl get \ svc demo-tidb -n tidb --output \ json | jq -r &apos;.spec.clusterIP&apos;) æˆ–è€…å»ºç«‹éš§é“ï¼š 1234567kubectl -n tidb port-forward \ demo-tidb-0 4000:4000 &amp;&gt;/dev/null \ &amp;sudo apt-get install -y mysql-client \ &amp;&amp;mysql -h 127.0.0.1 -u root -P 4000 è²Œä¼¼ç°åœ¨æ ¹æœ¬è¿æ¥ä¸ä¸Šäº†ï¼Œæ€»æ˜¯æç¤ºéœ€è¦å¯†ç ï¼Œä½†æ˜¯é»˜è®¤ä¸æ˜¯ä¸éœ€è¦å¯†ç çš„å—ï¼Ÿçœ‹æ¥éœ€è¦é‡å»ºé›†ç¾¤ï¼Œç„¶åé¦–æ¬¡è¿›å…¥å°±è®¾ç½®å¥½å¯†ç ã€‚ç”¨æˆ·ç®¡ç†å‚è€ƒï¼šTiDB User Account Management]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>TiDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[TiDB å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰]]></title>
    <url>%2F2018%2F12%2F02%2Ftidb-academy-learning-notes-part-one%2F</url>
    <content type="text"><![CDATA[å¼•è¨€TiDB Academy æä¾›äº† TiDB çš„è§†é¢‘å­¦ä¹ èµ„æºï¼Œæ–¹ä¾¿äº†è§£è¿™ä¸ªå…¨æ–°çš„æ•°æ®åº“ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œåšäº†è¿™ä¸ªç³»åˆ—çš„ç¬”è®°ï¼Œæ–¹ä¾¿åæœŸå›é¡¾ã€‚ è¯¾ç¨‹æ¦‚è¦è¿™ä¸ªç³»åˆ—è¯¾ç¨‹æ˜¯ä¸º MySQL DBA å‡†å¤‡çš„é«˜çº§è¯¾ç¨‹ã€‚è®²å¸ˆä¹Ÿå‡è®¾å­¦ä¹ è€…æ‹¥æœ‰ 3~5 å¹´çš„ MySQL è¿ç»´å’Œä½¿ç”¨ç»éªŒã€‚å› ä¸ºåœ¨è®²è§£çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°† TiDB çš„ä¸€äº›æ¦‚å¿µç›´æ¥å’Œ MySQL å¯¹æ¯”ï¼ˆè™½ç„¶å¹¶ä¸æ˜¯ MySQL DBAï¼Œä½†ä¸èƒ½é˜»æŒ¡æˆ‘å­¦ä¹ çš„è„šæ­¥~ï¼‰ã€‚ æˆ‘ä»¬å°†åœ¨è¿™ä¸ªç³»åˆ—è¯¾ç¨‹ä¸­å­¦ä¹ åˆ°å¾ˆå¤šå…³äºå¦‚ä½•è®¾è®¡å’Œå®ç°ä¸€ä¸ªç±»ä¼¼ TiDB è¿™æ ·å¤æ‚çš„åˆ†å¸ƒå¼æ•°æ®åº“çš„ç»†èŠ‚ã€‚æ€»çš„æ¥è¯´ï¼Œå°†ä¼šæ¶µç›–å¦‚ä¸‹å‡ ä¸ªè¯é¢˜ï¼š TiDB çš„æ¶æ„è®¾è®¡ï¼ˆOLTP/OLAP æ”¯æŒï¼‰ï¼Ÿ å¦‚ä½•åšåˆ°æ°´å¹³æ‰©å±•ï¼ŒåŒæ—¶ä¿æŒæ•°æ®å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨çš„ï¼Ÿ åœ¨çº¿ DDL ç®—æ³•å’Œå®ç° è¯¾å‰å‡†å¤‡ä¸ºäº†è·Ÿç€æ•™ç¨‹ä¸€æ­¥æ­¥å­¦ä¹ ï¼Œè‡ªç„¶æ˜¯éœ€è¦æœ‰ä¸ªç¯å¢ƒå¯ä»¥éƒ¨ç½² TiDB çš„å’¯ã€‚Google Cloud Platform é¦–æ¬¡ä½¿ç”¨ï¼Œç¬¬ä¸€å¹´å…è´¹èµ é€ $300ã€‚åªéœ€è¦ä¸€å¼  Visa ä¿¡ç”¨å¡ç»‘å®šå°±å¯ä»¥äº†ã€‚ åˆ†å¸ƒå¼æ•°æ®åº“ä»‹ç» 20 ä¸–çºª 60 å¹´ä»£ï¼Œç¬¬ä¸€ä»£æ•°æ®åº“è¯ç”Ÿã€‚ä¸»è¦ç‰¹ç‚¹ï¼š éå…³ç³»å‹ è®¿é—®å­˜å‚¨è®°å½•çš„è¯­è¨€ä¸ç»Ÿä¸€ï¼Œä¸å­˜å‚¨æ ¼å¼ç´§å¯†å…³è” 20 ä¸–çºª 70 å¹´ä»£ï¼Œå…³ç³»æ¨¡å‹å’Œ SQL è¯ç”Ÿ 20 ä¸–çºª 70 å¹´ä»£åˆ° 21 ä¸–çºªåˆï¼ŒåŸºäº SQL çš„å…³ç³»å‹æ•°æ®å æ®ç»Ÿæ²»åœ°ä½ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š æ•°æ®åº“å‚å•†å¾ˆå¤šï¼Œå‡æ”¯æŒ SQL å­˜å‚¨è¿‡ç¨‹è¯­è¨€å¾ˆå¤šï¼Œä¸”ç§»æ¤æ€§å¾ˆå·® é¢å‘å•æœºè®¾è®¡ 2000 å¹´ä¸­æœŸï¼ŒNoSQL æ•°æ®åº“è¯ç”Ÿã€‚ä¸»è¦ç‰¹ç‚¹ï¼š æ‰©å±•æ€§å¾ˆå¥½ ç¼ºä¹äº‹åŠ¡æ”¯æŒ å¢åŠ äº†åº”ç”¨ç¨‹åºè´Ÿæ‹…ï¼Œå¤æ‚æ€§æå‡ æ–°ä¸€ä»£ NewSQL è¯ç”Ÿï¼š ç±»ä¼¼ NoSQL çš„æ˜“äºæ‰©å±•æ€§ å…³ç³»å‹æ•°æ®åº“ æ”¯æŒ SQL å¼ºä¸€è‡´æ€§ä¿è¯ TiDBï¼ŒNewSQL å®¶æ—æˆå‘˜ï¼š å¸ˆæ‰¿ Google Spanner æ¶æ„ æ”¯æŒ MySQL ç½‘ç»œåè®® åº”ç”¨å±‚åŸºæœ¬æ— ç—›åˆ‡æ¢ TiDB ä½¿ç”¨ä¹è§‚é”æ¨¡å‹ï¼ˆä¸€ä¸ªæ¯”è¾ƒå¤§çš„å·®åˆ«ï¼‰ï¼Œå¯å‚è€ƒ è¿™æ®µä»‹ç»]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>TiDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[VSCode Markdown å†™ä½œæ•ˆç‡æå‡]]></title>
    <url>%2F2018%2F11%2F04%2Fmkdown-in-vscode%2F</url>
    <content type="text"><![CDATA[å¼•è¨€å¹³æ—¶å¤šä½¿ç”¨ VSCode ç¼–å†™ Markdown æ–‡ä»¶ï¼Œè™½ç„¶å®ƒä¹Ÿæœ‰å†…å»ºçš„é¢„è§ˆåŠŸèƒ½ï¼Œä½†æ˜¯æ•ˆæœä¸€èˆ¬ã€‚å¦‚æœèƒ½æœ‰å¥½çš„æ’ä»¶æ”¯æŒï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜å†™ä½œæ•ˆç‡ã€‚ä¸‹é¢å‡ ä¸ªæ’ä»¶ç€é‡è§£å†³è¿™ä¹ˆå‡ ä¸ªé—®é¢˜ï¼š æ”¯æŒæ›´å¼ºå¤§çš„é¢„è§ˆåŠŸèƒ½å’Œæ›´ä¸°å¯Œçš„æ‰©å±•è¯­æ³• æ”¯æŒå¿«æ·å›¾ç‰‡æ’å…¥ï¼Œè‡ªåŠ¨è¡¥é½ URL æ”¯æŒå¿«æ·é”®è®¾ç½®åŠ ç²—ã€æ–œä½“ç­‰ å¢å¼ºæ’ä»¶Markdown å®æ—¶é¢„è§ˆ åœ¨ VSCode çš„æ’ä»¶ä¸­å¿ƒæœç´¢ Markdown Preview Enhanced æ’ä»¶å¹¶å®‰è£…ï¼Œè¿™æ¬¾æ’ä»¶æ”¯æŒæ›´åŠ ä¸°å¯Œçš„æ‰©å±•è¯­æ³•ï¼Œå¯¹äºæå‡å†™ä½œæ•ˆç‡å¸®åŠ©å¾ˆå¤§ã€‚å¦å¤–ï¼Œé¢„è§ˆåŠŸèƒ½ä¹Ÿæ˜¯éå¸¸ç»™åŠ›ï¼ŒæåŠ›æ¨èï¼ å¿«æ·æ’å…¥å›¾ç‰‡åœ¨ VSCode æ’ä»¶ä¸­å¿ƒæœ‰ä¸¤æ¬¾çœ‹èµ·æ¥ä¸é”™çš„å›¾ç‰‡æ’å…¥å·¥å…·ï¼Œå‡æ”¯æŒä¸Šä¼ è‡³ä¸ƒç‰›äº‘ï¼Œå¹¶è‡ªåŠ¨åœ¨éœ€è¦æ’å…¥å›¾ç‰‡çš„ä½ç½®è¡¥å…¨è·¯å¾„ã€‚ é¦–å…ˆåœ¨ VSCode ä¸­æœç´¢å¹¶å®‰è£…æ’ä»¶ paste image to qiniuï¼Œæ¥ä¸‹æ¥é…ç½®ä¸ƒç‰›äº‘ï¼ˆAK, SK, Bucket ç­‰ï¼‰ï¼š è¿™æ¬¾æ’ä»¶çš„ç‰¹ç‚¹æ˜¯æ”¯æŒç›´æ¥ç²˜è´´å›¾ç‰‡å¹¶è‡ªåŠ¨ä¸Šä¼ çš„ã€‚å…¶é»˜è®¤çš„ç²˜è´´å¿«æ·é”®æ˜¯ option+command+v~ å¦å¤–ä¸€æ¬¾æ’ä»¶ qiniu-upload-image åˆ™æ”¯æŒæ‰“å¼€æŒ‡å®šçš„å›¾ç‰‡å¹¶å®Œæˆè‡ªåŠ¨ä¸Šä¼ ã€‚å…¶é…ç½®ä¸ä¸Šä¸€ä¸ªæ’ä»¶ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸¤æ¬¾æ’ä»¶çš„å¿«æ·é”®å¯èƒ½ä¸æ˜¯å¤ªæ–¹ä¾¿ï¼Œå»ºè®®å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹ä¸‹ï¼š Markdown å¿«æ·é”®æœ€åè¦ä»‹ç»çš„æ˜¯ä¸€æ¬¾èƒ½å¤Ÿæä¾› Markdown æ ¼å¼å¸¸ç”¨å¿«æ·é”®çš„æ’ä»¶ï¼šMarkdown Shortcutsã€‚æ”¯æŒçš„å¿«æ·æ“ä½œå¦‚ä¸‹ï¼š åŠ ç²— å€¾æ–œ åˆ é™¤çº¿ å¿«é€Ÿåˆ¶è¡¨ æ’å…¥ä»£ç  å¡«å†™ URLâ€¦]]></content>
      <categories>
        <category>å·¥å…·</category>
      </categories>
      <tags>
        <tag>VSCode</tag>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹è¯»ä¹¦ç¬”è®°]]></title>
    <url>%2F2018%2F11%2F04%2Fclean-code-notes%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ï¼ˆClean Codeï¼‰è¿™æœ¬ä¹¦éå¸¸é€‚åˆæ¯ä¸€ä¸ªå¸Œæœ›æé«˜ç¼–ç¨‹è´¨é‡çš„ç¨‹åºå‘˜é˜…è¯»ã€‚å¦‚ä½•ç»™å‚æ•°å‘½åï¼Ÿå¦‚ä½•å®šä¹‰å‡½æ•°ï¼Ÿå¦‚ä½•ç¼–æ’å­å‡½æ•°ï¼Ÿç­‰ç­‰è¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œä½ éƒ½å¯ä»¥åœ¨ä¹¦ä¸­æ‰¾åˆ°ã€‚ é¡¹ç›®è´¨é‡çš„å¥½åå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä»£ç é£æ ¼ï¼Œå¦‚æœå›¢é˜Ÿçš„ä»£ç é£æ ¼èƒ½å¤ŸåŸºæœ¬ä¿æŒä¸€è‡´ï¼Œå¯¹äºæ¯ä¸€ä½å¼€å‘è€…å’Œç»´æŠ¤è€…æ¥è¯´éƒ½æ˜¯ç¦éŸ³ã€‚ä¼˜ç§€çš„ä»£ç æ˜“äºç†è§£ï¼Œé€»è¾‘æ¸…æ™°ï¼Œå‘½åè§„èŒƒï¼Œä¹Ÿæ˜¯éå¸¸å€¼å¾—å­¦ä¹ çš„ã€‚ æœ¬æ–‡è®°å½•äº†åœ¨é˜…è¯» Robert C. Martin çš„ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ä¸€ä¹¦æ—¶å­¦ä¹ åˆ°çš„å…³é”®å†…å®¹ï¼Œä¾¿äºåæœŸå¤ä¹ ã€åæ€ã€æ€»ç»“å’Œè¿›ä¸€æ­¥æå‡ã€‚åŠªåŠ›åšä¸€ä¸ªæ‹¥æœ‰è‰¯å¥½ã€Œä»£ç æ´ç™–ã€çš„ç å†œ~ å‘½åè§„åˆ™ åå‰¯å…¶å®ï¼š ä¸éœ€è¦æ³¨é‡Šæ¥è¡¥å……å‘½åçš„å«ä¹‰ é¿å…è¯¯å¯¼ï¼š é¿å…ä½¿ç”¨ä¸æœ¬æ„ç›¸æ‚–çš„è¯ å ¤é˜²ä½¿ç”¨ä¸åŒä¹‹å¤„è¾ƒå°çš„åç§° åšæœ‰æ„ä¹‰çš„åŒºåˆ†ï¼š ä¸è¦ä»¥æ•°å­—åŒºåˆ† é¿å…åºŸè¯ åºŸè¯éƒ½æ˜¯å†—ä½™ï¼ŒVariable ä¸€è¯æ°¸è¿œä¸åº”å½“å‡ºç°åœ¨å˜é‡åä¸­ è¦åŒºåˆ†åç§°ï¼Œå°±è¦ä»¥è¯»è€…èƒ½é‰´åˆ«ä¸åŒä¹‹å¤„çš„æ–¹å¼æ¥åŒºåˆ†ã€‚ ä½¿ç”¨è¯»å¾—å‡ºæ¥çš„åç§° ä½¿ç”¨å¯æœç´¢çš„åç§°ï¼š é¿å…ä½¿ç”¨å•å­—æ¯çš„è¯ åç§°é•¿çŸ­åº”ä¸å…¶ä½œç”¨åŸŸå¤§å°ç›¸å¯¹åº” é¿å…ä½¿ç”¨ç¼–ç ï¼š å¯¹äºç°ä»£ç¼–è¯‘å™¨ï¼Œè¯·æ‘’å¼ƒåŒˆç‰™åˆ©å‘½åæ³• ä¸éœ€è¦æˆå‘˜å‰ç¼€ï¼Œå¦‚ _m é¿å…æ€ç»´æ˜ å°„ï¼š æ˜ç¡®æ˜¯ç‹é“ ç±»åï¼š ç±»åå’Œå¯¹è±¡åº”å½“æ˜¯åè¯æˆ–è€…åè¯æ€§çŸ­è¯­ é¿å… Manager, Processor, Data æˆ– Info è¿™ç±»çš„ç±»å ç±»åä¸åº”è¯¥æ˜¯åŠ¨è¯ã€‚ æ–¹æ³•åï¼š æ–¹æ³•ååº”å½“æ˜¯åŠ¨è¯æˆ–åŠ¨è¯çŸ­è¯­ åˆ«æ‰®å¯çˆ±ï¼š å®å¯æ˜ç¡®ï¼Œæ¯‹ä¸ºå¥½ç© è¨€åˆ°æ„åˆ°ï¼Œæ„åˆ°è¨€åˆ° æ¯ä¸ªæ¦‚å¿µå¯¹åº”ä¸€ä¸ªè¯ åˆ«ç”¨åŒå…³è¯­ï¼š é¿å…å°†åŒä¸€ä¸ªå•è¯ç”¨äºä¸åŒç›®çš„ ä½¿ç”¨è§£å†³æ–¹æ¡ˆé¢†åŸŸåç§°ï¼š å¤šä½¿ç”¨ CS æœ¯è¯­ã€ç®—æ³•ã€æ¨¡å¼ã€æ•°å­¦æœ¯è¯­å§ ä½¿ç”¨æºè‡ªæ‰€æ¶‰é—®é¢˜é¢†åŸŸçš„åç§° æ·»åŠ æœ‰æ„ä¹‰çš„è¯­å¢ƒï¼š è‰¯å¥½å‘½åçš„ç±»ã€å‡½æ•°æˆ–å‘½åç©ºé—´æ”¾ç½®åç§°ï¼Œæä¾›è¯­å¢ƒ ä½¿ç”¨å‰ç¼€ ä¸è¦æ·»åŠ æ²¡ç”¨çš„è¯­å¢ƒï¼š åªè¦çŸ­åç§°è¶³å¤Ÿæ¸…æ¥šï¼Œå°±æ¯”é•¿åç§°å¥½ å‡½æ•° çŸ­å°ï¼š å‡½æ•°çš„ç¬¬ä¸€è§„åˆ™æ˜¯çŸ­å°ï¼Œç¬¬äºŒæ¡æ˜¯æ›´çŸ­å° å‡½æ•°ï¼Œ20 è¡Œå°é¡¶æœ€ä½³ åªåšä¸€ä»¶äº‹ï¼š å‡½æ•°åº”è¯¥åªåšä¸€ä»¶äº‹æƒ…ï¼Œæœ€å¥½è¿™ä»¶äº‹æƒ… åˆ¤æ–­å‡½æ•°æ˜¯å¦ä¸æ­¢åšäº†ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯çœ‹èƒ½å¦å†æ‹†å‡ºä¸€ä¸ªå‡½æ•° å¦‚æœå‡½æ•°åªæ˜¯åšäº†è¯¥å‡½æ•°åŒä¸€æŠ½è±¡å±‚ä¸Šçš„æ­¥éª¤ï¼Œåˆ™å‡½æ•°è¿˜æ˜¯åªåšäº†ä¸€ä»¶äº‹ æ¯ä¸ªå‡½æ•°ä¸€ä¸ªæŠ½è±¡å±‚çº§ï¼š è‡ªé¡¶å‘ä¸‹è¯»ä»£ç ï¼šå‘ä¸‹è§„åˆ™ è®©æ¯ä¸ªå‡½æ•°åé¢éƒ½è·Ÿç€ä½äºä¸‹ä¸€æŠ½è±¡å±‚çš„å‡½æ•° switch è¯­å¥ï¼š å¤šæ€åˆ›å»ºï¼Œéšè—äºæŸä¸ªç»§æ‰¿å…³ç³»ä¸­ï¼Œä¸è¦æš´éœ²å‡ºæ¥ ä½¿ç”¨æè¿°æ€§çš„åç§°ï¼š å¦‚æœæ¯ä¸ªä¾‹ç¨‹éƒ½è®©ä½ æ„Ÿåˆ°æ·±åˆå·±æ„ï¼Œé‚£å°±æ˜¯æ•´æ´ä»£ç  é•¿è€Œå…·æœ‰æè¿°æ€§çš„åç§°ï¼Œæ¯”çŸ­è€Œä»¤äººè´¹è§£çš„åç§°å¥½ é•¿è€Œå…·æœ‰æè¿°æ€§çš„åç§°ï¼Œè¦æ¯”æè¿°æ€§çš„é•¿æ³¨é‡Šå¥½ å‡½æ•°å‚æ•°ï¼š å‚æ•°ä¸è¦è¿‡å¤šï¼ˆå°½å¯èƒ½ï¼‰ å‚æ•°å’Œå‡½æ•°åç§°å¤„äºä¸åŒçš„æŠ½è±¡å±‚çº§ï¼Œè¦æ±‚ä½ äº†è§£ç›®å‰å¹¶ä¸ç‰¹åˆ«é‡è¦çš„ç»†èŠ‚ æ ‡è¯†å‚æ•°ä¸‘é™‹ä¸å ªï¼Œæ„å‘³ç€è¦åšä¸æ­¢ä¸€ä»¶äº‹æƒ… æœ‰ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°è¦æ¯”ä¸€å…ƒå‡½æ•°éš¾æ‡‚ å°‘ç”¨å‚æ•°åˆ—è¡¨ æ— å‰¯ä½œç”¨ï¼š æ™®éè€Œè¨€ï¼Œåº”é¿å…ä½¿ç”¨è¾“å‡ºå‚æ•°ã€‚å¦‚æœå‡½æ•°å¿…é¡»è¦ä¿®æ”¹æŸç§çŠ¶æ€ï¼Œå°±ä¿®æ”¹æ‰€å±çš„å¯¹è±¡çŠ¶æ€å§ã€‚ åˆ†éš”æŒ‡ä»¤ä¸è¯¢é—®ï¼š å‡½æ•°è¦ä¹ˆåšä»€ä¹ˆäº‹æƒ…ï¼Œè¦ä¹ˆå›ç­”ä»€ä¹ˆï¼ŒäºŒè€…ä¸å¯å…¼å¾— å‡½æ•°åº”è¯¥ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€æˆ–è¿”å›å¯¹è±¡çš„æœ‰å…³ä¿¡æ¯ã€‚ ä½¿ç”¨å¼‚å¸¸æ›¿ä»£è¿”å›çš„é”™è¯¯ç ï¼š æŠ½ç¦» try/catch ä»£ç å— å‡½æ•°åªåº”è¯¥åšä¸€ä»¶äº‹ï¼Œé”™è¯¯å¤„ç†å°±æ˜¯ä¸€ä»¶ åˆ«é‡å¤è‡ªå·±ï¼ˆDRY)ï¼š é‡å¤å¯èƒ½æ˜¯è½¯ä»¶ä¸­ä¸€åˆ‡é‚ªæ¶çš„æ ¹æº å¾ˆå¤šåŸåˆ™å’Œå®è·µè§„åˆ™éƒ½æ˜¯ä¸ºäº†æ§åˆ¶ä¸æ¶ˆé™¤é‡å¤è€Œåˆ›å»º ç»“æ„åŒ–ç¼–ç¨‹ å¹¶ä¸æ˜¯ä»ä¸€å¼€å§‹æŒ‰ç…§è§„åˆ™å†™å‡½æ•°ï¼Œæ²¡äººå¯ä»¥åšåˆ°ã€‚å¯ä»¥ä¸€å¼€å§‹è®©å‡½æ•°å·¥ä½œèµ·æ¥ï¼Œå†åˆ©ç”¨ä¸Šé¢çš„è§„èŒƒè¿›è¡Œä¼˜åŒ–ï¼ŒåŒæ—¶é…åˆå•å…ƒæµ‹è¯•ä¿è¯æ²¡æœ‰é”™è¯¯ çœŸæ­£çš„ç›®æ ‡åœ¨äºè®²è¿°ç³»ç»Ÿçš„æ•…äº‹ï¼Œç¼–å†™çš„å‡½æ•°å¿…é¡»å¯ä»¥å¹²å‡€åˆ©è½åœ°æ‹¼è£…åœ¨ä¸€å—ï¼Œå½¢æˆä¸€ç§ç²¾ç¡®è€Œæ¸…æ™°çš„è¯­è¨€ï¼Œå¸®ä½ è®²æ•…äº‹ æ³¨é‡Š æ³¨é‡Šæ€»æ˜¯ä¸€ç§å¤±è´¥ï¼Œæˆ‘ä»¬æ€»æ— æ³•æ‰¾åˆ°ä¸ç”¨æ³¨é‡Šå°±èƒ½è¡¨è¾¾è‡ªæˆ‘çš„æ–¹æ³•ï¼Œæ‰€ä»¥æ€»è¦æœ‰æ³¨é‡Šï¼Œå¹¶ä¸å€¼å¾—åº†ç¥ ç¨‹åºå‘˜ä¸èƒ½åšæŒç»´æŠ¤æ³¨é‡Š çœŸæ­£å¥½çš„æ³¨é‡Šæ˜¯ä¸å†™æ³¨é‡Šï¼Œç”¨ä»£ç è¡¨è¾¾ å¥½çš„æ³¨é‡Šï¼š æ³•å¾‹ä¿¡æ¯ æä¾›ä¿¡æ¯çš„æ³¨é‡Š å¯¹æ„å›¾çš„è§£é‡Š é˜é‡Š è­¦ç¤º TODO æ³¨é‡Š æ”¾å¤§ åçš„æ³¨é‡Šï¼š å–ƒå–ƒè‡ªè¯­ï¼šä»»ä½•è¿«ä½¿è¯»è€…æŸ¥çœ‹å…¶å®ƒæ¨¡å—çš„æ³¨é‡Šéƒ½æ²¡èƒ½ä¸è¯»è€…æ²Ÿé€šå¥½ å¤šä½™çš„æ³¨é‡Š è¯¯å¯¼æ€§æ³¨é‡Š å¾ªè§„è¹ˆçŸ©å¼æ³¨é‡Š æ—¥å¿—å¼æ³¨é‡Š åºŸè¯æ³¨é‡Š å¯æ€•çš„åºŸè¯ èƒ½ç”¨å‡½æ•°æˆ–å˜é‡æ—¶å°±åˆ«ç”¨æ³¨é‡Š ä½ç½®æ ‡è®° å½’å±ä¸ç½²åï¼šæºç æ§åˆ¶ç³»ç»Ÿå·²ç»å¯ä»¥æå®š æ³¨é‡Šæ‰çš„ä»£ç  HTML æ³¨é‡Š éæœ¬åœ°ä¿¡æ¯ï¼šæ³¨é‡Šè¦é è¿‘ä»£ç  ä¿¡æ¯è¿‡å¤š ä¸æ˜æ˜¾çš„è”ç³»ï¼šæ³¨é‡Šè¦è§£é‡Šä»£ç ä¸­ä¸èƒ½è‡ªè¡Œè§£é‡Šçš„éƒ¨åˆ†ï¼Œä¸è¦è®©æ³¨é‡Šéœ€è¦äºŒæ¬¡è§£æ å‡½æ•°å¤´æ³¨é‡Šï¼šç”¨å¥½çš„å‡½æ•°åç§°ä»£æ›¿ èŒƒä¾‹ æ ¼å¼ ä»£ç æ ¼å¼å¾ˆé‡è¦ã€‚ä»£ç æ ¼å¼å…³ä¹æ²Ÿé€šï¼Œè€Œæ²Ÿé€šæ˜¯ä¸“ä¸šå¼€å‘çš„å¤´ç­‰å¤§äº‹ è®©é£æ ¼å’Œå¾‹æ¡æ°¸å­˜ çŸ­æ–‡ä»¶é€šå¸¸æ¯”é•¿æ–‡ä»¶æ˜“äºç†è§£ å‘æŠ¥çº¸å­¦ä¹ ï¼šå¾ªåºæ¸è¿› æ¦‚å¿µé—´å‚ç›´æ–¹å‘ä¸Šçš„åŒºéš”ï¼šç©ºè¡Œ å‚ç›´æ–¹å‘ä¸Šçš„é è¿‘ï¼šç´§å¯†ä»£ç ç›¸äº’é è¿‘ å‚ç›´è·ç¦»ï¼šå…³ç³»å¯†åˆ‡çš„æ¦‚å¿µåº”è¯¥ç›¸äº’é è¿‘ï¼Œåº”é¿å…è¯»è€…åœ¨æºæ–‡ä»¶å’Œç±»ä¸­è·³æ¥è·³å» å˜é‡å£°æ˜ï¼šå°½å¯èƒ½é è¿‘ä½¿ç”¨ä½ç½® å®ä½“å˜é‡ï¼šåº”åœ¨ç±»çš„é¡¶éƒ¨å£°æ˜ ç›¸å…³å‡½æ•°ï¼šè‹¥æŸä¸ªå‡½æ•°è°ƒç”¨äº†å¦ä¸€ä¸ªï¼Œå°±åº”è¯¥æŠŠå®ƒä»¬æ”¾åˆ°ä¸€èµ·ï¼Œè°ƒç”¨è€…åº”è¯¥å°½å¯èƒ½æ”¾åœ¨è¢«è°ƒç”¨è€…ä¸Šè¾¹ æ¦‚å¿µç›¸å…³ï¼šæ­¤ç±»ä»£ç åº”æ”¾åœ¨ä¸€èµ·ï¼Œç›¸å…³æ€§è¶Šå¼ºï¼Œåº”è¯¥è¶Šé è¿‘ å‚ç›´é¡ºåºï¼šè‡ªé¡¶å‘ä¸‹åœ°å±•ç°è°ƒç”¨ä¾èµ– æ¨ªå‘æ ¼å¼ï¼šå»ºè®®æ¯è¡ŒçŸ­å°ï¼Œ120 åˆ—å°±æ˜¯ä¸Šé™äº† æ°´å¹³æ–¹å‘ä¸Šçš„åŒºéš”ä¸é è¿‘ï¼š åŠ ç©ºæ ¼åˆ†éš” æ°´å¹³å¯¹é½ï¼š ä¸ç”¨å¤ªåˆ»æ„å…³æ³¨ ç¼©è¿›ï¼šä¸€ç§ç»§æ‰¿ç»“æ„ï¼Œä½“ç°ä¸€ç§å±‚çº§å…³ç³» ç©ºèŒƒå›´ï¼šåº”å½“ç¼©è¿›å¼€æ¥ å›¢é˜Ÿè§„åˆ™ï¼šéµå®ˆå›¢é˜Ÿè§„åˆ™ã€‚å¥½çš„è½¯ä»¶ç³»ç»Ÿæ˜¯ç”±ä¸€ç³»åˆ—è¯»èµ·æ¥ä¸é”™çš„ä»£ç æ–‡ä»¶ç»„æˆçš„ å¯¹è±¡å’Œæ•°æ®ç»“æ„ éšè—å®ç°å…³ä¹æŠ½è±¡ï¼Œç±»å¹¶ä¸æ˜¯ç®€å•åœ°ç”¨å–å€¼å™¨å’Œèµ‹å€¼å™¨å°†å…¶å˜é‡æ¨å‘å¤–é—´ï¼Œè€Œæ˜¯æš´éœ²æŠ½è±¡æ¥å£ï¼Œä»¥ä¾¿ç”¨æˆ·æ— éœ€äº†è§£æ•°æ®çš„å®ç°å°±èƒ½æ“ä½œæ•°æ®æœ¬ä½“ æ•°æ®ã€å¯¹è±¡å’Œåå¯¹ç§°æ€§ï¼š å¯¹è±¡æŠŠæ•°æ®éšè—äºæŠ½è±¡ä¹‹åï¼Œæš´éœ²æ“ä½œæ•°æ®çš„å‡½æ•° æ•°æ®ç»“æ„æš´éœ²æ•°æ®ï¼Œæ²¡æœ‰æä¾›æœ‰æ„ä¹‰çš„å‡½æ•° è¿‡ç¨‹å¼ä»£ç ï¼ˆä½¿ç”¨æ•°æ®ç»“æ„çš„ä»£ç ï¼‰ä¾¿äºåœ¨ä¸æ”¹åŠ¨æ—¢æœ‰æ•°æ®ç»“æ„çš„å‰æä¸‹æ–°å¢å‡½æ•°ã€‚é¢å‘å¯¹è±¡ä»£ç ä¾¿äºåœ¨ä¸æ”¹åŠ¨æ—¢æœ‰å‡½æ•°çš„å‰æä¸‹æ–°å¢ç±»ï¼Œåä¹‹äº¦ç„¶ å¯¹äºä¸¤ç§ç±»å‹ï¼Œåº”è¯¥æ ¹æ®æƒ…å†µè€ƒè™‘ä½¿ç”¨ å¾—å¢¨å¿’è€³å¾‹ï¼šæ¨¡å—ä¸åº”è¯¥äº†è§£å®ƒæ‰€æ“ä½œå¯¹è±¡çš„å†…éƒ¨æƒ…å½¢ï¼Œæ–¹æ³•ä¸åº”è°ƒç”¨ä»»ä½•å‡½æ•°è¿”å›çš„å¯¹è±¡çš„æ–¹æ³•ï¼ˆæ¯”å¦‚é“¾å¼è°ƒç”¨å°±è¿åäº†ï¼‰ æ•°æ®ä¼ é€å¯¹è±¡ï¼š æœ€ä¸ºç²¾ç‚¼çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåªæœ‰å…¬å…±å˜é‡ã€æ²¡æœ‰å‡½æ•°çš„ç±»ï¼Œå³æ•°æ®ä¼ é€å¯¹è±¡ï¼ˆDTO, Data Transfer Objectsï¼‰ å¯¹è±¡æš´éœ²è¡Œä¸ºï¼Œéšè—æ•°æ®ã€‚ä¾¿äºæ·»åŠ æ–°å¯¹è±¡ç±»å‹è€Œæ— éœ€ä¿®æ”¹æ—¢æœ‰è¡Œä¸ºï¼ŒåŒæ—¶ä¹Ÿéš¾ä»¥åœ¨æ—¢æœ‰å¯¹è±¡ä¸­æ·»åŠ æ–°è¡Œä¸º æ•°æ®ç»“æ„æš´éœ²æ•°æ®ï¼Œæ²¡æœ‰æ˜æ˜¾çš„è¡Œä¸ºã€‚ä¾¿äºå‘æ•°æ®ç»“æ„æ·»åŠ æ–°è¡Œä¸ºï¼ŒåŒæ—¶ä¹Ÿéš¾ä»¥å‘æ—¢æœ‰å‡½æ•°ä¸­æ·»åŠ æ–°çš„æ•°æ®ç»“æ„ åœ¨ä»»ä½•ç³»ç»Ÿä¸­æˆ‘ä»¬æœ‰æ—¶å¸Œæœ›èƒ½å¤Ÿçµæ´»æ·»åŠ æ–°çš„æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä½¿ç”¨å¯¹è±¡ã€‚æœ‰æ—¶å¸Œæœ›çµæ´»æ·»åŠ æ–°è¡Œä¸ºï¼Œè¿™æ—¶æ›´å¸Œæœ›ä½¿ç”¨æ•°æ®ç±»å‹å’Œè¿‡ç¨‹ã€‚ä¼˜ç§€çš„å¼€å‘è€…ä¸å¸¦æˆè§åœ°äº†è§£è¿™äº›å½¢å¼ï¼Œæ ¹æ®æƒ…å†µé€‰æ‹©åˆé€‚çš„æ‰‹æ®µ é”™è¯¯å¤„ç†å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œç¨‹åºå‘˜æœ‰è´£ä»»ä¿è¯ä»£ç ç…§å¸¸å·¥ä½œã€‚é”™è¯¯å¤„ç†å¾ˆé‡è¦ï¼Œå¦‚æœæä¹±äº†ä»£ç é€»è¾‘ï¼Œåˆ™æ˜¯é”™è¯¯çš„åšæ³•ã€‚ ä½¿ç”¨å¼‚å¸¸è€Œéè¿”å›ç  å…ˆå†™ try-catch-finally è¯­å¥ï¼š å¼‚å¸¸çš„å¦™å¤„ä¹‹ä¸€ï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªèŒƒå›´ å°è¯•ç¼–å†™å¼ºè¡ŒæŠ›å‡ºå¼‚å¸¸çš„æµ‹è¯•ï¼Œå†å¾€å¤„ç†å™¨ä¸­æ·»åŠ è¡Œä¸ºï¼Œä½¿ä¹‹æ»¡è¶³æµ‹è¯•è¦æ±‚ ä½¿ç”¨ä¸å¯æ§å¼‚å¸¸ï¼š å¯æ§å¼‚å¸¸çš„ä»£ä»·æ˜¯è¿åâ€œå¼€é—­åŸåˆ™â€ ä¸€èˆ¬åº”ç”¨å¼€å‘ï¼Œåº”è¯¥é¿å…å¯æ§å¼‚å¸¸ ç»™å‡ºå¼‚å¸¸å‘ç”Ÿçš„ç¯å¢ƒè¯´æ˜ï¼šåˆ›å»ºä¿¡æ¯å……åˆ†çš„é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶å’Œå¼‚å¸¸ä¸€èµ·ä¼ é€’å‡ºå»ã€‚åœ¨æ¶ˆæ¯ä¸­åŒ…æ‹¬å¤±è´¥çš„æ“ä½œå’Œå¤±è´¥çš„ç±»å‹ ä¾è°ƒç”¨è€…éœ€è¦å®šä¹‰å¼‚å¸¸ç±»ï¼š å®šä¹‰å¼‚å¸¸ï¼Œè€ƒè™‘å®ƒä»¬åº”è¯¥å¦‚ä½•æ•è· å°†ç¬¬ä¸‰æ–¹ API æ‰“åŒ…æ˜¯ä¸ªè‰¯å¥½çš„å®è·µæ‰‹æ®µï¼Œå½“æ‰“åŒ…ä¸€ä¸ªç¬¬ä¸‰æ–¹ APIï¼Œå°±é™ä½äº†å¯¹å®ƒçš„ä¾èµ–ï¼ŒåŒæ—¶åœ¨æµ‹è¯•æ—¶æœ‰åŠ©äºæ¨¡æ‹Ÿç¬¬ä¸‰æ–¹è°ƒç”¨ å®šä¹‰å¸¸è§„æµç¨‹ï¼š åˆ›å»ºä¸€ä¸ªç±»æˆ–é…ç½®ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å¤„ç†ç‰¹ä¾‹ï¼Œå¼‚å¸¸è¡Œä¸ºå°è£…åˆ°ç‰¹ä¾‹å¯¹è±¡ä¸­ é¿å…æ‰“æ–­ä¸šåŠ¡é€»è¾‘ é¿å…ä¼ é€’ None/NULL/nil ç­‰ï¼Œå¦åˆ™å‡½æ•°éœ€è¦åšå¾ˆå¤šé¢å¤–çš„åˆ¤æ–­ï¼ˆå½“ç„¶ï¼Œè¿™äº›æ˜¯å¿…é¡»çš„ï¼‰ è¾¹ç•Œå¦‚ä½•ä¿æŒè½¯ä»¶è¾¹ç•Œæ•´æ´ï¼Ÿè¿™ä¸€ç« ç»™å‡ºä¸€äº›å®è·µæ‰‹æ®µå’ŒæŠ€å·§ ä½¿ç”¨ç¬¬ä¸‰æ–¹ä»£ç ï¼š è¾¹ç•Œä¸Šçš„æ¥å£æ˜¯éšè—çš„ ä¸åº”å°†å«æœ‰è¾¹ç•Œæ¥å£çš„å¯¹è±¡åˆ°å¤„ä¼ é€’ï¼Œåº”å½“æŠŠå®ƒä¿ç•™åœ¨ç±»æˆ–è¿‘äº²ç±»ä¸­ å­¦ä¹ æ€§æµ‹è¯•çš„å¥½å¤„ä¸åªæ˜¯å…è´¹ï¼š æ— è®ºå¦‚ä½•éƒ½è¦å­¦ä¹ ä½¿ç”¨ APIï¼Œè€Œç¼–å†™æµ‹è¯•æ˜¯è·å¾—è¿™äº›çŸ¥è¯†çš„å®¹æ˜“è€Œä¸å½±å“å…¶ä»–å·¥ä½œçš„é€”å¾„ å­¦ä¹ æ€§æµ‹è¯•æ˜¯ä¸€ç§ç²¾ç¡®å®éªŒï¼Œå¸®åŠ©æˆ‘ä»¬é˜Ÿ API çš„ç†è§£ ä½¿ç”¨å°šä¸å­˜åœ¨çš„ä»£ç ï¼š è¿˜æœ‰ä¸€ç§è¾¹ç•Œï¼Œå°†å·²çŸ¥å’Œä½ç½®åˆ†éš”å¼€çš„è¾¹ç•Œ Fake å’Œ Adapter æ•´æ´çš„è¾¹ç•Œï¼š è¾¹ç•Œä¸Šçš„ä»£ç éœ€è¦æ¸…æ™°åœ°åˆ†å‰²å’Œå®šä¹‰æœŸæœ›çš„æµ‹è¯•ã€‚åº”è¯¥é¿å…æˆ‘ä»¬çš„ä»£ç è¿‡å¤šäº†è§£ç¬¬ä¸‰æ–¹ä»£ç çš„ç‰¹å®šä¿¡æ¯ ä¾é ä½ èƒ½æ§åˆ¶çš„ä¸œè¥¿ï¼Œå¥½è¿‡ä¾é ä½ æ§åˆ¶ä¸äº†çš„ä¸œè¥¿ å¯ä»¥é‡‡ç”¨å†…éƒ¨éšè—è¾¹ç•Œæ¥å£æˆ–è€…ä½¿ç”¨é€‚é…æ¨¡å¼ä¿æŒè¾¹ç•Œæ•´æ´ï¼Œä»è€Œå‡å°‘æ¥å£çš„ä¿®æ”¹ å•å…ƒæµ‹è¯• TDD ä¸‰å®šå¾‹ï¼š åœ¨ç¼–å†™ä¸èƒ½é€šè¿‡çš„å•å…ƒæµ‹è¯•å‰ï¼Œä¸å¯ç¼–å†™ç”Ÿäº§ä»£ç  åªå¯ç¼–å†™åˆšå¥½æ— æ³•é€šè¿‡çš„å•å…ƒæµ‹è¯•ï¼Œä¸èƒ½ç¼–è¯‘ä¹Ÿç®—ä¸é€šè¿‡ åªç¼–å†™åˆšå¥½å¯ä»¥é€šè¿‡å½“å‰å¤±è´¥æµ‹è¯•çš„ç”Ÿäº§ä»£ç  ä¿æŒæ•´æ´çš„æµ‹è¯•ï¼š è‚®è„çš„æµ‹è¯•ç­‰åŒäºæ²¡æœ‰æµ‹è¯• æµ‹è¯•å¿…é¡»è·Ÿéšç”Ÿäº§ä»£ç ä¿®æ”¹ æµ‹è¯•ä»£ç å’Œç”Ÿæˆä»£ç ä¸€æ ·é‡è¦ï¼Œéœ€è¦ä»”ç»†æ€è€ƒã€è®¾è®¡å’Œç…§æ–™ï¼Œä¿æŒæ•´æ´ æ­£æ˜¯å•å…ƒæµ‹è¯•è®©ä½ çš„ä»£ç å¯æ‰©å±•ã€å¯ç»´æŠ¤ã€å¯å¤ç”¨ æµ‹è¯•å¸¦æ¥äº†ä¸€åˆ‡å¥½å¤„ï¼Œä½¿å˜åŠ¨æˆä¸ºå¯èƒ½ æµ‹è¯•è¶Šè„ï¼Œä»£ç æœ€ç»ˆä¼šè¶Šè„ æ•´æ´çš„æµ‹è¯•ï¼š å¯è¯»æ€§ æ„é€ -æ“ä½œ-æ£€éªŒï¼ˆBUILD-OPERATE-CHECK)æ¨¡å¼ æµ‹è¯•ç›´è¾¾ç›®çš„ï¼Œåªç”¨çœŸæ­£éœ€è¦çš„æ•°æ®ç±»å‹å’Œå‡½æ•° ä¸“ä¸šçš„å¼€å‘è€…å°†ä»–ä»¬çš„æµ‹è¯•ä»£ç é‡æ„ä¸ºç®€æ´å’Œå…·æœ‰è¡¨è¾¾åŠ›çš„å½¢å¼ æ¯ä¸ªæµ‹è¯•ä¸€ä¸ªæ–­è¨€ï¼š æ¯ä¸ªæµ‹è¯•æ—¶ä¸€ä¸ªæ¦‚å¿µ FIRSTï¼š å¿«é€Ÿ Fastï¼šèƒ½å¤Ÿé¢‘ç¹è¿è¡Œ ç‹¬ç«‹ Independentï¼šæŸä¸ªæµ‹è¯•ä¸åº”ä¸ºä¸‹ä¸€ä¸ªæµ‹è¯•è®¾å®šæ¡ä»¶ å¯é‡å¤ Repeatableï¼šæµ‹è¯•åº”å½“å¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­é‡å¤é€šè¿‡ è‡ªè¶³éªŒè¯ Self-Validatingï¼šæµ‹è¯•åº”æœ‰å¸ƒå°”å€¼è¾“å‡ºï¼Œå¯ä»¥ç›´æ¥åé¦ˆæµ‹è¯•ç»“æœ åŠæ—¶ Timelyï¼šæµ‹è¯•åº”åŠæ—¶ç¼–å†™ æˆ–è®¸æµ‹è¯•æ›´ä¸ºé‡è¦ï¼Œå®ƒä¿è¯å’Œå¢å¼ºäº†ç”Ÿäº§ä»£ç çš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯å¤ç”¨æ€§ ç±» ç±»çš„ç»„ç»‡ï¼š å…¬å…±å‡½æ•°åº”è·Ÿåœ¨å˜é‡åˆ—è¡¨ä¹‹åï¼Œæˆ‘ä»¬å–œæ¬¢æŠŠç”±æŸä¸ªå…¬å…±å‡½æ•°è°ƒç”¨çš„ç§æœ‰å·¥å…·å‡½æ•°ç´§éšåœ¨è¯¥å…¬å…±å‡½æ•°çš„åé¢ï¼Œç¬¦åˆè‡ªé¡¶å‘ä¸‹çš„åŸåˆ™ ç±»åº”è¯¥çŸ­å°ï¼š è®¡ç®—ã€Œæƒè´£ responsibilityã€è¡¡é‡ç±»å¤§å° ç±»çš„åç§°åº”å½“æè¿°æƒè´£ï¼Œå¦‚æœæ— æ³•ä¸ºæŸä¸ªç±»å‘½åä»¥ç²¾ç¡®çš„åç§°ï¼Œè¿™ä¸ªç±»å¤§æ¦‚å°±å¤ªé•¿äº† å•ä¸€æƒè´£åŸåˆ™ï¼ˆSRP)ï¼šç±»æˆ–æ¨¡å—åº”è¯¥æœ‰ä¸”åªæœ‰ä¸€æ¡åŠ ä»¥ä¿®æ”¹çš„ç†ç”± ç³»ç»Ÿåº”è¯¥ç”±è®¸å¤šçŸ­å°çš„ç±»è€Œéå°‘é‡å·¨å¤§çš„ç±»ç»„æˆã€‚æ¯ä¸ªå°ç±»å°è£…ä¸€ä¸ªæƒè´£ï¼Œåªæœ‰ä¸€ä¸ªä¿®æ”¹çš„åŸå› ï¼Œå¹¶ä¸å°‘æ•°å…¶ä»–ç±»ä¸€èµ·ååŒè¾¾æˆæœŸæœ›çš„ç³»ç»Ÿè¡Œä¸º å†…èšï¼šç±»åº”è¯¥åªæœ‰å°‘é‡çš„å®ä½“å˜é‡ï¼Œç±»ä¸­çš„æ¯ä¸ªæ–¹æ³•éƒ½åº”è¯¥æ“ä½œä¸€ä¸ªæˆ–å¤šä¸ªè¿™ç§å˜é‡ ä¿æŒå†…èšä¼šå¾—åˆ°è®¸å¤šçŸ­å°çš„ç±» åœ¨ç†æƒ³ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ‰©å±•è€Œéä¿®æ”¹ç°æœ‰ç³»ç»Ÿçš„æ–¹å¼æ·»åŠ æ–°ç‰¹æ€§ éƒ¨ä»¶ä¹‹é—´çš„è§£è€¦ä»£è¡¨ç³»ç»Ÿä¸­çš„å…ƒç´ ç›¸äº’éš”ç¦»çš„å¾ˆå¥½ï¼Œéš”ç¦»ä¹Ÿè®©ç³»ç»Ÿæ¯ä¸ªå…ƒç´ çš„ç†è§£å˜å¾—æ›´åŠ å®¹æ˜“ ä¾èµ–å€’ç½®åŸ(DIP)ï¼šä¾èµ–äºæŠ½è±¡è€Œéå®ç°çš„ç»†èŠ‚ ç³»ç»Ÿï¼ˆå Javaï¼‰â€œå¤æ‚è¦äººå‘½ã€‚å®ƒæ¶ˆç£¨å¼€å‘è€…çš„ç”Ÿå‘½ï¼Œè®©äº§å“éš¾ä»¥è§„åˆ’ã€æ„å»ºå’Œæµ‹è¯•â€â€”â€” Ray Ozzieï¼Œå¾®è½¯é¦–å¸­æŠ€æœ¯å®˜ åŸå¸‚ç®¡ç†ï¼šæœ‰äººè´Ÿè´£å…¨å±€ï¼Œæœ‰äººè´Ÿè´£å±€éƒ¨ å°†ç³»ç»Ÿçš„æ„é€ å’Œä½¿ç”¨åˆ†å¼€ï¼š â€œè½¯ä»¶ç³»ç»Ÿåº”å°†èµ·å§‹è¿‡ç¨‹å’Œèµ·å§‹è¿‡ç¨‹ä¹‹åçš„è¿è¡Œæ—¶é€»è¾‘åˆ†ç¦»å¼€ï¼Œåœ¨èµ·å§‹è¿‡ç¨‹ä¸­æ„å»ºåº”ç”¨å¯¹è±¡ï¼Œä¹Ÿä¼šå­˜åœ¨äº’ç›¸çº ç¼ çš„ä¾èµ–å…³ç³»â€ åˆ†è§£ main å·¥å‚ ä¾èµ–æ³¨å…¥ï¼šæ§åˆ¶åè½¬åœ¨ä¾èµ–ç®¡ç†ä¸­çš„ä¸€ç§åº”ç”¨æ‰‹æ®µ æ‰©å®¹ï¼š â€œä¸€å¼€å§‹å°±åšå¯¹ç³»ç»Ÿâ€çº¯å±ç¥è¯ æµ‹è¯•é©±åŠ¨å¼€å‘ã€è¿­ä»£å’Œå¢é‡æ•æ·æ‰©å±•ç³»ç»Ÿ å°æ­¥å¿«è·‘ï¼šè¿­ä»£ é€šè¿‡è¿­ä»£å’Œæ”¹è¿›è®¾è®¡è¾¾åˆ°æ•´æ´ç›®çš„ï¼ˆKent Beck çš„ç®€å•è®¾è®¡è§„åˆ™ï¼‰ï¼š è¿è¡Œæ‰€æœ‰æµ‹è¯• ä¸å¯é‡å¤ è¡¨è¾¾äº†ç¨‹åºå‘˜çš„æ„å›¾ å°½å¯èƒ½å‡å°‘ç±»å’Œæ–¹æ³•çš„æ•°é‡ ä»¥ä¸Šè§„åˆ™æŒ‰é‡è¦ç¨‹åº¦æ’åº ç®€å•è®¾è®¡è§„åˆ™ 1ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š å…¨é¢æµ‹è¯•å¹¶æŒç»­é€šè¿‡æ‰€æœ‰æµ‹è¯•çš„ç³»ç»Ÿï¼Œå°±æ˜¯å¯æµ‹è¯•çš„ç³»ç»Ÿ ä¸å¯æµ‹è¯•çš„ç³»ç»Ÿä¸å¯éªŒè¯ï¼Œä¸å¯éªŒè¯çš„ç³»ç»Ÿï¼Œä¸å¯éƒ¨ç½² ç´§è€¦åˆçš„ä»£ç éš¾ä»¥ç¼–å†™æµ‹è¯•ï¼ŒåŒæ ·ç¼–å†™æµ‹è¯•è¶Šå¤šï¼Œå°±è¶Šä¼šéµå¾ª DIP ä¹‹ç±»è§„åˆ™ éµå¾ªæœ‰å…³ç¼–å†™æµ‹è¯•å¹¶æŒç»­è¿è¡Œæµ‹è¯•çš„ç®€å•ã€æ˜ç¡®çš„è§„åˆ’ï¼Œç³»ç»Ÿå°±ä¼šæ›´è´´è¿‘ OO ä½è€¦åˆåº¦ã€é«˜å†…èšåº¦çš„ç›®æ ‡ï¼Œç¼–å†™æµ‹è¯•å¼•è‡´æ›´å¥½çš„è®¾è®¡ ç®€å•è®¾è®¡è§„åˆ™ 2~4ï¼šé‡æ„ï¼š æµ‹è¯•æ¶ˆé™¤äº†å¯¹æ¸…ç†ä»£ç å°±ä¼šç ´åä»£ç çš„ææƒ§ å¢é‡å¼é‡æ„æ”¹å–„ä»£ç  æå‡å†…èšæ€§ã€é™ä½è€¦åˆåº¦ã€åˆ‡åˆ†å…³æ³¨é¢ã€æ¨¡å—åŒ–ç³»ç»Ÿæ€§å…³æ³¨é¢ã€ç¼©å°å‡½æ•°å’Œç±»çš„å°ºå¯¸ã€é€‰ç”¨æ›´å¥½çš„åç§°ç­‰ ä¸å¯é‡å¤ï¼š é‡å¤åŒ…æ‹¬å½¢å¼ä¸Šå’Œå®ç°ä¸Šçš„é‡å¤ æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§ç§»é™¤é«˜å±‚é‡å¤çš„é€šç”¨æŠ€å·§ è¡¨è¾¾åŠ›ï¼š è½¯ä»¶é¡¹ç›®çš„ä¸»è¦æˆæœ¬åœ¨äºé•¿æœŸç»´æŠ¤ é€‰ç”¨å¥½çš„åç§° ä¿æŒå‡½æ•°å’Œç±»å°ºå¯¸çŸ­å° é‡‡ç”¨æ ‡å‡†å‘½åæ³• ç¼–å†™è‰¯å¥½çš„å•å…ƒæµ‹è¯• åšåˆ°æœ‰è¡¨å¸¦æœ€é‡è¦çš„æ˜¯å°è¯•ï¼Œå¤ªå¤šæ—¶å€™æˆ‘ä»¬å†™å‡ºèƒ½å·¥ä½œçš„ä»£ç ï¼Œå°±è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œæ²¡æœ‰ä¸‹è¶³åŠŸå¤«è°ƒæ•´ å°½å¯èƒ½å‡å°‘ç±»å’Œæ–¹æ³•ï¼š ç±»å’Œæ–¹æ³•çš„æ•°é‡å¤ªå¤šï¼Œæœ‰æ—¶å€™æ˜¯ç”±æ¯«æ— æ„ä¹‰çš„æ•™æ¡ä¸»ä¹‰å¯¼è‡´çš„ ä¿æŒå‡½æ•°å’Œç±»çŸ­å°çš„åŒæ—¶ï¼Œä¿æŒæ•´ä¸ªç³»ç»ŸçŸ­å°ç²¾æ‚ éµå¾ªç®€å•è®¾è®¡çš„å®è·µæ‰‹æ®µï¼Œå¼€å‘è€…ä¸å¿…å¹´è½»å­¦ä¹ å°±èƒ½æŒæ¡å¥½çš„åŸåˆ™å’Œæ¨¡å¼ å¹¶å‘ç¼–ç¨‹â€œå¯¹è±¡æ˜¯å¯¹è¿‡ç¨‹çš„æŠ½è±¡ï¼Œçº¿ç¨‹æ˜¯å¯¹è°ƒåº¦çš„æŠ½è±¡â€ ä¸ºä»€ä¹ˆè¦å¹¶å‘ï¼š å¹¶å‘æ˜¯ä¸€ç§è§£è€¦ç­–ç•¥ï¼ŒæŠŠåšä»€ä¹ˆï¼ˆç›®çš„ï¼‰å’Œä½•æ—¶ï¼ˆæ—¶æœºï¼‰åˆ†å¼€ è§£è€¦ç›®çš„ä¸æ—¶æœºèƒ½æ˜æ˜¾åœ°æ”¹è¿›åº”ç”¨ç¨‹åºçš„ååé‡å’Œç»“æ„ è¯¯åŒºï¼š å¹¶å‘æ€»èƒ½æ”¹è¿›æ€§èƒ½ ç¼–å†™å¹¶å‘ç¨‹åºæ— éœ€ä¿®æ”¹è®¾è®¡ å®é™…ï¼š å¹¶å‘ä¼šåœ¨æ€§èƒ½å’Œç¼–å†™é¢å¤–ä»£ç ä¸Šå¢åŠ é¢å¤–ä¸€äº›å¼€é”€ æ­£ç¡®çš„å¹¶å‘æ˜¯å¤æ‚çš„ï¼Œå‡ éå¯¹äºç®€å•çš„é—®é¢˜ä¹Ÿæ˜¯å¦‚æ­¤ å¹¶å‘ç¼ºé™·å¹¶éæ€»èƒ½é‡ç° å¹¶å‘å¸¸å¸¸éœ€è¦å¯¹è®¾è®¡ç­–ç•¥çš„æ ¹æœ¬æ€§ä¿®æ”¹ å¹¶å‘é˜²å¾¡åŸåˆ™ï¼š å•ä¸€æƒè´£åŸåˆ™ï¼š åˆ†ç¦»å¹¶å‘ç›¸å…³çš„ä»£ç å’Œå…¶å®ƒä»£ç  æ¨è®ºï¼šé™åˆ¶æ•°æ®ä½œç”¨åŸŸï¼š ä¿æŠ¤ä¸´ç•ŒåŒºå…±äº«å¯¹è±¡ è°¨è®°æ•°æ®å°è£…ï¼Œä¸¥æ ¼é™åˆ¶å¯¹å¯èƒ½è¢«å…±äº«çš„æ•°æ®çš„è®¿é—® æ¨è®ºï¼šä½¿ç”¨æ•°æ®å‰¯æœ¬ æ¨è®ºï¼šçº¿ç¨‹åº”å°½å¯èƒ½ç‹¬ç«‹ï¼šå°è¯•å°†æ•°æ®åˆ†è§£åˆ°å¯è¢«ç‹¬ç«‹çº¿ç¨‹ï¼ˆå¯èƒ½ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼‰æ“ä½œçš„ç‹¬ç«‹å­é›† äº†è§£æ‰§è¡Œæ¨¡å‹ï¼š å‡ ç§æ¦‚å¿µï¼š é™å®šèµ„æº äº’æ–¥ çº¿ç¨‹é¥¥é¥¿ æ­»é” æ´»é”ï¼šæ‰§è¡Œæ¬¡åºä¸€è‡´çš„çº¿ç¨‹ï¼Œæ¯ä¸ªéƒ½æƒ³èµ·æ­¥ï¼Œä½†å‘ç°å…¶ä»–çº¿ç¨‹å·²ç»åœ¨è·¯ä¸Š ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼šä¸­é—´é˜Ÿåˆ—æ˜¯é™å®šèµ„æº è¯»è€…-å†™ç€æ¨¡å‹ å®´å¸­å“²å­¦å®¶ ä¿æŒåŒæ­¥åŒºåŸŸå¾®å°ï¼šå°½å¯èƒ½å‡å°‘åŒæ­¥åŒºåŸŸï¼Œå¦åˆ™ä¼šå¢åŠ èµ„æºç«äº‰ï¼Œæ‰§è¡Œæ•ˆç‡é™ä½ å°½æ—©è€ƒè™‘å…³é—­é—®é¢˜ï¼Œå°½æ—©ä»¤å…¶æ­£å¸¸å·¥ä½œ æµ‹è¯•çº¿ç¨‹ä»£ç ï¼š å»ºè®®ç¼–å†™æœ‰æ½œåŠ›æš´éœ²é—®é¢˜çš„æµ‹è¯•ï¼Œåœ¨ä¸åŒçš„é…ç½®å’Œè´Ÿè½½ä¸‹é¢‘ç¹è¿è¡Œã€‚å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œåˆ™è·Ÿè¸ªé”™è¯¯ å°†ä¼ªå¤±è´¥çœ‹åšå¯èƒ½çš„çº¿ç¨‹é—®é¢˜ å…ˆä½¿ç”¨å•çº¿ç¨‹ä»£ç å¯å·¥ä½œ ç¼–å†™å¯æ’æ‹”çš„çº¿ç¨‹ä»£ç  ç¼–å†™å¯è°ƒæ•´çš„çº¿ç¨‹ä»£ç  è¿è¡Œå¤šäºå¤„ç†å™¨æ•°é‡çš„çº¿ç¨‹ åœ¨ä¸åŒå¹³å°ä¸Šè¿è¡Œ è°ƒæ•´ä»£ç å¹¶å¼ºè¿«å‘ç”Ÿé”™è¯¯ ä¸è¦å°†ç³»ç»Ÿé”™è¯¯å½’å’äºå¶å‘äº‹ä»¶ ä»»åŠ¡äº¤æ¢è¶Šé¢‘ç¹ï¼Œè¶Šæœ‰å¯èƒ½æ‰¾åˆ°é”™è¿‡ä¸´ç•ŒåŒºæˆ–å¯¼è‡´æ­»é”çš„ä»£ç  Code Smell &amp; Inspiration æ³¨é‡Šï¼š ä¸æ°å½“çš„æ³¨é‡Š åºŸå¼ƒçš„æ³¨é‡Š å†—ä½™çš„æ³¨é‡Š ç³Ÿç³•çš„æ³¨é‡Š æ³¨é‡Šæ‰çš„ä»£ç  ç¯å¢ƒï¼š éœ€è¦å¤šæ­¥æ‰èƒ½å®ç°çš„æ„å»ºï¼šæ„å»ºç³»ç»Ÿåº”è¯¥æ˜¯å•æ­¥çš„å°æ“ä½œ éœ€è¦å¤šæ­¥æ‰èƒ½åšåˆ°çš„æµ‹è¯•ï¼šåº”è¯¥èƒ½å¿«é€Ÿè¿è¡Œå•å…ƒæµ‹è¯• å‡½æ•°ï¼š è¿‡å¤šçš„å‚æ•° è¾“å‡ºå‚æ•° æ ‡å¿—å‚æ•° æ­»å‡½æ•° ä¸€èˆ¬æ€§é—®é¢˜ï¼š ä¸€ä¸ªæºæ–‡ä»¶ä¸­å­˜åœ¨å¤šç§è¯­è¨€ï¼šåº”å°½åŠ›å‡å°‘æºæ–‡ä»¶ä¸­é¢å¤–è¯­è¨€çš„æ•°é‡å’ŒèŒƒå›´ æ˜æ˜¾çš„è¡Œä¸ºæœªå®ç°ï¼šåº”éµå¾ªâ€œæœ€å°æƒŠè®¶åŸåˆ™â€ ä¸æ­£ç¡®çš„è¾¹ç•Œè¡Œä¸º å¿½è§†å®‰å…¨ é‡å¤ åœ¨é”™è¯¯çš„æŠ½è±¡å±‚çº§ä¸Šçš„ä»£ç ï¼š åˆ›å»ºåˆ†ç¦»è¾ƒé«˜å±‚ä¸€èˆ¬æ€§æ¦‚å¿µä¸è¾ƒä½å±‚ç»†èŠ‚æ¦‚å¿µçš„æŠ½è±¡æ¨¡å‹å¾ˆé‡è¦ å­¤ç«‹æŠ½è±¡æ˜¯è½¯ä»¶å¼€å‘è€…æœ€éš¾åšåˆ°çš„äº‹æƒ…ä¹‹ä¸€ï¼Œè€Œä¸”ä¸€æ—¦åšé”™ä¹Ÿæ²¡æœ‰å¿«æ·çš„ä¿®å¤æ‰‹æ®µ åŸºç±»ä¾èµ–äºæ´¾ç”Ÿç±»ï¼šé€šå¸¸åŸºç±»å¯¹æ´¾ç”Ÿç±»ä¸€æ— æ‰€çŸ¥ ä¿¡æ¯è¿‡å¤šï¼š è‰¯å¥½è®¾è®¡çš„æ¨¡å—æœ‰éå¸¸å°çš„æ¥å£ ä¼˜ç§€å¼€å‘è€…åº”è¯¥é™åˆ¶ç±»æˆ–è€…æ¨¡å—ä¸­æš´éœ²çš„æ¥å£æ•°é‡ éšè—æ•°æ®ã€å·¥å…·å‡½æ•°ã€å¸¸é‡ã€ä¸´æ—¶å˜é‡ æ­»ä»£ç ï¼šæ­»ä»£ç ä¼šå˜è‡­ å‚ç›´åˆ†ç¦»ï¼š å˜é‡å’Œå‡½æ•°åº”è¯¥é è¿‘è¢«ä½¿ç”¨çš„åœ°æ–¹å®šä¹‰ ç§æœ‰å‡½æ•°åº”è¯¥åˆšå¥½åœ¨å…¶é¦–æ¬¡è¢«ä½¿ç”¨çš„ä½ç½®ä¸‹é¢å®šä¹‰ å‰åä¸ä¸€è‡´ æ··æ·†è§†å¬ï¼š æ²¡æœ‰ç”¨åˆ°çš„å˜é‡ã€å‡½æ•°ã€æ³¨é‡Šç­‰éƒ½è¦ç§»é™¤ ä¿æŒæ–‡ä»¶æ•´æ´ã€è‰¯å¥½ç»„ç»‡ äººä¸ºè€¦åˆï¼šäººä¸ºè€¦åˆæ˜¯æŒ‡ä¸¤ä¸ªæ²¡æœ‰ç›´æ¥ç›®çš„çš„æ¨¡å—çš„è€¦åˆ ç‰¹æ€§ä¾æ‹ï¼šç±»çš„æ–¹æ³•åªåº”å¯¹å…¶æ‰€å±ç±»çš„å˜é‡å’Œå‡½æ•°æ„Ÿå…´è¶£ï¼Œä¸åº”è¯¥å‚é’å…¶ä»–ç±»ä¸­çš„å˜é‡å’Œå‡½æ•° é€‰æ‹©æ ‡å¿—å‚æ•°ï¼šé€‰æ‹©æ ‡å¿—å‚æ•°åªæ˜¯ä¸€ç§é¿å…æŠŠå¤§å‡½æ•°åˆ‡åˆ†æˆå°å‡½æ•°å·æ‡’çš„åšæ³• æ™¦æ¶©çš„æ„å›¾ ä½ç½®é”™è¯¯çš„æƒè´£ ä¸æ°å½“çš„é™æ€æ–¹æ³• ä½¿ç”¨è§£é‡Šæ€§å˜é‡ å‡½æ•°åç§°åº”è¯¥è¡¨è¾¾å…¶è¡Œä¸º ç†è§£ç®—æ³• æŠŠé€»è¾‘ä¾èµ–æ”¹ä¸ºç‰©ç†ä¾èµ– ç”¨å¤šæ€æ›¿æ¢ if/else éµå¾ªçº¦å®šæ ‡å‡† ç”¨å‘½åå¸¸é‡æ›¿ä»£é­”æœ¯æ•° å‡†ç¡®ï¼šå¦‚æœå¤„ç†è´§å¸ï¼Œè¯·ä½¿ç”¨æ•´æ•° ç»“æ„ç”šäºçº¦å®šï¼š å°è£…æ¡ä»¶ é¿å…å¦å®šæ€§æ¡ä»¶ å‡½æ•°åªåšä¸€ä»¶äº‹æƒ… æ©è”½æ—¶åºè€¦åˆ åˆ«éšæ„ å°è£…è¾¹ç•Œæ¡ä»¶ å‡½æ•°åº”è¯¥åªåœ¨ä¸€ä¸ªæŠ½è±¡å±‚çº§ä¸Š åœ¨è¾ƒé«˜å±‚çº§æ”¾ç½®å¯é…ç½®æ•°æ® é¿å…ä¼ é€’æµè§ˆ åç§°ï¼š é‡‡ç”¨æè¿°æ€§åç§° åç§°åº”ä¸æŠ½è±¡å±‚çº§ç›¸ç¬¦ å°½å¯èƒ½ä½¿ç”¨æ ‡å‡†å‘½åæ³• æ— æ­§ä¹‰çš„åç§° ä¸ºè¾ƒå¤§ä½œç”¨èŒƒå›´é€‰ç”¨è¾ƒé•¿çš„åç§° é¿å…ç¼–ç ï¼šå¦‚ä¸€äº›å‰ç¼€ç­‰ åç§°åº”è¯¥è¯´æ˜å‰¯ä½œç”¨ æµ‹è¯•ï¼š æµ‹è¯•ä¸è¶³ ä½¿ç”¨è¦†ç›–ç‡å·¥å…· åˆ«ç•¥è¿‡å°æµ‹è¯• è¢«å¿½ç•¥çš„æµ‹è¯•å°±æ˜¯å¯¹ä¸ç¡®å®šäº‹ç‰©çš„ç–‘é—® æµ‹è¯•è¾¹ç•Œæ¡ä»¶ å…¨é¢æµ‹è¯•ç›¸è¿‘çš„ç¼ºé™· æµ‹è¯•å¤±è´¥çš„æ¨¡å¼æœ‰å¯å‘æ€§ æµ‹è¯•åº”è¯¥å¿«é€Ÿ]]></content>
      <categories>
        <category>ç¼–ç¨‹ä¹‹é“</category>
      </categories>
      <tags>
        <tag>æ•´æ´ä»£ç </tag>
        <tag>ç¼–ç¨‹é£æ ¼</tag>
      </tags>
  </entry>
</search>
