<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é»‘ç™½ä¹‹é™¢</title>
  
  <subtitle>Valar Morghulis</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://ifaceless.space/"/>
  <updated>2020-01-21T03:45:37.518Z</updated>
  <id>http://ifaceless.space/</id>
  
  <author>
    <name>iFaceless</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust async-std å…¥é—¨</title>
    <link href="http://ifaceless.space/2020/01/20/rust-async-std-intro/"/>
    <id>http://ifaceless.space/2020/01/20/rust-async-std-intro/</id>
    <published>2020-01-20T10:00:40.000Z</published>
    <updated>2020-01-21T03:45:37.518Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æ‰“ç®—åŸºäº Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚</p><p><a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ <code>async-std</code> ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª <code>task</code> æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ <code>thread</code> æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ <code>async/await</code> é£æ ¼çš„ <code>Mutex</code> åŸè¯­ã€‚</p><a id="more"></a><p>Rust ä¸­æœ‰ä¸¤ç§ç±»å‹çš„ <code>Future</code>ï¼š</p><ol><li>æºè‡ª<a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">æ ‡å‡†åº“</a>çš„ <code>std::future::Future</code></li><li>æºè‡ª <a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  çš„ <code>futures::future::Future</code></li></ol><p>èƒŒæ™¯æ˜¯è¿™æ ·çš„ï¼Œ<a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  ä¸­å®šä¹‰çš„ future æ˜¯ Future ç±»å‹æœ€åˆçš„å®ç°ã€‚Rust ä¸ºäº†æ”¯æŒ <code>async/await</code> è¯­æ³•ï¼Œå°±æŠŠæ ¸å¿ƒçš„ <code>trait Future</code> è½¬ç§»åˆ°äº†æ ‡å‡†åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„ <code>std::future::Future</code>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>std::future::Future</code> çœ‹ä½œæ˜¯ <code>futures::future::Future</code> çš„æœ€å°å­é›†ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä¸¥æ ¼åŒºåˆ† <code>std::future::Future</code> å’Œ <code>futures::future::Future</code>ï¼Œä»¥åŠ <code>async-std</code> æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„ã€‚æ€»çš„æ¥è¯´ï¼Œæ™®é€šçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯ä¸ä¼šå’Œ <code>std::future::Future</code> æ‰“äº¤é“çš„ï¼ˆé™¤äº†ä½¿ç”¨ <code>.await</code> è°ƒç”¨ï¼‰ã€‚é€šå¸¸åªæœ‰å®ç° <code>Future</code> çš„å¼€å‘è€…æ‰ä¼šå…³æ³¨ <code>std::future::Future</code> çš„å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚è¿‡å»å¾ˆå¤šåœ¨ <code>Future</code> ä¸­å®šä¹‰çš„åŠŸèƒ½éƒ½è¢«ç§»åŠ¨åˆ°äº† <code>FuturesExt</code> æ‰©å±• trait ä¸­ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† <code>futures</code> åº“å½“ä½œæ˜¯æ ¸å¿ƒ Rust å¼‚æ­¥åŠŸèƒ½çš„æ‰©å±•ã€‚</p><p>é‚£ä¹ˆï¼Œä¸Šé¢ä¸€ç›´æåˆ°çš„ Futures ç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿåˆæ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œ<strong>Futures å°±æ˜¯å¯¹äºä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ä¸€ç§æŠ½è±¡</strong>ï¼Œå®ƒä»¬å…¶å®ä»€ä¹ˆä¹Ÿä¸åšã€‚é‚£ä¹ˆæ€ä¹ˆæ¨è¿›æ‰§è¡Œå¹¶è·å¾—ç»“æœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é æ‰§è¡Œå™¨ <code>executor</code>ï¼Œå®ƒä¼šå†³å®š<strong>ä½•æ—¶</strong>åŠ<strong>å¦‚ä½•</strong>æ‰§è¡Œä½ çš„ Futuresã€‚<code>async-std::task</code> æ¨¡å—å°±ä¸ºæˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ‰§è¡Œå™¨æ¥å£ã€‚</p><h1 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h1><p>Rust æœ‰ä¸ªéå¸¸äº®çœ¼çš„ç‰¹æ€§å«<a href="https://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html" target="_blank" rel="noopener">ã€Œæ— è°“å¹¶å‘ã€</a>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨è·å¾—å¹¶å‘ç‰¹æ€§çš„åŒæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰çš„é—®é¢˜ï¼ˆç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥åˆ°æ•°æ®ç«äº‰çš„é—®é¢˜ï¼‰ã€‚</p><p>Futures æ˜¯å¯¹<strong>è®¡ç®—</strong>çš„æŠ½è±¡ï¼Œå®ƒä»¬æè¿°äº†ã€Œåšä»€ä¹ˆï¼ˆwhatï¼‰ã€ï¼Œä½†æ˜¯ä¸ã€Œåœ¨å“ªå„¿ï¼ˆwhereï¼‰ã€ã€ã€Œä»€ä¹ˆæ—¶å€™ï¼ˆwhenï¼‰ã€æ‰§è¡Œæ˜¯åˆ†å¼€çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ä»£ç æ‰“æ•£æˆå°æ®µçš„ã€å¯ç»„åˆçš„è¡Œä¸ºï¼Œè¿™æ ·å¯ä»¥ä½œä¸ºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ‰§è¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯<strong>è®¡ç®—</strong>ï¼ˆcompute thingsï¼‰ï¼Œå¹¶æ‰¾åˆ°å¯ä»¥æŠ½è±¡çš„åœ°æ–¹ã€‚</p><h2 id="Send-å’Œ-Sync"><a href="#Send-å’Œ-Sync" class="headerlink" title="Send å’Œ Sync"></a>Send å’Œ Sync</h2><p>Rust å®‰å…¨å¹¶å‘ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æŠ½è±¡ï¼ˆMarkersï¼‰ï¼š<code>Send</code> å’Œ <code>Sync</code>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ç®€å•çš„ä»‹ç»ï¼š</p><ul><li><code>Send</code> æ ‡è®°çš„æ•°æ®ç±»å‹æ˜¯å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªè®¡ç®—ï¼ˆcomputationï¼‰<strong>è½¬ç§»åˆ°ï¼ˆmovedï¼‰</strong>å¦å¤–ä¸€ä¸ªå¹¶å‘è®¡ç®—ï¼ˆæ‰€æœ‰æƒä¹ŸåŒæ ·è¢«è½¬ç§»äº†ï¼Œå‘é€æ–¹å°†ä¸èƒ½å†è®¿é—®å®ƒï¼‰ã€‚</li><li><code>Sync</code> æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸­<strong>å…±äº«ï¼ˆsharingï¼‰</strong>æ•°æ®ã€‚</li></ul><p>ä»¥ä¸Šæ²¡æœ‰ä½¿ç”¨ <code>thread</code> å³çº¿ç¨‹è¿™æ ·çš„å­—çœ¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æŠ½è±¡çš„ <code>computation</code>ã€‚<code>Send</code> å’Œ <code>Sync</code> æœ€å¼ºå¤§çš„ç‰¹ç‚¹åœ¨äºå®ƒä¸ºæˆ‘ä»¬å‡è½»äº†çŸ¥é“å…±äº«ä»€ä¹ˆçš„è´Ÿæ‹…ã€‚åœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¯¹äºç›¸åº”çš„æ•°æ®ç±»å‹é‡‡ç”¨ä»€ä¹ˆåˆ†äº«æ–¹å¼å³å¯ã€‚</p><p>å…³äº <code>Send</code> å’Œ <code>Sync</code> çš„ç»„åˆè¿˜æœ‰æ›´å¤šæœ‰è¶£çš„ç‰¹æ€§ï¼Œå¯ä»¥å‚è€ƒ <a href="https://doc.rust-lang.org/stable/book/ch16-04-extensible-concurrency-sync-and-send.html" target="_blank" rel="noopener">Rust Book</a> äº†è§£æ›´å¤šã€‚</p><h2 id="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"><a href="#ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰" class="headerlink" title="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"></a>ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰</h2><p>æ‰€è°“çš„è®¡ç®—ï¼ˆcomputationï¼‰æ˜¯æŒ‡ä¸€ä¸ªå¯ç»„åˆçš„æ“ä½œåºåˆ—ï¼Œå¯ä»¥åŸºäºå†³ç­–åˆ†æ”¯ï¼Œå¯ä»¥ä¸€ç›´æ¨è¿›è¿è¡Œåˆ°ç»“æŸï¼Œæœ€ç»ˆè¿”å›ç»“æœæˆ–è€…é”™è¯¯ã€‚</p><h2 id="å»¶è¿Ÿè®¡ç®—"><a href="#å»¶è¿Ÿè®¡ç®—" class="headerlink" title="å»¶è¿Ÿè®¡ç®—"></a>å»¶è¿Ÿè®¡ç®—</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œ<code>Send</code> å’Œ <code>Sync</code> éƒ½æ˜¯æè¿°æ•°æ®çš„ï¼›ä½†åº”ç”¨ç¨‹åºå¯ä¸æ­¢æ•°æ®ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“å¦‚ä½•è®¡ç®—å‡ºæ•°æ®ï¼Œç”±æ­¤å¼•å…¥äº† <code>Futures</code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>Futures</code> æ˜¯æ€ä¹ˆå…è®¸æˆ‘ä»¬ç”¨è‡ªç„¶è¯­è¨€è¡¨è¾¾è¦åšçš„äº‹æƒ…çš„ï¼Œ<code>Futures</code> ä»è¿™æ ·çš„è®¡åˆ’ï¼š</p><ul><li>Do X</li><li>If X succeeded, do Y</li></ul><p>å˜æˆäº†ï¼š</p><ul><li>Start doing X</li><li>Once X succeeds, start doing Y</li></ul><p>ç›¸æ¯”äºå‘Šè¯‰è®¡ç®—æœºè¦åšä»€ä¹ˆï¼Œå¹¶ä¸”æ ¹æ®å½“å‰ç»“æœå†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼›å»¶è¿Ÿè®¡ç®—å°±æ˜¯è®©æˆ‘ä»¬å‘Šè¯‰è®¡ç®—æœºè¦å¼€å§‹åšä»€ä¹ˆï¼Œå¹¶å“åº”<strong>æœªæ¥</strong>å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶ã€‚</p><h2 id="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"><a href="#ä»ç®€å•çš„ä¾‹å­å¼€å§‹" class="headerlink" title="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"></a>ä»ç®€å•çš„ä¾‹å­å¼€å§‹</h2><p>ä¸‹é¢çš„ä¾‹å­æ˜¯ä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents)?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œä¹Ÿå¾ˆç›´è§‚ã€‚é—®é¢˜æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œæ§åˆ¶æƒå°±ä¼šè½¬ç§»è‡³è¢«è°ƒç”¨çš„å‡½æ•°ç›´åˆ°å…¶è¿”å›ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸Šè¿°è¿”å›å€¼æè¿°çš„æ˜¯è¿‡å»ã€‚è€Œè¿‡å»å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæ‰€æœ‰çš„å†³ç­–éƒ½å·²ç»ç¡®å®šäº†ã€‚ä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜ç‚¹ï¼šè¿”å›çš„ç»“æœå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç¨‹åºè¿‡å»è®¡ç®—çš„ç»“æœè§£åŒ…ï¼ˆunwrapï¼‰å‡ºæ¥ï¼Œç„¶åå†³å®šå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><p>ä½†æˆ‘ä»¬è¿˜æ˜¯æƒ³è¦æŠ½è±¡è®¡ç®—ï¼Œå¹¶è®©åˆ«äººé€‰æ‹©å¦‚ä½•è¿è¡Œå®ƒã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ç±»å‹ï¼Œå¯ä»¥æè¿°è®¡ç®—è¿‡ç¨‹ï¼Œä½†æ˜¯åˆä¸æ‰§è¡Œå®ƒã€‚ğŸ‘† ä¸Šé¢çš„å‡½æ•°åªèƒ½è®©æˆ‘ä»¬åœ¨è°ƒç”¨å‰æˆ–è€…è°ƒç”¨åæ‰§è¡Œæ“ä½œã€‚è¿™å…¶å®å¹¶éé¢„æœŸçš„ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨åœ¨è¿è¡Œçš„æ—¶å€™åšç‚¹åˆ«çš„äº‹æƒ…ï¼ˆå®é™…ä¸Šå°±æ˜¯èƒ½å¤Ÿæ‰“æ–­æ‰§è¡Œæµï¼‰ã€‚å½“åœ¨å¹¶è¡Œç¼–ç¨‹æ—¶ï¼Œè¿™ä¹Ÿå‰¥å¤ºäº†æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡è¿è¡Œæ—¶å¯åŠ¨å¦å¤–ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡çš„èƒ½åŠ›ï¼ˆè¿™æ—¶æ§åˆ¶æƒå·²ç»è½¬ç§»ç»™æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°äº†ï¼‰ã€‚</p><p>æ­¤å¤„è™½ç„¶å¯ä»¥å¼•å…¥çº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æœ¬èº«æ˜¯éå¸¸ç‰¹å®šçš„å¹¶å‘åŸè¯­ï¼Œè€Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾çš„æ˜¯ä¸€ç§<strong>æŠ½è±¡</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ ·çš„æŠ½è±¡å°±æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªè¿›è¡Œä¸­çš„å·¥ä½œï¼Œä¼šåœ¨æœªæ¥äº§ç”Ÿç»“æœã€‚ä¸‹é¢çœ‹çœ‹éå®Œæ•´å®šä¹‰çš„ <code>Future</code> traitï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Future</span></span> &#123;</span><br><span class="line">    <span class="comment">// Ouput æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œè¡¨ç¤ºè¾“å‡ºç»“æœçš„æ³›å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span>;</span><br><span class="line">    <span class="comment">// poll æ–¹æ³•ä¼šè¿”å›å½“å‰è®¡ç®—çš„çŠ¶æ€ï¼Œpoll æ–¹æ³•ä¼šè¿”å›ä¸¤ç§ç»“æœï¼š</span></span><br><span class="line">    <span class="comment">// 1. `Poll::Ready`ï¼Œè¡¨ç¤ºè®¡ç®—ç»“æŸ</span></span><br><span class="line">    <span class="comment">// 2. `Poll::Pending`ï¼Œè¡¨ç¤ºè®¡ç®—å°šæœªç»“æŸ</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context) -&gt; Poll&lt;Self::Output&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>poll()</code> æ–¹æ³•æ£€æŸ¥ <code>Future</code> æ˜¯å¦å®Œæˆï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™è¿”å›å¯¹åº”çš„ç»“æœã€‚æ˜¾ç„¶ï¼Œæœ€ç®€å•çš„æœºåˆ¶å°±æ˜¯åœ¨å¾ªç¯ä¸­ä¸æ–­è½®è¯¢ï¼›ä¸è¿‡æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æˆç†Ÿçš„ runtime æ¥æ‰§è¡Œã€‚<em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>poll()</code> è¿”å› <code>Poll::Ready</code> åï¼Œç»§ç»­è°ƒç”¨å¯èƒ½ä¼šæœ‰ä»¤äººå›°æƒ‘çš„è¡Œä¸ºäº§ç”Ÿï¼Œå…·ä½“å¯ä»¥å‚è§ <a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">futures-docs</a></em>ã€‚</p><h2 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h2><p>å®é™…ä¸Š <code>Future</code> åœ¨ Rust ä¸­å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´äº†ï¼Œåªæ˜¯ç›´æ¥æ„å»ºå’Œæè¿°å®ƒä»¬æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œ<code>async</code> å…³é”®è¯å°±æ˜¯æˆ‘ä»¬çš„æ•‘æ˜Ÿï¼Œä¸‹é¢çš„ä¾‹å­ä¸­æ¼”ç¤ºäº† <code>async-std</code> æ­é… <code>async/await</code> é‡æ„ä¸Šé¢çš„å‡½æ•°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async æ ‡è®°å‡½æ•°ä½“æ˜¯ä¸€ä¸ªå»¶è¿Ÿè®¡ç®—å¯¹è±¡ï¼Œå½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª `Future&lt;Output = io::Result&lt;string&gt;&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">// è¯¥å€¼å¹¶éç«‹å³è¿”å›çš„ç»“æœ `io::Result&lt;String&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">//ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯äº§ç”Ÿäº†å®ç°äº† `Future&lt;Output = io::Result&lt;String&gt;&gt;` çš„ç±»å‹ï¼‰ã€‚</span></span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="await-å¹²äº†ä»€ä¹ˆ"><a href="#await-å¹²äº†ä»€ä¹ˆ" class="headerlink" title=".await å¹²äº†ä»€ä¹ˆ"></a><code>.await</code> å¹²äº†ä»€ä¹ˆ</h2><p>é¡¾åæ€ä¹‰ï¼Œ<code>.await</code> è¡¨ç¤ºç­‰å¾…è¯·æ±‚è¡Œä¸ºï¼ˆrequested actionï¼‰ç›´åˆ°å®Œæˆï¼Œç„¶åæ‰ä¼šç»§ç»­åç»­çš„æ‰§è¡Œã€‚å‡†ç¡®çš„æ¥è¯´ï¼Œ<code>.await</code> æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºæ­¤å¤„çš„ä»£ç å°†ä¼šç­‰å¾…ç›´åˆ° <code>Future</code> äº§ç”Ÿç»“æœã€‚è‡³äº Future æ˜¯æ€ä¹ˆç»“æŸçš„ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚<code>.await</code> ä¼šè®©è¿è¡Œæ—¶æŒæ§è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œè‡³äºåœ¨è®¡ç®—ç»“æŸæ—¶è¦æ‰§è¡Œå“ªäº›æ“ä½œéƒ½ç”±è¿è¡Œæ—¶æ¥æ“å¿ƒã€‚å½“ä½ ç¼–å†™çš„æ“ä½œåœ¨åå°å®Œæˆæ—¶ï¼Œå®ƒä¼šå›åˆ°æ ‡è®°ç‚¹ï¼Œç»§ç»­åç»­çš„æ“ä½œã€‚æ‰€ä»¥è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¸º <strong>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆevented programmingï¼‰</strong>ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç­‰å¾…æŸäº›äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶ï¼‰ï¼Œå¹¶æ®æ­¤ä½œå‡ºå“åº”ï¼ˆæ¯”å¦‚å¼€å§‹è¯»å–å†…å®¹ï¼‰ã€‚</p><p>å½“æœ‰ 2 ä¸ªåŠä»¥ä¸Šè¿™æ ·çš„å‡½æ•°åœ¨åŒæ—¶è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„è¿è¡Œæ—¶ç³»ç»Ÿå°±èƒ½å¤Ÿå¤„ç†å½“å‰æ‰€æœ‰è¿›è¡Œçš„äº‹ä»¶äº†ï¼Œé¿å…äº†å‚»å‚»åœ°ç­‰å¾…ã€‚</p><h1 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h1><p>æˆ‘ä»¬å·²ç»çŸ¥é“ä»€ä¹ˆæ˜¯ Futures äº†ï¼Œé‚£å…·ä½“æ€ä¹ˆè¿è¡Œå®ƒä»¬å‘¢ï¼Ÿè¿™å°±æ˜¯æ¥ä¸‹æ¥è¦ä»‹ç»çš„ <code>tasks</code> æ¨¡å—è¦åšçš„äº‹æƒ…ã€‚ä¸‹é¢çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::&#123;fs::File, io, prelude::*, task&#125;;</span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file: File = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// `spawn` æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `Future`ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œå®ƒã€‚</span></span><br><span class="line">    <span class="comment">// è¯¥å‡½æ•°ä¼šè¿”å› `JoinHanle`ã€‚</span></span><br><span class="line">    <span class="keyword">let</span> reader_task = task::spawn(async &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å—ï¼Œå¿…é¡»è¦ä½¿ç”¨å¼‚æ­¥å—æ‰èƒ½è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼ŒåŒæ—¶</span></span><br><span class="line">        <span class="comment">// ä¹Ÿä¼šå¼•å¯¼ç¼–è¯‘å™¨å°†æ‰€æœ‰ç›¸å…³çš„æŒ‡ä»¤åŒ…å«è¿›æ¥ã€‚Rust ä¸­æ‰€æœ‰çš„å—</span></span><br><span class="line">        <span class="comment">// éƒ½ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œ `async` å—åˆ™è¿”å›çš„æ˜¯ç±»å‹ä¸º </span></span><br><span class="line">        <span class="comment">// `Future` çš„å€¼</span></span><br><span class="line">        <span class="keyword">let</span> result = read_file(<span class="string">"data.csv"</span>).await;</span><br><span class="line">        <span class="keyword">match</span> result &#123;</span><br><span class="line">            <span class="literal">Ok</span>(s) =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, s),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">"Error reading &#123;:?&#125;"</span>, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Started task!"</span>);</span><br><span class="line">    task::block_on(reader_task);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Stopped task!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Rust çš„ Futures æœ‰æ—¶ä¹Ÿå«ã€Œå†·ï¼ˆcoldï¼‰ã€Futuresï¼Œä½ éœ€è¦è¿è¡Œå®ƒä»¬çš„ä¸œè¥¿ã€‚ä¸ºäº†è¿è¡Œä¸€ä¸ª Futureï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„è®°è´¦å·¥å…·ï¼šæ¯”å¦‚å½“å‰ Future æ˜¯å¦åœ¨è¿è¡Œä¸­è¿˜æ˜¯å·²ç»ç»“æŸï¼Œåœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå½“å‰çš„çŠ¶æ€ã€‚è¿™ç§è®°è´¦é€»è¾‘å°±è¢«æŠ½è±¡åˆ°äº† <code>Task</code> ä¸­ã€‚</p><p><code>Task</code> ç±»ä¼¼äº <code>Thread</code>ï¼Œä½†ä¹Ÿæœ‰äº›è®¸ä¸åŒï¼šå®ƒæ˜¯ç”±åº”ç”¨ç¨‹åºï¼ˆç”¨æˆ·ç©ºé—´ï¼‰è¢«è°ƒåº¦ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ä¼šæ„ŸçŸ¥ï¼›ä¸€æ—¦åˆ°äº†æŸä¸ªç‚¹éœ€è¦ç­‰å¾…ï¼Œåº”ç”¨ç¨‹åºè‡ªå·±éœ€è¦è´Ÿè´£å”¤é†’ä»»åŠ¡ã€‚<code>async_std</code> çš„ä»»åŠ¡å¯ä»¥æ‹¥æœ‰åç§°å’Œ IDã€‚</p><p>å½“é€šè¿‡ <code>spawn</code> ç”Ÿæˆä»»åŠ¡åï¼Œä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¿”å›çš„ <code>JoinHandle</code> æœ¬èº«æ˜¯ä¸€ä¸ª Futureï¼Œå®ƒä¼šåœ¨ <code>Task</code> è¿è¡Œç»“æŸåï¼ˆrun to conclusionï¼‰ä¹Ÿä¼šç»“æŸã€‚ç±»ä¼¼ <code>threads</code> å’Œ <code>join</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å¯¹ <code>JoinHandle</code> è°ƒç”¨ <code>block_on</code> å‡½æ•°ï¼Œä»è€Œé˜»å¡ç¨‹åºï¼ˆå‡†ç¡®æ¥è¯´æ˜¯è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ï¼‰ç›´åˆ°å…¶è¿è¡Œç»“æŸã€‚</p><h2 id="Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"><a href="#Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ" class="headerlink" title="Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"></a>Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ</h2><p>é€šè¿‡ç®€å•é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/block_on.rs#L129" target="_blank" rel="noopener">src/task/block_on.rs</a> çœ‹åˆ°æ‰§è¡Œçš„é€»è¾‘ï¼Œå½“ Task è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„  <code>run</code> å‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè¿›è€Œæ¨è¿› Future ä¸­çš„è®¡ç®—é€»è¾‘ç›´åˆ°å®Œæˆï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Blocks the current thread on a future's result.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F, T&gt;(future: F) -&gt; T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: Future&lt;Output = T&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    CACHE.with(|cache| &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Poll::Ready(t) = future.as_mut().poll(cx) &#123;</span><br><span class="line">                <span class="comment">// Save the parker for the next invocation of `block`.</span></span><br><span class="line">                cache.set(<span class="literal">Some</span>(arc_parker));</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Yield a few times or park the current thread.</span></span><br><span class="line">            <span class="keyword">if</span> step &lt; <span class="number">3</span> &#123;</span><br><span class="line">                thread::yield_now();</span><br><span class="line">                step += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                arc_parker.park();</span><br><span class="line">                step = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"><a href="#JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ" class="headerlink" title="JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"></a>JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ</h2><p>ç¿»é˜… <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/join_handle.rs#L15" target="_blank" rel="noopener">src/task/join_handle.rs</a> æºç å¾—çŸ¥ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°äº† <code>Future trait</code> çš„å¯¹è±¡ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;T&gt;(async_task::JoinHandle&lt;T, Task&gt;);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Future <span class="keyword">for</span> JoinHandle&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = T;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">mut</span> <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> Pin::new(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>).poll(cx) &#123;</span><br><span class="line">            Poll::Pending =&gt; Poll::Pending,</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ Noneï¼Œè¡¨ç¤ºä»»åŠ¡ panic æˆ–è€…è¢«å–æ¶ˆäº†</span></span><br><span class="line">            Poll::Ready(<span class="literal">None</span>) =&gt; <span class="built_in">panic!</span>(<span class="string">"cannot await the result of a panicked task"</span>),</span><br><span class="line">            <span class="comment">// å½“ä»»åŠ¡ç»“æŸï¼Œè‡ªç„¶ä¼šæ‹¿åˆ°å…·ä½“ç»“æœ</span></span><br><span class="line">            Poll::Ready(<span class="literal">Some</span>(val)) =&gt; Poll::Ready(val),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>async_std</code> ä¸­çš„ <code>JoinHandle</code> å®é™…æ˜¯å¯¹ <code>async_task::JoinHandle</code> çš„åŒ…è£…ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥çœ‹ä¸‹å…·ä½“æ˜¯æ€ä¹ˆä» Task ä¸­å–åˆ°ç»“æœçš„ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async-task-1.1.0/src/join_handle.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A handle that awaits the result of a task.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// * `None` è¡¨ç¤ºä»»åŠ¡è¢«å–æ¶ˆæˆ–è€… panic äº†</span></span><br><span class="line"><span class="comment">/// * `Some(result)` è¡¨ç¤ºä»»åŠ¡ç»“æŸï¼Œè¿”å›çš„ç»“æœ `result` ç±»å‹ä¸º `R`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="comment">/// A raw task pointer.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) raw_task: NonNull&lt;()&gt;,</span><br><span class="line">    <span class="comment">/// A marker capturing generic types `R` and `T`.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) _marker: PhantomData&lt;(R, T)&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Future <span class="keyword">for</span> JoinHandle&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = <span class="built_in">Option</span>&lt;R&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="keyword">self</span>.raw_task.as_ptr();</span><br><span class="line">        <span class="keyword">let</span> header = ptr <span class="keyword">as</span> *<span class="keyword">const</span> Header;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> state = (*header).state.load(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="comment">// If the task has been closed, notify the awaiter and return `None`.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; CLOSED != <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> Poll::Ready(<span class="literal">None</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// If the task is not completed, register the current task.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; COMPLETED == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»»åŠ¡å®Œæˆï¼Œæå–ç»“æœ</span></span><br><span class="line">                <span class="keyword">match</span> (*header).state.compare_exchange(</span><br><span class="line">                    state,</span><br><span class="line">                    state | CLOSED,</span><br><span class="line">                    Ordering::AcqRel,</span><br><span class="line">                    Ordering::Acquire,</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                        <span class="comment">// ä»è¿™é‡ŒæŠŠä»»åŠ¡ç»“æœè·å–å‡ºæ¥ï¼ˆæŒº Hack çš„ï¼‰ï¼Œå°±æ˜¯ä¸‹é¢çš„ output.read()</span></span><br><span class="line">                        <span class="keyword">let</span> output = ((*header).vtable.get_output)(ptr) <span class="keyword">as</span> *<span class="keyword">mut</span> R;</span><br><span class="line">                        <span class="keyword">return</span> Poll::Ready(<span class="literal">Some</span>(output.read()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Err</span>(s) =&gt; state = s,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="async-std-ä¸­çš„-Task"><a href="#async-std-ä¸­çš„-Task" class="headerlink" title="async_std ä¸­çš„ Task"></a>async_std ä¸­çš„ Task</h2><p>Task æ˜¯ <code>async_std</code> ä¸­æœ€æ ¸å¿ƒçš„æŠ½è±¡ä¹‹ä¸€ï¼Œå’Œ Rust ä¸­çš„ <code>thread</code> ç±»ä¼¼ã€‚<code>Tasks</code> å’Œè¿è¡Œæ—¶è™½ç„¶ä¹Ÿæœ‰å…³è”ï¼Œä½†å®ƒä»¬æ˜¯åˆ†å¼€çš„ã€‚<code>async_std</code> Task æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡æ˜¯å•æ¬¡åˆ†é…çš„ï¼ˆin one single allocationï¼‰ï¼›</li><li>æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª <code>backchannel</code>ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ <code>JoinHandle</code> å°†ç»“æœå’Œé”™è¯¯ä¼ é€’åˆ°å¯¹åº”çš„ä»»åŠ¡ï¼ˆspawning taskï¼‰ï¼›</li><li>å®ƒä»¬æºå¸¦ç”¨äºè°ƒè¯•çš„å…ƒä¿¡æ¯ï¼›</li><li>å®ƒä»¬æ”¯æŒ ä»»åŠ¡çº§åˆ«çš„ local storageã€‚</li></ul><p><code>async_std</code> ä»»åŠ¡ API ä¼šå¤„ç†èƒŒåçš„ runtime åˆå§‹åŒ–ï¼ˆsetupï¼‰å’Œæ¸…ç†ï¼ˆteardownï¼‰å·¥ä½œï¼Œä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼åœ°å¯åŠ¨è¿è¡Œæ—¶ï¼ˆè¿™ä¸ªå’Œ Python 3 æœ‰ä¸¢ä¸¢åŒºåˆ«ï¼‰ã€‚</p><h2 id="é˜»å¡ï¼ˆBlockingï¼‰"><a href="#é˜»å¡ï¼ˆBlockingï¼‰" class="headerlink" title="é˜»å¡ï¼ˆBlockingï¼‰"></a>é˜»å¡ï¼ˆBlockingï¼‰</h2><p>ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸º Tasks éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¯èƒ½å®ƒä»¬ä¼šå…±äº«åŒä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆåœ¨è¯¥çº¿ç¨‹ä¸Šåˆ‡æ¢ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚è¿™åŒæ—¶ä¹Ÿæ„å‘³ç€å¦‚æœåœ¨æŸä¸ªæ‰§è¡Œçº¿ç¨‹ä¸Šè°ƒç”¨äº†é˜»å¡ APIï¼ˆæ¯”å¦‚ <code>std::thread::sleep</code> æˆ–è€…æ ‡å‡†åº“çš„ IO å‡½æ•°ï¼‰ï¼Œä¼šå¯¼è‡´å¯¹åº”æ‰§è¡Œçº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´<strong>è¯¥æ‰§è¡Œçº¿ç¨‹ä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½åœæ­¢è¿è¡Œäº†</strong>ã€‚å…¶å®ƒçš„ä¸€äº›åº“ï¼ˆå¦‚ db driversï¼‰ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„è¡Œä¸ºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé˜»å¡å½“å‰çº¿ç¨‹æœ¬èº«å¹¶éåäº‹æƒ…ï¼Œåªæ˜¯ä¸è¦å’Œ <code>async_std</code> å¹¶å‘æ‰§è¡Œçš„æ¨¡å‹ææ··æ·†å³å¯ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿™æ ·åšï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="comment">//  æ ‡å‡†åº“ std::fsï¼Œä¼šå¯¼è‡´é˜»å¡</span></span><br><span class="line">        std::fs::read_to_string(<span class="string">"test_file"</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦æ··åˆé˜»å¡ API è°ƒç”¨ï¼Œå»ºè®®å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ ·çš„é˜»å¡æ“ä½œã€‚</p><h2 id="å…³äºé”™è¯¯å’Œ-Panic"><a href="#å…³äºé”™è¯¯å’Œ-Panic" class="headerlink" title="å…³äºé”™è¯¯å’Œ Panic"></a>å…³äºé”™è¯¯å’Œ Panic</h2><p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå¦‚æœä»»åŠ¡å¯èƒ½å‡ºé”™ï¼Œé‚£ä¹ˆä»»åŠ¡çš„è¾“å‡º <code>Output</code> åº”è¯¥æ˜¯  <code>Result&lt;T, E&gt;</code> ç±»å‹ã€‚ä½†æ˜¯åœ¨ <code>panic</code> çš„æ—¶å€™ï¼Œå…·ä½“çš„è¡¨ç°åˆ™å–å†³äºæœ‰æ²¡æœ‰åˆç†å¤„ç† panic çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šé€€å‡ºã€‚</p><p>å®è·µä¸­ï¼Œæ„å‘³ç€ <code>block_on</code> ä¼šä¼ é€’ panic åˆ°é˜»å¡è°ƒç”¨çš„åœ°æ–¹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        panic!(&quot;test&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br></pre></td></tr></table></figure></p><p>è€Œå¯¹äº spwan å‡ºå»çš„ä»»åŠ¡å¦‚æœ panicï¼Œåˆ™ä¼šå¯¼è‡´é€€å‡ºï¼ˆabortï¼‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task::spawn(async &#123;</span><br><span class="line">    panic!(&quot;test&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task::block_on(async &#123;</span><br><span class="line">    task::sleep(Duration::from_millis(10000)).await;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„è¡Œä¸ºæœ€åˆçœ‹ä¸Šå»æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¦å¤–ä¸€ç§é€‰é¡¹æ˜¯å¯¹äº spawn å‡ºå»çš„ä»»åŠ¡å¦‚æœå‘ç”Ÿ panicï¼Œåˆ™ç®€å•å¿½ç•¥æ‰ã€‚å½“å‰çš„è¡Œä¸ºå¯ä»¥è¢«ä¿®æ”¹ä¸ºæ•è· spawn å‡ºå»çš„ä»»åŠ¡ä¸­å‘ç”Ÿçš„ panicï¼Œå¹¶ä¸”æ ¹æ®ä¸åŒçš„æƒ…å†µåšå‡ºä¸åŒçš„å“åº”ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦é‡‡å–ä¸åŒçš„ panic å¤„ç†ç­–ç•¥ã€‚</p><h1 id="æ›´å¤šç¤ºä¾‹"><a href="#æ›´å¤šç¤ºä¾‹" class="headerlink" title="æ›´å¤šç¤ºä¾‹"></a>æ›´å¤šç¤ºä¾‹</h1><p>åœ¨ <a href="https://github.com/async-rs/async-std/tree/master/examples" target="_blank" rel="noopener">è¿™é‡Œ</a> æœ‰ä¸å°‘ç¤ºä¾‹ä»£ç å¯ä»¥å‚è€ƒï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ UDP å®¢æˆ·ç«¯ä¾‹å­ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::io;</span><br><span class="line"><span class="keyword">use</span> async_std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> async_std::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="keyword">let</span> socket = UdpSocket::bind(<span class="string">"127.0.0.1:8081"</span>).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Listening on &#123;&#125;"</span>, socket.local_addr()?);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> msg = <span class="string">"hello world"</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&lt;- &#123;&#125;"</span>, msg);</span><br><span class="line">        socket.send_to(msg.as_bytes(), <span class="string">"127.0.0.1:8080"</span>).await?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> buf = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">let</span> (n, _) = socket.recv_from(&amp;<span class="keyword">mut</span> buf).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"-&gt; &#123;&#125;\n"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;buf[..n]));</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.async.rs/introduction.html" target="_blank" rel="noopener">Async programming in Rust with async-std</a></li><li><a href="https://rust-lang.github.io/async-book/" target="_blank" rel="noopener">Asynchronous Programming in Rust</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æ‰“ç®—åŸºäº Rust &lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust &lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ &lt;code&gt;async-std&lt;/code&gt; ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª &lt;code&gt;task&lt;/code&gt; æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ &lt;code&gt;thread&lt;/code&gt; æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ &lt;code&gt;async/await&lt;/code&gt; é£æ ¼çš„ &lt;code&gt;Mutex&lt;/code&gt; åŸè¯­ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Rust" scheme="http://ifaceless.space/categories/Rust/"/>
    
    
      <category term="Rust" scheme="http://ifaceless.space/tags/Rust/"/>
    
      <category term="Async" scheme="http://ifaceless.space/tags/Async/"/>
    
  </entry>
  
  <entry>
    <title>åˆè¯† Elasticsearch</title>
    <link href="http://ifaceless.space/2020/01/15/elasticsearch-intro/"/>
    <id>http://ifaceless.space/2020/01/15/elasticsearch-intro/</id>
    <published>2020-01-15T06:06:48.000Z</published>
    <updated>2020-01-15T06:44:16.554Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æœç´¢åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯åœ¨ App ä¸­è¿˜æ˜¯ç½‘ç«™ä¸­ã€‚æœç´¢æ¯æ—¶æ¯åˆ»éƒ½åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚æœç´¢å–œæ¬¢çš„é›¶é£Ÿã€å¥½çœ‹çš„è¡£æœã€å–œæ¬¢çš„æ–‡ç« ã€æƒ³è¦å­¦ä¹ çš„è¯¾ç¨‹ç­‰ç­‰ã€‚å¦‚ä»Šè¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ æœç´¢å·²ç»éå¸¸å®¹æ˜“äº†ï¼Œæ—©æœŸæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MySQL çš„ MyISAM å­˜å‚¨å¼•æ“æ¥åšå…¨æ–‡æœ¬æœç´¢æ”¯æŒï¼Œä¸è¿‡ä»Šå¤©è¦è¯´çš„ Elasticsearch åŒæ ·å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ›´å¼ºå¤§ã€‚ç®€å•æ¥è¯´ï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œä¹Ÿæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ELK Stack æ ¸å¿ƒæˆå‘˜ã€‚å®ƒä»¥ JSON çš„æ ¼å¼å­˜å‚¨æ–‡æ¡£åˆ°ç´¢å¼•å½“ä¸­ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å¤šç§ç±»å‹ï¼Œå¹¶æä¾›å¿«é€Ÿæœç´¢çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ•´ä¸ª ELK Stack ç”Ÿæ€éå¸¸å®Œå–„ã€‚</p><a id="more"></a><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è·Ÿç€å®˜æ–¹æ–‡æ¡£å­¦ä¹ ä¸‹ Elasticsearch å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿé€‚ç”¨çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæ”¯æŒä»€ä¹ˆæ•°æ®ç±»å‹å­˜å‚¨å’Œæ£€ç´¢ï¼Ÿ</p><p><em>PS: æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ ES æ„å»ºäº†è¯¾ç¨‹å•†å“ï¼ˆSKUï¼‰ç´¢å¼•ï¼Œæ–¹ä¾¿å¯¹ç”¨æˆ·ã€ç®¡ç†åå°æä¾›è¯¾ç¨‹æœç´¢èƒ½åŠ›ã€‚</em></p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p><a href="https://github.com/deviantony/docker-elk" target="_blank" rel="noopener">docker-elk</a> ä»“åº“æä¾›äº†åœ¨ Docker ç¯å¢ƒä¸‹æ­å»º ELK Stack æœåŠ¡çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶è¯´æ˜æ–‡æ¡£è¿›è¡Œå®‰è£…ï¼ˆåœ¨ macOS Catalina ç¯å¢ƒä¸‹æ“ä½œï¼‰ã€‚</p><ol><li>å…‹éš†ä»“åº“ï¼š<code>git clone git@github.com:deviantony/docker-elk.git</code></li><li>ç¬¬ä¸€æ¬¡éœ€è¦è¿è¡Œ <code>docker-compose build</code>ï¼Œç­‰å¾…æ„å»ºå®Œæˆ</li><li>éœ€è¦åœ¨ <code>docker-compose.yml</code> ä¸­ä¿®æ”¹ä¸‹ ES çš„å¯†ç ï¼Œå½“ç„¶è¿˜æœ‰ <code>elasticsearch/config</code>ï¼Œ<code>kibana/config</code>, <code>logstash/config</code> ä¸­éƒ½æœ‰å¯†ç éœ€è¦ä¿®æ”¹ã€‚ç”±äºæ˜¯åœ¨æœ¬åœ°å­¦ä¹ ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•è®¾ç½®äº†ä¸‹å¯†ç ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®å‚è€ƒæ–‡æ¡£ï¼Œç”Ÿæˆå¤æ‚çš„å¯†ç </li><li>è¿è¡Œ <code>docker-compose up [-d]</code> å³å¯å¯åŠ¨</li><li>å…³é—­ <code>docker-compose down -v</code></li></ol><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>é…ç½®æ–‡ä»¶å¹¶éåŠ¨æ€åŠ è½½ï¼Œæ¯æ¬¡å˜æ›´åéœ€è¦é‡å¯å¯¹åº”çš„ç»„ä»¶</li><li>ç«¯å£æ˜ å°„è¯´æ˜ï¼š<ol><li>9200: ES HTTP</li><li>9300: ES TCP</li><li>5000: Logstash TCP input</li><li>5601: Kibana</li></ol></li></ol><p>å¯åŠ¨æˆåŠŸåï¼Œå¯ä»¥æ‰“å¼€ Kibana å¼€å§‹æ¢ç´¢å•¦~<br><img src="https://pic3.zhimg.com/v2-8ea49800d9c7e5e4f147349ca3237593.png" alt=""></p><h1 id="Elasticsearch-ç®€ä»‹"><a href="#Elasticsearch-ç®€ä»‹" class="headerlink" title="Elasticsearch ç®€ä»‹"></a>Elasticsearch ç®€ä»‹</h1><p>Elasticsearch æ˜¯ä¸€ä¸ª<strong>åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“</strong>ï¼ŒELK æ ˆçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚è€Œ Logstash å’Œ Beats ç”¨äº<strong>æ”¶é›†</strong>ã€<strong>èšåˆ</strong>ã€<strong>è½¬æ¢</strong>æ•°æ®ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ Elasticsearch å½“ä¸­ã€‚è€Œ Kibana åˆ™è®©æˆ‘ä»¬èƒ½å¤Ÿä¾¿æ·æ¢ç´¢ã€æŸ¥çœ‹å¹¶åˆ†äº«æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥ç®¡ç† ELK æ ˆã€‚</p><p>ES æä¾›äº†å®æ—¶çš„æœç´¢å’Œåˆ†æèƒ½åŠ›ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆç»“æ„åŒ–ã€éç»“æ„åŒ–ã€æ•°å­—ã€åœ°ç†ä½ç½®ç­‰ï¼‰ï¼ŒES ä¼šé«˜æ•ˆåœ°å­˜å‚¨å¹¶ç´¢å¼•è¿™äº›æ•°æ®ï¼Œä»è€Œæ”¯æŒå¿«é€Ÿæœç´¢ã€‚ç”±äºåˆ†å¸ƒå¼çš„ç‰¹ç‚¹ï¼Œéšç€æ•°æ®é›†çš„å¢åŠ ï¼Œå¯ä»¥è½»æ¾åœ°è¿›è¡Œæ°´å¹³æ‰©å±•æ¥æé«˜æœåŠ¡å¯é æ€§å’Œæ€§èƒ½ã€‚</p><p>ES æ”¯æŒçš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p><ol><li><strong>ä¸ºæˆ‘ä»¬çš„ App æˆ–ç½‘ç«™æä¾›æœç´¢æ”¯æŒ</strong></li><li><strong>å¯ä»¥å­˜å‚¨åˆ†ææ—¥å¿—ï¼ˆanalyze logsï¼‰ã€æŒ‡æ ‡æ•°æ®ï¼ˆmetricsï¼‰ã€å®‰å…¨äº‹ä»¶æ•°æ®ï¼ˆsecurity event dataï¼‰</strong></li><li>åŸºäºæœºå™¨å­¦ä¹ æ ¹æ®æ•°æ®å®æ—¶å»ºæ¨¡</li><li>å¯ä»¥ç”¨ä½œ GIS ç³»ç»Ÿï¼ˆåœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼‰ï¼Œç”¨äºç®¡ç†ã€é›†æˆå¹¶åˆ†æç©ºé—´ä¿¡æ¯</li><li>å¯ä»¥ç”¨äºç”Ÿç‰©å­¦ç ”ç©¶å·¥å…·ï¼Œå­˜å‚¨å¹¶å¤„ç†åŸºå› æ•°æ®</li></ol><h1 id="æ–‡æ¡£å’Œç´¢å¼•"><a href="#æ–‡æ¡£å’Œç´¢å¼•" class="headerlink" title="æ–‡æ¡£å’Œç´¢å¼•"></a>æ–‡æ¡£å’Œç´¢å¼•</h1><p>ES æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨æœåŠ¡ï¼ˆç±»æ¯” Mongoï¼Ÿï¼‰ï¼Œå®é™…åœ¨ç´¢å¼•ä¸­å­˜å‚¨çš„æ˜¯ JSON æ ¼å¼çš„æ–‡æ¡£ã€‚åœ¨ ES é›†ç¾¤ä¸­ï¼Œæ–‡æ¡£ä¼šè¢«åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤å­˜å‚¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ç«‹åˆ»è®¿é—®åˆ°ã€‚</p><p>ä¸€æ—¦æ–°çš„æ–‡æ¡£å­˜å‚¨åˆ°ç´¢å¼•åï¼Œå‡ ä¹å¯ä»¥ç«‹åˆ»è¢«æœç´¢åˆ°ï¼ˆ1s ä»¥å†…ï¼‰ï¼Œå› æ­¤å¯ä»¥æ„å»ºè¿‘ä¹å®æ—¶çš„æœç´¢å¼•æ“ã€‚é‚£ä¹ˆ ES ç©¶ç«Ÿæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒä½¿ç”¨äº†<strong>å€’æ’ç´¢å¼•ï¼ˆinverted indexï¼‰</strong>è¿™ç§æ•°æ®ç»“æ„æ¥æ”¯æŒå…¨æ–‡æœ¬æœç´¢ã€‚æ‰€è°“çš„<strong>å€’æ’ç´¢å¼•</strong>å°±æ˜¯å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ï¼Œç„¶åè®°å½•æ¯ä¸ªåˆ†è¯æ‰€åœ¨çš„æ–‡æ¡£ idï¼ˆå½“ç„¶è¿˜æœ‰è¯é¢‘ç­‰ä¿¡æ¯ï¼‰ï¼Œè¿™æ ·åœ¨æŸ¥è¯¢æ—¶å¯ä»¥åŸºäºåˆ†è¯å¿«é€Ÿå®šä½æ‰€åœ¨çš„æ–‡æ¡£ã€‚</p><p>åœ¨ ES ä¸­ï¼Œ<strong>ç´¢å¼•</strong>æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼ˆå›é¡¾ä¸‹ MySQL InnoDB çš„èšç°‡ç´¢å¼•ï¼Œè¡¨ä¸­çš„è®°å½•å­˜å‚¨åœ¨ B-Tree Node ä¸Šï¼ŒåŸºäº B+ Tree è¿™ç§æ•°æ®ç»“æ„å¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„é¡µï¼‰ï¼Œä½†æ˜¯è¿™é‡Œçš„ç´¢å¼•å’Œåœ¨å…³ç³»æ•°æ®åº“ä¸­æåˆ°çš„ç´¢å¼•æœ‰æ‰€å·®åˆ«ã€‚æ€»ç»“ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>ES çš„<strong>ç´¢å¼•ï¼ˆindexï¼‰</strong>å¯ä»¥çœ‹æˆ<strong>æ–‡æ¡£ï¼ˆdocumentï¼‰</strong>çš„é›†åˆï¼›</li><li>æ¯ä¸ª<strong>æ–‡æ¡£ï¼ˆdocumentï¼‰</strong>å¯ä»¥çœ‹æˆ<strong>å­—æ®µï¼ˆfieldï¼‰</strong>ï¼ˆç±»æ¯”ä¸‹å­—å…¸ä¸­çš„ key-valueï¼‰çš„é›†åˆï¼›<br><img src="https://pic1.zhimg.com/v2-b165c6321a00d62c6c5ab2b2ac0994bb.png" alt=""></li></ol><p>é»˜è®¤è®¾ç½®ä¸‹ï¼ŒES ä¼šä¸ºæ–‡æ¡£ä¸­çš„æ¯ä¸ªå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µéƒ½ä¼šåŒ¹é…ä¸“é—¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„ä»¥è¾¾åˆ°é«˜æ•ˆå­˜å‚¨å’Œå¿«é€Ÿæœç´¢çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šæ–‡æœ¬ä½¿ç”¨<strong>å€’æ’ç´¢å¼•</strong>ï¼Œæ•°å­—å’Œåœ°ç†ä½ç½®ä½¿ç”¨ <a href="https://www.shenyanchao.cn/blog/2018/12/04/lucene-bkd/" target="_blank" rel="noopener">BKD æ ‘</a>ã€‚</p><p>ES æ”¯æŒ schema-lessï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨ä¸ºæ¯ä¸ªå­—æ®µæ˜¾å¼æŒ‡å®šç´¢å¼•æ–¹å¼ã€‚å½“æˆ‘ä»¬å¯ç”¨åŠ¨æ€æ˜ å°„ï¼ˆdynamic mappingï¼‰æ—¶ï¼ˆè¿™ä¸ªæ˜¯é»˜è®¤è®¾ç½®ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ–°å¢å­—æ®µï¼Œè‡ªåŠ¨å°†æ–‡æ¡£ä¸­çš„ bool å€¼ã€æµ®ç‚¹æ•°ã€æ•´æ•°ã€æ—¥æœŸã€å­—ç¬¦ä¸²ç­‰æ˜ å°„æˆåˆé€‚çš„ ES æ•°æ®ç±»å‹ã€‚</p><p>å½“ç„¶ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦å…³é—­åŠ¨æ€æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™æ—¶å¯ä»¥è‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼Œä»è€Œæ§åˆ¶æ¯ä¸ªå­—æ®µå­˜å‚¨å’Œç´¢å¼•çš„æ–¹å¼ã€‚è‡ªå®šä¹‰æ˜ å°„å¸¦å¯ä»¥ï¼š</p><ol><li>åŒºåˆ†å…¨æ–‡æœ¬å­—ç¬¦ä¸²å­—æ®µå’Œç²¾ç¡®åŒ¹é…çš„å­—ç¬¦ä¸²å­—æ®µï¼›</li><li>æ‰§è¡Œç‰¹å®šè¯­è¨€çš„æ–‡æœ¬åˆ†æï¼›</li><li>ä¼˜åŒ–éƒ¨åˆ†åŒ¹é…ï¼›</li><li>ä½¿ç”¨è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼›</li><li>ä½¿ç”¨ä¸€äº›æ— æ³•è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>geo_point</code>, <code>geo_shape</code>ï¼‰ã€‚</li></ol><p>æ­¤å¤–ï¼ŒES å¯ä»¥ä¸ºç›¸åŒçš„å­—æ®µå»ºç«‹ä¸åŒçš„ç´¢å¼•ï¼Œä»¥æ»¡è¶³ä¸åŒçš„éœ€æ±‚åœºæ™¯ã€‚</p><h1 id="æœç´¢ä¸åˆ†æ"><a href="#æœç´¢ä¸åˆ†æ" class="headerlink" title="æœç´¢ä¸åˆ†æ"></a>æœç´¢ä¸åˆ†æ</h1><p>ES æä¾›äº†éå¸¸ç®€å•æ˜“äºä½¿ç”¨çš„ REST APIï¼Œå¯ä»¥åˆ©ç”¨å®ƒä»¬ç®¡ç†é›†ç¾¤ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚æˆ‘ä»¬æ—¢å¯ä»¥åœ¨ Kibana æ§åˆ¶å°ä¸­å’Œ ES äº¤äº’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å„ä¸ªè¯­è¨€ï¼ˆæ”¯æŒ Java, JavaScript, Go, .Net, PHP, Perl, Python, Ruby ç­‰ï¼‰çš„å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ã€‚</p><h2 id="æœç´¢æ•°æ®"><a href="#æœç´¢æ•°æ®" class="headerlink" title="æœç´¢æ•°æ®"></a>æœç´¢æ•°æ®</h2><p><em>ç›®å‰æ”¯æŒä¸¤ç§æŸ¥è¯¢æ–¹å¼ï¼šJSON Query DSL å’Œ SQLã€‚</em></p><p>ES API å…è®¸æˆ‘ä»¬ä½¿ç”¨ç»“æ„åŒ–æŸ¥è¯¢ã€å…¨æ–‡æœ¬æŸ¥è¯¢æˆ–è€…äºŒè€…ç»„åˆï¼š</p><ol><li><strong>ç»“æ„åŒ–æŸ¥è¯¢</strong>ï¼šç±»ä¼¼ SQL é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢æŸå‡ ä¸ªå­—æ®µï¼ŒåŸºäºæŸå­—æ®µæ’åºç­‰ï¼›</li><li><strong>å…¨æ–‡æœ¬æŸ¥è¯¢</strong>ï¼šè¿”å›åŒ¹é…å…³é”®è¯çš„æ–‡æ¡£ï¼Œè¿”å›çš„ç»“æœåŸºäºç›¸å…³æ€§æ’åºã€‚</li></ol><p>æ­¤å¤–ï¼Œè¿˜æ”¯æŒå•ç‹¬åˆ†è¯ï¼ˆindividual termsï¼‰æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒçŸ­è¯­æœç´¢ï¼ˆphrase searchesï¼‰ã€ç›¸ä¼¼åº¦æœç´¢ï¼ˆsimilarity searchesï¼‰å’Œå‰ç¼€æœç´¢ï¼ˆprefix searchesï¼‰ï¼Œç”šè‡³å¯ä»¥å¾—åˆ°è‡ªåŠ¨è¡¥å…¨çš„å»ºè®®ã€‚å½“ç„¶ï¼Œå¯¹äºåœ°ç†ä½ç½®æˆ–è€…æ•°å­—ç±»å‹çš„æ•°æ®ï¼ŒES ä¹Ÿå¯ä»¥æä¾›é«˜æ•ˆçš„æŸ¥è¯¢åŠŸèƒ½ã€‚</p><h2 id="åˆ†ææ•°æ®"><a href="#åˆ†ææ•°æ®" class="headerlink" title="åˆ†ææ•°æ®"></a>åˆ†ææ•°æ®</h2><p>ES å…è®¸æˆ‘ä»¬æ‰§è¡Œ<strong>èšåˆï¼ˆaggregationï¼‰</strong>æ“ä½œï¼Œä»è€Œå¯¹å…³é”®çš„æŒ‡æ ‡ã€ å¢é•¿è¶‹åŠ¿ç­‰æœ‰æ›´ä¸ºæ·±åˆ»çš„è®¤è¯†ã€‚ES é«˜æ•ˆèšåˆçš„èƒ½åŠ›ï¼Œå¯ä»¥è®©æˆ‘ä»¬èƒ½å¤Ÿå®æ—¶åœ°åˆ†æå’Œå¯è§†åŒ–æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæœç´¢å’Œèšåˆè”åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æœç´¢ã€è¿‡æ»¤æ–‡æ¡£çš„åŒæ—¶ï¼Œå¯¹ç›¸åŒçš„ç»“æœè¿›è¡Œåˆ†æã€‚</p><p>æ­¤å¤–ï¼ŒES è¿˜æä¾›äº†è‡ªåŠ¨åˆ†ææ—¶åºæ•°æ®çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨æœºå™¨å­¦ä¹ æ¥å‘ç°æ•°æ®ä¸­çš„å¼‚å¸¸ï¼Œä¸è¿‡è¿™å—å±äºé«˜çº§åŠŸèƒ½äº†ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸‹~</p><h1 id="é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§"><a href="#é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§" class="headerlink" title="é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§"></a>é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§</h1><p><img src="https://pic3.zhimg.com/v2-f8f2d20ee4cd5a1cc87c4ddba58f0078.jpg" alt=""></p><p>æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œé«˜å¯ç”¨å’Œå¯ä¼¸ç¼©çš„èƒ½åŠ›è‡ªç„¶æ˜¯ ES å¿…å¤‡æŠ€èƒ½ã€‚æˆ‘ä»¬å¯ä»¥æŒ‰éœ€ç»™é›†ç¾¤å¢åŠ æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰å®ç°æ‰©å®¹ã€‚ES ä¼šè‡ªåŠ¨å°†æ•°æ®å’ŒæŸ¥è¯¢è´Ÿè½½å‡è¡¡åˆ°<strong>å¯ç”¨èŠ‚ç‚¹</strong>ä¸Šï¼Œä»¥å®ç°ä¼¸ç¼©å’Œé«˜å¯ç”¨ã€‚</p><p>é‚£ä¹ˆï¼ŒES æ˜¯å¦‚ä½•å­˜å‚¨å’Œç»´æŠ¤ç´¢å¼•çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œæ¯ä¸ª ES <strong>ç´¢å¼•ï¼ˆindexï¼‰</strong>å…¶å®æ˜¯ä¸€ä¸ªåˆ°å¤šä¸ª<strong>ç‰©ç†åˆ†ç‰‡ï¼ˆphysical shardsï¼‰</strong> æ‰€ç»„æˆçš„<strong>é€»è¾‘åˆ†ç»„ï¼ˆlogical groupï¼‰</strong>ï¼›æ¯ä¸ªåˆ†ç‰‡å®é™…æ˜¯<strong>è‡ªåŒ…å«ç´¢å¼•ï¼ˆself-contained indexï¼‰</strong>ã€‚é€šè¿‡å°†ç´¢å¼•æ”¾åˆ°å¤šä¸ªåˆ†ç‰‡å­˜å‚¨ï¼Œç„¶åå°†åˆ†ç‰‡åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼ŒES å¯ä»¥ä¸ºåˆ†ç‰‡æä¾›å†—ä½™å¤‡ä»½ï¼Œä»è€Œè¾¾åˆ°æ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨çš„ç›®çš„ã€‚éšç€é›†ç¾¤çš„æ‰©å®¹ï¼ˆæˆ–ç¼©å®¹ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨å†å‡è¡¡ï¼Œå¿…è¦æ—¶ä¹Ÿä¼šåˆå¹¶åˆ†ç‰‡ã€‚</p><h2 id="å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰"><a href="#å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰" class="headerlink" title="å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰"></a>å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰</h2><p>åˆ†ç‰‡åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p><ol><li><strong>ä¸»åˆ†ç‰‡ï¼ˆprimary shardï¼‰</strong>ï¼šç´¢å¼•ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½å±äºæŸä¸ªä¸»åˆ†ç‰‡ã€‚</li><li><strong>å‰¯æœ¬åˆ†ç‰‡ï¼ˆreplicasï¼‰</strong>ï¼šå‰¯æœ¬åˆ†ç‰‡å…¶å®å°±æ˜¯ä¸»åˆ†ç‰‡çš„æ‹·è´ï¼Œä¸€æ–¹é¢å®ç°æ•°æ®å†—ä½™ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯¹å¤–æä¾›è¯»æœåŠ¡ï¼ˆæœç´¢ã€è·å–æ–‡æ¡£ç­‰ï¼‰ã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>ç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°åœ¨åˆ›å»ºåå°±ä¸èƒ½ä¿®æ”¹äº†ï¼Œåªèƒ½é‡å»ºé é‡å»ºç´¢å¼•æ¥æ‰©å±•ä¸»åˆ†ç‰‡æ•°</strong>ï¼Œä½†æ˜¯å‰¯æœ¬åˆ†ç‰‡æ•°å¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œä¸ä¼šæ‰“æ–­ç´¢å¼•å’ŒæŸ¥è¯¢æ“ä½œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°è¶Šå¤šè¶Šå¥½å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯è¿™æ ·çš„ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘ç´¢å¼•çš„æ•°æ®é‡å¤§å°ï¼Œå°½å¯èƒ½ä¿è¯æ¯ä¸ªåˆ†ç‰‡ä¸è¦å¤ªå¤§ï¼Œåˆ†ç‰‡æ•°é‡ä¸è¦è¿‡å¤šã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åˆ†ç‰‡æ•°è¿‡å¤šä¼šå¯¼è‡´çš„é—®é¢˜å§ï¼š</p><ol><li>æ¯ä¸ªåˆ†ç‰‡å…¶å®éƒ½æ˜¯ä¸€ä¸ª Lucene ç´¢å¼•ï¼Œä¼šå ç”¨æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜å’Œ CPU èµ„æºï¼›</li><li>æœç´¢ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœåˆ†ç‰‡éƒ½ä½äºä¸åŒèŠ‚ç‚¹è¿˜å¥½ï¼Œè¦æ˜¯é›†ä¸­åœ¨æŸä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå‡ºç°çƒ­ç‚¹é—®é¢˜ï¼Œèµ„æºç«äº‰æ¿€çƒˆï¼Œæ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼›</li><li>è¿‡å¤šçš„åˆ†ç‰‡ä¹Ÿä¼šå¯¼è‡´è¿‡å¤šçš„åˆ†ç‰‡è¯·æ±‚ï¼Œä¼šäº§ç”Ÿä¸€å®šçš„ç½‘ç»œå¼€é”€ç­‰ï¼›</li><li>ES ä½¿ç”¨è¯é¢‘æ¥ç»Ÿè®¡åŒ¹é…çš„ç›¸å…³æ€§ï¼Œç»Ÿè®¡ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœå¤§é‡åˆ†ç‰‡ä¸Šåªç»´æŠ¤äº†å¾ˆå°‘çš„æ•°æ®ï¼Œåˆ™ä¼šå¯¼è‡´æœ€ç»ˆçš„æ–‡æ¡£çš„ç›¸å…³æ€§è¾ƒå·®ã€‚</li></ol><p>å¦‚æœæ¯ä¸ªåˆ†ç‰‡è¿‡å¤§ï¼Œåˆ™ä¼šå¯¼è‡´é›†ç¾¤å†å‡è¡¡åŠæ—¶ï¼Œæ¬è¿æ•°æ®æ›´è€—æ—¶ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æµ‹è¯•æ¥ç¡®å®šæœ€ä½³çš„é…ç½®ã€‚èµ·åˆå¯ä»¥è¿™æ ·ï¼š</p><ol><li>ä¿è¯æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°åœ¨ GB åˆ°å‡ å GB èŒƒå›´ã€‚å¯¹äºå¸¸è§çš„æ—¶åºæ•°æ®ï¼Œåˆ†ç‰‡å¤§å°åœ¨ 20GB ~ 40GB ä¹Ÿå¾ˆå¸¸è§ã€‚å‚è€ƒæ–‡çŒ®ä¸­ç»™å‡ºçš„å¤§å°é™åˆ¶ä¸º 30GBã€‚</li><li>é¿å…è¿‡å¤§çš„åˆ†ç‰‡é—®é¢˜ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯å®¹çº³çš„åˆ†ç‰‡æ•°é‡å’Œå¯ç”¨çš„å †ç©ºé—´æˆæ­£æ¯”ï¼Œæ¯ GB å †ç©ºé—´åˆ†ç‰‡æ•°åº”è¯¥å°äº 20ã€‚</li></ol><h2 id="ç¾å¤‡"><a href="#ç¾å¤‡" class="headerlink" title="ç¾å¤‡"></a>ç¾å¤‡</h2><p>è€ƒè™‘æ€§èƒ½çš„å› ç´ ï¼Œé€šå¸¸é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åº”è¯¥ä½äºç›¸åŒçš„ç½‘ç»œç¯å¢ƒã€‚è·¨æ•°æ®ä¸­å¿ƒå‡è¡¡åˆ†ç‰‡éå¸¸è€—æ—¶ï¼Œå¯é æ€§ä¹Ÿä¼šé™ä½ã€‚ä½†æ˜¯é«˜å¯ç”¨æ¶æ„è®¾è®¡å°±æ˜¯è¦ä¿è¯æˆ‘ä»¬ä¸è¦æŠŠé¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œï¼Œè¿™æ ·ä¸€æ—¦æŸå¤„çš„æœåŠ¡å™¨å®•æœºï¼Œä½äºå…¶å®ƒä½ç½®çš„æœåŠ¡å™¨å¯ä»¥æ¥æ›¿ç»§ç»­æä¾›æœåŠ¡ã€‚</p><p>ES ä¸ºæˆ‘ä»¬æä¾›äº† CCR åŠŸèƒ½ï¼ˆè·¨é›†ç¾¤å¤åˆ¶ï¼ŒCross-cluster replicationï¼‰ï¼Œè¿™æ ·å¯ä»¥å°†ä¸»é›†ç¾¤çš„ç´¢å¼•åŒæ­¥åˆ°è¿œç¨‹çš„é›†ç¾¤ä½œä¸ºçƒ­å¤‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŸºäºåœ°ç†ä½ç½®ä½¿ç”¨å…¶å®ƒé›†ç¾¤æä¾›è¯»è¯·æ±‚ã€‚æ‰€æœ‰çš„å†™å…¥æ“ä½œéƒ½åœ¨ä¸»é›†ç¾¤å®Œæˆï¼Œå…¶å®ƒçš„å‰¯æœ¬é›†ç¾¤éƒ½æ˜¯åªè¯»çš„ Followersã€‚</p><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="https://pic2.zhimg.com/v2-f2d85b3f20fc985bf5b47c8927c2afcf.jpg" alt=""></p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>ç”Ÿäº§ç¯å¢ƒåˆ›å»ºç´¢å¼•æ¨¡æ¿ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">PUT /_template/km_server_warehouse_template</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"km_server_warehouse*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: &#123;</span><br><span class="line">      <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">        <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"znlp-coarse"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">            <span class="attr">"tokenizer"</span>: <span class="string">"znlp-fine"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="string">"1"</span>,</span><br><span class="line">      <span class="attr">"translog"</span>: &#123;</span><br><span class="line">        <span class="attr">"sync_interval"</span>: <span class="string">"5s"</span>,</span><br><span class="line">        <span class="attr">"durability"</span>: <span class="string">"async"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="string">"4"</span>,</span><br><span class="line">      <span class="attr">"similarity"</span>: &#123;</span><br><span class="line">        <span class="attr">"scripted_bm25"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"scripted"</span>,</span><br><span class="line">          <span class="attr">"script"</span>: &#123;</span><br><span class="line">            <span class="attr">"source"</span>: <span class="string">"double k1 = 1.2; double b = 0.75; double tfNorm = doc.freq * (k1 + 1) / (doc.freq + k1 * (1 - b + b * doc.length / (1.0 * field.sumTotalTermFreq/field.docCount))); return query.boost * tfNorm;"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"contents"</span>: &#123;</span><br><span class="line">      <span class="attr">"dynamic"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"content_basic"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">          <span class="attr">"properties"</span>: &#123;</span><br><span class="line">            <span class="attr">"sku_id"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"business_id"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"business_type"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"producer"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"svip_right"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"free"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"discount"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"instabook_right"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"free"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"discount"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"svip_privileges"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"title"</span>: &#123;</span><br><span class="line">              <span class="attr">"similarity"</span>: <span class="string">"scripted_bm25"</span>,</span><br><span class="line">              <span class="attr">"analyzer"</span>: <span class="string">"znlp-fine"</span>,</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"authors"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"right_list"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"serial_status"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"public_status"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"online_time"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"categories"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"id"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"level"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"weight"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"name"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">                  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">                    <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">                      <span class="attr">"ignore_above"</span>: <span class="number">256</span>,</span><br><span class="line">                      <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"name_en"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">                  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">                    <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">                      <span class="attr">"ignore_above"</span>: <span class="number">256</span>,</span><br><span class="line">                      <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"is_test"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"content_aggregation"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">          <span class="attr">"properties"</span>: &#123;</span><br><span class="line">            <span class="attr">"interest_count"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"created_at"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"updated_at"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" target="_blank" rel="noopener">ES ä»‹ç»</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">Query DSL</a></li><li><a href="https://www.cnblogs.com/ningskyer/articles/5789010.html" target="_blank" rel="noopener">Elasticsearchç³»ç»Ÿæ¦‚å¿µåŠæ¶æ„å›¾</a></li><li><a href="https://blog.csdn.net/zx711166/article/details/81517178" target="_blank" rel="noopener">å€’æ’ç´¢å¼•</a></li><li><a href="https://elasticsearch.cn/article/711" target="_blank" rel="noopener">èŠèŠ ELASTICSEARCH çš„é›†ç¾¤çŠ¶æ€çš„ç®¡ç†å’Œç»´æŠ¤</a></li><li><a href="https://logz.io/learn/complete-guide-elk-stack/#intro" target="_blank" rel="noopener">THE COMPLETE GUIDE TO THE ELK STACK</a></li><li><a href="https://www.edureka.co/blog/elk-stack-tutorial/" target="_blank" rel="noopener">ELK Stack Tutorial â€“ Discover, Analyze And Visualize Your Data Efficiently</a></li><li><a href="https://www.shenyanchao.cn/blog/2018/12/04/lucene-bkd/" target="_blank" rel="noopener">Lucene BKDæ ‘-åŠ¨æ€ç£ç›˜ä¼˜åŒ–BSPæ ‘</a></li><li><a href="https://www.cnblogs.com/bigben0123/p/11274296.html" target="_blank" rel="noopener">èŠèŠ ES åˆ†ç‰‡ä¼˜åŒ–</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æœç´¢åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯åœ¨ App ä¸­è¿˜æ˜¯ç½‘ç«™ä¸­ã€‚æœç´¢æ¯æ—¶æ¯åˆ»éƒ½åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚æœç´¢å–œæ¬¢çš„é›¶é£Ÿã€å¥½çœ‹çš„è¡£æœã€å–œæ¬¢çš„æ–‡ç« ã€æƒ³è¦å­¦ä¹ çš„è¯¾ç¨‹ç­‰ç­‰ã€‚å¦‚ä»Šè¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ æœç´¢å·²ç»éå¸¸å®¹æ˜“äº†ï¼Œæ—©æœŸæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MySQL çš„ MyISAM å­˜å‚¨å¼•æ“æ¥åšå…¨æ–‡æœ¬æœç´¢æ”¯æŒï¼Œä¸è¿‡ä»Šå¤©è¦è¯´çš„ Elasticsearch åŒæ ·å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ›´å¼ºå¤§ã€‚ç®€å•æ¥è¯´ï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œä¹Ÿæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ELK Stack æ ¸å¿ƒæˆå‘˜ã€‚å®ƒä»¥ JSON çš„æ ¼å¼å­˜å‚¨æ–‡æ¡£åˆ°ç´¢å¼•å½“ä¸­ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å¤šç§ç±»å‹ï¼Œå¹¶æä¾›å¿«é€Ÿæœç´¢çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ•´ä¸ª ELK Stack ç”Ÿæ€éå¸¸å®Œå–„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Elasticsearch" scheme="http://ifaceless.space/categories/Elasticsearch/"/>
    
    
      <category term="Elasticsearch" scheme="http://ifaceless.space/tags/Elasticsearch/"/>
    
      <category term="ELK" scheme="http://ifaceless.space/tags/ELK/"/>
    
      <category term="æœç´¢å¼•æ“" scheme="http://ifaceless.space/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/"/>
    
  </entry>
  
  <entry>
    <title>å¿«é€’ç½‘ç‚¹æŠ“å–æ‚è®°</title>
    <link href="http://ifaceless.space/2019/12/29/craw-dilivery-network-distribution/"/>
    <id>http://ifaceless.space/2019/12/29/craw-dilivery-network-distribution/</id>
    <published>2019-12-29T05:02:30.000Z</published>
    <updated>2020-01-01T04:34:08.208Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åº”æ±‚å¼€å‘ä¸€ä¸ªç®€å•çš„çˆ¬è™«ï¼Œç”¨äºä»<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">å¿«é€’ 100</a> æŠ“å–å¿«é€’ç½‘ç‚¹çš„åˆ†å¸ƒï¼Œè¾“å…¥çœä»½+åŸå¸‚+åŒºå¿ï¼Œç„¶åæ˜¯å¿«é€’å…¬å¸åç§°ï¼ŒæŠ“å–å…¶å¯¹åº”çš„å¿«é€’ç½‘ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€åœ°å€ã€ç”µè¯ã€åæ ‡ç­‰ï¼‰ã€‚è¯´èµ·æ¥ï¼Œå¼€å‘è¿™æ ·ä¸€ä¸ªç®€å•çš„çˆ¬è™«å…¶å®æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆæ²¡æœ‰æ—¶é—´è¦æ±‚ã€ä¸éœ€è¦åˆ†å¸ƒå¼æŠ“å–ã€æ²¡ä»€ä¹ˆååçˆ¬ç­–ç•¥åŠ æŒç­‰ï¼‰ï¼Œä¸è¿‡è¿™æœŸé—´ä¹Ÿé‡åˆ°ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸‹ã€‚</p><p>å¦å¤–å°±æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦äº† <a href="https://pyecharts.org/#/zh-cn/geography_charts" target="_blank" rel="noopener">pyecharts</a> è¿™ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨èµ·æ¥è¿˜æŒºæ–¹ä¾¿çš„ã€‚æ ·å¼é…ç½®å¥½ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥å¾ˆå¥½çš„è§†è§‰å†²å‡»çš„ï¼å½“ç„¶ï¼Œå…³é”®æ˜¯åˆ©ç”¨è¿™ç§å·¥å…·æœ‰åŠ©äºå¢åŠ å¯¹æŠ“å–æ•°æ®çš„ç†è§£ï¼ˆçœ‹å…·ä½“éœ€è¦çš„åˆ†æç»´åº¦äº†ï¼‰ã€‚</p><a id="more"></a><p>æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œè™½ç„¶å®šä½æŸäº›å…ƒç´ çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œå†™ XPath è¡¨è¾¾å¼ä¹Ÿæ¯”è¾ƒæ¯ç‡¥ï¼ˆä¸è¦æŒ‡æœ›æµè§ˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„ XPathï¼Œé€šå¸¸éƒ½ä¸å¤Ÿé€šç”¨ï¼‰ã€‚ä½†æ˜¯å®Œæˆæ•´ä¸ªä»»åŠ¡åï¼Œè¿˜æ˜¯æœ‰äº›æ”¶è·çš„ã€‚ä¸‹é¢å¼€å§‹å§~</p><h1 id="ç¡®å®šæ–¹æ¡ˆ"><a href="#ç¡®å®šæ–¹æ¡ˆ" class="headerlink" title="ç¡®å®šæ–¹æ¡ˆ"></a>ç¡®å®šæ–¹æ¡ˆ</h1><h2 id="å°è¯•-API-ç›´æ¥è·å–"><a href="#å°è¯•-API-ç›´æ¥è·å–" class="headerlink" title="å°è¯• API ç›´æ¥è·å–"></a>å°è¯• API ç›´æ¥è·å–</h2><p>å¿«é€’ 100 å¯¹å¤–å…¬å¼€çš„ API æ–‡æ¡£<a href="https://www.kuaidi100.com/openapi/cloud_api.shtml" target="_blank" rel="noopener">åœ¨æ­¤</a>ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æ”¾ç½‘ç‚¹æŸ¥è¯¢çš„æ¥å£ï¼Œæ•…æ— æ³•ä½¿ç”¨ã€‚<em>ç›´æ¥é€šè¿‡ API æŸ¥è¯¢æ˜¯æœ€çœå¿ƒçš„æ–¹å¼ï¼Œä½†æ˜¯ç›®å‰è¿™æ¡è·¯è¡Œä¸é€š</em>ã€‚</p><h2 id="å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨-API-è¯·æ±‚"><a href="#å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨-API-è¯·æ±‚" class="headerlink" title="å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨ API è¯·æ±‚"></a>å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨ API è¯·æ±‚</h2><p>ç½‘ç‚¹æŸ¥è¯¢çš„<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">ä¸»é¡µ</a>ï¼Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„åŸå¸‚å’Œå¿«é€’å…¬å¸ï¼Œé¡µé¢å†…å®¹è‡ªåŠ¨åˆ‡æ¢ã€‚æ­¤æ—¶ï¼Œè¿˜æ˜¯å°è¯•åˆ†æå…¶ API è¯·æ±‚ï¼Œå› ä¸ºè¿™ä¸ªé€šå¸¸æ˜¯æŠ“å–ç½‘ç«™æœ€ç®€å•çš„æ–¹å¼ã€‚</p><p>æ‰“å¼€ Chrome æµè§ˆå™¨çš„è°ƒè¯•æ¨¡å¼ï¼Œé€šè¿‡ç‚¹å‡»é¡µé¢ä¸Šçš„ç­›é€‰é¡¹ï¼ŒæŸ¥çœ‹ç½‘ç»œè¯·æ±‚ï¼Œç¡®å®šè¯·æ±‚äº†ä»€ä¹ˆæ¥å£ï¼Œä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè¿”å›çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œä»è€Œèƒ½å¤Ÿæ¨¡æ‹Ÿå…¶è¯·æ±‚æ–¹å¼æ¥è·å–æ•°æ®ã€‚æ¥ä¸‹æ¥æ¼”ç¤ºçš„æ˜¯æŸ¥è¯¢ä¸Šæµ·åœ°åŒºçš„æŸå¿«é€’å…¬å¸çš„ç½‘ç‚¹ã€‚</p><p>æˆªå›¾ 1ï¼šè¯·æ±‚æ–¹å¼ä¸º POSTï¼ŒURL ä¸º <code>www.kuaidi100.com/network/searchapi.do</code><br><img src="https://pic4.zhimg.com/80/v2-5e4a1966207a0722b6027de8c59575fa.png" alt=""></p><p>æˆªå›¾ 2ï¼šä»¥è¡¨å•çš„å½¢å¼ï¼Œæäº¤äº†è¯·æ±‚çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯é¡µé¢ç‚¹å‡»çš„ç­›é€‰é¡¹ã€‚<br><img src="https://pic4.zhimg.com/80/v2-68027253f03f285b193cbede8deff551.png" alt=""></p><p>æˆªå›¾ 3ï¼šå½“å®Œæˆè¯·æ±‚åï¼Œå¯ä»¥çœ‹åˆ°å…¶è¿”å›ç»“æœä¸º JSON ç»“æ„ï¼Œå…¶ä¸­çš„ <code>netList</code> æ­£æ˜¯æƒ³è¦æ‰¾çš„ç½‘ç‚¹æ•°æ®ã€‚<br><img src="https://pic4.zhimg.com/80/v2-e0a0299c70020102ca4f261123572f1a.png" alt=""></p><h2 id="å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–"><a href="#å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–" class="headerlink" title="å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–"></a>å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–</h2><p>ä¸€èˆ¬åœ¨è¿›è¡Œç½‘ç«™æ•°æ®æŠ“å–æ—¶ï¼Œèƒ½é€šè¿‡å…¶ API è·å–ï¼Œå°±å°½å¯èƒ½å»åˆ©ç”¨ã€‚ä½¿ç”¨ API è¯·æ±‚æ•°æ®çš„å¥½å¤„æœ‰è¿™ä¹ˆå‡ ç‚¹ï¼š</p><ol><li>çœå»äº†åˆ†æç½‘é¡µ HTML ç»“æ„çš„æ—¶é—´ï¼Œå¯ä»¥ç›´æ¥è§£ææ¥å£è¿”å›çš„æ•°æ®ï¼Œæå–æƒ³è¦çš„ä¿¡æ¯å¹¶å­˜å‚¨å³å¯ï¼›</li><li>API è¯·æ±‚æ–¹å¼æœ€ä¸ºç®€å•å¯é çµæ´»ï¼Œä¸”èƒ½é€‚åº”è¾ƒé«˜çš„æŠ“å–é¢‘ç‡ï¼›</li><li>ç›¸å¯¹äºåˆ†æç½‘é¡µ HTML ç»“æ„ï¼Œæå–ä¿¡æ¯çš„æ–¹å¼ï¼ŒAPI æŠ“å–é€šå¸¸ä¸ç”¨åƒæ‹…å¿ƒå‰ç«¯é¡µé¢é¢‘ç¹æ”¹ç‰ˆè€Œå¯¼è‡´çˆ¬è™«ç¨‹åºä¹Ÿè¦å³ä½¿æ›´æ–°çš„å›°å¢ƒï¼Œæ–¹ä¾¿ç»´æŠ¤ã€‚</li></ol><p>ä¸è¿‡åªæ˜¯é€šè¿‡ API æ¥æŠ“å–ï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œåœ¨ Selenium çš„å¸®åŠ©ä¸‹ï¼Œä»¥å¯è§†åŒ–çš„æ–¹å¼æŠ“å–é¡µé¢è²Œä¼¼æ›´æœ‰è¶£ç‚¹ã€‚è¿™é‡Œçš„æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å®‰è£… Selenium + Chrome Web Driverï¼Œé€šè¿‡æ“çºµæµè§ˆå™¨æ¨¡æ‹Ÿäººç±»è®¿é—®é¡µé¢çš„æ–¹å¼æ¥æŠ“å–æ•°æ®ï¼›</li><li>ç¼–å†™çˆ¬è™«ç¨‹åºï¼Œæ§åˆ¶æµè§ˆå™¨æ‰“å¼€ç½‘ç‚¹æŸ¥è¯¢çš„é¦–é¡µï¼š<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">https://www.kuaidi100.com/network/</a></li><li>æ¥æ”¶è¾“å…¥çš„åŸå¸‚å’Œå¿«é€’å…¬å¸åç§°ä½œä¸ºå‚æ•°ï¼Œç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»ä¸‹æ‹‰æ¡†ï¼Œé€‰æ‹©åŸå¸‚ï¼›ç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»æŒ‡å®šçš„å¿«é€’å…¬å¸ï¼›</li><li>æ¥ä¸‹æ¥å¼€å§‹è§£æé¡µé¢ç»“æ„ï¼Œæå–å¿«é€’ç½‘ç‚¹æ•°æ®è½¬æ¢ä¸º JSON æ ¼å¼ï¼ˆåœ°ç†ä½ç½®åæ ‡é€šè¿‡ç™¾åº¦åœ°å›¾ API è·å¾—ï¼‰ï¼Œå­˜å‚¨åœ¨æŒ‡å®šè·¯å¾„ä¸‹ï¼›ç„¶åä¸æ–­æ§åˆ¶æµè§ˆå™¨ç¿»é¡µï¼Œå®Œæˆå‰©ä½™é¡µé¢è§£æï¼Œè‡³æ­¤å¯¹åº”çš„ç½‘ç‚¹ä¿¡æ¯æŠ“å–å®Œæˆã€‚</li></ol><h1 id="å‡†å¤‡å¼€å‘ç¯å¢ƒ"><a href="#å‡†å¤‡å¼€å‘ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡å¼€å‘ç¯å¢ƒ"></a>å‡†å¤‡å¼€å‘ç¯å¢ƒ</h1><ol><li>Python 3.7 ç¯å¢ƒï¼›</li><li><a href="https://pypi.org/project/selenium/" target="_blank" rel="noopener">selenium-python</a>ï¼Œå…¶ä½¿ç”¨æ–‡æ¡£å‚è€ƒ<a href="https://selenium-python-zh.readthedocs.io/en/latest/getting-started.html" target="_blank" rel="noopener">æ­¤å¤„</a>ï¼›</li><li><a href="http://npm.taobao.org/mirrors/chromedriver/" target="_blank" rel="noopener">chromedriver</a> ä¸‹è½½ï¼Œå¹¶è§£å‹å¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼›</li><li>Anaconda ç¯å¢ƒå®‰è£…ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯ Jupter Notebook èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼›</li><li>ä¾èµ–çš„é‡è¦ Python åŒ…å®‰è£…ï¼š<ul><li>pyecharts</li><li>echarts-countries-pypkg </li><li>echarts-china-provinces-pypkg </li><li>echarts-china-cities-pypkg </li><li>echarts-china-counties-pypkg </li><li>echarts-china-misc-pypkg</li><li>requests</li></ul></li><li>è®°å¾—å®‰è£… Chrome æµè§ˆå™¨ã€‚</li></ol><h1 id="é¡µé¢å…³é”®å…ƒç´ å®šä½"><a href="#é¡µé¢å…³é”®å…ƒç´ å®šä½" class="headerlink" title="é¡µé¢å…³é”®å…ƒç´ å®šä½"></a>é¡µé¢å…³é”®å…ƒç´ å®šä½</h1><p>æ ¹æ®ä¸Šè¿°æŠ“å–æ€è·¯ï¼Œéœ€è¦åšçš„æ˜¯å®šä½ä¸€äº›å…³é”®å…ƒç´ ï¼Œå¹¶ä¸”èƒ½å¤Ÿä» HTML ä¸­æŠ½å–å‡ºéœ€è¦çš„ä¿¡æ¯ã€‚é¡µé¢å…ƒç´ å®šä½ï¼Œéœ€è¦äº†è§£ä¸‹ <a href="https://www.w3school.com.cn/xpath/xpath_syntax.asp" target="_blank" rel="noopener">XPath</a> è¯­æ³•ï¼Œæ‘˜å–æƒ³è¦çš„å…ƒç´ ã€‚</p><p><em>å°æŠ€å·§ï¼Œå¯ä»¥åœ¨ Chrome æ§åˆ¶å°é€šè¿‡ <code>$x(&#39;xpath-expression&#39;)</code> éªŒè¯é€‰æ‹©å™¨æ˜¯å¦æ­£å¸¸ï¼š</em><br><img src="https://pic4.zhimg.com/80/v2-7349b600693e94c344c2246ad63c1548.png" alt=""></p><ul><li><p>çœä»½é€‰æ‹©ä¸‹æ‹‰æ¡†å…ƒç´  id ä¸º <code>provinceSelect</code>ï¼š<br>  <img src="https://pic4.zhimg.com/80/v2-bac9ebd7eb25c1b40feaff8d07ef3396.png" alt=""></p></li><li><p>å®šä½çœä»½ä½ç½®ï¼ˆæ‹·è´å…¶ XPATHï¼‰<br>  <img src="https://pic1.zhimg.com/80/v2-5273d05981d0d6e9b4d611ea5408f785.png" alt=""></p></li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å…¶å®ƒå…³é”®å…ƒç´ ç¡®å®šæ–¹å¼ç±»ä¼¼ï¼Œä¸»è¦ä»¥ XPath çš„æ–¹å¼æŸ¥æ‰¾ã€‚å¾—åˆ°æœ€ç»ˆéœ€è¦çš„ XPath è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XPathExpression</span>:</span></span><br><span class="line">    <span class="comment"># çœä»½ä¸‹æ‹‰æ¡† Tab</span></span><br><span class="line">    PROVINCE_TAB = <span class="string">'//*[@id="provinces"]/div/ul/li[2]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªçœä»½</span></span><br><span class="line">    PROVINCE_ITEM = <span class="string">'//*[contains(@class, "place province") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªåŸå¸‚</span></span><br><span class="line">    CITY_ITEM = <span class="string">'//*[contains(@class, "place city") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªåŒºå¿</span></span><br><span class="line">    COUNTY_ITEM = <span class="string">'//*[contains(@class, "place county") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å³ä¾§æŸ¥è¯¢æŒ‰é’®</span></span><br><span class="line">    QUERY_BUTTON = <span class="string">'//*[contains(@class, "btn-query")]'</span></span><br><span class="line">    <span class="comment"># å¿«é€’å…¬å¸é€‰æ‹©</span></span><br><span class="line">    PROVIDER_ITEM = <span class="string">'//ul[@id="companyCount"]/li/*[contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># ä¸‹ä¸€é¡µ</span></span><br><span class="line">    NEXT_PAGE_BUTTON = <span class="string">'//*[contains(@class, "page-down-active")]'</span></span><br><span class="line">    <span class="comment"># é¡µé¢ä¸­çš„å¿«é€’å…¬å¸ä¿¡æ¯æ¡ç›®</span></span><br><span class="line">    QUERY_ITEMS = <span class="string">'//*[@id="queryResult"]/dl'</span></span><br></pre></td></tr></table></figure><h1 id="å†™ä»£ç "><a href="#å†™ä»£ç " class="headerlink" title="å†™ä»£ç "></a>å†™ä»£ç </h1><p><code>main</code> å‡½æ•°æ˜¯å…³é”®å…¥å£ï¼Œå®ƒä¼šè°ƒç”¨çˆ¬è™«ç±»æœç´¢æŒ‡å®šä½ç½®æŒ‡å®šå…¬å¸çš„å¿«é€’ç½‘ç‚¹ä¿¡æ¯ï¼Œå¹¶å°†è¿”å›çš„æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„è·¯å¾„ä¸‹ï¼Œä½¿ç”¨ <code>json line</code> æ ¼å¼ï¼ˆå³æ¯ä¸€è¡Œéƒ½æ˜¯ json æ ¼å¼å­—ç¬¦ä¸²ï¼‰å­˜å‚¨ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(province, city, provider=<span class="string">'å…¨éƒ¨'</span>)</span>:</span></span><br><span class="line">    spider = DeliveryNetworkSpider(</span><br><span class="line">        driver_path=os.path.join(PROJECT_DIR, <span class="string">'dep/mac/chromedriver'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = spider.search(province=province, city=city, provider=provider)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        print(err)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            print(result)</span><br><span class="line">            store_result(os.path.join(PROJECT_DIR, <span class="string">'results'</span>, <span class="string">f'<span class="subst">&#123;province&#125;</span>-<span class="subst">&#123;city&#125;</span>-<span class="subst">&#123;provider&#125;</span>.jl'</span>), result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        spider.close()</span><br></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒçˆ¬è™«ç±»"><a href="#æ ¸å¿ƒçˆ¬è™«ç±»" class="headerlink" title="æ ¸å¿ƒçˆ¬è™«ç±»"></a>æ ¸å¿ƒçˆ¬è™«ç±»</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeliveryNetworkSpider</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""åŸºäºå¿«é€’ 100 çš„å¿«é€’ç½‘ç‚¹æŸ¥è¯¢çˆ¬è™«</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, driver_path)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–å¿«é€’ç½‘ç‚¹çˆ¬è™«ï¼Œå…³é”®å‚æ•°æ˜¯è¦æŒ‡å®š webdriver è·¯å¾„ï¼Œå¦åˆ™</span></span><br><span class="line"><span class="string">        æ— æ³•æ§åˆ¶æµè§ˆå™¨è¿›è¡Œæ¨¡æ‹ŸæŸ¥è¯¢ã€‚å½“å‰ä»…æ”¯æŒ Chrome æµè§ˆå™¨ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param driver_path: é»˜è®¤æ˜¯ Mac ç‰ˆæœ¬æ‰€åœ¨çš„è·¯å¾„ï¼Œå¦‚æœæ˜¯ win</span></span><br><span class="line"><span class="string">                ç‰ˆæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># Windows ä¸‹éœ€è¦æ›¿æ¢æˆå¯¹åº”çš„ chromedriverï¼Œå¯ä»¥åœ¨ dep ç›®å½•ä¸‹æ–°å»º win</span></span><br><span class="line">        <span class="comment"># ç›®å½•ï¼Œå°† windows ç‰ˆæœ¬çš„æ”¾åˆ°ç›®å½•ä¸‹ï¼Œå¹¶ä¿®æ”¹ mac-&gt;win</span></span><br><span class="line">        self._driver = webdriver.Chrome(executable_path=driver_path)</span><br><span class="line">        self._driver.implicitly_wait(<span class="number">10</span>)  <span class="comment"># éšå¼ç­‰å¾…å…ƒç´ å‡ºç°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._driver.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, province, city, county=<span class="string">'æš‚ä¸é€‰æ‹©'</span>, provider=<span class="string">'å…¨éƒ¨'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""æ‰§è¡Œç½‘ç‚¹æŸ¥è¯¢çš„æ ¸å¿ƒæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param province: çœä»½ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰</span></span><br><span class="line"><span class="string">        :param city: åŸå¸‚ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰</span></span><br><span class="line"><span class="string">        :param county: åŒºå¿ï¼Œé»˜è®¤ä¸ºå…¨éƒ¨åŒºå¿</span></span><br><span class="line"><span class="string">        :param provider: å¿«é€’æœåŠ¡å•†åå­—ï¼Œä¸ä¼ åˆ™æŸ¥è¯¢æ‰€æœ‰å¿«é€’å…¬å¸</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._open_home_page()</span><br><span class="line">        self._select_location(province, city, county)</span><br><span class="line">        self._select_provider(provider)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> self._parse_page(province, city)</span><br><span class="line">            <span class="keyword">if</span> self._has_next_page():</span><br><span class="line">                time.sleep(<span class="number">.5</span>)  <span class="comment"># é˜²æ­¢ç¿»é¡µå¤ªå¿«è¢«æŠ“åˆ°</span></span><br><span class="line">                self._visit_next_page()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_open_home_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._driver.get(<span class="string">'https://www.kuaidi100.com/network/'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_select_location</span><span class="params">(self, province, city, county)</span>:</span></span><br><span class="line">        <span class="comment"># æ‰¾åˆ°è¾“å…¥ä¸‹æ‹‰æ¡†ä½ç½®</span></span><br><span class="line">        elem = self._driver.find_element_by_id(<span class="string">'provinceSelect'</span>)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä½é€‰æ‹©çœä»½ Tab</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.PROVINCE_TAB)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¥ä¸‹æ¥é€‰æ‹©çœä»½</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.PROVINCE_ITEM.format(province))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç´§æ¥ç€é€‰æ‹©åŸå¸‚</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.CITY_ITEM.format(city))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€‰æ‹©æ‰€æœ‰åŒºåŸŸ</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.COUNTY_ITEM.format(county))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä½åˆ°æŸ¥è¯¢æŒ‰é’®ï¼Œå¹¶ç‚¹å‡»æŸ¥è¯¢è·³è½¬é¡µé¢</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.QUERY_BUTTON)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_select_provider</span><span class="params">(self, provider)</span>:</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.PROVIDER_ITEM.format(provider))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_has_next_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON)</span><br><span class="line">        <span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_visit_next_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__highlight</span><span class="params">(self, elem)</span>:</span></span><br><span class="line">        <span class="string">"""é«˜äº®æ“ä½œçš„å…ƒç´ """</span></span><br><span class="line">        self._driver.execute_script(</span><br><span class="line">            <span class="string">"arguments[0].setAttribute('style',arguments[1]);"</span>,</span><br><span class="line">            elem,</span><br><span class="line">            <span class="string">"outline:2px solid red;"</span>)</span><br><span class="line">        time.sleep(<span class="number">.2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_parse_page</span><span class="params">(self, province, city)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            elements = self._driver.find_elements_by_xpath(XPathExpression.QUERY_ITEMS)</span><br><span class="line">        <span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> el <span class="keyword">in</span> elements:</span><br><span class="line">                <span class="keyword">yield</span> self._extract(el.text, province, city)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_extract</span><span class="params">(text, province, city)</span>:</span></span><br><span class="line">        item = dict(</span><br><span class="line">            province=province,</span><br><span class="line">            city=city,</span><br><span class="line">            name=<span class="string">''</span>,  <span class="comment"># åç§°</span></span><br><span class="line">            address=<span class="string">''</span>,  <span class="comment"># åœ°å€</span></span><br><span class="line">            contact_phone=<span class="string">''</span>,  <span class="comment"># è”ç³»ç”µè¯</span></span><br><span class="line">            pickup_phone=<span class="string">''</span>,  <span class="comment"># å–ä»¶ç”µè¯</span></span><br><span class="line">            check_phone=<span class="string">''</span>,  <span class="comment"># æŸ¥ä»¶ç”µè¯</span></span><br><span class="line">            complaint_phone=<span class="string">''</span>,  <span class="comment"># æŠ•è¯‰ç”µè¯</span></span><br><span class="line">            location=dict(</span><br><span class="line">                lng=<span class="number">0.0</span>,  <span class="comment"># ç»åº¦</span></span><br><span class="line">                lat=<span class="number">0.0</span>,  <span class="comment"># çº¬åº¦</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–å‡ºçº¯æ–‡æœ¬åæ¢è¡Œè§£æ</span></span><br><span class="line">        lines = [l.strip() <span class="keyword">for</span> l <span class="keyword">in</span> text.splitlines() <span class="keyword">if</span> l.strip()]</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__</span><span class="params">(k)</span>:</span></span><br><span class="line">            r = [l <span class="keyword">for</span> l <span class="keyword">in</span> lines <span class="keyword">if</span> l.startswith(k)]</span><br><span class="line">            <span class="keyword">return</span> r[<span class="number">0</span>].replace(k, <span class="string">''</span>) <span class="keyword">if</span> r <span class="keyword">else</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        item[<span class="string">'name'</span>] = lines[<span class="number">0</span>]</span><br><span class="line">        item[<span class="string">'address'</span>] = __(<span class="string">'å…¬å¸åœ°å€ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'contact_phone'</span>] = __(<span class="string">'è”ç³»ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'pickup_phone'</span>] = __(<span class="string">'å–ä»¶ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'check_phone'</span>] = __(<span class="string">'æŸ¥ä»¶ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'complaint_phone'</span>] = __(<span class="string">'æŠ•è¯‰ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'location'</span>] = get_location(</span><br><span class="line">            item[<span class="string">'address'</span>], city=<span class="string">u"&#123;&#125;&#123;&#125;"</span>.format(province, city))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure><h2 id="åæ ‡æŸ¥è¯¢"><a href="#åæ ‡æŸ¥è¯¢" class="headerlink" title="åæ ‡æŸ¥è¯¢"></a>åæ ‡æŸ¥è¯¢</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">BASE_API = <span class="string">'http://api.map.baidu.com'</span></span><br><span class="line">LOCATION_API = <span class="string">'/geocoding/v3/?address=&#123;&#125;&amp;city=&#123;&#125;&amp;output=json&amp;ak=&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢</span></span><br><span class="line"><span class="meta">@filecache(YEAR)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_location</span><span class="params">(addr, city=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æ–‡æ¡£å‚è€ƒï¼šhttp://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr:</span><br><span class="line">        <span class="keyword">return</span> dict(lng=<span class="number">0.0</span>, lat=<span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    url = _get_query_url(LOCATION_API.format(addr, city, AK))</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    result = r.json()</span><br><span class="line">    <span class="keyword">assert</span> result[<span class="string">'status'</span>] == <span class="number">0</span>, <span class="string">u"è·å–ç»çº¬åº¦ä¿¡æ¯å¤±è´¥ï¼è¯·æ±‚ï¼š&#123;&#125;ï¼Œè¿”å›ç»“æœï¼š&#123;&#125;"</span>.format(url, result)</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">'result'</span>][<span class="string">'location'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_query_url</span><span class="params">(query_str)</span>:</span></span><br><span class="line">    query_str = query_str.replace(<span class="string">'#'</span>, <span class="string">''</span>)  <span class="comment"># å»é™¤ç‰¹æ®Šå­—ç¬¦</span></span><br><span class="line">    <span class="comment"># å¯¹ query_str è¿›è¡Œè½¬ç ï¼Œsafe å†…çš„ä¿ç•™å­—ç¬¦ä¸è½¬æ¢</span></span><br><span class="line">    qs = quote(query_str, safe=<span class="string">"/:=&amp;?#+!$,;'@()*[]"</span>)</span><br><span class="line">    sn = hashlib.md5(quote_plus(qs + SK).encode(<span class="string">'utf8'</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> BASE_API + query_str + <span class="string">f'&amp;sn=<span class="subst">&#123;sn&#125;</span>'</span></span><br></pre></td></tr></table></figure><h1 id="æ§åˆ¶æŠ“å–æ•°æ®"><a href="#æ§åˆ¶æŠ“å–æ•°æ®" class="headerlink" title="æ§åˆ¶æŠ“å–æ•°æ®"></a>æ§åˆ¶æŠ“å–æ•°æ®</h1><p>æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯æŠ“å–ä¸­é€šå¿«é€’åœ¨åŒ—äº¬å„ä¸ªåœ°åŒºçš„ç½‘ç‚¹ã€‚å¯åŠ¨åï¼Œä¼šé€šè¿‡ Selenuium æ§åˆ¶ Chrome æµè§ˆå™¨è®¿é—®æŸ¥è¯¢ç½‘ç«™ï¼Œå¹¶ç‚¹å‡»å¯¹åº”çš„å…ƒç´ ï¼Œå®Œæˆæ•°æ®çš„æŠ“å–ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main(province=<span class="string">'åŒ—äº¬'</span>, city=<span class="string">'åŒ—äº¬'</span>, provider=<span class="string">'ä¸­é€š'</span>)</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªå·¥ä½œè¿‡ç¨‹æ¼”ç¤ºå‚è§ <a href="https://pan.baidu.com/s/1HD_fwdNHZqr1k1w3vzWyMQ" target="_blank" rel="noopener">ç™¾åº¦ç½‘ç›˜ï¼ˆæå–ç : kaunï¼‰</a>ã€‚æŠ“å–åˆ°çš„æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic3.zhimg.com/80/v2-16533f8a8c8f62a9433df19e188dd305.png" alt=""></p><h1 id="ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾"><a href="#ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾" class="headerlink" title="ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾"></a>ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾</h1><p>è¿™é‡Œå°±éœ€è¦ä½¿ç”¨å…³é”®çš„ <a href="https://pyecharts.org/" target="_blank" rel="noopener">pyecharts</a> äº†ï¼Œå…·ä½“æ€ä¹ˆå®‰è£…å’Œé…ç½®å°±ä¸å¤šè¯´äº†ï¼Œå®ƒæœ‰éå¸¸å®Œå–„çš„ä¸­æ–‡æ–‡æ¡£ï¼Œä»¥åŠä¸€äº› Demo å¯ä»¥å­¦ä¹ ã€‚ä»¥ä¸‹å°±æ˜¯åˆ©ç”¨ä¸Šè¿°æŠ“åˆ°çš„æ•°æ®ï¼Œåšä¸ªç®€å•çš„æ¼”ç¤ºï¼Œçœ‹çœ‹è¿™äº›å¿«é€’ç½‘ç‚¹çš„å…·ä½“åˆ†å¸ƒçƒ­ç‚¹æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦åˆ‡æ¢åˆ°çˆ¬è™«ç›®å½•ä¸‹ï¼Œå¹¶å¯åŠ¨ Jupter Notebookï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd path/to/kuaidi100/src</span><br><span class="line">jupter notebook # å¯åŠ¨æœåŠ¡</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œé€‰æ‹© <code>src/heatmap.ipynb</code> æ–‡ä»¶æ‰“å¼€ï¼š<br><img src="https://pic2.zhimg.com/80/v2-af251174caa70eb0ca1f9285db7423ef.png" alt=""></p><p>èœå•æ  <code>Cell-&gt;Run All</code> æ‰§è¡Œæ‰€æœ‰ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç®€å•çš„çƒ­ç‚¹åœ°å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://pic4.zhimg.com/80/v2-1c41db550a36616d2df8808bfaa61540.png" alt=""></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è‡³æ­¤ï¼Œæ•´ä¸ªæŠ˜è…¾çš„è¿‡ç¨‹å°±å®Œç»“å’¯ã€‚ä¸»è¦æ—¶é—´èŠ±è´¹åœ¨ç¡®å®šçˆ¬é‡çš„æ–¹æ¡ˆï¼Œä»¥åŠä½¿ç”¨çµæ´»çš„æ–¹å¼å®šä½å…ƒç´ ä¸Šã€‚åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œä¹Ÿé‡åˆ°ä¸€äº›å°é—®é¢˜ï¼Œå¹¶åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼š</p><ol><li>æ¯”å¦‚æŸäº›æƒ…å†µä¸‹å…ƒç´  <code>click</code> ä¼šå¤±è´¥ï¼Œè¿™æ—¶ä¸ºäº†ä¿è¯çˆ¬è™«çš„å¥å£®æ€§ï¼Œéœ€è¦åšå¼‚å¸¸æ•è·ï¼›é¡µé¢åŠ è½½æœªå®Œæˆæ—¶ï¼Œå¯èƒ½æ— æ³•æŸ¥æ‰¾åˆ°æŒ‡å®šå…ƒç´ ï¼Œå¯¼è‡´çˆ¬è™«ç¨‹åºæŒ‚äº†ï¼Œè¿™é‡Œå°±éœ€è¦é…ç½® Selenium éšå¼ç­‰å¾… 10sã€‚</li><li>ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿ Selenium æ­£åœ¨æ“çºµçš„å…ƒç´ ï¼Œè¿™é‡Œå€ŸåŠ©äº† <code>driver.execute_script()</code> çš„æ–¹å¼ç»™é€‰ä¸­çš„å…ƒç´ æ·»åŠ çº¢è‰²è¾¹æ¡†ã€‚</li><li>å¦å¤–ï¼Œè€ƒè™‘åˆ°çˆ¬å–é¢‘ç‡è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´è§¦å‘åçˆ¬ç­–ç•¥ï¼Œè¿™é‡Œç®€å•åšäº†å»¶è¿Ÿç­‰å¾…ï¼ˆ<code>time.sleep()</code>ï¼‰ã€‚</li></ol><p>æ•´ä½“è€Œè¨€ï¼Œå†™å¾—æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±ç®€å•è®°å½•ä¸‹ã€‚å®Œæ•´çš„ä»£ç ä»“åº“å‚è§ï¼š<a href="https://gitee.com/ifaceless/kuaidi100-spider" target="_blank" rel="noopener">kuaidi100-spider</a>ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://pyecharts.org/#/zh-cn/geography_charts" target="_blank" rel="noopener">pyecharts åœ°ç†å›¾æ ‡æ–‡æ¡£</a></li><li><a href="https://blog.csdn.net/qq_31362537/article/details/90667814" target="_blank" rel="noopener">pyecharts åœ¨åœ°å›¾ä¸Šæ ¹æ®ç»çº¬åº¦å’Œé‡å€¼ï¼Œç”»å‡ºæ•£ç‚¹å›¾/çƒ­åŠ›å›¾</a></li><li><a href="http://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding" target="_blank" rel="noopener">ç™¾åº¦åœ°å›¾æ–‡æ¡£</a></li><li><a href="https://www.w3school.com.cn/xpath/xpath_syntax.asp" target="_blank" rel="noopener">XPath è¯­æ³•</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åº”æ±‚å¼€å‘ä¸€ä¸ªç®€å•çš„çˆ¬è™«ï¼Œç”¨äºä»&lt;a href=&quot;https://www.kuaidi100.com/network/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å¿«é€’ 100&lt;/a&gt; æŠ“å–å¿«é€’ç½‘ç‚¹çš„åˆ†å¸ƒï¼Œè¾“å…¥çœä»½+åŸå¸‚+åŒºå¿ï¼Œç„¶åæ˜¯å¿«é€’å…¬å¸åç§°ï¼ŒæŠ“å–å…¶å¯¹åº”çš„å¿«é€’ç½‘ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€åœ°å€ã€ç”µè¯ã€åæ ‡ç­‰ï¼‰ã€‚è¯´èµ·æ¥ï¼Œå¼€å‘è¿™æ ·ä¸€ä¸ªç®€å•çš„çˆ¬è™«å…¶å®æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆæ²¡æœ‰æ—¶é—´è¦æ±‚ã€ä¸éœ€è¦åˆ†å¸ƒå¼æŠ“å–ã€æ²¡ä»€ä¹ˆååçˆ¬ç­–ç•¥åŠ æŒç­‰ï¼‰ï¼Œä¸è¿‡è¿™æœŸé—´ä¹Ÿé‡åˆ°ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–å°±æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦äº† &lt;a href=&quot;https://pyecharts.org/#/zh-cn/geography_charts&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;pyecharts&lt;/a&gt; è¿™ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨èµ·æ¥è¿˜æŒºæ–¹ä¾¿çš„ã€‚æ ·å¼é…ç½®å¥½ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥å¾ˆå¥½çš„è§†è§‰å†²å‡»çš„ï¼å½“ç„¶ï¼Œå…³é”®æ˜¯åˆ©ç”¨è¿™ç§å·¥å…·æœ‰åŠ©äºå¢åŠ å¯¹æŠ“å–æ•°æ®çš„ç†è§£ï¼ˆçœ‹å…·ä½“éœ€è¦çš„åˆ†æç»´åº¦äº†ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Python" scheme="http://ifaceless.space/categories/Python/"/>
    
    
      <category term="çˆ¬è™«" scheme="http://ifaceless.space/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="Python" scheme="http://ifaceless.space/tags/Python/"/>
    
      <category term="æ•°æ®å¯è§†åŒ–" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£æ–‡ä»¶æè¿°ç¬¦ä¸æ–‡ä»¶å¥æŸ„</title>
    <link href="http://ifaceless.space/2019/12/19/understand-file-descriptor-and-file-description/"/>
    <id>http://ifaceless.space/2019/12/19/understand-file-descriptor-and-file-description/</id>
    <published>2019-12-19T05:26:37.000Z</published>
    <updated>2019-12-19T05:39:40.914Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨ã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹5.4 èŠ‚ï¼Œå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€çš„æ–‡ä»¶å…³ç³»æ˜¯è¿™æ ·æè¿°çš„ï¼šã€Œå†…æ ¸ä¸ºæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ç»´æŠ¤äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„<strong>æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸º<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>ï¼Œå¹¶å°†è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ç§°ä¸º<strong>æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰</strong>ã€‚è€Œé’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸åˆä¸ºå…¶ç»´æŠ¤äº†<strong>æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰</strong>ã€ã€‚</p><a id="more"></a><p><img src="https://pic4.zhimg.com/80/v2-3064b2743259ac1b79da998a595b7c3b.png" alt=""></p><p>åæ¥åœ¨è¿™ç¯‡æ–‡ç«  <a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a> ä¸­ï¼Œçœ‹åˆ°äº†è¿™æ ·çš„çš„æè¿°ï¼šã€Œç®€å•æ¥è¯´ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>ã€‚è¡¨ä¸­çš„æ¯ä¸€é¡¹æ˜¯struct fileç±»å‹ï¼ŒåŒ…å«äº†æ‰“å¼€æ–‡ä»¶çš„ä¸€äº›å±æ€§æ¯”å¦‚åç§»é‡ï¼Œè¯»å†™è®¿é—®æ¨¡å¼ç­‰ï¼Œè¿™æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ–‡ä»¶å¥æŸ„ã€ã€‚</p><p><img src="https://pic1.zhimg.com/80/v2-c315f6671cc7038e8199346a98d4e300.png" alt=""></p><p>é‚£ä¹ˆè¿™é‡Œæåˆ°çš„ã€Œæ‰“å¼€çš„æ–‡ä»¶è¡¨ã€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œæ€ä¹ˆåˆå˜æˆäº†æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰çš„å‘¢ï¼Ÿã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸­ä¸æ˜¯è¯´ã€Œæ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰ã€æ˜¯ç‹¬ç«‹äºè¿›ç¨‹çš„ç³»ç»Ÿçº§è¡¨å—ï¼Ÿæ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å›°æƒ‘å’ŒçŸ›ç›¾å‘¢ï¼Ÿ</p><p>ä¸ºäº†èƒ½å¤Ÿè§£ç­”å›°æƒ‘ï¼ŒåŠ æ·±å¯¹æ–‡ä»¶æè¿°ç¬¦çš„ç†è§£ï¼Œç‰¹åœ°æ·±æ‰’äº†ä¸‹ Linux å†…æ ¸çš„ç›¸å…³æºç ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ä¸Šæ–‡æåˆ°çš„<strong>æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ã€<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>ã€<strong>æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰</strong>è¿™ä¸‰ç§æŠ½è±¡çš„æ•°æ®ç»“æ„å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä»¥ä¾¿èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ä¹¦ä¸­çš„æ¦‚å¿µã€‚</p><h1 id="æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»"><a href="#æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»"></a>æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»</h1><p>åœ¨åŒºåˆ†è¿™äº›æ¦‚å¿µå‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>open()</code> ç³»ç»Ÿè°ƒç”¨çš„ <code>man page</code> ä¸­æåˆ°çš„ä¸€æ®µè¯´æ˜ï¼š</p><blockquote><p>A call to open() creates a new <strong>open file description</strong>, an entry in the<br>system-wide <strong>table of open files</strong>. The open file description records<br>the file offset and the file status flags (see below). A <strong>file<br>descriptor</strong> is a reference to an open file description; this reference<br>is unaffected if pathname is subsequently removed or modified to<br>refer to a different fileâ€¦</p></blockquote><p>åœ¨çœ‹å®Œä¸Šé¢çš„ä»‹ç»åï¼Œç»“åˆã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹æåˆ°çš„åè¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½œå‡ºè¿™æ ·çš„æ˜ å°„ï¼š</p><ol><li>open file description: æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰ï¼Œå®ƒæ‰ä¼šå…³è”åˆ°çœŸæ­£åœ°æ–‡ä»¶ inode</li><li>table of open files: å°±æ˜¯ä¹¦ä¸­æåˆ°çš„ç³»ç»Ÿçº§æè¿°è¡¨ï¼ˆopen file tableï¼‰</li><li>file descriptor: å…¶å®å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹æ–‡ä»¶å¥æŸ„çš„å¼•ç”¨</li></ol><p>å¥½å•¦ï¼Œä¸‹é¢æ¥çœ‹çœ‹ä¸æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„å®ç°ç»†èŠ‚ï¼Œå¹¶äº†è§£å‡ ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨ å®ç°ã€‚</p><h1 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h1><p>ä»¥ä¸‹ä»£ç æ‘˜è‡ª <a href="https://github.com/torvalds/linux/tree/v5.4" target="_blank" rel="noopener">Linux Kernel 5.4</a>ï¼Œè€ƒè™‘åˆ°å†…æ ¸ä»£ç éå¸¸å¤æ‚ï¼Œå¤„ç†ç»†èŠ‚ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æŠŠæ¯ä¸ªå‡½æ•°æˆ–æ•°æ®ç»“æ„æ‰€æœ‰ä»£ç éƒ½è´´å‡ºæ¥ï¼Œåªä¿ç•™äº†ä¸€äº›å’Œæœ¬æ–‡ç„¦ç‚¹æœ‰å…³çš„ä»£ç è¡Œã€‚</p><h2 id="Linux-å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„"><a href="#Linux-å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„" class="headerlink" title="Linux å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„"></a>Linux å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„</h2><p>æ¯ä¸ªè¿›ç¨‹éƒ½å…³è”æŒ‡å‘äº†ä¸€ä¸ª <code>files_struct</code>ï¼Œå³æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">/* Filesystem information*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span></span></span><br><span class="line"><span class="class">    /* <span class="title">Open</span> <span class="title">file</span> <span class="title">information</span>*/</span></span><br><span class="line"><span class="class">    <span class="title">struct</span> <span class="title">files_struct</span>        *<span class="title">files</span>;</span></span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * read mostly part</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œå¯ä»¥å’Œå…¶å®ƒ task å…±äº«</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;</span><br><span class="line">    <span class="keyword">bool</span> resize_in_progress;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> resize_wait;</span><br><span class="line">    <span class="comment">// fdtable æ˜¯æ¯ä¸ªè¿›ç¨‹ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * written part on a separate cache line in SMP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> file_lock ____cacheline_aligned_in_smp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> next_fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> close_on_exec_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> open_fds_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> full_fds_bits_init[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå…³äº fdtable ï¼ˆè¿™ä¸ªå¯ä»¥ç†è§£ä¸ºè¿›ç¨‹ç‹¬ç«‹çš„<strong>æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰</strong>ï¼‰çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_fds;</span><br><span class="line">    <span class="comment">// è¿™é‡Œ fd æ•°ç»„ï¼Œç»´æŠ¤äº†è¿›ç¨‹å…³è”çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶æ–‡ä»¶å¥æŸ„çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶å¥æŸ„å¯ä»¥å…±äº«ï¼ˆæ¯”å¦‚ï¼Œdup ç³»ç»Ÿè°ƒç”¨ï¼‰</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯åœ¨ä½¿ç”¨ open ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼šåˆ›å»ºæ–°çš„ fileï¼Œå³æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> **<span class="title">fd</span>;</span> <span class="comment">/* current fd array */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *close_on_exec;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *open_fds;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *full_fds_bits;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹çœ‹æ–‡ä»¶å¥æŸ„ï¼ˆå³ open file descriptionï¼‰æ˜¯ä»€ä¹ˆï¼Ÿå®ƒç»´æŠ¤äº†å’Œæ‰“å¼€æ–‡ä»¶æœ‰å…³çš„é‡è¦ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span>        <span class="title">f_path</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘çœŸæ­£çš„æ–‡ä»¶ï¼Œinode æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span>        *<span class="title">f_inode</span>;</span>    <span class="comment">/* cached value */</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç›¸å…³çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">f_op</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">     * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span>        f_lock;</span><br><span class="line">    <span class="keyword">enum</span> rw_hint        f_write_hint;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œåªæœ‰ count ä¸º 0 æ—¶ï¼Œæ‰ä¼šè¢«çœŸæ­£åœ°å›æ”¶</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span>        f_count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>         f_flags;</span><br><span class="line">    <span class="keyword">fmode_t</span>            f_mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>        <span class="title">f_pos_lock</span>;</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶åç§»</span></span><br><span class="line">    <span class="keyword">loff_t</span>            f_pos;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>    <span class="title">f_owner</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>    *<span class="title">f_cred</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>    <span class="title">f_ra</span>;</span></span><br><span class="line">    u64            f_version;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»äº†ä¸€ä¸ªå›¾ï¼Œæ–¹ä¾¿äº†è§£ä¸Šè¿°æ•°æ®ç»“æ„å…³ç³»ï¼š<br><img src="https://pic1.zhimg.com/v2-f3e683ab99b911d184e6e1dd244bdba4.jpg" alt="file-descriptor-file-description"></p><h2 id="ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°"><a href="#ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°" class="headerlink" title="ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°"></a>ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°</h2><h3 id="open"><a href="#open" class="headerlink" title="open"></a>open</h3><p><code>open()</code>  ç³»ç»Ÿè°ƒç”¨ä¼šåˆ†é…æ–°çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ï¼Œç”¨æ¥ç»´æŠ¤ä¸æ‰“å¼€æ–‡ä»¶ç›¸å…³çš„å…ƒä¿¡æ¯ï¼ˆå¦‚åç§»é‡ã€è·¯å¾„ã€æ“ä½œæ–¹æ³•ç­‰ï¼‰ï¼Œå¹¶ä¼šç»™è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå…¶å®å°±æ˜¯ä¸ªå°æ•´æ•°ï¼‰ã€‚å®ƒå¯¹åº”çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic4.zhimg.com/v2-57c48d5ad99dc3fca76727492cbd8a8d.jpg" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/open.c</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">do_sys_open</span><span class="params">(<span class="keyword">int</span> dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *filename, <span class="keyword">int</span> flags, <span class="keyword">umode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">open_flags</span> <span class="title">op</span>;</span></span><br><span class="line">    <span class="comment">// ä¸è¦è¢«åå­— fd è¿·æƒ‘äº†ï¼Œå…¶å®è¿™é‡Œè¿”å›çš„æ˜¯é”™è¯¯ä¿¡æ¯ï¼ˆé 0 è¡¨ç¤ºå‡ºé”™äº†ï¼ï¼‰</span></span><br><span class="line">    <span class="keyword">int</span> fd = build_open_flags(flags, mode, &amp;op);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">filename</span> *<span class="title">tmp</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (fd)</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    tmp = getname(filename);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(tmp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    fd = get_unused_fd_flags(flags);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span> = <span class="title">do_filp_open</span>(<span class="title">dfd</span>, <span class="title">tmp</span>, &amp;<span class="title">op</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">            put_unused_fd(fd);</span><br><span class="line">            fd = PTR_ERR(f);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fsnotify_open(f);</span><br><span class="line">            <span class="comment">// æ³¨å†Œåˆ°è¿›ç¨‹çš„ fdtable ä¸­</span></span><br><span class="line">            fd_install(fd, f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    putname(tmp);</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/namei.c</span></span><br><span class="line"><span class="function">struct file *<span class="title">do_filp_open</span><span class="params">(<span class="keyword">int</span> dfd, struct filename *pathname,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct open_flags *op)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line">    filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> filp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct file *<span class="title">path_openat</span><span class="params">(struct nameidata *nd,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct open_flags *op, <span class="keyword">unsigned</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    file = alloc_empty_file(op-&gt;open_flag, current_cred());</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> file</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> fd_install(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, struct file *file)</span><br><span class="line">&#123;</span><br><span class="line">    __fd_install(current-&gt;files, fd, file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __fd_install(struct files_struct *files, <span class="keyword">unsigned</span> <span class="keyword">int</span> fd,</span><br><span class="line">        struct file *file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    rcu_assign_pointer(fdt-&gt;fd[fd], file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h3><p><code>dup()</code> ç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šæ˜¯ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯åº•å±‚è¿˜æ˜¯ä¼šæŒ‡å‘ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦å…³è”çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line">SYSCALL_DEFINE1(dup, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fildes)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -EBADF;</span><br><span class="line">    <span class="comment">// åŸºäºä¼ å…¥çš„æ–‡ä»¶æè¿°ï¼ŒæŸ¥æ‰¾åˆ°å…³è”çš„æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    <span class="comment">// éšè—äº†ä¸€äº›é”™è¯¯åˆ¤æ–­é€»è¾‘</span></span><br><span class="line">    <span class="comment">// fget_raw ä¼šè°ƒç”¨ __fget å‡½æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> = <span class="title">fget_raw</span>(<span class="title">fildes</span>);</span></span><br><span class="line">    ret = get_unused_fd_flags(<span class="number">0</span>);</span><br><span class="line">    fd_install(ret, file);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">fget</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">fd</span>, <span class="title">fmode_t</span> <span class="title">mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">refs</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// å¾—åˆ°å½“å‰è¿›ç¨‹å…³è”çš„æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆOpen file info tableï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span> = <span class="title">current</span>-&gt;<span class="title">files</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ fd -&gt; æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    file = fcheck_files(files, fd);</span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="comment">/* File object ref couldn't be taken.</span></span><br><span class="line"><span class="comment">         * dup2() atomicity guarantee is the reason</span></span><br><span class="line"><span class="comment">         * we loop to catch the new file (or NULL pointer)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (file-&gt;f_mode &amp; mask)</span><br><span class="line">            file = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!get_file_rcu_many(file, refs))</span><br><span class="line">            <span class="keyword">goto</span> loop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p><code>close()</code> ç³»ç»Ÿè°ƒä¼šå›æ”¶æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒæ—¶ä¼šç»™æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰çš„å¼•ç”¨è®¡æ•°å‡ 1ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œå›æ”¶ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.zhimg.com/v2-2152cb65cd8c5d140c444b4bda0be2f4.jpg" alt=""></p><p>å…¶å¯¹åº”çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE1(close, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = __close_fd(current-&gt;files, fd);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line"><span class="comment">// __close_fd å…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶ä¸­ `files` æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹å…³è”çš„</span></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è¡¨ã€‚</span></span><br><span class="line"><span class="keyword">int</span> __close_fd(struct files_struct *files, <span class="keyword">unsigned</span> fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    spin_lock(&amp;files-&gt;file_lock);</span><br><span class="line">    fdt = files_fdtable(files);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¼ å…¥çš„ file descriptor æœ‰æ•ˆæ€§</span></span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= fdt-&gt;max_fds)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾åˆ°å…³è”çš„ file descriptionï¼Œå³æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    file = fdt-&gt;fd[fd];</span><br><span class="line">    <span class="comment">// å›æ”¶ file descriptor</span></span><br><span class="line">    rcu_assign_pointer(fdt-&gt;fd[fd], <span class="literal">NULL</span>);</span><br><span class="line">    __put_unused_fd(files, fd);</span><br><span class="line">    spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line">    <span class="comment">// å…³é—­ file description</span></span><br><span class="line">    <span class="keyword">return</span> filp_close(file, files);</span><br><span class="line">out_unlock:</span><br><span class="line">    spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line">    <span class="keyword">return</span> -EBADF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// filp_close å…³é—­æŒ‡å‘çš„ file descriptionï¼Œå…¶ä¸­ id ä¸º</span></span><br><span class="line"><span class="comment">// POSIX çº¿ç¨‹ IDã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">filp_close</span><span class="params">(struct file *filp, <span class="keyword">fl_owner_t</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–‡ä»¶å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œè¯´æ˜å­˜åœ¨é”™è¯¯ï¼Œæ— æ³•å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (!file_count(filp)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">"VFS: Close: file count is 0\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (filp-&gt;f_op-&gt;flush)</span><br><span class="line">        retval = filp-&gt;f_op-&gt;flush(filp, id);</span><br><span class="line">    <span class="comment">// å¯èƒ½ä¼šå›æ”¶ file descriptionï¼Œä½†æ˜¯ä¼šè€ƒè™‘å…¶å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    fput(filp);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹å®šä¹‰åœ¨ï¼šfs/file_table.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fput</span><span class="params">(struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç»™ file description çš„å¼•ç”¨è®¡æ•°å‡ 1</span></span><br><span class="line">    fput_many(file, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fput_many</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> refs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åŸå­æ“ä½œï¼š&amp;file-&gt;f_count -= refs</span></span><br><span class="line">    <span class="keyword">if</span> (atomic_long_sub_and_test(refs, &amp;file-&gt;f_count)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä»‹ç»äº†ä¸‹æ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€æ–‡ä»¶çš„å…³ç³»ï¼Œå¹¶ç®€è¦è®²è§£äº† Linux å†…æ ¸ä¸­å…³äºè¿™äº›æŠ½è±¡æ¦‚å¿µçš„å…·ä½“å®ç°ã€‚åŒæ—¶ï¼Œè¿˜ç®€å•ä»‹ç»äº†ä¸‹ <code>open()</code>, <code>dup()</code> å’Œ <code>close()</code> ç³»ç»Ÿè°ƒç”¨çš„å®ç°ã€‚ç›¸ä¿¡åœ¨çœ‹å®Œè¿™äº›åï¼Œèƒ½å¤Ÿæ›´åŠ æ·±å…¥å’Œæ¸…æ™°åœ°ç†è§£è¿™ä¸‰ä¸ªæ¦‚å¿µï¼š<strong>ç³»ç»Ÿçº§æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰/æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ã€<strong>æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰/æ–‡ä»¶æè¿°ï¼ˆfile descriptionï¼‰</strong>ä»¥åŠ<strong>æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰</strong>ã€‚</p><p>æœ€åï¼Œå›ç­”ä¸‹æœ¬æ–‡å¼€å¤´æåˆ°çš„é—®é¢˜ã€‚å…¶å®ï¼Œç«™åœ¨è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œä½œè€…åœ¨ <a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a> ä¸­æåˆ°ã€Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>ã€è¿™æ ·çš„è¯´æ³•å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚åªæ˜¯æ­¤å¤„<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>å’Œã€ŠLinux ç³»ç»Ÿç¼–ç¨‹ã€‹ä¸­æåˆ°çš„ç³»ç»Ÿçº§<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>å¹¶éä¸€ä¸ªæ¦‚å¿µã€‚ä½œè€…æåˆ°çš„<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>å…¶å®æ­£æ˜¯æŠ½è±¡çš„<strong>è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰</strong>è¡¨ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æ²¡å¿…è¦ä¸ºæ­¤çº ç»“ï¼Œå’¬æ–‡åš¼å­—ä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä¸è¿‡å¯¹äºå›°æƒ‘çš„ä¸œè¥¿è¿˜æ˜¯èƒ½å¤Ÿææ¸…æ¥šæ‰å¥½ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a></li><li><a href="https://zhuanlan.zhihu.com/p/34280875" target="_blank" rel="noopener">Linux å†…æ ¸æ–‡ä»¶æè¿°ç¬¦è¡¨çš„æ¼”å˜</a></li><li><a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener">man open(2)</a></li><li><a href="https://zhuanlan.zhihu.com/p/46031338" target="_blank" rel="noopener">Linux IOæ ¸å¿ƒæ•°æ®ç»“æ„ä¹‹ä¸€</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹5.4 èŠ‚ï¼Œå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€çš„æ–‡ä»¶å…³ç³»æ˜¯è¿™æ ·æè¿°çš„ï¼šã€Œå†…æ ¸ä¸ºæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ç»´æŠ¤äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„&lt;strong&gt;æè¿°è¡¨ï¼ˆopen file description tableï¼‰&lt;/strong&gt;ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸º&lt;strong&gt;æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰&lt;/strong&gt;ï¼Œå¹¶å°†è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ç§°ä¸º&lt;strong&gt;æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰&lt;/strong&gt;ã€‚è€Œé’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸åˆä¸ºå…¶ç»´æŠ¤äº†&lt;strong&gt;æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰&lt;/strong&gt;ã€ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="æ–‡ä»¶æè¿°ç¬¦" scheme="http://ifaceless.space/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/"/>
    
      <category term="æ–‡ä»¶å¥æŸ„" scheme="http://ifaceless.space/tags/%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€å®ç° Redis å­—å…¸</title>
    <link href="http://ifaceless.space/2019/12/17/implement-redis-dict-in-go/"/>
    <id>http://ifaceless.space/2019/12/17/implement-redis-dict-in-go/</id>
    <published>2019-12-17T09:18:10.000Z</published>
    <updated>2019-12-19T05:26:12.447Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png" alt=""></p><p>å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”®å€¼æ•°æ®åº“ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹åœ¨ <a href="https://ifaceless.space/2019/12/15/redis-low-level-data-structures/">Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„</a>  ä¸­æåˆ°çš„ Redis å­—å…¸å®ç°çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p><ol><li>æ”¯æŒæµ·é‡ <code>&lt;key, value&gt;</code> å­˜å‚¨ï¼›</li><li>ä½¿ç”¨æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œé¿å…å› ä¸ºéœ€è¦è¿ç§»çš„ buckets å¤ªå¤šå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼ˆRedis æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼‰ï¼›</li><li>é»˜è®¤ä½¿ç”¨ SipHash ç®—æ³•è®¡ç®—é”®çš„ hash å€¼ï¼›</li><li>å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œé‡‡ç”¨äº†å¸¸è§çš„é“¾åœ°å€æ³•ï¼Œä¸”æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼›</li><li>å­—å…¸å†…éƒ¨ç»´æŠ¤äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¼šåœ¨æ‰©å®¹æœŸé—´ï¼ˆRehashï¼‰ä½¿ç”¨ï¼›</li><li>æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ã€‚</li></ol><a id="more"></a><p>åœ¨çœ‹äº† Redis å­—å…¸æºç ï¼Œææ‡‚å®ƒçš„å·¥ä½œåŸç†åï¼Œæœ‰æ²¡æœ‰æƒ³è¦è‡ªå·±å®ç°ä¸‹å‘¢ï¼Ÿæ‰€ä»¥ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å±±å¯¨ä¸€ä¸ª Redis å­—å…¸å®ç°ï¼Œè™½ç„¶ã€Œå®¹è²Œã€æœ‰å¼‚ï¼Œä½†ã€Œå†…æ ¸ã€è¿˜æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨å®ç°çš„æ—¶å€™å…ˆä¸è€ƒè™‘ goroutine å®‰å…¨é—®é¢˜ï¼Œç„¦ç‚¹æ”¾åœ¨ Redis å­—å…¸å®ç°çš„æ ¸å¿ƒæ€æƒ³ä¸Šã€‚æ‰€ä»¥åé¢çš„å®ç°ï¼Œéƒ½å‡è®¾åªæœ‰ä¸€ä¸ª goroutine åœ¨å¯¹å­—å…¸è¿›è¡Œæ“ä½œã€‚ç”±äº Go è¯­è¨€è‡ªå¸¦ GCï¼Œæ‰€ä»¥ä½¿ç”¨å®ƒæ¥å®ç°å°±ä¸ç”¨çƒ¦å¿ƒå†…å­˜ç®¡ç†çš„é—®é¢˜äº†ï¼ˆåœ¨ Redis <code>dict.c</code> å®ç°ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šä»£ç æ˜¯æ¶‰åŠå†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„ï¼‰ï¼Œè¿™æ ·å°±èƒ½è®©æˆ‘ä»¬æ›´åŠ å®¹æ˜“åœ°ç†è§£æ ¸å¿ƒçš„å®ç°ç­–ç•¥ã€‚</p><h1 id="ä¸€ç‚¹è¯´æ˜"><a href="#ä¸€ç‚¹è¯´æ˜" class="headerlink" title="ä¸€ç‚¹è¯´æ˜"></a>ä¸€ç‚¹è¯´æ˜</h1><p>æ­£æ‰€è°“ã€Œå…¥ä¹¡éšä¿—ã€å˜›ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°çš„å­—å…¸ä¸­ï¼Œå¹¶æ²¡æœ‰ç…§æ¬åŸå…ˆ Redis ä¸­å­—å…¸çš„æ¥å£ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç»„ç±»ä¼¼äºæ ‡å‡†åº“ <code>sync.Map</code> çš„æ¥å£ã€‚</p><p>å¦å¤–ï¼Œä»€ä¹ˆæ ·çš„ key å¯ä»¥ä½œä¸ºå­—å…¸çš„é”®å‘¢ï¼Ÿé¦–å…ˆï¼Œå¿…é¡»è¦æ˜¯æ–¹ä¾¿è®¡ç®—å“ˆå¸Œå€¼çš„ï¼›å…¶æ¬¡ï¼Œæ–¹ä¾¿è¿›è¡Œç›´æ¥æ¯”è¾ƒã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Redis çš„å­—å…¸å®ç°ä¸­æä¾›äº†ä¸€ç»„æ¥å£ï¼Œä¾›å®é™…ä½¿ç”¨å­—å…¸å­˜å‚¨çš„æ•°æ®ç±»å‹å®ç°ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„æ‰©å±•æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¸ºäº†ç®€å•èµ·è§ï¼Œåœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°æ—¶å­—å…¸æ—¶ï¼Œä¼ å…¥çš„ <code>key</code> å’Œ <code>value</code> å‡ä¸º <code>interface{}</code>  ç±»å‹ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶çš„æ¥å£å®ç°è¦æ±‚ã€‚å¦å¤–ï¼Œé’ˆå¯¹ <code>key</code> å°†åªæ”¯æŒ <code>string</code> å’Œ <code>int</code> ç±»å‹åŠå…¶å˜ç§ã€‚è¿™ç§å¯ä»¥æ»¡è¶³åŸºæœ¬çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæ‹¥æœ‰å’Œ <code>sync.Map</code> ä¸€æ ·çš„æ¥å£ç­¾åã€‚</p><p>æœ€åï¼Œæ¥çœ‹ä¸‹å­—å…¸çš„æ¥å£è®¾è®¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store å‘å­—å…¸ä¸­æ·»åŠ æ–°çš„ key-value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Store</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, value <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Load</span> ä»å­—å…¸ä¸­è·å–æŒ‡å®š <span class="title">key</span> å¯¹åº”çš„å€¼</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Load</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">LoadOrStore</span> ç”¨äºæ ¹æ®æŒ‡å®š <span class="title">key</span> å…ˆæŸ¥æ‰¾å¯¹åº”å€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å¯¹åº”å€¼ï¼›</span></span><br><span class="line"><span class="function">// å¦åˆ™ï¼Œä¼šå°†ç»™å®š <span class="title">key</span>-<span class="title">value</span> å­˜å‚¨åˆ°å­—å…¸ä¸­ï¼Œå¹¶è¿”å›ä¼ å…¥çš„ <span class="title">value</span>ã€‚</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">LoadOrStore</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(actual <span class="keyword">interface</span>&#123;&#125;, loaded <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Delete</span> åˆ é™¤æŒ‡å®šçš„ <span class="title">key</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Len</span> è¿”å›å­—å…¸çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">uint64</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Cap</span> è¿”å›å­—å…¸çš„å®¹é‡</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">uint64</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Range</span> æ¨¡æ‹Ÿ <span class="title">Redis</span> å­—å…¸æ™®é€šè¿­ä»£å™¨è¡Œä¸ºï¼Œä¸æ”¯æŒéå®‰å…¨çš„æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Range</span><span class="params">(fn <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">RangeSafely</span> æ¨¡æ‹Ÿ <span class="title">Redis</span> å­—å…¸å®‰å…¨è¿­ä»£å™¨è¡Œä¸ºï¼Œè¿­ä»£æœŸé—´ä¸åš <span class="title">rehash</span> æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">RangeSafely</span><span class="params">(fn <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Resize</span> ç”¨äºè°ƒæ•´å­—å…¸å®¹é‡ï¼ˆæ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯ <span class="title">rehash</span> è¿˜æ˜¯æ¸è¿›å¼çš„ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Resize</span><span class="params">()</span> <span class="title">error</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">RehashForAWhile</span> æ‰§è¡Œä¸€æ®µæ—¶é—´çš„ <span class="title">rehash</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">RehashForAWhile</span><span class="params">(duration time.Duration)</span></span></span><br></pre></td></tr></table></figure><h1 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h1><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dict <span class="keyword">struct</span> &#123;</span><br><span class="line">    hashTables []*hashTable</span><br><span class="line">    rehashIdx <span class="keyword">int64</span></span><br><span class="line">    iterators <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> hashTable <span class="keyword">struct</span> &#123;</span><br><span class="line">    buckets []*entry</span><br><span class="line">    size <span class="keyword">uint64</span></span><br><span class="line">    sizemask <span class="keyword">uint64</span></span><br><span class="line">    used <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    key, value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    next *entry</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­—å…¸åˆå§‹åŒ–"><a href="#å­—å…¸åˆå§‹åŒ–" class="headerlink" title="å­—å…¸åˆå§‹åŒ–"></a>å­—å…¸åˆå§‹åŒ–</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New å®ä¾‹åŒ–ä¸€ä¸ªå­—å…¸ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Dict</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Dict&#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‡†å¤‡ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œé»˜è®¤ä½¿ç”¨å“ˆå¸Œè¡¨ 1</span></span><br><span class="line">        <span class="comment">// åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œä¼šå°†å“ˆå¸Œè¡¨ 1 ä¸­çš„æ‰€æœ‰å…ƒç´ è¿ç§»åˆ°</span></span><br><span class="line">        <span class="comment">// å“ˆå¸Œè¡¨ 2ã€‚</span></span><br><span class="line">        hashTables: []*hashTable&#123;&#123;&#125;, &#123;&#125;&#125;,</span><br><span class="line">        rehashIdx: <span class="number">-1</span>,</span><br><span class="line">        iterators: <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®"><a href="#åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®" class="headerlink" title="åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®"></a>åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®</h2><p>ä¸‹é¢è¿™ä¸ªå‡½æ•°å°†åŸºäºæŒ‡å®šçš„ key è®¡ç®—å‡ºå¯¹åº”çš„ hash å€¼ï¼ˆä½¿ç”¨ SipHash ç®—æ³•ï¼ŒRedis å­—å…¸ä¸­é»˜è®¤ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡æŸ¥è¯¢å“ˆå¸Œè¡¨æ¥ç¡®å®šå¯¹åº”çš„ key æ˜¯å¦å­˜åœ¨äºå­—å…¸ä¸­ã€‚è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé‡è¦ï¼Œåœ¨åé¢çš„ <code>Load</code> å’Œ <code>Store</code> å‡½æ•°ä¸­éƒ½æœ‰åº”ç”¨ï¼Œä¸‹é¢æ¥çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°å§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// keyIndex åŸºäºæŒ‡å®šçš„ key è·å¾—å¯¹åº”çš„ bucket ç´¢å¼•</span></span><br><span class="line"><span class="comment">// å¦‚æœ key å·²ç»å­˜åœ¨äºå­—å…¸ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›å…³è”çš„ entry</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">keyIndex</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(idx <span class="keyword">uint64</span>, existed *entry)</span></span> &#123;</span><br><span class="line">    hash := SipHash(key)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        ht := d.hashTables[i]</span><br><span class="line">        idx = ht.sizemask &amp; hash</span><br><span class="line">        <span class="keyword">for</span> ent := ht.buckets[idx]; ent != <span class="literal">nil</span>; ent = ent.next &#123;</span><br><span class="line">            <span class="keyword">if</span> ent.key == key &#123;</span><br><span class="line">                <span class="keyword">return</span> idx, ent</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå­—å…¸å¤„äº rehashing ä¸­ï¼Œä¸Šé¢çš„å¾ªç¯å¯ä»¥ä¿è¯æœ€åçš„ idx ä¸€å®šä½äº</span></span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä»è€Œä¿è¯ä¾èµ–è¯¥æ¥å£çš„åœ°æ–¹å­˜å‚¨çš„æ–°é”®ä¸€å®šè¿›å…¥åˆ°æ–°çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    <span class="keyword">return</span> idx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢é”®å€¼å¯¹"><a href="#æŸ¥è¯¢é”®å€¼å¯¹" class="headerlink" title="æŸ¥è¯¢é”®å€¼å¯¹"></a>æŸ¥è¯¢é”®å€¼å¯¹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load ä»å­—å…¸ä¸­åŠ è½½æŒ‡å®šçš„ key å¯¹åº”çš„å€¼ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Load</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _, existed := d.keyIndex(key)</span><br><span class="line">    <span class="keyword">if</span> existed != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> existed.value, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­˜å‚¨é”®å€¼å¯¹"><a href="#å­˜å‚¨é”®å€¼å¯¹" class="headerlink" title="å­˜å‚¨é”®å€¼å¯¹"></a>å­˜å‚¨é”®å€¼å¯¹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store å‘å­—å…¸ä¸­æ·»åŠ  key-valueã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Store</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    ent, loaded := d.loadOrStore(key, value)</span><br><span class="line">    <span class="keyword">if</span> loaded &#123;</span><br><span class="line">        ent.value = value <span class="comment">// ç›´æ¥æ›´æ–° value å³å¯</span></span><br><span class="line">    &#125; <span class="comment">// å¦åˆ™ï¼Œä¸Šè¿°å‡½æ•°è°ƒç”¨ä¼šè‡ªåŠ¨æ·»åŠ  (key, value) åˆ°å­—å…¸ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loadOrStore å…ˆå°è¯•ä½¿ç”¨ key æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°åˆ™ç›´æ¥è¿”å›å¯¹åº” entryï¼Œ</span></span><br><span class="line"><span class="comment">// å¦åˆ™ï¼Œä¼šæ·»åŠ æ–°çš„ entry åˆ°å­—å…¸ä¸­ï¼ŒåŒæ—¶è¿”å› nilï¼Œè¡¨ç¤ºä¹‹å‰ä¸å­˜åœ¨ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">loadOrStore</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(ent *entry, loaded <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _ = d.expandIfNeeded() <span class="comment">// è¿™é‡Œç®€å•èµ·è§ï¼Œå‡è®¾ä¸€å®šæ˜¯å¯ä»¥æ‰©å®¹æˆåŠŸçš„ï¼Œå¿½ç•¥äº†é”™è¯¯</span></span><br><span class="line">    idx, existed := d.keyIndex(key)</span><br><span class="line">    ht := d.hashTables[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        ht = d.hashTables[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> existed != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> existed, <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œéœ€è¦åœ¨æŒ‡å®š bucket æ·»åŠ æ–°çš„ entry</span></span><br><span class="line">        <span class="comment">// å¯¹äºå“ˆå¸Œå†²çªçš„æƒ…å†µï¼Œé‡‡ç”¨é“¾åœ°å€æ³•ï¼Œåœ¨æ’å…¥æ–°çš„ entry æ—¶ï¼Œ</span></span><br><span class="line">        <span class="comment">// é‡‡ç”¨å¤´æ’æ³•ï¼Œä¿è¯æœ€è¿‘æ·»åŠ çš„åœ¨æœ€å‰é¢</span></span><br><span class="line">        entry := &amp;entry&#123;key: key, value: value, next: ht.buckets[idx]&#125;</span><br><span class="line">        ht.buckets[idx] = entry</span><br><span class="line">        ht.used++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤é”®å€¼å¯¹"><a href="#åˆ é™¤é”®å€¼å¯¹" class="headerlink" title="åˆ é™¤é”®å€¼å¯¹"></a>åˆ é™¤é”®å€¼å¯¹</h2><p>åˆ é™¤æ“ä½œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æŸ¥æ‰¾åˆ°è¦åˆ é™¤çš„ Entry åï¼Œéœ€è¦è®°å¾—è°ƒæ•´å“ˆå¸Œæ¡¶çš„å¤´æŒ‡é’ˆï¼Œå¯èƒ½è¢«åˆ é™¤çš„ Entry æ°å¥½å°±æ˜¯å¤´èŠ‚ç‚¹ã€‚ä»£ç å®ç°æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete ä»å­—å…¸ä¸­åˆ é™¤æŒ‡å®šçš„ keyï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆä¹Ÿ</span></span><br><span class="line"><span class="comment">// ä¸åšã€‚</span></span><br><span class="line"><span class="comment">// å®ç°æè¿°ï¼š</span></span><br><span class="line"><span class="comment">// 1. éå†å“ˆå¸Œè¡¨ï¼Œå®šä½åˆ°å¯¹åº”çš„ buckets</span></span><br><span class="line"><span class="comment">// 2. åˆ é™¤ buckets ä¸­åŒ¹é…çš„ entryã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.Len() == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸è¦åšæ— ç•çš„æŒ£æ‰ï¼</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash := SipHash(key)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        ht := d.hashTables[i]</span><br><span class="line">        idx := ht.sizemask &amp; hash</span><br><span class="line">        <span class="keyword">var</span> prevEntry *entry</span><br><span class="line">        <span class="keyword">for</span> ent := ht.buckets[idx]; ent != <span class="literal">nil</span>; ent = ent.next &#123;</span><br><span class="line">            <span class="keyword">if</span> ent.key == key &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶éœ€è¦é‡Šæ”¾ ent èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> prevEntry != <span class="literal">nil</span> &#123;</span><br><span class="line">                    prevEntry.next = ent.next</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å¾…é‡Šæ”¾çš„èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒæ•´ buckets[idx] æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                    ht.buckets[idx] = ent.next</span><br><span class="line">                &#125;</span><br><span class="line">                ent.next = <span class="literal">nil</span></span><br><span class="line">                ht.used--</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            prevEntry = ent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰©å®¹å’Œç¼©å®¹"><a href="#æ‰©å®¹å’Œç¼©å®¹" class="headerlink" title="æ‰©å®¹å’Œç¼©å®¹"></a>æ‰©å®¹å’Œç¼©å®¹</h2><p>åœ¨ç»™å­—å…¸æ·»åŠ é”®å€¼å¯¹æ—¶ï¼Œä¼šè°ƒç”¨ <code>loadOrStore</code> æ–¹æ³•ï¼Œè€Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†ä¸€æ¬¡ <code>d.expandIfNeeded()</code> æ–¹æ³•å°è¯•ç»™å­—å…¸æŒ‰éœ€æ‰©å®¹ã€‚é‚£ä¹ˆï¼Œå­—å…¸æ‰©å®¹çš„æ—¶æœºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰©å®¹çš„ç­–ç•¥åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿä¸”çœ‹æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    _initialHashtableSize <span class="keyword">uint64</span> = <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">expandIfNeeded</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶è¡¨æ˜æ‰©å®¹å·²ç»æˆåŠŸï¼Œæ­£åœ¨è¿›è¡Œè¿ç§»ï¼ˆrehashï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œéœ€è¦ä¸€å®šçš„ç©ºé—´å­˜æ”¾æ–°çš„ keys</span></span><br><span class="line">        <span class="keyword">return</span> d.resizeTo(_initialHashtableSize)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œæ ¹æ®è´Ÿè½½å› å­åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="comment">// æ‰©å®¹ç­–ç•¥ç®€å•ç²—æš´ï¼Œè‡³å°‘è¦æ˜¯å·²æœ‰å…ƒç´ ä¸ªæ•°çš„äºŒå€</span></span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].used == d.hashTables[<span class="number">0</span>].size &#123;</span><br><span class="line">        <span class="keyword">return</span> d.resizeTo(d.hashTables[<span class="number">0</span>].used * <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">resizeTo</span><span class="params">(size <span class="keyword">uint64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸»è¦æ˜¯è¦ä¿è¯æ‰©å®¹å¤§å°ç¬¦åˆè¦æ±‚ï¼Œè‡³å°‘è¦æ¯”ç°æœ‰å…ƒç´ ä¸ªæ•°å¤š</span></span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() || d.hashTables[<span class="number">0</span>].used &gt; size &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"failed to resize"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = d.nextPower(size)</span><br><span class="line">    <span class="keyword">if</span> size == d.hashTables[<span class="number">0</span>].size &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡å¼€å§‹æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">var</span> ht *hashTable</span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œæ‰©å®¹ï¼Œç»™ ht[0] å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥ keys å¯ä»¥ç›´æ¥æ”¾è¿›æ¥</span></span><br><span class="line">        ht = d.hashTables[<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ht = d.hashTables[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">// è¡¨æ˜éœ€è¦å¼€å§‹è¿›ä¸€æ­¥æ‰©å®¹ï¼Œè¿ç§» ht[0] -&gt; ht[1]</span></span><br><span class="line">        d.rehashIdx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ht.size = size</span><br><span class="line">    ht.sizemask = size - <span class="number">1</span></span><br><span class="line">    ht.buckets = <span class="built_in">make</span>([]*entry, ht.size)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextPower æ‰¾åˆ°åŒ¹é… size çš„æ‰©å®¹å¤§å°</span></span><br><span class="line"><span class="comment">// 2^2 -&gt; 2^3 -&gt; 2^4 -&gt; 2^5 -&gt; ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">nextPower</span><span class="params">(size <span class="keyword">uint64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> size &gt;= math.MaxUint64 &#123;</span><br><span class="line">        <span class="keyword">return</span> math.MaxUint64</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i := _initialHashtableSize</span><br><span class="line">    <span class="keyword">for</span> i &lt; size &#123;</span><br><span class="line">        i &lt;&lt;= <span class="number">1</span> <span class="comment">// i*= 2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“äº†æ‰©å®¹æ˜¯ä½•æ—¶è¿›è¡Œçš„äº†ï¼Œ ä½†æ˜¯çœ‹èµ·æ¥å¹¶æ²¡æœ‰åœ¨åˆ é™¤å…ƒç´ æ—¶æ‰§è¡Œç¼©å®¹æ“ä½œå‘¢ï¼Ÿé‚£ç¼©å®¹ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿåœ¨ Redis ä¸­ï¼Œæ˜¯ç”±å­—å…¸çš„ä½¿ç”¨è€…æ¥ç¡®å®šç¼©å®¹çš„æ—¶æœºçš„ï¼Œæ¯”å¦‚åœ¨åˆ é™¤é”®å€¼å¯¹åï¼Œæˆ–è€…åœ¨ <code>serverCron</code> ä¸­æ‰§è¡Œï¼ˆå…·ä½“è°ƒç”¨é“¾è·¯ä¸ºï¼š<code>serverCron-&gt;databasesCron-&gt;tryResizeHashTables-&gt;dictResize</code>ï¼‰ã€‚è¯¥æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œç”¨ Go è¯­è¨€è¡¨è¾¾å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Resize è®©å­—å…¸æ‰©å®¹æˆ–è€…ç¼©å®¹åˆ°ä¸€å®šå¤§å°ã€‚</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ä¼šå‡†å¤‡å¥½ç”¨äºæ‰©å®¹çš„ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä½†çœŸæ­£çš„è¿ç§»è¿˜æ˜¯åˆ†æ•£</span></span><br><span class="line"><span class="comment">// åœ¨å¤šæ¬¡ Rehash æ“ä½œä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Resize</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"dict is rehashing"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size := d.hashTables[<span class="number">0</span>].used</span><br><span class="line">    <span class="keyword">if</span> size &lt; _initialHashtableSize &#123;</span><br><span class="line">        size = _initialHashtableSize</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> d.resizeTo(size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸è¿›å¼-rehash"><a href="#æ¸è¿›å¼-rehash" class="headerlink" title="æ¸è¿›å¼ rehash"></a>æ¸è¿›å¼ rehash</h2><p>æ¸è¿›å¼ Rehash çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å¤§é‡çš„å·¥ä½œåˆ†æˆå¾ˆå¤šæ­¥å®Œæˆã€‚åœ¨ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Load</code>, <code>Store</code>, <code>Delete</code> æ–¹æ³•ä¸­ï¼Œéƒ½æœ‰è°ƒç”¨ <code>d.rehashStep()</code>ï¼Œè¿›è€Œåˆä¼šè°ƒç”¨ <code>d.rehash(1)</code>ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¸è¿›å¼ Rehash æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rehash å®ç°æ¸è¿›å¼ Rehash ç­–ç•¥ã€‚åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œæ¯æ¬¡å¯¹æœ€å¤š</span></span><br><span class="line"><span class="comment">// steps ä¸ª buckets è¿›è¡Œè¿ç§»ã€‚å¦å¤–ï¼Œè€ƒè™‘åˆ°å¯èƒ½æ—§çš„å“ˆå¸Œè¡¨ä¸­</span></span><br><span class="line"><span class="comment">// ä¼šè¿ç»­é‡åˆ°è¾ƒå¤šçš„ç©º bucketsï¼Œå¯¼è‡´è€—è´¹æ—¶é—´ä¸å—é™åˆ¶ï¼Œè¿™é‡Œè¿˜</span></span><br><span class="line"><span class="comment">// é™å®šæœ€å¤šé‡åˆ° 10 * steps ä¸ªç©º buckets å°±é€€å‡ºã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">rehash</span><span class="params">(steps <span class="keyword">uint64</span>)</span> <span class="params">(finished <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    maxEmptyBucketsMeets := <span class="number">10</span> * steps</span><br><span class="line">    src, dst := d.hashTables[<span class="number">0</span>], d.hashTables[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> ; steps &gt; <span class="number">0</span> &amp;&amp; src.used != <span class="number">0</span>; steps-- &#123;</span><br><span class="line">        <span class="comment">// æ‰«æå“ˆå¸Œè¡¨ç›´åˆ°é‡åˆ°éç©ºçš„ bucket</span></span><br><span class="line">        <span class="keyword">for</span> src.buckets[d.rehashIdx] == <span class="literal">nil</span> &#123;</span><br><span class="line">            d.rehashIdx++</span><br><span class="line">            maxEmptyBucketsMeets--</span><br><span class="line">            <span class="keyword">if</span> maxEmptyBucketsMeets &lt;= <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠæ•´ä¸ª bucket ä¸Šæ‰€æœ‰çš„ entry éƒ½è¿ç§»èµ°</span></span><br><span class="line">        <span class="keyword">for</span> ent := src.buckets[d.rehashIdx]; ent != <span class="literal">nil</span>; &#123;</span><br><span class="line">            next := ent.next</span><br><span class="line">            idx := SiphHash(ent.key) &amp; dst.sizemask</span><br><span class="line">            ent.next = dst.buckets[idx]</span><br><span class="line">            dst.buckets[idx] = ent</span><br><span class="line">            src.used--</span><br><span class="line">            dst.used++</span><br><span class="line">            ent = next</span><br><span class="line">        &#125;</span><br><span class="line">        src.buckets[d.rehashIdx] = <span class="literal">nil</span> <span class="comment">// æ¸…ç©ºæ—§çš„ bucket</span></span><br><span class="line">        d.rehashIdx++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¿ç§»å®Œæ¯•ï¼Œéœ€è¦å°† ht[0] æŒ‡å‘è¿ç§»åçš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    <span class="keyword">if</span> src.used == <span class="number">0</span> &#123;</span><br><span class="line">        d.hashTables[<span class="number">0</span>] = dst</span><br><span class="line">        d.hashTables[<span class="number">1</span>] = &amp;hashTable&#123;&#125;</span><br><span class="line">        d.rehashIdx = <span class="number">-1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­—å…¸è¿­ä»£å™¨"><a href="#å­—å…¸è¿­ä»£å™¨" class="headerlink" title="å­—å…¸è¿­ä»£å™¨"></a>å­—å…¸è¿­ä»£å™¨</h2><p>è¿­ä»£å™¨çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iterator å®ç°äº†ä¸€ä¸ªå¯¹å­—å…¸çš„è¿­ä»£å™¨ã€‚</span></span><br><span class="line"><span class="comment">// ä¸è¿‡è€ƒè™‘åˆ°æˆ‘ä»¬å°†ä¸ºå­—å…¸æä¾› `Range` æ–¹æ³•ï¼Œæ•…è¯¥è¿­ä»£å™¨å°±ä¸å¾€å¤–æš´éœ²äº†ã€‚</span></span><br><span class="line"><span class="keyword">type</span> iterator <span class="keyword">struct</span> &#123;</span><br><span class="line">    d *Dict</span><br><span class="line">    tableIndex <span class="keyword">int</span></span><br><span class="line">    safe <span class="keyword">bool</span></span><br><span class="line">    fingerprint <span class="keyword">int64</span></span><br><span class="line">    entry *entry</span><br><span class="line">    bucketIndex <span class="keyword">uint64</span></span><br><span class="line">    waitFirstIteration <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newIterator</span><span class="params">(d *Dict, safe <span class="keyword">bool</span>)</span> *<span class="title">iterator</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;iterator&#123;</span><br><span class="line">        d: d,</span><br><span class="line">        safe: safe,</span><br><span class="line">        waitFirstIteration: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Redis çš„å­—å…¸ä¸­ï¼Œæä¾›äº†ä¸¤ç§ç±»å‹çš„è¿­ä»£å™¨ï¼Œåˆ†åˆ«é€šè¿‡ <code>dictGetIterator</code> å’Œ <code>dictGetSafeIterator</code> è·å¾—ã€‚æ™®é€šè¿­ä»£å™¨åªèƒ½æ‰§è¡Œå’Œå­—å…¸å…³è”çš„ <code>dictNext</code> æ–¹æ³•ï¼Œä¸å…è®¸æ‰§è¡Œ <code>dictFind</code>ï¼Œ<code>dictAdd</code> ç­‰æ“ä½œï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºè¿™äº›æ“ä½œå¯èƒ½ä¼šå¼•èµ· Rehashï¼Œä»è€Œå¯¼è‡´åœ¨è¿­ä»£æœŸé—´å¯èƒ½ä¼šæ‰«æåˆ°é‡å¤çš„é”®å€¼å¯¹ï¼ˆæ¯”å¦‚åœ¨æ‰§è¡Œ Rehash æœŸé—´ï¼ŒæŸäº›é”®å€¼å¯¹è¢«è¿ç§»åˆ°äº†æ–°çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¼˜å…ˆæ‰«æç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç„¶åå†æ‰«æç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œè€Œæ­¤æ—¶å¯èƒ½ä¼šé‡åˆ°ä¹‹å‰æ‰«æè¿‡çš„å…ƒç´ ï¼‰ã€‚å½“ç„¶ï¼ŒRedis çš„æ™®é€šè¿­ä»£å™¨æ˜¯æ²¡æ³•é˜»æ­¢ä½ åœ¨è¿­ä»£æœŸé—´æ‰§è¡Œä¸å®‰å…¨çš„æ“ä½œçš„ï¼Œä½†æ˜¯å®ƒä¼šé€šè¿‡è®¡ç®—è¿­ä»£å‰åå­—å…¸çš„æŒ‡çº¹ä¿¡æ¯ï¼Œå¹¶åœ¨æœ€åè¿›è¡Œæ¯”å¯¹ï¼Œè‹¥æŒ‡çº¹ä¸åŒ¹é…ï¼Œåˆ™æ— æ³•é€šè¿‡ <code>assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d))</code> æ–­è¨€ã€‚</p><p>é‚£ä¹ˆå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å¯ä»¥å…è®¸ <code>dictFind</code> å’Œ <code>dictAdd</code> ç­‰æ“ä½œæ‰§è¡Œçš„å‘¢ï¼Ÿå…¶å®å®ƒæ˜¯é€šè¿‡é˜»æ­¢å­—å…¸ <code>rehash</code> å®ç°çš„ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒæ‰å¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°æ‰«æå“ˆå¸Œè¡¨ä¸­çš„ Entriesï¼Œè€Œä¸ç”¨æ‹…å¿ƒé‡åˆ°é‡å¤çš„ Entriesã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>Load</code>ã€<code>Store</code> å’Œ <code>Delete</code> ä¸­éƒ½æœ‰ç›´æ¥æˆ–é—´æ¥åœ°è°ƒç”¨ <code>d.rehashStep()</code> æ–¹æ³•ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">rehashStep</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.iterators == <span class="number">0</span> &#123;</span><br><span class="line">        d.rehash(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿­ä»£å™¨æœ€é‡è¦çš„ <code>next()</code> æ–¹æ³•å®ç°ï¼Œå°±å¯ä»¥çœ‹åˆ°å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next ä¼šä¾æ¬¡æ‰«æå­—å…¸ä¸­å“ˆå¸Œè¡¨çš„æ‰€æœ‰ bucketsï¼Œå¹¶å°†å…¶ä¸­çš„ entry ä¸€ä¸€è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœå­—å…¸æ­£åœ¨ rehashï¼Œé‚£ä¹ˆä¼šåœ¨æ‰«æå®Œå“ˆå¸Œè¡¨ 1 åï¼Œç»§ç»­æ‰«æå“ˆå¸Œè¡¨ 2ã€‚éœ€è¦</span></span><br><span class="line"><span class="comment">// æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨è¿­ä»£æœŸé—´ï¼Œç»§ç»­å‘å­—å…¸ä¸­æ·»åŠ æ•°æ®å¯èƒ½æ²¡æ³•è¢«æ‰«æåˆ°ï¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(it *iterator)</span> <span class="title">next</span><span class="params">()</span> *<span class="title">entry</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> it.entry == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> it.waitFirstIteration &#123;</span><br><span class="line">                <span class="comment">// ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œè¦åšç‚¹ç‰¹åˆ«çš„äº‹æƒ…~</span></span><br><span class="line">                <span class="keyword">if</span> it.safe &#123;</span><br><span class="line">                    <span class="comment">// å‘Šè¯‰ dictï¼Œæœ‰æ­£åœ¨è¿è¡Œçš„å®‰å…¨è¿­ä»£å™¨ï¼Œè¿›è€Œé˜»æ­¢æŸäº›æ“ä½œæ—¶çš„ Rehash æ“ä½œ</span></span><br><span class="line">                    it.d.iterators++</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    it.fingerprint = it.d.fingerprint()</span><br><span class="line">                &#125;</span><br><span class="line">                it.waitFirstIteration = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ht := it.d.hashTables[it.tableIndex]</span><br><span class="line">            <span class="keyword">if</span> it.bucketIndex &gt;= ht.size &#123;</span><br><span class="line">                <span class="keyword">if</span> !it.d.isRehashing() || it.tableIndex != <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ç»§ç»­æ‰«æ</span></span><br><span class="line">                it.tableIndex = <span class="number">1</span></span><br><span class="line">                it.bucketIndex = <span class="number">0</span></span><br><span class="line">                ht = it.d.hashTables[<span class="number">1</span>]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            it.entry = ht.buckets[it.bucketIndex]</span><br><span class="line">            it.bucketIndex++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            it.entry = it.entry.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> it.entry != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> it.entry</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    d := dict.New()</span><br><span class="line">    d.Store(<span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">    d.Store(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line">    fmt.Println(d.Load(<span class="string">"hello"</span>))</span><br><span class="line">    fmt.Println(d.LoadOrStore(<span class="string">"language"</span>, <span class="string">"Eng"</span>))</span><br><span class="line">    d.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        fmt.Println(key, <span class="string">"=&gt;"</span>, value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    _ = d.Resize()</span><br><span class="line">    d.RehashForAWhile(<span class="number">1</span> * time.Microsecond)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¥½å•¦ï¼Œå…³äº Redis å­—å…¸çš„å®ç°ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢å•¦ã€‚ç›¸ä¿¡çœ‹å®Œä¸Šé¢çš„ä»£ç åï¼Œåº”è¯¥å¯ä»¥äº†è§£åˆ° Redis å­—å…¸çš„æ‰©å®¹æœºåˆ¶ã€æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œä»¥åŠå“ˆå¸Œå†²çªè§£å†³æ–¹æ¡ˆã€‚å®Œæ•´çš„å®ç°ä»£ç åŠå…¶å•å…ƒæµ‹è¯•å‚è§ <a href="https://gitee.com/ifaceless/go-redis-dict" target="_blank" rel="noopener">go-redis-dict</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”®å€¼æ•°æ®åº“ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹åœ¨ &lt;a href=&quot;https://ifaceless.space/2019/12/15/redis-low-level-data-structures/&quot;&gt;Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„&lt;/a&gt;  ä¸­æåˆ°çš„ Redis å­—å…¸å®ç°çš„ä¸€äº›ç‰¹ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ”¯æŒæµ·é‡ &lt;code&gt;&amp;lt;key, value&amp;gt;&lt;/code&gt; å­˜å‚¨ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œé¿å…å› ä¸ºéœ€è¦è¿ç§»çš„ buckets å¤ªå¤šå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼ˆRedis æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;é»˜è®¤ä½¿ç”¨ SipHash ç®—æ³•è®¡ç®—é”®çš„ hash å€¼ï¼›&lt;/li&gt;
&lt;li&gt;å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œé‡‡ç”¨äº†å¸¸è§çš„é“¾åœ°å€æ³•ï¼Œä¸”æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼›&lt;/li&gt;
&lt;li&gt;å­—å…¸å†…éƒ¨ç»´æŠ¤äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¼šåœ¨æ‰©å®¹æœŸé—´ï¼ˆRehashï¼‰ä½¿ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="Redis" scheme="http://ifaceless.space/categories/Redis/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="Redis" scheme="http://ifaceless.space/tags/Redis/"/>
    
      <category term="å­—å…¸" scheme="http://ifaceless.space/tags/%E5%AD%97%E5%85%B8/"/>
    
  </entry>
  
  <entry>
    <title>Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„</title>
    <link href="http://ifaceless.space/2019/12/15/redis-low-level-data-structures/"/>
    <id>http://ifaceless.space/2019/12/15/redis-low-level-data-structures/</id>
    <published>2019-12-15T06:11:14.000Z</published>
    <updated>2019-12-15T06:17:36.398Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic4.zhimg.com/v2-1d46ebdc21d0364fefecf710d01f473d.jpeg" alt=""></p><p>Redis åº•å±‚çš„åŸºç¡€æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šåŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsdsï¼‰ã€è·³è¡¨ï¼ˆskiplistï¼‰ã€å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€æ•´æ•°é›†åˆï¼ˆintsetï¼‰ï¼Œå¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰ç­‰ï¼Œ<code>t_hash</code>ï¼Œ<code>t_set</code>, <code>t_zset</code>, <code>t_list</code> ç­‰å¯¹å¤–ç±»å‹çš„å†…éƒ¨å®ç°éƒ½ä¾èµ–äºè¿™äº›æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥éå¸¸å€¼å¾—å­¦ä¹ ã€‚</p><a id="more"></a><p>åœ¨å­¦ä¹ æ¯ç§æ•°æ®ç»“æ„æ—¶ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Œåšäº†ä»€ä¹ˆæ ·çš„æƒè¡¡ï¼Ÿæ¯”å¦‚ï¼Œæœ‰äº›æ•°æ®ç»“æ„æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥ä¼šç‰ºç‰²ä¸€å®šçš„æŸ¥æ‰¾æ•ˆç‡ï¼›</li><li>æ¯ç§æ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå…·ä½“åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹åº”ç”¨åˆ°ï¼Ÿ</li><li>ä¸€äº›æ•°æ®ç»“æ„æ¥å£çš„å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å¾ˆå¤šæ•°æ®ç»“æ„åœ¨ä¸Šå±‚ä½¿ç”¨æ—¶ï¼Œä¼šæ ¹æ®éœ€è¦é€‰æ‹©ï¼Œå¿…è¦æ—¶ä¼šè¿›è¡Œè½¬æ¢ã€‚éœ€è¦äº†è§£è½¬æ¢çš„æ—¶æœºå’Œè§¦å‘çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>æŸäº›æ•°æ®ç»“æ„å†…éƒ¨ä¼šæŒ‰éœ€æ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œéœ€è¦å…³æ³¨å®ƒä»¬æ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç­–ç•¥å¦‚ä½•ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘ï¼Ÿ</li></ol><p>æœ¬æ–‡çš„æºç å­¦ä¹ ç¬”è®°æ˜¯åŸºäº Redis 5.0.7 ç‰ˆæœ¬åšçš„ï¼Œè‡ªå·±åšäº†äº›ä¸­æ–‡æ³¨é‡Šï¼Œæ¨é€åˆ°äº† <a href="https://github.com/iFaceless/redis/blob/comment-src/src" target="_blank" rel="noopener">redis comment-src åˆ†æ”¯</a>ï¼Œå‚è€ƒä¹¦ç±ä¸ºã€ŠRedis 5 æºç è®¾è®¡ä¸åˆ†æã€‹ã€‚</p><p><strong>åšäº†ä¸€ä¸ªç®€å•çš„æ€ç»´å¯¼å›¾ï¼Œç®€å•æ€»ç»“äº†å„ä¸ªæ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹å’Œä¸€äº›å€¼å¾—é˜…è¯»æºç çš„ APIs</strong>ï¼Œå¦‚æœæƒ³è¦å¿«é€Ÿäº†è§£çš„è¯ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°æœ¬æ–‡æœ€åä¸€èŠ‚æŸ¥çœ‹~</p><h1 id="åŠ¨æ€å­—ç¬¦ä¸²"><a href="#åŠ¨æ€å­—ç¬¦ä¸²" class="headerlink" title="åŠ¨æ€å­—ç¬¦ä¸²"></a>åŠ¨æ€å­—ç¬¦ä¸²</h1><p>åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDS, Simple Dynamic Stringï¼‰æ˜¯ Redis ä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹ä¹‹ä¸€ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´æ•°ã€‚å¹¶ä¸”å®ƒæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œè¿˜å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²çš„ç»“æŸç¬¦ â€˜\0â€™ï¼Œæ‰€ä»¥éƒ¨åˆ† C æ ‡å‡†åº“ä¸­çš„å­—ç¬¦ä¸²å‡½æ•°ä¹Ÿå¯ä»¥å¯¹ SDS è¿›è¡Œæ“ä½œã€‚</p><p>åŠ¨æ€å­—ç¬¦ä¸²å…ƒä¿¡æ¯åŠå­˜å‚¨å­—ç¬¦ä¸²çš„ buf æ˜¯ç”± sdshdr* ç»´æŠ¤çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __attribute__ ((__packed__)) ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¦æ±‚ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ï¼ŒæŒ‰ç…§å®é™…çš„å­—èŠ‚æ•°è¿›è¡Œå¯¹é½ã€‚</span></span><br><span class="line"><span class="comment">// è¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ä¸ªï¼š</span></span><br><span class="line"><span class="comment">// 1. èŠ‚çº¦å†…å­˜ï¼ˆå¦åˆ™ä¸åŒçš„ sdshdr* å› ä¸ºä¸åŒçš„å­—èŠ‚å¯¹é½æ–¹å¼ï¼Œè€Œå¯¼è‡´å æ®è¾ƒå¤šå†…å­˜ï¼‰</span></span><br><span class="line"><span class="comment">// 2. é€šè¿‡ header è·å¾— buf åœ°å€æ—¶ï¼Œä¸ç”¨è€ƒè™‘ç¹ççš„å­—èŠ‚å¯¹é½é—®é¢˜è€Œå¯¼è‡´è®¡ç®—å¤æ‚</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="comment">// flags çš„ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ä¸‰ä½è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="comment">// len å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="comment">// alloc è¡¨ç¤ºæŸ”æ€§æ•°ç»„åˆ†é…çš„é•¿åº¦ï¼ˆä¸åŒ…å« header å’Œå­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦å·ï¼‰</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="comment">// flags ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ 5 ä½ä¿ç•™</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤–è¿˜æœ‰ sdshdr16, sdshdr32, sdshdr64ï¼ŒåŒºåˆ«ä»…åœ¨äº len, alloc ä½¿ç”¨çš„æ•´æ•°å­—èŠ‚é•¿åº¦</span></span><br></pre></td></tr></table></figure><p>å…³äº SDS çš„å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>å¦‚ä½•å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²æ ‡å‡†ï¼Ÿ</strong> SDS è¿”å›çš„å°±æ˜¯æŒ‡å‘å­˜å‚¨å­—ç¬¦ä¸² buf çš„æŒ‡é’ˆï¼Œä¸”ä»¥ â€˜\0â€™ ç»“å°¾ã€‚</li><li><strong>å¦‚ä½•èŠ‚çº¦å†…å­˜ï¼Ÿ</strong> SDS ä¸­æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œæä¾›äº†ä¸åŒç±»å‹çš„ç»“æ„ä½“è¡¨ç¤ºï¼ˆsdshdr5, sdshdr8, sdshdr16, sdshdr32, sdshdr64ï¼‰ï¼Œå¹¶ä¸”ç»“æ„ä½“ä¸­çš„å­—æ®µæŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼ˆ<code>((__packed__))</code>ï¼‰è¿›ä¸€æ­¥å‡å°‘å› é»˜è®¤å­—èŠ‚å¯¹é½æ–¹å¼å¸¦æ¥äº†å†…å­˜æ¶ˆè€—ï¼›åŒæ—¶æŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼Œä¹Ÿæ–¹ä¾¿åŸºäº header æŒ‡é’ˆè®¡ç®—å‡ºæŸ”æ€§æ•°ç»„çš„æŒ‡é’ˆã€‚</li><li><strong>å¦‚ä½•åšåˆ°äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿ</strong> SDS Header ç»“æ„ä½“ä¸­æ‹¥æœ‰ <code>len</code> å­—æ®µï¼Œè®°å½•äº†å®é™…å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸å«ç»“æŸç¬¦ï¼‰ï¼Œå› æ­¤åœ¨è¯»å–çš„æ—¶å€™å¯ä»¥ç¡®åˆ‡åœ°çŸ¥é“åœ¨å“ªå„¿åœæ­¢ï¼Œä¸ä¼šå—åˆ°ä¸­é—´çš„ â€˜\0â€™ å½±å“ã€‚</li><li><strong>SDS åœ¨åˆ›å»ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œä¸ºä½•å°† sdshdr5 è½¬æˆ sdshdr8ï¼Ÿ</strong> è€ƒè™‘åˆ° sdshdr5 å¯èƒ½éœ€è¦é¢‘ç¹æ‰©å®¹ï¼Œå¯¼è‡´å†…å­˜å¤åˆ¶å¼€é”€ã€‚ä½¿ç”¨ sdshdr8 å¯ä»¥æœ‰æ•ˆç¼“è§£ã€‚</li><li><strong>SDS å¯¹äºçŸ­å­—ç¬¦ä¸²ä¸ºä½•ä½¿ç”¨ sdshdr5ï¼Ÿ</strong> å¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå¤šæ•°çš„å­—ç¬¦ä¸²å¯èƒ½éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²ï¼ˆé•¿åº¦ 32 ä»¥å†…ï¼‰ã€‚</li><li><strong>SDS åœ¨å†™å…¥æ—¶å¯èƒ½ä¼šæ‰©å®¹ï¼Œé‚£ä¹ˆå®ƒçš„æ‰©å®¹ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ</strong>å®ƒçš„ç­–ç•¥æ¯”è¾ƒç®€å•ï¼Œå¦‚æœ buf å‰©ä½™ç©ºé—´ï¼ˆalloc-lenï¼‰èƒ½å¤Ÿæ”¾ä¸‹æ–°å¢çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ™ä¸ä¼šæœ‰å®è´¨çš„æ‰©å®¹å‘ç”Ÿï¼›å¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿï¼Œåˆ™éœ€è¦çœ‹ len+newLen çš„é•¿åº¦å€¼ï¼Œå¦‚æœå°äº 1MBï¼Œåˆ™æŒ‰ç…§ 2 å€æ‰©å®¹ï¼›å¦åˆ™æ¯æ¬¡å¢åŠ  1MBã€‚åœ¨æ‰©å®¹åï¼Œè¿˜è¦çœ‹æ–°çš„ header ç±»å‹ï¼ˆflags å­—æ®µè¡¨ç¤ºï¼‰æ˜¯å¦å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ realloc åŸåœ°æ‰©å®¹å³å¯ï¼›å¦åˆ™éœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿæ–°ç©ºé—´ï¼Œå¹¶ä½¿ç”¨ <code>memcopy</code> å¤åˆ¶æ•°æ®ã€‚å®Œæˆæ‰©å®¹åï¼Œéœ€è¦æ›´æ–° SDS çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶è¿”å›æ–°çš„ buf æŒ‡é’ˆï¼ˆä¹Ÿå¯èƒ½æŒ‡å‘åŸæ¥ä½ç½®ï¼Œå…·ä½“çœ‹æ‰©å®¹æ—¶çš„ç­–ç•¥æ‰§è¡Œï¼‰ã€‚</li></ol><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>è¯¦ç»†çš„æºç æ³¨é‡Šå‚è§ <a href="https://github.com/iFaceless/redis/blob/9366cba9171ea96f54b96f7d83e654958fe9b71f/src/sds.c#L90" target="_blank" rel="noopener">è¿™é‡Œ</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sdsnewlen åˆ›å»ºä¸€ä¸ªæ–°çš„ sds å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ init æŒ‡å‘çš„å†…å®¹åˆå§‹åŒ–</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh;</span><br><span class="line">    sds s;</span><br><span class="line">    <span class="keyword">char</span> type = sdsReqType(initlen);</span><br><span class="line">    <span class="comment">// ç©ºå­—ç¬¦ä¸²åˆ›å»ºé€šå¸¸éƒ½éœ€è¦æ‰§è¡Œ append è¿½åŠ å­—ç¬¦ä¸²ã€‚ä½¿ç”¨ type 8 æ¯”è¾ƒé€‚åˆï¼Œ</span></span><br><span class="line">    <span class="comment">// type 5 å¯èƒ½ç©ºé—´ä¸è¶³ï¼Œè¿˜éœ€è¦æ‰§è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="number">0</span>) type = SDS_TYPE_8;</span><br><span class="line">    <span class="keyword">int</span> hdrlen = sdsHdrSize(type); <span class="comment">// æ ¹æ®æ•°æ®ç±»å‹ç¡®å®š header é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp; <span class="comment">/* flags pointer. */</span></span><br><span class="line">    sh = s_malloc(hdrlen+initlen+<span class="number">1</span>); <span class="comment">// åˆ†é… sds å†…å­˜ï¼Œ+1 ä¸ºäº†å­˜å‚¨ '\0'</span></span><br><span class="line">    <span class="keyword">if</span> (init==SDS_NOINIT)</span><br><span class="line">        init = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!init)</span><br><span class="line">        <span class="built_in">memset</span>(sh, <span class="number">0</span>, hdrlen+initlen+<span class="number">1</span>); <span class="comment">// å†…å­˜åˆå§‹åŒ–ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    s = (<span class="keyword">char</span>*)sh+hdrlen; <span class="comment">// æ‹¿åˆ°æŒ‡å‘ buf çš„æŒ‡é’ˆ</span></span><br><span class="line">    fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>; <span class="comment">// point to flag, æ³¨æ„ flag å…¶å®æ˜¯ unsigned char ç±»å‹</span></span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5: &#123;</span><br><span class="line">            <span class="comment">// type 5 çš„ flag æ¯”è¾ƒç‰¹æ®Šï¼Œç±»å‹ä¿ç•™åœ¨ä½ 3 ä½</span></span><br><span class="line">            *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">8</span>,s);</span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// SDS_TYPE_16, SDS_TYPE_32, SDS_TYPE_64...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (initlen &amp;&amp; init)</span><br><span class="line">        <span class="built_in">memcpy</span>(s, init, initlen); <span class="comment">// å°†ç”¨æˆ·æŒ‡å®šåŒºåŸŸçš„æ•°æ®æ‹·è´è¿‡æ¥ï¼Œä¸è€ƒè™‘ \0ï¼ŒäºŒè¿›åˆ¶å®‰å…¨</span></span><br><span class="line">    s[initlen] = <span class="string">'\0'</span>; <span class="comment">// C è¯­è¨€å­—ç¬¦ä¸²ä»¥ '\0' ç»“å°¾</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// s å®é™…æŒ‡å‘çš„æ˜¯ buf ä½ç½®ï¼Œè¿™é‡Œéœ€è¦è®¡ç®—å‡º header æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// flag å§‹ç»ˆä½äº buf å‰é¢ï¼Œæ‰€ä»¥ s[-1] å¯ä»¥å¾—åˆ° flagï¼Œè¿›è€Œ</span></span><br><span class="line">    <span class="comment">// ç¡®å®š typeï¼Œä»è€Œå¯ä»¥è®¡ç®—å‡º header é•¿åº¦</span></span><br><span class="line">    s_free((<span class="keyword">char</span>*)s-sdsHdrSize(s[<span class="number">-1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh, *newsh;</span><br><span class="line">    <span class="keyword">size_t</span> avail = sdsavail(s); <span class="comment">// ç¡®å®š buf å‰©ä½™çš„ç©ºé—´ï¼ˆalloc-lenï¼‰</span></span><br><span class="line">    <span class="keyword">size_t</span> len, newlen;</span><br><span class="line">    <span class="keyword">char</span> type, oldtype = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class="line">    <span class="keyword">int</span> hdrlen;</span><br><span class="line">    <span class="comment">/* Return ASAP if there is enough space left. */</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= addlen)</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    <span class="comment">// ç¡®å®šç°æœ‰å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    len = sdslen(s);</span><br><span class="line">    <span class="comment">// è·å¾—å­—ç¬¦ä¸²å¯¹åº”çš„ sdshdr æŒ‡é’ˆ</span></span><br><span class="line">    sh = (<span class="keyword">char</span> *)s - sdsHdrSize(oldtype);</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„æ–°é•¿åº¦æ˜¯åé¢æ‰©å®¹ç­–ç•¥æ‰§è¡Œçš„ä¾æ®</span></span><br><span class="line">    newlen = (len + addlen);</span><br><span class="line">    <span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class="line">        <span class="comment">// ç›®å‰æ˜¯ 1MB ä»¥å†…ï¼Œ2 å€æ‰©å®¹</span></span><br><span class="line">        newlen *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éƒ½æ˜¯åŠ  1MB</span></span><br><span class="line">        newlen += SDS_MAX_PREALLOC;</span><br><span class="line">    type = sdsReqType(newlen);</span><br><span class="line">    <span class="comment">/* Don't use type 5: the user is appending to the string and type 5 is</span></span><br><span class="line"><span class="comment">     * not able to remember empty space, so sdsMakeRoomFor() must be called</span></span><br><span class="line"><span class="comment">     * at every appending operation. */</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5)</span><br><span class="line">        type = SDS_TYPE_8;</span><br><span class="line">    hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="keyword">if</span> (oldtype == type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç±»å‹ä¸å˜ï¼Œåˆ™æ‰§è¡Œæ‰©å®¹</span></span><br><span class="line">        newsh = s_realloc(sh, hdrlen + newlen + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// è·å–æ–°çš„ sds æŒ‡å‘</span></span><br><span class="line">        s = (<span class="keyword">char</span> *)newsh + hdrlen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Since the header size changes, need to move the string forward,</span></span><br><span class="line"><span class="comment">         * and can't use realloc */</span></span><br><span class="line">        <span class="comment">// ç”±äº header å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿç©ºé—´äº†</span></span><br><span class="line">        newsh = s_malloc(hdrlen + newlen + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// å°† sds ä¸­çš„å†…å®¹æ‹·è´åˆ°æ–°çš„ç©ºé—´ï¼ŒåŒ…æ‹¬ \0</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)newsh + hdrlen, s, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ—§çš„å†…å­˜</span></span><br><span class="line">        s_free(sh);</span><br><span class="line">        <span class="comment">// è·å–æ–°çš„ sds æŒ‡é’ˆ</span></span><br><span class="line">        s = (<span class="keyword">char</span> *)newsh + hdrlen;</span><br><span class="line">        <span class="comment">// æ›´æ–° flags</span></span><br><span class="line">        s[<span class="number">-1</span>] = type;</span><br><span class="line">        <span class="comment">// æ›´æ–°é•¿åº¦ä¿¡æ¯</span></span><br><span class="line">        sdssetlen(s, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°åˆ†é…çš„ç©ºé—´å¤§å°</span></span><br><span class="line">    sdssetalloc(s, newlen);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è·³è¡¨ï¼ˆskiplistï¼‰"><a href="#è·³è¡¨ï¼ˆskiplistï¼‰" class="headerlink" title="è·³è¡¨ï¼ˆskiplistï¼‰"></a>è·³è¡¨ï¼ˆskiplistï¼‰</h1><p>è·³è¡¨æ˜¯ Redis é›†åˆï¼ˆzsetï¼‰åº•å±‚çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼ˆå¦ä¸€ç§æ˜¯ ziplistï¼‰ã€‚è·³è¡¨çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>åŸç†ç®€å•ï¼Œå®ç°éš¾åº¦è¿œä½äºå¹³è¡¡æ ‘ï¼ˆçº¢é»‘æ ‘ï¼‰ï¼›</li><li>å¯¹äºæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤ï¼Œå¹³å‡ O(logN) æ—¶é—´å¤æ‚åº¦ï¼Œæ•ˆç‡å’Œçº¢é»‘æ ‘ç›¸å½“ï¼›</li><li>å†…å­˜å¼€é”€ç›¸å¯¹å¹³è¡¡æ ‘å¹¶æ²¡æœ‰ç‰¹åˆ«å¤§ï¼›</li><li>ç‰¹åˆ«å®¹æ˜“å®ç° Redis zset ä¸­èŒƒå›´æŸ¥è¯¢ã€‚</li></ol><p>è·³è¡¨æ ¸å¿ƒè¦ç´ ï¼š<strong>åˆ†å±‚</strong> + <strong>æœ‰åºé“¾è¡¨</strong>ã€‚</p><p>è·³è¡¨æŸ¥æ‰¾è¿‡ç¨‹æè¿°ï¼šä»æœ€ä¸Šå±‚ä¾æ¬¡å‘åæŸ¥æ‰¾ï¼Œå¦‚æœæœ¬å±‚çš„ next èŠ‚ç‚¹å¤§äºè¦æŸ¥æ‰¾çš„å€¼ï¼Œæˆ–è€… next èŠ‚ç‚¹ä¸º NULLï¼Œåˆ™ä»æœ¬èŠ‚ç‚¹å¼€å§‹ï¼Œé™ä½ä¸€å±‚ç»§ç»­å¾€åæŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œåˆ™è¿”å›ï¼›å¦åˆ™è¿”å› NULLã€‚</p><p><em>æ­¤å‰ä½¿ç”¨ Go è¯­è¨€å°è¯•å®ç°äº†ä¸‹ Redis è·³è¡¨ï¼Œç›¸å…³æ–‡ç« å‚è§ <a href="https://zhuanlan.zhihu.com/p/96849002" target="_blank" rel="noopener">Go è¯­è¨€å®ç° Redis è·³è¡¨</a>ï¼Œæºç åŠæ³¨é‡Šå‚è§ <a href="https://link.zhihu.com/?target=https%3A//gitee.com/ifaceless/goskiplist/tree/master" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚æ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥é˜…è¯»ä¸‹~</em></p><h2 id="Redis-è·³è¡¨å®ç°ç‰¹ç‚¹"><a href="#Redis-è·³è¡¨å®ç°ç‰¹ç‚¹" class="headerlink" title="Redis è·³è¡¨å®ç°ç‰¹ç‚¹"></a>Redis è·³è¡¨å®ç°ç‰¹ç‚¹</h2><p><img src="https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png" alt=""></p><ol start="0"><li>æœ€å¤šæœ‰ 64 å±‚ï¼Œå¯ä»¥è¡¨ç¤º 2^64 ä¸ªå…ƒç´ ï¼›</li><li>æ‹¥æœ‰ backward åé€€æŒ‡é’ˆï¼Œæ–¹ä¾¿åå‘éå†ï¼›</li><li>æ·»åŠ äº† span å­—æ®µï¼Œè®°å½• forward æŒ‡å‘çš„èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„é—´éš”ã€‚span è¶Šå¤§ï¼Œè·³è¿‡çš„èŠ‚ç‚¹ä¼šè¶Šå¤šã€‚åœ¨è®¡ç®—æ’åï¼ˆrankï¼‰æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ span è®¡ç®—å¾—åˆ°ï¼›</li><li>æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œå±‚é«˜æ˜¯é€šè¿‡ <code>zlsRandomLevel()</code> å‡½æ•°éšæœºç”Ÿæˆçš„ï¼ŒèŒƒå›´æ˜¯ [1, 64]ã€‚ä½†æ˜¯è¯¥å‡½æ•°ä¼šä¿è¯è¶Šé«˜ level å€¼çš„å‡ºç°çš„æ¦‚ç‡è¶Šä½ã€‚èŠ‚ç‚¹çš„å±‚é«˜ç¡®å®šåï¼Œå°†ä¸ä¼šæ”¹è¾¹ï¼›</li><li>èŠ‚ç‚¹ä¸­çš„ score å…è®¸é‡å¤ã€‚</li></ol><h2 id="è·³è¡¨çš„å…·ä½“åº”ç”¨"><a href="#è·³è¡¨çš„å…·ä½“åº”ç”¨" class="headerlink" title="è·³è¡¨çš„å…·ä½“åº”ç”¨"></a>è·³è¡¨çš„å…·ä½“åº”ç”¨</h2><p>zset ä¼šä½¿ç”¨è·³è¡¨å­˜å‚¨æ•°æ®ï¼Œä½†æ˜¯å®ƒä¼šæ ¹æ®é…ç½® <code>zset-max-ziplist-entries 128</code> å’Œ <code>zset-max-ziplist-value 64</code> å€¼æ¥ç¡®å®šè¯¥ä½¿ç”¨è·³è¡¨è¿˜æ˜¯ ziplistã€‚å¦å¤–ï¼Œåœ¨æ–°å¢å…ƒç´ æ—¶ï¼Œå¦‚æœåŸå…ˆæ˜¯ ziplistï¼Œå½“ä¸´ç•Œæ¡ä»¶è¾¾åˆ°æ—¶ï¼Œä¼šè¢«è½¬æ¢æˆ skiplistï¼Œè€Œä¸”è½¬å˜åå°±ä¸å¯é€†äº†ã€‚</p><h2 id="æ ¸å¿ƒæºç -1"><a href="#æ ¸å¿ƒæºç -1" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>ä¸è·³è¡¨ç›¸å…³çš„å‡ ä¸ªé‡è¦çš„å‡½æ•°ä½œäº†æ³¨é‡Šï¼Œå‚è§ <a href="https://github.com/iFaceless/redis/blob/9366cba9171ea96f54b96f7d83e654958fe9b71f/src/t_zset.c#L144" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚éœ€è¦é‡ç‚¹å…³æ³¨çš„å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zskiplist *<span class="title">zslCreate</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslDeleteNode</span><span class="params">(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslDelete</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele, zskiplistNode **node)</span></span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslUpdateScore</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> curscore, sds ele, <span class="keyword">double</span> newscore)</span></span></span><br></pre></td></tr></table></figure></p><p>åœ¨çœ‹æºç æ—¶ï¼Œä¼šç»å¸¸çœ‹åˆ° <code>update[]</code> æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„æ˜¯ç”¨æ¥å­˜æ”¾æ¯ä¸€å±‚éœ€è¦è¢«æ›´æ–°çš„èŠ‚ç‚¹ï¼ˆåœ¨å¢åŠ ã€åˆ é™¤èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°ï¼‰ï¼ŒæŠŠå®ƒçœ‹æˆ <code>pending_update_nodes</code> æˆ–è®¸ä¼šæ›´å¥½ç†è§£ç‚¹ã€‚<br>å¦å¤–ï¼Œåœ¨å¢ã€åˆ ã€æ”¹çš„æ—¶å€™ï¼Œéƒ½ä¼šæ¶‰åŠåˆ° <code>span</code> çš„æ›´æ–°ï¼Œéœ€è¦ä»”ç»†æ–Ÿé…Œè®¡ç®—é€»è¾‘ï¼Œä¸€ä¸å°å¿ƒå°±ç®—é”™äº†ã€‚</p><h1 id="å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰"><a href="#å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰" class="headerlink" title="å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰"></a>å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰</h1><p>å‹ç¼©è¡¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæ˜¯ä¸€ç§ä¸ºèŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„æ•°æ®ç»“æ„ã€‚å¯ä»¥å­˜å‚¨å¤šä¸ªå…ƒç´ ï¼Œä¸”æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯æ•´æ•°æˆ–è€…å­—ç¬¦ä¸²ï¼ˆè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—èŠ‚æ•°ç»„ï¼‰ã€‚ä¸¤ç«¯æ“ä½œï¼ˆpop/pushï¼‰æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œä½†è€ƒè™‘åˆ°å®ƒæ¯æ¬¡æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œéƒ½éœ€è¦è°ƒæ•´å†…å­˜ï¼ˆæ‰©å®¹æˆ–è€…ç¼©å°å†…å­˜å ç”¨ï¼‰ï¼Œæ‰€ä»¥å®é™…çš„æ—¶é—´å¤æ‚åº¦å’Œå®ƒå ç”¨çš„å†…å­˜æœ‰å…³ã€‚</p><p>ziplist åœ¨<strong>æ•£åˆ—è¡¨ã€åˆ—è¡¨å’Œæœ‰åºé›†åˆ</strong>ä¸­å‡æœ‰ï¼ˆç›´æ¥æˆ–é—´æ¥åœ°ï¼‰åº”ç”¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>object encoding &lt;key&gt;</code> æ¥æŸ¥çœ‹å…·ä½“çš„ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; zadd visitors 1.0 a</span><br><span class="line">&gt; object encoding visitors</span><br><span class="line">&quot;ziplist&quot;</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h2><p>åœ¨ Redis çš„ <code>ziplist.c</code> ä¸­ï¼Œä½œè€…åœ¨æ³¨é‡Šä¸­ç»™å‡ºäº†å‹ç¼©åˆ—è¡¨å­˜å‚¨å¸ƒå±€ï¼Œå¹¶ä¸”ç»™å‡ºäº†éå¸¸è¯¦ç»†çš„è¯´æ˜å’Œç¤ºä¾‹ï¼Œå€¼å¾—é˜…è¯»ã€‚æ•´ä½“æ¥çœ‹ï¼Œå‹ç¼©åˆ—è¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š<br><img src="https://pic4.zhimg.com/80/v2-0da8094f90661a53f47145881faf3315.png" alt=""></p><table><thead><tr><th>å­—æ®µå</th><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>å‹ç¼©è¡¨å­—èŠ‚é•¿åº¦ï¼ˆåŒ…æ‹¬ <code>zlbytes</code> è‡ªå·±ï¼‰</td></tr><tr><td>zltail</td><td>uint32_t</td><td>å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»ï¼Œå¦‚æ­¤æ–¹ä¾¿å¿«é€Ÿ pop æœ€åä¸€ä¸ªå…ƒç´ </td></tr><tr><td>zllen</td><td>uint16_t</td><td>è¡¨ç¤º entries çš„ä¸ªæ•°ï¼Œæœ€å¤§æœ‰æ•ˆå€¼ä¸º <code>2^16-2</code>ï¼Œä¸€æ—¦è¶…å‡ºï¼Œè¯¥å€¼å›ºå®šä¸º <code>2^16-1</code>ï¼Œå¹¶ä¸”éœ€è¦éå†æ•´ä¸ªåˆ—è¡¨æ‰èƒ½å¾—åˆ°å‡†ç¡®çš„é•¿åº¦</td></tr><tr><td>zlend</td><td>uint8_t</td><td>å›ºå®šä¸º <code>0xff</code>ï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„ç»“å°¾</td></tr></tbody></table><h2 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ¯ä¸ª entry ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://pic4.zhimg.com/80/v2-84cb4d8cd05b321b4f611a492471c88a.png" alt=""></p><p>å…¶ä¸­ï¼Œ<code>prevlen</code> è¡¨ç¤ºå‰ä¸€ä¸ª <code>entry</code> çš„å­—èŠ‚æ•°ï¼Œä¾¿äºä»åå‘å‰éå†ï¼›<code>encoding</code> åˆ™è¡¨ç¤ºå½“å‰ <code>entry</code> çš„ç¼–ç ï¼ˆæ•´æ•°ç±»å‹ï¼Ÿå­—ç¬¦ä¸²ç±»å‹ï¼Ÿï¼‰ï¼›è€Œ <code>entry-data</code> åˆ™æ˜¯çœŸå®å­˜å‚¨å†…å®¹çš„éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œè¿™é‡Œçš„ <code>prevlen</code> å’Œ <code>encoding</code> éƒ½æ˜¯å˜é•¿çš„ï¼Œè€Œ <code>entry-data</code> åˆ™å¯èƒ½æ²¡æœ‰ï¼ˆæ¯”å¦‚å­˜å‚¨å°æ•´æ•° 0~12 æ—¶ï¼‰ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>prevlen</code> é‡‡ç”¨ <code>uint8_t</code> ç±»å‹ï¼Œå¯è¡¨ç¤ºæœ€å¤š 253 å­—èŠ‚é•¿åº¦ï¼Œè¶…å‡º 253 åï¼Œå°†ä¼šä½¿ç”¨ 5 ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// å¸¸è§„æƒ…å†µä¸‹</span><br><span class="line">&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;</span><br><span class="line">// é•¿åº¦è¶…è¿‡ 253 å</span><br><span class="line">0xFE &lt;4 å­—èŠ‚ï¼Œå°ç«¯åº prevlen&gt; &lt;encoding&gt; &lt;entry&gt;</span><br></pre></td></tr></table></figure><p><code>encoding</code> å­—æ®µä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒå ç”¨å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå’Œå®é™…è¦å­˜å‚¨çš„å†…å®¹æœ‰å…³ï¼š</p><ul><li>å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ <code>encoding</code> çš„å‰ä¸¤ä½è¡¨ç¤ºç±»å‹ï¼Œå‰©ä¸‹çš„åˆ™è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼š<ul><li><code>|00pppppp|</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 64 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œ<code>pppppp</code> è¡¨ç¤º 6 ä½æ— ç¬¦å·æ•´æ•°</li><li><code>|01pppppp|qqqqqqqq| - 2 å­—èŠ‚</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^14 å­—èŠ‚çš„å­—ç¬¦ä¸²</li><li><code>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 å­—èŠ‚</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^32 çš„å­—ç¬¦ä¸² </li></ul></li><li>å¦‚æœæ˜¯æ•´æ•°ç±»å‹ï¼Œåˆ™ <code>encoding</code> çš„å‰ä¸¤ä½æ€»æ˜¯ 1ï¼Œç´§æ¥ç€çš„ä¸¤ä½åˆ™è¡¨ç¤ºå…·ä½“çš„æ•´æ•°ç±»å‹ï¼š<ul><li><code>|11000000|</code>ï¼šint16</li><li><code>|11010000|</code>ï¼šint32</li><li><code>|11100000|</code>ï¼šint64</li><li><code>|11110000|</code>ï¼š24 ä½æœ‰ç¬¦å·æ•´æ•°</li><li><code>|11111110|</code>ï¼š8 ä½æœ‰ç¬¦å·æ•´æ•°</li><li><code>|1111xxxx|</code>ï¼šè¡¨ç¤º 4 ä½ç«‹å³æ•´æ•°ï¼ˆimediate integerï¼‰ï¼Œ0~12 æ— ç¬¦å·æ•´æ•°ï¼Œæ­¤æ—¶æ²¡æœ‰ <code>entry-data</code> å­—æ®µäº†</li></ul></li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ ¹æ®ä¸Šé¢æè¿°çš„ ziplist ç¼–ç ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ¡ä»¶ä¸‹å®ƒä¼šå ç”¨è¾ƒå¤šå†…å­˜ï¼Ÿä¸ºä»€ä¹ˆè¯´ ziplist é€‚åˆå­˜å‚¨ä¸ªæ•°è¾ƒå°‘ï¼Œä¸”é•¿åº¦è¾ƒçŸ­çš„å…ƒç´ å‘¢ï¼Ÿ</p><ol><li>é€šè¿‡ <code>zzlen</code> å¯çŸ¥ï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°è¶…å‡º <code>2^16-2</code> æ—¶ï¼Œéœ€è¦éå†æ•´ä¸ª ziplist å…ƒç´ æ‰å¯ä»¥çŸ¥é“å…·ä½“çš„é•¿åº¦ï¼Œæ•ˆç‡è‡ªç„¶ä¼šé™ä½å¾ˆå¤šï¼›</li><li>é€šè¿‡ <code>prevlen</code> å¯çŸ¥ï¼Œå¦‚æœå‰ä¸€ä¸ª <code>entry</code> è¶…å‡ºå…¶è¡¨ç¤ºçš„èŒƒå›´æ—¶ï¼ˆ253 å­—èŠ‚ï¼‰ï¼Œå°±éœ€è¦ç”±åŸæ¥çš„ 1 ä¸ªå­—èŠ‚å˜æˆ 5 å­—èŠ‚è¡¨ç¤ºï¼›</li><li>é€šè¿‡ <code>encoding</code> å¯çŸ¥ï¼Œå¯¹äºå­—ç¬¦ä¸²ç±»å‹å…ƒç´ ï¼Œé•¿åº¦è¶Šé•¿ï¼Œ<code>encoding</code> éœ€è¦å ç”¨çš„å­—èŠ‚è¶Šå¤šã€‚å°¤å…¶æ˜¯åœ¨è¶…å‡º <code>2^14-1</code>  æ—¶ï¼Œæ–°çš„ <code>encoding</code> è¿˜è¦æµªè´¹ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸­çš„å 6 ä½ï¼Œè€Œä½¿ç”¨åé¢çš„ 32 ä½æ•´æ•°æ¥è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ã€‚</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå½±å“å†…å­˜å ç”¨å’Œæ‰§è¡Œæ•ˆç‡çš„ä¸»è¦å› ç´ å¦‚ä¸‹ï¼š</p><ol><li>å…ƒç´ ä¸ªæ•°ï¼›</li><li>å…ƒç´ ç±»å‹ï¼›</li><li>å…ƒç´ é•¿åº¦ã€‚</li></ol><h2 id="æ ¸å¿ƒæºç -2"><a href="#æ ¸å¿ƒæºç -2" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>ä¸ºäº†æ–¹ä¾¿è·å¾—æ¯ä¸ª entry ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œåœ¨ <code>ziplist.c</code> ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>zlentry</code> ç»“æ„ä½“ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯è¯¥ç»“æ„ä½“å¹¶é entry å®é™…ç¼–ç çš„å¸ƒå±€ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zlentry å­˜åœ¨çš„ç›®çš„å°±æ˜¯ä¿å­˜æ¯ä¸ª entry è§£ç åçš„å…ƒä¿¡æ¯ã€‚å› ä¸ºå®é™…æ¯æ¬¡å¯¹ length, encoding</span></span><br><span class="line"><span class="comment">// ç­‰è¿›è¡Œè§£ç æ˜¯æ¯”è¾ƒå¤æ‚çš„è¿ç®—ï¼Œè¿™é‡Œç¼“å­˜ä¸‹æ¥ä¹Ÿä¾¿äºåç»­æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œzlentry å¹¶éçœŸå®çš„ entry ç¼–ç ç»“æ„ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zlentry</span> &#123;</span></span><br><span class="line">    <span class="comment">// prevrawlensize è¡¨ç¤º `prevlen` å ç”¨äº†å‡ ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> prevrawlensize; <span class="comment">/* Bytes used to encode the previous entry len*/</span></span><br><span class="line">    <span class="comment">// prevrawlen è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å®é™…é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> prevrawlen; <span class="comment">/* Previous entry len. */</span></span><br><span class="line">    <span class="comment">// lensize è¡¨ç¤º `encoding` å ç”¨äº†å‡ ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> lensize; <span class="comment">/* Bytes used to encode this entry type/len.</span></span><br><span class="line"><span class="comment">                                    For example strings have a 1, 2 or 5 bytes</span></span><br><span class="line"><span class="comment">                                    header. Integers always use a single byte.*/</span></span><br><span class="line">    <span class="comment">// len è¡¨ç¤º entry å†…å®¹çœŸæ­£çš„é•¿åº¦ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼›å¦‚æœæ˜¯æ•´æ•°</span></span><br><span class="line">    <span class="comment">// åˆ™å¯èƒ½çš„å€¼ä¸º 0ï¼ˆ4 ä½å°æ•´æ•°ï¼‰ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ8ï¼ˆå’Œå…·ä½“çš„ int ç±»å‹æœ‰å…³ï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len; <span class="comment">/* Bytes used to represent the actual entry.</span></span><br><span class="line"><span class="comment">                                    For strings this is just the string length</span></span><br><span class="line"><span class="comment">                                    while for integers it is 1, 2, 3, 4, 8 or</span></span><br><span class="line"><span class="comment">                                    0 (for 4 bit immediate) depending on the</span></span><br><span class="line"><span class="comment">                                    number range. */</span></span><br><span class="line">    <span class="comment">// headersize è¡¨ç¤ºæ•´ä¸ª header éƒ¨åˆ†é•¿åº¦ï¼š&lt;prevlen&gt; + &lt;encoding&gt;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> headersize; <span class="comment">/* prevrawlensize + lensize. */</span></span><br><span class="line">    <span class="comment">// encoding è¡¨ç¤ºå…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œå¦‚æœ `ZIP_STR_*`,`ZIP_INT_*`</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯å°æ•´æ•°ï¼Œè¿˜è¦åšèŒƒå›´æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> encoding; <span class="comment">/* Set to ZIP_STR_* or ZIP_INT_* depending on</span></span><br><span class="line"><span class="comment">                                    the entry encoding. However for 4 bits</span></span><br><span class="line"><span class="comment">                                    immediate integers this can assume a range</span></span><br><span class="line"><span class="comment">                                    of values and must be range-checked. */</span></span><br><span class="line">    <span class="comment">// p æŒ‡å‘å…ƒç´ å¼€å¤´çš„æŒ‡é’ˆï¼Œå®é™…æŒ‡å‘çš„å°±æ˜¯ `prevlen` ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p; <span class="comment">/* Pointer to the very start of the entry, that</span></span><br><span class="line"><span class="comment">                                    is, this points to prev-entry-len field. */</span></span><br><span class="line">&#125; zlentry;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç”»ä¸€ä¸ªç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://pic2.zhimg.com/v2-74aa62891936d8a5ebd929fe2fcf4656.jpg" alt=""></p><p>ziplist ç›¸å…³çš„æºç å‚è§ <a href="https://github.com/iFaceless/redis/blob/comment-src/src/ziplist.c" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistNew</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistPush</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">int</span> slen, <span class="keyword">int</span> where)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistInsert</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *p, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">int</span> slen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistDelete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> **p)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistFind</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *p, <span class="keyword">unsigned</span> <span class="keyword">char</span> *vstr, <span class="keyword">unsigned</span> <span class="keyword">int</span> vlen, <span class="keyword">unsigned</span> <span class="keyword">int</span> skip)</span></span>;</span><br></pre></td></tr></table></figure><p>ziplist ä¸­æ¯”è¾ƒæ™¦æ¶©æˆ–è€…æ¯ç‡¥çš„éƒ¨åˆ†æ˜¯ç¼–ç ã€è§£ç æ“ä½œï¼›å…¶æ¬¡ï¼Œæ¯æ¬¡å¢åŠ æˆ–è€…ç§»é™¤å…ƒç´ æ—¶ï¼Œéƒ½æ¶‰åŠåˆ°å¾ˆå¤šå†…å­˜æ“ä½œï¼ˆåˆ†é…ç©ºé—´ã€å†…å­˜æ‹·è´ï¼‰ä»¥åŠ entry header çš„è°ƒæ•´ã€‚æƒ³è¦å†™å‡ºå¯é çš„ä»£ç æ¥ï¼Œè¿˜æ˜¯éœ€è¦å¿ƒæ€ç¼œå¯†ï¼Œé€»è¾‘æ¸…æ™°æ‰å¯ä»¥ï¼Œå¤§ä½¬ä»¬çš„ç¼–ç èƒ½åŠ›å®åœ¨æ˜¯å¤ªå¼ºæ‚äº†ï¼</p><p>è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯ï¼Œå…ƒç´ çš„æ’å…¥å’Œåˆ é™¤ï¼Œå¯èƒ½ä¼šäº§ç”Ÿ<strong>è¿é”æ›´æ–°</strong>é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è‡ªæ’å…¥ç‚¹ï¼ˆæˆ–åˆ é™¤ç‚¹ï¼‰åç»­çš„ entry prevlen éƒ½éœ€è¦ä¿®æ”¹ï¼ˆè¿˜è®°å¾—å‰é¢æåˆ°çš„ entry prevlen æ˜¯å˜é•¿çš„å—ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å°† prevlen å¢é•¿åˆ° 5 å­—èŠ‚å®¹çº³æ›´å¤§çš„å€¼ï¼›ä½†æ˜¯åè¿‡æ¥ï¼Œå¹¶æ²¡æœ‰å…è®¸ç¼©å®¹ï¼‰ã€‚ä¸è¿‡è¿™ç§æƒ…å†µï¼Œåªæœ‰åœ¨åç»­å…ƒç´ çš„å¤§å°æ¥è¿‘äº <code>ZIP_BIG_PREVLEN</code> æ‰å¯èƒ½å‘ç”Ÿï¼Œæ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥å®é™…ä¸Šä¹Ÿæ²¡åšä»€ä¹ˆä¼˜åŒ–ã€‚å…·ä½“ç­–ç•¥çš„å®ç°å¯ä»¥å‚è€ƒ <code>__ziplistCascadeUpdate()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *__ziplistCascadeUpdate(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;</span><br><span class="line">    <span class="keyword">size_t</span> offset, noffset, extra;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *np;</span><br><span class="line">    zlentry cur, next;</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="keyword">while</span> (p[<span class="number">0</span>] != ZIP_END)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰ entry é•¿åº¦å­˜å‚¨éœ€è¦çš„å­—èŠ‚æ•°ï¼šrawlensize</span></span><br><span class="line">        zipEntry(p, &amp;cur);</span><br><span class="line">        rawlen = cur.headersize + cur.len;</span><br><span class="line">        rawlensize = zipStorePrevEntryLength(<span class="literal">NULL</span>, rawlen);</span><br><span class="line">        <span class="keyword">if</span> (p[rawlen] == ZIP_END)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        zipEntry(p + rawlen, &amp;next);</span><br><span class="line">        <span class="comment">// å¦‚æœé•¿åº¦ä¸å˜ï¼Œåˆ™ç›´æ¥é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (next.prevrawlen == rawlen)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (next.prevrawlensize &lt; rawlensize) &#123;</span><br><span class="line">            <span class="comment">// ä¸‹ä¸€ä¸ªå…ƒç´ çš„ prevlen éœ€è¦æ›´å¤šå­—èŠ‚æ¥å­˜å‚¨ prevrawlen å€¼</span></span><br><span class="line">            offset = p - zl;</span><br><span class="line">            extra = rawlensize - next.prevrawlensize;</span><br><span class="line">            <span class="comment">// æ‰©å®¹ä»¥æ”¯æŒå­˜å‚¨æ›´é•¿çš„ rawlen</span></span><br><span class="line">            zl = ziplistResize(zl, curlen + extra); <span class="comment">// å¢åŠ  extra ç©ºé—´</span></span><br><span class="line">            p = zl + offset;</span><br><span class="line">            np = p + rawlen;</span><br><span class="line">            noffset = np - zl;</span><br><span class="line">            <span class="comment">// æ›´æ–° tail åç§»ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„ä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> ((zl + intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np)</span><br><span class="line">            &#123;</span><br><span class="line">                ZIPLIST_TAIL_OFFSET(zl) =</span><br><span class="line">                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)) + extra);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†åç»­ entry æ¬ç§»ï¼Œè…¾æŒªå‡ºç©ºé—´å­˜æ”¾æ–°çš„é•¿åº¦å€¼</span></span><br><span class="line">            memmove(np + rawlensize,</span><br><span class="line">                    np + next.prevrawlensize,</span><br><span class="line">                    curlen - noffset - next.prevrawlensize - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// next entry prevlen è®°å½•ä¸‹ä¹‹å‰ entry çš„é•¿åº¦å€¼        </span></span><br><span class="line">            zipStorePrevEntryLength(np, rawlen);</span><br><span class="line">            <span class="comment">// ...ç»§ç»­ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡éƒ½å¯èƒ½æ¶‰åŠåˆ°å†…å­˜çš„æ‰©å®¹å’Œå…ƒç´ çš„ memmove æ“ä½œ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é˜»æ­¢è¿›è¡Œç¼©å®¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢åç»­æ’å…¥æ—¶ï¼Œå¯èƒ½é¢‘ç¹åœ° shrink æˆ–è€… grow å¯¼è‡´</span></span><br><span class="line">            <span class="comment">// æ›´å¤šåœ°å¼€é”€ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (next.prevrawlensize &gt; rawlensize) &#123;</span><br><span class="line">                <span class="comment">/* This would result in shrinking, which we want to avoid.</span></span><br><span class="line"><span class="comment">                 * So, set "rawlen" in the available bytes. */</span></span><br><span class="line">                zipStorePrevEntryLengthLarge(p + rawlen, rawlen);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                zipStorePrevEntryLength(p + rawlen, rawlen);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å­—å…¸ï¼ˆdictï¼‰"><a href="#å­—å…¸ï¼ˆdictï¼‰" class="headerlink" title="å­—å…¸ï¼ˆdictï¼‰"></a>å­—å…¸ï¼ˆdictï¼‰</h1><p>å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ª Key-Value æ•°æ®åº“ã€‚Redis ä¸­çš„å­—å…¸å®ç°ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>å¯ä»¥æ”¯æŒæµ·é‡çš„ key-value æ˜ å°„ï¼›</li><li>key çš„ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•´æ•°ç­‰ç±»å‹ï¼ˆ<code>void *</code>ï¼‰ï¼›value å¯ä»¥æ˜¯å¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆstring, hash, list, set, sorted setï¼‰æˆ–è€…æ˜¯æ•´æ•°ã€æµ®ç‚¹æ•°ç­‰ï¼›</li><li>ä¸ºäº†é¿å…å“ˆå¸Œå†²çªï¼Œé‡‡ç”¨äº†é“¾åœ°å€æ³•ï¼Œå°†å†²çªçš„ Entry ä¸²è”äº†èµ·æ¥ï¼›</li><li>ä¸ºäº†é¿å…åœ¨è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œéœ€è¦å¯¹æµ·é‡ keys è¿›è¡Œ rehash è€Œå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼Œé‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥ï¼›</li><li>æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ï¼›</li><li>å¯¹äº keys éå¸¸å¤§çš„å­—å…¸ï¼Œæä¾›äº† <code>dictScan</code> æ–¹æ³•ï¼Œé—´æ–­è¿­ä»£ï¼Œé¿å…å› ä¸ºæ™®é€šè¿­ä»£æ—¶é˜»å¡å…¶å®ƒæ“ä½œã€‚</li></ol><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;</span><br><span class="line">        <span class="keyword">uint64_t</span> u64;</span><br><span class="line">        <span class="keyword">int64_t</span> s64;</span><br><span class="line">        <span class="keyword">double</span> d;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></span><br><span class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size; <span class="comment">// å“ˆå¸Œè¡¨çœŸæ­£çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask; <span class="comment">// sizemask = size-1ï¼Œè¿™é‡Œç”¨äº hash &amp; sizemask è®¡ç®—å‡º slot</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used; <span class="comment">// å“ˆå¸Œè¡¨ä¸­çš„ keys ä¸ªæ•°</span></span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type; <span class="comment">// ä¾èµ–æ•°æ®æŠ½è±¡çš„æ“ä½œæ¥å£</span></span><br><span class="line">    <span class="keyword">void</span> *privdata; <span class="comment">// ç§æœ‰æ•°æ®ï¼Œé…åˆ type å­—æ®µæŒ‡å‘çš„å‡½æ•°ä½¿ç”¨</span></span><br><span class="line">    dictht ht[<span class="number">2</span>]; <span class="comment">// æœ‰ä¸¤ä¸ª hash table</span></span><br><span class="line">    <span class="comment">// rehashidx è¡¨ç¤º rehash çš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="comment">// iterators å½“å‰æ­£åœ¨è¿è¡Œçš„è¿­ä»£å™¨æ•°é‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>å­—å…¸æ•´ä½“ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š<br><img src="https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png" alt=""></p><h2 id="æ‰©å®¹ä¸ç¼©å®¹"><a href="#æ‰©å®¹ä¸ç¼©å®¹" class="headerlink" title="æ‰©å®¹ä¸ç¼©å®¹"></a>æ‰©å®¹ä¸ç¼©å®¹</h2><p>åœ¨æ‰§è¡Œ <code>dictAddRaw()</code> æ—¶ï¼Œä¼šå°è¯•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dictAddRaw()</span><br><span class="line">  _dictKeyIndex()</span><br><span class="line">    _dictExpandIfNeeded()</span><br><span class="line">      dictExpand()</span><br><span class="line">        _dictNextPower()</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ‰©å®¹æˆ–è€…ç¼©å®¹çš„æ ¸å¿ƒé€»è¾‘åœ¨ <code>dictExpand()</code> å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¯¥å‡½æ•°å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictExpand</span><span class="params">(dict *d, <span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç¡®ä¿æˆ‘ä»¬è¦æ‰©å®¹çš„å¤§å°å¯ä»¥å®¹çº³ç›®å‰çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="number">0</span>].used &gt; size)</span><br><span class="line">        <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    <span class="comment">// å¾—åˆ°ç›®æ ‡æ‰©å®¹å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> realsize = _dictNextPower(size);</span><br><span class="line">    <span class="comment">/* Rehashing to the same table size is not useful. */</span></span><br><span class="line">    <span class="comment">// æ‰©å®¹æ—¶æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œé¿å…æ— æ•ˆæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (realsize == d-&gt;ht[<span class="number">0</span>].size) <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ–°çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    dictht n;</span><br><span class="line">    n.size = realsize;</span><br><span class="line">    n.sizemask = realsize<span class="number">-1</span>;</span><br><span class="line">    n.table = zcalloc(realsize*<span class="keyword">sizeof</span>(dictEntry*));</span><br><span class="line">    n.used = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ht[1] æŒ‡å‘çš„å“ˆå¸Œè¡¨ä¾›æ¸è¿›å¼ rehash ä½¿ç”¨ã€‚</span></span><br><span class="line">    d-&gt;ht[<span class="number">1</span>] = n;</span><br><span class="line">    d-&gt;rehashidx = <span class="number">0</span>; <span class="comment">// è¡¨ç¤º rehash å‡†å¤‡å®Œæ¯•ï¼Œè¿›åº¦ä¸º 0</span></span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹ç­–ç•¥ï¼š4 -&gt; 4 * 2 -&gt; 4 * 2 * 2 -&gt; ...</span></span><br><span class="line"><span class="comment">// æŒ‰ç…§ 2 çš„å€æ•°å¢åŠ ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³ size å¤§å°çš„æ•°æ‰¾åˆ°ä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> _dictNextPower(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i = DICT_HT_INITIAL_SIZE; <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= LONG_MAX)</span><br><span class="line">        <span class="keyword">return</span> LONG_MAX + <span class="number">1L</span>U;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        i *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éœ€è¦çš„æ—¶å€™ï¼ŒRedis å¯ä»¥å¯¹å­—å…¸æ‰§è¡Œç¼©å®¹æ“ä½œï¼Œå…·ä½“å¯ä»¥è°ƒç”¨ <code>dictResize()</code> å‡½æ•°å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictResize</span><span class="params">(dict *d)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> minimal = d-&gt;ht[<span class="number">0</span>].used;</span><br><span class="line">    <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">        minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    <span class="keyword">return</span> dictExpand(d, minimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸è¿›å¼-Rehash"><a href="#æ¸è¿›å¼-Rehash" class="headerlink" title="æ¸è¿›å¼ Rehash"></a>æ¸è¿›å¼ Rehash</h2><p>ä¸ºäº†é¿å…åœ¨ rehash æœŸé—´ï¼Œå› ä¸ºè¦è¿ç§»çš„ keys å¤ªå¤šï¼Œå¯¼è‡´é˜»å¡å…¶å®ƒæ“ä½œæ—¶é—´å¤ªä¹…ï¼ŒRedis çš„å­—å…¸å®ç°ä¸­ï¼Œä½¿ç”¨äº†æ¸è¿›å¼ rehash çš„ç­–ç•¥ï¼Œä»è€Œå°†å¯¹å¤§é‡ keys çš„è¿ç§»åˆ†æ•£åœ¨ N æ¬¡æ“ä½œä¸­ï¼Œç›´åˆ°æœ€ç»ˆå®Œæˆï¼Œå…·ä½“å®ç°å‚è§ <a href="https://github.com/iFaceless/redis/blob/4c5a6f422b60500816e9c507bb0265495f483dda/src/dict.c#L206" target="_blank" rel="noopener">dictRehash()</a>ã€‚</p><p>é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥åï¼Œæ¯æ¬¡åœ¨æ‰§è¡ŒæŸ¥æ‰¾ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ä»¥åŠ Redis æœåŠ¡å™¨ç©ºé—²æ—¶ï¼Œå¯ä»¥æ‰§è¡Œä¸€éƒ¨åˆ† keys çš„ rehash æ“ä½œã€‚å…·ä½“æ‰§è¡Œæ—¶æœºå¦‚ä¸‹ï¼š</p><ol><li><p><code>_dictRehashStep() -&gt; dictRehash(d, 1)</code>ï¼š</p><ol><li><code>dictAddRaw()</code></li><li><code>dictDelete()</code></li><li><code>dictUnlink()</code></li><li><code>dictFind()</code></li><li><code>dictGetRandomKey()</code></li><li><code>dictGetSomeKeys()</code></li></ol></li><li><p><code>incrementallyRehash() -&gt; dictRehashMilliseconds(d, 1) -&gt; dictRehash(d, 100)</code>ï¼šServer å¤„äºç©ºé—²æ—¶æ‰§è¡Œ 1ms çš„ rehash å·¥ä½œã€‚</p></li></ol><h2 id="æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨"><a href="#æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨" class="headerlink" title="æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨"></a>æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨</h2><p>è¿­ä»£å™¨æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¯¹å®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†ï¼Œä½†ä¸éœ€è¦äº†è§£å®¹å™¨å†…éƒ¨å®ç°ç»†èŠ‚ã€‚Redis çš„å­—å…¸ä¹Ÿæˆ‘ä»¬æä¾›äº†è¿­ä»£å™¨æ•°æ®ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictIterator</span> &#123;</span></span><br><span class="line">    dict *d;</span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    <span class="comment">// table æŒ‡å‘çš„å½“å‰åœ¨è¿­ä»£ tableï¼Œsafe è¡¨æ˜æ˜¯å¦ä¸ºå®‰å…¨çš„è¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">int</span> table, safe;</span><br><span class="line">    dictEntry *entry, *nextEntry;</span><br><span class="line">    <span class="comment">// fingerprint ç”¨æ¥æ£€æŸ¥éå®‰å…¨è¿­ä»£å™¨åœ¨ä½¿ç”¨æœŸé—´æ˜¯å¦æ‰§è¡Œäº†ä¸å…è®¸çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> fingerprint;</span><br><span class="line">&#125; dictIterator;</span><br><span class="line"></span><br><span class="line"><span class="function">dictIterator *<span class="title">dictGetIterator</span><span class="params">(dict *d)</span></span>;</span><br><span class="line"><span class="function">dictIterator *<span class="title">dictGetSafeIterator</span><span class="params">(dict *d)</span></span>;</span><br><span class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span></span>;</span><br></pre></td></tr></table></figure><p>å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«ï¼š</p><ul><li>å®‰å…¨è¿­ä»£å™¨å…è®¸æˆ‘ä»¬åœ¨è¿­ä»£æœŸé—´ï¼Œæ‰§è¡ŒæŸ¥æ‰¾ã€åˆ é™¤ã€æ–°å¢ç­‰å¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå¦‚æ‰§è¡Œ <code>keys *</code> å‘½ä»¤æ—¶ä¼šåˆ›å»ºå®‰å…¨è¿­ä»£å™¨ï¼‰ï¼›</li><li>æ™®é€šè¿­ä»£å™¨åˆ™åªèƒ½å…è®¸æˆ‘ä»¬æ‰§è¡Œ <code>dictNext()</code> è¿›è¡Œè¿­ä»£ï¼Œå…¶å®ƒæ“ä½œæ˜¯ä¸å…è®¸çš„ï¼ˆå¦‚æ‰§è¡Œ <code>sort</code> ä¼šåˆ›å»ºéå®‰å…¨è¿­ä»£å™¨ï¼‰ã€‚</li></ul><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é™åˆ¶å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨è¿­ä»£æœŸé—´ï¼Œå¦‚æœæœ‰æ‰§è¡ŒæŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤ç­‰æ“ä½œï¼Œå¯èƒ½ä¼šå‘ç”Ÿ rehashï¼Œè¿›è€Œå¯¼è‡´æ‰«æåˆ°é‡å¤çš„ entryã€‚</p><p>æ™®é€šè¿­ä»£å™¨åœ¨è¿­ä»£å¼€å§‹æ—¶ï¼Œè®¡ç®—å‡ºå½“å‰ dict çš„æŒ‡çº¹ï¼Œå¹¶åœ¨è¿­ä»£ç»“æŸæ—¶å†æ¬¡è®¡ç®— dict çš„æŒ‡çº¹ï¼Œä»è€Œç¡®å®š dict åœ¨æ­¤æœŸé—´æ˜¯å¦å‘ç”Ÿè¿‡ä¿®æ”¹è¿‡ï¼Œç›¸å…³å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            dictht *ht = &amp;iter-&gt;d-&gt;ht[iter-&gt;table];</span><br><span class="line">            <span class="keyword">if</span> (iter-&gt;index == <span class="number">-1</span> &amp;&amp; iter-&gt;table == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¼€å§‹è¿­ä»£ï¼Œè®¡ç®—ä¸‹ fp</span></span><br><span class="line">                iter-&gt;fingerprint = dictFingerprint(iter-&gt;d);</span><br><span class="line">            &#125;</span><br><span class="line">            iter-&gt;index++;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(iter-&gt;index == <span class="number">-1</span> &amp;&amp; iter-&gt;table == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;safe)</span><br><span class="line">            iter-&gt;d-&gt;iterators--;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d));</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(iter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆï¼Œå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å®‰å…¨çš„å‘¢ï¼Ÿå…¶å®ç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œå¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œæ—¶ï¼Œé˜»æ­¢å…¶è¿›è¡Œ rehash å³å¯ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åº•å±‚çš„ hash tables ä¸ä¼šæœ‰ keys çš„è¿ç§»ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><ul><li>è¿­ä»£å™¨åˆå§‹åŒ–æ—¶ï¼Œ<code>safe</code> å­—æ®µç½® 1ï¼›</li><li>åˆæ¬¡è¿­ä»£æ—¶ï¼Œæ‰§è¡Œ <code>iter-&gt;d-&gt;iterators++</code>ï¼Œå‘Šè¯‰ <code>dict</code> å½“å‰å­˜åœ¨å®‰å…¨çš„è¿­ä»£å™¨åœ¨è¿è¡Œï¼›</li><li><code>_dictRehashStep</code> æ—¶ï¼Œå¦‚æœ <code>dict-&gt;iterators != 0</code> åˆ™ä¸ä¼šæ‰§è¡Œ rehashã€‚</li></ul><h2 id="é—´æ–­è¿­ä»£å™¨"><a href="#é—´æ–­è¿­ä»£å™¨" class="headerlink" title="é—´æ–­è¿­ä»£å™¨"></a>é—´æ–­è¿­ä»£å™¨</h2><p>ä¸ºäº†é¿å…æ‰«ææ‰€æœ‰çš„ keys è€Œé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼ˆäº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒæ˜¯ç¦ç”¨ <code>keys</code> å‘½ä»¤çš„ï¼‰ï¼ŒRedis åœ¨ 2.8 ä¹‹ååŠ å…¥äº† <code>scan</code> æ“ä½œï¼Œä»è€Œèƒ½å¤Ÿé—´æ–­åœ°è¿­ä»£æ•´ä¸ªå­—å…¸ã€‚<code>zscan</code> å’Œ <code>hscan</code> åº•å±‚éƒ½ä¼šæ‰§è¡Œé—´æ–­è¿­ä»£æ“ä½œï¼Œå®ƒçš„å…·ä½“å®ç°å‚è§ <a href="https://github.com/iFaceless/redis/blob/4c5a6f422b60500816e9c507bb0265495f483dda/src/dict.c#L878" target="_blank" rel="noopener">dictScan</a>ï¼Œæ ¸å¿ƒæ˜¯å›´ç»•ä¸€ä¸ªæ¸¸æ ‡è¿›è¡Œçš„ï¼Œå…³äºå®ƒçš„å…·ä½“ç­–ç•¥å¯ä»¥å‚è§æºç çš„è¯¦ç»†æè¿°ã€‚</p><p>è¿™é‡Œæ€»ç»“ä¸‹ <code>dictScan</code> ç®—æ³•çš„ä¸»è¦ç‰¹ç‚¹ï¼š</p><ol><li><strong>è¿­ä»£å™¨æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ˆå’Œä¸Šé¢çš„ä¸¤ä¸ªç›¸æ¯”ï¼‰</strong>ï¼Œè¿­ä»£ä½ç½®æ˜¯åŸºäºæ¸¸æ ‡è®¡ç®—çš„ï¼Œè€Œæ¸¸æ ‡ä¼šè¿”å›ç»™ç”¨æˆ·ï¼Œç”±ç”¨æˆ·ä¿å­˜ï¼Œå¹¶åœ¨è¿­ä»£æ—¶ä¼ å…¥ï¼›</li><li><strong>å¯èƒ½ä¼šè¿­ä»£åˆ°é‡å¤çš„å…ƒç´ </strong>ï¼Œä½†ç”±äºé‡‡ç”¨äº† <em>reverse binary iteration</em> ç®—æ³•ï¼Œèƒ½å¤Ÿä¿è¯ä¸æ¼éå†ä¸”å°½å¯èƒ½ä¸é‡å¤éå†ï¼›</li><li><strong>æ¯æ¬¡è¿­ä»£ä¼šè¿”å›å¤šä¸ªå…ƒç´ </strong>ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºé¿å… rehash çš„å½±å“ï¼Œæ¯æ¬¡ä¼šå°†ä¸€ä¸ª bucket ä¸Šæ‰€æœ‰çš„ keys éƒ½è¿”å›å‡ºå»ã€‚</li></ol><h1 id="æ•´æ•°é›†åˆï¼ˆintsetï¼‰"><a href="#æ•´æ•°é›†åˆï¼ˆintsetï¼‰" class="headerlink" title="æ•´æ•°é›†åˆï¼ˆintsetï¼‰"></a>æ•´æ•°é›†åˆï¼ˆintsetï¼‰</h1><p>é¡¾åæ€ä¹‰ï¼Œintset æ˜¯è½¬é—¨ç”¨äº<strong>å­˜å‚¨æ•´æ•°</strong>çš„é›†åˆã€‚å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œéšç€å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ çš„ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œå®ƒä¹Ÿä¼šæŒ‰éœ€æ‰©å®¹ã€‚intset è¿˜æœ‰ä¸ªç‰¹ç‚¹æ˜¯<strong>æœ‰åºä¸”ä¸é‡å¤</strong>ï¼ˆå¯ä»¥æƒ³åˆ°æŸ¥æ‰¾æ—¶å°±å¯ä»¥å…‰æ˜æ­£å¤§åœ°åˆ©ç”¨äºŒåˆ†ç®—æ³•äº†ï¼‰ã€‚</p><p>intset å®é™…ä¸Šæ˜¯ Redis é›†åˆç±»å‹åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œ<strong>å½“å…ƒç´ ä¸º 64 ä½ä»¥å†…æœ‰ç¬¦å·æ•´æ•°ï¼ˆæ”¯æŒ <code>int16_t</code>, <code>int32_t</code>, <code>int64_t</code>ï¼‰ï¼Œä¸”å…ƒç´ ä¸ªæ•°ä¸å¤š</strong>ï¼ˆå–å†³äº <code>set_max_intset_entries</code> è®¾ç½®ï¼‰æ—¶ä½¿ç”¨ã€‚å½“å…ƒç´ ä¸ªæ•°è¶…å‡ºè®¾å®šå€¼ï¼Œæˆ–è€…æ–°å¢å…ƒç´ ç±»å‹éæ•´æ•°ï¼Œ<strong>intset å°±ä¼šè¢«è½¬æ¢æˆ hashtable</strong>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ dict æ¥å­˜å‚¨ã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">setTypeCreate</span><span class="params">(sds value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isSdsRepresentableAsLongLong(value,<span class="literal">NULL</span>) == C_OK)</span><br><span class="line">        <span class="keyword">return</span> createIntsetObject();</span><br><span class="line">    <span class="keyword">return</span> createSetObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setTypeAdd</span><span class="params">(robj *subject, sds value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> llval;</span><br><span class="line">    <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_HT) &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_INTSET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isSdsRepresentableAsLongLong(value, &amp;llval) == C_OK) &#123;</span><br><span class="line">            <span class="keyword">uint8_t</span> success = <span class="number">0</span>;</span><br><span class="line">            subject-&gt;ptr = intsetAdd(subject-&gt;ptr, llval, &amp;success);</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                <span class="comment">// å…ƒç´ ä¸ªæ•°è¶…å‡ºèŒƒå›´ï¼Œéœ€è¦è½¬æ¢æˆå­—å…¸å­˜å‚¨</span></span><br><span class="line">                <span class="keyword">if</span> (intsetLen(subject-&gt;ptr) &gt; server.set_max_intset_entries)</span><br><span class="line">                    setTypeConvert(subject, OBJ_ENCODING_HT);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// éæ•´æ•°ç±»å‹ï¼Œè½¬æ¢æˆå­—å…¸</span></span><br><span class="line">            setTypeConvert(subject, OBJ_ENCODING_HT);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> encoding; <span class="comment">// æ•´æ•°é•¿åº¦ï¼šINTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</span></span><br><span class="line">    <span class="keyword">uint32_t</span> length; <span class="comment">// æ•´æ•°ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure><p>ç®€å•ç”»äº†ä¸ªå†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹ï¼Œç›¸ä¿¡å¯ä»¥ç›´è§‚åœ°è¡¨è¾¾è¿™ä¸ªæ•°æ®ç»“æ„çš„ç‰¹ç‚¹ï¼š<br><img src="https://pic1.zhimg.com/80/v2-c565192165aad2be79d17ae7e6517bc1.png" alt=""></p><h2 id="æ ¸å¿ƒæºç -3"><a href="#æ ¸å¿ƒæºç -3" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>intset çš„æ ¸å¿ƒ API æ¯”è¾ƒå°‘ï¼Œä¸”å®ç°æ¯”è¾ƒç®€å•ï¼Œå¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å¤šèµ˜è¿°äº†ï¼Œç›¸å…³æºç ä¸­æ–‡æ³¨é‡Šç›´æ¥çœ‹ <a href="https://github.com/iFaceless/redis/blob/c4e3ab7aa976ff1bde948803a6212c1cb2764b76/src/intset.c#L97" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">intset *<span class="title">intsetNew</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function">intset *<span class="title">intsetAdd</span><span class="params">(intset *is, <span class="keyword">int64_t</span> value, <span class="keyword">uint8_t</span> *success)</span></span>; <span class="comment">// O(N)</span></span><br><span class="line"><span class="function">intset *<span class="title">intsetRemove</span><span class="params">(intset *is, <span class="keyword">int64_t</span> value, <span class="keyword">int</span> *success)</span></span>; <span class="comment">// O(N)</span></span><br><span class="line"><span class="keyword">uint8_t</span> intsetFind(intset *is, <span class="keyword">int64_t</span> value); <span class="comment">// O(logN)</span></span><br><span class="line"><span class="keyword">int64_t</span> intsetRandom(intset *is); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">uint8_t</span> intsetGet(intset *is, <span class="keyword">uint32_t</span> pos, <span class="keyword">int64_t</span> *value); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">uint32_t</span> intsetLen(<span class="keyword">const</span> intset *is); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">size_t</span> intsetBlobLen(intset *is); <span class="comment">// O(1)</span></span><br></pre></td></tr></table></figure><h1 id="å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰"><a href="#å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰" class="headerlink" title="å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰"></a>å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰</h1><p>å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä½†æ˜¯å®ƒçš„æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä½äº ziplist ä¸­ï¼Œå¹¶ä¸”ä¸­é—´èŠ‚ç‚¹çš„ ziplist è¿˜å¯ä»¥ä½¿ç”¨ LZF ç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ã€‚æ€»çš„æ¥è¯´ï¼Œquicklist æ˜¯ä¸€ä¸ªç»¼åˆäº†åŒå‘é“¾è¡¨å’Œ ziplist ä¼˜ç‚¹çš„æ•°æ®ç»“æ„ã€‚ziplist æœ€å¤§çš„ç‰¹ç‚¹æ˜¯èŠ‚çº¦å†…å­˜ï¼Œä½†ä¸é€‚å®œå­˜å‚¨è¿‡å¤šçš„å…ƒç´ ï¼›è€Œé“¾è¡¨åˆ™ä¾¿äºä»å¤´éƒ¨æˆ–è€…å°¾éƒ¨æ‰§è¡Œæ’å…¥æˆ–æŸ¥æ‰¾ã€‚</p><p>å› æ­¤ï¼Œquicklist ç®—æ˜¯ä¸º Redis åˆ—è¡¨ç±»å‹ <code>t_list</code> ç‰¹åˆ«å®šåˆ¶çš„æ•°æ®ç»“æ„ï¼Œå…¼é¡¾äº†æ—¶é—´å’Œç©ºé—´æ•ˆç‡ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„ <code>LPUSH</code>, <code>LPOP</code>, <code>RPUSH</code>, <code>RPOP</code> å‘½ä»¤ï¼Œå®é™…ä¸Šåªéœ€è¦æ“ä½œåˆ—è¡¨ä¸¤ç«¯å³å¯ï¼Œè€Œ qucklist æ°å¥½ç»´æŠ¤äº† head å’Œ tail çš„èŠ‚ç‚¹æŒ‡é’ˆï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-5eace6803426c11a9f2b27a83ff5d94f.png" alt=""></p><h2 id="æ•°æ®ç»“æ„-2"><a href="#æ•°æ®ç»“æ„-2" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// quicklist æ˜¯å¯¹å¿«é€Ÿé“¾è¡¨è¿™ç§æ•°æ®ç»“æ„çš„æŠ½è±¡ï¼Œå…¶ä¸­å­˜å‚¨äº†ä¸€äº›å…ƒä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></span><br><span class="line">    <span class="comment">// head, tail æŒ‡å‘é“¾è¡¨çš„å¤´å°¾</span></span><br><span class="line">    quicklistNode *head;</span><br><span class="line">    quicklistNode *tail;</span><br><span class="line">    <span class="comment">// count è®°å½•äº†æ‰€æœ‰ ziplists çš„å…ƒç´ ä¸ªæ•°ä¹‹å’Œ</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> count; <span class="comment">/* total count of all entries in all ziplists */</span></span><br><span class="line">    <span class="comment">// len è®°å½•äº†æœ‰å¤šå°‘ä¸ª Nodes</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len; <span class="comment">/* number of quicklistNodes */</span></span><br><span class="line">    <span class="comment">// fill è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¯ä»¥åŒ…å«çš„æ•°æ®é¡¹ï¼Œæ­£æ•°è¡¨ç¤ºæœ€å¤šå¯ä»¥å«æœ‰çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">// è´Ÿæ•°åˆ™è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹ ziplist çš„æœ€å¤§é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼š</span></span><br><span class="line">    <span class="comment">// -1, 4KB</span></span><br><span class="line">    <span class="comment">// -2, 8KB</span></span><br><span class="line">    <span class="comment">// -3, 16KB</span></span><br><span class="line">    <span class="comment">// -4, 32KB</span></span><br><span class="line">    <span class="comment">// -5, 64KB</span></span><br><span class="line">    <span class="keyword">int</span> fill : <span class="number">16</span>; <span class="comment">/* fill factor for individual nodes */</span></span><br><span class="line">    <span class="comment">// compress è¡¨ç¤ºä¸¤ç«¯ä¸è¢«å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚ä¸€èˆ¬å¯¹äº list çš„æ“ä½œé€šå¸¸æ˜¯åœ¨ä¸¤ç«¯è¿›è¡Œçš„</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ï¼Œä¸ºäº†æ–¹ä¾¿ LPUSH/LPOP/RPUSH/RPOP å‘½ä»¤ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©å¯¹ä¸¤ç«¯ä¸åšå‹ç¼©ã€‚</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œä¼šå¯¹ä¸­é—´èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼ˆziplist å·²ç»å¤ŸèŠ‚çº¦å†…å­˜äº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å‹ç¼©</span></span><br><span class="line">    <span class="comment">// æ›´è¿›ä¸€æ­¥åœ°èŠ‚çº¦å†…å­˜ï¼‰ï¼Œä»£ä»·å°±æ˜¯æ¶ˆè€—ç‚¹ CPU æ—¶é—´ç”¨äºå‹ç¼©æˆ–è€…è§£å‹ç¼©ã€‚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> compress : <span class="number">16</span>; <span class="comment">/* depth of end nodes not to compress;0=off */</span></span><br><span class="line">&#125; quicklist;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistNode å®é™…ä¸Šæ˜¯å¯¹ ziplist çš„æè¿°ï¼Œå…ƒç´ å­˜å‚¨äº ziplist ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦åœ¨ quicklistNode ä¸­ä½äº ziplist çš„ä¸€äº›å…ƒä¿¡æ¯å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸º</span></span><br><span class="line"><span class="comment">// èŠ‚ç‚¹æŒ‡å‘çš„ ziplist å¯ä»¥è¢«å‹ç¼©ï¼Œè¿™æ ·å°±ä¸èƒ½å¿«é€Ÿè·å–ä¸€äº›å…ƒä¿¡æ¯äº†ï¼ˆå…ƒç´ ä¸ªæ•°ç­‰ï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// åŒå‘é“¾è¡¨ï¼Œè‡ªç„¶éœ€è¦å‰åå…³è”</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘ ziplist æŒ‡é’ˆï¼ˆå¦‚æœæ˜¯å‹ç¼©èŠ‚ç‚¹ï¼Œå®é™…æŒ‡å‘çš„æ˜¯ quicklistLZFï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl;</span><br><span class="line">    <span class="comment">// ziplist çš„å¤§å°ï¼ˆbytesï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz; <span class="comment">/* ziplist size in bytes */</span></span><br><span class="line">    <span class="comment">// ziplist ä¸­å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count : <span class="number">16</span>; <span class="comment">/* count of items in ziplist */</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤º ziplist è¿›è¡Œäº†å‹ç¼©ç¼–ç ï¼ŒRAW=1 è¡¨ç¤ºæ²¡æœ‰å‹ç¼©ï¼›2 è¡¨ç¤ºä½¿ç”¨äº† LZF ç®—æ³•å‹ç¼©</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> encoding : <span class="number">2</span>; <span class="comment">/* RAW==1 or LZF==2 */</span></span><br><span class="line">    <span class="comment">// å®¹å™¨ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> container : <span class="number">2</span>; <span class="comment">/* NONE==1 or ZIPLIST==2 */</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯å¦è¢«å‹ç¼©è¿‡ï¼Ÿå¦‚æœå‹ç¼©è¿‡è¿˜éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œè§£å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> recompress : <span class="number">1</span>; <span class="comment">/* was this node previous compressed? */</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹å¤ªå°äº†ï¼Œæ— æ³•å‹ç¼©</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attempted_compress : <span class="number">1</span>; <span class="comment">/* node can't compress; too small */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extra : <span class="number">10</span>; <span class="comment">/* more bits to steal for future usage */</span></span><br><span class="line">&#125; quicklistNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistLZF è¡¨ç¤º ziplist å‹ç¼©åçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ª 4+N å­—èŠ‚å¤§å°çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistLZF</span> &#123;</span></span><br><span class="line">    <span class="comment">// sz è¡¨ç¤º LZF å‹ç¼©åçš„æ•°æ®å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz; <span class="comment">/* LZF size in bytes*/</span></span><br><span class="line">    <span class="comment">// compressed å­˜å‚¨å‹ç¼©åçš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">char</span> compressed[];</span><br><span class="line">&#125; quicklistLZF;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistEntry æ˜¯å¯¹ quicklistNode ä¸‹ ziplist æŸä¸ªå…ƒç´ çš„æŠ½è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">// æ–¹ä¾¿æˆ‘ä»¬è·å–å…ƒç´ çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistEntry</span> &#123;</span></span><br><span class="line">    <span class="comment">// quicklist æŒ‡å‘ quicklist çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">const</span> quicklist *quicklist;</span><br><span class="line">    <span class="comment">// quicklistNode å½“å‰ entry å…³è”çš„èŠ‚ç‚¹</span></span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="comment">// zi å…³è”çš„ ziplist</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zi;</span><br><span class="line">    <span class="comment">// value æŒ‡å‘ string ç±»å‹çš„å…ƒç´ ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *value;</span><br><span class="line">    <span class="comment">// longvalue å…ƒç´ è½¬æ¢ä¸ºæ•´æ•°çš„å€¼</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> longval;</span><br><span class="line">    <span class="comment">// sz è¡¨ç¤º value çš„æœ‰æ•ˆé•¿åº¦ï¼ˆstring ç±»å‹ç¼–ç æ—¶ï¼Œencoding ä¸­çš„é•¿åº¦éƒ¨åˆ†å°±æ˜¯è¿™ä¸ªï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;</span><br><span class="line">    <span class="comment">// offset è¡¨ç¤ºåœ¨å½“å‰ ziplist ä¸­çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">&#125; quicklistEntry;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹å›¾å¯ä»¥å¯¹ quicklist æœ‰ä¸ªç›´è§‚çš„æ„Ÿå—ï¼Œä¾¿äºç†è§£è¿™ç§æ•°æ®ç»“æ„ï¼š<br><img src="https://pic1.zhimg.com/80/v2-1f634fd2892ebc00aef8aeb8f03ceb09.png" alt=""></p><h2 id="æ ¸å¿ƒæºç -4"><a href="#æ ¸å¿ƒæºç -4" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>quicklist çš„æºç æ¯”è¾ƒå¤šï¼Œå°±ä¸å†æœ¬æ–‡ä¸­èµ˜è¿°äº†ï¼Œè¯¦ç»†çš„æºç æ³¨é‡Šå¯ä»¥åœ¨ <a href="https://github.com/iFaceless/redis/blob/152cb8a4be4ce107a34135314020ec69bca93216/src/quicklist.c#L94" target="_blank" rel="noopener">æ­¤å¤„</a> æŸ¥çœ‹ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// n ä¸º quicklist èŠ‚ç‚¹ä¸ªæ•°ï¼Œm è¡¨ç¤ºå†…éƒ¨ ziplist çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function">quicklist *<span class="title">quicklistCreate</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">// O(1)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushHead</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushTail</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistPush</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz, <span class="keyword">int</span> where)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertAfter</span><span class="params">(quicklist *quicklist, quicklistEntry *node, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertBefore</span><span class="params">(quicklist *quicklist, quicklistEntry *node, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistIndex</span><span class="params">(<span class="keyword">const</span> quicklist *quicklist, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> index, quicklistEntry *entry)</span></span>; <span class="comment">// O(n+m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPop</span><span class="params">(quicklist *quicklist, <span class="keyword">int</span> where, <span class="keyword">unsigned</span> <span class="keyword">char</span> **data, <span class="keyword">unsigned</span> <span class="keyword">int</span> *sz, <span class="keyword">long</span> <span class="keyword">long</span> *slong)</span></span>;  <span class="comment">// O(m)</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™é‡Œå°±ä¸å¤šåºŸè¯äº†ï¼Œå¯¹äºåŸºæœ¬çš„æ•°æ®ç»“æ„åšäº†ç‚¹æ€»ç»“ï¼Œæ”¾åœ¨ä¸‹é¢çš„æ€ç»´å¯¼å›¾ä¸­ã€‚å…¶ä¸­ APIs åˆ†æ”¯å¹¶éæ¯ä¸ªæ•°æ®ç»“æ„å…¨éƒ¨çš„æ¥å£ï¼Œè€Œæ˜¯ä¸€äº›æ¯”è¾ƒæœ‰è¶£ï¼Œå€¼å¾—é˜…è¯»æºç çš„æ¥å£ï¼Œæœ‰å…´è¶£åœ°è¯å¯ä»¥æ¬£èµä¸‹å®ƒä»¬çš„å†…éƒ¨å®ç°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€æŒ‡æ­£~</p><p><img src="https://pic2.zhimg.com/80/v2-82b204f0b41afb79e21e84d76a4806ef.png" alt=""></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-1d46ebdc21d0364fefecf710d01f473d.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Redis åº•å±‚çš„åŸºç¡€æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šåŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsdsï¼‰ã€è·³è¡¨ï¼ˆskiplistï¼‰ã€å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€æ•´æ•°é›†åˆï¼ˆintsetï¼‰ï¼Œå¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰ç­‰ï¼Œ&lt;code&gt;t_hash&lt;/code&gt;ï¼Œ&lt;code&gt;t_set&lt;/code&gt;, &lt;code&gt;t_zset&lt;/code&gt;, &lt;code&gt;t_list&lt;/code&gt; ç­‰å¯¹å¤–ç±»å‹çš„å†…éƒ¨å®ç°éƒ½ä¾èµ–äºè¿™äº›æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥éå¸¸å€¼å¾—å­¦ä¹ ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="http://ifaceless.space/categories/Redis/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Redis" scheme="http://ifaceless.space/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€å®ç° Redis è·³è¡¨</title>
    <link href="http://ifaceless.space/2019/12/11/implement-redis-skiplist-in-go/"/>
    <id>http://ifaceless.space/2019/12/11/implement-redis-skiplist-in-go/</id>
    <published>2019-12-11T12:58:39.000Z</published>
    <updated>2019-12-15T06:08:45.313Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png" alt=""><br>è¯»è¿‡ Redis æºç çš„ç«¥é‹ï¼Œæƒ³å¿…ä¼šçŸ¥é“ zset å®ç°æ—¶ï¼Œä½¿ç”¨äº†ã€Œè·³è¡¨ã€ï¼ˆSkiplistï¼‰è¿™ç§æ•°æ®ç»“æ„å§ã€‚å®ƒçš„åŸç†éå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœå¯¹é“¾è¡¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼ˆæ ¸å¿ƒï¼š<strong>æœ‰åºé“¾è¡¨</strong> + <strong>åˆ†å±‚</strong>ï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸ä¼šè¯¦ç»†è®²è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¯¹äº Redis è·³è¡¨æºç çš„è¯¦ç»†åˆ†æã€‚å› ä¸ºå·²ç»æœ‰å‰è¾ˆä»¬äº§å‡ºäº†éå¸¸ä¸°å¯Œçš„æ–‡ç« æ¥è®²è§£ Redis è·³è¡¨ï¼Œéœ€è¦çš„è¯ï¼Œæ¨èé˜…è¯» <a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</p><a id="more"></a><p>æ€»çš„æ¥è¯´ï¼ŒRedis çš„ zset å®ç°ä¸­ï¼Œé€‰ç”¨ã€Œè·³è¡¨ã€çš„ä¸»è¦åŸå› å¦‚ä¸‹ï¼š</p><ol><li><strong>åŸç†æ¸…æ™°æ˜“æ‡‚ï¼Œä¸”å®¹æ˜“å®ç°ï¼Œæ–¹ä¾¿ç»´æŠ¤</strong>ï¼šå¯¹æ¯”ä¸‹å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘ï¼ˆå¯èƒ½å°±åƒ Raft v.s. Paxos çš„æ„Ÿè§‰ä¸€æ ·ï¼‰ï¼Œä¸ç®¡æ˜¯åŸç†è¿˜æ˜¯å®ç°éƒ½ç®€å•äº†å¾ˆå¤šã€‚å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘åœ¨å®ç°æ—¶ï¼Œè¿˜è¦æ—¶åˆ»ç»´æŠ¤èŠ‚ç‚¹å…³ç³»ï¼Œå¿…è¦æ—¶è¿˜éœ€è¦æ‰§è¡Œæ ‘çš„å·¦æ—‹æˆ–è€…å³æ—‹æ¥ä¿æŒå¹³è¡¡ï¼›</li><li><strong>æ‹¥æœ‰åª²ç¾å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡</strong>ï¼šæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„å¹³å‡æ—¶é—´å¤æ‚åº¦å¯ä»¥è¾¾åˆ° O(logN)ã€‚</li></ol><p>å½“ç„¶ï¼Œç›¸å¯¹äº William Pugh åœ¨ä»–çš„è®ºæ–‡ä¸­æ‰€æè¿°çš„ã€Œè·³è¡¨ã€ç®—æ³•è€Œè¨€ï¼Œä½œè€…åœ¨å®ç° Redis ä¸­çš„ã€Œè·³è¡¨ã€æ—¶ï¼Œç»™å®ƒåŠ äº†ç‚¹ã€Œæ–™ã€ï¼š</p><ol><li>å…è®¸é‡å¤çš„åˆ†æ•°å­˜åœ¨ï¼›</li><li>åœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œä¸ä»…ä¼šæ¯”è¾ƒ scoreï¼Œè¿˜ä¼šè€ƒè™‘å…³è”çš„æ•°æ®ï¼›</li><li>æ·»åŠ äº†ä¸€ä¸ªå›é€€æŒ‡é’ˆï¼Œä»è€Œæ„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆlevel[0]ï¼‰ï¼Œä¾¿äºå€’åºéå†é“¾è¡¨ï¼ˆ<code>ZREVRANGE</code>ï¼‰ä½¿ç”¨ã€‚</li></ol><p>å¥½äº†ï¼ŒåºŸè¯å®Œæ¯•ã€‚æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å®ç°ã€Œè·³è¡¨ã€å§ï¼ˆè´´ä»£ç æ¨¡å¼å¼€å¯~ï¼‰ã€‚</p><h1 id="è·³è¡¨å®ç°"><a href="#è·³è¡¨å®ç°" class="headerlink" title="è·³è¡¨å®ç°"></a>è·³è¡¨å®ç°</h1><p>ä»¥ä¸‹ä»…ä»…åˆ—å‡ºäº†å‡ ä¸ªæ¯”è¾ƒæœ‰è¶£ä¸”å…³é”®çš„æ–¹æ³•å®ç°ï¼Œå³ï¼šæ’å…¥ã€åˆ é™¤å’Œæ›´æ–°åˆ†æ•°ã€‚å®Œæ•´çš„å®ç°æºç å¯ä»¥å‚è€ƒ <a href="https://gitee.com/ifaceless/goskiplist/tree/master" target="_blank" rel="noopener">è¿™é‡Œ</a> æˆ–è€… <a href="https://github.com/iFaceless/always-coding/tree/master/datastructure/skiplist" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼ŒåŒ…å«äº†æ¯”è¾ƒè¯¦ç»†çš„å•å…ƒæµ‹è¯•ã€‚</p><h2 id="æ•°æ®ç»“æ„å®šä¹‰"><a href="#æ•°æ®ç»“æ„å®šä¹‰" class="headerlink" title="æ•°æ®ç»“æ„å®šä¹‰"></a>æ•°æ®ç»“æ„å®šä¹‰</h2><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œå‡è®¾å­˜å‚¨çš„å…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆè¦æ˜¯ä½¿ç”¨ <code>interface{}</code> çš„è¯ï¼Œåˆå¾—åŠ äº›ä»£ç æ”¯æŒå…ƒç´ ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼‰ã€‚ä½†æ˜¯åœ¨ Redis ä¸­ï¼Œå®é™…çš„ <code>element</code>  ç±»å‹æ˜¯ <code>sds</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    MaxLevel = <span class="number">64</span> <span class="comment">// è¶³ä»¥å®¹çº³ 2^64 ä¸ªå…ƒç´ </span></span><br><span class="line">    P = <span class="number">0.25</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">    elem <span class="keyword">string</span></span><br><span class="line">    score <span class="keyword">float64</span></span><br><span class="line">    backward *Node</span><br><span class="line">    level []skipLevel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> skipLevel <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// forward æ¯å±‚éƒ½è¦æœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ</span></span><br><span class="line">    forward *Node</span><br><span class="line">    <span class="comment">// span é—´éš”å®šä¹‰ä¸ºï¼šä»å½“å‰èŠ‚ç‚¹åˆ° forward æŒ‡å‘çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¹‹é—´é—´éš”çš„èŠ‚ç‚¹æ•°</span></span><br><span class="line">    span <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Skiplist <span class="keyword">struct</span> &#123;</span><br><span class="line">    header, tail *Node</span><br><span class="line">    level <span class="keyword">int</span> <span class="comment">// è®°å½•è·³è¡¨çš„å®é™…é«˜åº¦</span></span><br><span class="line">    length <span class="keyword">int</span> <span class="comment">// è®°å½•è·³è¡¨çš„é•¿åº¦ï¼ˆä¸å«å¤´èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¾…åŠ©æ–¹æ³•"><a href="#è¾…åŠ©æ–¹æ³•" class="headerlink" title="è¾…åŠ©æ–¹æ³•"></a>è¾…åŠ©æ–¹æ³•</h2><p>è€ƒè™‘åˆ°åœ¨å®ç°æ—¶ï¼Œç»å¸¸éœ€è¦æ¯”è¾ƒ score å’Œ elementï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç»™ <code>Node</code> å®ç°äº†ä¸€äº›æ¯”è¾ƒæ–¹æ³•ï¼Œä¾¿äºä½¿ç”¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Compare</span><span class="params">(other *Node)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> node.score &lt; other.score || (node.score == other.score &amp;&amp; node.elem &lt; other.elem) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> node.score &gt; other.score || (node.score == other.score &amp;&amp; node.elem &gt; other.elem) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Lt</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &lt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Lte</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &lt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Gt</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &gt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Eq</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ’å…¥å…ƒç´ "><a href="#æ’å…¥å…ƒç´ " class="headerlink" title="æ’å…¥å…ƒç´ "></a>æ’å…¥å…ƒç´ </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Insert å‘è·³è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">// 1. æŸ¥æ‰¾æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="comment">// 2. åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶åœ¨ç›®æ ‡ä½ç½®æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// 3. è°ƒæ•´è·³è¡¨ backward æŒ‡é’ˆç­‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">Insert</span><span class="params">(score <span class="keyword">float64</span>, elem <span class="keyword">string</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        <span class="comment">// update ç”¨äºè®°å½•æ¯å±‚å¾…æ›´æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        <span class="comment">// rank ç”¨æ¥è®°å½•æ¯å±‚ç»è¿‡çš„èŠ‚ç‚¹è®°å½•ï¼ˆå¯ä»¥çœ‹æˆåˆ°å¤´èŠ‚ç‚¹çš„è·ç¦»ï¼‰</span></span><br><span class="line">        rank [MaxLevel]<span class="keyword">int</span></span><br><span class="line">        <span class="comment">// æ„å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œç”¨äºä¸‹é¢çš„å¤§å°åˆ¤æ–­ï¼Œå…¶ level åœ¨åé¢è®¾ç½®</span></span><br><span class="line">        node = &amp;Node&#123;score: score, elem: elem&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">if</span> cur == sl.header &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rank[i] = rank[i+<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸åŒå±‚çš„åä¸€ä¸ªèŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœåä¸€ä¸ªæ¯”ç›®æ ‡å€¼å°ï¼Œåˆ™å¯ä»¥ç»§ç»­å‘å</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ä¸‹é™åˆ°ä¸€å±‚æŸ¥æ‰¾ã€‚æ³¨æ„è¿™é‡Œçš„å¤§å°æ¯”è¾ƒæ˜¯æŒ‰ç…§ score å’Œ</span></span><br><span class="line">        <span class="comment">// elem ç»¼åˆè®¡ç®—å¾—åˆ°çš„ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(node) &#123;</span><br><span class="line">            rank[i] += cur.level[i].span</span><br><span class="line">            <span class="comment">// åŒå±‚ç»§ç»­å¾€åæŸ¥æ‰¾</span></span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´è·³è¡¨é«˜åº¦</span></span><br><span class="line">    level := sl.randomLevel()</span><br><span class="line">    <span class="keyword">if</span> level &gt; sl.level &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ¯å±‚</span></span><br><span class="line">        <span class="keyword">for</span> i := level - <span class="number">1</span>; i &gt;= sl.level; i-- &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span></span><br><span class="line">            update[i] = sl.header</span><br><span class="line">            update[i].level[i].span = sl.length</span><br><span class="line">        &#125;</span><br><span class="line">        sl.level = level</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°èŠ‚ç‚¹ levelï¼Œå¹¶æ’å…¥æ–°èŠ‚ç‚¹</span></span><br><span class="line">    node.setLevel(level)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; level; i++ &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°æ¯å±‚çš„èŠ‚ç‚¹æŒ‡å‘</span></span><br><span class="line">        node.level[i].forward = update[i].level[i].forward</span><br><span class="line">        update[i].level[i].forward = node</span><br><span class="line">        <span class="comment">// æ›´æ–° span ä¿¡æ¯</span></span><br><span class="line">        node.level[i].span = update[i].level[i].span - (rank[<span class="number">0</span>] - rank[i])</span><br><span class="line">        update[i].level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é’ˆå¯¹æ–°å¢èŠ‚ç‚¹ level &lt; sl.level çš„æƒ…å†µï¼Œéœ€è¦æ›´æ–°ä¸Šé¢æ²¡æœ‰æ‰«åˆ°çš„å±‚ span</span></span><br><span class="line">    <span class="keyword">for</span> i := level; i &lt; sl.level; i++ &#123;</span><br><span class="line">        update[i].level[i].span++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´ backward æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™ backward ä¸º nil</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ backward æŒ‡å‘ä¹‹å‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> update[<span class="number">0</span>] != sl.header &#123;</span><br><span class="line">        <span class="comment">// update[0] å°±æ˜¯å’Œæ–°å¢èŠ‚ç‚¹ç›¸é‚»çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        node.backward = update[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°å¢èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™éœ€è¦æ›´æ–° tail æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> node.level[<span class="number">0</span>].forward == <span class="literal">nil</span> &#123;</span><br><span class="line">        sl.tail = node</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­é—´èŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹çš„å›é€€æŒ‡é’ˆ</span></span><br><span class="line">        node.level[<span class="number">0</span>].forward.backward = node</span><br><span class="line">    &#125;</span><br><span class="line">    sl.length++</span><br><span class="line">    <span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// randomLevel å¯¹äºæ–°å¢èŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªéšæœºçš„ level</span></span><br><span class="line"><span class="comment">// è¿”å›çš„ level èŒƒå›´ä¸º [1, MaxLevel]ã€‚å¹¶ä¸”ï¼Œé‡‡ç”¨çš„</span></span><br><span class="line"><span class="comment">// ç®—æ³•ä¼šä¿è¯ï¼Œæ›´å¤§çš„ level è¿”å›çš„æ¦‚ç‡è¶Šä½ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ª level å‡ºç°çš„æ¦‚ç‡è®¡ç®—ï¼š(1-p) * p^(level-1)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">randomLevel</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    level := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> rand.Float64() &lt; P &amp;&amp; level &lt; MaxLevel &#123;</span><br><span class="line">        level++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> level</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete ç”¨äºåˆ é™¤è·³è¡¨ä¸­æŒ‡å®šçš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">Delete</span><span class="params">(score <span class="keyword">float64</span>, elem <span class="keyword">string</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°éœ€è¦åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        targetNode = &amp;Node&#123;elem: elem, score: score&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123;</span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›®æ ‡èŠ‚ç‚¹æ‰¾åˆ°åï¼Œè¿™é‡Œéœ€è¦åˆ¤æ–­ä¸‹ elem æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">    <span class="comment">// score å¯ä»¥é‡å¤ï¼Œæ‰€ä»¥å¿…é¡»è¦è°¨æ…</span></span><br><span class="line">    nodeToBeDeleted := update[<span class="number">0</span>].level[<span class="number">0</span>].forward</span><br><span class="line">    <span class="keyword">if</span> nodeToBeDeleted == <span class="literal">nil</span> || !nodeToBeDeleted.Eq(targetNode) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    sl.deleteNode(update, nodeToBeDeleted)</span><br><span class="line">    <span class="keyword">return</span> nodeToBeDeleted</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">deleteNode</span><span class="params">(update [64]*Node, nodeToBeDeleted *Node)</span></span> &#123;</span><br><span class="line">    <span class="comment">// è¿™æ—¶æˆ‘ä»¬è¦åˆ é™¤çš„èŠ‚ç‚¹å°±æ˜¯ nodeToBeDeleted</span></span><br><span class="line">    <span class="comment">// è°ƒæ•´æ¯å±‚å¾…æ›´æ–°èŠ‚ç‚¹ï¼Œä¿®æ”¹ forward æŒ‡å‘</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sl.level; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> update[i].level[i].forward == nodeToBeDeleted &#123;</span><br><span class="line">            update[i].level[i].forward = nodeToBeDeleted.level[i].forward</span><br><span class="line">            update[i].level[i].span += nodeToBeDeleted.level[i].span - <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            update[i].level[i].span--</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´å›é€€æŒ‡é’ˆï¼š</span></span><br><span class="line">    <span class="comment">// 1. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–° sl.tail</span></span><br><span class="line">    <span class="comment">// 2. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹ä½äºä¸­é—´ï¼Œåˆ™ç›´æ¥æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹ backward å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> sl.tail == nodeToBeDeleted &#123;</span><br><span class="line">        sl.tail = nodeToBeDeleted.backward</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nodeToBeDeleted.level[<span class="number">0</span>].forward.backward = nodeToBeDeleted.backward</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´å±‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span> sl.header.level[sl.level<span class="number">-1</span>].forward == <span class="literal">nil</span> &#123;</span><br><span class="line">        sl.level--</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‡å°‘èŠ‚ç‚¹è®¡æ•°</span></span><br><span class="line">    sl.length--</span><br><span class="line">    nodeToBeDeleted.backward = <span class="literal">nil</span></span><br><span class="line">    nodeToBeDeleted.level[<span class="number">0</span>].forward = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°åˆ†æ•°"><a href="#æ›´æ–°åˆ†æ•°" class="headerlink" title="æ›´æ–°åˆ†æ•°"></a>æ›´æ–°åˆ†æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UpdateScore ç”¨äºæ›´æ–°èŠ‚ç‚¹çš„åˆ†æ•°ã€‚è¯¥å‡½æ•°ä¼šä¿è¯æ›´æ–°åˆ†æ•°åï¼Œ</span></span><br><span class="line"><span class="comment">// èŠ‚ç‚¹çš„æœ‰åºæ€§ä¾ç„¶å¯ä»¥ç»´æŒã€‚</span></span><br><span class="line"><span class="comment">// ç­–ç•¥å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">// 1. å¿«é€Ÿåˆ¤æ–­èƒ½å¦åŸèŠ‚ç‚¹ä¿®æ”¹ï¼Œå¦‚æœå¯ä»¥åˆ™ç›´æ¥ä¿®æ”¹å¹¶è¿”å›ï¼›</span></span><br><span class="line"><span class="comment">// 2. é‡‡ç”¨æ›´åŠ æ˜‚è´µçš„æ“ä½œï¼šåˆ é™¤å†æ·»åŠ ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">UpdateScore</span><span class="params">(curScore <span class="keyword">float64</span>, elem <span class="keyword">string</span>, newScore <span class="keyword">float64</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        targetNode = &amp;Node&#123;elem: elem, score: curScore&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123;</span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    node := cur.level[<span class="number">0</span>].forward</span><br><span class="line">    <span class="keyword">if</span> node == <span class="literal">nil</span> || !node.Eq(targetNode) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sl.canUpdateScoreFor(node, newScore) &#123;</span><br><span class="line">        node.score = newScore</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œå¢åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">        sl.deleteNode(update, node)</span><br><span class="line">        <span class="keyword">return</span> sl.Insert(newScore, node.elem)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// canUpdateScoreFor ç¡®å®šèƒ½å¦ç›´æ¥åœ¨åŸæœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œä¿®æ”¹</span></span><br><span class="line"><span class="comment">// ä»€ä¹ˆæ¡ä»¶æ‰å¯ä»¥ç›´æ¥åŸåœ°æ›´æ–° score å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment">// 1. node æ˜¯å”¯ä¸€ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼ˆnode.backward == NULL &amp;&amp; node-&gt;level[0].forward == NULLï¼‰</span></span><br><span class="line"><span class="comment">// 2. node æ˜¯ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸”æ–°çš„åˆ†æ•°è¦æ¯” node ä¹‹åèŠ‚ç‚¹åˆ†æ•°è¦å°ï¼ˆè¿™æ ·æ‰èƒ½ä¿è¯æœ‰åºï¼‰</span></span><br><span class="line"><span class="comment">// å³ï¼šnode.backward == NULL &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newScoreï¼‰</span></span><br><span class="line"><span class="comment">// 3. node æ˜¯æœ€åä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸” node ä¹‹å‰èŠ‚ç‚¹çš„åˆ†æ•°è¦æ¯”æ–°æ”¹çš„åˆ†æ•°å°</span></span><br><span class="line"><span class="comment">// å³ï¼šnode-&gt;backward-&gt;score &lt; newScore &amp;&amp; node-&gt;level[0].forward == NULL</span></span><br><span class="line"><span class="comment">// 4. node æ˜¯ä¿®æ”¹çš„åçš„åˆ†æ•°æ°å¥½è¿˜èƒ½ä¿è¯ä½äºå‰ä¸€ä¸ªå’Œåä¸€ä¸ªèŠ‚ç‚¹åˆ†æ•°ä¹‹é—´</span></span><br><span class="line"><span class="comment">// å³ï¼šnode-&gt;backward-&gt;score &lt; newscore &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newscore</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">canUpdateScoreFor</span><span class="params">(node *Node, newScore <span class="keyword">float64</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.backward == <span class="literal">nil</span> || node.backward.score &lt; newScore) &amp;&amp;</span><br><span class="line">        (node.level[<span class="number">0</span>].forward == <span class="literal">nil</span> || node.level[<span class="number">0</span>].forward.score &gt; newScore) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¿—è¯è¯´ï¼Œã€Œè¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥éš¾ã€ã€‚åœ¨å®ç°ã€Œè·³è¡¨ã€çš„æ—¶å€™æ„Ÿå—é¢‡æ·±ï¼Œä¼¼ä¹çœ‹å®Œ Redis çš„ã€Œè·³è¡¨ã€æºç å’Œç½‘ä¸Šè¯¸å¤šå‰è¾ˆç¼–å†™çš„æ–‡ç« åï¼Œè‡ªä»¥ä¸ºæ‡‚å¾—äº†åŸç†ï¼ˆå¯èƒ½ç¡®å®æ‡‚äº†ï¼‰ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°çš„æ—¶å€™è¿˜æ˜¯è¸©äº†ä¸å°‘å‘ã€‚æ¯”å¦‚ï¼Œç©ºæŒ‡é’ˆå¼•èµ· panicï¼›<code>i--</code> å†™æˆäº† <code>i++</code> å¯¼è‡´æŸ¥æ‰¾å¤±è´¥ï¼›ä¸€äº›è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­ç­‰ã€‚æ€»ä¹‹ï¼Œç»†èŠ‚å†³å®šæˆè´¥ï¼Œéœ€è¦åœ¨ä¿æŒæ€è·¯æ¸…æ™°çš„åŒæ—¶ï¼Œæ›´åŠ è°¨æ…ä¸€äº›æ‰èƒ½å†™å‡ºè¶³å¤Ÿå¥å£®çš„ä»£ç æ¥ã€‚å½“ç„¶ï¼Œè¿™æœŸé—´è‡ªç„¶å°‘ä¸äº†å•å…ƒæµ‹è¯•çš„åŠ©æ”»ï¼Œå¦åˆ™æœ‰å¾ˆå¤šé—®é¢˜å¯èƒ½éƒ½æ²¡æ³•æš´éœ²å‡ºæ¥~</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/53975333" target="_blank" rel="noopener">æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯è·³è¡¨ï¼Ÿ</a></li><li><a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;è¯»è¿‡ Redis æºç çš„ç«¥é‹ï¼Œæƒ³å¿…ä¼šçŸ¥é“ zset å®ç°æ—¶ï¼Œä½¿ç”¨äº†ã€Œè·³è¡¨ã€ï¼ˆSkiplistï¼‰è¿™ç§æ•°æ®ç»“æ„å§ã€‚å®ƒçš„åŸç†éå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœå¯¹é“¾è¡¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼ˆæ ¸å¿ƒï¼š&lt;strong&gt;æœ‰åºé“¾è¡¨&lt;/strong&gt; + &lt;strong&gt;åˆ†å±‚&lt;/strong&gt;ï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸ä¼šè¯¦ç»†è®²è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¯¹äº Redis è·³è¡¨æºç çš„è¯¦ç»†åˆ†æã€‚å› ä¸ºå·²ç»æœ‰å‰è¾ˆä»¬äº§å‡ºäº†éå¸¸ä¸°å¯Œçš„æ–‡ç« æ¥è®²è§£ Redis è·³è¡¨ï¼Œéœ€è¦çš„è¯ï¼Œæ¨èé˜…è¯» &lt;a href=&quot;https://juejin.im/post/57fa935b0e3dd90057c50fbc&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt; äº†è§£æ›´å¤šç»†èŠ‚ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="http://ifaceless.space/categories/Redis/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="è·³è¡¨" scheme="http://ifaceless.space/tags/%E8%B7%B3%E8%A1%A8/"/>
    
      <category term="Redis" scheme="http://ifaceless.space/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 5 æºç åˆæ¢</title>
    <link href="http://ifaceless.space/2019/12/08/primitive-exploration-of-redis5/"/>
    <id>http://ifaceless.space/2019/12/08/primitive-exploration-of-redis5/</id>
    <published>2019-12-08T07:01:24.000Z</published>
    <updated>2019-12-15T06:10:30.103Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">Redis, REmote DIctionary Server</a> å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼</p><p>ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š</p><ol><li>è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›</li><li>ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›</li><li>ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ol><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯<strong>å­—ç¬¦ä¸²ã€é›†åˆï¼ˆæœ‰åº/æ— åºï¼‰ã€å­—å…¸ã€åˆ—è¡¨</strong>ç­‰ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚</p><a id="more"></a><p>æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚</p><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ</p><p>é¦–å…ˆï¼Œ<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹</a> å’Œ <a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a> å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚</p><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼›</li><li>åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼›</li><li>æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼›</li><li>å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚</li></ol><h1 id="Redis-ç‰¹ç‚¹"><a href="#Redis-ç‰¹ç‚¹" class="headerlink" title="Redis ç‰¹ç‚¹"></a>Redis ç‰¹ç‚¹</h1><p>ç¬¬ä¸€ä¸ªå€¼å¾—ç§°é“çš„ç‰¹ç‚¹å°±æ˜¯<strong>é«˜æ€§èƒ½</strong>ï¼ŒRedis çš„é«˜æ€§èƒ½å¾—ç›Šäºå¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š</p><ol><li>å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼›</li><li>æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼›</li><li>ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼›</li><li>é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚</li></ol><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><code>&lt;key, value&gt;</code> ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼›</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼›</li><li>æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼›</li><li>æ”¯æŒé›†ç¾¤ã€‚</li></ol><h1 id="æºç æ¦‚è§ˆ"><a href="#æºç æ¦‚è§ˆ" class="headerlink" title="æºç æ¦‚è§ˆ"></a>æºç æ¦‚è§ˆ</h1><p><em>åé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼š<a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">https://github.com/iFaceless/redis/tree/5.0</a>ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ <code>comment-src</code> åˆ†æ”¯ä¸‹ã€‚</em></p><p>å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ <a href="https://github.com/antirez/redis/tree/5.0#source-code-layout" target="_blank" rel="noopener">README.md</a> ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š</p><ul><li><code>src</code>: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰</li><li><code>tests</code>: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰</li><li><code>deps</code>: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« <code>jemalloc</code> æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ <code>malloc</code>ï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡</li></ul><h2 id="server-h"><a href="#server-h" class="headerlink" title="server.h"></a>server.h</h2><p><code>server.h</code> ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ <code>struct redisServer</code> ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li><code>db</code>: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®</li><li><code>commands</code>: å‘½ä»¤è¡¨</li><li><code>clients</code>: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨</li><li><code>master</code>: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯</li></ul><p>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>redisClient</code>ï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="comment">// å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    sds querybuf;</span><br><span class="line">    <span class="keyword">int</span> argc;</span><br><span class="line">    robj **argv;</span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="comment">// reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">    <span class="built_in">list</span> *reply;</span><br><span class="line">    <span class="keyword">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class="line">    ... many other fields ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>robj</code>ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="comment">// type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></span><br><span class="line">    <span class="comment">// refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">   <span class="comment">// ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><h2 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h2><p>Redis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ <code>main</code> å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š</p><ul><li><code>initServerConfig()</code> ç”¨æ¥é…ç½® <code>struct server</code> çš„é»˜è®¤å€¼</li><li><code>initServer()</code> åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰</li><li><code>aeMain()</code> å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥</li></ul><p>Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>serverCron()</code> ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ <code>server.hz</code> é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰</li><li><code>beforeSleep()</code> ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰</li></ul><p>åœ¨ <code>server.c</code> ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š</p><ul><li><code>call()</code> ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨</li><li><code>activeExpireCycle()</code> ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys</li><li><code>freeMemoryIfNeeded()</code> å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ <code>maxmemory</code> æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜</li><li><code>redisCommandTable</code> ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§</li></ul><h2 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h2><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š</p><ul><li><code>createClient()</code> åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯</li><li><code>addReply*()</code> å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ®</li><li><code>writeToClient()</code> ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« <code>sendReplyToClient()</code> è°ƒç”¨</li><li><code>readQueryFromClient()</code> ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº</li><li><code>processInputBuffer()</code> æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ <code>processCommand()</code> æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤</li><li><code>freeClient()</code> é‡Šæ”¾å®¢æˆ·ç«¯</li></ul><h2 id="aof-c-å’Œ-rdb-c"><a href="#aof-c-å’Œ-rdb-c" class="headerlink" title="aof.c å’Œ rdb.c"></a>aof.c å’Œ rdb.c</h2><p>é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<code>rdb.c</code> åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›<code>aof.c</code> åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚</p><h2 id="db-c"><a href="#db-c" class="headerlink" title="db.c"></a>db.c</h2><p><code>db.c</code> ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ <code>DEL</code> å’Œ <code>EXPIRE</code> ç­‰ã€‚æ­¤å¤–ï¼Œ<code>db.c</code> ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p>ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š</p><ul><li><code>lookupKeyRead()</code> å’Œ <code>lookupKeyWrite()</code> ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>NULL</code></li><li><code>dbAdd()</code> åŠæ›´æŠ½è±¡çš„å‡½æ•° <code>setKey()</code> æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key</li><li><code>dbDelete()</code> ç§»é™¤ key åŠå…³è”çš„ value</li><li><code>emptyDb()</code> ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“</li></ul><h2 id="object-c"><a href="#object-c" class="headerlink" title="object.c"></a>object.c</h2><p><code>struct robj</code> æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ <code>object.c</code> ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>incrRefcount()</code> å’Œ <code>decrRefCount()</code> ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡</li><li><code>createObject()</code> ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ <code>createStringObjectFromLongLong()</code> ç­‰</li></ul><h2 id="replication-c"><a href="#replication-c" class="headerlink" title="replication.c"></a>replication.c</h2><p><code>replication.c</code> æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚</p><p>è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° <code>replicationFeedSlaves()</code>ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† <code>SYNC</code> å’Œ <code>PSYNC</code> å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚</p><h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><ul><li><code>t_hash.c</code>, <code>t_list.c</code>, <code>t_set.c</code>, <code>t_string.c</code> å’Œ <code>t_zset.c</code>  æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç°</li><li><code>ae.c</code> Redis äº‹ä»¶å¾ªç¯å®ç°</li><li><code>sds.c</code> Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸²</li><li><code>anet.c</code> å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£</li><li><code>dict.c</code> éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç°</li><li><code>scripting.c</code> å®ç°äº† Luc è„šæœ¬</li><li><code>cluster.c</code> Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ <a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis é›†ç¾¤è¯´æ˜</a></li></ul><h2 id="æ€ç»´å¯¼å›¾"><a href="#æ€ç»´å¯¼å›¾" class="headerlink" title="æ€ç»´å¯¼å›¾"></a>æ€ç»´å¯¼å›¾</h2><p><img src="https://pic1.zhimg.com/80/v2-f63c98a65e85898b828f3446f260a060.png" alt=""></p><h1 id="æ„å»º-amp-è°ƒè¯•"><a href="#æ„å»º-amp-è°ƒè¯•" class="headerlink" title="æ„å»º &amp; è°ƒè¯•"></a>æ„å»º &amp; è°ƒè¯•</h1><p>Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a> ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ <a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a> è¿™ç¯‡æ–‡ç« ~</p><p>åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° <code>src</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./mkreleasehdr.sh</code> è„šæœ¬ç”Ÿæˆ <code>src/release.h</code> æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake .</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ <code>src/server.c</code> ï¼Œå¹¶æ‰¾åˆ° <code>main</code> å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» <code>main</code> å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚</p><p><img src="https://pic1.zhimg.com/v2-823df912ab47cf9dbe7ccc53a0eae03f.jpg" alt=""></p><p>Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š<br><img src="https://pic2.zhimg.com/v2-66bb67315fc0d86701b95ae306679eeb.jpg" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://github.com/antirez/redis/tree/5.0" target="_blank" rel="noopener">Redis README</a></li><li><a href="https://sunznx.com/redis/redis-source-debug-with-clion.html" target="_blank" rel="noopener">Clion è°ƒè¯• Redis æºç </a></li><li><a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/iFaceless/redis/tree/5.0&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Redis, REmote DIctionary Server&lt;/a&gt; å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼&lt;/p&gt;
&lt;p&gt;ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›&lt;/li&gt;
&lt;li&gt;ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯&lt;strong&gt;å­—ç¬¦ä¸²ã€é›†åˆï¼ˆæœ‰åº/æ— åºï¼‰ã€å­—å…¸ã€åˆ—è¡¨&lt;/strong&gt;ç­‰ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="http://ifaceless.space/categories/Redis/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Redis" scheme="http://ifaceless.space/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>gcache æºç å­¦ä¹ </title>
    <link href="http://ifaceless.space/2019/12/03/gcache-code-analysis/"/>
    <id>http://ifaceless.space/2019/12/03/gcache-code-analysis/</id>
    <published>2019-12-03T12:36:43.000Z</published>
    <updated>2019-12-08T07:11:32.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">Redis, REmote DIctionary Server</a> å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼</p><p>ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š</p><ol><li>è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›</li><li>ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›</li><li>ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ol><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯ <code>string</code>, <code>set</code>, <code>zset</code>, <code>list</code>, <code>hash map</code>ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚</p><a id="more"></a><p>æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚</p><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ</p><p>é¦–å…ˆï¼Œ<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹</a> å’Œ <a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a> å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚</p><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼›</li><li>åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼›</li><li>æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼›</li><li>å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚</li></ol><h1 id="Redis-ç‰¹ç‚¹"><a href="#Redis-ç‰¹ç‚¹" class="headerlink" title="Redis ç‰¹ç‚¹"></a>Redis ç‰¹ç‚¹</h1><p>Redis ä¹‹æ‰€ä»¥èƒ½å¤Ÿæœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š</p><ol><li>å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼›</li><li>æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼›</li><li>ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼›</li><li>é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚</li></ol><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><code>&lt;key, value&gt;</code> ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼›</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼›</li><li>æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼›</li><li>æ”¯æŒé›†ç¾¤ã€‚</li></ol><h1 id="æºç æ¦‚è§ˆ"><a href="#æºç æ¦‚è§ˆ" class="headerlink" title="æºç æ¦‚è§ˆ"></a>æºç æ¦‚è§ˆ</h1><p><em>åé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼š<a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">https://github.com/iFaceless/redis/tree/5.0</a>ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ <code>comment-src</code> åˆ†æ”¯ä¸‹ã€‚</em></p><p>å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ <a href="https://github.com/antirez/redis/tree/5.0#source-code-layout" target="_blank" rel="noopener">README.md</a> ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š</p><ul><li><code>src</code>: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰</li><li><code>tests</code>: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰</li><li><code>deps</code>: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« <code>jemalloc</code> æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ <code>malloc</code>ï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡</li></ul><h2 id="server-h"><a href="#server-h" class="headerlink" title="server.h"></a>server.h</h2><p><code>server.h</code> ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ <code>struct redisServer</code> ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li><code>db</code>: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®</li><li><code>commands</code>: å‘½ä»¤è¡¨</li><li><code>clients</code>: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨</li><li><code>master</code>: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯</li></ul><p>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>redisClient</code>ï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="comment">// å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    sds querybuf;</span><br><span class="line">    <span class="keyword">int</span> argc;</span><br><span class="line">    robj **argv;</span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="comment">// reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">    <span class="built_in">list</span> *reply;</span><br><span class="line">    <span class="keyword">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class="line">    ... many other fields ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>robj</code>ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="comment">// type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></span><br><span class="line">    <span class="comment">// refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">   <span class="comment">// ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><h2 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h2><p>Redis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ <code>main</code> å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š</p><ul><li><code>initServerConfig()</code> ç”¨æ¥é…ç½® <code>struct server</code> çš„é»˜è®¤å€¼</li><li><code>initServer()</code> åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰</li><li><code>aeMain()</code> å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥</li></ul><p>Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>serverCron()</code> ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ <code>server.hz</code> é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰</li><li><code>beforeSleep()</code> ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰</li></ul><p>åœ¨ <code>server.c</code> ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š</p><ul><li><code>call()</code> ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨</li><li><code>activeExpireCycle()</code> ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys</li><li><code>freeMemoryIfNeeded()</code> å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ <code>maxmemory</code> æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜</li><li><code>redisCommandTable</code> ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§</li></ul><h2 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h2><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š</p><ul><li><code>createClient()</code> åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯</li><li><code>addReply*()</code> å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ®</li><li><code>writeToClient()</code> ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« <code>sendReplyToClient()</code> è°ƒç”¨</li><li><code>readQueryFromClient()</code> ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº</li><li><code>processInputBuffer()</code> æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ <code>processCommand()</code> æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤</li><li><code>freeClient()</code> é‡Šæ”¾å®¢æˆ·ç«¯</li></ul><h2 id="aof-c-å’Œ-rdb-c"><a href="#aof-c-å’Œ-rdb-c" class="headerlink" title="aof.c å’Œ rdb.c"></a>aof.c å’Œ rdb.c</h2><p>é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<code>rdb.c</code> åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›<code>aof.c</code> åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚</p><h2 id="db-c"><a href="#db-c" class="headerlink" title="db.c"></a>db.c</h2><p><code>db.c</code> ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ <code>DEL</code> å’Œ <code>EXPIRE</code> ç­‰ã€‚æ­¤å¤–ï¼Œ<code>db.c</code> ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p>ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š</p><ul><li><code>lookupKeyRead()</code> å’Œ <code>lookupKeyWrite()</code> ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>NULL</code></li><li><code>dbAdd()</code> åŠæ›´æŠ½è±¡çš„å‡½æ•° <code>setKey()</code> æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key</li><li><code>dbDelete()</code> ç§»é™¤ key åŠå…³è”çš„ value</li><li><code>emptyDb()</code> ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“</li></ul><h2 id="object-c"><a href="#object-c" class="headerlink" title="object.c"></a>object.c</h2><p><code>struct robj</code> æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ <code>object.c</code> ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>incrRefcount()</code> å’Œ <code>decrRefCount()</code> ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡</li><li><code>createObject()</code> ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ <code>createStringObjectFromLongLong()</code> ç­‰</li></ul><h2 id="replication-c"><a href="#replication-c" class="headerlink" title="replication.c"></a>replication.c</h2><p><code>replication.c</code> æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚</p><p>è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° <code>replicationFeedSlaves()</code>ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† <code>SYNC</code> å’Œ <code>PSYNC</code> å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚</p><h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><ul><li><code>t_hash.c</code>, <code>t_list.c</code>, <code>t_set.c</code>, <code>t_string.c</code> å’Œ <code>t_zset.c</code>  æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç°</li><li><code>ae.c</code> Redis äº‹ä»¶å¾ªç¯å®ç°</li><li><code>sds.c</code> Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸²</li><li><code>anet.c</code> å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£</li><li><code>dict.c</code> éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç°</li><li><code>scripting.c</code> å®ç°äº† Luc è„šæœ¬</li><li><code>cluster.c</code> Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ <a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis é›†ç¾¤è¯´æ˜</a></li></ul><h2 id="æ€ç»´å¯¼å›¾"><a href="#æ€ç»´å¯¼å›¾" class="headerlink" title="æ€ç»´å¯¼å›¾"></a>æ€ç»´å¯¼å›¾</h2><p><img src="https://pic4.zhimg.com/v2-aab236e8173ddcc8e76721fbf651ea53.jpg" alt=""></p><h1 id="æ„å»º-amp-è°ƒè¯•"><a href="#æ„å»º-amp-è°ƒè¯•" class="headerlink" title="æ„å»º &amp; è°ƒè¯•"></a>æ„å»º &amp; è°ƒè¯•</h1><p>Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a> ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ <a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a> è¿™ç¯‡æ–‡ç« ~</p><p>åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° <code>src</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./mkreleasehdr.sh</code> è„šæœ¬ç”Ÿæˆ <code>src/release.h</code> æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake .</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ <code>src/server.c</code> ï¼Œå¹¶æ‰¾åˆ° <code>main</code> å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» <code>main</code> å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚</p><p><img src="https://pic1.zhimg.com/v2-823df912ab47cf9dbe7ccc53a0eae03f.jpg" alt=""></p><p>Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š<br><img src="https://pic2.zhimg.com/v2-66bb67315fc0d86701b95ae306679eeb.jpg" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://github.com/antirez/redis/tree/5.0" target="_blank" rel="noopener">Redis README</a></li><li><a href="https://sunznx.com/redis/redis-source-debug-with-clion.html" target="_blank" rel="noopener">Clion è°ƒè¯• Redis æºç </a></li><li><a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/iFaceless/redis/tree/5.0&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Redis, REmote DIctionary Server&lt;/a&gt; å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼&lt;/p&gt;
&lt;p&gt;ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›&lt;/li&gt;
&lt;li&gt;ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯ &lt;code&gt;string&lt;/code&gt;, &lt;code&gt;set&lt;/code&gt;, &lt;code&gt;zset&lt;/code&gt;, &lt;code&gt;list&lt;/code&gt;, &lt;code&gt;hash map&lt;/code&gt;ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="ç¼“å­˜" scheme="http://ifaceless.space/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="LRU" scheme="http://ifaceless.space/tags/LRU/"/>
    
      <category term="LFU" scheme="http://ifaceless.space/tags/LFU/"/>
    
      <category term="ARC" scheme="http://ifaceless.space/tags/ARC/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ–ï¼Ÿ</title>
    <link href="http://ifaceless.space/2019/11/28/portal/"/>
    <id>http://ifaceless.space/2019/11/28/portal/</id>
    <published>2019-11-28T13:50:45.000Z</published>
    <updated>2019-11-28T09:41:31.558Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚</p><p>è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚<br><a id="more"></a><br>ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¹Ÿé‡åˆ°äº†è¯¸å¤šé—®é¢˜ï¼š</p><ol><li>API Schema çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®šä¹‰çš„ä¸åŒï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨å‘å·å™¨è·å¾—çš„ ID åœ¨ Model struct ä¸­å®šä¹‰çš„æ˜¯ int64ï¼Œä½†æ˜¯ä¸ºäº†é¿å… json.Marshal æ—¶æº¢å‡ºï¼ˆæµè§ˆå™¨æˆªæ–­ï¼‰ï¼Œç»Ÿä¸€è¿”å›äº† string ç±»å‹çš„ IDï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼›</li><li>API Schema çš„å­—æ®µåç§°å’Œ Model ä¸­å®šä¹‰çš„å¯èƒ½ä¸åŒï¼›</li><li>æ”¯æŒçµæ´»çš„ Schema å­—æ®µè¿‡æ»¤æ¯”è¾ƒéº»çƒ¦ï¼Œä¸åŒçš„é¡¹ç›®å®ç°å¯èƒ½ä¸åŒï¼›</li><li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚è¯¾ç¨‹ API Schema å…³è”çš„ä¸€äº›æ•°æ®æ¥è‡ªäºå…¶å®ƒæœåŠ¡ï¼ˆéœ€è¦é€šè¿‡ RPC è°ƒç”¨ï¼‰ï¼Œè¿™æ—¶å¦‚æœèƒ½å¤Ÿå¹¶å‘åŠ è½½å°±æœ‰æé«˜æ¥å£å“åº”é€Ÿåº¦çš„å¯èƒ½ï¼Œä½†æ˜¯éœ€è¦æ¯æ¬¡åœ¨åº”ç”¨å±‚é‡æ–°å®ç°ï¼ˆå½“ç„¶å¯ä»¥å†æŠ½ä¸€å±‚å‡ºæ¥ï¼Œä¸è¿‡è¿˜æ˜¯å¾ˆéº»çƒ¦ï¼Œä¼šæœ‰å¿ƒæ™ºè´Ÿæ‹…ï¼‰ã€‚</li><li>â€¦â€¦</li></ol><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ</p><h1 id="æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”"><a href="#æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”" class="headerlink" title="æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”"></a>æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”</h1><p>æˆ‘ä»¬ä¹‹å‰åœ¨ä½¿ç”¨ Python é¡¹ç›®å¼€å‘æ—¶ï¼Œä½¿ç”¨åˆ°äº† <a href="https://github.com/marshmallow-code/marshmallow" target="_blank" rel="noopener">marshmallow</a> è¿™ä¸ªè½»é‡çº§çš„å¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ã€‚å½“ç„¶ï¼Œå®ƒä¸ä»…ä»…æä¾›åºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œè¿˜æœ‰ååºåˆ—åŒ–ä»¥åŠå­—æ®µæ ¡éªŒçš„èƒ½åŠ›ã€‚å¦‚æœèƒ½å¤Ÿæ°å½“çš„ä½¿ç”¨å®ƒï¼Œæ˜¯å¯ä»¥æå‡å¼€å‘æ•ˆç‡çš„ã€‚å¦‚æœåœ¨ Go è¯­è¨€ç¤¾åŒºä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªæ¡†æ¶çš„è¯ï¼Œå®ƒæ˜¯å¯ä»¥è§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜çš„ã€‚</p><p>åœ¨ç»è¿‡ä¸€ç•ªæ€æƒ³æ–—äº‰åï¼Œæ–—èƒ†å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„æ¡†æ¶ <a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> ç”¨äºè§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜ã€‚<a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> èšç„¦äºä»¥ä¼˜é›…ä¸”ä¸€è‡´çš„æ–¹å¼å¤„ç†å¯¹è±¡åºåˆ—åŒ–çš„é—®é¢˜ï¼›è€Œå¯¹äº Struct Fields çš„æ ¡éªŒé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¬¬ä¸‰æ–¹åº“å¦‚ <a href="https://github.com/go-playground/validator" target="_blank" rel="noopener">go-playground/validator</a> æˆ– <a href="https://github.com/asaskevich/govalidator" target="_blank" rel="noopener">asaskevich/govalidator</a>ã€‚</p><p>ç›®å‰æ¥è¯´ï¼Œæ ¸å¿ƒåŠŸèƒ½å‡å·²æŒ‰ç…§æœ€åˆçš„è®¾è®¡å®ç°äº†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ol><li>æä¾›ç®€æ´æ˜“ç”¨çš„ API æ¥å£</li><li>æ”¯æŒéå¸¸çµæ´»çš„å­—æ®µè¿‡æ»¤èƒ½åŠ›ï¼ˆä»»æ„æ·±åº¦çš„åµŒå¥—å­—æ®µè¿‡æ»¤ï¼‰</li><li>è‡ªåŠ¨å°è¯•ç±»å‹è½¬æ¢ï¼Œè¿œç¦»æ‰‹åŠ¨ç¼–å†™å¤ªå¤šæ²¡ä»€ä¹ˆçµé­‚çš„ç±»å‹è½¬æ¢ä»£ç ï¼ˆæ—©ç‚¹ä¸‹ç­ä¸å¥½å—ï¼Ÿï¼‰</li><li>æ”¯æŒå¹¶å‘å¡«å……å­—æ®µå€¼ï¼š<ol><li>å¯æ‰‹åŠ¨æŒ‡å®šå“ªäº›å­—æ®µå¼‚æ­¥åŠ è½½</li><li>å¯è®¾ç½®å…¨å±€çš„ goroutine æ± å¤§å°</li></ol></li></ol><h1 id="ä½¿ç”¨-PORTAL"><a href="#ä½¿ç”¨-PORTAL" class="headerlink" title="ä½¿ç”¨ PORTAL"></a>ä½¿ç”¨ PORTAL</h1><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…è¯¥åŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get get -u github.com/ifaceless/portal</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ Model ç»“æ„ä½“</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotificationModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">int</span></span><br><span class="line">    Title   <span class="keyword">string</span></span><br><span class="line">    Content <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Fullname</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        <span class="comment">// åç§°ç”šè‡³å¯ä»¥æ¥è‡ª RPC è°ƒç”¨ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"user:%d"</span>, u.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notifications è¿”å›ç”¨æˆ·å…³è”çš„ä¸€äº›é€šçŸ¥ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Notifications</span><span class="params">()</span> <span class="params">(result []*NotificationModel)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1</span>; i++ &#123;</span><br><span class="line">        result = <span class="built_in">append</span>(result, &amp;NotificationModel&#123;</span><br><span class="line">            ID:      i,</span><br><span class="line">            Title:   fmt.Sprintf(<span class="string">"title_%d"</span>, i),</span><br><span class="line">            Content: fmt.Sprintf(<span class="string">"content_%d"</span>, i),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="keyword">int</span></span><br><span class="line">    UserID <span class="keyword">int</span></span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User è¿”å› Task å…³è”çš„ç”¨æˆ·æ˜¯è°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TaskModel)</span> <span class="title">User</span><span class="params">()</span> *<span class="title">UserModel</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserModel&#123;t.UserID&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒæ­¥ï¼šå®šä¹‰ API Schema ç»“æ„ä½“</strong></p><p>ä»¥ä¸‹ Schema åœ¨å®šä¹‰æ—¶ï¼Œéƒ½æ·»åŠ äº† json tagï¼Œå¹¶ä¸”æ ‡è®°ä¸º omitemptyã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œ<strong>å½“æˆ‘ä»¬é€‰æ‹©è¿‡æ»¤æŸäº›å­—æ®µçš„æ—¶å€™ï¼Œportal å°±ä¸ä¼šå¡«å……å¯¹åº”çš„ Schema Fields</strong>ã€‚å› æ­¤ï¼Œæ ‡è®°äº† omitempty çš„å­—æ®µåœ¨ json.Marshal åå°±ä¸ä¼šå‡ºç°ï¼Œä»è€Œè¾¾åˆ°å­—æ®µè¿‡æ»¤çš„ç›®çš„ã€‚ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotiSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">string</span> <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title   <span class="keyword">string</span> <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Content <span class="keyword">string</span> <span class="string">`json:"content,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID                   <span class="keyword">string</span>        <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    <span class="comment">// åç§°æ˜¯ä» User.Fullname() æ–¹æ³•ä¸­è·å–ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º User çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨ `attr` æ ‡è®°</span></span><br><span class="line">    Name                 <span class="keyword">string</span>        <span class="string">`json:"name,omitempty" portal:"attr:Fullname"`</span></span><br><span class="line">        <span class="comment">// nested è¡¨æ˜è¯¥å­—æ®µçš„å€¼æ˜¯ä¸€ä¸ªå¤åˆç±»å‹ï¼Œportal ä¼šè‡ªåŠ¨å°† notifications æ•°æ®å¡«å……åˆ°å¯¹åº”çš„ schema åˆ—è¡¨</span></span><br><span class="line">    Notifications        []*NotiSchema <span class="string">`json:"notifications,omitempty" portal:"nested"`</span></span><br><span class="line">    AnotherNotifications []*NotiSchema <span class="string">`json:"another_notifications,omitempty" portal:"nested;attr:Notifications"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID          <span class="keyword">string</span>      <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title       <span class="keyword">string</span>      <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Description <span class="keyword">string</span>      <span class="string">`json:"description,omitempty" portal:"meth:GetDescription"`</span></span><br><span class="line">    <span class="comment">// UserSchema is a nested schema</span></span><br><span class="line">    User        *UserSchema <span class="string">`json:"user,omitempty" portal:"nested"`</span></span><br><span class="line">    <span class="comment">// We just want `Name` field for `SimpleUser`.</span></span><br><span class="line">    <span class="comment">// Besides, the data source is the same with `UserSchema`</span></span><br><span class="line">    SimpleUser  *UserSchema <span class="string">`json:"simple_user,omitempty" portal:"nested;only:Name;attr:User"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetDescription æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•æ¥æä¾›æƒ³è¦çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿”å›ä¸åŒçš„æ–‡æ¡ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TaskSchema)</span> <span class="title">GetDescription</span><span class="params">(model *model.TaskModel)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Custom description"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ­¥ï¼šæŒ‰éœ€åºåˆ—åŒ–</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"github.com/ifaceless/portal"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// log debug info</span></span><br><span class="line">    portal.SetDebug(<span class="literal">true</span>)</span><br><span class="line">    <span class="comment">// set max worker pool size</span></span><br><span class="line">    portal.SetMaxPoolSize(<span class="number">1024</span>)</span><br><span class="line">    <span class="comment">// make sure to clean up.</span></span><br><span class="line">    <span class="keyword">defer</span> portal.CleanUp()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write to a specified task schema</span></span><br><span class="line">    <span class="keyword">var</span> taskSchema schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel)</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","title":"Finish your jobs.","description":"Custom description","user":&#123;"id":"1","name":"user:1","notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;],"another_notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// select specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"Title"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// select fields with alias defined in the json tag.</span></span><br><span class="line">    <span class="comment">// actually, the default alias tag is `json`, `portal.FieldAliasMapTagName("json")` is optional.</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"title"</span>, <span class="string">"SimpleUser"</span>), portal.FieldAliasMapTagName(<span class="string">"json"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// you can keep any fields for any nested schemas</span></span><br><span class="line">    <span class="comment">// multiple fields are separated with ','</span></span><br><span class="line">    <span class="comment">// nested fields are wrapped with '[' and ']'</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"ID"</span>, <span class="string">"User[ID,Notifications[ID],AnotherNotifications[Title]]"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","user":&#123;"id":"1","notifications":[&#123;"id":"0"&#125;],"another_notifications":[&#123;"title":"title_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ignore specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Exclude(<span class="string">"Description"</span>, <span class="string">"ID"</span>, <span class="string">"User[Name,Notifications[ID,Content],AnotherNotifications], SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","user":&#123;"id":"1","notifications":[&#123;"title":"title_0"&#125;]&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dump multiple tasks</span></span><br><span class="line">    <span class="keyword">var</span> taskSchemas []schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchemas, &amp;taskModels, portal.Only(<span class="string">"ID"</span>, <span class="string">"Title"</span>, <span class="string">"User[Name]"</span>))</span><br><span class="line">    <span class="comment">// data: [&#123;"id":"0","title":"Task #1","user":&#123;"name":"user:100"&#125;&#125;,&#123;"id":"1","title":"Task #2","user":&#123;"name":"user:101"&#125;&#125;]</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šä»…ä»…æ˜¯ PORTAL çš„ä¸€äº›ç®€å•åœºæ™¯çš„åº”ç”¨ï¼Œè¯¦ç»†å¯ä»¥æŸ¥çœ‹<a href="https://github.com/iFaceless/portal/blob/master/examples/todo" target="_blank" rel="noopener">å®Œæ•´ç¤ºä¾‹</a>ï¼Œåœ¨<a href="https://github.com/iFaceless/portal/blob/master/USERGUIDE.md" target="_blank" rel="noopener">ä½¿ç”¨æŒ‡å—</a>ä¸­æä¾›äº†ä¸€äº›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ã€‚</p><h1 id="æ ¸å¿ƒ-API"><a href="#æ ¸å¿ƒ-API" class="headerlink" title="æ ¸å¿ƒ API"></a>æ ¸å¿ƒ API</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ...Option)</span> <span class="params">(*Chell, error)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Dump</span><span class="params">(dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span> <span class="title">error</span> </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">DumpWithContext</span><span class="params">(ctx context.Context, dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetDebug</span><span class="params">(v <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetMaxPoolSize</span><span class="params">(size <span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">CleanUp</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h1 id="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"><a href="#å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥" class="headerlink" title="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"></a>å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥</h1><ul><li>å½“æŸä¸ª Schema ç»“æ„ä½“å­—æ®µæ ‡è®°äº† <code>portal:&quot;async&quot;</code> æ ‡ç­¾æ—¶ä¼šå¼‚æ­¥å¡«å……å­—æ®µå€¼ï¼›</li><li>å½“åºåˆ—åŒ– Schema åˆ—è¡¨æ—¶ï¼Œä¼šåˆ†æ Schema ä¸­æœ‰æ— æ ‡è®°äº† <code>async</code> çš„å­—æ®µï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ä½¿ç”¨å¹¶å‘å¡«å……ç­–ç•¥ï¼›å¦åˆ™åªåœ¨å½“å‰ goroutine ä¸­å®Œæˆåºåˆ—åŒ–ï¼›</li><li>å¯ä»¥åœ¨ Dump æ—¶æ·»åŠ  <code>portal.DisableConcurrency()</code> ç¦ç”¨å¹¶å‘åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚</li></ul><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p><strong>Q: ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€ worker pool å­˜åœ¨ï¼Ÿ</strong><br><strong>A:</strong> è€ƒè™‘åˆ°åœ¨ Web æœåŠ¡ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutine å¤„ç†ã€‚è€Œåœ¨å¤„ç†è¯·æ±‚ä¸­ï¼Œå¦‚æœä¸é™åˆ¶ PORTAL å¹¶å‘åŠ è½½å­—æ®µå€¼æ—¶çš„ goroutine æ•°é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„èµ„æºæ¶ˆè€—é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† ants æ¡†æ¶ã€‚</p><p><strong>Q: æ€§èƒ½ v.s å¼€å‘æ•ˆç‡ï¼Ÿ</strong><br><strong>A:</strong>å…¶å®å¼•å…¥è¿™ç§æ¡†æ¶ï¼ŒåŠ¿å¿…ä¼šå¯¹æ¥å£å¤„ç†æ—¶çš„å†…å­˜å ç”¨ï¼Œå¤„ç†æ€§èƒ½äº§ç”Ÿå½±å“ã€‚å› ä¸ºå†…éƒ¨å®ç°ä¸­ä¹Ÿä¸å¯é¿å…åœ°å¤§é‡ä½¿ç”¨äº†åå°„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½çš„è¯ï¼Œé‚£è¿˜æ˜¯ä¸æ¨èä½¿ç”¨äº†ã€‚å°±æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼Œå¾ˆå¤šæ¥å£çš„ QPS å¹¶ä¸é«˜ï¼ˆå°¤å…¶æ˜¯ä¸€äº›åå°æ¥å£ï¼‰ï¼Œä¸ç®¡æ˜¯ CPU è¿˜æ˜¯å†…å­˜èµ„æºéƒ½æ˜¯å……è¶³çš„ã€‚è¿™ä¸ªæ—¶å€™ä½¿ç”¨ PORTAL æ˜¯å¯ä»¥æœ‰æ•ˆæé«˜å¼€å‘æ•ˆç‡çš„ï¼ˆä¸ªäººæ„šè§ï¼‰ï¼Œæ¯•ç«Ÿå¯ä»¥å°‘å†™ä¸€äº›ä»£ç ï¼Œè®©æœºå™¨å¹²äº›è ¢æ´»è„æ´»ã€‚</p><p><strong>Q: å®é™…é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ portal çš„ï¼Ÿæœ‰ä»€ä¹ˆä½“ä¼šï¼Ÿå¸¦æ¥äº†ä»€ä¹ˆæ”¶ç›Šï¼Ÿ</strong><br><strong>A:</strong>å†ç»å°†è¿‘ä¸€ä¸ªæœˆçš„å®é™…é¡¹ç›®å®è·µï¼Œportal ç›®å‰å·²ç»è¶‹äºç¨³å®šï¼Œå¹¶ä¸”ä¿®å¤äº†å¤§é‡é—®é¢˜ï¼Œå‘å¸ƒäº† 22 ä¸ªç‰ˆæœ¬ã€‚ç›®å‰è¯¥å·¥å…·åŒ…åº”åº”ç”¨åœ¨å¤šä¸ªçº¿ä¸ŠæœåŠ¡ä¸­ï¼ˆåŒ…æ‹¬ HTTP RESTful API å’Œ RPC ä¸­ Model åˆ° thrift å®šä¹‰ç±»å‹çš„æ˜ å°„ï¼‰ï¼Œæ•´ä½“æ„Ÿå—å°±æ˜¯å¼€å‘ä½“éªŒæˆå€æé«˜ï¼Œè€Œä¸”å¸¦æ¥äº†æ€§èƒ½å½±å“å¹¶æ²¡æœ‰æœ€å¼€å§‹è®¤ä¸ºçš„é‚£ä¹ˆå¤§ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸ªäººè®¤ä¸ºï¼Œæ¡†æ¶çš„å¼•å…¥æ­£æ˜¯ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œæå‡é¡¹ç›®è´¨é‡çš„ã€‚æ¡†æ¶å±‚çš„æŠ½è±¡å’Œå°è£…å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½åœ¨ä¸šåŠ¡ä»£ç å±‚ç¼–å†™é‡å¤æœºæ¢°å¼çš„ä»£ç ï¼ŒåŒæ—¶èƒ½å¤Ÿä¿è¯ç¼–å†™æ–¹å¼çš„ä¸€è‡´æ€§ï¼Œæå‡é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚<strong>æ‰€è°“çš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿè®¸æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼›æ‰€è°“çš„æå‰ä¼˜åŒ–ï¼Œä¹Ÿè®¸åªæ˜¯è¿‡åº¦ä¼˜åŒ–ã€‚</strong>æˆ‘ä»¬åº”è¯¥ç”¨ 20% æ—¶é—´è§£å†³ 80% çš„å¸¸è§„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯é«˜æ•ˆç‡é«˜è´¨é‡çš„é‚£ç§ã€‚è€Œå‰©ä¸‹ 20% çš„éš¾é¢˜ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ«çš„æ–¹æ³•è§£å†³ã€‚åˆ‡å‹¿æœ¬æœ«å€’ç½®ï¼</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚&lt;/p&gt;
&lt;p&gt;è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="å¯¹è±¡åºåˆ—åŒ–" scheme="http://ifaceless.space/tags/%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="Web API" scheme="http://ifaceless.space/tags/Web-API/"/>
    
      <category term="portal" scheme="http://ifaceless.space/tags/portal/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡å­¦ä¹ ä¹‹ Linux è°ƒåº¦å™¨</title>
    <link href="http://ifaceless.space/2019/11/17/guide-to-linux-scheduler/"/>
    <id>http://ifaceless.space/2019/11/17/guide-to-linux-scheduler/</id>
    <published>2019-11-17T15:20:14.000Z</published>
    <updated>2019-11-28T09:55:32.191Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><em>Linux Kernel Development</em> ä¸€ä¹¦ä¸­ï¼Œå…³äº Linux çš„è¿›ç¨‹è°ƒåº¦å™¨å¹¶æ²¡æœ‰è®²è§£çš„å¾ˆæ·±å…¥ï¼Œåªæ˜¯æåˆ°äº† CFS è°ƒåº¦å™¨çš„åŸºæœ¬æ€æƒ³å’Œä¸€äº›å®ç°ç»†èŠ‚ï¼›å¹¶æ²¡æœ‰ Linux æ—©æœŸçš„è°ƒåº¦å™¨ä»‹ç»ï¼Œä»¥åŠæœ€è¿‘è¿™äº›å¹´æ–°å¢çš„åœ¨å†…æ ¸æºç æ ‘å¤–ç»´æŠ¤çš„è°ƒåº¦å™¨æ€æƒ³ã€‚æ‰€ä»¥åœ¨ç»è¿‡ä¸€ç•ªæœå¯»åï¼Œçœ‹åˆ°äº†è¿™ç¯‡è®ºæ–‡ <a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a>ï¼Œå¯¹ Linux çš„è°ƒåº¦å™¨å†å²è¿›è¡Œäº†å›é¡¾ï¼Œå¹¶ä¸”ç›¸å¯¹ç»†è‡´åœ°è®²è§£äº† CFS è°ƒåº¦å™¨ã€‚æ•´ä½“æ¥è¯´ï¼Œè™½ç„¶æ¯”è¾ƒå•°å—¦ï¼Œä½†æ˜¯å¯¹äºæƒ³è¦çŸ¥é“æ›´å¤šç»†èŠ‚çš„æˆ‘æ¥è¯´éå¸¸é€‚åˆï¼Œæ‰€ä»¥å°±æœ‰äº†ç¿»è¯‘å®ƒçš„å†²åŠ¨ã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ è¿‡ç¨‹ä¹Ÿå‚è€ƒäº†å…¶å®ƒè®ºæ–‡ã€‚ä¸‹é¢å¼€å¯å­¦ä¹ ä¹‹æ—…å§~</p><a id="more"></a><p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Linux ä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªç»“æ„ä½“ï¼ˆtask_structï¼Œå³ä»»åŠ¡æè¿°ç¬¦ï¼‰è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æ–‡ä¸­ä¼šäº¤å‰ä½¿ç”¨è¿›ç¨‹ã€çº¿ç¨‹å’Œä»»åŠ¡ç­‰æœ¯è¯­ï¼Œå¯ä»¥å°†å®ƒä»¬è§†ä½œåŒä¹‰è¯ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ç§°ä¸ºæœ€å°æ‰§è¡Œå•å…ƒã€‚ä½† Linux çš„è°ƒåº¦ç®—æ³•ï¼ˆå¦‚ CFSï¼‰å¯ä»¥åº”ç”¨æ›´åŠ é€šç”¨çš„è°ƒåº¦å•å…ƒï¼ˆå¦‚çº¿ç¨‹ã€cgroupã€ç”¨æˆ·ç­‰ï¼‰ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿‡åº¦çº ç»“è¿™é‡Œçš„æœ¯è¯­ï¼Œé‡è¦çš„æ˜¯äº†è§£æ¯ç§è°ƒåº¦ç®—æ³•çš„æ€æƒ³ï¼</em></p><h1 id="ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦"></a>ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦</h1><p>Linux æ˜¯ä¸€ä¸ªå¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿï¼Œè¿™å°±æ„å‘³ç€å®ƒå¯ä»¥ã€ŒåŒæ—¶ã€æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚åœ¨å•æ ¸å¤„ç†å™¨ä¸Šï¼Œä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰§è¡Œï¼ˆå¹¶å‘ï¼‰ï¼›è€Œåœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œåˆ™å…è®¸ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œã€‚ç„¶è€Œï¼Œä¸ç®¡æ˜¯ä½•ç§ç¡¬ä»¶ç±»å‹çš„æœºå™¨ä¸Šï¼Œå¯èƒ½åŒæ—¶è¿˜æœ‰å¾ˆå¤šåœ¨å†…å­˜ä¸­æ— æ³•å¾—åˆ°æ‰§è¡Œçš„è¿›ç¨‹ï¼Œå®ƒä»¬æ­£åœ¨ç­‰å¾…è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨ç¡çœ ã€‚è´Ÿè´£å°† CPU æ—¶é—´åˆ†é…ç»™è¿›ç¨‹çš„å†…æ ¸ç»„ä»¶å°±æ˜¯ã€Œè¿›ç¨‹è°ƒåº¦å™¨ã€ã€‚</p><p>è°ƒåº¦å™¨è´Ÿè´£ç»´æŠ¤è¿›ç¨‹è°ƒåº¦é¡ºåºï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¦‚åŒå¤šæ•°å…¶å®ƒçš„ç°ä»£æ“ä½œç³»ç»Ÿï¼ŒLinux å®ç°äº†<strong>æŠ¢å å¼</strong>å¤šä»»åŠ¡æœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒåº¦å™¨å¯ä»¥éšæ—¶å†³å®šä»»æ„è¿›ç¨‹åœæ­¢è¿è¡Œï¼Œè€Œè®©å…¶å®ƒè¿›ç¨‹è·å¾— CPU èµ„æºã€‚è¿™ç§è¿èƒŒæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ„æ„¿ï¼Œåœæ­¢å…¶è¿è¡Œçš„è¡Œä¸ºå°±æ˜¯æ‰€è°“çš„ã€ŒæŠ¢å ã€ã€‚æŠ¢å é€šå¸¸å¯ä»¥åœ¨å®šæ—¶å™¨ä¸­æ–­æ—¶å‘ç”Ÿï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢ä»»åŠ¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šå®Œæˆè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¯ä¸ªè¿›ç¨‹æ‰€è·å¾—çš„è¿è¡Œæ—¶é—´å«åš<strong>è¿›ç¨‹çš„æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰</strong>ã€‚</p><p>ä»»åŠ¡é€šå¸¸å¯ä»¥åŒºåˆ†ä¸º<strong>äº¤äº’å¼ï¼ˆI/O å¯†é›†å‹ï¼‰</strong>å’Œ<strong>éäº¤äº’å¼ï¼ˆCPU å¯†é›†å‹ï¼‰</strong>ä»»åŠ¡ã€‚äº¤äº’å¼ä»»åŠ¡é€šå¸¸ä¼šé‡åº¦ä¾èµ– I/O æ“ä½œï¼ˆå¦‚ GUI åº”ç”¨ï¼‰ï¼Œå¹¶ä¸”é€šå¸¸ç”¨ä¸å®Œåˆ†é…ç»™å®ƒçš„æ—¶é—´ç‰‡ã€‚è€Œéäº¤äº’å¼ä»»åŠ¡ï¼ˆå¦‚æ•°å­¦è¿ç®—ï¼‰åˆ™éœ€è¦ä½¿ç”¨æ›´å¤šçš„ CPU èµ„æºã€‚å®ƒä»¬é€šå¸¸ä¼šç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡ä¹‹åè¢«æŠ¢å ï¼Œå¹¶ä¸ä¼šè¢« I/O è¯·æ±‚é¢‘ç¹é˜»å¡ã€‚</p><p>å½“ç„¶ï¼Œç°å®ä¸­çš„åº”ç”¨ç¨‹åºå¯èƒ½åŒæ—¶åŒ…å«ä¸Šè¿°ä¸¤ç§åˆ†ç±»ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ‹¼å†™æ£€æŸ¥æ—¶ä¹Ÿä¼šéœ€è¦å ç”¨å¤§é‡ CPU èµ„æºã€‚</p><p><strong>æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥å°±éœ€è¦å‡è¡¡è¿™ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¿è¯æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¾—åˆ°è¶³å¤Ÿçš„æ‰§è¡Œèµ„æºï¼Œè€Œä¸ä¼šå¯¹å…¶å®ƒä»»åŠ¡äº§ç”Ÿæ˜æ˜¾çš„æ€§èƒ½å½±å“ã€‚</strong> Linux ä¸ºäº†ä¿è¯ CPU åˆ©ç”¨ç‡æœ€å¤§åŒ–ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ›´å¿«çš„å“åº”æ—¶é—´ï¼Œå€¾å‘äºä¸ºéäº¤äº’å¼ä»»åŠ¡åˆ†é…æ›´å¤§çš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯ä»¥è¾ƒä½çš„é¢‘ç‡è¿è¡Œå®ƒä»¬ï¼›è€Œé’ˆå¯¹ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œåˆ™ä¼šåœ¨è¾ƒçŸ­å‘¨æœŸå†…é¢‘ç¹åœ°æ‰§è¡Œã€‚</p><h1 id="è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦"><a href="#è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦" class="headerlink" title="è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦"></a>è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦</h1><p>è¿›ç¨‹æè¿°ç¬¦ï¼ˆtask_structï¼‰ä¸­çš„å¾ˆå¤šå­—æ®µä¼šè¢«è°ƒåº¦æœºåˆ¶ç›´æ¥ä½¿ç”¨ã€‚ä»¥ä¸‹ä»…åˆ—å‡ºä¸€äº›æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶åœ¨åæ–‡è¯¦ç»†è®¨è®ºã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> <span class="title">rt</span>;</span></span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> policy;</span><br><span class="line">    <span class="keyword">cpumask_t</span> cpus_allowed;</span><br><span class="line">    â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…³äºè¿™äº›å­—æ®µçš„è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>prio</code> è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿›ç¨‹è¿è¡Œæ—¶é—´ï¼ŒæŠ¢å é¢‘ç‡éƒ½ä¾èµ–äºè¿™äº›å€¼ã€‚<code>rt_priority</code> åˆ™ç”¨äºå®æ—¶ï¼ˆreal-timeï¼‰ä»»åŠ¡ï¼›</li><li><code>sched_class</code> è¡¨ç¤ºè¿›ç¨‹ä½äºå“ªä¸ªè°ƒåº¦ç±»ï¼›</li><li><code>sched_entity</code> çš„æ„ä¹‰æ¯”è¾ƒç‰¹æ®Šã€‚é€šå¸¸æŠŠä¸€ä¸ªçº¿ç¨‹ï¼ˆLinux ä¸­çš„è¿›ç¨‹ã€ä»»åŠ¡åŒä¹‰è¯ï¼‰å«ä½œæœ€å°è°ƒåº¦å•å…ƒã€‚ä½†æ˜¯ Linux è°ƒåº¦å™¨ä¸ä»…ä»…åªèƒ½å¤Ÿè°ƒåº¦å•ä¸ªä»»åŠ¡ï¼Œ<strong>è€Œä¸”è¿˜å¯ä»¥å°†ä¸€ç»„è¿›ç¨‹ï¼Œç”šè‡³å±äºæŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹ä½œä¸ºæ•´ä½“è¿›è¡Œè°ƒåº¦</strong>ã€‚è¿™å°±å…è®¸æˆ‘ä»¬å®ç°ç»„è°ƒåº¦ï¼Œä»è€Œå°† CPU æ—¶é—´å…ˆåˆ†é…åˆ°è¿›ç¨‹ç»„ï¼Œå†åœ¨ç»„å†…åˆ†é…åˆ°å•ä¸ªçº¿ç¨‹ã€‚å½“å¼•å…¥è¿™é¡¹åŠŸèƒ½åï¼Œå¯ä»¥å¤§å¹…åº¦æå‡æ¡Œé¢ç³»ç»Ÿçš„äº¤äº’æ€§ã€‚æ¯”å¦‚ï¼Œå¯ä»¥å°†ç¼–è¯‘ä»»åŠ¡èšé›†æˆä¸€ä¸ªç»„ï¼Œç„¶åè¿›è¡Œè°ƒåº¦ï¼Œä»è€Œä¸ä¼šå¯¹äº¤äº’æ€§äº§ç”Ÿæ˜æ˜¾çš„å½±å“ã€‚è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸‹ï¼Œ**Linux è°ƒåº¦å™¨ä¸ä»…ä»…èƒ½ç›´æ¥è°ƒåº¦è¿›ç¨‹ï¼Œä¹Ÿèƒ½å¯¹è°ƒåº¦å•å…ƒï¼ˆschedulable entitiesï¼‰è¿›è¡Œè°ƒåº¦ã€‚è¿™æ ·çš„è°ƒåº¦å•å…ƒæ­£æ˜¯ç”¨ <code>struct sched_entity</code> æ¥è¡¨ç¤ºçš„ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå®ƒå¹¶éä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥åµŒå¥—åœ¨è¿›ç¨‹æè¿°ç¬¦ä¸­çš„ã€‚å½“ç„¶ï¼Œåé¢çš„è°ˆè®ºå°†èšç„¦åœ¨å•è¿›ç¨‹è°ƒåº¦è¿™ç§ç®€å•åœºæ™¯ã€‚ç”±äºè°ƒåº¦å™¨æ˜¯é¢å‘è°ƒåº¦å•å…ƒè®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒä¼šå°†å•ä¸ªè¿›ç¨‹ä¹Ÿè§†ä¸ºè°ƒåº¦å•å…ƒï¼Œå› æ­¤ä¼šä½¿ç”¨ <code>sched_entity</code> ç»“æ„ä½“æ“ä½œå®ƒä»¬ã€‚<code>sched_rt_entity</code> åˆ™æ˜¯å®æ—¶è°ƒåº¦æ—¶ä½¿ç”¨çš„ã€‚</li><li><code>policy</code> è¡¨æ˜ä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼šé€šå¸¸æ„å‘³ç€é’ˆå¯¹æŸäº›ç‰¹å®šçš„è¿›ç¨‹ç»„ï¼ˆå¦‚éœ€è¦æ›´é•¿æ—¶é—´ç‰‡ï¼Œæ›´é«˜ä¼˜å…ˆçº§ç­‰ï¼‰åº”ç”¨ç‰¹æ®Šçš„è°ƒåº¦å†³ç­–ã€‚Linux å†…æ ¸ç›®å‰æ”¯æŒçš„è°ƒåº¦ç­–ç•¥å¦‚ä¸‹ï¼š<ul><li><code>SCHED_NORMAL</code>ï¼šæ™®é€šä»»åŠ¡ä½¿ç”¨çš„è°ƒåº¦ç­–ç•¥ï¼›</li><li><code>SCHED_BATCH</code>ï¼šä¸åƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œå¯å…è®¸ä»»åŠ¡è¿è¡Œå°½å¯èƒ½é•¿çš„æ—¶é—´ï¼Œä»è€Œæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ï¼Œä½†æ˜¯ä»£ä»·è‡ªç„¶æ˜¯æŸå¤±äº¤äº’æ€§èƒ½ã€‚è¿™ç§éå¸¸é€‚åˆæ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼ˆæ‰¹é‡çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼‰;</li><li><code>SCHED_IDLE</code>ï¼šå®ƒè¦æ¯” nice 19 çš„ä»»åŠ¡ä¼˜å…ˆçº§è¿˜è¦ä½ï¼Œä½†å®ƒå¹¶éçœŸçš„ç©ºé—²ä»»åŠ¡;</li><li><code>SCHED_FIFO</code> å’Œ <code>SCHED_RR</code> æ˜¯è½¯å®æ—¶è¿›ç¨‹è°ƒåº¦ç­–ç•¥ã€‚å®ƒä»¬æ˜¯ç”± POSIX æ ‡å‡†å®šä¹‰çš„ï¼Œç”± <code>&lt;kernel/sched/rt.c&gt;</code> é‡Œé¢å®šä¹‰çš„å®æ—¶è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ã€‚RR å®ç°çš„æ˜¯å¸¦æœ‰å›ºå®šæ—¶é—´ç‰‡çš„è½®è½¬è°ƒåº¦æ–¹å¼ï¼›SCHED_FIFO åˆ™ä½¿ç”¨çš„æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æœºåˆ¶ã€‚</li></ul></li><li><code>cpus_allowed</code>ï¼šç”¨æ¥è¡¨ç¤ºä»»åŠ¡çš„ CPU äº²å’Œæ€§ã€‚ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡ <code>sched_setaffinity</code> ç³»ç»Ÿè°ƒç”¨æ¥è®¾ç½®ã€‚</li></ul><h1 id="ä¼˜å…ˆçº§-Priority"><a href="#ä¼˜å…ˆçº§-Priority" class="headerlink" title="ä¼˜å…ˆçº§ Priority"></a>ä¼˜å…ˆçº§ Priority</h1><h2 id="è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="è¿›ç¨‹ä¼˜å…ˆçº§"></a>è¿›ç¨‹ä¼˜å…ˆçº§</h2><h3 id="æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§"><a href="#æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§" class="headerlink" title="æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§"></a>æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§</h3><p>æ‰€æœ‰çš„ç±» Unix æ“ä½œç³»ç»Ÿéƒ½å®ç°äº†ä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªå€¼ï¼Œç„¶åé€šè¿‡è¯¥å€¼å†³å®šä»»åŠ¡çš„é‡è¦ç¨‹åº¦ã€‚å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸€è‡´ï¼Œåˆ™ä¸€æ¬¡é‡å¤è¿è¡Œå®ƒä»¬ã€‚åœ¨ Linux ä¸­ï¼Œæ¯ä¸€ä¸ªæ™®é€šä»»åŠ¡éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ª nice å€¼ï¼Œå®ƒçš„èŒƒå›´æ˜¯ -20 åˆ° +19ï¼Œä»»åŠ¡é»˜è®¤ nice å€¼æ˜¯ 0ã€‚<br><img src="https://pic1.zhimg.com/v2-665ed41d133e9e332c4fdc6034240cb5.jpg" alt=""></p><p>nice å€¼è¶Šé«˜ï¼Œä»»åŠ¡ä¼˜å…ˆçº§è¶Šä½ï¼ˆitâ€™s nice to othersï¼‰ã€‚Linux ä¸­å¯ä»¥ä½¿ç”¨ <code>nice(int increment)</code> ç³»ç»Ÿè°ƒç”¨æ¥ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°ä½äº <code>&lt;kernel/shced/core.c&gt;</code> ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åªèƒ½ä¸ºè¯¥ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹å¢åŠ  nice å€¼ï¼ˆå³é™ä½ä¼˜å…ˆçº§ï¼‰ã€‚å¦‚æœéœ€è¦å¢åŠ ä¼˜å…ˆçº§ï¼ˆå‡å°‘ nice å€¼ï¼‰ï¼Œæˆ–è€…ä¿®æ”¹å…¶å®ƒç”¨æˆ·è¿›ç¨‹ä¼˜å…ˆçº§ï¼Œåˆ™å¿…é¡»ä»¥ root èº«ä»½æ“ä½œã€‚</p><h3 id="å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§"><a href="#å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§" class="headerlink" title="å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§"></a>å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§</h3><p>åœ¨ Linux ä¸­ï¼Œé™¤äº†æ™®é€šä»»åŠ¡å¤–ï¼Œè¿˜æœ‰ä¸€ç±»ä»»åŠ¡å±äºå®æ—¶ä»»åŠ¡ã€‚å®æ—¶ä»»åŠ¡æ˜¯ç¡®ä¿å®ƒä»¬èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæœ‰ä¸¤ç±»å®æ—¶ä»»åŠ¡ï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š</p><ul><li><strong>ç¡¬å®æ—¶ä»»åŠ¡</strong>ï¼šä¼šæœ‰ä¸¥æ ¼çš„æ—¶é—´é™åˆ¶ï¼Œä»»åŠ¡å¿…é¡»åœ¨æ—¶é™å†…å®Œæˆã€‚æ¯”å¦‚ç›´å‡æœºçš„é£æ§ç³»ç»Ÿï¼Œå°±éœ€è¦åŠæ—¶å“åº”é©¾é©¶å‘˜çš„æ“æ§ï¼Œå¹¶åšå‡ºé¢„æœŸçš„åŠ¨ä½œã€‚ç„¶è€Œï¼ŒLinux æœ¬èº«å¹¶ä¸æ”¯æŒç¡¬å®æ—¶ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰ä¸€äº›åŸºäºå®ƒä¿®æ”¹çš„ç‰ˆæœ¬ï¼Œå¦‚ RTLinuxï¼ˆå®ƒä»¬é€šå¸¸è¢«ç§°ä¸º RTOSï¼‰åˆ™æ˜¯æ”¯æŒç¡¬å®æ—¶è°ƒåº¦çš„ã€‚</li><li><strong>è½¯å®æ—¶ä»»åŠ¡</strong>ï¼šè½¯å®æ—¶ä»»åŠ¡å…¶å®ä¹Ÿä¼šæœ‰æ—¶é—´é™åˆ¶ï¼Œä½†ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»åŠ¡æ™šä¸€ç‚¹è¿è¡Œä»»åŠ¡ï¼Œå¹¶ä¸ä¼šé€ æˆä¸å¯æŒ½å›çš„ç¾éš¾æ€§äº‹æ•…ã€‚å®è·µä¸­ï¼Œè½¯å®æ—¶ä»»åŠ¡ä¼šæä¾›ä¸€å®šçš„æ—¶é—´é™åˆ¶ä¿éšœï¼Œä½†æ˜¯ä¸è¦è¿‡åº¦ä¾èµ–è¿™ç§ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼ŒVOIP è½¯ä»¶ä¼šä½¿ç”¨è½¯å®æ—¶ä¿éšœçš„åè®®ä¼ æ¥é€éŸ³è§†é¢‘ä¿¡å·ï¼Œä½†æ˜¯å³ä¾¿å› ä¸ºæ“ä½œç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œè€Œäº§ç”Ÿä¸€ç‚¹å»¶è¿Ÿï¼Œä¹Ÿä¸ä¼šé€ æˆå¾ˆå¤§å½±å“ã€‚<strong>æ— è®ºå¦‚ä½•ï¼Œè½¯å®æ—¶ä»»åŠ¡æ€»ä¼šæ¯”æ™®é€šä»»åŠ¡çš„ä¼˜å…ˆçº§æ›´é«˜</strong>ã€‚</li></ul><p>Linux ä¸­å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§èŒƒå›´æ˜¯ 0~99ï¼Œä½†æ˜¯æœ‰è¶£çš„æ˜¯ï¼Œå®ƒå’Œ nice å€¼çš„ä½œç”¨åˆšå¥½ç›¸åï¼Œè¿™é‡Œçš„ä¼˜å…ˆçº§å€¼è¶Šå¤§ï¼Œå°±æ„å‘³ç€ä¼˜å…ˆçº§è¶Šé«˜ã€‚<br><img src="https://pic4.zhimg.com/v2-d5299a6846bcb492ec3340f1a725b323.jpg" alt=""></p><p>ç±»ä¼¼å…¶å®ƒçš„ Unix ç³»ç»Ÿï¼ŒLinux ä¹Ÿæ˜¯åŸºäº POSIX 1b æ ‡å‡†å®šä¹‰çš„ ã€ŒReal-time Extensionsã€å®ç°å®æ—¶ä¼˜å…ˆçº§ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å®æ—¶ä»»åŠ¡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ps -eo pid, rtprio, cmd</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯é€šè¿‡ <code>chrt -p pid</code> æŸ¥çœ‹å•ä¸ªè¿›ç¨‹çš„è¯¦æƒ…ã€‚Linux ä¸­å¯ä»¥é€šè¿‡ <code>chrt -p prio pid</code> æ›´æ”¹å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ“ä½œçš„æ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼ˆé€šå¸¸å¹¶ä¸ä¼šå°†æ™®é€šç”¨æˆ·çš„è¿›ç¨‹è®¾ç½®ä¸ºå®æ—¶çš„ï¼‰ï¼Œåˆ™å¿…é¡»æœ‰ root æƒé™æ‰å¯ä»¥ä¿®æ”¹å®æ—¶ä¼˜å…ˆçº§ã€‚</p><h2 id="å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§"></a>å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§</h2><p>å®æ—¶ä¸Šï¼Œå†…æ ¸çœ‹åˆ°çš„ä»»åŠ¡ä¼˜å…ˆçº§å’Œç”¨æˆ·çœ‹åˆ°çš„å¹¶ä¸ç›¸åŒï¼Œåœ¨è®¡ç®—å’Œç®¡ç†ä¼˜å…ˆçº§æ—¶ä¹Ÿéœ€è¦è€ƒè™‘å¾ˆå¤šæ–¹é¢ã€‚Linux å†…æ ¸ä¸­ä½¿ç”¨ 0~139 è¡¨ç¤ºä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”ï¼Œ<strong>å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong>ï¼ˆæ³¨æ„å’Œç”¨æˆ·ç©ºé—´çš„åŒºåˆ«ï¼‰ã€‚å…¶ä¸­ 0~99 ä¿ç•™ç»™å®æ—¶è¿›ç¨‹ï¼Œ100~139ï¼ˆæ˜ å°„æˆ nice å€¼å°±æ˜¯ -20~19ï¼‰ä¿ç•™ç»™æ™®é€šè¿›ç¨‹ã€‚<br><img src="https://pic2.zhimg.com/v2-4d4d4645d2dc1a52bbea516e8d82171b.jpg" alt=""></p><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>&lt;include/linux/sched/prio.h&gt;</code> å¤´æ–‡ä»¶ä¸­çœ‹åˆ°å†…æ ¸è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§çš„å•ä½ï¼ˆscaleï¼‰å’Œå®å®šä¹‰ï¼ˆmacrosï¼‰ï¼Œå®ƒä»¬ç”¨æ¥å°†ç”¨æˆ·ç©ºé—´ä¼˜å…ˆçº§æ˜ å°„åˆ°åˆ°å†…æ ¸ç©ºé—´ã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_NICE 19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_NICE -20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_WIDTH (MAX_NICE - MIN_NICE + 1)</span></span><br><span class="line">â€¦</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_RT_PRIO 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_RT_PRIO MAX_USER_RT_PRIO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PRIO (MAX_RT_PRIO + NICE_WIDTH)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_PRIO (MAX_RT_PRIO + NICE_WIDTH / 2)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Convert user-nice values [ -20 ... 0 ... 19 ]</span></span><br><span class="line"><span class="comment">* to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],</span></span><br><span class="line"><span class="comment">* and back.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_TO_PRIO(nice) ((nice) + DEFAULT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIO_TO_NICE(prio) ((prio) - DEFAULT_PRIO)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 'User priority' is the nice value converted to something we</span></span><br><span class="line"><span class="comment">* can work with better when scaling various scheduler parameters,</span></span><br><span class="line"><span class="comment">* it's a [ 0 ... 39 ] range.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_PRIO(p) ((p)-MAX_RT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_USER_PRIO(p) USER_PRIO((p)-&gt;static_prio)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_PRIO (USER_PRIO(MAX_PRIO))</span></span><br></pre></td></tr></table></figure></p><h2 id="ä¼˜å…ˆçº§è®¡ç®—"><a href="#ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="ä¼˜å…ˆçº§è®¡ç®—"></a>ä¼˜å…ˆçº§è®¡ç®—</h2><p>åœ¨ <code>task_struct</code> ä¸­æœ‰å‡ ä¸ªå­—æ®µç”¨æ¥è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br></pre></td></tr></table></figure></p><p><code>static_prio</code> æ˜¯ç”±ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾å®šçš„ã€Œé™æ€ã€ä¼˜å…ˆçº§æ˜ å°„æˆå†…æ ¸è¡¨ç¤ºçš„ä¼˜å…ˆçº§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;static_prio = NICE_TO_PRIO(nice_value);</span><br></pre></td></tr></table></figure></p><p><code>normal_prio</code> å­˜æ”¾çš„æ˜¯åŸºäº <code>static_prio</code> å’Œè¿›ç¨‹è°ƒåº¦ç­–ç•¥ï¼ˆå®æ—¶æˆ–æ™®é€šï¼‰å†³å®šçš„ä¼˜å…ˆçº§ï¼Œç›¸åŒçš„é™æ€ä¼˜å…ˆçº§ï¼Œåœ¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥ä¸‹ï¼Œå¾—åˆ°çš„æ­£å¸¸ä¼˜å…ˆçº§æ˜¯ä¸åŒçš„ã€‚å­è¿›ç¨‹åœ¨ fork æ—¶ï¼Œä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ <code>normal_prio</code>ã€‚</p><p><code>prio</code> åˆ™æ˜¯ã€ŒåŠ¨æ€ä¼˜å…ˆçº§ã€ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ä¼˜å…ˆçº§ä¼šå‘ç”Ÿå˜åŠ¨ã€‚ä¸€ç§åœºæ™¯å°±æ˜¯ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡ç»™æŸä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡ä¸€æ®µæ—¶é—´ï¼Œä»è€ŒæŠ¢å å…¶å®ƒé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¸€æ—¦ <code>static_prio</code> ç¡®å®šï¼Œ<code>prio</code> å­—æ®µå°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¡ç®—ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;prio = effective_prio(p);</span><br><span class="line"><span class="comment">// kernel/sched/core.c ä¸­å®šä¹‰äº†è®¡ç®—æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">effective_prio</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p-&gt;normal_prio = normal_prio(p);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If we are RT tasks or we were boosted to RT priority,</span></span><br><span class="line"><span class="comment">    * keep the priority unchanged. Otherwise, update priority</span></span><br><span class="line"><span class="comment">    * to the normal priority:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!rt_prio(p-&gt;prio))</span><br><span class="line">        <span class="keyword">return</span> p-&gt;normal_prio;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;prio;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">normal_prio</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> prio;</span><br><span class="line">    <span class="keyword">if</span> (task_has_dl_policy(p))</span><br><span class="line">        prio = MAX_DL_PRIO<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (task_has_rt_policy(p))</span><br><span class="line">        prio = MAX_RT_PRIO<span class="number">-1</span> - p-&gt;rt_priority;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        prio = __normal_prio(p);</span><br><span class="line">    <span class="keyword">return</span> prio;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> __normal_prio(struct task_struct *p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;static_prio;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="è´Ÿè½½æƒé‡ï¼ˆLoad-Weightsï¼‰"><a href="#è´Ÿè½½æƒé‡ï¼ˆLoad-Weightsï¼‰" class="headerlink" title="è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰"></a>è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰</h2><p>ä¼˜å…ˆçº§ä¼šè®©ä¸€äº›ä»»åŠ¡æ¯”åˆ«çš„ä»»åŠ¡æ›´é‡è¦ï¼Œå› æ­¤ä¹Ÿä¼šè·å¾—æ›´å¤šçš„ CPU ä½¿ç”¨æ—¶é—´ã€‚nice å€¼å’Œæ—¶é—´ç‰‡çš„æ¯”ä¾‹å…³ç³»æ˜¯é€šè¿‡è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰è¿›è¡Œç»´æŠ¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>task_struct-&gt;se.load</code> ä¸­çœ‹åˆ°è¿›ç¨‹çš„æƒé‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span> <span class="comment">/* for load-balancing */</span></span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> weight;</span><br><span class="line">    u32 inv_weight;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†è®© nice å€¼çš„å˜åŒ–åæ˜ åˆ° CPU æ—¶é—´å˜åŒ–ç‰‡ä¸Šæ›´åŠ åˆç†ï¼ŒLinux å†…æ ¸ä¸­å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºæ˜ å°„ nice å€¼åˆ°æƒé‡ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> prio_to_weight[<span class="number">40</span>] = &#123;</span><br><span class="line">    <span class="comment">/* -20 */</span> <span class="number">88761</span>, <span class="number">71755</span>, <span class="number">56483</span>, <span class="number">46273</span>, <span class="number">36291</span>,</span><br><span class="line">    <span class="comment">/* -15 */</span> <span class="number">29154</span>, <span class="number">23254</span>, <span class="number">18705</span>, <span class="number">14949</span>, <span class="number">11916</span>,</span><br><span class="line">    <span class="comment">/* -10 */</span> <span class="number">9548</span>, <span class="number">7620</span>, <span class="number">6100</span>, <span class="number">4904</span>, <span class="number">3906</span>,</span><br><span class="line">    <span class="comment">/* -5 */</span> <span class="number">3121</span>, <span class="number">2501</span>, <span class="number">1991</span>, <span class="number">1586</span>, <span class="number">1277</span>,</span><br><span class="line">    <span class="comment">/* 0 */</span> <span class="number">1024</span>, <span class="number">820</span>, <span class="number">655</span>, <span class="number">526</span>, <span class="number">423</span>,</span><br><span class="line">    <span class="comment">/* 5 */</span> <span class="number">335</span>, <span class="number">272</span>, <span class="number">215</span>, <span class="number">172</span>, <span class="number">137</span>,</span><br><span class="line">    <span class="comment">/* 10 */</span> <span class="number">110</span>, <span class="number">87</span>, <span class="number">70</span>, <span class="number">56</span>, <span class="number">45</span>,</span><br><span class="line">    <span class="comment">/* 15 */</span> <span class="number">36</span>, <span class="number">29</span>, <span class="number">23</span>, <span class="number">18</span>, <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ä¸Šé¢çš„æ˜ å°„è¡¨ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªä¼˜å…ˆçº§éƒ½æ˜¯ 0 çš„ä»»åŠ¡ï¼Œæ¯ä¸ªéƒ½èƒ½è·å¾— 50% çš„ CPU æ—¶é—´ï¼ˆ1024 / (1024 + 1024) = 0.5ï¼‰ã€‚å¦‚æœçªç„¶ç»™å…¶ä¸­çš„ä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡äº† 1 ï¼ˆnice å€¼ -1ï¼‰ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªä»»åŠ¡åº”è¯¥ä¼šè·å¾—é¢å¤– 10% å·¦å³çš„ CPU æ—¶é—´ï¼Œè€Œå¦ä¸€ä¸ªåˆ™ä¼šå‡å°‘ 10% CPU æ—¶é—´ã€‚æ¥çœ‹çœ‹è®¡ç®—ç»“æœï¼š1277 / (1024 + 1277) â‰ˆ 0.55ï¼Œ1024 / (1024 + 1277) â‰ˆ 0.45ï¼ŒäºŒè€…å·®è·åˆšå¥½åœ¨ 10% å·¦å³ï¼Œç¬¦åˆé¢„æœŸã€‚å®Œæ•´çš„è®¡ç®—å‡½æ•°å®šä¹‰åœ¨ <code>&lt;kernel/sched/core.c&gt;</code> ä¸­ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set_load_weight</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> prio = p-&gt;static_prio - MAX_RT_PRIO;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> *<span class="title">load</span> = &amp;<span class="title">p</span>-&gt;<span class="title">se</span>.<span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * SCHED_IDLE tasks get minimal weight:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;policy == SCHED_IDLE) &#123;</span><br><span class="line">        load-&gt;weight = scale_load(WEIGHT_IDLEPRIO);</span><br><span class="line">        load-&gt;inv_weight = WMULT_IDLEPRIO;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    load-&gt;weight = scale_load(prio_to_weight[prio]);</span><br><span class="line">    load-&gt;inv_weight = prio_to_wmult[prio];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="è°ƒåº¦ç±»-Scheduling-Classes"><a href="#è°ƒåº¦ç±»-Scheduling-Classes" class="headerlink" title="è°ƒåº¦ç±» Scheduling Classes"></a>è°ƒåº¦ç±» Scheduling Classes</h1><p>è™½è¯´ Linux å†…æ ¸ä½¿ç”¨çš„ C è¯­è¨€å¹¶éæ‰€è°“çš„ OOP è¯­è¨€ï¼ˆæ²¡æœ‰ç±»ä¼¼ C++/Java ä¸­çš„ class æ¦‚å¿µï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ä»£ç ä¸­çœ‹åˆ°ä¸€äº›ä½¿ç”¨ C è¯­è¨€ç»“æ„ä½“ + å‡½æ•°æŒ‡é’ˆï¼ˆHooksï¼‰çš„æ–¹å¼æ¥æ¨¡æ‹Ÿé¢å‘å¯¹è±¡çš„æ–¹å¼ï¼ŒæŠ½è±¡è¡Œä¸ºå’Œæ•°æ®ã€‚è°ƒåº¦ç±»ä¹Ÿæ˜¯è¿™æ ·å®ç°çš„ï¼ˆæ­¤å¤–ï¼Œè¿˜æœ‰ <code>inode_operations</code>, <code>super_block_operations</code> ç­‰ï¼‰ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;kernel/shced/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆå¦‚ SMP ç›¸å…³çš„ï¼‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> &#123;</span></span><br><span class="line">    <span class="comment">// å¤šä¸ª sched_class æ˜¯é“¾æ¥åœ¨ä¸€èµ·çš„</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†è°ƒåº¦å•å…ƒï¼ˆå¦‚ä¸€ä¸ªä»»åŠ¡ï¼‰æ”¾åˆ°</span></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶é€’å¢ `nr_running` å˜é‡ï¼ˆè¯¥å˜é‡è¡¨ç¤ºè¿è¡Œé˜Ÿåˆ—ä¸­å¯è¿è¡Œçš„ä»»åŠ¡æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">void</span> (*enqueue_task) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¸å¯è¿è¡Œæ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†ä»»åŠ¡ç§»å‡ºé˜Ÿåˆ—ï¼ŒåŒæ—¶é€’å‡ `nr_running`</span></span><br><span class="line">    <span class="keyword">void</span> (*dequeue_task) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook å¯ä»¥åœ¨ä»»åŠ¡éœ€è¦ä¸»åŠ¨æ”¾å¼ƒ CPU æ—¶è°ƒç”¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸ä¼šæ”¹å˜</span></span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„å¯è¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ä¾ç„¶ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ã€‚ç±»ä¼¼äºå…ˆ dequeue_taskï¼Œ</span></span><br><span class="line">    <span class="comment">// å† enqueue_task</span></span><br><span class="line">    <span class="keyword">void</span> (*yield_task) (struct rq *rq);</span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨å¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> (*check_preempt_curr) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook ç”¨æ¥é€‰æ‹©æœ€é€‚åˆè¿è¡Œçš„ä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * (*<span class="title">pick_next_task</span>) (<span class="title">struct</span> <span class="title">rq</span> *<span class="title">rq</span>, <span class="title">struct</span> <span class="title">task_struct</span> *<span class="title">prev</span>);</span></span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¿®æ”¹è‡ªèº«çš„è°ƒåº¦ç±»æˆ–è€…ä»»åŠ¡ç»„æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> (*set_curr_task) (struct rq *rq);</span><br><span class="line">    <span class="comment">// é€šå¸¸æ˜¯åœ¨æ—¶é’Ÿä¸­æ–­æ—¶è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»»åŠ¡åˆ‡æ¢</span></span><br><span class="line">    <span class="keyword">void</span> (*task_tick) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> queued);</span><br><span class="line">    <span class="comment">// å½“ä»»åŠ¡è¢« fork æ—¶é€šçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">void</span> (*task_fork) (struct task_struct *p);</span><br><span class="line">    <span class="comment">// å½“ä»»åŠ¡æŒ‚æ‰æ—¶é€šçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">void</span> (*task_dead) (struct task_struct *p);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…³äºè°ƒåº¦ç­–ç•¥çš„å…·ä½“ç»†èŠ‚çš„å®ç°æœ‰å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p><ul><li><code>core.c</code> åŒ…å«è°ƒåº¦å™¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼›</li><li><code>fair.c</code> å®ç°äº† CFSï¼ˆComple Faire Schedulerï¼Œå®Œå…¨å…¬å¹³ä»»åŠ¡è°ƒåº¦å™¨ï¼‰ è°ƒåº¦å™¨ï¼Œåº”ç”¨äºæ™®é€šä»»åŠ¡ï¼›</li><li><code>rt.c</code> å®ç°äº†å®æ—¶è°ƒåº¦ï¼Œåº”ç”¨äºå®æ—¶ä»»åŠ¡ï¼›</li><li><code>idle_task.c</code> å½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œçš„ä»»åŠ¡æ—¶ï¼Œä¼šè¿è¡Œç©ºé—²ä»»åŠ¡ã€‚<br>å†…æ ¸æ˜¯åŸºäºä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼ˆSCHED_*ï¼‰æ¥å†³å®šä½¿ç”¨ä½•ç§è°ƒåº¦ç±»å®ç°ï¼Œå¹¶ä¼šè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚<code>SCHED_NORMAL</code>, <code>SCHED_BATCH</code> å’Œ <code>SCHED_IDLE</code> è¿›ç¨‹ä¼šæ˜ å°„åˆ° <code>fair_sched_class</code> ï¼ˆç”± CFS å®ç°ï¼‰ï¼›<code>SCHED_RR</code> å’Œ <code>SCHED_FIFO</code> åˆ™æ˜ å°„çš„ <code>rt_sched_class</code> ï¼ˆå®æ—¶è°ƒåº¦å™¨ï¼‰ã€‚</li></ul><h1 id="è¿è¡Œé˜Ÿåˆ—-Run-Queue"><a href="#è¿è¡Œé˜Ÿåˆ—-Run-Queue" class="headerlink" title="è¿è¡Œé˜Ÿåˆ— Run Queue"></a>è¿è¡Œé˜Ÿåˆ— Run Queue</h1><p>æ‰€æœ‰å¯è¿è¡Œçš„ä»»åŠ¡æ˜¯æ”¾åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­çš„ï¼Œå¹¶ä¸”ç­‰å¾… CPU è¿è¡Œã€‚æ¯ä¸ª CPU æ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„è¿è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡ä»»æ„æ—¶åˆ»åªèƒ½å¤„äºå…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åœ¨å¤šå¤„ç†å™¨æœºå™¨ä¸­ï¼Œä¼šæœ‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»»åŠ¡å°±ä¼šè½¬ç§»åˆ°å…¶å®ƒ CPU ä¸Šè¿è¡Œçš„å¯èƒ½ã€‚</p><p>è¿è¡Œé˜Ÿåˆ—æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;kernel/sched/sched.h&gt;</code>ï¼‰:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆSMP ç›¸å…³ï¼‰</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ˜¯æ¯ä¸ª CPU éƒ½ä¼šæœ‰çš„ä¸€ä¸ªä»»åŠ¡è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰é˜Ÿåˆ—ä¸­æ€»å…±æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆåŒ…å«æ‰€æœ‰çš„ sched classï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_running;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_LOAD_IDX_MAX 5</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cpu_load[CPU_LOAD_IDX_MAX];</span><br><span class="line">    <span class="comment">// è¿è¡Œé˜Ÿåˆ—è´Ÿè½½è®°å½•</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">// åµŒå¥—çš„ CFS è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span> <span class="title">cfs</span>;</span></span><br><span class="line">    <span class="comment">// åµŒå¥—çš„å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> <span class="title">rt</span>;</span></span><br><span class="line">    <span class="comment">// curr æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æè¿°ç¬¦</span></span><br><span class="line">    <span class="comment">// idle åˆ™æŒ‡å‘ç©ºé—²è¿›ç¨‹æè¿°ç¬¦ï¼ˆå½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šå¯åŠ¨ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">curr</span>, *<span class="title">idle</span>;</span></span><br><span class="line">    u64 clock;</span><br><span class="line">    <span class="keyword">int</span> cpu;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ"><a href="#ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ" class="headerlink" title="ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ"></a>ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ</h1><p>å®æ—¶ä¸Šï¼Œè°ƒåº¦å‡½æ•° <code>schedule()</code> ä¼šåœ¨å¾ˆå¤šåœºæ™¯ä¸‹è¢«è°ƒç”¨ã€‚æœ‰çš„æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæœ‰çš„åˆ™æ˜¯éšå¼è°ƒç”¨ï¼ˆé€šè¿‡è®¾ç½® <code>TIF_NEED_RESCHED</code> æ¥æç¤ºæ“ä½œç³»ç»Ÿå°½å¿«è¿è¡Œè°ƒåº¦å‡½æ•°ï¼‰ã€‚ä»¥ä¸‹ä¸‰ä¸ªè°ƒåº¦æ—¶æœºå€¼å¾—å…³æ³¨ä¸‹ï¼š</p><ul><li><p><strong>æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨ <code>scheduler_tick()</code> å‡½æ•°</strong>ï¼Œè¯¥å‡½æ•°ä¼šæ›´æ–°ä¸€äº›å’Œè°ƒåº¦æœ‰å…³çš„æ•°æ®ç»Ÿè®¡ï¼Œå¹¶è§¦å‘è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦æ–¹æ³•ï¼Œä»è€Œé—´æ¥åœ°è¿›è¡Œè°ƒåº¦ã€‚ä»¥ 2.6.39 æºç ä¸ºä¾‹ï¼Œå¯èƒ½çš„è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scheduler_tick</span><br><span class="line">â””â”€â”€ task_tick</span><br><span class="line">    â””â”€â”€ entity_tick</span><br><span class="line">        â””â”€â”€ check_preempt_tick</span><br><span class="line">            â””â”€â”€ resched_task</span><br><span class="line">                â””â”€â”€ set_tsk_need_resched</span><br></pre></td></tr></table></figure></li><li><p><strong>å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è¿›å…¥ç¡çœ çŠ¶æ€</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡ä¼šä¸»åŠ¨é‡Šæ”¾ CPUã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥ä»»åŠ¡ä¼šå› ä¸ºç­‰å¾…æŒ‡å®šçš„äº‹ä»¶è€Œç¡çœ ï¼Œå®ƒå¯ä»¥å°†è‡ªå·±æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨å¾ªç¯æ£€æŸ¥æœŸæœ›çš„æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚åœ¨è¿›å…¥ç¡çœ å‰ï¼Œä»»åŠ¡å¯ä»¥å°†è‡ªå·±çš„çŠ¶æ€è®¾ç½®ä¸º <code>TASK_INTERRUPTABLE</code>ï¼ˆé™¤äº†ä»»åŠ¡è¦ç­‰å¾…çš„äº‹ä»¶å¯å”¤é†’å¤–ï¼Œä¹Ÿå¯ä»¥è¢«ä¿¡å·å”¤é†’ï¼‰æˆ–è€… <code>TASK_UNINTERRUPTABLE</code>ï¼ˆè‡ªç„¶æ˜¯ä¸ä¼šç†ä¼šä¿¡å·å’¯ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>schedule()</code> é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡è¿è¡Œã€‚</p></li><li><p><strong>ç¡çœ çš„ä»»åŠ¡è¢«å”¤é†’</strong>ã€‚ä»»åŠ¡ç­‰å¾…çš„äº‹ä»¶å¯ä»¥åœ¨å…³è”çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šè°ƒç”¨ <code>wake_up()</code> å‡½æ•°å”¤é†’ä»»åŠ¡ï¼šç›¸å…³ä»»åŠ¡ä¼šå°†è‡ªå·±è®¾ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœå½“å‰å”¤é†’çš„ä»»åŠ¡ä¼˜å…ˆçº§æ¯”è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä»»ä½•ä»»åŠ¡éƒ½é«˜ï¼Œåˆ™ä¼šè®¾ç½® <code>TIF_NEED_RESCHED</code> æ ‡å¿—ï¼Œä»è€Œè®©æ“ä½œç³»ç»Ÿå°½å¿«è°ƒç”¨ <code>schedule()</code> å‡½æ•°ã€‚</p></li></ul><h1 id="Linux-è°ƒåº¦å™¨"><a href="#Linux-è°ƒåº¦å™¨" class="headerlink" title="Linux è°ƒåº¦å™¨"></a>Linux è°ƒåº¦å™¨</h1><h2 id="æ—©æœŸç‰ˆæœ¬"><a href="#æ—©æœŸç‰ˆæœ¬" class="headerlink" title="æ—©æœŸç‰ˆæœ¬"></a>æ—©æœŸç‰ˆæœ¬</h2><p>Linux 0.0.1 ç‰ˆæœ¬å°±å·²ç»æœ‰äº†ä¸€ä¸ªç®€å•çš„è°ƒåº¦å™¨ï¼Œå½“ç„¶å¹¶éé€‚åˆæ‹¥æœ‰ç‰¹åˆ«å¤šå¤„ç†å™¨çš„ç³»ç»Ÿã€‚è¯¥è°ƒåº¦å™¨åªç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„è¿›ç¨‹é˜Ÿåˆ—ï¼Œæ¯æ¬¡éƒ½éœ€è¦éå†è¯¥é˜Ÿåˆ—æ¥å¯»æ‰¾æ–°çš„è¿›ç¨‹æ‰§è¡Œï¼Œè€Œä¸”å¯¹ä»»åŠ¡æ•°é‡è¿˜æœ‰ä¸¥æ ¼é™åˆ¶ï¼ˆ<code>NR_TASKS</code> åœ¨æœ€åˆçš„ç‰ˆæœ¬ä¸­åªæœ‰ 32ï¼‰ã€‚ä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„å§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 'schedule()' is the scheduler function. </span></span><br><span class="line"><span class="comment">// This is GOOD CODE! There probably won't be any reason to change </span></span><br><span class="line"><span class="comment">// this, as it should work well in all circumstances (ie gives </span></span><br><span class="line"><span class="comment">// IO-bound processes good response etc)...</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, next, c;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> **<span class="title">p</span>;</span></span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰ä¿¡å·ï¼Œåˆ™éœ€è¦å”¤é†’ `TASK_INTERRUPTABLE` çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">for</span> (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p)</span><br><span class="line">        <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123;</span><br><span class="line">                (*p)-&gt;signal |= (<span class="number">1</span> &lt;&lt; (SIGALRM - <span class="number">1</span>));</span><br><span class="line">                (*p)-&gt;alarm = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;signal &amp;&amp; (*p)-&gt;state == TASK_INTERRUPTIBLE)</span><br><span class="line">                (*p)-&gt;state = TASK_RUNNING;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        c = <span class="number">-1</span>;</span><br><span class="line">        next = <span class="number">0</span>;</span><br><span class="line">        i = NR_TASKS;</span><br><span class="line">        p = &amp;task[NR_TASKS];</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ‰¾åˆ°æ—¶é—´ç‰‡æœ€é•¿çš„é‚£ä¸ª</span></span><br><span class="line">        <span class="keyword">while</span> (--i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!*--p)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c)</span><br><span class="line">                c = (*p)-&gt;counter, next = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// éå†ä»»åŠ¡ï¼Œé‡æ–°è®¾å€¼æ—¶é—´ç‰‡</span></span><br><span class="line">        <span class="keyword">for</span> (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p)</span><br><span class="line">            <span class="keyword">if</span> (*p)</span><br><span class="line">                (*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; <span class="number">1</span>) + (*p)-&gt;priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    switch_to(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="O-n"><a href="#O-n" class="headerlink" title="O(n)"></a>O(n)</h2><p>2.4 ç‰ˆæœ¬çš„ Linux å†…æ ¸ä½¿ç”¨çš„è°ƒåº¦ç®—æ³•éå¸¸ç®€å•å’Œç›´æ¥ï¼Œç”±äºæ¯æ¬¡åœ¨å¯»æ‰¾ä¸‹ä¸€ä¸ªä»»åŠ¡æ—¶éœ€è¦éå†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆé“¾è¡¨ï¼‰ï¼Œå› æ­¤è¢«ç§°ä¸º O(n) è°ƒåº¦å™¨ï¼ˆæ—¶é—´å¤æ‚åº¦ï¼‰ã€‚</p><p>å½“ç„¶ï¼Œè¯¥è°ƒåº¦å™¨è¦æ¯” 0.01 ç‰ˆæœ¬å†…æ ¸ä¸­çš„è°ƒåº¦ç®—æ³•ç¨å¾®å¤æ‚ç‚¹ï¼Œå®ƒå¼•å…¥äº† epoch æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯å°†æ—¶é—´åˆ†æˆçºªå…ƒï¼ˆepochsï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæ¯ä¸ªçºªå…ƒç»“æŸï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½åº”è¯¥è¿è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œè€Œä¸”é€šå¸¸ç”¨å…‰äº†å®ƒå½“å‰çš„æ—¶é—´ç‰‡ã€‚ä½†å®é™…ä¸Šï¼Œæœ‰äº›ä»»åŠ¡å¹¶æ²¡æœ‰å®Œå…¨ç”¨å®Œæ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆå®ƒå‰©ä½™æ—¶é—´ç‰‡çš„ä¸€åŠå°†ä¼šå’Œæ–°çš„æ—¶é—´ç‰‡ç›¸åŠ ï¼Œä»è€Œåœ¨ä¸‹ä¸€ä¸ªçºªå…ƒè¿è¡Œæ›´é•¿çš„æ—¶é—´ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>schedule()</code> ç®—æ³•çš„æ ¸å¿ƒæºç ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schedule() ç®—æ³•ä¼šéå†æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆO(N)ï¼‰ï¼Œå¹¶ä¸”è®¡ç®—å‡ºæ¯ä¸ªä»»åŠ¡çš„</span></span><br><span class="line"><span class="comment">// goodness å€¼ï¼Œä¸”æŒ‘é€‰å‡ºã€Œæœ€å¥½ã€çš„ä»»åŠ¡æ¥è¿è¡Œã€‚</span></span><br><span class="line"><span class="comment">// ä»¥ä¸‹æ˜¯éƒ¨åˆ†æ ¸å¿ƒæºç ï¼Œä¸»è¦æ˜¯äº†è§£ä¸‹å®ƒçš„æ€è·¯ã€‚</span></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æè¿°ç¬¦ï¼š</span></span><br><span class="line">    <span class="comment">// 1. prev: å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// 2. next: ä¸‹ä¸€ä¸ªå°†è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// 3. p: å½“å‰æ­£åœ¨éå†çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">prev</span>, *<span class="title">next</span>, *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> this_cpu, c; <span class="comment">// c è¡¨ç¤ºæƒé‡å€¼</span></span><br><span class="line">repeat_schedule:</span><br><span class="line">    <span class="comment">// é»˜è®¤é€‰ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">    next = idle_task(this_cpu);</span><br><span class="line">    c = <span class="number">-1000</span>;</span><br><span class="line">    list_for_each(tmp, &amp;runqueue_head) &#123;</span><br><span class="line">        p = list_entry(tmp, struct task_struct, run_list);</span><br><span class="line">        <span class="keyword">if</span> (can_schedule(p, this_cpu)) &#123;</span><br><span class="line">            <span class="keyword">int</span> weight = goodness(p, this_cpu, prev-&gt;active_mm);</span><br><span class="line">            <span class="keyword">if</span> (weight &gt; c)</span><br><span class="line">                c = weight, next = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æºç ä¸­çš„ <code>goodness()</code> å‡½æ•°ä¼šè®¡ç®—å‡ºä¸€ä¸ªæƒé‡å€¼ï¼Œå®ƒçš„ç®—æ³•åŸºæœ¬æ€æƒ³å°±æ˜¯åŸºäºè¿›ç¨‹æ‰€å‰©ä½™çš„æ—¶é’ŸèŠ‚æ‹æ•°ï¼ˆæ—¶é—´ç‰‡ï¼‰ï¼Œå†åŠ ä¸ŠåŸºäºè¿›ç¨‹ä¼˜å…ˆçº§çš„æƒé‡å€¼ã€‚è¿”å›å€¼å¦‚ä¸‹ï¼š</p><ul><li>-1000 è¡¨ç¤ºä¸è¦é€‰æ‹©è¯¥è¿›ç¨‹è¿è¡Œ</li><li>0 è¡¨ç¤ºæ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œéœ€è¦é‡æ–°è®¡ç®— countersï¼ˆå¯èƒ½ä¼šè¢«é€‰ä¸­è¿è¡Œï¼‰</li><li>æ­£æ•´æ•°ï¼šè¡¨ç¤º goodness å€¼ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰</li><li>+1000 è¡¨ç¤ºå®æ—¶è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥å°±è¦é€‰æ‹©å®ƒè¿è¡Œ</li></ul><p>æœ€åï¼Œé’ˆå¯¹ O(n) è°ƒåº¦å™¨åšä¸‹æ€»ç»“ï¼š</p><ol><li>ç®—æ³•å®ç°éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¸é«˜æ•ˆï¼ˆä»»åŠ¡è¶Šå¤šï¼Œéå†è€—è´¹æ—¶é—´è¶Šä¹…ï¼‰</li><li>æ²¡æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§ï¼Œå¤šæ ¸å¤„ç†å™¨æ€ä¹ˆåŠï¼Ÿ</li><li>å¯¹äºå®æ—¶ä»»åŠ¡è°ƒåº¦æ”¯æŒè¾ƒå¼±ï¼ˆæ— è®ºå¦‚ä½•ä½œä¸ºä¼˜å…ˆçº§é«˜çš„å®æ—¶ä»»åŠ¡éƒ½éœ€è¦åœ¨éå†å®Œåˆ—è¡¨åæ‰å¯ä»¥çŸ¥é“ï¼‰</li></ol><h2 id="O-1"><a href="#O-1" class="headerlink" title="O(1)"></a>O(1)</h2><p><a href="https://en.wikipedia.org/wiki/Ingo_Moln%C3%A1r" target="_blank" rel="noopener">Ingo MolnÃ¡r</a> å¤§ä½¬åœ¨ 2.6 ç‰ˆæœ¬çš„å†…æ ¸ä¸­åŠ å…¥äº†å…¨æ–°çš„è°ƒåº¦ç®—æ³•ï¼Œå®ƒèƒ½å¤Ÿåœ¨å¸¸æ•°æ—¶é—´å†…è°ƒåº¦ä»»åŠ¡ï¼Œå› æ­¤è¢«ç§°ä¸º O(1) è°ƒåº¦å™¨ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå¼•å…¥çš„ä¸€äº›æ–°ç‰¹æ€§ï¼š</p><ul><li>å…¨å±€ä¼˜å…ˆçº§å•ä½ï¼ŒèŒƒå›´æ˜¯ 0~139ï¼Œæ•°å€¼è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li><li><strong>å°†ä»»åŠ¡æ‹†åˆ†æˆå®æ—¶ï¼ˆ0~99ï¼‰å’Œæ­£å¸¸ï¼ˆ100~139ï¼‰ä¸¤éƒ¨åˆ†</strong>ã€‚æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡è·å¾—æ›´å¤šæ—¶é—´ç‰‡</li><li><strong>å³åˆ»æŠ¢å ï¼ˆearly preemptionï¼‰</strong>ã€‚å½“ä»»åŠ¡çŠ¶æ€å˜æˆ <code>TASK_RUNNING</code> æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å…¶ä¼˜å…ˆçº§æ˜¯å¦æ¯”å½“å‰è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™æŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œåˆ‡æ¢åˆ°è¯¥ä»»åŠ¡</li><li><strong>å®æ—¶ä»»åŠ¡ä½¿ç”¨é™æ€ä¼˜å…ˆçº§</strong></li><li><strong>æ™®é€šä»»åŠ¡ä½¿ç”¨ä½¿ç”¨åŠ¨æ€ä¼˜å…ˆçº§</strong>ã€‚ä»»åŠ¡ä¼˜å…ˆçº§ä¼šåœ¨å…¶ä½¿ç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡åé‡æ–°è®¡ç®—ï¼Œå†…æ ¸ä¼šè€ƒè™‘å®ƒè¿‡å»çš„è¡Œä¸ºï¼Œå†³å®šå®ƒçš„äº¤äº’æ€§ç­‰çº§ã€‚äº¤äº’å‹ä»»åŠ¡æ›´å®¹æ˜“å¾—åˆ°è°ƒåº¦</li></ul><p>O(n) çš„è°ƒåº¦å™¨ä¼šåœ¨æ¯ä¸ªçºªå…ƒç»“æŸåï¼ˆæ‰€æœ‰ä»»åŠ¡çš„æ—¶é—´ç‰‡éƒ½ä½¿ç”¨è¿‡ï¼‰ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è€Œ O(1) åˆ™æ˜¯åœ¨æ¯ä¸ªä»»åŠ¡æ—¶é—´ç‰‡é…é¢ç”¨å®Œåå°±é‡æ–°è®¡ç®—ä¼˜å…ˆçº§ã€‚O(1) è°ƒåº¦å™¨ä¸º<strong>æ¯ä¸ª CPU ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå³ active å’Œ expired</strong>ã€‚active é˜Ÿåˆ—å­˜æ”¾çš„æ˜¯æ—¶é—´ç‰‡å°šæœªç”¨å®Œçš„ä»»åŠ¡ï¼Œè€Œ expired åˆ™æ˜¯æ—¶é—´ç‰‡å·²ç»è€—å°½çš„ä»»åŠ¡ã€‚å½“ä¸€ä¸ªä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å®Œåï¼Œå°±ä¼šè¢«è½¬åˆ° expired é˜Ÿåˆ—ï¼Œè€Œä¸”ä¼šé‡æ–°è®¡ç®—å®ƒçš„ä¼˜å…ˆçº§ã€‚<strong>å½“ active é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨è½¬ç§»åˆ° expired é˜Ÿåˆ—åï¼Œä¼šäº¤æ¢äºŒè€…ï¼ˆè®© active æŒ‡å‘ expired é˜Ÿåˆ—ï¼Œexpired æŒ‡å‘ active é˜Ÿåˆ—ï¼‰</strong>ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œé˜Ÿåˆ—åˆ‡æ¢éƒ½å’Œä»»åŠ¡æ•°é‡å¤šå¯¡æ— å…³ï¼Œèƒ½å¤Ÿåœ¨ O(1) æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆã€‚</p><p>åœ¨å…ˆå‰ä»‹ç»çš„è°ƒåº¦ç®—æ³•ä¸­ï¼Œå¦‚æœæƒ³è¦å–ä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ï¼Œè¿˜éœ€è¦éå†æ•´ä¸ªä»»åŠ¡é“¾è¡¨æ‰å¯ä»¥ã€‚è€Œ O(1) è°ƒåº¦å™¨åˆ™å¾ˆç‰¹åˆ«ï¼Œå®ƒä¸ºæ¯ç§ä¼˜å…ˆçº§æä¾›äº†ä¸€ä¸ªä»»åŠ¡é“¾è¡¨ã€‚æ‰€æœ‰çš„å¯è¿è¡Œä»»åŠ¡ä¼šè¢«åˆ†æ•£åœ¨ä¸åŒä¼˜å…ˆçº§é˜Ÿåº”çš„é“¾è¡¨ä¸­ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹å…¨æ–°çš„ <code>runqueue</code> æ˜¯æ€ä¹ˆå®šä¹‰çš„å§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">runqueue</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_running; <span class="comment">/* å¯è¿è¡Œçš„ä»»åŠ¡æ€»æ•°ï¼ˆæŸä¸ª CPUï¼‰ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> *<span class="title">active</span>;</span> <span class="comment">/* æŒ‡å‘ active çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> *<span class="title">expired</span>;</span> <span class="comment">/* æŒ‡å‘ expired çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> <span class="title">arrays</span>[2];</span> <span class="comment">/* å®é™…å­˜æ”¾ä¸åŒä¼˜å…ˆçº§å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥ç›´è§‚æ„Ÿå—ä¸‹ä»»åŠ¡é˜Ÿåˆ—ï¼š<br><img src="https://pic4.zhimg.com/v2-a4e9ffb8e01f5adbb240bd0f3e19991f.jpg" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>prio_array</code> æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> nr_active; <span class="comment">/* åˆ—è¡¨ä¸­çš„ä»»åŠ¡æ€»æ•° */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> bitmap[BITMAP_SIZE]; <span class="comment">/* ä½å›¾è¡¨ç¤ºå¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨æ˜¯å¦æœ‰ä»»åŠ¡å­˜åœ¨ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>[<span class="title">MAX_PRIO</span>];</span> <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¯ç§ä¼˜å…ˆçº§å¯¹åº”ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼‰ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>prio_array</code> ä¸­å­˜åœ¨ä¸€ä¸ªä½å›¾ï¼Œå®ƒæ˜¯ç”¨æ¥æ ‡è®°æ¯ä¸ª priority å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨æ˜¯å¦å­˜åœ¨ä»»åŠ¡çš„ã€‚æ¥ä¸‹æ¥çœ‹çœ‹ä¸ºä½• O(1) è°ƒåº¦å™¨å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´æ‰¾åˆ°éœ€è¦è¿è¡Œçš„ä»»åŠ¡ï¼š</p><ol><li><strong>å¸¸æ•°æ—¶é—´ç¡®å®šä¼˜å…ˆçº§</strong>ï¼šé¦–å…ˆä¼šåœ¨ä½å›¾ä¸­æŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªè®¾ç½®ä¸º 1 çš„ä½ï¼ˆæ€»å…±æœ‰ 140 bitsï¼Œä»ç¬¬ä¸€ä¸ª bit å¼€å§‹æœç´¢ï¼Œè¿™æ ·å¯ä»¥ä¿è¯é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆå¾—åˆ°æœºä¼šè¿è¡Œï¼‰ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±å¯ä»¥ç¡®å®šå“ªä¸ªä¼˜å…ˆçº§æœ‰ä»»åŠ¡ï¼Œå‡è®¾æ‰¾åˆ°åçš„å€¼ä¸º <code>priority</code>ï¼›</li><li><strong>å¸¸æ•°æ—¶é—´è·å¾—ä¸‹ä¸€ä¸ªä»»åŠ¡</strong>ï¼šåœ¨ <code>queue[priority]</code> å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ä¸­æå–ç¬¬ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼ˆå¤šä¸ªä»»åŠ¡ä¼šè½®è½¬æ‰§è¡Œï¼‰ã€‚<br><img src="https://pic1.zhimg.com/v2-5dbbda39ff60d26fd2605ef6970dc468.jpg" alt=""></li></ol><p>å¥½äº†ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸‹ O(1) è°ƒåº¦å™¨çš„ä¼˜ç¼ºç‚¹äº†ï¼š</p><ol><li>è®¾è®¡ä¸Šè¦æ¯” O(n) è°ƒåº¦å™¨æ›´åŠ å¤æ‚ç²¾å¦™ï¼›</li><li>ç›¸å¯¹æ¥è¯´æ‰©å±•æ€§æ›´å¥½ï¼Œæ€§èƒ½æ›´ä¼˜ï¼Œåœ¨ä»»åŠ¡åˆ‡æ¢ä¸Šçš„å¼€é”€æ›´å°ï¼›</li><li>ç”¨æ¥æ ‡è®°ä»»åŠ¡æ˜¯å¦ä¸ºäº¤äº’ç±»å‹çš„ç®—æ³•è¿˜æ˜¯è¿‡äºå¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚</li></ol><h2 id="Staircase"><a href="#Staircase" class="headerlink" title="Staircase"></a>Staircase</h2><p><em>Staircase Scheduler</em> æ˜¯ Con Kolivas ä¸ºäº†æ”¹å–„æ¡Œé¢ç³»ç»Ÿäº¤äº’åº”ç”¨çš„å“åº”æ—¶é—´è€Œå®ç°çš„è°ƒåº¦å™¨ï¼Œä½†å®ƒå¹¶éå†…æ ¸å®˜æ–¹æ”¯æŒçš„è°ƒåº¦å™¨ã€‚å®ƒçš„æ•´ä½“è®¾è®¡æ€æƒ³ç±»ä¼¼äº <em>Operating Systems: The Three Easy Pieces</em> ä¸­æåˆ°çš„ MLFQï¼ˆMultilevel Feedback Queueï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„è®¾è®¡æ€æƒ³ï¼š</p><ol><li>é¦–å…ˆï¼Œå®ƒä¹Ÿæ˜¯å°†ä»»åŠ¡æŒ‰ç…§ä¼˜å…ˆçº§æ”¾åœ¨ä¸åŒçš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆç±»ä¼¼ä¸Šé¢çš„ active é˜Ÿåˆ—ï¼‰</li><li>è°ƒåº¦å™¨æ¯æ¬¡ä¼šä»æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­è·å–ä¸€ä¸ªè¦åˆ‡æ¢æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ—¶é—´ç‰‡ä½¿ç”¨å®Œæ¯•åï¼Œä¼šå°†å…¶ä¼˜å…ˆçº§è°ƒä½ä¸€ä¸ªç­‰çº§ï¼Œç›´åˆ°å…¶ä¼˜å…ˆçº§é™åˆ°æœ€ä½ã€‚</li><li>å½“å¤„äºæœ€ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ç”¨å…‰äº†æ—¶é—´ç‰‡åï¼Œå®ƒä¼šè¢«é‡æ–°æ”¾åˆ°æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆè¿™ä¸ªæ–°çš„ä¼˜å…ˆçº§æ˜¯å®ƒä¹‹å‰æœ€é«˜ä¼˜å…ˆçº§å‡ 1 åçš„å€¼ï¼‰ï¼ŒåŒæ—¶ä¼šè·å¾—ä¸¤å€äºä¹‹å‰çš„æ—¶é—´ç‰‡</li><li>å¯¹äºé•¿æ—¶é—´ç¡çœ çš„ä»»åŠ¡ï¼Œä¼šè¢«æ”¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡é“¾è¡¨ã€‚æ‰€ä»¥äº¤äº’å¼ä»»åŠ¡å¯ä»¥ä¿æŒåœ¨æœ€é«˜ä¼˜å…ˆçº§ä½ç½®ï¼Œä»è€Œä¿æŒè‰¯å¥½çš„å“åº”æ€§èƒ½ï¼›è€Œæ‰¹å¤„ç†ä»»åŠ¡åˆ™å¤„äºä½ä¼˜å…ˆçº§ï¼Œä½†æ˜¯ä¼šè·å¾—æ›´å¤šçš„æ‰§è¡Œæ—¶é—´ã€‚</li></ol><h2 id="CFS"><a href="#CFS" class="headerlink" title="CFS"></a>CFS</h2><h3 id="å•æ ¸è°ƒåº¦"><a href="#å•æ ¸è°ƒåº¦" class="headerlink" title="å•æ ¸è°ƒåº¦"></a>å•æ ¸è°ƒåº¦</h3><p>CFS çš„å…¨ç§°æ˜¯ Complete Fair Schedulerï¼Œä¹Ÿå°±æ˜¯å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ã€‚å®ƒå®ç°äº†ä¸€ä¸ªåŸºäºæƒé‡çš„å…¬å¹³é˜Ÿåˆ—ç®—æ³•ï¼Œä»è€Œå°† CPU æ—¶é—´åˆ†é…ç»™å¤šä¸ªä»»åŠ¡ï¼ˆæ¯ä¸ªä»»åŠ¡çš„æƒé‡å’Œå®ƒçš„ nice å€¼æœ‰å…³ï¼Œnice å€¼è¶Šä½ï¼Œæƒé‡å€¼è¶Šé«˜ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è™šæ‹Ÿè¿è¡Œæ—¶é—´ vruntimeï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªä»»åŠ¡æ‰€ä½¿ç”¨çš„ CPU æ—¶é—´é™¤ä»¥å…¶ä¼˜å…ˆçº§å¾—åˆ°çš„å€¼ã€‚ç›¸åŒä¼˜å…ˆçº§å’Œç›¸åŒ vruntime çš„ä¸¤ä¸ªä»»åŠ¡å®é™…è¿è¡Œçš„æ—¶é—´ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œè¿™å°±æ„å‘³ç€ CPU èµ„æºæ˜¯ç”±å®ƒä»¬å‡åˆ†äº†ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰ä»»åŠ¡èƒ½å¤Ÿå…¬å¹³æ¨è¿›ï¼Œæ¯å½“éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡æ—¶ï¼ŒCFS æ€»ä¼šæŒ‘é€‰å‡º <code>vruntime</code> æœ€å°çš„é‚£ä¸ªä»»åŠ¡è¿è¡Œã€‚</p><p>å†…æ ¸ç‰ˆæœ¬åœ¨ 2.6.38 ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ä¼šè¢«å½“æˆç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå¹¶ä¸”å’Œç³»ç»Ÿä¸­å…¶å®ƒçº¿ç¨‹å…±äº«èµ„æºï¼Œè¿™å°±æ„å‘³ç€ä¸€ä¸ªå¤šçº¿ç¨‹çš„åº”ç”¨ä¼šæ¯”å•çº¿ç¨‹çš„åº”ç”¨è·å¾—æ›´å¤šçš„èµ„æºã€‚ä¹‹åï¼ŒCFS ä¸æ–­æ”¹è¿›ï¼Œç›®å‰å·²ç»æ”¯æŒå°†ä¸€ä¸ªåº”ç”¨ä¸­çš„çº¿ç¨‹æ‰“åŒ…åˆ° cgroup ç»“æ„ä¸­ï¼Œcgroup çš„ vruntime æ˜¯å…¶ä¸­æ‰€æœ‰çº¿ç¨‹çš„ vuntime ä¹‹å’Œã€‚ç„¶å CFS å°±å¯ä»¥å°†å®ƒçš„ç®—æ³•åº”ç”¨äºcgroup ä¹‹é—´ï¼Œä»è€Œä¿è¯å…¬å¹³æ€§ã€‚å½“æŸä¸ª cgroup è¢«é€‰ä¸­åï¼Œå…¶ä¸­æ‹¥æœ‰æœ€å° vruntime çš„çº¿ç¨‹ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œä¿è¯ cgroup ä¸­çš„çº¿ç¨‹ä¹‹é—´çš„å…¬å¹³æ€§ã€‚cgroup è¿˜å¯ä»¥åµŒå¥—ï¼Œä¾‹å¦‚ systemd ä¼šè‡ªåŠ¨é…ç½® cgroup æ¥ä¿è¯ä¸åŒç”¨æˆ·ä¹‹é—´çš„å…¬å¹³æ€§ï¼Œç„¶ååœ¨ç”¨æˆ·è¿è¡Œçš„å¤šä¸ªåº”ç”¨ä¹‹é—´ç»´æŒå…¬å¹³æ€§ã€‚</p><p>CFS é€šè¿‡åœ¨ä¸€å®šæ—¶é—´å†…è¿è¡Œè°ƒåº¦æ‰€æœ‰çš„çº¿ç¨‹æ¥é¿å…é¥¥é¥¿é—®é¢˜ã€‚å½“è¿è¡Œçš„ çº¿ç¨‹æ•°åœ¨ 8 ä¸ªåŠä»¥ä¸‹æ—¶ï¼Œé»˜è®¤çš„æ—¶é—´å‘¨æœŸæ˜¯ 48msï¼›è€Œå½“å¤šäº 8 ä¸ªçº¿ç¨‹æ—¶ï¼Œæ—¶é—´å‘¨æœŸå°±ä¼šéšç€çº¿ç¨‹æ•°é‡è€Œå¢åŠ ï¼ˆ6ms * çº¿ç¨‹æ•°ï¼Œä¹‹æ‰€ä»¥é€‰æ‹© 6msï¼Œæ˜¯ä¸ºäº†é¿å…é¢‘ç¹æŠ¢å ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹åˆ‡æ¢çš„å¼€é”€ï¼‰ã€‚ç”±äº CFS æ€»æ˜¯ä¼šæŒ‘é€‰ vruntime æœ€å°çš„çº¿ç¨‹æ‰§è¡Œï¼Œå®ƒå°±éœ€è¦é¿å…æŸä¸ªçº¿ç¨‹çš„ vruntime å¤ªå°ï¼Œä»¥è‡³äºå…¶å®ƒçº¿ç¨‹éœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½å¾—åˆ°è°ƒåº¦ï¼ˆä¼šæœ‰é¥¥é¥¿é—®é¢˜ï¼‰ã€‚æ‰€ä»¥åœ¨å®è·µä¸­ï¼ŒCFS ä¼šä¿è¯æ‰€æœ‰çº¿ç¨‹ä¹‹é—´çš„ vruntime ä¹‹å·®ä½äºæŠ¢å æ—¶é—´ï¼ˆ6msï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡å¦‚ä¸‹ä¸¤ç‚¹æ¥ä¿è¯çš„ï¼š</p><ol><li>å½“çº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå®ƒçš„ vruntime å€¼ç­‰äºè¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçº¿ç¨‹çš„æœ€å¤§ vruntimeï¼›</li><li>å½“çº¿ç¨‹ä»ç¡çœ ä¸­å”¤é†’æ—¶ï¼Œå®ƒçš„ vruntime å€¼ä¼šè¢«æ›´æ–°ä¸ºå¤§äºæˆ–ç­‰äºæ‰€æœ‰å¾…è°ƒåº¦çº¿ç¨‹ä¸­æœ€å°çš„ vruntimeã€‚ä½¿ç”¨æœ€å° vruntime è¿˜å¯ä»¥ä¿è¯é¢‘ç¹ç¡çœ çš„çº¿ç¨‹ä¼˜å…ˆè¢«è°ƒåº¦ï¼Œè¿™å¯¹äºæ¡Œé¢ç³»ç»Ÿéå¸¸é€‚åˆï¼Œå®ƒä¼šå‡å°‘äº¤äº’åº”ç”¨çš„å“åº”å»¶è¿Ÿã€‚</li></ol><p>CFS è¿˜å¼•å…¥äº†å¯å‘å¼è°ƒåº¦æ€æƒ³æ¥æ”¹å–„é«˜é€Ÿç¼“å­˜åˆ©ç”¨ç‡ã€‚ä¾‹å¦‚ï¼Œå½“çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥è¯¥çº¿ç¨‹çš„ vruntime å’Œæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ vruntime ä¹‹å·®æ˜¯å¦éå¸¸æ˜¾è‘—ï¼ˆä¸´ç•Œå€¼æ˜¯ 1msï¼‰ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™ä¸ä¼šæŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯è¿™ç§åšæ³•è¿˜æ˜¯ä»¥ç‰ºç‰²è°ƒåº¦å»¶è¿Ÿä¸ºä»£ä»·çš„ï¼Œç®—æ˜¯ä¸€ç§æƒè¡¡å§ã€‚</p><h3 id="å¤šæ ¸è´Ÿè½½å‡è¡¡"><a href="#å¤šæ ¸è´Ÿè½½å‡è¡¡" class="headerlink" title="å¤šæ ¸è´Ÿè½½å‡è¡¡"></a>å¤šæ ¸è´Ÿè½½å‡è¡¡</h3><p>åœ¨å¤šæ ¸ç¯å¢ƒä¸­ï¼ŒLinux CFS ä¼šå°†<em>å·¥ä½œï¼ˆworkï¼‰</em>åˆ†æ‘Šåˆ°å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸­æ‰§è¡Œã€‚ä½†æ˜¯è¿™ä¸ç­‰åŒäºå°†çº¿ç¨‹å‡åˆ†åˆ°å¤šä¸ªå¤„ç†å™¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª CPU å¯†é›†å‹çš„çº¿ç¨‹å’Œ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹å¯èƒ½åˆ†åˆ«åœ¨ä¸¤ä¸ªæ ¸ä¸Šæ‰§è¡Œï¼Œå…¶ä¸­ä¸€ä¸ªä¸“é—¨æ‰§è¡Œ CPU å¯†é›†å‹çº¿ç¨‹ï¼›è€Œå¦ä¸€ä¸ªåˆ™å¤„ç†é‚£ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹ã€‚</p><p>ä¸ºäº†å¤šä¸ªå¤„ç†å™¨ä¸Šçš„å·¥ä½œé‡å‡è¡¡ï¼ŒCFS ä½¿ç”¨äº† <code>load</code> æŒ‡æ ‡æ¥è¡¡é‡çº¿ç¨‹å’Œå¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µã€‚çº¿ç¨‹çš„è´Ÿè½½å’Œçº¿ç¨‹çš„ CPU å¹³å‡ä½¿ç”¨ç‡ç›¸å…³ï¼šç»å¸¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½è¦ä½äºä¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½ã€‚ç±»ä¼¼ vruntimeï¼Œçº¿ç¨‹çš„è´Ÿè½½ä¹Ÿæ˜¯çº¿ç¨‹çš„ä¼˜å…ˆçº§åŠ æƒå¾—åˆ°çš„ã€‚è€Œå¤„ç†å™¨çš„è´Ÿè½½æ˜¯åœ¨è¯¥å¤„ç†å™¨ä¸Šå¯è¿è¡Œçº¿ç¨‹çš„è´Ÿè½½ä¹‹å’Œã€‚CFS ä¼šå°è¯•å‡è¡¡å¤„ç†å™¨çš„è´Ÿè½½ã€‚</p><p>CFS ä¼šåœ¨çº¿ç¨‹åˆ›å»ºå’Œå”¤é†’æ—¶å…³æ³¨å¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µï¼Œè°ƒåº¦å™¨é¦–å…ˆè¦å†³å®šå°†ä»»åŠ¡æ”¾åœ¨å“ªä¸ªå¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚è¿™é‡Œä¹Ÿä¼šæ¶‰åŠåˆ°å¯å‘å¼æ€æƒ³ï¼Œæ¯”å¦‚ï¼Œå¦‚æœ CFS æ£€æŸ¥åˆ°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé‚£ä¹ˆå®ƒä¼šå°†æ¶ˆè´¹è€…çº¿ç¨‹å°½å¯èƒ½åœ°åˆ†æ•£åˆ°æœºå™¨çš„å¤šä¸ªå¤„ç†å™¨ä¸Šï¼Œå› ä¸ºå¤šæ•°æ ¸å¿ƒéƒ½é€‚åˆå¤„ç†å”¤é†’çš„çº¿ç¨‹ã€‚</p><p>è´Ÿè½½å‡è¡¡è¿˜ä¼šå‘¨æœŸæ€§å‘ç”Ÿï¼Œæ¯éš” 4msï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå°è¯•ä»å…¶å®ƒå¤„ç†å™¨å·å–ä¸€äº›å·¥ä½œã€‚å½“ç„¶ï¼Œè¿™ç§ work-stealing å‡è¡¡æ–¹æ³•è¿˜ä¼šè€ƒè™‘æœºå™¨çš„æ‹“æ‰‘ç»“æ„ï¼šå¤„ç†å™¨ä¼šå°è¯•ä»è·ç¦»å®ƒä»¬ã€Œæ›´è¿‘ã€çš„å…¶å®ƒå¤„ç†å™¨ä¸Šå°è¯•çªƒå–å·¥ä½œï¼Œè€Œéè·ç¦»ã€Œæ›´è¿œã€çš„å¤„ç†å™¨ï¼ˆå¦‚è¿œç¨‹ NUMA èŠ‚ç‚¹ï¼‰ã€‚å½“å¤„ç†å™¨å†³å®šè¦ä»å…¶å®ƒå¤„ç†å™¨çªƒå–ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šå°è¯•åœ¨äºŒè€…ä¹‹é—´å‡è¡¡è´Ÿè½½ï¼Œå¹¶ä¸”ä¼šçªƒå–å¤šè¾¾ 32 ä¸ªçº¿ç¨‹ã€‚æ­¤å¤–ï¼Œå½“å¤„ç†å™¨è¿›å…¥ç©ºé—²çŠ¶æ€æ—¶ï¼Œå®ƒä¹Ÿä¼šç«‹åˆ»è°ƒç”¨è´Ÿè½½å‡è¡¡å™¨ã€‚</p><p>åœ¨å¤§å‹çš„ NUMA æœºå™¨ä¸Šï¼ŒCFS å¹¶ä¸ä¼šç²—æš´åœ°æ¯”è¾ƒæ‰€æœ‰ CPU çš„è´Ÿè½½ï¼Œè€Œæ˜¯ä»¥åˆ†å±‚çš„æ–¹å¼è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚ä»¥ä¸€å°æœ‰ä¸¤ä¸ª NUMA èŠ‚ç‚¹çš„æœºå™¨ä¸ºä¾‹ï¼ŒCFS ä¼šå…ˆåœ¨ NUMA èŠ‚ç‚¹å†…éƒ¨çš„å¤„ç†å™¨ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œç„¶åæ¯”è¾ƒ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½ï¼ˆé€šè¿‡èŠ‚ç‚¹å†…éƒ¨å¤„ç†å™¨è´Ÿè½½è®¡ç®—å¾—åˆ°ï¼‰ï¼Œå†å†³å®šè¦ä¸è¦åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¦‚æœ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½å·®è·åœ¨ 25% ä»¥å†…ï¼Œåˆ™ä¸ä¼šè¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ€»ç»“æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªå¤„ç†å™¨ï¼ˆæˆ–å¤„ç†å™¨ç»„ï¼‰ä¹‹é—´çš„è·ç¦»è¶Šè¿œï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä¸å¹³è¡¡æ€§å·®è·è¶Šå¤§çš„æƒ…å†µä¸‹æ‰ä¼šè€ƒè™‘è´Ÿè½½å‡è¡¡ã€‚</p><h3 id="è¿è¡Œé˜Ÿåˆ—"><a href="#è¿è¡Œé˜Ÿåˆ—" class="headerlink" title="è¿è¡Œé˜Ÿåˆ—"></a>è¿è¡Œé˜Ÿåˆ—</h3><p>CFS å¼•å…¥äº†<a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree" target="_blank" rel="noopener">çº¢é»‘æ ‘</a>ï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µåŠå¹³è¡¡äºŒå‰æ ‘ï¼Œå¯¹äºæ’å…¥å’ŒæŸ¥æ‰¾éƒ½æœ‰ O(log(N)) çš„æ—¶é—´å¤æ‚åº¦ï¼‰æ¥ç»´æŠ¤è¿è¡Œé˜Ÿåˆ—ï¼Œæ ‘çš„èŠ‚ç‚¹å€¼æ˜¯è°ƒåº¦å•å…ƒçš„ vruntimeï¼Œæ‹¥æœ‰æœ€å° vruntime çš„èŠ‚ç‚¹ä½äºæ ‘çš„æœ€å·¦ä¸‹è¾¹ã€‚<br><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Red-black_tree_example.svg/2560px-Red-black_tree_example.svg.png" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>cfs_rq</code> æ•°æ®ç»“æ„çš„å®šä¹‰ï¼ˆä½äº <code>&lt;kernel/sched/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰ä»»åŠ¡çš„ç´¯è®¡æƒé‡å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¯¥é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_running;</span><br><span class="line">    <span class="comment">// è¿è¡Œé˜Ÿåˆ—ä¸­æœ€å°çš„ vruntime</span></span><br><span class="line">    u64 min_vruntime;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ŒæŒ‡å‘è¿è¡Œä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">tasks_timeline</span>;</span></span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªå³å°†è¢«è°ƒåº¦çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_leftmost</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è°ƒåº¦å•å…ƒ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">curr</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>CFS ç®—æ³•å®é™…åº”ç”¨äºè°ƒåº¦å•å…ƒï¼ˆè¿™æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æŠ½è±¡ï¼Œå¯ä»¥æ˜¯çº¿ç¨‹ã€cgroups ç­‰ï¼‰ï¼Œè°ƒåº¦å•å…ƒæ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;include/linux/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè°ƒåº¦å•å…ƒçš„è´Ÿè½½æƒé‡ï¼ˆæ¯”å¦‚è¯¥è°ƒåº¦å•å…ƒæ˜¯ä¸€ä¸ªç»„ï¼Œåˆ™è¯¥å€¼å°±æ˜¯è¯¥ç»„ä¸‹æ‰€æœ‰çº¿ç¨‹çš„è´Ÿè½½æƒé‡çš„ç»„åˆï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span> <span class="comment">/* for load-balancing */</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">run_node</span>;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰è°ƒåº¦å•å…ƒæ˜¯å¦ä½äºè¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> on_rq;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    u64 exec_start;</span><br><span class="line">    <span class="comment">// æ€»å…±è¿è¡Œçš„æ—¶é—´ï¼Œè¯¥å€¼æ˜¯é€šè¿‡ `update_curr()` æ›´æ–°çš„ã€‚</span></span><br><span class="line">    u64 sum_exec_runtime;</span><br><span class="line">    <span class="comment">// åŸºäºè™šæ‹Ÿæ—¶é’Ÿè®¡ç®—å‡ºè¯¥è°ƒåº¦å•å…ƒå·²è¿è¡Œçš„æ—¶é—´</span></span><br><span class="line">    u64 vruntime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè®°å½•ä¹‹å‰è¿è¡Œçš„æ—¶é—´ä¹‹å’Œ</span></span><br><span class="line">    u64 prev_sum_exec_runtime;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h3 id="è™šæ‹Ÿæ—¶é’Ÿ"><a href="#è™šæ‹Ÿæ—¶é’Ÿ" class="headerlink" title="è™šæ‹Ÿæ—¶é’Ÿ"></a>è™šæ‹Ÿæ—¶é’Ÿ</h3><p>å‰é¢æåˆ°çš„ vruntime ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆå«ä½œè™šæ‹Ÿè¿è¡Œæ—¶é—´å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±è¦æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ã€‚ä¸ºäº†æ›´å¥½åœ°å®ç°å…¬å¹³æ€§ï¼ŒCFS ä½¿ç”¨äº†è™šæ‹Ÿæ—¶é’Ÿæ¥æµ‹é‡ä¸€ä¸ªç­‰å¾…çš„è°ƒåº¦å•å…ƒåœ¨ä¸€ä¸ª<strong>å®Œå…¨å…¬å¹³çš„å¤„ç†å™¨</strong>ä¸Šå…è®¸æ‰§è¡Œçš„æ—¶é—´ã€‚ç„¶è€Œï¼Œè™šæ‹Ÿæ—¶é’Ÿå¹¶æ²¡æœ‰çœŸå®çš„å®ç°ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚</p><p>æˆ‘ä»¬å¯ä»¥åŸºäºçœŸå®æ—¶é—´å’Œä»»åŠ¡çš„è´Ÿè½½æƒé‡æ¥è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ï¼Œè¯¥ç®—æ³•æ˜¯åœ¨ <code>update_cur()</code> å‡½æ•°ä¸­å®ç°çš„ï¼Œå®ƒä¼šæ›´æ–°è°ƒåº¦å•å…ƒçš„æ—¶é—´è®°è´¦ä¿¡æ¯ï¼Œä»¥åŠ CFS è¿è¡Œé˜Ÿåˆ—çš„ <code>min_vruntime</code>ï¼ˆå®Œæ•´å®šä¹‰ä½äº <code>&lt;kernel/sched/fair.c&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_curr</span><span class="params">(struct cfs_rq *cfs_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">curr</span> = <span class="title">cfs_rq</span>-&gt;<span class="title">curr</span>;</span></span><br><span class="line">    u64 now = rq_clock_task(rq_of(cfs_rq));</span><br><span class="line">    u64 delta_exec;</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!curr))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡ºè°ƒåº¦å•å…ƒå¼€å§‹æ‰§è¡Œæ—¶é—´å’Œå½“å‰ä¹‹é—´çš„å·®å€¼ï¼Œå³çœŸå®è¿è¡Œæ—¶é—´</span></span><br><span class="line">    delta_exec = now - curr-&gt;exec_start;</span><br><span class="line">    curr-&gt;vruntime += calc_delta_fair(delta_exec, curr);</span><br><span class="line">    update_min_vruntime(cfs_rq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u64 <span class="title">calc_delta_fair</span><span class="params">(u64 delta, struct sched_entity *se)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é»˜è®¤çš„ä¼˜å…ˆçº§ï¼ˆå†…éƒ¨ nice å€¼æ˜¯ 120ï¼‰ï¼Œé‚£ä¹ˆè™šæ‹Ÿè¿è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="comment">// å°±æ˜¯çœŸå®è¿è¡Œæ—¶é—´ã€‚å¦åˆ™ï¼Œä¼šåŸºäº `__calc_delta` è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(se-&gt;load.weight != NICE_0_LOAD))</span><br><span class="line">        <span class="comment">// è¯¥è®¡ç®—è¿‡ç¨‹åŸºæœ¬ç­‰åŒäºï¼š</span></span><br><span class="line">        <span class="comment">// delta = delta_exec * NICE_0_LOAD / cur-&gt;load.weight;</span></span><br><span class="line">        delta = __calc_delta(delta, NICE_0_LOAD, &amp;se-&gt;load);</span><br><span class="line">    <span class="keyword">return</span> delta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_min_vruntime</span><span class="params">(struct cfs_rq *cfs_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 vruntime = cfs_rq-&gt;min_vruntime;</span><br><span class="line">    <span class="keyword">if</span> (cfs_rq-&gt;curr)</span><br><span class="line">        <span class="comment">// å¦‚æœæ­¤æ—¶æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œå°±æ›´æ–°æœ€å°è¿è¡Œæ—¶é—´ä¸ºå½“å‰ä»»åŠ¡çš„ vruntime</span></span><br><span class="line">        vruntime = cfs_rq-&gt;curr-&gt;vruntime;</span><br><span class="line">    <span class="keyword">if</span> (cfs_rq-&gt;rb_leftmost)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è°ƒåº¦å•å…ƒ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">se</span> = <span class="title">rb_entry</span>(<span class="title">cfs_rq</span>-&gt;<span class="title">rb_leftmost</span>,</span></span><br><span class="line"><span class="class">                                           <span class="title">struct</span> <span class="title">sched_entity</span>,</span></span><br><span class="line"><span class="class">                                           <span class="title">run_node</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (!cfs_rq-&gt;curr)</span><br><span class="line">            vruntime = se-&gt;vruntime;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// ä¿è¯ min_vruntime æ˜¯äºŒè€…ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªå€¼</span></span><br><span class="line">            vruntime = min_vruntime(vruntime, se-&gt;vruntime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¹‹æ‰€ä»¥å»äºŒè€…ä¹‹é—´çš„æœ€å¤§å€¼ï¼Œæ˜¯ä¸ºäº†ä¿è¯ min_vruntime èƒ½å¤Ÿå•è°ƒå¢é•¿</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æƒ³æƒ³ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ</span></span><br><span class="line">    cfs_rq-&gt;min_vruntime = max_vruntime(cfs_rq-&gt;min_vruntime, vruntime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æœ€åï¼Œæ¥æ€»ç»“ä¸‹ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿçš„æ„ä¹‰ï¼š</p><ul><li>å½“ä»»åŠ¡è¿è¡Œæ—¶ï¼Œå®ƒçš„è™šæ‹Ÿæ—¶é—´æ€»æ˜¯ä¼šå¢åŠ ï¼Œä»è€Œä¿è¯å®ƒä¼šè¢«ç§»åŠ¨åˆ°çº¢é»‘æ ‘çš„å³ä¾§ï¼›</li><li>å¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè™šæ‹Ÿæ—¶é’Ÿçš„èŠ‚æ‹æ›´æ…¢ï¼Œä»è€Œè®©å®ƒç§»åŠ¨åˆ°çº¢é»‘æ ‘å³ä¾§çš„é€Ÿåº¦å°±è¶Šæ…¢ï¼Œå› æ­¤å®ƒä»¬è¢«å†æ¬¡è°ƒåº¦çš„æœºä¼šå°±æ›´å¤§äº›ã€‚<br><img src="https://pic3.zhimg.com/v2-bcc1970ab1806342e946bf4e9b6ff1d7.jpg" alt=""></li></ul><h3 id="é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡"><a href="#é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡" class="headerlink" title="é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡"></a>é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡</h3><p>CFS å¯ä»¥åœ¨çº¢é»‘æ ‘ä¸­ä¸€ç›´æ‰¾åˆ°æœ€å·¦ï¼ˆleftmostï¼‰è¾¹çš„èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªè¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯çœŸæ­£å®ç° <code>__pick_first_entity()</code> çš„å‡½æ•°å…¶å®å¹¶æ²¡æœ‰çœŸæ­£åœ°æ‰§è¡ŒæŸ¥æ‰¾ï¼ˆè™½ç„¶å¯ä»¥åœ¨ O(log(N)) æ—¶é—´å†…æ‰¾åˆ°ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼ˆå®Œæ•´å®šä¹‰ä½äº <code>&lt;kernel/sched/fair.c&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *__<span class="title">pick_first_entity</span>(<span class="title">struct</span> <span class="title">cfs_rq</span> *<span class="title">cfs_rq</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// å…¶å®è¿™é‡Œå–çš„æ˜¯ç¼“å­˜çš„ leftmost èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ‰§è¡Œå°±ä¼šæ›´å¿«äº†</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">left</span> = <span class="title">cfs_rq</span>-&gt;<span class="title">rb_leftmost</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!left)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> rb_entry(left, struct sched_entity, run_node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="å®æ—¶è°ƒåº¦å™¨"><a href="#å®æ—¶è°ƒåº¦å™¨" class="headerlink" title="å®æ—¶è°ƒåº¦å™¨"></a>å®æ—¶è°ƒåº¦å™¨</h2><p>Linux å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨å®ç°ä½äº <code>&lt;kernel/sched/rt.c</code>ï¼Œå¯¹äºç³»ç»Ÿè€Œè¨€ï¼Œå®æ—¶ä»»åŠ¡å±äºè´µå®¢ï¼Œä¸€æ—¦å­˜åœ¨å®æ—¶ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œé‚£å°±åº”å½“å°½å¯èƒ½åŠæ—¶åœ°ä¸ºå®ƒä»¬æœåŠ¡ã€‚å¯¹äºå®æ—¶ä»»åŠ¡è€Œè¨€ï¼Œæœ‰ä¸¤ç§è°ƒåº¦ç­–ç•¥å­˜åœ¨ï¼š</p><ul><li><p><code>SCHED_FIFO</code>: è¿™ä¸ªå…¶å®å°±æ˜¯ä¸€ä¸ªå…ˆåˆ°å…ˆæœåŠ¡çš„è°ƒåº¦ç®—æ³•ã€‚è¿™ç±»ä»»åŠ¡æ²¡æœ‰æ—¶é—´ç‰‡é™åˆ¶ï¼Œå®ƒä»¬ä¼šä¸€ç›´è¿è¡Œç›´åˆ°é˜»å¡æˆ–è€…ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œäº¦æˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡æŠ¢å ã€‚è¯¥ç±»ä»»åŠ¡æ€»ä¼šæŠ¢å  <code>SCHED_NORMAL</code> ä»»åŠ¡ã€‚å¦‚æœå¤šä¸ªä»»åŠ¡å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œé‚£å®ƒä»¬ä¼šä»¥è½®è¯¢çš„æ–¹å¼è°ƒåº¦ï¼ˆä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œä¼šè¢«æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œï¼‰ï¼›</p></li><li><p><code>SCHED_RR</code>: è¿™ç§ç­–ç•¥ç±»ä¼¼äº <code>SCHED_FIFO</code>ï¼Œåªæ˜¯å¤šäº†æ—¶é—´ç‰‡é™åˆ¶ã€‚ç›¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šä»¥è½®è¯¢çš„æ–¹å¼è¢«è°ƒåº¦ï¼Œæ¯ä¸ªè¿è¡Œçš„ä»»åŠ¡éƒ½ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å…¶ç”¨å…‰è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æŠ¢å ã€‚å½“ä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å…‰åï¼Œå®ƒä¼šé‡æ–°è¡¥å……èƒ½é‡ï¼Œå¹¶è¢«åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚é»˜è®¤çš„æ—¶é—´ç‰‡æ˜¯ 100msï¼Œå¯ä»¥åœ¨ <code>&lt;include/linux/sched/rt.h&gt;</code> æ‰¾åˆ°å…¶å®šä¹‰ã€‚</p></li></ul><p>å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é™æ€çš„ï¼Œä¸ä¼šåƒä¹‹å‰æåˆ°çš„ç®—æ³•ï¼Œä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ <code>chrt</code> å‘½ä»¤æ›´æ”¹ä»»åŠ¡ä¼˜å…ˆçº§ã€‚</p><h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p>å®æ—¶ä»»åŠ¡æœ‰è‡ªå·±çš„è°ƒåº¦å•å…ƒæ•°æ®ç»“æ„ï¼ˆä½äº <code>&lt;include/linux/sched.h&gt;</code>ï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">run_list</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> timeout;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> watchdog_stamp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> time_slice;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> *<span class="title">back</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> *<span class="title">parent</span>;</span></span><br><span class="line">    <span class="comment">/* rq on which this entity is (to be) queued: */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> *<span class="title">rt_rq</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><code>SCHED_FIFO</code> çš„æ—¶é—´ç‰‡æ˜¯ 0ï¼Œå¯ä»¥åœ¨ <code>&lt;kernel/sched/rt.c&gt;</code> ä¸­çœ‹åˆ°å…·ä½“å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sched_rr_timeslice = RR_TIMESLICE;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">get_rr_interval_rt</span><span class="params">(struct rq *rq,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       struct task_struct *task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task-&gt;policy == SCHED_RR)</span><br><span class="line">        <span class="keyword">return</span> sched_rr_timeslice;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">è€Œå…³äºè¿è¡Œé˜Ÿåˆ—çš„å®šä¹‰å¦‚ä¸‹ï¼š</span><br><span class="line">```c</span><br><span class="line"><span class="comment">/* Real-Time classes' related field in a runqueue: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡éƒ½ä¿å­˜åœ¨ `active.queue[prio]` é“¾è¡¨ä¸­</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_prio_array</span> <span class="title">active</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rt_nr_running;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span>;</span> <span class="comment">/* main runqueue */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This is the priority-queue data structure of the RT scheduling class:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_prio_array</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* include 1 bit for delimiter */</span></span><br><span class="line">    <span class="comment">// ç±»ä¼¼ O(1) è°ƒåº¦å™¨ï¼Œä½¿ç”¨ä½å›¾æ¥æ ‡è®°å¯¹åº”ä¼˜å…ˆçº§çš„é“¾è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    DECLARE_BITMAP(bitmap, MAX_RT_PRIO + <span class="number">1</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>[<span class="title">MAX_RT_PRIO</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ç±»ä¼¼äº CFS ä¸­çš„ <code>update_curr()</code> å‡½æ•°ï¼Œ<code>update_curr_rt()</code> å‡½æ•°ç”¨æ¥è·Ÿè¸ªå®æ—¶ä»»åŠ¡çš„ CPU å ç”¨æƒ…å†µï¼Œæ”¶é›†ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ›´æ–°æ—¶é—´ç‰‡ç­‰ï¼Œä½†è¿™é‡Œä½¿ç”¨çš„æ˜¯çœŸå®æ—¶é—´ï¼Œè€Œæ²¡æœ‰è™šæ‹Ÿæ—¶é—´çš„æ¦‚å¿µã€‚å®Œæ•´å®šä¹‰å¯ä»¥å‚è€ƒ <a href="https://github.com/torvalds/linux/blob/a6ed68d6468bd5a3da78a103344ded1435fed57a/kernel/sched/rt.c#L955" target="_blank" rel="noopener">kernel/sched/rt.c#L955</a>ã€‚</p><h2 id="BFS-amp-MuqSS"><a href="#BFS-amp-MuqSS" class="headerlink" title="BFS &amp; MuqSS"></a>BFS &amp; MuqSS</h2><p>å…³äº BFS å’Œ MuqSS çš„ç²¾å½©ä»‹ç»å¯ä»¥å‚è€ƒ <a href="https://mp.weixin.qq.com/s/kI3pFJ3qUgQJ2P_--G3ehQ" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚<br>æ€»ä½“æ¥è¯´ï¼ŒBFS æ˜¯ä¸€ä¸ªé€‚ç”¨äºæ¡Œé¢æˆ–ç§»åŠ¨è®¾å¤‡çš„è°ƒåº¦å™¨ï¼Œè®¾è®¡åœ°æ¯”è¾ƒç®€æ´ï¼Œç”¨äºæ”¹å–„æ¡Œé¢åº”ç”¨çš„äº¤äº’æ€§ï¼Œå‡å°å“åº”æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚å®ƒé‡‡ç”¨äº†å…¨å±€å•ä»»åŠ¡é˜Ÿåˆ—è®¾è®¡ï¼Œä¸å†è®©æ¯ä¸ª CPU éƒ½æœ‰ç‹¬ç«‹çš„è¿è¡Œé˜Ÿåˆ—ã€‚è™½ç„¶ä½¿ç”¨å•ä¸ªå…¨å±€é˜Ÿåˆ—ï¼Œéœ€è¦å¼•å…¥é˜Ÿåˆ—é”æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ï¼Œä½†æ˜¯å¯¹äºæ¡Œé¢ç³»ç»Ÿè€Œè¨€ï¼Œå¤„ç†å™¨é€šå¸¸éƒ½æ¯”è¾ƒå°‘ï¼Œé”çš„å¼€é”€åŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚BFS æ¯æ¬¡ä¼šåœ¨ä»»åŠ¡é“¾è¡¨ä¸­é€‰æ‹©å…·æœ‰æœ€å° virtual deadline çš„ä»»åŠ¡è¿è¡Œã€‚</p><p>MuqSS æ˜¯ä½œè€…åæ¥åŸºäº BFS æ”¹è¿›çš„ä¸€æ¬¾è°ƒåº¦å™¨ï¼ŒåŒæ ·æ˜¯ç”¨äºæ¡Œé¢ç¯å¢ƒä»»åŠ¡è°ƒåº¦ã€‚å®ƒä¸»è¦è§£å†³äº† BFS çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>æ¯æ¬¡éœ€è¦åœ¨å¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨ä¸­éå†æŸ¥æ‰¾éœ€è¦æ‰§è¡Œä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚æ‰€ä»¥æ–°çš„è°ƒåº¦å™¨å¼•å…¥äº†è·³è¡¨æ¥è§£å†³è¯¥é—®é¢˜ï¼Œä»è€Œå°†æ—¶é—´å¤æ‚åº¦é™ä½åˆ° O(1)ã€‚</li><li>å…¨å±€é”äº‰å¤ºçš„å¼€é”€ä¼˜åŒ–ï¼Œé‡‡ç”¨ <code>try_lock</code> æ›¿ä»£ <code>lock</code>ã€‚<br><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6bytXicPsWIWNWxe47NbURjISJ8rdLqdPkHHW9vngCa5CojQPoI8s7f3f2V6I1OMBJXB1rbOhlmb6wrg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""></li></ol><h1 id="æ·±å…¥å­¦ä¹ "><a href="#æ·±å…¥å­¦ä¹ " class="headerlink" title="æ·±å…¥å­¦ä¹ "></a>æ·±å…¥å­¦ä¹ </h1><ul><li>ã€ŠLinux è®¾è®¡ä¸å®ç° ç¬¬ä¸‰ç‰ˆã€‹è¿›ç¨‹è°ƒåº¦ç« èŠ‚</li><li><a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a></li><li><a href="https://oska874.gitbooks.io/process-scheduling-in-linux/chapter1.html" target="_blank" rel="noopener">Process Scheduling in Linux</a></li><li><a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">å†…æ ¸æ–‡æ¡£ï¼šCFS Scheduler è®¾è®¡</a></li><li>Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹<ul><li>å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</li><li>Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„</li></ul></li><li><a href="https://opensource.com/article/19/2/fair-scheduling-linux" target="_blank" rel="noopener">Linux å…¬å¹³è°ƒåº¦</a><ul><li>å¯¹æ¯”äº†ä¼ ç»Ÿè°ƒåº¦å™¨å’Œ CFS çš„åŒºåˆ«</li><li>ç®€å•ä»‹ç»äº† CFS çš„å®ç°</li></ul></li><li><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" target="_blank" rel="noopener">The Battle of Schedulers: FreeBSD ULE vs Linux CFS</a><ul><li>é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ†</li><li>å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ</li></ul></li><li><a href="https://zhuanlan.zhihu.com/p/33621500" target="_blank" rel="noopener">NUMA æ¶æ„æ·±ç©¶</a><ul><li>æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„</li><li>NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³»</li></ul></li><li><a href="https://jin-yang.github.io/post/linux-kernel-scheduler.html" target="_blank" rel="noopener">Kernel è°ƒåº¦ç³»ç»Ÿ</a><ul><li>é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—®</li><li>vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ</li><li>vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ</li></ul></li><li><a href="https://mp.weixin.qq.com/s/kI3pFJ3qUgQJ2P_--G3ehQ" target="_blank" rel="noopener">ä¸¤ä¸ªéå¸¸æœ‰æ„æ€çš„é€‚åˆæ¡Œé¢ä½¿ç”¨çš„ Linux task è°ƒåº¦å™¨: BFS å’Œ MuqSS</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;em&gt;Linux Kernel Development&lt;/em&gt; ä¸€ä¹¦ä¸­ï¼Œå…³äº Linux çš„è¿›ç¨‹è°ƒåº¦å™¨å¹¶æ²¡æœ‰è®²è§£çš„å¾ˆæ·±å…¥ï¼Œåªæ˜¯æåˆ°äº† CFS è°ƒåº¦å™¨çš„åŸºæœ¬æ€æƒ³å’Œä¸€äº›å®ç°ç»†èŠ‚ï¼›å¹¶æ²¡æœ‰ Linux æ—©æœŸçš„è°ƒåº¦å™¨ä»‹ç»ï¼Œä»¥åŠæœ€è¿‘è¿™äº›å¹´æ–°å¢çš„åœ¨å†…æ ¸æºç æ ‘å¤–ç»´æŠ¤çš„è°ƒåº¦å™¨æ€æƒ³ã€‚æ‰€ä»¥åœ¨ç»è¿‡ä¸€ç•ªæœå¯»åï¼Œçœ‹åˆ°äº†è¿™ç¯‡è®ºæ–‡ &lt;a href=&quot;https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;A complete guide to Linux process scheduling&lt;/a&gt;ï¼Œå¯¹ Linux çš„è°ƒåº¦å™¨å†å²è¿›è¡Œäº†å›é¡¾ï¼Œå¹¶ä¸”ç›¸å¯¹ç»†è‡´åœ°è®²è§£äº† CFS è°ƒåº¦å™¨ã€‚æ•´ä½“æ¥è¯´ï¼Œè™½ç„¶æ¯”è¾ƒå•°å—¦ï¼Œä½†æ˜¯å¯¹äºæƒ³è¦çŸ¥é“æ›´å¤šç»†èŠ‚çš„æˆ‘æ¥è¯´éå¸¸é€‚åˆï¼Œæ‰€ä»¥å°±æœ‰äº†ç¿»è¯‘å®ƒçš„å†²åŠ¨ã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ è¿‡ç¨‹ä¹Ÿå‚è€ƒäº†å…¶å®ƒè®ºæ–‡ã€‚ä¸‹é¢å¼€å¯å­¦ä¹ ä¹‹æ—…å§~&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://ifaceless.space/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="CFS" scheme="http://ifaceless.space/tags/CFS/"/>
    
  </entry>
  
  <entry>
    <title>Linux è°ƒåº¦å™¨å­¦ä¹ èµ„æ–™æ•´ç†</title>
    <link href="http://ifaceless.space/2019/11/05/linux-kernel-scheduler-papers/"/>
    <id>http://ifaceless.space/2019/11/05/linux-kernel-scheduler-papers/</id>
    <published>2019-11-05T13:18:35.000Z</published>
    <updated>2019-11-28T09:41:31.557Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f23_hd.png" alt=""></p><p>ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚<br><a id="more"></a><br>ä¸€ç›´ä»¥æ¥ï¼Œå„è·¯ Linux Hackers éƒ½å¸Œæœ›èƒ½ä¸º Linux æä¾›è¿™æ ·ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ¡Œé¢ç³»ç»Ÿä¸Šæœ‰è¾ƒå¥½çš„äº¤äº’æ€§ï¼Œè€Œåœ¨é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šæœ‰è¾ƒå¥½çš„ååé‡ã€‚</p><p>ä»¥ä¸‹åˆ—ä¸¾ä¸€äº›å­¦ä¹ èµ„æ–™ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£ï¼</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li>è®ºæ–‡ï¼š<a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a>ï¼Œè¿™ç¯‡è®ºæ–‡è®²å¾—æ¯”è¾ƒå¥½ï¼Œå‡†å¤‡ç¿»è¯‘å‡ºæ¥ä»¥ä¾›æ¬£èµ</li><li>GitBook: <a href="https://oska874.gitbooks.io/process-scheduling-in-linux/chapter1.html" target="_blank" rel="noopener">Process Scheduling in Linux</a></li><li>å†…æ ¸æ–‡æ¡£ï¼š<a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux scheduler doc, CFS</a></li><li><p>Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹</p><ul><li>å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</li><li>Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„</li></ul></li><li><p><a href="https://opensource.com/article/19/2/fair-scheduling-linux" target="_blank" rel="noopener">Linux å…¬å¹³è°ƒåº¦</a></p></li><li><p><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" target="_blank" rel="noopener">The Battle of Schedulers: FreeBSD ULE vs Linux CFS</a></p><ul><li>é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ†</li><li>å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ</li></ul></li><li><p><a href="https://zhuanlan.zhihu.com/p/33621500" target="_blank" rel="noopener">NUMA æ¶æ„æ·±ç©¶</a></p><ul><li>æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„</li><li>NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³»</li></ul></li><li><p><a href="https://jin-yang.github.io/post/linux-kernel-scheduler.html" target="_blank" rel="noopener">Kernel è°ƒåº¦ç³»ç»Ÿ</a></p><ul><li>é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—®</li><li>vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ</li><li>vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f23_hd.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://ifaceless.space/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="CFS" scheme="http://ifaceless.space/tags/CFS/"/>
    
  </entry>
  
  <entry>
    <title>Linux Kernel Development å­¦ä¹ ä¸æ€»ç»“</title>
    <link href="http://ifaceless.space/2019/10/30/linux-kernel-dev-notes/"/>
    <id>http://ifaceless.space/2019/10/30/linux-kernel-dev-notes/</id>
    <published>2019-10-30T09:47:22.000Z</published>
    <updated>2019-11-28T09:41:31.556Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æŠ½æ—¶é—´æŠŠ <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" target="_blank" rel="noopener"><em>Operating Systems: Three Easy Pieces</em></a> ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´ ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆ<em>Linux Kernel Development</em>ï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚<br><a id="more"></a><br>åœ¨å­¦ä¹ ä¹‹å‰ï¼Œæ€è€ƒäº†ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥åœ¨å­¦ä¹ ä¸­æ¢ç´¢è¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼š</p><ol><li>Linux ä¸­è¿›ç¨‹ã€çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå„ç§è°ƒåº¦ç­–ç•¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li><li>å¹¶å‘é—®é¢˜è‚¯å®šéœ€è¦æ³¨æ„ï¼ŒLinux ä¸­å¦‚ä½•åº”å¯¹ç«æ€æ¡ä»¶ &amp; æ•°æ®ç«äº‰å‘¢ï¼Ÿå„ç§å¸¸è§çš„åŒæ­¥åŸè¯­åˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>Linux çš„å†…å­˜è™šæ‹ŸåŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå†…å­˜å¸ƒå±€ï¼Ÿè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Ÿ</li><li>æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ€ä¹ˆè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å¯¹ç”¨æˆ·æä¾›ä¸€è‡´ä¼˜é›…çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„å‘¢ï¼Ÿ</li><li>Linux å†…æ ¸ä¸­æœ‰å“ªäº›éå¸¸ç»å…¸çš„ç®—æ³•å’Œæ•°æ®ç»“æ„çš„åº”ç”¨ï¼Ÿå®ƒä»¬ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li></ol><h1 id="Linux-å†…æ ¸ç®€ä»‹"><a href="#Linux-å†…æ ¸ç®€ä»‹" class="headerlink" title="Linux å†…æ ¸ç®€ä»‹"></a>Linux å†…æ ¸ç®€ä»‹</h1><p><img src="https://pic4.zhimg.com/80/v2-e0c1aced72034fd29160b2a0dbc73fa5_r.png" alt=""></p><p>è¯´åˆ° Linuxï¼Œå°±ä¸å¾—ä¸æåˆ°å®ƒçš„ç¥–å…ˆ Unix ç³»ç»Ÿã€‚Unix åœ¨ 1970 å¹´å·¦å³è¢« Ken Thompson é¦–å…ˆåœ¨ä¸€å° PDP-7 æœºå‹ä¸Šå®ç°ï¼Œè€Œåç§»æ¤åˆ° PDP-11 æœºå™¨ä¸Šï¼Œ1973 å¹´å®ƒè¢«ä½¿ç”¨ C è¯­è¨€é‡å†™ï¼Œæä¾›äº†æ›´åŠ å¼ºå¤§çš„å¯ç§»æ¤æ€§ã€‚</p><p>ç»è¿‡å¤šå¹´å‘å±•ï¼ŒUnix ç³»ç»Ÿæˆä¸ºäº†ä¸€ä¸ªå¼ºå¤§ã€å¥å£®ä¸”ç¨³å®šçš„æ“ä½œç³»ç»Ÿã€‚å…¶å¼ºå¤§çš„æ ¹æœ¬åŸå› å¦‚ä¸‹ï¼š</p><ol><li>ç®€æ´ï¼Œä»…æä¾›æ•°ç™¾ä¸ªè®¾è®¡ç›®æ ‡æ˜ç¡®çš„ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>æ‰€æœ‰çš„ä¸œè¥¿éƒ½è¢«å½“ä½œæ–‡ä»¶çœ‹å¾…</li><li>å¾ˆå¼ºçš„ç§»æ¤èƒ½åŠ›</li><li>è¿›ç¨‹åˆ›å»ºéå¸¸è¿…é€Ÿï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨</li><li>æ‹¥æœ‰ç®€å•ä¸”ç¨³å®šçš„è¿›ç¨‹é—´é€šä¿¡åŸè¯­</li></ol><p>Linux æ˜¯ç±» Unix ç³»ç»Ÿï¼Œå®ƒçš„å®ç°å’Œ Unix ä¹Ÿæœ‰ä¸€äº›å¤§ç›¸å¾„åº­çš„æ–¹é¢ï¼Œä½†æ˜¯å®ƒä¾ç„¶ç»§æ‰¿äº† Unix çš„è®¾è®¡ç›®æ ‡ï¼Œä¿è¯äº† API çš„ä¸€è‡´æ€§ï¼ˆæœ‰å“ä½çš„ç¨‹åºå‘˜éƒ½åº”è¯¥è¦å­¦ä¹ è¿™ä¸€æ€æƒ³ï¼‰ã€‚</p><p>Linux è¯æ±‡ä¸€èˆ¬ç”¨æ¥æŒ‡ä»£å†…æ ¸ã€‚å®ƒçš„åŸºç¡€åŒ…æ‹¬ï¼š</p><ol><li>å†…æ ¸</li><li>C åº“</li><li>å·¥å…·é›†</li><li>ç³»ç»Ÿçš„åŸºæœ¬å·¥å…·ï¼Œå¦‚ Shell</li></ol><p>ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿå®½æ³›çš„æ“ä½œç³»ç»Ÿæ˜¯æŒ‡æ•´ä¸ªç³»ç»Ÿä¸­è´Ÿè´£å®Œæˆæœ€åŸºæœ¬åŠŸèƒ½å’Œç³»ç»Ÿç®¡ç†çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬<strong>å†…æ ¸ã€è®¾å¤‡é©±åŠ¨ã€å¯åŠ¨å¼•å¯¼ç¨‹åºã€å‘½ä»¤è¡Œ Shell æˆ–ç”¨æˆ·ç•Œé¢ã€æ–‡ä»¶ç®¡ç†å·¥å…·å’Œç³»ç»Ÿå·¥å…·</strong>ã€‚å†…æ ¸åˆ™æ˜¯é‚£ä¸ªæœ€äº®çš„ä»”ï¼Œå®ƒé€šå¸¸ç”±å¦‚ä¸‹å‡ ä¸ªé‡è¦éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>ä¸­æ–­æœåŠ¡</li><li>ä»»åŠ¡è°ƒåº¦ç¨‹åº</li><li>å†…å­˜ç®¡ç†ç¨‹åº</li><li>ç½‘ç»œ</li><li>è¿›ç¨‹é—´é€šä¿¡ç­‰ç³»ç»ŸæœåŠ¡</li></ol><p>Linux çš„ä¸­æ–­æœåŠ¡æ˜¯ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªä¸æ‰€æœ‰è¿›ç¨‹æ— å…³ã€ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ç¬¬ä¸€æ—¶é—´èƒ½å¤Ÿå“åº”å’Œå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œç„¶åå¿«é€Ÿé€€å‡ºã€‚</p><p>å¤„ç†å™¨åœ¨ä»»æ„æ—¶é—´ç‚¹æ´»åŠ¨å¯æ¦‚æ‹¬ä¸ºä»¥ä¸‹ä¸‰ç§ä¹‹ä¸€ï¼š</p><ol><li>è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä»£è¡¨æŸä¸ªç‰¹å®šçš„è¿›ç¨‹æ‰§è¡Œï¼ˆå¦‚æŸä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸è¿›ç¨‹æ— å…³ï¼Œå¤„ç†ç‰¹å®šçš„ä¸­æ–­</li></ol><h2 id="å¾®å†…æ ¸å’Œå®å†…æ ¸"><a href="#å¾®å†…æ ¸å’Œå®å†…æ ¸" class="headerlink" title="å¾®å†…æ ¸å’Œå®å†…æ ¸"></a>å¾®å†…æ ¸å’Œå®å†…æ ¸</h2><p>è¿™ä¸ªæ˜¯æ¯”è¾ƒæœ‰è¶£çš„å†å²äº†ï¼Œæ“ä½œç³»ç»Ÿè®¾è®¡æœ‰ä¸¤å¤§ä¸»è¦é˜µè¥ï¼šå¾®å†…æ ¸å’Œå®å†…æ ¸ã€‚</p><p>å¾®å†…æ ¸çš„åŠŸèƒ½åˆ’åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æ˜¯ä¸€ä¸ªæœåŠ¡ï¼ˆC/S æ¨¡å‹ï¼ŒæœåŠ¡ä¸å†…æ ¸äº¤äº’ï¼‰ã€‚ç³»ç»Ÿé‡‡ç”¨ IPC ç¦æ­¢äº’é€šæ¶ˆæ¯ï¼Œäº’æ¢ã€ŒæœåŠ¡ã€ã€‚æœåŠ¡çš„ç‹¬ç«‹æ€§å¯ä»¥é¿å…ä¸€ä¸ªæœåŠ¡å¤±è´¥æ®ƒåŠå…¶å®ƒæœåŠ¡ã€‚æ¨¡å—åŒ–è®¾è®¡ä¹Ÿéå¸¸é€‚åˆçƒ­æ’æ‹”ã€‚ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯ IPC çš„å¼€é”€å¤šäºå‡½æ•°è°ƒç”¨ï¼ˆç±»æ¯”å¾®æœåŠ¡çš„ç½‘ç»œå¼€é”€å’Œåœ¨æœ¬åœ°è°ƒç”¨å‡½æ•°çš„å¼€é”€ï¼‰ã€‚</p><p>å®å†…æ ¸åˆ™æ˜¯å®ç”¨ä¸»ä¹‰è€…å–œæ¬¢çš„è®¾è®¡ï¼Œå®ƒæ˜¯æ¯”è¾ƒç®€å•çš„è®¾è®¡ï¼Œæ•´ä½“ä¸Šå°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿‡ç¨‹ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ã€‚å†…æ ¸ä¹‹é—´çš„é€šä¿¡å¾®ä¸è¶³é“ï¼Œæ€§èƒ½é«˜ã€‚</p><p>Linux è‡ªç„¶æ˜¯å®å†…æ ¸è®¾è®¡ï¼ŒLinux å†…æ ¸è¿è¡Œåœ¨å•ç‹¬çš„å†…æ ¸åœ°å€ç©ºé—´ä¸Šã€‚åŒæ—¶å®ƒä¹Ÿé‡‡çº³äº†å¾®å†…æ ¸çš„ç²¾åï¼Œä½¿å®ƒæˆä¸ºæ¨¡å—åŒ–çš„ã€å¤šçº¿ç¨‹çš„ä»¥åŠå†…æ ¸æœ¬èº«å¯è°ƒåº¦çš„æ“ä½œç³»ç»Ÿã€‚</p><h2 id="ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«"><a href="#ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«" class="headerlink" title="ä¸ä¼ ç»Ÿ Unix åŒºåˆ«"></a>ä¸ä¼ ç»Ÿ Unix åŒºåˆ«</h2><ol><li>æ”¯æŒåŠ¨æ€åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆè¿™ä¸ªä¸æ˜¯å¾®å†…æ ¸å®£ç§°çš„å¥½å¤„å—ï¼Ÿå’±ä¹Ÿæœ‰ï¼‰</li><li>æ”¯æŒå¯¹ç§°å¤šå¤„ç†æœºåˆ¶ï¼ˆSMPï¼‰</li><li>å†…æ ¸å¯ä»¥æŠ¢å ï¼ˆpreemptiveï¼‰ï¼šä»»åŠ¡å¯ä»¥æœ‰ä¼˜å…ˆçº§</li><li>å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒå¾ˆç‰¹åˆ«ï¼šå†…æ ¸ä¸åŒºåˆ†çº¿ç¨‹å’Œä¸€èˆ¬çš„è¿›ç¨‹ï¼Œå¯¹äºå†…æ ¸è€Œè¨€ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸€æ ·ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€äº›å…±äº«èµ„æºè€Œå·²</li><li>å…·æœ‰è®¾å¤‡ç±»çš„é¢å‘å¯¹è±¡çš„è®¾å¤‡æ¨¡å‹ã€çƒ­æ’æ‹”äº‹ä»¶ï¼Œç”¨æˆ·ç©ºé—´çš„è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆsysfsï¼‰</li><li>å¿½ç•¥äº†ä¸€äº›æ‹™åŠ£ç‰¹æ€§</li><li>è‡ªç”±ï¼šä»»ä½•æ”¹å˜éƒ½å¿…é¡»è¦èƒ½é€šè¿‡ç®€æ´çš„è®¾è®¡åŠæ­£ç¡®å¯é çš„å®ç°æ¥è§£å†³ç°å®ä¸­ç¡®å®å­˜åœ¨çš„é—®é¢˜</li></ol><h2 id="å†…æ ¸ç‰ˆæœ¬"><a href="#å†…æ ¸ç‰ˆæœ¬" class="headerlink" title="å†…æ ¸ç‰ˆæœ¬"></a>å†…æ ¸ç‰ˆæœ¬</h2><p><code>&lt;ä¸»ç‰ˆæœ¬&gt;.&lt;ä»ç‰ˆæœ¬&gt;.&lt;ä¿®è®¢&gt;[.&lt;ç¨³å®šç‰ˆæœ¬å·&gt;]</code>ï¼Œå…¶ä¸­<strong>ä»ç‰ˆæœ¬å·</strong>ä¸ºå¶æ•°ï¼Œåˆ™ä¸ºç¨³å®šç‰ˆæœ¬ï¼Œå¦åˆ™ä¸ºå¼€å‘ç‰ˆæœ¬ã€‚</p><h2 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h2><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>å¯ä»¥ä½¿ç”¨çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><code>make config</code></li><li><code>make menuconfig1</code></li><li><code>make gconfig</code></li><li>é»˜è®¤é…ç½®ï¼š<code>make defconfig</code></li></ol><p>éªŒè¯å’Œæ›´æ–°é…ç½®ï¼š<code>make oldconfig</code></p><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><ol><li>ç›´æ¥ç¼–è¯‘ï¼š<code>make</code></li><li>å¯¼å‡ºä¸å…³å¿ƒçš„ infoï¼š<code>make &gt;/dev/null</code></li><li>æŒ‡å®šå¹¶è¡Œç¼–è¯‘æ•°é‡ï¼š<code>make -j4 &gt;/dev/null</code></li></ol><h2 id="å†…æ ¸å¼€å‘ç‰¹ç‚¹"><a href="#å†…æ ¸å¼€å‘ç‰¹ç‚¹" class="headerlink" title="å†…æ ¸å¼€å‘ç‰¹ç‚¹"></a>å†…æ ¸å¼€å‘ç‰¹ç‚¹</h2><ol><li>ä¸èƒ½ä½¿ç”¨æ ‡å‡† C åº“</li><li><p>å¿…é¡»ä½¿ç”¨ GNU Cï¼ˆéœ€è¦ç”¨åˆ°å®ƒçš„ä¸€äº›æ‰©å±•ç‰¹æ€§ï¼‰</p><ol><li><code>inline</code>ï¼šé€šå¸¸å°†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå‡½æ•°æœ¬èº«æ¯”è¾ƒçŸ­çš„å®šä¹‰æˆå†…è”å‡½æ•°ã€‚åœ¨å†…æ ¸ä¸­ï¼Œä¸ºäº†ç±»å‹å®‰å…¨å’Œæ˜“è¯»æ€§ï¼Œä¼˜å…ˆä½¿ç”¨ inline å‡½æ•°ï¼Œè€Œéå¤æ‚çš„å®</li><li>å†…è”ç¼–è¯‘ï¼šæ”¯æŒä½¿ç”¨ <code>asm()</code> åµŒå…¥æ±‡ç¼–ä»£ç </li><li>åˆ†æ”¯å£°æ˜ï¼šå¯ä»¥ä½¿ç”¨ <code>likely()</code> å’Œ <code>unlikely()</code> å£°æ˜åˆ†æ”¯æ˜¯å¦ç»å¸¸å‡ºç°æˆ–å¾ˆå°‘å‡ºç°ï¼ŒæŒ‡å¯¼ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ï¼ˆè¦ææ¸…æ¥šï¼Œå¦åˆ™ä¼˜åŒ–åè€Œå˜æˆäº†æ‹–ç´¯ï¼‰</li></ol></li><li><p>ç¼ºä¹åƒç”¨æˆ·ç©ºé—´ä¸­çš„å†…å­˜ä¿æŠ¤æœºåˆ¶</p><ol><li>å†…æ ¸ä¸­å‘ç”Ÿå†…å­˜é”™è¯¯ä¼šå¯¼è‡´ oopsï¼Œå†…æ ¸å¯èƒ½ä¼šæ­»æ‰</li><li>å†…æ ¸ä¸­çš„å†…å­˜æ˜¯<strong>ä¸åˆ†é¡µ</strong>çš„ï¼Œæ¯ç”¨æ‰ä¸€ä¸ªå­—èŠ‚ï¼Œç‰©ç†å†…å­˜å°±å‡å°‘ä¸€ä¸ªå­—èŠ‚</li></ol></li><li><p>éš¾ä»¥æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—</p><ol><li>ä¸èƒ½åƒç”¨æˆ·ç©ºé—´æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—é‚£æ ·ï¼Œå¯ä»¥é€šè¿‡ trap çš„æ–¹å¼å°†æ•´æ•°æ¨¡å¼è½¬æ¢åˆ°æµ®ç‚¹æ•°æ¨¡å¼è®¡ç®—</li><li>å†…æ ¸ä¸èƒ½å®Œç¾æ”¯æŒæµ®ç‚¹æ•°è®¡ç®—ï¼Œæœ¬èº«ä¹Ÿæ— æ³•é™·å…¥ã€‚éè¦æ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦æ‰‹åŠ¨ä¿å­˜å’Œæ¢å¤æµ®ç‚¹å¯„å­˜å™¨ï¼Œéå¸¸éº»çƒ¦</li></ol></li><li><p>å†…æ ¸ç»™æ¯ä¸ªè¿›ç¨‹<strong>åªæœ‰ä¸€ä¸ªå¾ˆå°çš„å®šé•¿å †æ ˆ</strong></p><ol><li>ç”¨æˆ·ç©ºé—´çš„æ ˆå¯ä»¥åŠ¨æ€å¢é•¿ï¼Œå¯æ”¯æŒéå¸¸å¤§çš„æ•°æ®ç»“æ„</li><li>å†…æ ¸æ ˆçš„å¤§å°å’Œä½“ç³»ç»“æ„æœ‰å…³ï¼ˆå¦‚ x86 å¯ä»¥æ˜¯ 4KB/8KBï¼‰</li><li>å†å²ä¸Šæ¥è¯´ï¼Œå†…æ ¸æ ˆå¤§å°æ˜¯ä¸¤é¡µï¼Œ32 ä½æ˜¯ 8KBï¼Œ64 ä½æ˜¯ 16KBï¼›æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„æ ˆ</li></ol></li><li><p>ç”±äºè¦æ”¯æŒå¼‚æ­¥ä¸­æ–­ã€æŠ¢å å’Œ SMPï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å®‰å…¨å’ŒåŒæ­¥</p></li><li>è€ƒè™‘å¯ç§»æ¤æ€§<ol><li>ä¿æŒå­—èŠ‚åº</li><li>64 ä½å¯¹é½</li><li>ä¸å‡å®šå­—é•¿å’Œé¡µé¢é•¿åº¦</li></ol></li></ol><h1 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h1><h2 id="ç®¡ç†è¿›ç¨‹"><a href="#ç®¡ç†è¿›ç¨‹" class="headerlink" title="ç®¡ç†è¿›ç¨‹"></a>ç®¡ç†è¿›ç¨‹</h2><ol><li>å†…æ ¸æŠŠè¿›ç¨‹çš„åˆ—è¡¨å­˜æ”¾åœ¨ task list åŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ª entry çš„ç±»å‹æ˜¯ <code>task_struct</code>ï¼Œè¢«ç§°ä¸º <code>process descriptor</code></li><li>é€šè¿‡ slabï¼ˆæ›´æ–°çš„åº”è¯¥æ˜¯ SLUBï¼‰ åˆ†é…å™¨åˆ†é… task_struct ç»“æ„ä½“ï¼ˆå¯¹è±¡å¤ç”¨å’Œç¼“å­˜ç€è‰²ï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡çš„ <code>thread_info</code> ä½äºå†…æ ¸æ ˆçš„å°¾ç«¯ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘ <code>task_struct</code> çš„æŒ‡é’ˆåŠå…¶å®ƒä¿¡æ¯</li><li>è¿›ç¨‹é€šè¿‡ PID è¿›è¡ŒåŒºåˆ†ï¼Œå…¶å€¼å­˜æ”¾åœ¨ <code>process descriptor</code> ä¸­ã€‚ç”±äºè¿›ç¨‹å¤„ç†ä»£ç éœ€è¦é¢‘ç¹è®¿é—® <code>task_struct</code> ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ PowerPC ç­‰æœºå™¨ä¸Šï¼Œæœ‰ä¸“é—¨çš„å¯„å­˜å™¨å­˜å‚¨äº†ç›¸åº”çš„æŒ‡é’ˆï¼›è€Œåœ¨ x86 ä½“ç³»ä¸‹ï¼Œåˆ™æ˜¯åˆ©ç”¨å†…æ ¸æ ˆå°¾åˆ›å»ºçš„ <code>thread_info</code>ï¼Œå¹¶å€ŸåŠ©åç§»è®¡ç®—é—´æ¥æŸ¥æ‰¾ <code>task_struct</code> ç»“æ„ä½“</li><li><p>è¿›ç¨‹çŠ¶æ€ï¼š</p><ol><li>TASK_RUNNING</li><li>TASK_INTERRUPTABLE</li><li>TASK_UNINTERRUPTABLE</li><li>__TASK_TRACED: è¢«å…¶å®ƒè¿›ç¨‹è·Ÿè¸ªçš„è¿›ç¨‹ï¼ˆå¦‚ ptrace å¯¹è°ƒè¯•ç¨‹åºè¿›è¡Œè·Ÿè¸ªï¼‰</li><li><p>__TASK_STOPPED: è¿›ç¨‹åœæ­¢æ‰§è¡Œï¼Œæ²¡æœ‰æŠ•å…¥è¿è¡Œä¹Ÿæ— æ³•æŠ•å…¥è¿è¡Œ</p><p><img src="https://pic2.zhimg.com/80/v2-ad2075f3f165ab1ab983605446be9b28_r.png" alt=""></p></li></ol></li><li><p>æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ PID ä¸º 1 çš„ init è¿›ç¨‹çš„åä»£ï¼Œinit è¿›ç¨‹çš„æè¿°ç¬¦æ˜¯ä½œä¸º init_task é™æ€åˆ†é…çš„ï¼ˆæ¯”è¾ƒç‰¹æ®Šï¼‰</p></li><li><p>Unix ç³»ç»Ÿè¿›ç¨‹åˆ›å»ºï¼š</p><ol><li>é€šè¿‡ <code>fork()</code> æ‹·è´å½“å‰è¿›ç¨‹åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆåŒºåˆ«çˆ¶è¿›ç¨‹ï¼šæœ‰æ–°çš„ PIDï¼Œæœ‰æŸäº›èµ„æºå’Œç»Ÿè®¡é‡ï¼‰</li><li><code>exec()</code> å‡½æ•°è´Ÿè´£è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¹¶å°†å…¶è½½å…¥åœ°å€ç©ºé—´å¼€å§‹è¿è¡Œ</li></ol></li><li><p>å†™æ—¶æ‹·è´ï¼šå†…æ ¸å¹¶éå¼€å§‹å°±å¤åˆ¶æ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè€Œæ˜¯è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ‹·è´ï¼Œåªæœ‰åœ¨éœ€è¦å†™å…¥çš„æ—¶å€™ï¼Œæ•°æ®æ‰ä¼šè¢«å¤åˆ¶ï¼Œä»è€Œæ‹¥æœ‰å„è‡ªçš„æ‹·è´ã€‚<code>fork()</code> å®é™…å¼€é”€ï¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œç»™å­è¿›ç¨‹åˆ›å»ºå”¯ä¸€çš„è¿›ç¨‹æè¿°ç¬¦</p></li><li>Linux ä¸­çš„ <code>fork()</code> å’Œ <code>vfork()</code> éƒ½æ˜¯é€šè¿‡ <code>clone()</code> ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚<code>vfork()</code> çš„ç‰¹ç‚¹æ˜¯ï¼šä¸æ‹·è´çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä¸”å­è¿›ç¨‹ä½œä¸ºçˆ¶è¿›ç¨‹çš„å•ç‹¬çº¿ç¨‹åœ¨å®ƒçš„åœ°å€ç©ºé—´æ‰§è¡Œï¼Œçˆ¶è¿›ç¨‹é˜»å¡ç›´åˆ°å­è¿›ç¨‹é€€å‡ºæˆ–æ‰§è¡Œ <code>exec()</code></li><li><p>Linux ä¸­çš„çº¿ç¨‹å®ç°ï¼š</p><ol><li>ä»å†…æ ¸è§’åº¦çœ‹ï¼Œæ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹çœ‹å¾…ï¼Œåªæ˜¯ä¸å…¶å®ƒè¿›ç¨‹å…±äº«æŸäº›èµ„æºã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰å±äºè‡ªå·±çš„ task_struct</li><li>å…¶å®ƒç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹è¢«æŠ½è±¡æˆä¸€ç§è€—è´¹èµ„æºè¾ƒå°‘çš„èµ„æºï¼Œè¿è¡Œè¿…é€Ÿçš„æ‰§è¡Œå•å…ƒ</li><li>é€šè¿‡ <code>clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, 0);</code> åˆ›å»ºçº¿ç¨‹</li><li>å¯¹æ¯” <code>fork()</code> å®ç°ï¼š<code>clone(SIGCHLD, 0)</code></li><li>å¯¹æ¯” <code>vfork()</code> å®ç°ï¼š<code>clone(CLONE_VFORK | CLONE_VM | SIGCHLD, 0)</code></li></ol></li><li><p>å†…æ ¸çº¿ç¨‹ï¼š</p><ol><li>å†…æ ¸é€šå¸¸éœ€è¦åœ¨åå°æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè¿™äº›ä»»åŠ¡å¯é€šè¿‡ kernel thread å®Œæˆã€‚è¿™ç§æ˜¯è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„æ ‡å‡†è¿›ç¨‹</li><li>å†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¯è¢«è°ƒåº¦ï¼Œå¯è¢«æŠ¢å </li></ol></li><li><p>è¿›ç¨‹ç»ˆç»“ï¼š</p><ol><li>é€šå¸¸é€šè¿‡ <code>do_exit()</code> å®Œæˆé€€å‡ºï¼ŒæœŸé—´ä¼šé‡Šæ”¾ç›¸å…³çš„èµ„æºï¼Œæœ€ç»ˆå°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º <code>EXIT_ZOMBIE</code>ï¼Œä½†æ˜¯æ­¤æ—¶çš„å†…æ ¸æ ˆã€thread_info å’Œ task_struct ç»“æ„ä½“è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œç»™çˆ¶è¿›ç¨‹æä¾›ä¿¡æ¯</li><li>çˆ¶è¿›ç¨‹è·å¾—å·²ç»ˆç»“çš„å­è¿›ç¨‹ä¿¡æ¯åï¼ˆçˆ¶è¿›ç¨‹å¯é€šè¿‡ <code>wait()</code> ç³»ç»Ÿè°ƒç”¨æ”¶é›†ä¿¡æ¯ï¼‰ï¼Œæˆ–è€…é€šçŸ¥å†…æ ¸å®ƒä¸å…³æ³¨è¿™äº›ä¿¡æ¯ï¼Œæ‰ä¼šé‡Šæ”¾å‰©ä½™çš„å†…å­˜ç©ºé—´</li></ol></li><li><p>å­¤å„¿è¿›ç¨‹ï¼š</p><ol><li>é€€å‡ºæ—¶æ°¸è¿œå¤„äºåƒµæ­»çŠ¶æ€ï¼Œç™½ç™½æµªè´¹å†…å­˜</li><li>è§£å†³åŠæ³•å°±æ˜¯åœ¨å½“å‰çº¿ç¨‹ç»„å¯»æ‰¾æŸä¸ªçº¿ç¨‹ä½œä¸ºçˆ¶äº²ï¼Œå®åœ¨ä¸è¡Œï¼Œå°±è®© init æ¥ç›˜</li></ol></li></ol><h2 id="è°ƒåº¦è¿›ç¨‹"><a href="#è°ƒåº¦è¿›ç¨‹" class="headerlink" title="è°ƒåº¦è¿›ç¨‹"></a>è°ƒåº¦è¿›ç¨‹</h2><ol><li><p>å¤šä»»åŠ¡ç³»ç»Ÿåˆ†ä¸ºä¸¤ç±»ï¼š</p><ol><li>éæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆcooperative multitaskingï¼‰</li><li>æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆpreemptive multitaskingï¼‰</li></ol></li><li><p>è¿›ç¨‹è°ƒåº¦ç­–ç•¥ä¼šå…³å¿ƒè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡</p></li><li>Linux ä¸­çš„è¿›ç¨‹åˆ†ä¸ºæ™®é€šè¿›ç¨‹å’Œå®æ—¶è¿›ç¨‹ï¼Œå…¶ä¸­å‰è€…çš„ä¼˜å…ˆçº§åœ¨ (-20, +19ï¼‰ï¼Œè€Œåè€…åˆ™æ˜¯ (0, 99)ã€‚æ­¤å¤–ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºæ™®é€šè¿›ç¨‹ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜ å°„è¿‡æ¥å°±æ˜¯ (100, 139)</li><li>Linux ä¸­å¯ä»¥é€šè¿‡ <code>nice</code> è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¶Šå°çš„å€¼æ‹¥æœ‰è¶Šé«˜çš„æƒé‡ï¼›åä¹‹ï¼Œåˆ™æƒé‡è¶Šä½ï¼ˆä½“ç°åœ¨æ—¶é—´ç‰‡ä¸Šï¼‰</li></ol><h3 id="CFS-è°ƒåº¦å™¨"><a href="#CFS-è°ƒåº¦å™¨" class="headerlink" title="CFS è°ƒåº¦å™¨"></a>CFS è°ƒåº¦å™¨</h3><ol><li>Linux 2.6 å†…æ ¸å¼•å…¥äº† CFS è°ƒåº¦å™¨ï¼ˆä½äº <code>sched/fair.c</code>ï¼‰ä½œä¸ºæ™®é€šè¿›ç¨‹çš„è°ƒåº¦å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿‘ä¹å®Œç¾çš„å…¬å¹³è°ƒåº¦å™¨ï¼ˆæƒè¡¡å‘¨è½¬æ—¶é—´å’Œå“åº”æ—¶é—´ï¼‰ã€‚å¹¶éé‡‡ç”¨æ—¶é—´ç‰‡è¿›è¡Œåˆ†é…ï¼Œè€Œæ˜¯ç»™è¿›ç¨‹åˆ†é…äº†å¤„ç†å™¨ä½¿ç”¨çš„æ¯”é‡ï¼Œä»è€Œç¡®ä¿è¿›ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿæœ‰æ’å®šçš„å…¬å¹³æ€§ï¼Œä»è€Œå°†åˆ‡æ¢é¢‘ç‡ç½®äºä¸æ–­å˜åŠ¨ä¸­</li><li>CFS åŸºäºä¸€ä¸ªç®€å•çš„ç†å¿µï¼šè¿›ç¨‹è°ƒåº¦çš„æ•ˆæœåº”è¯¥ç­‰åŒäºç³»ç»Ÿæ‹¥æœ‰ä¸€ä¸ªå®Œç¾çš„å¤šä»»åŠ¡å¤„ç†å™¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½èƒ½è·å¾— 1/n_running å¤„ç†å™¨æ—¶é—´</li><li>CFS å…è®¸æ¯ä¸ªè¿›ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå¾ªç¯è½®è½¬ï¼Œæ€»æ˜¯é€‰æ‹© vruntime æœ€å°çš„è¿›ç¨‹ä½œä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯é€šè¿‡æ‰€æœ‰å¯è¿è¡Œç»å¸¸æ€»æ•°ä¸ºåŸºç¡€æ¥è®¡ç®—å‡ºè¿›ç¨‹åº”è¯¥è¿è¡Œå¤šä¹…ï¼Œè€Œéä¾é  nice å€¼æ¥è®¡ç®—æ—¶é—´ç‰‡ï¼ˆä¼ ç»Ÿçš„åšæ³•å°±æ˜¯è¿™ç§ï¼‰</li><li>è°ƒåº¦å™¨å®ç°æ¦‚è¦ï¼š<ol><li><code>sched_entity</code> ç»“æ„ä½“è·Ÿè¸ªè¿è¡Œè®°è´¦ï¼ˆå…¶ä¸­åŒ…å« vruntimeï¼‰</li><li>æ‰€æœ‰å¯è¿è¡Œçš„è¿›ç¨‹éƒ½ä½äºä¸€æ£µé»‘çº¢æ ‘ä¸­ï¼ˆO(logN) æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾ï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½ä¼šä»æ ‘çš„æœ€å·¦å¶å­èŠ‚ç‚¹ä¸Šï¼ˆleftmostï¼‰æ‰¾åˆ° vruntime æœ€å°çš„é‚£ä¸ªè¿›ç¨‹è¿è¡Œï¼ˆå®æ—¶ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯æå‰ç¼“å­˜å¥½çš„ï¼‰</li><li>è°ƒåº¦å™¨å…¥å£å¤„ä¼šæ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„è°ƒåº¦ç±»ï¼Œç„¶åè·å–åˆ°è°æ˜¯ä¸‹ä¸€ä¸ªè¯¥è¿è¡Œçš„è¿›ç¨‹</li><li>ç¡çœ ï¼šè¿›ç¨‹ä¼šæŠŠè‡ªå·±æ ‡è®°æˆä¼‘çœ çŠ¶æ€ï¼Œä»å¯æ‰§è¡Œçº¢é»‘æ ‘ä¸­æº¢å‡ºï¼Œå¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè°ƒç”¨ <code>schedule()</code> æ‰§è¡Œä¸€ä¸ªå…¶ä»–è¿›ç¨‹</li><li>å”¤é†’ï¼šè¿›ç¨‹è¢«è®¾ç½®ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ç§»é™¤ï¼Œæ·»åŠ åˆ°å¯æ‰§è¡Œçº¢é»‘æ ‘</li></ol></li><li>CFS å®ç°äº†å¦‚ä¸‹å‡ ç§è°ƒåº¦ç­–ç•¥ï¼š<ol><li>SCHED_NORMALï¼ˆä»¥å‰å«åš SCHED_OTHERï¼‰ï¼šç”¨äºæ™®é€šä»»åŠ¡è°ƒåº¦</li><li>SCHED_BATCHï¼šå¹¶éåƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œä¼šå°½å¯èƒ½å…è®¸ä»»åŠ¡è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ä¸Š CPU äº²å’Œæ€§ä»¥åŠæ›´å¥½åœ°å¤ç”¨ç¼“å­˜</li><li>SCHED_IDLEï¼šè¿™ç§ä»»åŠ¡ä¼˜å…ˆçº§æ¯” nice 19 è¿˜è¦ä½</li></ol></li></ol><h3 id="æŠ¢å "><a href="#æŠ¢å " class="headerlink" title="æŠ¢å "></a>æŠ¢å </h3><ol><li>ç”¨æˆ·æŠ¢å ï¼ˆæ£€æŸ¥ need_resched æ ‡è¯†ç¬¦ï¼‰ï¼šä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼›ä»ä¸­æ–­å¤„ç†è¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li><li>å†…æ ¸æŠ¢å ï¼ˆthread_info ä¸­å­˜åœ¨ preemt_count è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰æ²¡æœ‰é”è¢«æŒæœ‰ï¼‰ï¼šå°±æ˜¯è°ƒåº¦ç¨‹åºèƒ½å¤Ÿåœ¨å†…æ ¸ä»»åŠ¡æ‰§è¡ŒæœŸé—´è¢«æ‰§è¡Œ<ol><li>åªè¦é‡æ–°è°ƒåº¦æ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰æŒæœ‰é”ï¼‰ï¼Œå†…æ ¸å°±å¯ä»¥åœ¨ä»»ä½•æ—¶é—´æŠ¢å æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li><li>å†…æ ¸æŠ¢å æ—¶æœºï¼š<ol><li>ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œä¸”è¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰</li><li>å†…æ ¸ä»£ç å†æ¬¡å…·æœ‰å¯æŠ¢å æ€§æ—¶</li><li>å†…æ ¸ä»»åŠ¡æ˜¾å¼è°ƒç”¨ <code>schedule()</code></li><li>å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡ï¼ˆæ­¤æ—¶ä¼šå¯¼è‡´è°ƒç”¨ <code>schedule()</code>ï¼‰</li></ol></li></ol></li></ol><h3 id="å®æ—¶è°ƒåº¦å™¨"><a href="#å®æ—¶è°ƒåº¦å™¨" class="headerlink" title="å®æ—¶è°ƒåº¦å™¨"></a>å®æ—¶è°ƒåº¦å™¨</h3><ol><li>å®æ—¶è°ƒåº¦å™¨æ˜¯åœ¨ <code>sched/rt.c</code> ä¸­å®ç°çš„ï¼Œå®ƒä½¿ç”¨äº† 100 ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼ˆå¯¹åº” 1~99 ä»»åŠ¡ä¼˜å…ˆçº§ï¼‰ï¼Œå®ç°äº† SCHED_FIFO å’Œ SCHED_RR ç­–ç•¥ã€‚</li><li><p>SCHED_FIFO:</p><ol><li>ç®€å•çš„å…ˆå…¥å…ˆå‡ºè°ƒåº¦ç®—æ³•ï¼Œä¸ä¾èµ–æ—¶é—´ç‰‡</li><li>è¯¥çº§åˆ«ä»»åŠ¡æ¯” SCHED_NORMAL çº§åˆ«çš„è¿›ç¨‹å…ˆå¾—åˆ°è°ƒåº¦</li><li>ä¸€æ—¦ä»»åŠ¡å¤„äºæ‰§è¡ŒæœŸé—´ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼›åªæœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ SCHED_FIFO/SCHED_RR ä»»åŠ¡æ‰å¯ä»¥æŠ¢å </li></ol></li><li><p>SCHED_RR:</p><ol><li>ç±»ä¼¼ FIFOï¼Œä½†æ˜¯æ¯ä¸ªä»»åŠ¡ä¼šæœ‰åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡è€—å°½åå°±è¦æ¢å…¶å®ƒä»»åŠ¡æ‰§è¡Œ</li><li>å¯¹äº FIFO è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§å§‹ç»ˆæŠ¢å ä½ä¼˜å…ˆçº§è¿›ç¨‹ï¼›ä½ä¼˜å…ˆçº§è¿›ç¨‹ä¸èƒ½æŠ¢å  SCHED_RR è¿›ç¨‹ï¼Œå³ä¾¿å…¶è€—å°½äº†æ—¶é—´ç‰‡</li></ol></li><li><p>Linux æä¾›çš„æ˜¯è½¯å®æ—¶å·¥ä½œæ–¹å¼ï¼Œå°½åŠ›ä½¿å¾—è¿›ç¨‹èƒ½å¤Ÿåœ¨é™å®šçš„æ—¶é—´åˆ°æ¥å‰æ‰§è¡Œï¼Œä½†å†…æ ¸ä¸ä¿è¯æ€»èƒ½æ»¡è¶³è¿™äº›è¿›ç¨‹çš„è¦æ±‚</p></li></ol><h3 id="è°ƒåº¦å™¨ç±»"><a href="#è°ƒåº¦å™¨ç±»" class="headerlink" title="è°ƒåº¦å™¨ç±»"></a>è°ƒåº¦å™¨ç±»</h3><p>è°ƒåº¦å™¨ç±»éœ€è¦å®ç°ä¸€äº› hooksï¼Œè¿™æ ·å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åšåˆé€‚çš„æ“ä½œã€‚éƒ¨åˆ† hooks å¦‚ä¸‹ï¼š</p><ul><li><code>enqueue_task</code></li><li><code>dequeue_task</code></li><li><code>yield_task</code></li><li><code>check_preempt_cur</code></li><li><code>pick_next_task</code></li><li><code>set_curr_task</code></li><li><code>task_tick</code></li></ul><h3 id="è°ƒåº¦ç›¸å…³çš„-syscall"><a href="#è°ƒåº¦ç›¸å…³çš„-syscall" class="headerlink" title="è°ƒåº¦ç›¸å…³çš„ syscall"></a>è°ƒåº¦ç›¸å…³çš„ syscall</h3><table><thead><tr><th>ç³»ç»Ÿè°ƒç”¨</th><th>æè¿°</th></tr></thead><tbody><tr><td>nice()</td><td>è®¾ç½®è¿›ç¨‹çš„ nice å€¼</td></tr><tr><td>sched_setscheduler()</td><td>è®¾ç½®è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_getscheduler()</td><td>è·å–è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_setparam()</td><td>è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</td></tr><tr><td>sched_getparam()</td><td></td></tr><tr><td>sched_rr_get_interval()</td><td>æ—¶é—´ç‰‡å€¼</td></tr><tr><td>sched_setaffinity()</td><td>è®¾ç½®å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>sched_getaffinity()</td><td>è·å–è¿›ç¨‹å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>shced_yield()</td><td>æš‚æ—¶è®©å‡ºå¤„ç†å™¨</td></tr></tbody></table><h1 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œè¿›ç¨‹æ˜¯åœ¨æ“ä½œç³»ç»Ÿæä¾›çš„ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ï¼Œè€Œå¦‚æœéœ€è¦æ‰“å¼€æ–‡ä»¶ç­‰æ“ä½œï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥åˆ°å†…æ ¸æ€ï¼Œç”±æ“ä½œç³»ç»Ÿä»£æ›¿å®Œæˆå’Œç¡¬ä»¶çš„äº¤äº’ï¼Œä»è€Œä¸ºè¿›ç¨‹æä¾›æœåŠ¡ã€‚æ‰€ä»¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨æ—¶åœ¨ç”¨æˆ·ç©ºé—´å’Œè¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚ã€‚è¿™ä¸ªä¸­é—´å±‚çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li>ä¸ºç”¨æˆ·ç©ºé—´æä¾›ç¡¬ä»¶æ¥å£æŠ½è±¡</li><li>ç³»ç»Ÿè°ƒç”¨ä¿è¯ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®š</li><li>æ“ä½œç³»ç»Ÿå¯ä»¥æŒæ§è¿›ç¨‹çš„ç¡¬ä»¶è®¿é—®æ„å›¾ï¼Œå¹¶ä¸”ä»£åŠ³</li></ol><p>é‚£ä¹ˆç³»ç»Ÿè°ƒç”¨åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä¸€å¥è¯æ€»ç»“ä¸ºï¼š<strong>å½“ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶ï¼Œä¼šé™·å…¥åˆ°å†…æ ¸ï¼Œä¼ é€’ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•°ï¼Œæ‰§è¡Œæ­£ç¡®çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼å¸¦å›ç”¨æˆ·ç©ºé—´ã€‚</strong>å¯è§ï¼Œç³»ç»Ÿè°ƒç”¨éå¸¸ç‰¹æ®Šï¼Œå®Œå…¨ä¸åŒäºå¸¸è§„çš„å‡½æ•°è°ƒç”¨ï¼Œçœ‹èµ·æ¥éå¸¸ Hackã€‚</p><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡å‡ ä¸ªé—®é¢˜ï¼ŒåŠ æ·±å¯¹ä¸Šè¿°æè¿°çš„ç†è§£ï¼š</p><ol><li><strong>å¦‚ä½•é™·å…¥åˆ°å†…æ ¸ï¼Ÿ</strong>é€šè¿‡è½¯ä¸­æ–­çš„æ–¹å¼å®ç°ï¼Œé€šè¿‡å¼•å‘ä¸€ä¸ªå¼‚å¸¸è§¦å‘ç³»ç»Ÿåˆ‡æ¢åˆ°å†…æ ¸æ€æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</li><li><strong>ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>åœ¨ Linux ä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªç¼–å·ï¼Œè¿›ç¨‹å…¶å®æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·è€Œä¸æ˜¯åç§°æ¥å‘ŠçŸ¥å†…æ ¸è‡ªå·±ä¸­æ„å“ªä¸ªç³»ç»Ÿè°ƒç”¨çš„ã€‚</li><li><strong>å¦‚ä½•ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œåœ¨ x86 ä¸­ï¼Œå°±æ˜¯å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨ eax å¯„å­˜å™¨ä¼ é€’ç»™å†…æ ¸çš„ã€‚</li><li><strong>å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Ÿ</strong>    <ol><li>ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯å°†å‚æ•°æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸€èˆ¬æ¥è¯´ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸ä¼šå¾ˆå¤šã€‚åœ¨ x86 ä¸­ï¼Œå¯ä»¥ç”¨ ebx, ecx, edx, esi å’Œ edi æŒ‰é¡ºåºå­˜æ”¾äº”ä¸ªå‚æ•°ã€‚</li><li>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯å°†å‚æ•°å­˜æ”¾åœ¨ç”¨æˆ·ç©ºé—´å†…å­˜ä¸­ï¼Œå¹¶å°†å‚æ•°æŒ‡é’ˆå­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è¿™ç§æ˜¯ä¸ºäº†åº”ä»˜å‚æ•°è¶…è¿‡ 6 ä¸ªæƒ…å†µã€‚</li></ol></li><li><strong>è¿”å›å€¼å¦‚ä½•å¸¦ç»™ç”¨æˆ·ç©ºé—´ï¼Ÿ</strong>å½“ç„¶ä¹Ÿæ˜¯é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’çš„ï¼Œåœ¨ x86 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ eax å¯„å­˜å™¨ã€‚</li></ol><h1 id="å†…æ ¸æ•°æ®ç»“æ„"><a href="#å†…æ ¸æ•°æ®ç»“æ„" class="headerlink" title="å†…æ ¸æ•°æ®ç»“æ„"></a>å†…æ ¸æ•°æ®ç»“æ„</h1><p><img src="https://pic1.zhimg.com/80/v2-2bbaf34ff51ed6c19c0390d1fd118b40_hd.png" alt="å†…æ ¸æ•°æ®ç»“æ„"></p><p>Linux å†…æ ¸é“¾è¡¨å®ç°ç‹¬æ ‘ä¸€å¸œã€‚å®ƒæ˜¯å°†é“¾è¡¨å¡å…¥åˆ°æ•°æ®ç»“æ„ï¼Œè€Œéå¸¸è§„çš„é‚£ç§åœ¨æ•°æ®ç»“æ„ä¸­å¡å…¥é“¾è¡¨ã€‚</p><p>å¯ä»¥çœ‹ä¸‹å¯¹æ¯”å°±çŸ¥é“ä¸ºä½•ç‰¹åˆ«äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸¸è§„å®šä¹‰æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Linux å†…æ ¸é“¾è¡¨å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">// æ‰€æœ‰çš„ node å½¢æˆé“¾è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œé€šç”¨çš„é“¾è¡¨æ“ä½œå°±å¯ä»¥åŸºäº <code>struct list_head</code> æ¥å®ç°äº†ã€‚é‚£å¦‚ä½•å’Œæ ¹æ®é“¾è¡¨æŒ‡é’ˆè·å¾—å¯¹åº”çš„ <code>node</code> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ <code>container_of()</code> å®ï¼Œå®é™…ä¸Š C è¯­è¨€ä¸­ï¼Œä¸€ä¸ªç»™å®šç»“æ„ä½“ä¸­çš„å˜é‡åç§»åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¯ä»¥å€Ÿæ­¤è·å¾—çˆ¶ç»“æ„ä¸­çš„ä»»æ„å˜é‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define container_of(ptr, type, member) (&#123; \</span><br><span class="line">    const typeof( ((type *)0)-&gt;member) *__mptr = (ptr); \</span><br><span class="line">    (type *)( (char *)__mptr - offsetof(type, member) );&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å’Œä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"></a>ä¸­æ–­å’Œä¸­æ–­å¤„ç†</h1><p><img src="https://pic4.zhimg.com/80/v2-78cb6999358bdd22b1a00c221f1d606e_r.png" alt=""></p><p>ä¸­æ–­æ˜¯å„ç§ç¡¬ä»¶è®¾å¤‡ä¸å¤„ç†å™¨ååŒé«˜æ•ˆå·¥ä½œçš„æ–¹å¼ä¹‹ä¸€ã€‚å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸€äº›å¤–éƒ¨è®¾å¤‡åˆ™ä¼šæ…¢å¾ˆå¤šï¼›ä¸ºäº†èƒ½å¤Ÿä¿è¯ CPU ä¸æµªè´¹æ—¶é—´è½®è¯¢è®¾å¤‡çŠ¶æ€ï¼Œè€Œé™ä½åˆ©ç”¨ç‡ï¼Œæ‰€ä»¥éœ€è¦ä¸­æ–­æœºåˆ¶æ¥é€šçŸ¥ CPUã€‚å½“å¤„ç†å™¨æ¥æ”¶åˆ°ä¸­æ–­åï¼Œä¼šå»æ‰§è¡Œå·²æ³¨å†Œçš„ç›¸å…³ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–­å’Œå‰é¢æåˆ°çš„å¼‚å¸¸ï¼ˆFaultï¼‰æ˜¯ä¸åŒçš„ï¼š</p><ol><li>ä¸­æ–­é€šå¸¸æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¸è€ƒè™‘æ—¶é’ŸåŒæ­¥ï¼›</li><li>å¼‚å¸¸åˆ™å¿…é¡»ä¸å¤„ç†å™¨æ—¶é’ŸåŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥ä¸­æ–­ï¼ˆå¦‚é™¤ 0 é”™è¯¯ã€ç¼ºé¡µï¼‰ã€‚</li></ol><p>Linux ä¸­å¯¹äºä¸­æ–­çš„å“åº”å’Œå¤„ç†åˆ†æˆ<strong>ä¸ŠåŠéƒ¨</strong>å’Œ<strong>ä¸‹åŠéƒ¨</strong>ã€‚å…¶ä¸­ä¸ŠåŠéƒ¨ä¼šåœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·åå¿«é€Ÿå®Œæˆå¿…è¦å·¥ä½œçš„ï¼ˆæœ‰ä¸¥æ ¼çš„æ—¶é™ï¼‰ï¼Œè€Œæ›´åŠ ç¹é‡çš„ä»»åŠ¡åˆ™ä¼šåœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚åœ¨ä¸ŠåŠéƒ¨éœ€è¦å¿«é€Ÿæ‰§è¡Œï¼Œä¸”æ— æ³•ç¡çœ ï¼›ä½†ä¸‹åŠéƒ¨åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚</p><h2 id="æ— é¡»é‡å…¥"><a href="#æ— é¡»é‡å…¥" class="headerlink" title="æ— é¡»é‡å…¥"></a>æ— é¡»é‡å…¥</h2><p>Linux ä¸­çš„ä¸­æ–­å¤„ç†ä¸ç”¨è€ƒè™‘é‡å…¥ï¼Œå› ä¸ºå½“ç»™å®šä¸­æ–­å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œå¯¹åº”ä¸­æ–­çº¿åœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šè¢«å±è”½ï¼Œé¿å…åŒä¸€ä¸­æ–­çº¿æ¥æ”¶å¦å¤–çš„ä¸­æ–­ã€‚è¿™æ ·åšç®€åŒ–äº†ä¸­æ–­å¤„ç†ç¨‹åºçš„ç¼–å†™ã€‚</p><h2 id="ä¸­æ–­ä¸Šä¸‹æ–‡"><a href="#ä¸­æ–­ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸­æ–­ä¸Šä¸‹æ–‡"></a>ä¸­æ–­ä¸Šä¸‹æ–‡</h2><p>æ‰€è°“çš„ä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆinterrupt contextï¼‰ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚ä¸­æ–­ä¸Šä¸‹æ–‡å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡æ²¡æœ‰åŠæ¯›é’±å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œè¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œä¸€ç•ªå¯¹æ¯”ï¼š</p><table><thead><tr><th>ä¸­æ–­ä¸Šä¸‹æ–‡</th><th>è¿›ç¨‹ä¸Šä¸‹æ–‡</th></tr></thead><tbody><tr><td>æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡</td><td>å†…æ ¸ä»£è¡¨è¿›ç¨‹æ‰§è¡Œï¼ˆç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œå†…æ ¸çº¿ç¨‹ï¼‰æ—¶ï¼Œæ‰€å¤„çš„æ“ä½œæ¨¡å¼</td></tr><tr><td>ä¸è¿›ç¨‹æ— ç“œï¼Œä¸ current å®æ— ç“œ</td><td>å¯é€šè¿‡ current å®å…³è”å½“å‰è¿›ç¨‹</td></tr><tr><td>æ²¡æœ‰åå¤‡è¿›ç¨‹ï¼Œæ— æ³•ç¡çœ ï¼Œä¹Ÿä¸èƒ½è°ƒç”¨ä¼šå¯¼è‡´ç¡çœ çš„å‡½æ•°</td><td>å¯ç¡çœ ï¼Œå¯è°ƒç”¨è°ƒåº¦ç¨‹åº</td></tr><tr><td>æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶é™</td><td>æ²¡æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚</td></tr></tbody></table><h2 id="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"><a href="#ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ" class="headerlink" title="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"></a>ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ</h2><p>ä¸‹åŠéƒ¨å°±æ˜¯æ‰§è¡Œå’Œä¸­æ–­å¤„ç†ç›¸å…³ï¼Œä½†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºä¸­ä¸ä¼šæ‰§è¡Œçš„å·¥ä½œã€‚å¼•å…¥ä¸‹åŠéƒ¨çš„ç›®çš„å°±æ˜¯è®©ä¸­æ–­å¤„ç†ç¨‹åºå°½å¯èƒ½åœ°ç®€çŸ­ã€å¿«é€Ÿï¼Œé¿å…å±è”½ä¸­æ–­å¤ªä¹…ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å“åº”èƒ½åŠ›å’Œæ€§èƒ½å—åˆ°å½±å“ï¼›è€Œæ¯”è¾ƒç¹é‡çš„å·¥ä½œå¯ä»¥åœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚</p><p>ä¸‹åŠéƒ¨ä¸»è¦å®ç°æ–¹å¼ï¼š</p><ol><li><strong>è½¯ä¸­æ–­</strong><ol><li>å¯¹äºæ—¶é—´è¦æ±‚ä¸¥æ ¼ï¼Œä¸”èƒ½è‡ªå·±é«˜æ•ˆå®ŒæˆåŠ é”çš„å·¥ä½œï¼Œå¯ä½¿ç”¨è½¯ä¸­æ–­ï¼ˆå¦‚ç½‘ç»œã€SCSIï¼‰</li><li>è½¯ä¸­æ–­æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸å“åº”ä¸­æ–­ï¼Œä½†å®ƒè‡ªèº«<strong>ä¸èƒ½ç¡çœ </strong></li></ol></li><li><strong>tasklet</strong><ol><li>åŸºäºè½¯ä¸­æ–­å®ç°ï¼ŒåŒä¸€ä¸ªå¤„ç†ç¨‹åºçš„å¤šä¸ªå®ä¾‹ä¸èƒ½å†å¤šä¸ªå¤„ç†å™¨åŒæ—¶è¿è¡Œ</li><li>ç”¨é€”å¹¿æ³›ï¼Œæ¥å£ç®€å•ï¼Œæ€§èƒ½ä¸é”™</li><li>ä¸èƒ½ç¡çœ </li></ol></li><li><strong>å·¥ä½œé˜Ÿåˆ—</strong>ä¸­çš„å·¥ä½œå¯ä»¥äº¤ç»™å†…æ ¸çº¿ç¨‹æ¨åæ‰§è¡Œï¼ˆä¼šåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¼˜åŠ¿ï¼Œä¸”å¯ä»¥é‡æ–°è°ƒåº¦å’Œç¡çœ </li></ol><h1 id="å†…æ ¸åŒæ­¥"><a href="#å†…æ ¸åŒæ­¥" class="headerlink" title="å†…æ ¸åŒæ­¥"></a>å†…æ ¸åŒæ­¥</h1><p>åœ¨è¿›è¡Œå†…æ ¸ç¼–ç¨‹æ—¶ï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ä¸´ç•ŒåŒºï¼Œæ­£ç¡®åŠ é”ã€è§£é”ï¼Œä¿è¯å…³é”®æ•°æ®ç»“æ„ä¸è¢«é”™è¯¯ä¿®æ”¹ã€‚é‚£ä¹ˆæœ‰å“ªäº›æƒ…å†µèƒ½é€ æˆå¹¶å‘é—®é¢˜å‘¢ï¼Ÿ</p><ol><li><strong>ä¸­æ–­</strong>ï¼šå¼‚æ­¥å‘ç”Ÿï¼Œä¼šä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>è½¯ä¸­æ–­å’Œ tasklet</strong>ï¼šå†…æ ¸ä¼šåœ¨ä»»æ„æ—¶åˆ»å”¤é†’è½¯ä¸­æ–­å’Œ taskletï¼Œæ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>å†…æ ¸æŠ¢å </strong>ï¼šå†…æ ¸ä¸­çš„ä»»åŠ¡å¯èƒ½è¢«å…¶å®ƒä»»åŠ¡æŠ¢å </li><li><strong>ç¡çœ åŠä¸ç”¨æˆ·ç©ºé—´åŒæ­¥</strong>ï¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œçš„è¿›ç¨‹å¯èƒ½ä¼šç¡çœ ï¼Œä»è€Œå¯¼è‡´è°ƒåº¦ç¨‹åºè¢«å”¤é†’ï¼Œå¹¶è¿è¡Œæ–°çš„ç”¨æˆ·è¿›ç¨‹</li><li><strong>SMP</strong>ï¼šå¤šä¸ªå¤„ç†å™¨ä¼šå¹¶è¡Œæ‰§è¡Œ</li></ol><p><img src="https://pic3.zhimg.com/80/v2-de0df74c2c0f79723ab558d3b2727e71.png" alt=""></p><h1 id="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"><a href="#å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†" class="headerlink" title="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"></a>å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†</h1><p>å†…æ ¸éœ€è¦åœ¨ç¡¬ä»¶ï¼ˆRTC å’Œ Timerï¼‰çš„å¸®åŠ©ä¸‹æ‰èƒ½è®¡ç®—å’Œç®¡ç†æ—¶é—´ï¼Œå†…æ ¸é€šè¿‡<strong>å·²çŸ¥çš„</strong>ï¼ˆè¿™ä¸ªæ—¶é’Ÿå‘¨æœŸæ˜¯å¯ç¼–ç¨‹çš„ï¼Œå¯ç¡®å®šçš„ï¼‰æ—¶é’Ÿä¸­æ–­é—´éš”æ¥è®¡ç®— wall time å’Œ jiffiesï¼ˆç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ€»æ•°ï¼‰ã€‚é‚£ä¹ˆï¼Œåœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ç©¶ç«Ÿä¼šåšå“ªäº›å·¥ä½œå‘¢ï¼Ÿä»¥ä¸‹ç»™å‡ºä¸€äº›ä¼šå‘¨æœŸæ‰§è¡Œçš„å·¥ä½œï¼š</p><ol><li>æ›´æ–°ç³»ç»Ÿè¿è¡Œæ—¶é—´å’Œå®é™…æ—¶é—´</li><li>å¯¹äº SMP ç³»ç»Ÿï¼Œéœ€è¦å‡è¡¡å„å¤„ç†å™¨ä¸Šçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœè¿è¡Œé˜Ÿåˆ—è´Ÿè½½ä¸å‡è¡¡ï¼Œéœ€è¦å°½é‡è®©å®ƒä»¬å‡è¡¡</li><li>æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦ç”¨å°½äº†è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œå¦‚æœæ—¶ï¼Œåˆ™é‡æ–°è¿›è¡Œè°ƒåº¦</li><li>è¿è¡Œè¶…æ—¶çš„åŠ¨æ€å®šæ—¶å™¨</li><li>æ›´æ–°èµ„æºæ¶ˆè€—å’Œå¤„ç†å™¨æ—¶é—´ç»Ÿè®¡å€¼</li></ol><h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><h2 id="é¡µ"><a href="#é¡µ" class="headerlink" title="é¡µ"></a>é¡µ</h2><p>å†…æ ¸æ˜¯æŠŠç‰©ç†å†…å­˜åˆ†é¡µç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µï¼ˆpageï¼‰æ˜¯æœ€åŸºæœ¬çš„ç®¡ç†å•å…ƒã€‚MMU ä¹Ÿæ˜¯ä»¥é¡µå¤§å°ä¸ºå•ä½è½¬æ¢è™šæ‹Ÿåœ°å€åˆ°ç¡¬ä»¶åœ°å€çš„ã€‚ä¸åŒçš„ä½“ç³»ç»“æ„ï¼Œé¡µå¤§å°ä¸åŒï¼Œä¸€èˆ¬ 32 ä½ç³»ç»Ÿæ˜¯ 4KBï¼Œ64 ä½ç³»ç»Ÿæ˜¯ 8KBã€‚</p><h2 id="åŒº"><a href="#åŒº" class="headerlink" title="åŒº"></a>åŒº</h2><p>å› ä¸ºç¡¬ä»¶å­˜åœ¨é™åˆ¶ï¼Œå†…æ ¸æ— æ³•å¯¹æ‰€æœ‰çš„é¡µä¸€è§†åŒä»ã€‚å› æ­¤éœ€è¦æŠŠé¡µåˆ’åˆ†æˆä¸åŒçš„åŒºï¼ˆzoneï¼‰ï¼Œå†…æ ¸éœ€è¦å¤„ç†å¦‚ä¸‹å› ä¸ºç¡¬ä»¶ç¼ºé™·è€Œå¼•èµ·çš„å†…å­˜å¯»å€é—®é¢˜ï¼š</p><ol><li>ä¸€äº›ç¡¬ä»¶åªèƒ½ç”¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œ DMA æ“ä½œ</li><li>ä¸€äº›ä½“ç³»ç»“æ„çš„å†…å­˜ç‰©ç†å¯»å€èŒƒå›´æ¯”è™šæ‹Ÿåœ°å€èŒƒå›´å¤§</li></ol><p>å†…æ ¸çš„åˆ†åŒºæœ‰å››ç§ï¼š</p><ol><li><strong>ZONE_DMA</strong>ï¼šå¯æ‰§è¡Œ DMA æ“ä½œçš„é¡µé›†åˆ</li><li>ZONE_DMA32ï¼šåŒä¸Šï¼Œä½†ä»…é™äº 32 ä½è®¾å¤‡</li><li><strong>ZONE_NORMAL</strong>ï¼šèƒ½å¤Ÿæ­£å¸¸æ˜ å°„çš„é¡µ</li><li>ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­çš„é¡µä¸èƒ½æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼ˆè¿™é‡Œé™äº 32 ä½åœ°å€ç©ºé—´ï¼Œ64 ä½å°±ä¸ä¼šæœ‰é—®é¢˜äº†ï¼‰</li></ol><h2 id="é¡µç”³è¯·å’Œé‡Šæ”¾"><a href="#é¡µç”³è¯·å’Œé‡Šæ”¾" class="headerlink" title="é¡µç”³è¯·å’Œé‡Šæ”¾"></a>é¡µç”³è¯·å’Œé‡Šæ”¾</h2><ol><li><code>alloc_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘é¡µç»“æ„çš„æŒ‡é’ˆ</li><li><code>alloc_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­é¡µ</li><li><code>__get_free_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘å…¶é€»è¾‘åœ°å€çš„æŒ‡é’ˆ</li><li><code>__get_free_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­ç‰©ç†é¡µï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>get_zeroed_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œä¸”å¡«å…… 0 ï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>__free_pages(struct page *page, unsinged int order)</code></li><li><code>free_pages(unsigned long addr, unsinged int order)</code></li><li><code>free_page(unsigned long addr)</code></li></ol><h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p><code>void *kmalloc(size_t size, gfp_t flags)</code>ï¼Œ<code>kmalloc()</code> ç±»ä¼¼äº <code>malloc()</code>ï¼Œå¯ä»¥è·å¾—æŒ‡å®šå­—èŠ‚å¤§å°çš„å†…æ ¸å†…å­˜ï¼Œå®ƒåˆ†é…å¾—åˆ°çš„é¡µçš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯è¿ç»­çš„ã€‚<br><code>void kfree(const void *ptr)</code> é‡Šæ”¾åˆ†é…çš„å†…å­˜ç©ºé—´</p><p>å…³äºæ ‡è®°ä½ï¼Œå¸¸ç”¨çš„æ˜¯ GFP_KERNELï¼Œå…è®¸ç¡çœ ï¼Œç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ç©ºé—´ï¼›å¦å¤–çš„ GFP_ATOMICï¼Œåˆ™ä¸å¯ä»¥ç¡çœ ï¼Œå¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ã€ä¸­æ–­å¤„ç†ç¨‹åºã€è½¯ä¸­æ–­ã€taskletã€‚</p><h2 id="vmalloc"><a href="#vmalloc" class="headerlink" title="vmalloc"></a>vmalloc</h2><p><code>vmalloc()</code> ç±»ä¼¼ <code>kmalloc()</code>ï¼Œä¸åŒçš„æ˜¯ï¼Œå®ƒåˆ†é…çš„å†…å­˜è™šæ‹Ÿåœ°å€è™½ç„¶æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å®é™…çš„ç‰©ç†åœ°å€æ— éœ€è¿ç»­ã€‚å®ƒé€šè¿‡åˆ†é…éè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†ã€Œä¿®æ­£ã€é¡µè¡¨ï¼Œä»è€ŒæŠŠå†…å­˜æ˜ å°„åˆ°é€»è¾‘åœ°å€ç©ºé—´è¿ç»­çš„åŒºåŸŸã€‚å®ƒéœ€è¦ä¸“é—¨çš„é¡µè¡¨æ¥å®Œæˆè¿ç»­è™šæ‹Ÿåœ°å€åˆ°å®é™…éè¿ç»­ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œå¼€é”€è¾ƒå¤§ï¼Œä¸”å®¹æ˜“å¼•èµ· TLB æŠ–åŠ¨ï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­æ›´å€¾å‘äºä½¿ç”¨ <code>kmalloc()</code>ã€‚</p><h2 id="slab-å±‚"><a href="#slab-å±‚" class="headerlink" title="slab å±‚"></a>slab å±‚</h2><p>slab å±‚å……å½“é€šç”¨æ•°æ®ç»“æ„çš„ç¼“å­˜å±‚çš„è§’è‰²ï¼Œå®ƒä¼šä¸ºä¸åŒçš„å¯¹è±¡åˆ’åˆ†æˆä¸åŒçš„é«˜é€Ÿç¼“å­˜ç»„ï¼Œæ¯ç»„å­˜æ”¾ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œå­˜æ”¾ task_struct å’Œ inode å°±åˆ†å±äºä¸åŒçš„ç»„ã€‚kmalloc() ä¹Ÿæ˜¯åŸºäº slab å±‚ä¹‹ä¸Šï¼Œä½¿ç”¨äº†ä¸€ç»„é€šç”¨é«˜é€Ÿç¼“å­˜ã€‚</p><p>slab åˆ†é…å™¨å¼•å…¥çš„ç›®çš„ï¼š</p><ol><li>é¿å…é¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡éœ€è¦é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾ï¼Œé™ä½å¼€é”€</li><li>é¢‘ç¹åˆ†é…å›æ”¶å®¹æ˜“å¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œå‡å°‘ç¢ç‰‡é—®é¢˜</li><li>æé«˜æ€§èƒ½</li><li>éƒ¨åˆ†ç¼“å­˜ä¸“å±äºæŸä¸ªå¤„ç†å™¨æ—¶ï¼Œå¯ä»¥å®ç°æ— é”åˆ†é…å’Œé‡Šæ”¾ï¼ˆtcmallocï¼‰</li></ol><p><img src="https://pic1.zhimg.com/80/v2-1540217805cb1d2ee083d293209bbbaf_r.png" alt=""></p><h1 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰" class="headerlink" title="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"></a>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</h1><p>VFS æ˜¯ Linux æä¾›çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼Œæ¶µç›–äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¸¸ç”¨åŠŸèƒ½é›†å’Œè¡Œä¸ºï¼Œä»è€Œæ”¯æŒå„ç§å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NTFS, FAT, EXT4ï¼‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ç©ºé—´ write() -&gt; VFS sys_write() -&gt; æ–‡ä»¶ç³»ç»Ÿçš„å†™æ–¹æ³• -&gt; å­˜å‚¨è®¾å¤‡</span><br></pre></td></tr></table></figure></p><p>Unix æ–‡ä»¶ç³»ç»Ÿä¼ ç»ŸæŠ½è±¡æ¦‚å¿µï¼šFile, DirectoryEntry, Index Node å’Œ Mount Pointã€‚Unix æ–‡ä»¶çš„ç‰¹ç‚¹æ˜¯é¢å‘å­—èŠ‚æµæŠ½è±¡è®¾è®¡çš„ï¼Œå…·æœ‰ç®€å•ã€çµæ´»çš„ç‰¹æ€§ã€‚åœ¨ Unix ä¸­ï¼Œç›®å½•ä¹Ÿæ˜¯æ™®é€šæ–‡ä»¶ï¼Œå…¶åˆ—å‡ºäº†åŒ…å«åœ¨ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ã€‚</p><p>VFS ä¸­çš„ä¸»è¦å¯¹è±¡ï¼š</p><ol><li>è¶…çº§å—å¯¹è±¡ï¼Œä»£è¡¨å…·ä½“å·²å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶</li><li>ç›®å½•é¡¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ†</li><li>æ–‡ä»¶å¯¹è±¡ï¼Œä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼ˆå…¶å®å®ƒä¼šæŒ‡å‘ç›®å½•é¡¹å¯¹è±¡ï¼Œè€Œç›®å½•é¡¹å¯¹è±¡æ‰æ˜¯çœŸæ­£è¡¨ç¤ºå·²æ‰“å¼€çš„å®é™…æ–‡ä»¶ï¼Œå› ä¸ºå…¶ä¸­åŒ…å«äº†æŒ‡å‘ inode çš„æŒ‡é’ˆï¼‰</li></ol><h1 id="å—-I-O"><a href="#å—-I-O" class="headerlink" title="å— I/O"></a>å— I/O</h1><p>Linux ä¸­ï¼Œè®¾å¤‡åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li><strong>å—è®¾å¤‡</strong>ï¼šæ”¯æŒéšæœºè®¿é—®å›ºå®šå¤§å°çš„æ•°æ®å—ï¼Œå¦‚ç¡¬ç›˜ã€é—ªå­˜</li><li><strong>å­—ç¬¦è®¾å¤‡</strong>ï¼šä»¥å­—ç¬¦æµçš„å½¢å¼è¢«è®¿é—®ï¼Œå¦‚é”®ç›˜</li><li><strong>ç½‘ç»œè®¾å¤‡</strong></li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹å—è®¾å¤‡çš„è¯·æ±‚ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·åœ¨ I/O è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå¹¶ä¸”ç”± I/O è°ƒåº¦ç¨‹åºæ¥ç®¡ç†è¯·æ±‚é˜Ÿåˆ—ã€‚å®ƒä¼šå†³å®šè¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚<strong>å¦‚ä½•æ’åº</strong>ï¼Œä»¥åŠ<strong>ä½•æ—¶</strong>å‘é€åˆ°å…·ä½“çš„å—è®¾å¤‡ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œå°±æ˜¯æœŸæœ›å€ŸåŠ© I/O è°ƒåº¦ç¨‹åºï¼Œå¯¹è¯·æ±‚è¿›è¡Œ<strong>åˆå¹¶</strong>å’Œ<strong>æ’åº</strong>ï¼Œä»è€Œæœ‰æ•ˆæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼ˆä¹Ÿå¯èƒ½é€ æˆæŸäº›è¯·æ±‚å¾—ä¸åˆ°å…¬å¹³å¯¹å¾…ï¼Œç”šè‡³å‡ºç°é¥¥é¥¿çš„æƒ…å†µï¼‰ã€‚ä»¥ä¸‹è®°å½•çš„æ˜¯ Linux ä¸­å·²ç»å®ç°çš„å‡ ç§ I/O è°ƒåº¦ç®—æ³•ï¼š</p><ol><li><p><strong>Linus ç”µæ¢¯</strong></p><ol><li>æ”¯æŒå‘å‰å’Œå‘ååˆå¹¶ï¼ˆé€šå¸¸éƒ½æ˜¯è¿™ç§å±…å¤šï¼‰</li><li>æœ‰è¾ƒå¥½çš„å…¨å±€ååé‡</li><li>ä¼šå‘ç”Ÿè¯·æ±‚é¥¥é¥¿é—®é¢˜</li></ol></li><li><p><strong>æœ€ç»ˆæœŸé™ï¼ˆdeadlineï¼‰ I/O è°ƒåº¦</strong></p><ol><li>é™ä½äº†ç³»ç»Ÿçš„å…¨å±€ååé‡</li><li>è¯»è¯·æ±‚è¶…æ—¶ 500msï¼Œå†™è¯·æ±‚è¶…æ—¶ 5sï¼Œè¶…æ—¶å¿…ç„¶å¾—åˆ°æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´é¥¥é¥¿çš„é—®é¢˜</li></ol></li><li><p><strong>é¢„æµ‹ï¼ˆanticipatoryï¼‰ I/O è°ƒåº¦</strong></p><ol><li>ç›®æ ‡æ˜¯ä¿æŒè¾ƒå¥½çš„è¯»å“åº”åŒæ—¶ï¼Œæä¾›è‰¯å¥½çš„å…¨å±€ååé‡ã€‚è§†å›¾å‡å°‘åœ¨è¿›è¡Œ I/O æ“ä½œæœŸé—´ï¼Œå¤„ç†æ–°åˆ°çš„è¯»è¯·æ±‚å¸¦æ¥çš„å¯»å€æ•°é‡</li><li>è¯·æ±‚æäº¤åä¸ä¼šç›´æ¥è¿”å›å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œè€Œä¼šç©ºé—²ç‰‡åˆ»ï¼ˆå‡ æ¯«ç§’ï¼‰ï¼Œç­‰å¾…åº”ç”¨æäº¤å…¶å®ƒè¯»è¯·æ±‚</li></ol></li><li><p><strong>å®Œå…¨å…¬å¹³æ’é˜Ÿ I/O è°ƒåº¦ï¼ˆCFQï¼‰</strong></p><ol><li>ä¸ºç‰¹æ®Šå·¥ä½œè´Ÿè½½çš„åœºæ™¯è®¾è®¡ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è¯·æ±‚é˜Ÿåˆ—</li><li>ä»¥æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚</li></ol></li></ol><h1 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h1><p>ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡é‡‡ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œç»™æ¯ä¸ªè¿›ç¨‹è¥é€ äº†ç‹¬äº«å†…å­˜çš„å‡è±¡ï¼Œè¿™æ˜¯å†…å­˜è™šæ‹ŸåŒ–çš„é‡è¦æœºåˆ¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°ä»£é‡‡ç”¨è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿé€šå¸¸éƒ½ä½¿ç”¨å¹³å¦åœ°å€ç©ºé—´ï¼Œè€Œéåˆ†æ®µå¼çš„å†…å­˜æ¨¡å¼ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å­˜åœ°å€ç©ºé—´ä¼šæ ¹æ®éœ€è¦åˆ’åˆ†æˆä¸åŒçš„åŒºåŸŸã€‚å†…æ ¸å¯ä»¥ç»™è¿›ç¨‹åœ°å€ç©ºé—´åŠ¨æ€æ·»åŠ æˆ–å‡å°‘å†…å­˜åŒºåŸŸã€‚æ¯ä¸ªè¿›ç¨‹åªèƒ½è®¿é—®æœ‰æ•ˆå†…å­˜åŒºåŸŸå†…çš„å†…å­˜åœ°å€ï¼Œæ¯ä¸ªå†…å­˜åŒºåŸŸä¼šåŒ…å«æƒé™ç­‰å±æ€§ã€‚<strong>è¿›ç¨‹ä¸­ä»»æ„æœ‰æ•ˆåœ°å€åªèƒ½ä½äºå”¯ä¸€çš„åŒºåŸŸï¼Œä¸”è¿™äº›åŒºåŸŸä¸èƒ½ç›¸äº’è¦†ç›–</strong>ã€‚</p><p>å†…å­˜åŒºåŸŸå¯ä»¥åŒ…å«å„ç§å†…å­˜å¯¹è±¡ï¼š</p><ol><li>å¯æ‰§è¡Œæ–‡ä»¶ä»£ç çš„å†…å­˜æ˜ å°„ï¼Œtext section</li><li>å¯æ‰§è¡Œæ–‡ä»¶å·²åˆå§‹åŒ–å…¨å±€å˜é‡çš„å†…å­˜æ˜ å°„ï¼Œdata section</li><li>åŒ…å«æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒBSS æ®µçš„é›¶é¡µçš„å†…å­˜æ˜ å°„</li><li>è¿›ç¨‹ç”¨æˆ·ç©ºé—´æ ˆçš„é›¶é¡µå†…å­˜æ˜ å°„</li><li>æ¯ä¸ªä¸€ä¸ªè¯¸å¦‚ C åº“æˆ–åŠ¨æ€è¿æ¥ç¨‹åºç­‰å…±äº«çš„  text section, data section å’Œ bss ä¹Ÿè¢«è½½å…¥åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</li><li>å†…å­˜æ˜ å°„æ–‡ä»¶</li><li>å…±äº«å†…å­˜æ®µ</li><li>åŒ¿åæ˜ å°„ï¼Œå¦‚ malloc() åˆ†é…çš„å†…å­˜</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm_struct -&gt; vm_area_struct</span><br></pre></td></tr></table></figure><h2 id="64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"><a href="#64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€" class="headerlink" title="64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"></a>64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€</h2><p><img src="https://pic4.zhimg.com/80/v2-5f2b9c321b7100a11e2dae9e48bce81f_r.png" alt=""><br>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ 64bit çš„åœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨ä¸€åŠçš„åœ°å€ç©ºé—´ï¼ˆ128 TiBï¼‰ï¼Œè€Œå¦ä¸€åŠåˆ™æ˜¯å†…æ ¸ç©ºé—´ä½¿ç”¨ã€‚å†…æ ¸é€šå¸¸é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šè¢«æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å½“ä¸­ã€‚è€Œåœ¨å†…æ ¸ä¸­ï¼Œæ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚è¯¦ç»†çš„å†…å­˜å¸ƒå±€å¯ä»¥å‚è€ƒåé¢çš„å­¦ä¹ èµ„æ–™~</p><h2 id="é¡µè¡¨"><a href="#é¡µè¡¨" class="headerlink" title="é¡µè¡¨"></a>é¡µè¡¨</h2><p>Linux ä¸­ä½¿ç”¨ä¸‰çº§é¡µè¡¨å®Œæˆåœ°å€è½¬æ¢ï¼Œä½¿ç”¨å¤šçº§é¡µè¡¨å¯ä»¥èŠ‚çº¦åœ°å€è½¬æ¢éœ€è¦å ç”¨çš„ç©ºé—´ã€‚ä½†ç”±äºå®Œæˆè™šæ‹Ÿé¡µåœ°å€åˆ°ç‰©ç†é¡µåœ°å€è½¬æ¢éƒ½éœ€è¦åœ¨ä¸‰çº§é¡µè¡¨ä¸­æŸ¥æ‰¾åˆ°æ˜ å°„ï¼Œå¼€é”€æ¯”è¾ƒé«˜ã€‚æ‰€ä»¥å¾ˆå¤šä½“ç³»ç»“æ„æä¾›äº† TLB ä½œä¸ºåœ°å€æ˜ å°„çš„ç¡¬ä»¶ç¼“å­˜ã€‚<br><img src="https://pic4.zhimg.com/80/v2-e7ae1f0fcc4b3a1d0af4e65a1ca04101_r.png" alt=""><br><img src="https://pic4.zhimg.com/80/v2-ff24fef84f1c136922f8bf1f5679ea99_hd.png" alt=""></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»ä½“ä¸Šæ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯æ¯”è¾ƒé€‚åˆå¯¹æ“ä½œç³»ç»ŸåŸºæœ¬æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¸”å¯¹äº Linux å†…æ ¸ä¹Ÿæœ‰ä¸€ç‚¹äº†è§£çš„å‰æä¸‹é˜…è¯»ï¼Œå¦åˆ™åœ¨çœ‹åˆ°ä¸€äº›æ¦‚å¿µçš„æ—¶å€™ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ¯”å¦‚å¯¹äºè¿›ç¨‹ã€çº¿ç¨‹çš„æŠ½è±¡å®šä¹‰ï¼Œè™šæ‹Ÿå†…å­˜ä¸­è®²åˆ°çš„åˆ†é¡µã€åˆ†æ®µæ¦‚å¿µä»¥åŠå¤šçº§é¡µè¡¨çš„æ¦‚å¿µã€‚å¦å¤–ï¼Œå¯¹äºå¸¸ç”¨æ•°æ®ç»“æ„éœ€è¦æœ‰æ¸…æ™°çš„è®¤è¯†ï¼›å¹¶å‘ç›¸å…³çš„åŒæ­¥é—®é¢˜ä¹Ÿæœ‰äº†è§£ã€‚<br>è™½ç„¶æ•´æœ¬ä¹¦æ˜¯åŸºäº Linux 2.6.3x å†…æ ¸ä¸ºåŸºç¡€çš„ï¼Œå¦‚ä»Šçš„ Linux å†…æ ¸å·²ç»å‘å±•åˆ° 5.x æ—¶ä»£äº†ï¼Œè¿™æœŸé—´å˜åŒ–è‚¯å®šæœ‰å¾ˆå¤šã€‚ä½†è¿™æœ¬ä¹¦çš„ä»·å€¼è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå…¶ä¸­è®²å¾—å¾ˆå¤šæ€æƒ³ã€æ–¹æ³•ä¾ç„¶å®ç”¨ï¼Œå¯ä»¥å˜é€šåœ°å»çœ‹å¾…å’Œç†è§£ã€‚</p><h1 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h1><ol><li>POSIX: Portable Operating System Interface</li><li>TLB: Translation Lookup Buffer</li><li>CFS: Complete Fair Scheduler</li><li>CFQ: Complete Fair Queueingï¼Œè¿™ä¸ªæ˜¯ IO è°ƒåº¦å™¨ä¹‹ä¸€</li><li>VFS: Virtual File System</li><li>VMA: Virtual Memory Area</li><li>MMU: Memory Map Unit</li><li>jiffies: Linux ä¸­ç”¨æ¥è®°å½•ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ•°çš„å…¨å±€å˜é‡ï¼Œè¿˜æœ‰ä¸€ä¸ª jiffies_64</li><li>ISR: Interrupt Service Routine</li></ol><h1 id="æ·±å…¥å­¦ä¹ "><a href="#æ·±å…¥å­¦ä¹ " class="headerlink" title="æ·±å…¥å­¦ä¹ "></a>æ·±å…¥å­¦ä¹ </h1><ul><li>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç° Linux Kernel Developmentï¼Œç¬¬ 3 ç‰ˆã€‹</li><li><a href="https://unix.stackexchange.com/questions/364660/are-threads-implemented-as-processes-on-linux" target="_blank" rel="noopener">Are Threads Implemented As Processes on Linux</a></li><li><a href="https://zh.wikipedia.org/wiki/POSIX%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">POSIX çº¿ç¨‹</a></li><li><a href="https://juejin.im/post/5d23326d6fb9a07efe2de11e" target="_blank" rel="noopener">Linux çº¿ç¨‹å®ç°</a></li><li><a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux Sched Doc CFS</a></li><li><a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a></li><li><a href="https://www.win.tue.nl/~aeb/linux/lk/lk-9.html" target="_blank" rel="noopener">Linux Memory</a></li><li><a href="https://www.it.iitb.ac.in/frg/wiki/images/f/fc/113050076_Rajesh_Prodduturi_week5_presentation_3_2012-08-04.pdf" target="_blank" rel="noopener">Linux memory management</a></li><li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">x86_64 å†…å­˜æ˜ å°„</a></li><li><a href="https://simonis.github.io/Memory/" target="_blank" rel="noopener">The Memory Layout of a 64-bit Linux Process</a></li><li><a href="https://stackoverflow.com/questions/55443733/linux-kernel-memory-layout" target="_blank" rel="noopener">Linux kernel memory layout</a></li><li><a href="https://www.kernel.org/doc/gorman/html/understand/understand006.html" target="_blank" rel="noopener">Chapter 3 Page Table Management</a></li><li><a href="https://ifaceless.space/2019/11/18/linux-kernel-scheduler-papers/">Linux è°ƒåº¦å™¨èµ„æ–™æ•´ç†</a></li><li><a href="https://makelinux.github.io/kernel_map/" target="_blank" rel="noopener">Linux Kernel Map</a></li><li><a href="https://hackernoon.com/entering-god-mode-the-kernel-space-mirroring-attack-8a86b749545f" target="_blank" rel="noopener">Entering God Mode â€” The Kernel Space Mirroring Attack</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æŠ½æ—¶é—´æŠŠ &lt;a href=&quot;http://pages.cs.wisc.edu/~remzi/OSTEP/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;em&gt;Operating Systems: Three Easy Pieces&lt;/em&gt;&lt;/a&gt; ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´ ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆ&lt;em&gt;Linux Kernel Development&lt;/em&gt;ï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://ifaceless.space/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="http://ifaceless.space/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://ifaceless.space/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
      <category term="æ–‡ä»¶ç³»ç»Ÿ" scheme="http://ifaceless.space/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>é™æµç®—æ³•å­¦ä¹ ï¼šæ¼æ¡¶ &amp; ä»¤ç‰Œæ¡¶ç®—æ³•</title>
    <link href="http://ifaceless.space/2019/10/11/rate-limit-policies/"/>
    <id>http://ifaceless.space/2019/10/11/rate-limit-policies/</id>
    <published>2019-10-11T13:20:11.000Z</published>
    <updated>2019-11-28T09:41:31.559Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ¬èŠ‚ä¸»è¦å­¦ä¹ ä¸‹ä¸¤ç§å¸¸ç”¨çš„å•æœºé™æµæ€æƒ³ï¼Œåˆ†åˆ«æ˜¯<strong>æ¼æ¡¶ç®—æ³•</strong>å’Œ<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>ã€‚æ­¤å¤–ï¼Œè¿˜å°†ç»™å‡ºä½¿ç”¨ Python åŠ Go è¯­è¨€å®ç°ï¼Œä¾¿äºåŠ æ·±ç†è§£ã€‚å½“ç„¶ï¼Œç°å®ä¸­è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ä¸‹é¢çš„ä»£ç ã€‚å®é™…åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨å•æœºæ‰§è¡Œé™æµï¼Œä¸‹é¢çš„å®ç°ä¹Ÿå¹¶éçº¿ç¨‹æˆ– goroutine å®‰å…¨çš„ã€‚<br><a id="more"></a><br>å®é™…é™æµå¯ä»¥è€ƒè™‘åœ¨ Nginx å±‚å¯¹è¯·æ±‚é™æµï¼Œæˆ–è€…å¦‚æœçœŸçš„è¦è‡ªå·±åœ¨ä¸šåŠ¡æ–¹å®ç°ä¸€å¥—é™æµç­–ç•¥çš„è¯ï¼Œå¯ä»¥è€ƒè™‘åŸºäº Redis å®ç°åˆ†å¸ƒå¼é™æµç­–ç•¥ã€‚å¹¶ä¸”åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½è¿˜ä¼šåŸºäºä¸åŒçš„ç»´åº¦è¿›è¡Œé™æµï¼Œå¦‚ç”¨æˆ· idï¼Œè¯·æ±‚ IP ç­‰ï¼Œå®é™…åº”ç”¨éœ€è¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šã€‚</p><h1 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h1><p>å¯ä»¥æŠŠè¯·æ±‚å½“ä½œæ°´æµï¼Œæ°´æµå…¨éƒ¨è¿›å…¥æœ‰é™å¤§å°çš„æ°´ç¼¸ï¼ŒåŒæ—¶æ°´ç¼¸ä¼šæŒ‰ç…§å›ºå®šçš„é€Ÿç‡æ¼æ°´ã€‚å½“æ°´æµæ¹æ€¥ï¼Œæ°´ç¼¸æ¼æ°´å¤ªæ…¢çš„è¯ï¼Œä¼šå¾—çŸ¥æ°´ç¼¸ç§¯æ°´ï¼Œç›´åˆ°æº¢å‡ºï¼ˆæ­¤æ—¶æ‹’ç»æœåŠ¡ï¼‰ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-bdf9f813d2f9d8622174e9e58be308b6_hd.png" alt=""></p><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol><li>å®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»¥æ¯”è¾ƒæ’å®šçš„é€Ÿç‡æœåŠ¡è¯·æ±‚</li><li>ç¼ºç‚¹æ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æº¢å‡º</li></ol><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeakyBucketRateLimiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity=<span class="number">10</span>, leak_rate=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–æ¼æ¡¶</span></span><br><span class="line"><span class="string">        :param capacity: æ¡¶å®¹é‡</span></span><br><span class="line"><span class="string">        :param leak_rate: æ’å®šçš„æ¶ˆè´¹é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._capacity = float(capacity)</span><br><span class="line">        self._leak_rate = float(leak_rate)</span><br><span class="line">        self._water_level = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´</span></span><br><span class="line">        self._last_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, level=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="comment"># æ‰§è¡Œæ¼æ°´</span></span><br><span class="line">        now = time.time()</span><br><span class="line">        delta = self._water_level - self._leak_rate * (now - self._last_time)</span><br><span class="line">        self._water_level = min(<span class="number">0.0</span>, delta)</span><br><span class="line">        self._last_time = now</span><br><span class="line">        <span class="comment"># å°è¯•åŠ æ°´ï¼Œå¹¶çœ‹æ°´æ¡¶æ˜¯å¦æ»¡äº†</span></span><br><span class="line">        <span class="keyword">if</span> level + self._water_level &gt; self._capacity:</span><br><span class="line">            <span class="keyword">raise</span> RateLimitExceeded()</span><br><span class="line">        self._water_level += level</span><br></pre></td></tr></table></figure><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LeakyBucketRateLimiter <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    currentLevel <span class="keyword">int</span></span><br><span class="line">    leakRate <span class="keyword">int</span> <span class="comment">// consume how many requests per sec</span></span><br><span class="line">    lastLeakedAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLeakyBucketRateLimitter</span><span class="params">(capacity, leakRate <span class="keyword">int</span>)</span> *<span class="title">LeakyBucketRateLimiter</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;LeakyBucketRateLimiter&#123;</span><br><span class="line">        capacity: capacity,</span><br><span class="line">        currentLevel: <span class="number">0</span>,</span><br><span class="line">        leakRate: leakRate,</span><br><span class="line">        lastLeakedAt: time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *LeakyBucketRateLimiter)</span> <span class="title">Acquire</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    now := time.Now()</span><br><span class="line">    <span class="comment">// leak water</span></span><br><span class="line">    currentLevel := r.currentLevel - r.leakRate*<span class="keyword">int</span>(now.Sub(r.lastLeakedAt).Seconds())</span><br><span class="line">    r.currentLevel = max(currentLevel, <span class="number">0</span>)</span><br><span class="line">    r.lastLeakedAt = now</span><br><span class="line">    <span class="comment">// try to add water, test bucket is full or not.</span></span><br><span class="line">    currentLevel = n + r.currentLevel</span><br><span class="line">    <span class="keyword">if</span> currentLevel &gt; r.capacity &#123;</span><br><span class="line">        <span class="keyword">return</span> errRateLimitExceeds</span><br><span class="line">    &#125;</span><br><span class="line">    r.currentLevel = currentLevel</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h1><p>åŒæ ·æƒ³è±¡æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¡¶ï¼Œä¸“é—¨å­˜æ”¾ä»¤ç‰Œï¼Œä¼šä»¥æ’å®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå¹¶å°†å…¶æ”¾å…¥æ¡¶ä¸­ã€‚æ¯å½“æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œéœ€è¦å…ˆä»æ¡¶ä¸­å–åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»¤ç‰Œï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¦åˆ™æ‹’ç»æœåŠ¡ã€‚</p><p><img src="https://pic3.zhimg.com/80/v2-f2b510a893be6ff316bbde684b70c2e2_hd.png" alt=""></p><h2 id="ç‰¹ç‚¹-1"><a href="#ç‰¹ç‚¹-1" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol><li>å®ç°åŒæ ·æ˜¯å¾ˆç®€å•</li><li>å¯ä»¥åº”å¯¹çªå‘æµé‡ï¼Œé¢å¯¹ç¬é—´å¤§æµé‡ï¼Œå¯ä»¥åœ¨çŸ­æ—¶é—´å†…è·å¾—å¤§é‡ä»¤ç‰Œï¼Œä¸”ç”Ÿäº§ä»¤ç‰Œæ¯«ä¸è´¹åŠ›</li><li>å¯ä»¥åšæµé‡æ•´å½¢</li></ol><h2 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenBucketRateLimiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity=<span class="number">1</span>, fill_rate=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–ä»¤ç‰Œæ¡¶é™æµå™¨</span></span><br><span class="line"><span class="string">        :param capacity: ä»¤ç‰Œæ¡¶å®¹é‡</span></span><br><span class="line"><span class="string">        :param fill_rate: æ”¾å…¥ä»¤ç‰Œçš„é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._capacity = float(capacity)</span><br><span class="line">        self._rate = float(fill_rate)</span><br><span class="line">        self._bucket_tokens = float(capacity)</span><br><span class="line">        <span class="comment"># ä¸Šæ¬¡æ·»åŠ ä»¤ç‰Œçš„æ—¶é—´</span></span><br><span class="line">        self._last_time = int(time.time())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, tokens=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="comment"># å‘æ”¾ä»¤ç‰Œ</span></span><br><span class="line">        <span class="keyword">if</span> self._bucket_tokens &lt; self._capacity:</span><br><span class="line">            now = time.time()</span><br><span class="line">            delta = (now - self._last_time) * self._rate</span><br><span class="line">            self._last_time = now</span><br><span class="line">            self._bucket_tokens = min(self._capacity, self._bucket_tokens + delta)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tokens &gt; self._bucket_tokens:</span><br><span class="line">            <span class="comment"># æ— æ³•è·å–ä»¤ç‰Œäº†ï¼Œæ•°é‡ä¸å¤Ÿ</span></span><br><span class="line">            <span class="keyword">raise</span> RateLimitExceeded()</span><br><span class="line">        self._bucket_tokens -= tokens</span><br></pre></td></tr></table></figure><h3 id="Go-1"><a href="#Go-1" class="headerlink" title="Go"></a>Go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TokenBucketRateLimiter <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    tokens <span class="keyword">int</span></span><br><span class="line">    putRate <span class="keyword">int</span> <span class="comment">// put how many tokens per sec</span></span><br><span class="line">    lastPutAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTokenBucketRateLimiter</span><span class="params">(capacity, fillRate <span class="keyword">int</span>)</span> *<span class="title">TokenBucketRateLimiter</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;TokenBucketRateLimiter&#123;</span><br><span class="line">        capacity: capacity,</span><br><span class="line">        tokens: <span class="number">0</span>,</span><br><span class="line">        putRate: fillRate,</span><br><span class="line">        lastPutAt: time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *TokenBucketRateLimiter)</span> <span class="title">Acquire</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r.tokens &lt; r.capacity &#123;</span><br><span class="line">        <span class="comment">// put tokens in the bucket</span></span><br><span class="line">        now := time.Now()</span><br><span class="line">        howMany := r.putRate * <span class="keyword">int</span>(now.Sub(r.lastPutAt).Seconds())</span><br><span class="line">        r.tokens = min(r.capacity, howMany+r.tokens)</span><br><span class="line">        r.lastPutAt = now</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check if we have enough tokens</span></span><br><span class="line">    <span class="keyword">if</span> r.tokens &lt; n &#123;</span><br><span class="line">        <span class="keyword">return</span> errRateLimitExceeds</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// release tokens</span></span><br><span class="line">    r.tokens -= n</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://segmentfault.com/a/1190000015967922" target="_blank" rel="noopener">æ¥å£é™æµç®—æ³•ä»‹ç»</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ¬èŠ‚ä¸»è¦å­¦ä¹ ä¸‹ä¸¤ç§å¸¸ç”¨çš„å•æœºé™æµæ€æƒ³ï¼Œåˆ†åˆ«æ˜¯&lt;strong&gt;æ¼æ¡¶ç®—æ³•&lt;/strong&gt;å’Œ&lt;strong&gt;ä»¤ç‰Œæ¡¶ç®—æ³•&lt;/strong&gt;ã€‚æ­¤å¤–ï¼Œè¿˜å°†ç»™å‡ºä½¿ç”¨ Python åŠ Go è¯­è¨€å®ç°ï¼Œä¾¿äºåŠ æ·±ç†è§£ã€‚å½“ç„¶ï¼Œç°å®ä¸­è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ä¸‹é¢çš„ä»£ç ã€‚å®é™…åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨å•æœºæ‰§è¡Œé™æµï¼Œä¸‹é¢çš„å®ç°ä¹Ÿå¹¶éçº¿ç¨‹æˆ– goroutine å®‰å…¨çš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/tags/Web-%E5%BC%80%E5%8F%91/"/>
    
      <category term="é™æµ" scheme="http://ifaceless.space/tags/%E9%99%90%E6%B5%81/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Go è¯­è¨€å®ç°ä¸€ä¸ªç®€å•çš„ LRU Cache</title>
    <link href="http://ifaceless.space/2019/09/22/implement-lru-cache-in-go/"/>
    <id>http://ifaceless.space/2019/09/22/implement-lru-cache-in-go/</id>
    <published>2019-09-22T13:28:32.000Z</published>
    <updated>2019-11-28T09:41:31.555Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>LRU (Least-Recently-Used) Cache æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥å°†ä¸€äº›çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿›è€Œæé«˜æ¥å£çš„å“åº”é€Ÿåº¦ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œcache miss åï¼Œå®é™…å¯èƒ½ä¼šå›æºåˆ° Redis é›†ç¾¤è·å–ç¼“å­˜æ•°æ®ï¼Œå¦‚æœ Redis é›†ç¾¤ä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå›æºæ•°æ®åº“ã€‚ä¹Ÿå°±æ˜¯å¼•å…¥ LRU Cache åç›¸å½“äºç»™åº”ç”¨å±‚æ·»åŠ äº†ä¸€çº§é«˜é€Ÿç¼“å­˜ã€‚å½“ç„¶ï¼Œæ›´ä¸ºå®é™…ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„ LRU Cacheï¼Œå¦åˆ™åå°æ›´æ–°äº†è¯¾ç¨‹æ•°æ®ï¼Œç”±äºå†…å­˜ç¼“å­˜çš„åŸå› è€Œå¾—ä¸åˆ°åŠæ—¶æ›´æ–°ã€‚<br><a id="more"></a><br>æœ¬èŠ‚ä¸»è¦æ˜¯å­¦ä¹ ä¸‹ LRU Cache å®ç°åŸç†ï¼Œåªæ¢è®¨æœ€æ ¸å¿ƒçš„å®ç°æ€æƒ³ï¼Œä¸è€ƒè™‘å¤æ‚çš„æƒ…å†µï¼ˆå¦‚ goroutine å®‰å…¨ï¼Œç¼“å­˜å¸¦è¿‡æœŸæ—¶é—´ç­‰ï¼‰ã€‚</p><h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><p>LRU Cache æä¾›çš„åŠŸèƒ½æœ‰ä¸¤ä¸ªï¼š</p><ol><li>é¡¾åæ€ä¹‰ï¼Œç¼“å­˜èƒ½åŠ›</li><li>å½“ç¼“å­˜ç©ºé—´æ»¡äº†åï¼Œä¼šå°†æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹åˆ é™¤æ‰ï¼Œä»è€Œä¸ºæ–°çš„ key/value æä¾›ç¼“å­˜ç©ºé—´</li></ol><p>å…·ä½“å®ç°çš„æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>éœ€è¦ä½¿ç”¨ä¸€ä¸ª map ç»´æŠ¤ key -&gt; entry node çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œèƒ½å¤ŸåŸºäºæ­¤å¿«é€Ÿæ‰¾åˆ°ç›¸å…³çš„èŠ‚ç‚¹ï¼›</li><li>éœ€è¦ä½¿ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥ç»´æŠ¤ entry nodeï¼›</li><li><code>cache.set</code> æ—¶ï¼Œéœ€è¦é¦–å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦è¶…å‡ºç•Œé™äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œéœ€è¦å°†é“¾è¡¨å°¾å·´ï¼ˆå³æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹ï¼‰ç§»é™¤ï¼›ç„¶åå°†æ–°çš„èŠ‚ç‚¹æ’å…¥åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¹¶åœ¨ map ä¸­åˆ·æ–° key å¯¹åº”çš„ entry node æŒ‡é’ˆï¼›</li><li><code>cache.get</code> æ—¶ï¼Œå¦‚æœ hit åˆ°ç¼“å­˜äº†ï¼Œåˆ™å°†å¯¹åº”çš„ entry node è°ƒæ•´åœ¨é“¾è¡¨å¤´éƒ¨ï¼Œä¿è¯æœ€é¢‘ç¹çš„èŠ‚ç‚¹å§‹ç»ˆå¾€å‰é ã€‚</li></ol><h1 id="åŠ¨æ‰‹å®ç°"><a href="#åŠ¨æ‰‹å®ç°" class="headerlink" title="åŠ¨æ‰‹å®ç°"></a>åŠ¨æ‰‹å®ç°</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package lrucache implements a cache with limited capacity, which evicts</span></span><br><span class="line"><span class="comment">// least-used-entry when it overflows.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Caution: not production ready, not goroutine safe.</span></span><br><span class="line"><span class="keyword">package</span> lrucache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"path/to/bit/zerzura/log"</span></span><br><span class="line">    <span class="string">"path/to/bit/zerzura/datastructures/list"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    defaultCapacity = <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LRUCache <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    cache <span class="keyword">map</span>[<span class="keyword">string</span>]*list.Node</span><br><span class="line">    list *list.List</span><br><span class="line">    stats *Stats</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(cache *LRUCache)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Capacity</span><span class="params">(<span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(cache *LRUCache)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">cap</span> &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">cap</span> = defaultCapacity</span><br><span class="line">        &#125;</span><br><span class="line">        cache.capacity = <span class="built_in">cap</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ...Option)</span> *<span class="title">LRUCache</span></span> &#123;</span><br><span class="line">    cache := &amp;LRUCache&#123;</span><br><span class="line">        capacity: defaultCapacity,</span><br><span class="line">        cache: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*list.Node, defaultCapacity),</span><br><span class="line">        list: list.New(),</span><br><span class="line">        stats: &amp;Stats&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">        opt(cache)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"LRUCache(cap=%d, len=%d, hits=%d, misses=%d)"</span>, lru.capacity, lru.Len(), lru.stats.hits, lru.stats.misses)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lru.capacity</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(lru.cache)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Set</span><span class="params">(key <span class="keyword">string</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    log.Debugf(<span class="string">"lru.set (%s, %v)"</span>, key, value)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(lru.cache) &gt;= lru.capacity &#123;</span><br><span class="line">        node := lru.list.Tail()</span><br><span class="line">        <span class="keyword">if</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">            entry := node.Value.(*entry)</span><br><span class="line">            log.Infof(<span class="string">"[lru.set] evict entry %v"</span>, entry)</span><br><span class="line">            <span class="built_in">delete</span>(lru.cache, entry.key)</span><br><span class="line">            lru.list.RemoveNode(node)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">"unexpected state, node is nil, that's impossible"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    node, ok := lru.cache[key]</span><br><span class="line">    <span class="keyword">if</span> ok &amp;&amp; node != <span class="literal">nil</span> &#123;</span><br><span class="line">        lru.list.RemoveNode(node)</span><br><span class="line">    &#125;</span><br><span class="line">    lru.cache[key] = lru.list.Insert(</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;entry&#123;key: key, value: value&#125;,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    node, ok := lru.cache[key]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        log.Infof(<span class="string">"[lru.get] cache misses for key %s"</span>, key)</span><br><span class="line">        lru.stats.miss()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    entry := node.Value.(*entry)</span><br><span class="line">    entry.hits++</span><br><span class="line">    lru.list.RemoveNode(node)</span><br><span class="line">    lru.cache[key] = lru.list.Insert(<span class="number">0</span>, entry)</span><br><span class="line">    lru.stats.hit()</span><br><span class="line">    log.Debugf(<span class="string">"[lru.get] cache hits, got entry %v."</span>, entry)</span><br><span class="line">    <span class="keyword">return</span> entry.value, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Stats <span class="keyword">struct</span> &#123;</span><br><span class="line">    hits <span class="keyword">int</span></span><br><span class="line">    misses <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">hit</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.hits++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">miss</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.misses++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    key <span class="keyword">string</span></span><br><span class="line">    hits <span class="keyword">int</span></span><br><span class="line">    value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;LRU (Least-Recently-Used) Cache æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥å°†ä¸€äº›çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿›è€Œæé«˜æ¥å£çš„å“åº”é€Ÿåº¦ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œcache miss åï¼Œå®é™…å¯èƒ½ä¼šå›æºåˆ° Redis é›†ç¾¤è·å–ç¼“å­˜æ•°æ®ï¼Œå¦‚æœ Redis é›†ç¾¤ä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå›æºæ•°æ®åº“ã€‚ä¹Ÿå°±æ˜¯å¼•å…¥ LRU Cache åç›¸å½“äºç»™åº”ç”¨å±‚æ·»åŠ äº†ä¸€çº§é«˜é€Ÿç¼“å­˜ã€‚å½“ç„¶ï¼Œæ›´ä¸ºå®é™…ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„ LRU Cacheï¼Œå¦åˆ™åå°æ›´æ–°äº†è¯¾ç¨‹æ•°æ®ï¼Œç”±äºå†…å­˜ç¼“å­˜çš„åŸå› è€Œå¾—ä¸åˆ°åŠæ—¶æ›´æ–°ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="ç¼“å­˜" scheme="http://ifaceless.space/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="LRU" scheme="http://ifaceless.space/tags/LRU/"/>
    
  </entry>
  
  <entry>
    <title>Python æ ‡å‡†åº“æºç ä¹‹ threading æ¨¡å—</title>
    <link href="http://ifaceless.space/2019/09/14/python-stdlib-threading/"/>
    <id>http://ifaceless.space/2019/09/14/python-stdlib-threading/</id>
    <published>2019-09-14T13:03:33.000Z</published>
    <updated>2019-11-28T09:41:31.558Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>è™½ç„¶è¯´ Python å—é™äº CPython çš„å®ç°ï¼Œå­˜åœ¨çš„ GIL ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œæ²¡æ³•åˆ©ç”¨å¤šæ ¸è·‘å¤šçº¿ç¨‹ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼šç”¨åˆ°çº¿ç¨‹çš„ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ä¸€äº› I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</p><p>åœ¨ä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬éšæ—¶éœ€è¦æ³¨æ„<strong>ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰</strong>å’Œ<strong>æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰</strong>çš„é—®é¢˜ï¼Œå‰è€…ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è¿è¡Œç¨‹åºå¾—åˆ°çš„è¾“å‡ºå¯èƒ½ä¸åŒï¼›è€Œåè€…åˆ™æ›´ä¸ºå¯æ€•ï¼Œå®¹æ˜“å¯¼è‡´å…±äº«çš„æ•°æ®ç»“æ„è¢«é”™è¯¯ä¿®æ”¹ï¼Œç”šè‡³å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…å‡ºç°è«åå…¶å¦™çš„ Bugã€‚è¿™ä¸ªæ—¶å€™è‡ªç„¶å°±è¦ç”¨åˆ° Python threading æ¨¡å—ä¸ºæˆ‘ä»¬æä¾›çš„è‹¥å¹²åŒæ­¥åŸè¯­äº†ã€‚<br><a id="more"></a><br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ Lockã€RLockã€æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰ã€ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ç­‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥çš„æºç å­¦ä¹ æ˜¯åŸºäº <a href="https://github.com/python/cpython/blob/master/Lib/threading.py" target="_blank" rel="noopener">CPython master åˆ†æ”¯çš„çº¿ç¨‹æ¨¡å—</a>ã€‚å¸Œæœ›åœ¨å­¦ä¹ å®Œå®ƒä»¬çš„å®ç°åï¼Œèƒ½å¤ŸåŠ æ·±ç†è§£ï¼Œåˆç†è¿ç”¨ã€‚</p><h1 id="æºç å­¦ä¹ "><a href="#æºç å­¦ä¹ " class="headerlink" title="æºç å­¦ä¹ "></a>æºç å­¦ä¹ </h1><p>CPython çš„ threading æ¨¡å—å®é™…ä¸Šæ˜¯åŸºäº Java çš„çº¿ç¨‹æ¨¡å‹å®ç°çš„ï¼Œæ‰€ä»¥ç†Ÿæ‚‰ Java çš„è¯ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå¯¹è¯¥æ¨¡å—çš„å®ç°æ„Ÿåˆ°é™Œç”Ÿã€‚è¯¥æ¨¡å—æ˜¯åŸºäºæ›´åº•å±‚çš„ <code>_thread</code> æ¨¡å—ï¼ŒæŠ½è±¡å‡ºæ›´åŠ æ–¹ä¾¿ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œæ ¸å¿ƒåŒ…æ‹¬ <code>threading.Thread</code> çº¿ç¨‹ç±»å°è£…ï¼Œä¾¿äºç”¨æˆ·ç»§æ‰¿æˆ–ç»„åˆï¼›æ­¤å¤–è¿˜æœ‰ä¸€äº›åŒæ­¥åŸè¯­çš„å®ç°ã€‚<code>Python/thread_nt.h</code> æ–‡ä»¶ä¸­æ˜¯ C è¯­è¨€å®ç°çš„åº•å±‚å’Œçº¿ç¨‹æœ‰å…³çš„å‡½æ•°ï¼ˆå¦‚é”çš„åˆ›å»ºå’Œç»´æŠ¤ã€çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ï¼‰ã€‚</p><h2 id="åŒæ­¥åŸè¯­"><a href="#åŒæ­¥åŸè¯­" class="headerlink" title="åŒæ­¥åŸè¯­"></a>åŒæ­¥åŸè¯­</h2><h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>è¯¥æ¨¡å—ä¸­ï¼Œ<code>Lock</code> å…¶å®æ˜¯ä½¿ç”¨äº†åº•å±‚ <code>_thread.allocate_lock</code> å‡½æ•°æ¥åˆ›å»ºé”çš„ã€‚ä»£ç ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lock = _allocate_lock</span><br></pre></td></tr></table></figure><p>Lock ä¸ºæˆ‘ä»¬æä¾›äº† <code>acquire()</code> å’Œ <code>release()</code> è¿™ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹è°ƒç”¨ <code>acquire()</code> æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼ˆæ­¤æ—¶çº¿ç¨‹ä¸€èˆ¬å°±æ˜¯ç¡çœ ç­‰å¾…äº†ï¼‰ï¼Œç›´åˆ°ä¸»åŠ¨ <code>release()</code> åï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p><p>å…³äº Lock æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š</p><ol><li>è¯¥é”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°ä¸­é€’å½’ <code>acquire()</code> ä¼šå¯¼è‡´æ­»é”çš„é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ <code>RLock</code> æ¥ä»£æ›¿</li><li>Lock å¹¶é Mutexï¼ˆäº’æ–¥é”ï¼‰ï¼Œä¸”å®ƒåº•å±‚æ˜¯é€šè¿‡ä¿¡å·é‡é‚£æ ·å®ç°çš„ï¼Œæœ¬èº«ä¸ä¼šè®°å½•è°æŒæœ‰äº†è¯¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ Lock å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«å¼•ç”¨ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹è·å–ï¼Œè€Œåœ¨å­çº¿ç¨‹é‡Šæ”¾å®ƒã€‚å…·ä½“å¯ä»¥åœ¨ <code>CPython/Python/thread_nt.h:PyThread_allocate_lock</code> å¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°å¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lock support. It has to be implemented as semaphores.</span></span><br><span class="line"><span class="comment"> * I [Dag] tried to implement it with mutex but I could find a way to</span></span><br><span class="line"><span class="comment"> * tell whether a thread already own the lock or not.</span></span><br><span class="line"><span class="comment"> * Lock æ”¯æŒï¼šå®ƒå¿…é¡»ä»¥ä¿¡å·é‡çš„æ–¹å¼æ¥å®ç°ã€‚æˆ‘å°è¯•ä½¿ç”¨äº’æ–¥é”å®ç°è¿‡ï¼Œä½†æ˜¯æˆ‘</span></span><br><span class="line"><span class="comment"> * å‘ç°äº†å¦å¤–ä¸€ç§æ–¹å¼å¯ä»¥å¾—çŸ¥ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦æŒæœ‰äº†é”ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PyThread_type_lock</span><br><span class="line">PyThread_allocate_lock(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    PNRMUTEX aLock;</span><br><span class="line">    dprintf((<span class="string">"PyThread_allocate_lock called\n"</span>));</span><br><span class="line">    <span class="keyword">if</span> (!initialized)</span><br><span class="line">        PyThread_init_thread();</span><br><span class="line">    aLock = AllocNonRecursiveMutex() ;</span><br><span class="line">    dprintf((<span class="string">"%lu: PyThread_allocate_lock() -&gt; %p\n"</span>, PyThread_get_thread_ident(), aLock));</span><br><span class="line">    <span class="keyword">return</span> (PyThread_type_lock) aLock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶ä¸­ PNRMUTEX å®šä¹‰å¦‚ä¸‹ï¼Œå®ƒå¹¶ä¸ä¼šå‘Šè¯‰æˆ‘ä»¬å½“å‰æ˜¯å“ªä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="comment">// æŒæœ‰äº†é”</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NRMUTEX</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PyMUTEX_T cs;</span><br><span class="line">    PyCOND_T cv;</span><br><span class="line">    <span class="keyword">int</span> locked;</span><br><span class="line">&#125; NRMUTEX;</span><br><span class="line"><span class="keyword">typedef</span> NRMUTEX *PNRMUTEX;</span><br></pre></td></tr></table></figure></li></ol><p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œå…¶å® <code>PyCOND</code> å³æ¡ä»¶å˜é‡æ˜¯é€šè¿‡ä¿¡å·é‡æ¥å®ç°çš„ï¼›è€Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåœ¨ Python çš„ threading æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Condition å®ç°äº†ä¿¡å·é‡ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-ee4c29657d4deb6d0953bc8531241697_hd.png" alt=""></p><h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>RLock å°±æ˜¯å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰ï¼Œå®ƒå¯ä»¥è¢«æŒæœ‰é”çš„çº¿ç¨‹å¤šæ¬¡æ‰§è¡Œ <code>acquire()</code>ï¼Œè€Œä¸ä¼šå‘ç”Ÿé˜»å¡å’Œæ­»é”çš„é—®é¢˜ã€‚å®ƒçš„å®ç°æ€è·¯å¾ˆç®€å•ï¼š</p><ol><li>è§„å®šå¦‚æœä¸€ä¸ªçº¿ç¨‹æˆåŠŸæŒæœ‰äº†è¯¥é”ï¼Œåˆ™å°†è¯¥é”çš„æ‰€æœ‰æƒäº¤ç»™è¯¥çº¿ç¨‹ï¼Œå¹¶ä¸”åªæœ‰è¯¥çº¿ç¨‹å¯ä»¥é‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹æ— æ³•é‡Šæ”¾ï¼›</li><li>å½“åœ¨æŒæœ‰é”çš„çº¿ç¨‹ä¸­é€’å½’è·å–é”çš„æ—¶å€™ï¼Œå®é™…å¹¶ä¸ä¼šæ‰§è¡Œåº•å±‚çš„ <code>_lock.acquire()</code> æ–¹æ³•ï¼Œè€Œæ˜¯åªç»™è®¡æ•°å™¨é€’å¢ï¼›ä¸”é‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿæ˜¯å…ˆç»™è®¡æ•°å™¨é€’å‡ï¼Œç›´åˆ°ä¸º 0 åæ‰ä¼šé‡Šæ”¾é”ã€‚</li></ol><p>æ‰€ä»¥åœ¨ä½¿ç”¨ RLock çš„æ—¶å€™ä¸€å®šè¦è®°å¾— <code>acquire()</code> å’Œ <code>release()</code> çš„è°ƒç”¨æ¬¡æ•°å¾—åŒ¹é…æ‰èƒ½çœŸæ­£é‡Šæ”¾é”ã€‚æ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹æºç å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RLock</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _CRLock <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># æ¥ä¸‹æ¥é‡ç‚¹çœ‹ Python ç‰ˆæœ¬çš„ RLock å®ç°</span></span><br><span class="line">        <span class="keyword">return</span> _PyRLock(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> _CRLock(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RLock</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œæ˜¯çœŸæ­£çš„é”</span></span><br><span class="line">        self._block = _allocate_lock()</span><br><span class="line">        <span class="comment"># è®°å½•è°å¯¹è¯¥é”æœ‰æ‰€æœ‰æƒ</span></span><br><span class="line">        self._owner = <span class="keyword">None</span></span><br><span class="line">        <span class="comment"># è®°å½•è¯¥é”è¢«è·å–çš„æ¬¡æ•°ï¼Œç±»ä¼¼å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=True, timeout=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        me = get_ident()</span><br><span class="line">        <span class="keyword">if</span> self._owner == me:</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰æŒæœ‰é”çš„çº¿ç¨‹å°±æ˜¯å½“å‰éœ€è¦è·å¾—é”çš„çº¿ç¨‹ï¼Œè®¡æ•°å™¨é€’å¢å³å¯</span></span><br><span class="line">            self._count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        rc = self._block.acquire(blocking, timeout)</span><br><span class="line">        <span class="keyword">if</span> rc:</span><br><span class="line">            <span class="comment"># å¦‚æœæˆåŠŸè·å–åˆ°é”åï¼Œä¼šæŠŠæŒæœ‰é”çš„çº¿ç¨‹è®°å½•ä¸‹æ¥ï¼Œæ ‡è®°è¯¥çº¿ç¨‹æ˜¯æ‰€æœ‰æƒæ‹¥æœ‰è€…</span></span><br><span class="line">            self._owner = me</span><br><span class="line">            self._count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> rc</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._owner != get_ident():</span><br><span class="line">            <span class="comment"># æ˜¾è€Œæ˜“è§ï¼Œéæ‹¥æœ‰è€…ä¸èƒ½é‡Šæ”¾é”ï¼Œæƒ³éƒ½ä¸ç”¨æƒ³ï¼</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot release un-acquired lock"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿™é‡Œåªæ˜¯é€’å‡è®¡æ•°å™¨ï¼Œåªæœ‰_count å‡æ²¡äº†æ‰ä¼šçœŸæ­£é‡Šæ”¾</span></span><br><span class="line">        self._count = count = self._count - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> count:</span><br><span class="line">            self._owner = <span class="keyword">None</span></span><br><span class="line">            self._block.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸‹é¢çš„æ–¹æ³•æ˜¯ç”¨äºæ¡ä»¶å˜é‡å®ç°æ—¶ä½¿ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, state)</span>:</span></span><br><span class="line">        <span class="comment"># æ¢å¤é”çš„è·å–ï¼Œå¹¶ä¸”æ¢å¤åµŒå¥—å±‚æ¬¡</span></span><br><span class="line">        self._block.acquire()</span><br><span class="line">        self._count, self._owner = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># éœ€è¦ä¿è¯ä¸ç®¡æœ‰å¤šå°‘å±‚åµŒå¥—ï¼Œéƒ½èƒ½çœŸæ­£é‡Šæ”¾é”ï¼Œä½†åŒæ—¶è¿”å›å½“å‰çš„åµŒå¥—çŠ¶æ€ç­‰ä¿¡æ¯ä¾¿äºæ¢å¤</span></span><br><span class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot release un-acquired lock"</span>)</span><br><span class="line">        count = self._count</span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line">        owner = self._owner</span><br><span class="line">        self._owner = <span class="keyword">None</span></span><br><span class="line">        self._block.release()</span><br><span class="line">        <span class="keyword">return</span> (count, owner)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._owner == get_ident()</span><br></pre></td></tr></table></figure></p><h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>æ¡ä»¶å˜é‡æ˜¯åé¢å‡ ä¸ªåŒæ­¥åŸè¯­å®ç°çš„åŸºç¡€ï¼Œå€¼å¾—é‡ç‚¹å­¦ä¹ ä¸‹ã€‚æ¡ä»¶å˜é‡çš„å®ç°åŸç†æ¯”è¾ƒç®€å•ï¼šæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™ä¼šè¢«å”¤é†’ï¼ˆå¯ä»¥æƒ³æƒ³å¦‚ä½•å®ç° waiter çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’å‘¢ï¼Ÿï¼‰ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-b4516542d0e21eab291382ac3f8ed364_hd.png" alt=""></p><p>åœ¨åˆ†ææºç å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>Condition</code> ç±»æä¾›äº†å“ªäº›ä¸»è¦æ¥å£ï¼š</p><ul><li><code>wait(timeout=None)</code>ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£ç­‰å¾…è¢«å”¤é†’</li><li><code>notify()</code>ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£é€šçŸ¥é˜Ÿåˆ—ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç­‰å¾…çº¿ç¨‹è¢«å”¤é†’</li></ul><p>æ¥ä¸‹æ¥çœ‹çœ‹æºç å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Condition</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, lock=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> lock <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            lock = RLock()</span><br><span class="line">        self._lock = lock</span><br><span class="line">        <span class="comment"># Export the lock's acquire() and release() methods</span></span><br><span class="line">        self.acquire = lock.acquire</span><br><span class="line">        self.release = lock.release</span><br><span class="line">        <span class="comment"># If the lock defines _release_save() and/or _acquire_restore(),</span></span><br><span class="line">        <span class="comment"># these override the default implementations (which just call</span></span><br><span class="line">        <span class="comment"># release() and acquire() on the lock). Ditto for _is_owned().</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._release_save = lock._release_save</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._acquire_restore = lock._acquire_restore</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._is_owned = lock._is_owned</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        self._waiters = _deque()</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._lock.release() <span class="comment"># No state to save</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self._lock.acquire() <span class="comment"># Ignore saved state</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Return True if lock is owned by current_thread.</span></span><br><span class="line">        <span class="comment"># This method is called only if _lock doesn't have _is_owned().</span></span><br><span class="line">        <span class="keyword">if</span> self._lock.acquire(<span class="keyword">False</span>):</span><br><span class="line">            self._lock.release()</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot wait on un-acquired lock"</span>)</span><br><span class="line">        waiter = _allocate_lock()</span><br><span class="line">        waiter.acquire()</span><br><span class="line">        self._waiters.append(waiter)</span><br><span class="line">        saved_state = self._release_save()</span><br><span class="line">        gotit = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">try</span>: <span class="comment"># restore state no matter what (e.g., KeyboardInterrupt)</span></span><br><span class="line">            <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                waiter.acquire()</span><br><span class="line">                gotit = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> timeout &gt; <span class="number">0</span>:</span><br><span class="line">                    gotit = waiter.acquire(<span class="keyword">True</span>, timeout)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    gotit = waiter.acquire(<span class="keyword">False</span>)</span><br><span class="line">            <span class="keyword">return</span> gotit</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._acquire_restore(saved_state)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> gotit:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self._waiters.remove(waiter)</span><br><span class="line">                <span class="keyword">except</span> ValueError:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_for</span><span class="params">(self, predicate, timeout=None)</span>:</span></span><br><span class="line">        endtime = <span class="keyword">None</span></span><br><span class="line">        waittime = timeout</span><br><span class="line">        result = predicate()</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">if</span> waittime <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">if</span> endtime <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                    endtime = _time() + waittime</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    waittime = endtime - _time()</span><br><span class="line">                    <span class="keyword">if</span> waittime &lt;= <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            self.wait(waittime)</span><br><span class="line">            result = predicate()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot notify on un-acquired lock"</span>)</span><br><span class="line">        all_waiters = self._waiters</span><br><span class="line">        waiters_to_notify = _deque(_islice(all_waiters, n))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> waiters_to_notify:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> waiter <span class="keyword">in</span> waiters_to_notify:</span><br><span class="line">            waiter.release()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                all_waiters.remove(waiter)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span>:</span></span><br><span class="line">    <span class="string">"""This class implements semaphore objects.</span></span><br><span class="line"><span class="string">    Semaphores manage a counter representing the number of release() calls minus</span></span><br><span class="line"><span class="string">    the number of acquire() calls, plus an initial value. The acquire() method</span></span><br><span class="line"><span class="string">    blocks if necessary until it can return without making the counter</span></span><br><span class="line"><span class="string">    negative. If not given, value defaults to 1.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># After Tim Peters' semaphore class, but not quite the same (no maximum)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"semaphore initial value must be &gt;= 0"</span>)</span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=True, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Acquire a semaphore, decrementing the internal counter by one.</span></span><br><span class="line"><span class="string">        When invoked without arguments: if the internal counter is larger than</span></span><br><span class="line"><span class="string">        zero on entry, decrement it by one and return immediately. If it is zero</span></span><br><span class="line"><span class="string">        on entry, block, waiting until some other thread has called release() to</span></span><br><span class="line"><span class="string">        make it larger than zero. This is done with proper interlocking so that</span></span><br><span class="line"><span class="string">        if multiple acquire() calls are blocked, release() will wake exactly one</span></span><br><span class="line"><span class="string">        of them up. The implementation may pick one at random, so the order in</span></span><br><span class="line"><span class="string">        which blocked threads are awakened should not be relied on. There is no</span></span><br><span class="line"><span class="string">        return value in this case.</span></span><br><span class="line"><span class="string">        When invoked with blocking set to true, do the same thing as when called</span></span><br><span class="line"><span class="string">        without arguments, and return true.</span></span><br><span class="line"><span class="string">        When invoked with blocking set to false, do not block. If a call without</span></span><br><span class="line"><span class="string">        an argument would block, return false immediately; otherwise, do the</span></span><br><span class="line"><span class="string">        same thing as when called without arguments, and return true.</span></span><br><span class="line"><span class="string">        When invoked with a timeout other than None, it will block for at</span></span><br><span class="line"><span class="string">        most timeout seconds. If acquire does not complete successfully in</span></span><br><span class="line"><span class="string">        that interval, return false. Return true otherwise.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> blocking <span class="keyword">and</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"can't specify timeout for non-blocking acquire"</span>)</span><br><span class="line">        rc = <span class="keyword">False</span></span><br><span class="line">        endtime = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">while</span> self._value == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> blocking:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    <span class="keyword">if</span> endtime <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                        endtime = _time() + timeout</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        timeout = endtime - _time()</span><br><span class="line">                        <span class="keyword">if</span> timeout &lt;= <span class="number">0</span>:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                self._cond.wait(timeout)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._value -= <span class="number">1</span></span><br><span class="line">                rc = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> rc</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""Release a semaphore, incrementing the internal counter by one or more.</span></span><br><span class="line"><span class="string">        When the counter is zero on entry and another thread is waiting for it</span></span><br><span class="line"><span class="string">        to become larger than zero again, wake up that thread.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'n must be one or more'</span>)</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._value += n</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">                self._cond.notify()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedSemaphore</span><span class="params">(Semaphore)</span>:</span></span><br><span class="line">    <span class="string">"""Implements a bounded semaphore.</span></span><br><span class="line"><span class="string">    A bounded semaphore checks to make sure its current value doesn't exceed its</span></span><br><span class="line"><span class="string">    initial value. If it does, ValueError is raised. In most situations</span></span><br><span class="line"><span class="string">    semaphores are used to guard resources with limited capacity.</span></span><br><span class="line"><span class="string">    If the semaphore is released too many times it's a sign of a bug. If not</span></span><br><span class="line"><span class="string">    given, value defaults to 1.</span></span><br><span class="line"><span class="string">    Like regular semaphores, bounded semaphores manage a counter representing</span></span><br><span class="line"><span class="string">    the number of release() calls minus the number of acquire() calls, plus an</span></span><br><span class="line"><span class="string">    initial value. The acquire() method blocks if necessary until it can return</span></span><br><span class="line"><span class="string">    without making the counter negative. If not given, value defaults to 1.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></span><br><span class="line">        Semaphore.__init__(self, value)</span><br><span class="line">        self._initial_value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""Release a semaphore, incrementing the internal counter by one or more.</span></span><br><span class="line"><span class="string">        When the counter is zero on entry and another thread is waiting for it</span></span><br><span class="line"><span class="string">        to become larger than zero again, wake up that thread.</span></span><br><span class="line"><span class="string">        If the number of releases exceeds the number of acquires,</span></span><br><span class="line"><span class="string">        raise a ValueError.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'n must be one or more'</span>)</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">if</span> self._value + n &gt; self._initial_value:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"Semaphore released too many times"</span>)</span><br><span class="line">            self._value += n</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">                self._cond.notify()</span><br></pre></td></tr></table></figure><h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></span><br><span class="line">    <span class="string">"""Class implementing event objects.</span></span><br><span class="line"><span class="string">    Events manage a flag that can be set to true with the set() method and reset</span></span><br><span class="line"><span class="string">    to false with the clear() method. The wait() method blocks until the flag is</span></span><br><span class="line"><span class="string">    true. The flag is initially false.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># After Tim Peters' event class (without is_posted())</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._flag = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reset_internal_locks</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># private! called by Thread._reset_internal_locks by _after_fork()</span></span><br><span class="line">        self._cond.__init__(Lock())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_set</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return true if and only if the internal flag is true."""</span></span><br><span class="line">        <span class="keyword">return</span> self._flag</span><br><span class="line"></span><br><span class="line">    isSet = is_set</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Set the internal flag to true.</span></span><br><span class="line"><span class="string">        All threads waiting for it to become true are awakened. Threads</span></span><br><span class="line"><span class="string">        that call wait() once the flag is true will not block at all.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._flag = <span class="keyword">True</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Reset the internal flag to false.</span></span><br><span class="line"><span class="string">        Subsequently, threads calling wait() will block until set() is called to</span></span><br><span class="line"><span class="string">        set the internal flag to true again.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._flag = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Block until the internal flag is true.</span></span><br><span class="line"><span class="string">        If the internal flag is true on entry, return immediately. Otherwise,</span></span><br><span class="line"><span class="string">        block until another thread calls set() to set the flag to true, or until</span></span><br><span class="line"><span class="string">        the optional timeout occurs.</span></span><br><span class="line"><span class="string">        When the timeout argument is present and not None, it should be a</span></span><br><span class="line"><span class="string">        floating point number specifying a timeout for the operation in seconds</span></span><br><span class="line"><span class="string">        (or fractions thereof).</span></span><br><span class="line"><span class="string">        This method returns the internal flag on exit, so it will always return</span></span><br><span class="line"><span class="string">        True except if a timeout is given and the operation times out.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            signaled = self._flag</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> signaled:</span><br><span class="line">                signaled = self._cond.wait(timeout)</span><br><span class="line">            <span class="keyword">return</span> signaled</span><br></pre></td></tr></table></figure><h3 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h3><p>é€šå¸¸å¯ä»¥ä½¿ç”¨ Barrier å®ç°å¹¶å‘åˆå§‹åŒ–ï¼Œç„¶åä¸€åˆ‡å°±ç»ªåæ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚åº”ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> get_ident <span class="keyword">as</span> get_ident</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Barrier, Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signal_prepared</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"All are ready"</span>)</span><br><span class="line"></span><br><span class="line">barrier = Barrier(parties=<span class="number">4</span>, action=signal_prepared)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    Thread(target=load_disk_files).start()</span><br><span class="line">    Thread(target=make_cache).start()</span><br><span class="line">    Thread(target=init_db_pool).start()</span><br><span class="line">    print(<span class="string">"I'm ready, wait for other workers"</span>)</span><br><span class="line">    barrier.wait()</span><br><span class="line">    print(<span class="string">"Time to start our server"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_disk_files</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] load_disk_files"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_cache</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] make cache"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db_pool</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] init db pool"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œæ•ˆæœï¼š<br><img src="https://pic3.zhimg.com/80/v2-976ddfaeddc70d04ee29843cfd125713_hd.png" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ Barrier æ˜¯å¦‚ä½•å®ç°çš„ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Barrier æ˜¯åŸºäºéƒ¨åˆ†çš„ `pthread_barrier_*` API å’Œ Java ä¸­çš„ `CyclicBarrier`</span></span><br><span class="line"><span class="comment"># å‚è€ƒï¼š</span></span><br><span class="line"><span class="comment"># 1. http://sourceware.org/pthreads-win32/manual/pthread_barrier_init.html and</span></span><br><span class="line"><span class="comment"># 2. http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/CyclicBarrier.html</span></span><br><span class="line"><span class="comment"># åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸¤ç§ä¸»è¦çš„çŠ¶æ€ï¼š`filling` å’Œ `draining`ï¼Œä»è€Œè®©å±éšœå˜æˆå¯å¾ªç¯ä½¿ç”¨çš„ã€‚</span></span><br><span class="line"><span class="comment"># åªæœ‰ä¸Šä¸€ä¸ªå‘¨æœŸå®Œå…¨æ’æ°´ï¼ˆ`drained`ï¼‰å®Œæ¯•æ‰å¯ä»¥å…è®¸æ–°çš„çº¿ç¨‹è¿›å…¥ï¼ˆå¯¹æ¯”ä¸‹æ¼æ¡¶é™æµç®—æ³•ï¼‰</span></span><br><span class="line"><span class="comment"># æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æä¾›äº† `resetting` çŠ¶æ€ï¼Œå®ƒç±»ä¼¼äº `draining`ï¼Œä½†æ˜¯ä¼šè®©çº¿ç¨‹ç¦»å¼€çš„æ—¶å€™æŠ›å‡º `BrokeBarrierError`</span></span><br><span class="line"><span class="comment"># `broken` çŠ¶æ€è¡¨ç¤ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½äº§ç”Ÿäº†å¼‚å¸¸</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Barrier</span>:</span></span><br><span class="line">    <span class="string">"""I</span></span><br><span class="line"><span class="string">    æˆ‘ä»¬é€šå¸¸å¯ä»¥ä½¿ç”¨å±éšœè®©å¤šä¸ªçº¿ç¨‹åœ¨ç›¸åŒçš„åŒæ­¥ç‚¹åŒæ­¥å¼€å§‹ï¼ˆå¯ä»¥æƒ³è±¡ä¸‹æœ‰ä¸ªæ°´ç¼¸ï¼Œæ°´ä¸æ–­åœ°æµè¿›æ¥</span></span><br><span class="line"><span class="string">    ä½†æ˜¯ä¼šåœ¨æŸä¸ªç‚¹ä¸€èµ·æ”¾å¼€ï¼Œå½¢æˆæ´ªæµ...ï¼‰ã€‚æ‰€æœ‰è°ƒç”¨äº† `wait()` çš„çº¿ç¨‹ä¼šåœ¨æ¡ä»¶æ»¡è¶³æ—¶å‡ ä¹åŒæ—¶è¢«å”¤é†’ï¼Œ</span></span><br><span class="line"><span class="string">    ç„¶åå¤§å®¶å°±å¯ä»¥ä¸€èµ·å¿«ä¹åœ°å¹²æ´»äº†ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, parties, action=None, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Create a barrier, initialised to 'parties' threads.</span></span><br><span class="line"><span class="string">        'action' is a callable which, when supplied, will be called by one of</span></span><br><span class="line"><span class="string">        the threads after they have all entered the barrier and just prior to</span></span><br><span class="line"><span class="string">        releasing them all. If a 'timeout' is provided, it is used as the</span></span><br><span class="line"><span class="string">        default for all subsequent 'wait()' calls.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._action = action</span><br><span class="line">        self._timeout = timeout</span><br><span class="line">        self._parties = parties</span><br><span class="line">        self._state = <span class="number">0</span> <span class="comment">#0 filling, 1, draining, -1 resetting, -2 broken</span></span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Wait for the barrier.</span></span><br><span class="line"><span class="string">        When the specified number of threads have started waiting, they are all</span></span><br><span class="line"><span class="string">        simultaneously awoken. If an 'action' was provided for the barrier, one</span></span><br><span class="line"><span class="string">        of the threads will have executed that callback prior to returning.</span></span><br><span class="line"><span class="string">        Returns an individual index number from 0 to 'parties-1'.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            timeout = self._timeout</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._enter() <span class="comment"># Block while the barrier drains.</span></span><br><span class="line">            index = self._count</span><br><span class="line">            self._count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> index + <span class="number">1</span> == self._parties:</span><br><span class="line">                    <span class="comment"># We release the barrier</span></span><br><span class="line">                    self._release()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># We wait until someone releases us</span></span><br><span class="line">                    self._wait(timeout)</span><br><span class="line">                <span class="keyword">return</span> index</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self._count -= <span class="number">1</span></span><br><span class="line">                <span class="comment"># Wake up any threads waiting for barrier to drain.</span></span><br><span class="line">                self._exit()</span><br><span class="line">    <span class="comment"># Block until the barrier is ready for us, or raise an exception</span></span><br><span class="line">    <span class="comment"># if it is broken.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> self._state <span class="keyword">in</span> (<span class="number">-1</span>, <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># It is draining or resetting, wait until done</span></span><br><span class="line">            self._cond.wait()</span><br><span class="line">        <span class="comment">#see if the barrier is in a broken state</span></span><br><span class="line">        <span class="keyword">if</span> self._state &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">assert</span> self._state == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optionally run the 'action' and release the threads waiting</span></span><br><span class="line">    <span class="comment"># in the barrier.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self._action:</span><br><span class="line">                self._action()</span><br><span class="line">            <span class="comment"># enter draining state</span></span><br><span class="line">            self._state = <span class="number">1</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment">#an exception during the _action handler. Break and reraise</span></span><br><span class="line">            self._break()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Wait in the barrier until we are released. Raise an exception</span></span><br><span class="line">    <span class="comment"># if the barrier is reset or broken.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_wait</span><span class="params">(self, timeout)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._cond.wait_for(<span class="keyword">lambda</span> : self._state != <span class="number">0</span>, timeout):</span><br><span class="line">            <span class="comment">#timed out. Break the barrier</span></span><br><span class="line">            self._break()</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">if</span> self._state &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">assert</span> self._state == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we are the last thread to exit the barrier, signal any threads</span></span><br><span class="line">    <span class="comment"># waiting for the barrier to drain.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_exit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> self._state <span class="keyword">in</span> (<span class="number">-1</span>, <span class="number">1</span>):</span><br><span class="line">                <span class="comment">#resetting or draining</span></span><br><span class="line">                self._state = <span class="number">0</span></span><br><span class="line">                self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Reset the barrier to the initial state.</span></span><br><span class="line"><span class="string">        Any threads currently waiting will get the BrokenBarrier exception</span></span><br><span class="line"><span class="string">        raised.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">if</span> self._count &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> self._state == <span class="number">0</span>:</span><br><span class="line">                    <span class="comment">#reset the barrier, waking up threads</span></span><br><span class="line">                    self._state = <span class="number">-1</span></span><br><span class="line">                <span class="keyword">elif</span> self._state == <span class="number">-2</span>:</span><br><span class="line">                    <span class="comment">#was broken, set it to reset state</span></span><br><span class="line">                    <span class="comment">#which clears when the last thread exits</span></span><br><span class="line">                    self._state = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._state = <span class="number">0</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">abort</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Place the barrier into a 'broken' state.</span></span><br><span class="line"><span class="string">        Useful in case of error. Any currently waiting threads and threads</span></span><br><span class="line"><span class="string">        attempting to 'wait()' will have BrokenBarrierError raised.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._break()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_break</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># An internal error was detected. The barrier is set to</span></span><br><span class="line">        <span class="comment"># a broken state all parties awakened.</span></span><br><span class="line">        self._state = <span class="number">-2</span></span><br><span class="line">        self._cond.notify_all()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parties</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the number of threads required to trip the barrier."""</span></span><br><span class="line">        <span class="keyword">return</span> self._parties</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">n_waiting</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the number of threads currently waiting at the barrier."""</span></span><br><span class="line">        <span class="comment"># We don't need synchronization here since this is an ephemeral result</span></span><br><span class="line">        <span class="comment"># anyway. It returns the correct value in the steady state.</span></span><br><span class="line">        <span class="keyword">if</span> self._state == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> self._count</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">broken</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return True if the barrier is in a broken state."""</span></span><br><span class="line">        <span class="keyword">return</span> self._state == <span class="number">-2</span></span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Python æºç çš„æ³¨é‡Šå¤ªä¸°å¯Œäº†ï¼Œä»¥è‡³äºæˆ‘éƒ½ä¸æƒ³ç¿»è¯‘æˆä¸­æ–‡ã€‚æ‰€ä»¥ç»“åˆæ³¨é‡Šçœ‹ä»£ç å³å¯~</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;è™½ç„¶è¯´ Python å—é™äº CPython çš„å®ç°ï¼Œå­˜åœ¨çš„ GIL ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œæ²¡æ³•åˆ©ç”¨å¤šæ ¸è·‘å¤šçº¿ç¨‹ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼šç”¨åˆ°çº¿ç¨‹çš„ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ä¸€äº› I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬éšæ—¶éœ€è¦æ³¨æ„&lt;strong&gt;ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰&lt;/strong&gt;å’Œ&lt;strong&gt;æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰&lt;/strong&gt;çš„é—®é¢˜ï¼Œå‰è€…ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è¿è¡Œç¨‹åºå¾—åˆ°çš„è¾“å‡ºå¯èƒ½ä¸åŒï¼›è€Œåè€…åˆ™æ›´ä¸ºå¯æ€•ï¼Œå®¹æ˜“å¯¼è‡´å…±äº«çš„æ•°æ®ç»“æ„è¢«é”™è¯¯ä¿®æ”¹ï¼Œç”šè‡³å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…å‡ºç°è«åå…¶å¦™çš„ Bugã€‚è¿™ä¸ªæ—¶å€™è‡ªç„¶å°±è¦ç”¨åˆ° Python threading æ¨¡å—ä¸ºæˆ‘ä»¬æä¾›çš„è‹¥å¹²åŒæ­¥åŸè¯­äº†ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Python" scheme="http://ifaceless.space/categories/Python/"/>
    
    
      <category term="Python" scheme="http://ifaceless.space/tags/Python/"/>
    
      <category term="æºç å­¦ä¹ " scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://ifaceless.space/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Go ç¼–å†™å§¿åŠ¿</title>
    <link href="http://ifaceless.space/2019/09/03/golang-traps/"/>
    <id>http://ifaceless.space/2019/09/03/golang-traps/</id>
    <published>2019-09-03T13:44:19.000Z</published>
    <updated>2019-11-28T09:41:31.554Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinterface å¯ä»¥ç›´æ¥è¿›è¡Œå€¼ä¼ é€’ï¼Œé™¤éä½ éœ€è¦ä¿®æ”¹ interface æŒ‡å‘çš„æ•°æ®ã€‚interface æœ¬èº«å¾ˆè½»é‡ï¼Œå…¶åŒ…æ‹¬æŒ‡å‘æ•°æ®ç±»å‹çš„æŒ‡é’ˆå’Œå­˜å‚¨æ•°æ®çš„æŒ‡é’ˆã€‚</li><li>Value Receiver æ–¹æ³•å¯ä»¥é€šè¿‡å€¼æˆ–è€…æŒ‡é’ˆè°ƒç”¨ï¼›Pointer Receiver åˆ™åªæ¥å—æŒ‡é’ˆè°ƒç”¨ã€‚æ¢å¥è¯è¯´ï¼ŒæŒ‡é’ˆè°ƒç”¨æ–¹æ³•æ›´åŠ è½»æ¾ï¼Œé™åˆ¶æ›´å°‘ã€‚</li><li>Mutex å’Œ RWMutex å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶é›¶å€¼ï¼Œé›¶å€¼è¡¨ç¤º Unlock çŠ¶æ€ã€‚å·²ç»è¢«ä½¿ç”¨çš„ Mutex ä¸èƒ½è¢«æ‹·è´ã€‚</li><li><p>å¯¹äº Map &amp; Sliceï¼Œéœ€è¦æ³¨æ„å…¶ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå—åˆ°å¤–ç•Œæ“ä½œçš„å½±å“ã€‚ å®‰å…¨çš„åšæ³•æ˜¯åœ¨å†…éƒ¨åšä¸€æ¬¡æ‹·è´ï¼Œå†…éƒ¨å¯å®‰å…¨ä½¿ç”¨ã€‚</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d.trips = <span class="built_in">make</span>([]Trip, <span class="built_in">len</span>(trips))</span><br><span class="line"><span class="built_in">copy</span>(d.trips, trips)</span><br></pre></td></tr></table></figure></li><li><p>Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ï¼ˆè¿™ä¸ªè¿˜æ˜¯è¦çœ‹æƒ…å†µå§ï¼‰</p></li><li>å¸¸è§„æƒ…å†µä¸‹ï¼Œæšä¸¾ä» 1 å¼€å§‹è®¡æ•°ï¼›é™¤é 0 æ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚å¦‚ï¼š<code>LogToStdout = 0</code></li><li><p>ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯è¦å°å¿ƒï¼Œæœ€å¥½<strong>åªå…¬å¼€é”™è¯¯åŒ¹é…å™¨</strong>ï¼Œæ–¹ä¾¿è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼š</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> errNotFound <span class="keyword">struct</span> &#123;</span><br><span class="line">file <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e errNotFound)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">"file %q not found"</span>, e.file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsNotFoundError</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">_, ok := err.(errNotFound)</span><br><span class="line"><span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆç†ä½¿ç”¨ Error Wrappingï¼Œä¸ç”¨æ·»åŠ è¿‡å¤šå†—ä½™ä¿¡æ¯ï¼Œå¦‚ï¼š<code>failed to : error message</code>ã€‚</p></li><li>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿è¡Œçš„ç¨‹åºé¿å… panicï¼Œpanic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œè€Œæ˜¯å½“ä¸å¯æ¢å¤çš„äº‹æƒ…å‘ç”Ÿæ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚</li><li>ä½¿ç”¨ <a href="https://godoc.org/go.uber.org/atomic" target="_blank" rel="noopener">go.uber.org/atomic</a> æ›¿ä»£æ ‡å‡†åº“ <code>sync/atomic</code>ï¼Œé¿å…å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œã€‚</li><li><code>import _</code> åº”è¯¥åªç”¨äº <code>main</code> æ–‡ä»¶ä¸­ï¼Œå°½å¯èƒ½é è¿‘ç¨‹åºå¯åŠ¨ä½ç½®ã€‚</li></ul><h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><ul><li>ä¼˜å…ˆä½¿ç”¨ <code>strconv</code> è€Œé <code>fmt</code> è½¬æ¢ç±»å‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚</li><li>ä¸è¦åå¤ï¼ˆå¦‚å¾ªç¯ä¸­ï¼‰ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceï¼Œåä¹‹äº¦ç„¶ã€‚</li><li>map åˆ›å»ºæ—¶å°½é‡æä¾›å®¹é‡ hintï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ·»åŠ å…ƒç´ æœŸé—´è¿‡å¤šæ¬¡åœ°åˆ†é…ã€‚map è™½ç„¶ä¸èƒ½ä¿è¯åˆ†é… hint ä¸ªå®¹é‡ï¼Œæ·»åŠ å…ƒç´ æ—¶ä¾ç„¶å¯ä»¥è¿›è¡Œåˆ†é…ï¼Œä½†å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶æœ‰æ›´å°‘çš„åˆ†é…ã€‚</li></ul><h2 id="è§„èŒƒ"><a href="#è§„èŒƒ" class="headerlink" title="è§„èŒƒ"></a>è§„èŒƒ</h2><ol><li>ä¿è¯ä¸€è‡´æ€§ï¼Œä¾¿äºä»£ç çš„ç»´æŠ¤ã€å‡å°‘å­¦ä¹ æˆæœ¬</li><li>ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªåˆ†ç»„ï¼ˆimport/var/const/typeï¼‰ã€‚ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åˆ°ä¸€èµ·ï¼</li><li>åŒ…å‘½åè§„åˆ™ï¼š<ol><li>å…¨éƒ¨å°å†™ã€‚æ— å¤§å†™æˆ–ä¸‹åˆ’çº¿</li><li>å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œæ— éœ€é‡å‘½ååŒ…</li><li>ç®€çŸ­ &amp; ç®€æ´</li><li>ä¸è¦ä½¿ç”¨å¤æ•°</li></ol></li><li>å‡½æ•°åˆ†ç»„ä¸é¡ºåºï¼š<ol><li>å‡½æ•°ç²—ç•¥æŒ‰ç…§è°ƒç”¨é¡ºåºæ’åº</li><li>åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå‡½æ•°åº”è¯¥æŒ‰ç…§æ¥æ”¶è€…åˆ†ç»„</li><li>å¯¼å‡ºçš„å‡½æ•°åº”è¯¥å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨ <code>var</code>, <code>struct</code>, <code>const</code> å®šä¹‰çš„åé¢</li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> something <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSomething</span><span class="params">()</span> *<span class="title">something</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;something&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Cost</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> calcCost(s.weights)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcCost</span><span class="params">(n []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;...&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨ <code>_</code> ä½œä¸ºå‰ç¼€</strong>ã€‚æœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œä½¿ç”¨ <code>err</code> å¼€å¤´ã€‚åŸå› ï¼šé¡¶å±‚å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸï¼Œä½¿ç”¨é€šç”¨åç§°å¯èƒ½ä¼šå¯¼è‡´åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯å€¼ã€‚</li><li>ç»“æ„ä½“åµŒå…¥ï¼Œå¤šä¸€è¡Œç©ºè¡Œéš”å¼€</li><li><p><code>nil</code> æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ sliceï¼›<strong>é›¶å€¼åˆ‡ç‰‡ï¼ˆä½¿ç”¨ <code>var</code> å£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨ <code>make()</code> åˆ›å»ºã€‚</strong></p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nums []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">if</span> add1 &#123;</span><br><span class="line">nums = <span class="built_in">append</span>(nums, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> add2 &#123;</span><br><span class="line">nums = <span class="built_in">append</span>(nums, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœè¦å£°æ˜æ ¼å¼å­—ç¬¦ä¸²ï¼Œè®¾ç½®ä¸º <code>const</code> ç±»å‹ï¼Œæœ‰åŠ©äº <code>go vet</code> æ‰§è¡Œå­—ç¬¦ä¸²é™æ€æ£€æŸ¥ï¼š</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> msg = <span class="string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li></ul><h1 id="æ›´å¤šå‚è€ƒ"><a href="#æ›´å¤šå‚è€ƒ" class="headerlink" title="æ›´å¤šå‚è€ƒ"></a>æ›´å¤šå‚è€ƒ</h1><ul><li><a href="https://github.com/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener">Uber Go Guide</a></li><li><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener">The Go common mistakes guide</a></li><li><a href="https://www.kancloud.cn/kancloud/effective/72199" target="_blank" rel="noopener">Effective ä¸­æ–‡ç‰ˆ</a></li><li><a href="https://golang.org/doc/effective_go.html#pointers_vs_values" target="_blank" rel="noopener">Pointers v.s. Values</a></li><li><a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" target="_blank" rel="noopener">Donâ€™t just checked errors, handle them gracefully</a></li><li><a href="https://blog.golang.org/package-names" target="_blank" rel="noopener">Package Names</a></li><li><a href="https://rakyll.org/style-packages/" target="_blank" rel="noopener">Go åŒ…æ ·å¼æŒ‡å—</a></li><li><a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html" target="_blank" rel="noopener">Self-referential functions and the design of options</a></li><li><a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis" target="_blank" rel="noopener">Functional options for friendly APIs</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinterface å¯ä»¥ç›´æ¥è¿›è¡Œå€¼ä¼ é€’ï¼Œé™¤éä½ éœ€è¦ä¿®æ”¹ interface æŒ‡å‘çš„æ•°æ®ã€‚interface æœ¬èº«å¾ˆè½»é‡ï¼Œå…¶åŒ…æ‹¬æŒ‡å‘æ•°æ®ç±»å‹çš„æŒ‡é’ˆå’Œå­˜å‚¨æ•°æ®çš„æŒ‡é’ˆã€‚&lt;/li&gt;
&lt;li&gt;Value Receiver æ–¹æ³•å¯ä»¥é€šè¿‡å€¼æˆ–è€…æŒ‡é’ˆè°ƒç”¨ï¼›Point
      
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="æœ€ä½³å®è·µ" scheme="http://ifaceless.space/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹äº‹åŠ¡</title>
    <link href="http://ifaceless.space/2019/08/24/ddia-transaction/"/>
    <id>http://ifaceless.space/2019/08/24/ddia-transaction/</id>
    <published>2019-08-24T03:37:50.000Z</published>
    <updated>2019-11-24T09:45:59.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ç”±äºæ•°æ®å­˜å‚¨æœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿé”™è¯¯ã€æ•…éšœçš„ç‚¹ç‰¹åˆ«å¤šï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€ç£ç›˜å†™æ»¡ç­‰ï¼Œé¢å¯¹è¿™äº›å¤æ‚çš„æƒ…å†µï¼Œåº”ç”¨å±‚åº”ä»˜èµ·æ¥éå¸¸å›°éš¾ã€‚æ‰€ä»¥å°±æœ‰äº†äº‹åŠ¡çš„æ¦‚å¿µï¼Œè¯´é“äº‹åŠ¡ï¼Œæˆ‘ä»¬æœ€å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šå¯ä»¥ä¸€æ¬¡äº‹åŠ¡ä¸­å°†å¾ˆå¤šè¯»å†™å…¥æ“ä½œæ‰“åŒ…æˆä¸€ä¸ªé€»è¾‘æ“ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æˆåŠŸï¼ˆCommittedï¼‰ä¾¿æˆä»ï¼ˆRollbackï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æƒ…å†µå®‰å…¨åœ°é‡è¯•ï¼Œä¸ç”¨æ‹…å¿ƒéƒ¨åˆ†å†™å…¥çš„é—®é¢˜ã€‚</p><a id="more"></a><p>æ€»çš„æ¥è¯´ï¼Œäº‹åŠ¡å°±æ˜¯ä¸€å±‚æŠ½è±¡ï¼Œä¸ºç®€åŒ–åº”ç”¨å±‚ç¼–ç¨‹æ¨¡å‹è€Œç”Ÿï¼å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰çš„æ•°æ®åº“éƒ½æ”¯æŒäº‹åŠ¡ï¼Œä½†æ˜¯å¯¹å…³ç³»å‹æ•°æ®åº“è€Œè¨€ï¼Œè¿™ä¸ªåŸºæœ¬æ˜¯æ ‡é…ï¼›æŸäº› NoSQL æ•°æ®åº“å¯èƒ½å› ä¸ºæ€§èƒ½ã€å¯ç”¨æ€§ä»¥åŠæ‰©å±•æ€§è€ƒè™‘ï¼Œè€Œæ”¾å¼ƒäº†å¯¹äº‹åŠ¡çš„æ”¯æŒã€‚å¦å¤–ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸‹ï¼Œäº‹åŠ¡çš„å®ç°ä¼šæ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”æ‰§è¡Œå¼€é”€ä¹Ÿå¾ˆå¤§ï¼Œä½†å¹¶ä¸ä»£è¡¨å®ƒä¸èƒ½å®ç°ã€‚å…¸å‹çš„ åˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“å¦‚ TiDB ä»¥åŠ Google Spanner å°±æä¾›äº†äº‹åŠ¡æ”¯æŒã€‚</p><h1 id="æ·±å…¥ç†è§£-ACID"><a href="#æ·±å…¥ç†è§£-ACID" class="headerlink" title="æ·±å…¥ç†è§£ ACID"></a>æ·±å…¥ç†è§£ ACID</h1><ol><li><strong>Atomicityï¼ˆåŸå­æ€§ï¼‰</strong>ï¼šå°†å¤šä¸ªå†™æ“ä½œçº³å…¥ä¸€ä¸ªåŸå­äº‹åŠ¡ä¸­ï¼Œå¹¶åœ¨æ•…éšœï¼ˆè¿›ç¨‹å´©æºƒã€ç½‘ç»œä¸­æ–­ã€ç£ç›˜æ•…éšœï¼‰å‘ç”Ÿæ—¶èƒ½å¤ŸåŠæ—¶ä¸­æ­¢äº‹åŠ¡ï¼Œå¹¶å°†éƒ¨åˆ†å®Œæˆçš„å†™å…¥å…¨éƒ¨ä¸¢å¼ƒã€‚</li><li><p><strong>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</strong>ï¼š</p><ol><li>å¯¹æ•°æ®æœ‰ç‰¹å®šçš„çŠ¶æ€é¢„æœŸï¼Œä»»ä½•æ•°æ®å˜æ›´å¿…é¡»æ»¡è¶³è¿™äº›çŠ¶æ€çº¦æŸï¼ˆæˆ–è€…æ’ç­‰æ¡ä»¶ï¼‰</li><li>åº”ç”¨ç¨‹åºåº”è¯¥è´Ÿè´£ä¿è¯è¿™ç§ä¸€è‡´æ€§ï¼Œæ•°æ®åº“åªæ˜¯å­˜å‚¨</li><li><strong>è¿™ä¸ªæ›´å¤šçš„æ˜¯åº”ç”¨å±‚å±æ€§</strong>ï¼Œæ‰€ä»¥ C åŸæœ¬ä¸å±äº ACIDï¼Œåªæ˜¯ä½œè€… Joe Hellerstein è®¤ä¸ºå¬èµ·æ¥é¡ºå£å°±åŠ äº†è¿›æ¥ğŸ˜¢</li></ol></li><li><p><strong>Isolationï¼ˆéš”ç¦»æ€§ï¼‰</strong>ï¼šå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½ç›¸äº’äº¤å‰ã€‚ç»å…¸çš„æ•™ææŠŠå…¶ç§°ä¸º<em>å¯ä¸²è¡ŒåŒ–</em>ã€‚ä½†å®è·µä¸­ï¼Œä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«è¾ƒå°‘ä½¿ç”¨ï¼Œæ›´å¤šçš„è¿˜æ˜¯è¾ƒå¼±çš„éš”ç¦»çº§åˆ«ã€‚</p></li><li><p><strong>Durabilityï¼ˆæŒä¹…æ€§ï¼‰</strong>ï¼šæ•°æ®åº“æ‰¿è¯ºï¼Œä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå³ä¾¿ç¡¬ä»¶æ•…éšœæˆ–æ•°æ®åº“å´©æºƒï¼Œäº‹åŠ¡å†™å…¥çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p><ol><li>å¯¹äºå¦‚ä¸»ä»å¤åˆ¶çš„æ•°æ®åº“é›†ç¾¤ï¼Œæ„å‘³ç€å†™å…¥çš„æ•°æ®å¤åˆ¶åˆ°äº†å¤šä¸ªèŠ‚ç‚¹</li><li>å®Œç¾çš„æŒä¹…æ€§æ— æ³•ä¿è¯ï¼ˆæŠŠç¡¬ç›˜æ‹”äº†ã€å…¨éƒ¨æœºæˆ¿çƒ§äº†ğŸ”¥å‘¢ï¼Ÿï¼‰</li></ol></li><li><p>ç†æ€§çœ‹å¾…å„å®¶æ•°æ®åº“å®£ç§°çš„ ACID å…¼å®¹ï¼›å®é™…å„å®¶å®ç°éƒ½å¯èƒ½ä¸åŒ</p></li><li>ä¸ç¬¦åˆ ACID æ ‡å‡†çš„ç³»ç»Ÿé€šå¸¸ç§°ä¸º BASEï¼š<ul><li>Basically Available</li><li>Soft State</li><li>Eventually Consistency</li></ul></li><li>ACID æ•°æ®åº“åŸºäºè¿™æ ·çš„ç†å¿µï¼š<strong>å¦‚æœå­˜åœ¨è¿å AID çš„é£é™©ï¼Œå°±æ”¾å¼ƒæ•´ä¸ªäº‹åŠ¡ï¼Œè€Œééƒ¨åˆ†æ”¾å¼ƒ</strong>ï¼</li></ol><h1 id="å¼±éš”ç¦»çº§åˆ«"><a href="#å¼±éš”ç¦»çº§åˆ«" class="headerlink" title="å¼±éš”ç¦»çº§åˆ«"></a>å¼±éš”ç¦»çº§åˆ«</h1><ol><li>å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼šä¸¤ä¸ªäº‹åŠ¡é—´æ²¡æ•°æ®ä¾èµ–å…³ç³»ï¼Œæ“ä½œçš„æ˜¯å®Œå…¨ä¸åŒçš„æ•°æ®</li><li>ä¸å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼ˆä¼šå¼•å…¥ç«äº‰æ¡ä»¶ï¼‰ï¼š<ol><li>A äº‹åŠ¡ä¿®æ”¹äº†<strong>æŸæ•°æ®</strong>ï¼›B äº‹åŠ¡åˆè¯»å–<strong>è¯¥æ•°æ®</strong>ï¼›</li><li>A äº‹åŠ¡å’Œ B äº‹åŠ¡<strong>åŒæ—¶ä¿®æ”¹ç›¸åŒ</strong>çš„æ•°æ®ã€‚</li></ol></li><li>éš”ç¦»å°±æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡èƒ½å¤Ÿå®‰å…¨åœ°å¹¶å‘æ‰§è¡Œï¼Œå‡è£…æ²¡æœ‰å‘ç”Ÿå¹¶å‘ï¼›å¯ä¸²è¡Œåœ°éš”ç¦»æ„å‘³ç€æ•°æ®åº“ä¼šä¿è¯äº‹åŠ¡çš„æ‰§è¡Œç»“æœå’Œä¸²è¡Œæ‰§è¡Œç»“æœä¸€è‡´ã€‚</li><li>ä¸ºä½•äº§ç”Ÿå¼±éš”ç¦»çº§åˆ«ï¼Ÿ<ol><li>ä¸²è¡Œéš”ç¦»æ€§èƒ½ä¸å¥½</li><li>å¼±éš”ç¦»å¯è§£å†³éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼›ä½†æ˜¯è¿˜æ˜¯éœ€è¦å½»åº•ç†è§£å„ç§éš”ç¦»çº§åˆ«ä»¥åŠå®ƒä»¬å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼Œæ‰èƒ½æ›´å¥½åœ°å®Œæˆä¸šåŠ¡éœ€æ±‚</li></ol></li></ol><h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><p>åœ¨å­¦ä¹ å„ç§éš”ç¦»çº§åˆ«å‰ï¼Œæœ‰å¿…è¦äº†è§£å¦‚ä¸‹å‡ ä¸ªå…³é”®è¦ç‚¹ï¼š</p><table><thead><tr><th>è¦ç‚¹</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>è„è¯» Dirty Read</td><td>åœ¨äº‹åŠ¡ A ä¸­è¯»å–åˆ°äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚<em>é‡‡ç”¨ <strong>Read Committed</strong> åŠä»¥ä¸Šçº§åˆ«å¯é˜²èŒƒ</em>ã€‚</td></tr><tr><td>è„å†™ Dirty Write</td><td>åœ¨äº‹åŠ¡ A ä¸­è¦†ç›–äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚<em>å‡ ä¹æ‰€æœ‰çš„æ•°æ®åº“éƒ½å¯ä»¥é˜²æ­¢è„å†™ï¼Œæœ€ç®€å•å°±æ˜¯åŠ é”</em>ã€‚</td></tr><tr><td>è¯»å€¾æ–œï¼ˆä¸å¯é‡å¤è¯»ï¼‰ Non-Repeatable Read</td><td>åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œä¸åŒçš„æ—¶é—´ç‚¹è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¾—åˆ°çš„å€¼ä¸åŒã€‚<em>å¿«ç…§éš”ç¦»å¯è½»æ¾åº”ä»˜ï¼Œé€šå¸¸ä½¿ç”¨ MVCC å®ç°å¿«ç…§éš”ç¦»ï¼ˆå¦‚ InnoDBï¼‰</em>ã€‚</td></tr><tr><td>æ›´æ–°ä¸¢å¤± Lost Update</td><td>ä¸¤ä¸ªäº‹åŠ¡ä¸­éƒ½æ‰§è¡Œäº† Read-Modify-Write çš„æ“ä½œåºåˆ—ï¼Œå‡ºç°äº†å…¶ä¸­ä¸€ä¸ªè¦†ç›–äº†å¦ä¸€ä¸ªçš„å†™å…¥ï¼Œä½†æ²¡æœ‰åŒ…å«å¯¹æ–¹æœ€æ–°å€¼çš„æƒ…å†µï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ï¼šè¯»å–æŸä¸ªå­—æ®µ-&gt;å­—æ®µå€¼åŠ  1-&gt;å†™å…¥è¯¥å­—æ®µçš„æ–°å€¼ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œäº† +1ï¼Œä½†æœ€ç»ˆç»“æœä¸æ˜¯é¢„æœŸçš„ +2 æ•ˆæœï¼‰ã€‚<em>é€šå¸¸å¯ä»¥é‡‡ç”¨æ•°æ®æ”¯æŒçš„åŸå­å†™æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨ SELECTâ€¦FOR UPDATE æ˜¾å¼åŠ é”çš„æ–¹å¼è§£å†³ï¼›å½“ç„¶ï¼ŒæŸäº›å¿«ç…§éš”ç¦»çš„å®ç°å¯ä»¥è‡ªåŠ¨é˜²æ­¢è¿™ç§å¼‚å¸¸</em></td></tr><tr><td>å†™å€¾æ–œ Write Skew</td><td>å…¸å‹çš„åœºæ™¯æ˜¯ï¼šäº‹åŠ¡ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå†æ ¹æ®æŸ¥è¯¢ç»“æœåšå‡ºå†³ç­–ï¼Œæœ€åä¿®æ”¹æ•°æ®åº“ã€‚ä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤æ—¶ï¼Œæ”¯æŒå†³ç­–çš„å‰ææ¡ä»¶ä¸å†æˆç«‹ï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªäº‹åŠ¡ä¸­åšäº†ä¿®æ”¹ï¼Œå¯¼è‡´åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¾—åˆ°çš„ç»“æœä¸åŒï¼‰ã€‚<em>åªæœ‰ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«æ‰èƒ½çœŸæ­£é˜²æ­¢è¿™ç§å¼‚å¸¸</em></td></tr><tr><td>å¹»è¯» Phantom Read</td><td>äº‹åŠ¡è¯»å–äº†æŸäº›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼ŒåŒæ—¶å¦ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå†™å…¥ï¼Œæ”¹å˜äº†å…ˆå‰çš„æŸ¥è¯¢ç»“æœã€‚<em>å¿«ç…§éš”ç¦»å¯é˜²æ­¢ç®€å•çš„å¹»è¯»</em></td></tr></tbody></table><h2 id="ANSI-SQL-å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š"><a href="#ANSI-SQL-å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š" class="headerlink" title="ANSI SQL å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š"></a>ANSI SQL å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š</h2><p>å®é™…ä¸Šå„å®¶æ•°æ®åº“çš„æ”¯æŒæ˜¯ä¸å°½ç›¸åŒçš„ğŸ˜£ã€‚</p><table><thead><tr><th>çº§åˆ«</th><th>P1 è„è¯»</th><th>P2 ä¸å¯é‡å¤è¯»</th><th>P3 å¹»è¯»</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>å…è®¸</td><td>å…è®¸</td><td>å…è®¸</td></tr><tr><td>Read Committed</td><td>ç¦æ­¢</td><td>å…è®¸</td><td>å…è®¸</td></tr><tr><td>Repeatable Read</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td><td>å…è®¸</td></tr><tr><td>Serializable</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td></tr></tbody></table><h2 id="è¯»å·²æäº¤"><a href="#è¯»å·²æäº¤" class="headerlink" title="è¯»å·²æäº¤"></a>è¯»å·²æäº¤</h2><ol><li><p>æœ€åŸºæœ¬çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéœ€è¦æä¾›ä¸‹é¢ä¸¤ä¸ªä¿è¯ï¼š</p><ol><li>é˜²æ­¢è„è¯»</li><li>é˜²æ­¢è„å†™</li></ol></li><li><p>å®ç°ï¼š</p><ol><li>ä¸ºäº†é˜²æ­¢è„å†™ï¼Œå½“äº‹åŠ¡éœ€è¦ä¿®æ”¹æŸä¸ªå¯¹è±¡ï¼ˆæ¯”å¦‚è¡Œæˆ–æ–‡æ¡£ï¼‰æ—¶ï¼Œå¿…é¡»è¦è·å¾—è¯¥å¯¹è±¡çš„é”ï¼Œä¸€ç›´æŒæœ‰è¯¥é”ç›´åˆ°äº‹åŠ¡æäº¤æˆ–ä¸­æ­¢ï¼›    </li><li>ä¸ºäº†é˜²æ­¢è„è¯»ï¼Œä½¿ç”¨é”çš„æ–¹å¼è™½ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†åœ¨è¿è¡Œè¾ƒé•¿æ—¶é—´çš„å†™äº‹åŠ¡ä¼šå¯¼è‡´è®¸å¤šåªè¯»äº‹åŠ¡ç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå½±å“åªè¯»äº‹åŠ¡çš„å“åº”å»¶è¿Ÿï¼Œå¯æ“ä½œæ€§å·®ã€‚é€šå¸¸å¯¹äºæ¯ä¸ªå¾…æ›´æ–°çš„å¯¹è±¡ï¼Œæ•°æ®åº“ç»´æŠ¤å…¶æ—§å€¼å’Œå½“å‰æŒé”äº‹åŠ¡å°†è¦è®¾ç½®çš„æ–°å€¼ä¸¤ä¸ªç‰ˆæœ¬ã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼Œæ‰€æœ‰å…¶å®ƒè¯»æ“ä½œéƒ½è¯»å–æ—§å€¼ï¼›ä»…å½“å†™äº‹åŠ¡æäº¤åï¼Œæ‰ä¼šåˆ‡æ¢åˆ°è¯»å–æ–°å€¼ã€‚</li></ol></li></ol><h2 id="å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»"><a href="#å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»" class="headerlink" title="å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»"></a>å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»</h2><ol><li><p>Rread Committed ä¸èƒ½è§£å†³<strong>ä¸å¯é‡å¤è¯»</strong>çš„é—®é¢˜ï¼Œè€Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å°±ä¸èƒ½å®¹å¿ï¼š</p><ol><li>å¤‡ä»½</li><li>åˆ†ææŸ¥è¯¢å’Œå®Œæ•´æ€§æ£€æŸ¥</li></ol></li><li><p>å¿«ç…§éš”ç¦»ä¿è¯æ¯ä¸ªäº‹åŠ¡åªçœ‹åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„æ—§æ•°æ®ï¼Œä¸æ„ŸçŸ¥å…¶å®ƒäº‹åŠ¡ä¸­å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚è¯»å–æ“ä½œä¸ä¼šé˜»æ­¢å†™æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚</p></li><li>æ•°æ®åº“ä½¿ç”¨äº†<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Control, MVCCï¼‰</strong>æŠ€æœ¯æ¥å®ç°å¿«ç…§éš”ç¦»ã€‚è€Œ MVCC ä¹Ÿå¯ä»¥ç”¨æ¥å®ç° Read Committed éš”ç¦»çº§åˆ«ï¼ˆåªéœ€è¦ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬å³å¯ï¼Œå·²æäº¤çš„æ—§æ•°æ®å’Œå°šæœªæäº¤çš„æ–°ç‰ˆæœ¬æ•°æ®ï¼‰ï¼Œå…¸å‹çš„åšæ³•æ˜¯å¯¹æ¯ä¸ªä¸åŒçš„æŸ¥è¯¢å•ç‹¬åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼›è€Œå¿«ç…§éš”ç¦»çº§åˆ«åˆ™ä½¿ç”¨ä¸€ä¸ªå¿«ç…§è¿è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚<br> <img src="./mvvc.png" alt=""></li><li>ä¸€è‡´æ€§å¿«ç…§ä¸­æ•°æ®å¯è§æ€§è§„åˆ™ï¼š<ol><li>äº‹åŠ¡å¼€å§‹æ—¶ï¼Œåˆ›å»ºè¯¥å¯¹è±¡çš„äº‹åŠ¡å·²ç»å®Œæˆæäº¤</li><li>å¯¹è±¡æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼›æˆ–è€…å³ä¾¿æ ‡è®°äº†ï¼Œä½†æ˜¯åˆ é™¤äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å°šæœªæäº¤</li></ol></li></ol><h2 id="é˜²æ­¢æ›´æ–°ä¸¢å¤±"><a href="#é˜²æ­¢æ›´æ–°ä¸¢å¤±" class="headerlink" title="é˜²æ­¢æ›´æ–°ä¸¢å¤±"></a>é˜²æ­¢æ›´æ–°ä¸¢å¤±</h2><ol><li><p>äº§ç”Ÿæ›´æ–°ä¸¢å¤±çš„å…¸å‹åœºæ™¯æ˜¯ï¼šRead-Modify-Writeï¼Œå½“ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡åœ¨åŒæ ·çš„æ•°æ®è®°å½•ä¸Šæ‰§è¡Œç±»ä¼¼æ“ä½œæ—¶ï¼ŒäºŒè€…ç›¸äº’ä¸ä¼šæ„ŸçŸ¥å¯¹æ–¹çš„ä¿®æ”¹å€¼ï¼Œæœ€ç»ˆå¯¼è‡´æŸä¸ªäº‹åŠ¡çš„ä¿®æ”¹å€¼å¯èƒ½ä¸¢å¤±ã€‚åœºæ™¯å¦‚ä¸‹ï¼š</p><ol><li>é€’å¢è®¡æ•°å™¨ï¼›æ›´æ–°è´¦æˆ·ä½™é¢</li><li>å¯¹å¤æ‚å¯¹è±¡çš„ä¸€éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼ˆå¦‚ä¸€ä¸ªå¤§ JSON å¯¹è±¡ï¼‰</li></ol></li><li><p>å¦‚ä½•è§£å†³ï¼Ÿ</p><ol><li><p>é‡‡ç”¨<strong>åŸå­å†™æ“ä½œ</strong>ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒçš„è¯ï¼‰ï¼š</p><ol><li><code>UPDATE counter SET value = value + 1 WHERE id = 1</code>;</li><li>é€šå¸¸é‡‡ç”¨è¯»å–å¯¹è±¡å¹¶åŠ ç‹¬å é”çš„æ–¹å¼æ¥å®ç°ï¼ˆåœ¨å½“å‰äº‹åŠ¡æœªæäº¤å‰ï¼Œå…¶å®ƒäº‹åŠ¡ä¹Ÿä¸å¯è¯»ï¼‰ï¼›æˆ–è€…å¯ä»¥é‡‡ç”¨å•çº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œ</li></ol></li><li><p><strong>æ˜¾å¼åŠ é”</strong>ï¼š</p><ol><li><code>SELECT * FROM figures WHERE name = &#39;robot&#39; FOR UPDATE</code></li><li>å¯¹æ‰€é€‰è¡ŒåŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡è‹¥è¦åŒæ—¶å°è¯•è¯»å–å¯¹è±¡ï¼Œåˆ™è¦ç­‰å¾…å½“å‰æ­£åœ¨æ‰§è¡Œçš„åºåˆ—å…¨éƒ¨å®Œæˆ</li></ol></li><li><p><strong>è‡ªåŠ¨æ£€æµ‹æ›´æ–°ä¸¢å¤±</strong>ï¼š</p><ol><li>äº‹åŠ¡ç®¡ç†å™¨å¦‚æœæ£€æµ‹åˆ°æ›´æ–°ä¸¢å¤±é£é™©ï¼Œä¼šä¸­æ­¢å½“å‰äº‹åŠ¡ï¼Œå¼ºåˆ¶é€€å›åˆ°å®‰å…¨çš„ R-M-W æ–¹å¼</li><li>MySQL InnoDB ä¸æ”¯æŒæ£€æµ‹ï¼›PostgreSQL çš„å¯é‡å¤è¯»ã€Oracle å¯ä¸²è¡ŒåŒ–å’Œ SQL Server å¿«ç…§éš”ç¦»çº§åˆ«éƒ½æ”¯æŒ</li></ol></li><li><strong>åŸå­æ¯”è¾ƒå’Œè®¾ç½®</strong>ï¼š<ol><li>åªæœ‰åœ¨ä¸Šæ¬¡è¯»å–çš„æ•°æ®æœªå‘ç”Ÿå˜åŒ–æ—¶æ‰å…è®¸æ›´æ–°ï¼›å¦åˆ™å›é€€åˆ° R-M-W æ–¹å¼</li><li>ä½¿ç”¨å‰éœ€è¦ä»”ç»†æ£€æŸ¥</li></ol></li></ol></li></ol><h2 id="å†™å€¾æ–œä¸å¹»è¯»"><a href="#å†™å€¾æ–œä¸å¹»è¯»" class="headerlink" title="å†™å€¾æ–œä¸å¹»è¯»"></a>å†™å€¾æ–œä¸å¹»è¯»</h2><p><img src="./write-skew.png" alt=""></p><ol><li><p>å†™å€¾æ–œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§æ›´å¹¿ä¹‰çš„æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼Œå³å¦‚æœä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„ä¸€ç»„å¯¹è±¡ï¼Œç„¶åæ›´æ–°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼š</p><ol><li>ä¸åŒçš„äº‹åŠ¡æ›´æ–°ä¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå†™å€¾æ–œ</li><li>ä¸åŒçš„äº‹åŠ¡æ›´æ–°ç›¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿè„å†™æˆ–æ›´æ–°ä¸¢å¤±</li></ol></li><li><p>ç›¸å…³åœºæ™¯ï¼š</p><ol><li>ä¼šè®®å®¤é¢„å®šç³»ç»Ÿ</li><li>å¤šäººæ¸¸æˆ</li><li>å£°æ˜ä¸€ä¸ªç”¨æˆ·å</li><li>é˜²æ­¢åŒé‡å¼€æ”¯ï¼ˆç§¯åˆ†ç­‰ï¼‰</li></ol></li><li><p>å¦‚ä½•åº”å¯¹å†™å€¾æ–œï¼š</p><ol><li>å¦‚å€¼ç­åŒ»ç”Ÿçš„ä¾‹å­ï¼Œå¯ä»¥é‡‡ç”¨ <code>SELECT...FOR UPDATE</code> æ–¹å¼<strong>æ˜¾å¼åŠ é”</strong>ï¼Œä½†å¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œè¿™æ ·åšä¹Ÿä¸èƒ½å¥æ•ˆ</li><li>å®ä½“åŒ–å†²çªï¼Œæ¯”å¦‚ä¼šè®®å®¤é¢„å®šï¼Œå¯ä»¥æå‰å°†æœªæ¥ N ä¸ªæœˆçš„å¯¹åº”çš„æ‰€æœ‰æ—¶é—´å’Œæˆ¿é—´ç»„åˆåˆ›å»ºå¥½ï¼Œè¿™æ ·æ˜¾ç¤ºåŠ é”å¯ä»¥ç”Ÿæ•ˆ</li><li>é‡‡ç”¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«</li></ol></li></ol><h1 id="ä¸²è¡ŒåŒ–"><a href="#ä¸²è¡ŒåŒ–" class="headerlink" title="ä¸²è¡ŒåŒ–"></a>ä¸²è¡ŒåŒ–</h1><h2 id="ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ"><a href="#ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ" class="headerlink" title="ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ"></a>ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ</h2><ol><li>é‡‡ç”¨å•çº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œäº‹åŠ¡ï¼Œé¿å…æ£€æµ‹ã€äº‹åŠ¡å†²çªç­‰é—®é¢˜ï¼›åŒæ—¶å¯èƒ½ä¼šæ¯”æ”¯æŒå¹¶å‘çš„ç³»ç»Ÿæ•ˆç‡æ›´é«˜ï¼Œé¿å…é”çš„å¼€é”€</li><li>ä¸ºä»€ä¹ˆå¯è¡Œï¼Ÿ<ol><li>å†…å­˜æ›´ä¾¿å®œ</li><li>OLTP äº‹åŠ¡é€šå¸¸å¾ˆå¿«æ‰§è¡Œå®Œï¼Œåªäº§ç”Ÿå°‘é‡è¯»å–</li></ol></li><li>å…¸å‹çš„ä»£è¡¨ï¼šVoltDB / H-Store, Redis å’Œ Datomic</li><li>é€šå¸¸ä¸èƒ½æ”¯æŒäº¤äº’å¼çš„å¤šè¯­å¥äº‹åŠ¡ï¼ˆå¦åˆ™å¾—ç­‰å¾…å¤ªä¹…äº†ï¼‰<br> <img src="./procedure.png" alt=""></li><li>æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼Œä¸²è¡Œæ‰§è¡Œäº‹åŠ¡ç§‘å®ç°ä¸²è¡ŒåŒ–éš”ç¦»ï¼š<ol><li>äº‹åŠ¡å¿…é¡»<strong>ç®€çŸ­é«˜æ•ˆ</strong></li><li>ä»…é™äºæ´»åŠ¨æ•°æ®é›†å®Œå…¨å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„åœºæ™¯</li><li>å†™å…¥ååå¿…é¡»è¶³å¤Ÿä½ï¼Œæ‰èƒ½åœ¨å•æ ¸ä¸Šå¤„ç†ï¼›å¦åˆ™éœ€è¦é‡‡ç”¨åˆ†åŒºï¼Œä½†æœ€å¥½ä¸è¦ä½¿ç”¨è·¨åˆ†åŒºäº‹åŠ¡ï¼ˆé¿å…åè°ƒå¼€é”€ï¼‰</li><li>è·¨åˆ†åŒºäº‹åŠ¡å¯ä»¥æ”¯æŒï¼Œä½†å æ¯”å¿…é¡»è¦å°</li></ol></li></ol><h2 id="ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase-Lock-2PLï¼‰"><a href="#ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase-Lock-2PLï¼‰" class="headerlink" title="ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lock, 2PLï¼‰"></a>ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lock, 2PLï¼‰</h2><ol><li>2PL æ˜¯æ¯”è¾ƒè€ç‰Œçš„ä¸²è¡ŒåŒ–ç®—æ³•ï¼Œåº”ç”¨äº MySQL InnoDB å’Œ SQL Server çš„ã€Œå¯ä¸²è¡ŒåŒ–éš”ç¦»ã€å’Œ DB2 çš„ã€Œå¯é‡å¤è¯»éš”ç¦»ã€ã€‚æ‚²è§‚äº‹åŠ¡æ¨¡å‹ã€‚</li><li>å…¸å‹ç‰¹å¾ï¼š<ol><li>è¯»å†™äº’æ–¥</li><li>å¹¶å‘å†™äº’æ–¥</li></ol></li><li><p>åŸºæœ¬æ€è·¯ï¼ˆæ•°æ®åº“ä¼šä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤è¯»å†™é”æ¥éš”ç¦»è¯»å†™æ“ä½œï¼Œé”å¯ä»¥å¤„äº<strong>å…±äº«æ¨¡å¼</strong>æˆ–<strong>ç‹¬å æ¨¡å¼</strong>ï¼‰ï¼š</p><ol><li>å¦‚æœäº‹åŠ¡è¦è¯»å–å¯¹è±¡ï¼Œå¿…é¡»å…ˆä»¥å…±äº«æ¨¡å¼è·å¾—é”ã€‚å¤šä¸ªäº‹åŠ¡å¯åŒæ—¶ä»¥è·å¾—å¯¹è±¡çš„å…±äº«é”ï¼›ä½†å¦‚æœæŸä¸ªäº‹åŠ¡è·å¾—äº†å¯¹è±¡çš„ç‹¬å é”ï¼Œåˆ™å…¶ä»–äº‹åŠ¡éƒ½éœ€è¦ç­‰å¾…</li><li>å¦‚æœäº‹åŠ¡è¦ä¿®æ”¹å¯¹è±¡ï¼Œå¿…é¡»ä»¥ç‹¬å æ¨¡å¼è·å–é”ã€‚å¦‚æœå¯¹è±¡å·²ç»åŠ é”ï¼ˆä¸ç®¡æ˜¯è¯»è¿˜æ˜¯å†™ï¼‰ï¼Œåˆ™è¯¥äº‹åŠ¡å¿…é¡»ç­‰å¾…</li><li>å¦‚æœäº‹åŠ¡å…ˆè¯»åå†™ï¼Œåˆ™å°†å…±äº«é”å‡çº§ä¸ºç‹¬å é”</li><li>äº‹åŠ¡è·å–é”åï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰ä¼šé‡Šæ”¾</li></ol></li><li><p>ä¸¤é˜¶æ®µçš„å«ä¹‰ï¼š</p><ol><li>äº‹åŠ¡æ‰§è¡Œå‰<strong>è·å–é”</strong></li><li>äº‹åŠ¡ç»“æŸå<strong>é‡Šæ”¾é”</strong></li></ol></li><li><p>2PL çš„é—®é¢˜ï¼š</p><ol><li>ç³»ç»Ÿååé‡å’ŒæŸ¥è¯¢å“åº”æ—¶é—´ç›¸å¯¹äºå¼±éš”ç¦»çº§åˆ«ä¸‹é™å¾ˆå¤š</li><li>é”çš„å¼€é”€å¤šï¼›äº‹åŠ¡çš„å¹¶å‘æ€§é™ä½</li><li>è®¿é—®å»¶è¿Ÿä¸ç¡®å®šæ€§é«˜</li><li>æ­»é”é—®é¢˜ï¼Œå¦‚æœæ£€æµ‹åˆ°æ­»é”ï¼Œäº‹åŠ¡ä¼šè¢«å¼ºè¡Œä¸­æ­¢ï¼ˆåº”ç”¨å±‚å¯é€‰æ‹©é‡è¯•ï¼‰</li></ol></li><li><p>è°“è¯é”ï¼š</p><ol><li>ä¸å±äºç‰¹å®šçš„å¯¹è±¡ï¼Œä½œç”¨äºç‰¹å®šçš„æœç´¢æ¡ä»¶æŸ¥è¯¢åˆ°çš„æ‰€æœ‰å¯¹è±¡</li><li>å¯ä»¥ä¿æŠ¤æ•°æ®åº“ä¸­å°šä¸å­˜åœ¨ä½†å¯èƒ½é©¬ä¸Šä¼šè¢«æ’å…¥çš„å¯¹è±¡ï¼ˆä¼šå¼•èµ·å¹»è¯»ï¼‰</li><li>2PL å’Œè°“è¯é”ç»“ç›Ÿï¼Œå¯é˜»æ­¢ä»»ä½•å½¢å¼çš„å†™å€¾æ–œå’Œå…¶å®ƒç«äº‰æ¡ä»¶ï¼Œä½¿å¾—éš”ç¦»çœŸæ­£ä¸²è¡ŒåŒ–</li><li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸ä½³</li></ol></li><li><p>ç´¢å¼•åŒºé—´é”ï¼ˆnext-key lockingï¼‰</p><ol><li>æ ¸å¿ƒå°±æ˜¯å°†ä¿æŠ¤å¯¹è±¡æ‰©å¤§åŒ–ï¼Œä¸å¦‚ä¸ºè°“è¯é”ç²¾ç¡®ï¼Œä½†å¼€é”€ä½ï¼Œæ‰€ä»¥å®è·µä¸­å¸¸ç”¨</li><li>ä¼šå¯¹åˆé€‚çš„ç´¢å¼•åŠ åŒºé—´é”ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„ç´¢å¼•ï¼Œå°±å›é€€åˆ°æ•´å¼ è¡¨åŠ å…±äº«é”</li></ol></li></ol><h2 id="å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable-Snapshot-Isolation-SSIï¼‰"><a href="#å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable-Snapshot-Isolation-SSIï¼‰" class="headerlink" title="å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰"></a>å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰</h2><ol><li>SSI æ˜¯ä¹è§‚äº‹åŠ¡æ¨¡å‹å®ç°ï¼Œå¦‚æœå¯èƒ½å‘ç”Ÿå†²çªï¼Œä¹Ÿä¸ä¼šé˜»æ­¢äº‹åŠ¡æäº¤ï¼Œè€Œæ˜¯åœ¨çœŸæ­£æäº¤æ—¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å†²çªï¼ˆå³è¿åéš”ç¦»æ€§åŸåˆ™ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šä¸­æ­¢å¹¶æ¥ä¸‹æ¥é‡è¯•ã€‚</li><li>é€‚ç”¨äºäº‹åŠ¡ä¹‹é—´ç«äº‰ä¸å¤§ï¼Œå†²çªè¾ƒå°‘çš„åœºæ™¯ï¼Œä¼šæ¯”æ‚²è§‚æ–¹å¼é«˜æ•ˆå¾ˆå¤šï¼ˆæ‰€ä»¥ä¹Ÿæ¯”è¾ƒé€‚ç”¨äºäº’è”ç½‘ç¯å¢ƒï¼‰ã€‚</li><li>äº‹åŠ¡æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡æ‰€æŒæœ‰çš„é”ï¼Œè¦æ±‚è¯»å†™å‹äº‹åŠ¡è¦ç®€çŸ­ï¼ˆé•¿æ—¶é—´çš„è¯»å–äº‹åŠ¡æ²¡æœ‰é™åˆ¶ï¼‰<br><img src="./collision-detection.png" alt=""></li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ†</a></li><li><a href="https://www.zhihu.com/question/280650327" target="_blank" rel="noopener">çŸ¥ä¹ï¼šSQL å››ç§éš”ç¦»çº§åˆ«çš„è‹¥å¹²è¿·æƒ‘ï¼Ÿ</a></li><li><a href="https://zhuanlan.zhihu.com/p/38214642" target="_blank" rel="noopener">æ•°æ®åº“äº‹åŠ¡éš”ç¦»æ ‡å‡†åˆ†æ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ç”±äºæ•°æ®å­˜å‚¨æœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿé”™è¯¯ã€æ•…éšœçš„ç‚¹ç‰¹åˆ«å¤šï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€ç£ç›˜å†™æ»¡ç­‰ï¼Œé¢å¯¹è¿™äº›å¤æ‚çš„æƒ…å†µï¼Œåº”ç”¨å±‚åº”ä»˜èµ·æ¥éå¸¸å›°éš¾ã€‚æ‰€ä»¥å°±æœ‰äº†äº‹åŠ¡çš„æ¦‚å¿µï¼Œè¯´é“äº‹åŠ¡ï¼Œæˆ‘ä»¬æœ€å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šå¯ä»¥ä¸€æ¬¡äº‹åŠ¡ä¸­å°†å¾ˆå¤šè¯»å†™å…¥æ“ä½œæ‰“åŒ…æˆä¸€ä¸ªé€»è¾‘æ“ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æˆåŠŸï¼ˆCommittedï¼‰ä¾¿æˆä»ï¼ˆRollbackï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æƒ…å†µå®‰å…¨åœ°é‡è¯•ï¼Œä¸ç”¨æ‹…å¿ƒéƒ¨åˆ†å†™å…¥çš„é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹" scheme="http://ifaceless.space/tags/%E3%80%8A%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1%E3%80%8B/"/>
    
      <category term="äº‹åŠ¡" scheme="http://ifaceless.space/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®å¤åˆ¶å’Œåˆ†åŒº</title>
    <link href="http://ifaceless.space/2019/08/18/ddia-data-replication-and-partition/"/>
    <id>http://ifaceless.space/2019/08/18/ddia-data-replication-and-partition/</id>
    <published>2019-08-18T11:27:19.000Z</published>
    <updated>2019-11-24T09:45:59.823Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ç³»ç»ŸåŸºç¡€å­¦ä¹ åï¼Œå°±å¼€å§‹è¿›å…¥åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿçš„ä¸–ç•Œäº†ã€‚å‰é¢å­¦ä¹ çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„æƒ…å†µï¼›ç„¶è€Œï¼Œåœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„<strong>æ‰©å±•æ€§</strong>ã€<strong>å®¹é”™æ€§</strong>ä»¥åŠ<strong>å»¶è¿Ÿæ€§</strong>ç­‰ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é€šå¸¸ä¼šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚åº¦è‡ªç„¶ä¹Ÿä¸Šæ¥äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä¸»è¦å­¦ä¹ æ•°æ®ç³»ç»Ÿçš„å¤åˆ¶ã€åˆ†åŒºã€äº‹åŠ¡ã€ä¸€è‡´æ€§å…±è¯†ç®—æ³•ã€ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„ä¸€äº›æŒ‘æˆ˜ç­‰ï¼Œè¿™äº›çŸ¥è¯†éƒ½æ¯”è¾ƒç¡¬æ ¸ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚æ‰€ä»¥ï¼Œã€Œä¸Šè½¦ï¼Œèµ°å§~ã€</p><p>æœ¬ç¯‡ç¬”è®°é‡ç‚¹æ˜¯å…³äºæ•°æ®ç³»ç»Ÿçš„å¤åˆ¶å’Œåˆ†åŒºï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§„çš„ä¸»ä»å¤åˆ¶åŸç†ã€å¤šä¸»å¤åˆ¶çš„åº”ç”¨åœºæ™¯ï¼Œå¦å¤–è¿˜ä»‹ç»äº†æ— ä¸»å¤åˆ¶çš„ç³»ç»Ÿï¼ˆå¦‚äºšé©¬é€Š Dynamo ç³»ç»Ÿï¼‰ã€‚æœ€åå°±æ˜¯å…³äºæ•°æ®åˆ†åŒºçš„ä»‹ç»ï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§çš„åˆ†åŒºç­–ç•¥ï¼ŒåŠ¨æ€å¹³è¡¡ç­–ç•¥ç­‰ã€‚</p><a id="more"></a><h1 id="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ</h1><h2 id="å…±äº«æ¶æ„"><a href="#å…±äº«æ¶æ„" class="headerlink" title="å…±äº«æ¶æ„"></a>å…±äº«æ¶æ„</h2><p>é’ˆå¯¹å…±äº«æ¶æ„ï¼Œå¦‚æœè´Ÿè½½å¢åŠ ï¼Œæœ€å¸¸è§çš„æ‰©å±•æ–¹å¼å°±æ˜¯é‡‡ä¹°æ›´å¼ºå¤§çš„ CPUã€æ·»åŠ æ›´å¤šçš„å†…å­˜ç­‰ã€‚è¿™ç§è¢«ç§°ä¸ºå‚ç›´æ‰©å±•ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸ä¸€å®šå¥æ•ˆï¼Œå¤©èŠ±æ¿æ˜¯çœ‹å¾—è§çš„ã€‚å¹¶ä¸”æ‰©å±•çš„æˆæœ¬éçº¿æ€§ï¼Œè€Œåº”å¯¹è´Ÿè½½çš„èƒ½åŠ›å´ä¸ä¸€å®šèƒ½çº¿æ€§æé«˜ã€‚</p><h2 id="æ— å…±äº«æ¶æ„"><a href="#æ— å…±äº«æ¶æ„" class="headerlink" title="æ— å…±äº«æ¶æ„"></a>æ— å…±äº«æ¶æ„</h2><p>åœ¨æ— å…±äº«æ¶æ„ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹çš„ CPUã€å†…å­˜å’Œç£ç›˜ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡é‡‡ç”¨ä»¥å¤ªç½‘ã€‚è¯¥æ¶æ„æ— éœ€ç‰¹æ®Šçš„ç¡¬ä»¶æ”¯æŒï¼Œæ€§ä»·æ¯”é«˜ã€‚æ‰©å±•æ€§å¥½ï¼ˆæ°´å¹³æ‰©å±•ï¼‰ï¼Œå¹¶ä¸”æœ‰å¼ºå¤§çš„å®¹é”™èƒ½åŠ›å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚ä¸è¿‡è¿™ç§æ¶æ„æœ€å¤§çš„é—®é¢˜æ˜¯ä¼šå¸¦æ¥æ›´å¤§çš„å¤æ‚æ€§ï¼Œç”šè‡³ä¼šé™åˆ¶å®é™…å¯ä½¿ç”¨çš„æ•°æ®æ¨¡å‹ã€‚</p><h1 id="æ•°æ®å¤åˆ¶"><a href="#æ•°æ®å¤åˆ¶" class="headerlink" title="æ•°æ®å¤åˆ¶"></a>æ•°æ®å¤åˆ¶</h1><h2 id="ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹"><a href="#ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹" class="headerlink" title="ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹"></a>ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹</h2><ol><li>æ¯ä¸ªä¿å­˜äº†æ•°æ®åº“å®Œæ•´æ•°æ®é›†çš„èŠ‚ç‚¹å«ä½œå‰¯æœ¬</li><li>ä¸»ä»å¤åˆ¶æ–¹æ¡ˆï¼š<ol><li>æŒ‡å®šæŸä¸ªå‰¯æœ¬ä¸ºä¸»å‰¯æœ¬ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ã€‚å†™å…¥ä¼šå‘ç»™ä¸»èŠ‚ç‚¹</li><li>ä¸»èŠ‚ç‚¹åœ¨å°†æ–°æ•°æ®å­˜å‚¨åï¼Œå°†æ›´æ”¹ä½œä¸ºå¤åˆ¶çš„æ—¥å¿—æˆ–è€…æ›´æ”¹æµçš„æ–¹å¼å‘ç»™ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹è·å–æ›´æ”¹æ—¥å¿—ï¼Œå¹¶åº”ç”¨åˆ°æœ¬åœ°ï¼Œè¿™é‡Œå¿…é¡»è¦ä¿æŒå’Œä¸»å‰¯æœ¬ç›¸åŒçš„å†™å…¥é¡ºåº</li><li>å®¢æˆ·ç«¯è¯»å–æ—¶ï¼Œå¯è¯»å–ä»å‰¯æœ¬çš„æ•°æ®<br><img src="./master-slave-replication.png" alt=""></li></ol></li></ol><h3 id="åŒæ­¥å¤åˆ¶-v-s-å¼‚æ­¥å¤åˆ¶"><a href="#åŒæ­¥å¤åˆ¶-v-s-å¼‚æ­¥å¤åˆ¶" class="headerlink" title="åŒæ­¥å¤åˆ¶ v.s. å¼‚æ­¥å¤åˆ¶"></a>åŒæ­¥å¤åˆ¶ v.s. å¼‚æ­¥å¤åˆ¶</h3><p><img src="./data-sync.png" alt=""></p><ol><li>å¯¹äºå…³ç³»æ•°æ®åº“ï¼Œä¸¤ç§å¤åˆ¶æ–¹å¼é€šå¸¸æ˜¯å¯é…ç½®çš„ï¼›è€Œå…¶ä»–ç³»ç»Ÿå¯èƒ½åªå¯æŒ‡å®šå…¶ä¸­ä¸€ç§æ–¹å¼ã€‚</li><li>åŒæ­¥å¤åˆ¶ï¼š<ol><li>ä¼˜ç‚¹ï¼šä¸€æ—¦å‘ç”¨æˆ·ç¡®è®¤å†™å…¥è¯·æ±‚ï¼Œåˆ™ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œå¹¶éƒ½å¤„äºæœ€æ–°ç‰ˆæœ¬ã€‚ä¸»åº“å®•æœºï¼Œä¹Ÿå¯ä»¥æ”¾å¿ƒä»ä»åº“è¯»å–ã€‚</li><li>ç¼ºç‚¹ï¼šå¦‚æœä»èŠ‚ç‚¹æ— æ³•å®Œæˆç¡®è®¤ï¼ˆå¦‚ç½‘ç»œæ‹¥å¡ã€æ•…éšœç­‰ï¼‰ï¼Œå†™å…¥ä¼šå¤±è´¥ã€‚ä¸»èŠ‚ç‚¹ä¼šé˜»å¡åç»­å†™è¯·æ±‚ï¼Œé™ä½ç³»ç»Ÿååé‡å’Œå¯é æ€§ã€‚</li></ol></li><li><strong>åŠåŒæ­¥</strong>ï¼šå®è·µä¸­ï¼Œå¦‚æœå¼€å¯äº†åŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œé€šå¸¸æ˜¯å…¶ä¸­çš„<strong>æŸä¸ªä»èŠ‚</strong>ï¼ˆå¯æ ¹æ®æƒ…å†µé€‰æ‹©å…¶ä»–ä»èŠ‚ç‚¹æå‡ä¸ºåŒæ­¥æ¨¡å¼ï¼‰ç‚¹ä¸ºåŒæ­¥å¤åˆ¶ï¼Œè€Œå…¶ä»–ä¸ºå¼‚æ­¥å¤åˆ¶æ¨¡å¼ã€‚</li><li><strong>å…¨å¼‚æ­¥</strong>ï¼š<ol><li>ä¼˜ç‚¹ï¼šç³»ç»Ÿçš„ååæ€§èƒ½å¾ˆå¥½</li><li>ç¼ºç‚¹ï¼šæ•°æ®çš„æŒä¹…åŒ–æ— æ³•å¾—åˆ°ä¿è¯ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±çš„æƒ…å†µ</li></ol></li></ol><h3 id="é…ç½®æ–°çš„ä»èŠ‚ç‚¹"><a href="#é…ç½®æ–°çš„ä»èŠ‚ç‚¹" class="headerlink" title="é…ç½®æ–°çš„ä»èŠ‚ç‚¹"></a>é…ç½®æ–°çš„ä»èŠ‚ç‚¹</h3><ol><li><p>ä»€ä¹ˆæ—¶å€™éœ€è¦ï¼Ÿ</p><ol><li>æé«˜è´Ÿè½½èƒ½åŠ›</li><li>æä¾›å®¹é”™èƒ½åŠ›</li><li>æ›¿æ¢å¤±è´¥çš„å‰¯æœ¬</li></ol></li><li><p>è¦æƒ³åšåˆ°ä¸åœæœºå®Œæˆæ–°èŠ‚ç‚¹æ·»åŠ ï¼Œé€»è¾‘ä¸Šä¸»è¦æ“ä½œå¦‚ä¸‹ï¼š</p><ol><li><strong>ç”Ÿæˆå¿«ç…§</strong>ï¼šåœ¨æŸåˆ»å¯¹ä¸»èŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬äº§ç”Ÿä¸€ä¸ªä¸€è‡´æ€§å¿«ç…§ï¼ˆé¿å…é•¿æ—¶é—´é”åº“ï¼‰</li><li><strong>å¿«ç…§å‘é€</strong>ï¼šå¿«ç…§å‘é€åˆ°æ–°çš„ä»èŠ‚ç‚¹ï¼ˆè¿™æ ·å¤§éƒ¨åˆ†çš„å†å²æ•°æ®å°±æœ‰äº†ï¼‰</li><li><strong>å˜æ›´æ—¥å¿—</strong>ï¼šä»èŠ‚ç‚¹ä¸Šçº¿è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ï¼Œ<strong>è¯·æ±‚å¿«ç…§ç‚¹ä¹‹åå‘ç”Ÿçš„æ‰€æœ‰æ•°æ®æ›´æ”¹æ—¥å¿—</strong>ï¼ˆå¢é‡ï¼‰</li><li><strong>è¿½èµ¶</strong>ï¼šè·å¾—æ—¥å¿—åï¼Œä»èŠ‚ç‚¹åº”ç”¨å¿«ç…§åçš„æ•°æ®å˜æ›´ã€‚ç»§ç»­å¤„ç†ä¸»èŠ‚ç‚¹ä¸Šæ–°æ•°æ®å˜åŒ–ã€‚å¹¶é‡å¤æ­¥éª¤ 1~4</li></ol></li></ol><h3 id="èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ"><a href="#èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ"></a>èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ</h3><ol><li><strong>ä»èŠ‚ç‚¹å¤±æ•ˆï¼šè¿½èµ¶å¼æ¢å¤</strong>ã€‚ä»èŠ‚ç‚¹å¯æ ¹æ®å‰¯æœ¬çš„å¤åˆ¶æ—¥å¿—å¾—çŸ¥æ•…éšœå‰æœ€åä¸€ç¬”äº‹åŠ¡ï¼Œç„¶åå‘ä¸»èŠ‚ç‚¹è¯·æ±‚è¯¥äº‹åŠ¡ä¹‹åä¸­æ–­æœŸé—´å†…çš„æ‰€æœ‰æ•°æ®å˜æ›´ï¼Œå¹¶åº”ç”¨å˜æ›´ï¼Œå®Œæˆè¿½èµ¶ã€‚</li><li><p><strong>ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼šèŠ‚ç‚¹åˆ‡æ¢</strong>ï¼š</p><ol><li>æ•…éšœåˆ‡æ¢å¯æ‰‹åŠ¨ï¼Œå¯è‡ªåŠ¨ã€‚</li><li>è‡ªåŠ¨åˆ‡æ¢å¸¸è§„æ­¥éª¤ï¼š<ol><li><em>ç¡®å®šä¸»èŠ‚ç‚¹å¤±æ•ˆ</em>ã€‚å¤šé‡‡ç”¨åŸºäºè¶…æ—¶çš„æœºåˆ¶ï¼Œå¯ä»¥å‘¨æœŸæ€§åœ°å‘é€å¿ƒè·³åŒ…ã€‚</li><li><em>é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹</em>ã€‚æ¶‰åŠåˆ°å…±è¯†çš„ç®—æ³•ï¼ŒåŸåˆ™æ˜¯è¦ä¿è¯æ–°çš„ä¸»èŠ‚ç‚¹ä¸åŸæ¥çš„æ•°æ®å·®å¼‚æœ€å°ï¼Œå°½å¯èƒ½å‡å°‘æ•°æ®ä¸¢å¤±é£é™©ã€‚</li><li><em>é‡æ–°é…ç½®ç³»ç»Ÿï¼Œç”Ÿæ•ˆä¸»èŠ‚ç‚¹</em>ã€‚å®¢æˆ·ç«¯éœ€è¦å°†å†™è¯·æ±‚å‘é€åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¯¹äºåŸä¸»èŠ‚ç‚¹æ¢å¤åéœ€è¦ç¡®ä¿å…¶è¢«é™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œè®¤å¯æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li></ol></li></ol></li><li><p>éœ€è¦æ€è€ƒçš„é—®é¢˜ï¼š</p><ol><li>å¦‚æœé‡‡ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾åï¼ŒåŸä¸»èŠ‚ç‚¹ä¹Ÿä¸Šçº¿ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹å¯èƒ½ä¼šæ”¶åˆ°<strong>å†™å†²çª</strong>ã€‚ç®€å•ç²—æš´çš„æ–¹å¼å°±æ˜¯ï¼ŒæŠ›å¼ƒåŸä¸»èŠ‚ç‚¹æœªå®Œæˆå¤åˆ¶çš„å†™è¯·æ±‚ï¼Œè¿èƒŒæ•°æ®æŒä¹…åŒ–æ‰¿è¯ºã€‚</li><li><strong>è„‘è£‚ï¼ˆBrain-Splitï¼‰</strong>é—®é¢˜ï¼Œä¸¤ä¸ªä¸»èŠ‚ç‚¹éƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œä¼šå¯¼è‡´æ•°æ®å†²çªã€ä¸¢å¤±æˆ–è€…ç ´åç­‰ã€‚å¯ç²—æš´åœ°å…³é—­æŸä¸ªä¸»èŠ‚ç‚¹ã€‚</li><li>è¶…æ—¶è®¾ç½®å¤šä¹…æ‰åˆé€‚ï¼Ÿå¤ªé•¿ï¼Œæ„å‘³ç€ä¸»èŠ‚ç‚¹å®•æœºåï¼Œæ€»ä½“æ¢å¤æ—¶é—´å˜é•¿ï¼›å¤ªçŸ­ï¼Œä¼šå¯¼è‡´å¾ˆå¤šä¸å¿…è¦çš„åˆ‡æ¢ã€‚å°¤å…¶æ˜¯ç³»ç»Ÿå¤„äºé«˜è´Ÿè½½çš„å‹åŠ›ä¸‹ï¼ŒåŒæ—¶ç½‘ç»œæ‹¥å¡ä¸¥é‡ï¼Œä¸å¿…è¦çš„åˆ‡æ¢ä¼šå¯¼è‡´æƒ…å†µæ›´åŠ ç³Ÿç³•ã€‚</li></ol></li></ol><h3 id="å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°"><a href="#å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°" class="headerlink" title="å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°"></a>å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°</h3><ol><li><p><strong>åŸºäºè¯­å¥çš„å¤åˆ¶</strong>ï¼š</p><ol><li>çœ‹èµ·æ¥ä¸å¤æ‚</li><li>ä¸é€‚ç”¨çš„åœºæ™¯ï¼šè°ƒç”¨éç¡®å®šæ€§å‡½æ•°çš„è¯­å¥ï¼›å‰¯æœ¬éœ€è¦ä¸¥æ ¼æŒ‰ç…§å®Œå…¨ç›¸åŒçš„é¡ºåºæ‰§è¡Œè¯­å¥ï¼ˆé’ˆå¯¹ä¾èµ–æ•°æ®åº“çš„ç°æœ‰æ•°æ®çš„æƒ…å†µï¼‰ï¼›æœ‰å‰¯ä½œç”¨çš„è¯­å¥ï¼Œåœ¨ä¸åŒçš„èŠ‚ç‚¹å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„å‰¯ä½œç”¨</li></ol></li><li><p><strong>åŸºäº WAL ä¼ è¾“</strong>ï¼š</p><ol><li>å¯ä»¥åŸºäº WAL æ„å»ºä¸€ä¸ªå®Œæ•´çš„å‰¯æœ¬</li><li>æ—¥å¿—æè¿°çš„æ•°æ®ç»“æ„å¾ˆåº•å±‚ï¼Œå¤åˆ¶æ–¹æ¡ˆä¸å­˜å‚¨å¼•æ“ç´§å¯†è€¦åˆï¼›åè®®ç‰ˆæœ¬å‡çº§éœ€è¦é¡¾è™‘çš„è¾ƒå¤š</li></ol></li><li><p><strong>åŸºäºè¡Œçš„é€»è¾‘æ—¥å¿—å¤åˆ¶</strong>ï¼š</p><ol><li>é€»è¾‘æ—¥å¿—ï¼ŒåŒºåˆ†ç‰©ç†å­˜å‚¨å¼•æ“çš„æ•°æ®è¡¨ç¤ºã€‚æè¿°æ•°æ®è¡¨è¡Œçº§åˆ«çš„å†™è¯·æ±‚ã€‚</li><li>ä¸å­˜å‚¨å¼•æ“é€»è¾‘è§£è€¦ï¼Œä¾¿äºä¿æŒå‘åå…¼å®¹ã€‚è¿™æ ·ä¸»ä»èŠ‚ç‚¹ç”šè‡³å¯ä»¥è¿è¡Œä¸åŒçš„ç‰ˆæœ¬æˆ–è€…ä½¿ç”¨ä¸åŒçš„å­˜å‚¨å¼•æ“ã€‚</li><li>å®¹æ˜“è§£æï¼Œæ˜“äºå¤–éƒ¨ç³»ç»Ÿå¤„ç†</li></ol></li><li><p><strong>åŸºäºè§¦å‘å™¨çš„å¤åˆ¶</strong>ï¼šç»™åº”ç”¨å±‚æä¾›äº†ä¸€å®šçš„çµæ´»æ€§ï¼Œä½†æ˜¯å¤åˆ¶å¼€é”€æ›´é«˜ã€‚</p></li></ol><h2 id="å¤åˆ¶æ»åé—®é¢˜"><a href="#å¤åˆ¶æ»åé—®é¢˜" class="headerlink" title="å¤åˆ¶æ»åé—®é¢˜"></a>å¤åˆ¶æ»åé—®é¢˜</h2><h3 id="è¯»è‡ªå·±çš„å†™ï¼ˆRead-After-Writeï¼‰"><a href="#è¯»è‡ªå·±çš„å†™ï¼ˆRead-After-Writeï¼‰" class="headerlink" title="è¯»è‡ªå·±çš„å†™ï¼ˆRead After Writeï¼‰"></a>è¯»è‡ªå·±çš„å†™ï¼ˆRead After Writeï¼‰</h3><p><img src="./read-after-write.png" alt=""></p><ol><li>è¯¥æœºåˆ¶è¦ä¿è¯ç”¨æˆ·æ€»èƒ½çœ‹åˆ°è‡ªå·±æœ€è¿‘æäº¤çš„æ›´æ–°ã€‚</li><li>å¦‚ä½•å®ç°ï¼Ÿ<ol><li>å¦‚æœç”¨æˆ·è®¿é—®å¯èƒ½è¢«ä¿®æ”¹çš„å†…å®¹ï¼Œåˆ™ä»ä¸»èŠ‚ç‚¹è¯»ï¼›å¦åˆ™ä»ä»èŠ‚ç‚¹è¯»ã€‚</li><li>é’ˆå¯¹å¤§éƒ¨åˆ†éƒ½ä¼šè¢«ä¿®æ”¹çš„åœºæ™¯ï¼Œä¸Šè¿°æ–¹å¼ä¼šä¸§å¤±ä»èŠ‚ç‚¹çš„å­˜åœ¨æ„ä¹‰ã€‚å¯ä»¥è€ƒè™‘è·Ÿè¸ªæœ€æ–°çš„æ›´æ–°æ—¶é—´ï¼Œå¯¹äºæ›´æ–°æ—¶é—´åœ¨æœ€è¿‘ä¸€åˆ†é’Ÿçš„ï¼Œä»ä¸»èŠ‚ç‚¹è¯»å–ã€‚åŒæ—¶éœ€è¦æ·»åŠ ç›‘æ§ã€‚</li></ol></li></ol><h3 id="å•è°ƒè¯»"><a href="#å•è°ƒè¯»" class="headerlink" title="å•è°ƒè¯»"></a>å•è°ƒè¯»</h3><p><img src="./monotonic-read.png" alt=""></p><ol><li>ç”¨æˆ·åœ¨è¯»å–ä¿®æ”¹äº†çš„æ•°æ®æ—¶ï¼Œå‡ºç°ã€Œå›æ»šã€çš„ç°è±¡ã€‚ä¹Ÿå°±æ˜¯æ˜æ˜ä¿®æ”¹äº†ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™çœ‹åˆ°äº†æ–°çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¯»å–çš„æ—¶å€™å´çœ‹åˆ°äº†æ—§çš„æ•°æ®ï¼ˆå¤šèŠ‚ç‚¹æ•°æ®æœªåŒæ­¥ï¼‰ã€‚</li><li>å•è°ƒè¯»è¦æä¾›çš„ä¿è¯å°±æ˜¯é¿å…è¿™ç§å¥‡æ€ªçš„å›æ»šç°è±¡ï¼Œå®ƒæ¯”å¼ºä¸€è‡´æ€§è¦å¼±ï¼Œä½†æ¯”æœ€ç»ˆä¸€è‡´æ€§è¦å¼ºã€‚</li><li>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥è€ƒè™‘åŒä¸€ä¸ªç”¨æˆ·æ€»æ˜¯ä»æŸä¸ªå›ºå®šçš„å‰¯æœ¬è¯»å–ï¼ˆä¸åŒçš„ç”¨æˆ·åˆ†å‘åˆ°ä¸åŒçš„å‰¯æœ¬ï¼‰ã€‚</li></ol><h3 id="å‰ç¼€ä¸€è‡´è¯»"><a href="#å‰ç¼€ä¸€è‡´è¯»" class="headerlink" title="å‰ç¼€ä¸€è‡´è¯»"></a>å‰ç¼€ä¸€è‡´è¯»</h3><p><img src="./prefix-read.png" alt=""></p><ol><li>è¯¥æœºåˆ¶è¦ä¿è¯å¯¹äºä¸€ç³»åˆ—æŒ‰ç…§ç‰¹å®šé¡ºåºçš„å†™è¯·æ±‚ï¼Œåœ¨è¯»å–è¿™äº›å†…å®¹æ—¶è¦è¦éµå¾ªåŒæ ·çš„é¡ºåºã€‚å¦åˆ™å¯èƒ½ä¼šçœ‹åˆ°å…ˆæœ‰æœï¼Œå†æœ‰å› çš„å¥‡æ€ªç°è±¡ï¼Œä»¿ä½›é‡åˆ°äº†å…ˆçŸ¥ã€‚</li><li>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æ‹¥æœ‰å› æœå…³ç³»çš„å†™å…¥éƒ½æäº¤ç»™æŸä¸ªç‰¹å®šåˆ†åŒºå®Œæˆï¼Œä½†æ˜¯å®é™…æ•ˆç‡æ¯”è¾ƒä½ã€‚</li></ol><h2 id="å¤šä¸»èŠ‚ç‚¹å¤åˆ¶"><a href="#å¤šä¸»èŠ‚ç‚¹å¤åˆ¶" class="headerlink" title="å¤šä¸»èŠ‚ç‚¹å¤åˆ¶"></a>å¤šä¸»èŠ‚ç‚¹å¤åˆ¶</h2><p><img src="./multi-master-nodes.png" alt=""></p><ol><li>ä¸»ä»æ¨¡å¼çš„ç¼ºç‚¹ï¼šç³»ç»Ÿä»…æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ‰¿è½½æ‰€æœ‰çš„å†™è¯·æ±‚ã€‚å¦‚æœä¸»èŠ‚ç‚¹å®•æœºï¼Œä¼šå½±å“æ‰€æœ‰çš„å†™å…¥æ“ä½œã€‚</li><li>å¤šä¸»èŠ‚ç‚¹å¤åˆ¶ï¼š<ol><li>æ¯ä¸ªä¸»èŠ‚ç‚¹åˆ†åˆ«æ¥å—å†™è¯·æ±‚ï¼Œå¹¶å¤åˆ¶ï¼ˆå¼‚æ­¥ or åŒæ­¥ï¼‰ç»™å¯¹åº”çš„ä»èŠ‚ç‚¹</li><li>æ¯ä¸ªä¸»èŠ‚ç‚¹æ‰®æ¼”å…¶å®ƒä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹</li></ol></li></ol><h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><ol><li>å¤šæ•°æ®ä¸­å¿ƒ</li><li>ç¦»çº¿å®¢æˆ·ç«¯æ“ä½œï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ WizNoteï¼‰ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½å……å½“ä¸»èŠ‚ç‚¹çš„æœ¬åœ°æ•°æ®åº“ï¼Œè®¾å¤‡ä¹‹é—´é‡‡ç”¨å¼‚æ­¥åŒæ­¥æ–¹å¼å®Œæˆæ•°æ®åŒæ­¥ã€‚åŒæ­¥æ»åæ—¶é—´ä¸å®šã€‚</li><li>åä½œç¼–è¾‘</li></ol><h2 id="æ— ä¸»èŠ‚ç‚¹å¤åˆ¶"><a href="#æ— ä¸»èŠ‚ç‚¹å¤åˆ¶" class="headerlink" title="æ— ä¸»èŠ‚ç‚¹å¤åˆ¶"></a>æ— ä¸»èŠ‚ç‚¹å¤åˆ¶</h2><ol><li>äºšé©¬é€Šçš„ Dynamo ç³»ç»Ÿæ˜¯å…¸å‹çš„ä»£è¡¨ï¼ŒRiakã€Cassandra ä¹Ÿå—åˆ°äº†å¯å‘ã€‚</li><li>å®¢æˆ·ç«¯ç›´æ¥å°†å†™è¯·æ±‚å‘é€ç»™å¤šä¸ªå‰¯æœ¬ï¼Œæˆ–è€…äº¤ç»™åè°ƒè€…ï¼ˆä¸ä¿è¯å†™å…¥é¡ºåºï¼‰æ¥å‘é€ã€‚</li><li><p>æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼Ÿ</p><ol><li>è¯»æ—¶ä¿®å¤</li><li>åç†µï¼šè¡¥å¿æœºåˆ¶ï¼Œå¯»æ‰¾èŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œå°†ç¼ºå°‘çš„æ•°æ®ç»™è¡¥å……å¥½ã€‚è¯¥è¿‡ç¨‹ä¸ä¿è¯ç‰¹å®šé¡ºåºçš„å¤åˆ¶å†™å…¥ã€‚<br><img src="./repair-on-read.png" alt=""></li></ol></li><li><p>è¯»å†™ quorumï¼š</p><ol><li>ä¿è¯ï¼šw + r &gt; nï¼ˆæ€»èŠ‚ç‚¹æ•°ï¼‰</li><li>é€šå¸¸ n ä¸ºå¥‡æ•°ï¼Œw = r = (n+1)/2 ï¼ˆå‘ä¸Šèˆå…¥ï¼‰</li><li>quorum ä¸ä¸€å®šéå¾—æ˜¯å¤šæ•°ï¼Œè¯»å†™èŠ‚ç‚¹é›†åˆä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯é‡å çš„èŠ‚ç‚¹æ‰æœ€ä¸ºå…³é”®ï¼</li><li>ä¸èƒ½ä¿è¯æ€»èƒ½è¯»å–åˆ°æœ€æ–°å€¼ï¼ŒDynamo æ•°æ®åº“é€šå¸¸é’ˆå¯¹æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ä¼˜åŒ–çš„ã€‚</li></ol></li><li>å¹¶å‘æ£€æµ‹ï¼ˆè¿™å—è¿˜æ˜¯å»ºè®®çœ‹ä¹¦ä¸­çš„ä¾‹å­å§ï¼‰ï¼š<ol><li>æœ€åå†™å…¥è€…è·èƒœï¼ˆLWWï¼‰ï¼Œä¸¢å¼ƒå¹¶å‘å†™å…¥ã€‚å¯å®ç°æœ€ç»ˆæ”¶æ•›ç›®æ ‡ï¼Œä½†æ˜¯ç‰ºç‰²äº†æ•°æ®æŒä¹…æ€§ä¸ºä»£ä»·ã€‚</li><li>Happens-before å…³ç³»ä¸å¹¶å‘</li><li>ç¡®å®šå‰åå…³ç³»ï¼šä½¿ç”¨ç‰ˆæœ¬å·</li><li>åˆå¹¶åŒæ—¶å†™å…¥çš„å€¼</li><li>ç‰ˆæœ¬çŸ¢é‡</li></ol></li></ol><h1 id="æ•°æ®åˆ†åŒº"><a href="#æ•°æ®åˆ†åŒº" class="headerlink" title="æ•°æ®åˆ†åŒº"></a>æ•°æ®åˆ†åŒº</h1><ol><li>å®šä¹‰ï¼šæ¯æ¡æ•°æ®ï¼ˆæˆ–è€…è®°å½•ã€æ–‡æ¡£ï¼‰åªå±äºæŸä¸ªç‰¹å®šåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯è§†ä¸ºä¸€ä¸ªå®Œæ•´çš„å°å‹æ•°æ®åº“ï¼Œæ˜¯æ•´ä¸ªæ•°æ®é›†çš„ä¸€éƒ¨åˆ†ã€‚</li><li><p>ä¸ºä»€ä¹ˆè¦åˆ†åŒºï¼Ÿ</p><ol><li>æé«˜ç³»ç»Ÿæ‰©å±•æ€§ï¼šå°†å¤§çš„æ•°æ®é›†åˆ†æ•£åˆ°æ›´å¤šçš„èŠ‚ç‚¹ï¼Œè´Ÿè½½å‡è¡¡</li><li>æé«˜æŸ¥è¯¢ååé‡ï¼šè·¨åˆ†åŒºå¹¶å‘æŸ¥è¯¢</li></ol></li><li><p>åˆ†åŒºå’Œå¤åˆ¶é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œæ¯ä¸ªåˆ†åŒºåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å‰¯æœ¬ï¼Œæé«˜ç³»ç»Ÿçš„å®¹é”™æ€§ï¼š<br> <img src="./partition.png" alt=""></p></li></ol><h2 id="KV-æ•°æ®åˆ†åŒº"><a href="#KV-æ•°æ®åˆ†åŒº" class="headerlink" title="KV æ•°æ®åˆ†åŒº"></a>KV æ•°æ®åˆ†åŒº</h2><ol><li><p>åˆ†åŒºå¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼š</p><ol><li>åˆ†åŒºä¸å‡åŒ€ï¼Œä¼šé€ æˆè®¿é—®å€¾æ–œçš„é—®é¢˜ï¼Œç”šè‡³å¯èƒ½é€ æˆçƒ­ç‚¹</li><li>å¯é‡‡ç”¨éšæœºåˆ†é…åˆ°æ‰€æœ‰èŠ‚ç‚¹é¿å…çƒ­ç‚¹é—®é¢˜ï¼Œä½†æ˜¯æŸ¥è¯¢ä¼šå¾ˆå›°éš¾ï¼ˆå¯èƒ½éœ€è¦å¹¶å‘è¯·æ±‚æ‰€æœ‰åˆ†åŒºï¼‰</li></ol></li><li><p>åŸºäºå…³é”®å­—åŒºé—´åˆ†åŒºï¼š</p><ol><li>æ ¸å¿ƒæ˜¯<strong>ä¸ºæ¯ä¸ªåˆ†åŒºåˆ†é…ä¸€æ®µè¿ç»­çš„å…³é”®å­—æˆ–è€…å…³é”®å­—åŒºé—´</strong>ï¼ˆä»¥æœ€å°å€¼å’Œæœ€å¤§å€¼æ¥è¡¨ç¤ºï¼‰</li><li>å…³é”®å­—åŒºé—´æ®µä¸ä¸€å®šè¦å‡åŒ€åˆ†å¸ƒ</li><li>æ”¯æŒåŒºé—´æŸ¥è¯¢æ–¹ä¾¿ï¼ˆæœ‰ä¸€å®šé¡ºåºï¼‰</li><li>å¯èƒ½ä¼šæœ‰çƒ­ç‚¹é—®é¢˜ï¼ˆæ¯”å¦‚æŒ‰ç…§æ—¶é—´æˆ³èŒƒå›´åˆ’åˆ†ï¼Œå¯èƒ½æœ€æ–°çš„æ—¥æœŸè¯»å†™å°±å¾ˆå¤šï¼‰ï¼Œå¯ä»¥è€ƒè™‘å†æ·»åŠ åˆ«çš„å­—æ®µæ¥ç»„åˆå†³å®šåˆ†åŒº</li></ol></li><li><p>åŸºäºå…³é”®å­—å“ˆå¸Œå€¼åˆ†åŒºï¼š</p><ol><li>å¥½çš„å“ˆå¸Œå‡½æ•°å¯å¤„ç†æ•°æ®å€¾æ–œï¼Œå‡åŒ€åˆ†å¸ƒ</li><li>ä¸§å¤±è‰¯å¥½çš„åŒºé—´æŸ¥è¯¢ç‰¹æ€§<br><img src="./partition-with-hash.png" alt=""></li></ol></li><li><p>è´Ÿè½½å€¾æ–œå’Œçƒ­ç‚¹ï¼š</p><ol><li>å³ä¾¿é€šè¿‡å“ˆå¸Œå€¼åˆ†åŒºçš„æ–¹æ¡ˆï¼Œä¹Ÿä¸èƒ½å®Œå…¨é¿å…çƒ­ç‚¹é—®é¢˜ã€‚æç«¯æƒ…å†µæ˜¯ï¼Œæ‰€æœ‰çš„è¯»å†™éƒ½é’ˆå¯¹åŒä¸€ä¸ªå…³é”®å­—ï¼ˆå¦‚å¾®åšå¤§ Vï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½åˆ°äº†åŒä¸€ä¸ªåˆ†åŒºã€‚</li><li>å¤§å¤šæ•°ç³»ç»Ÿæ— æ³•è‡ªåŠ¨æ¶ˆé™¤è¿™ç§é«˜åº¦å€¾æ–œçš„è´Ÿè½½ï¼Œéœ€è¦åº”ç”¨å±‚ä»‹å…¥ã€‚</li></ol></li></ol><h2 id="åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•"><a href="#åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•" class="headerlink" title="åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•"></a>åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•</h2><ol><li>äºŒçº§ç´¢å¼•çš„æŒ‘æˆ˜æ˜¯ä¸èƒ½è§„æ•´åœ°æ˜ å°„åˆ°åˆ†åŒºä¸­ã€‚</li><li><p>åŸºäºæ–‡æ¡£åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š</p><ol><li>æ¯ä¸ªåˆ†åŒºåªå…³æ³¨è‡ªå·±çš„åˆ†åŒºçš„æ–‡æ¡£ï¼Œå¹¶å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•</li><li>æŸ¥è¯¢æ—¶å»¶è¿Ÿæ”¾å¤§ä¸¥é‡ï¼Œéœ€è¦åˆ†æ•£æŸ¥è¯¢å¹¶åˆå¹¶ç»“æœï¼Œä»£ä»·è¾ƒé«˜<br><img src="./secondary-index-on-doc.png" alt=""></li></ol></li><li><p>åŸºäºè¯æ¡åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š</p><ol><li>å¯¹æ‰€æœ‰æ•°æ®æ„å»ºå…¨å±€ç´¢å¼•ï¼›å…¨å±€ç´¢å¼•å¹¶éå­˜å‚¨åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆä¼šè¿›è¡Œåˆ†åŒºï¼‰ï¼Œå¯ä»¥å’Œå…³é”®å­—é‡‡å–ä¸åŒçš„åˆ†åŒºç­–ç•¥</li><li>å¯æ”¯æŒé«˜æ•ˆåœ°åŒºé—´æŸ¥è¯¢</li><li>è¯»å–é«˜æ•ˆï¼Œä¸éœ€è¦ scatter/gather æ¨¡å¼</li><li>å†™å…¥é€Ÿåº¦æ…¢ï¼Œä¸”å¾ˆå¤æ‚ï¼Œä¼šæœ‰æ˜¾è‘—çš„å†™æ”¾å¤§é—®é¢˜</li><li>æ‰€æœ‰ç°æœ‰çš„æ•°æ®åº“éƒ½éš¾ä»¥æ”¯æŒåŒæ­¥æ›´æ–°äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥é€šå¸¸éƒ½æ˜¯å¼‚æ­¥æ›´æ–°<br><img src="./secondary-index-on-terms.png" alt=""></li></ol></li></ol><h2 id="åˆ†åŒºå†å¹³è¡¡"><a href="#åˆ†åŒºå†å¹³è¡¡" class="headerlink" title="åˆ†åŒºå†å¹³è¡¡"></a>åˆ†åŒºå†å¹³è¡¡</h2><ol><li>å³å°†æ•°æ®å’Œè¯·æ±‚ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§è¿ç§»è´Ÿè½½çš„è¿‡ç¨‹è¢«å«ä½œå†å¹³è¡¡ï¼ˆåŠ¨æ€å¹³è¡¡ï¼‰</li><li><p>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ï¼Ÿ</p><ol><li>æŸ¥è¯¢å‹åŠ›å¢åŠ ï¼Œéœ€è¦å¢åŠ  CPU å¤„ç†è´Ÿè½½</li><li>æ•°æ®è§„æ¨¡å¢åŠ </li><li>èŠ‚ç‚¹æ•…éšœ</li></ol></li><li><p>å†å¹³è¡¡éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼š</p><ol><li>å¹³è¡¡ä¹‹åï¼Œè´Ÿè½½ã€æ•°æ®å­˜å‚¨ã€è¯»å†™è¯·æ±‚ç­‰åœ¨é›†ç¾¤èŒƒå›´æ›´åŠ å‡åŒ€åˆ†å¸ƒ</li><li>å¹³è¡¡è¿‡ç¨‹ä¸èƒ½å½±å“çº¿ä¸ŠæœåŠ¡</li><li>é¿å…ä¸å¿…è¦çš„è´Ÿè½½è¿ç§»ï¼Œå°½é‡å‡å°‘ç½‘ç»œå’Œç£ç›˜ I/O å½±å“</li></ol></li></ol><h3 id="åŠ¨æ€å¹³è¡¡ç­–ç•¥"><a href="#åŠ¨æ€å¹³è¡¡ç­–ç•¥" class="headerlink" title="åŠ¨æ€å¹³è¡¡ç­–ç•¥"></a>åŠ¨æ€å¹³è¡¡ç­–ç•¥</h3><ol><li><p>ç›´æ¥å–æ¨¡æ€ä¹ˆæ ·ï¼Ÿ</p><ol><li>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æ¯”å¦‚ç”¨æˆ· ID å’Œåˆ†åŒºæ•°é‡å–æ¨¡ï¼Œå¾—åˆ°å…·ä½“è¦è®¿é—®çš„åˆ†åŒºå¯¹åº”çš„èŠ‚ç‚¹</li><li>æ‰©å±•æˆ–ç§»é™¤èŠ‚ç‚¹å›°éš¾ï¼Œæ¶‰åŠåˆ°å¤§é‡æ•°æ®çš„ç§»åŠ¨ï¼Œåº”ç”¨å±‚ä»£ç ä¹Ÿå¯èƒ½ä¼šè¢«æ³¢åŠ</li></ol></li><li><p>å›ºå®šæ•°é‡çš„åˆ†åŒºï¼š</p><ol><li>åˆå§‹æ—¶æ ¹æ®é•¿è¿œè§„åˆ’ï¼Œè®¾ç½®ä¸€ä¸ªè¿œè¶…å®é™…èŠ‚ç‚¹æ•°çš„åˆ†åŒºæ•°ï¼ˆæ¯”å¦‚ 1000ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å¤šä¸ªåˆ†åŒºã€‚<strong>æ¯ä¸ªåˆ†åŒºçš„å¤§å°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³</strong>ã€‚</li><li>æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œä»å…¶ä»–èŠ‚ç‚¹åŒ€èµ°è‹¥å¹²åˆ†åŒºï¼Œç›´åˆ°å†æ¬¡è¾¾åˆ°å…¨å±€å¹³è¡¡ï¼›åˆ é™¤èŠ‚ç‚¹ï¼Œåˆ™é‡‡å–ç›¸åçš„æªæ–½ã€‚</li><li>éœ€è¦æ”¹å˜åˆ†åŒºå’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼›ä½†æ˜¯æ€»çš„åˆ†åŒºæ•°ä¸ä¼šå˜ï¼Œå…³é”®å­—æ˜ å°„ä¹Ÿä¸ä¼šå˜ã€‚</li><li>å¯¹äºæ•°æ®è§„æ¨¡é«˜åº¦ä¸ç¡®å®šæˆ–è€…å¯å˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚</li><li>Riak, ES, Couchbase ç­‰æ”¯æŒè¿™ç§åŠ¨æ€å¹³è¡¡ç­–ç•¥ã€‚<br><img src="./rebalance.png" alt=""></li></ol></li><li><p>åŠ¨æ€åˆ†åŒº</p><ol><li>å¦‚ HBase å’Œ RethinkDBï¼Œå¯ä»¥åœ¨åˆ†åŒºæ•°æ®å¢é•¿åˆ°æŸä¸ªé˜ˆå€¼ï¼ˆHBase é»˜è®¤é˜ˆå€¼ä¸º 10GBï¼‰è‡ªåŠ¨æ‹†åˆ†æˆä¸¤ä¸ªåˆ†åŒºï¼›å¦‚æœæ•°æ®è¢«å¤§é‡åˆ é™¤ï¼Œä¸”åˆ†åŒºç¼©å°åˆ°æŸä¸ªé˜ˆå€¼ï¼Œå°†ç›¸é‚»çš„åˆ†åŒºè¿›è¡Œåˆå¹¶ã€‚<strong>ç±»ä¼¼ B æ ‘åˆ†è£‚</strong>ã€‚</li><li>åˆ†åŒºæ•°é‡è‡ªåŠ¨é€‚é…åˆ†åŒºæ€»é‡ï¼Œå°‘é‡æ•°æ®-&gt;å°‘é‡åˆ†åŒº-&gt;è¾ƒå°çš„ç³»ç»Ÿå¼€é”€ï¼›æ¯ä¸ªåˆ†åŒºæœ€å¤§å€¼å¯è¢«é™åˆ¶ã€‚<strong>åˆ†åŒºæ€»æ•°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³</strong>ã€‚</li><li>é¢„åˆ†è£‚å¯é¿å…åˆæœŸå…ˆéªŒæ¡ä»¶ä¸è¶³ï¼Œæ— æ³•ç¡®å®šè¾ƒé€‚åˆçš„è¾¹ç•Œï¼Œå¯¼è‡´å†™å…¥éƒ½é›†ä¸­åœ¨å•ä¸ªèŠ‚ç‚¹å¤„ç†çš„é—®é¢˜ã€‚HBase å’Œ MongoDB éƒ½æ”¯æŒé…ç½®åˆå§‹åˆ†åŒºã€‚</li><li>é€‚åˆå…³é”®å­—åŒºé—´åˆ†åŒºå’Œå“ˆå¸Œåˆ†åŒºç­–ç•¥ã€‚</li></ol></li><li><p>æŒ‰èŠ‚ç‚¹æ¯”ä¾‹åˆ†åŒºï¼šCassandra å’Œ Ketama é‡‡ç”¨äº†å°†åˆ†åŒºæ•°å’Œé›†ç¾¤èŠ‚ç‚¹æ•°æˆæ­£æ¯”å…³ç³»çš„æ–¹å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºæ•°å›ºå®šï¼š</p><ol><li>èŠ‚ç‚¹æ•°ä¸å˜æ—¶ï¼Œåˆ†åŒºå¤§å°å’Œæ•°æ®é›†æ€»é‡æˆæ­£æ¯”</li><li>èŠ‚ç‚¹æ•°å¢åŠ æ—¶ï¼Œåˆ†åŒºåˆ™ä¼šå˜å°</li><li>åˆ†åŒºå¤§å°ä¿æŒç¨³å®šï¼Œå¯æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹æ‰¿è½½æ›´å¤šçš„æ•°æ®</li></ol></li></ol><h2 id="è¯·æ±‚è·¯ç”±"><a href="#è¯·æ±‚è·¯ç”±" class="headerlink" title="è¯·æ±‚è·¯ç”±"></a>è¯·æ±‚è·¯ç”±</h2><ol><li><p>å…¸å‹çš„æœåŠ¡å‘ç°é—®é¢˜ï¼Œå¤„ç†ç­–ç•¥å¦‚ä¸‹ï¼š</p><ol><li><strong>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ„ŸçŸ¥åˆ†åŒºæƒ…å†µ</strong>ï¼šå…è®¸å®¢æˆ·ç«¯è¿æ¥ä»»æ„èŠ‚ç‚¹ã€‚å¦‚æœæŸä¸ªèŠ‚ç‚¹æ°å¥½æ‹¥æœ‰è¯·æ±‚çš„åˆ†åŒºï¼Œåˆ™ç›´æ¥å¤„ç†ï¼›å¦åˆ™å°†è¯·æ±‚è½¬å‘ç»™åˆ«çš„èŠ‚ç‚¹ï¼Œç­‰å¾…ç­”å¤ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li><strong>è·¯ç”±å±‚æ„ŸçŸ¥åˆ†åŒºæƒ…å†µ</strong>ï¼šæ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚å‘é€è‡³ä¸€ä¸ªè·¯ç”±ä»£ç†å±‚ï¼Œç”±å®ƒæ¥åšè½¬å‘ã€‚</li><li><strong>å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ†åŒºå’ŒèŠ‚ç‚¹åˆ†é…å…³ç³»</strong>ï¼šå®¢æˆ·ç«¯å¯å†³å®šè¿æ¥åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œæ— éœ€ä¸­ä»‹ã€‚<br><img src="./route-policies.png" alt=""></li></ol></li><li><p>å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨äº†ç‹¬ç«‹çš„åè°ƒæœåŠ¡ï¼ˆå¦‚ ZooKeeperï¼‰è·Ÿè¸ªé›†ç¾¤ä¸­çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ HBaseï¼ŒKafka ç­‰ã€‚<br><img src="./zookeeper-save-meta.png" alt="">  </p></li><li><p>å¦å¤–ä¸€ç§æ€è·¯æ˜¯èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ gossip åè®®åŒæ­¥é›†ç¾¤çŠ¶æ€å˜åŒ–ï¼Œæ­¤æ—¶è¯·æ±‚å¯å‘åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹è´Ÿè´£å¤„ç†æˆ–è½¬å‘ã€‚æœ€å¤§çš„å¥½å¤„æ˜¯ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä½†æ˜¯èŠ‚ç‚¹å¤æ‚æ€§ä¹Ÿå¢åŠ äº†ã€‚å…¸å‹çš„ä»£è¡¨æ˜¯ Cassandra å’Œ Riakï¼Œå½“ç„¶è¿˜æœ‰ Redis Clusterã€‚</p></li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ†</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ç³»ç»ŸåŸºç¡€å­¦ä¹ åï¼Œå°±å¼€å§‹è¿›å…¥åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿçš„ä¸–ç•Œäº†ã€‚å‰é¢å­¦ä¹ çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„æƒ…å†µï¼›ç„¶è€Œï¼Œåœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„&lt;strong&gt;æ‰©å±•æ€§&lt;/strong&gt;ã€&lt;strong&gt;å®¹é”™æ€§&lt;/strong&gt;ä»¥åŠ&lt;strong&gt;å»¶è¿Ÿæ€§&lt;/strong&gt;ç­‰ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é€šå¸¸ä¼šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚åº¦è‡ªç„¶ä¹Ÿä¸Šæ¥äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä¸»è¦å­¦ä¹ æ•°æ®ç³»ç»Ÿçš„å¤åˆ¶ã€åˆ†åŒºã€äº‹åŠ¡ã€ä¸€è‡´æ€§å…±è¯†ç®—æ³•ã€ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„ä¸€äº›æŒ‘æˆ˜ç­‰ï¼Œè¿™äº›çŸ¥è¯†éƒ½æ¯”è¾ƒç¡¬æ ¸ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚æ‰€ä»¥ï¼Œã€Œä¸Šè½¦ï¼Œèµ°å§~ã€&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡ç¬”è®°é‡ç‚¹æ˜¯å…³äºæ•°æ®ç³»ç»Ÿçš„å¤åˆ¶å’Œåˆ†åŒºï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§„çš„ä¸»ä»å¤åˆ¶åŸç†ã€å¤šä¸»å¤åˆ¶çš„åº”ç”¨åœºæ™¯ï¼Œå¦å¤–è¿˜ä»‹ç»äº†æ— ä¸»å¤åˆ¶çš„ç³»ç»Ÿï¼ˆå¦‚äºšé©¬é€Š Dynamo ç³»ç»Ÿï¼‰ã€‚æœ€åå°±æ˜¯å…³äºæ•°æ®åˆ†åŒºçš„ä»‹ç»ï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§çš„åˆ†åŒºç­–ç•¥ï¼ŒåŠ¨æ€å¹³è¡¡ç­–ç•¥ç­‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="åˆ†å¸ƒå¼æ•°æ®åº“" scheme="http://ifaceless.space/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="æ•°æ®å¤åˆ¶" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/"/>
    
      <category term="æ•°æ®åˆ†åŒº" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®ç³»ç»ŸåŸºç¡€</title>
    <link href="http://ifaceless.space/2019/08/14/ddia-data-sys-basics/"/>
    <id>http://ifaceless.space/2019/08/14/ddia-data-sys-basics/</id>
    <published>2019-08-14T14:12:51.000Z</published>
    <updated>2019-11-24T09:45:59.880Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDesign Data-Intensive Applicationsï¼‰æ˜¯ä¸€æœ¬éå¸¸æœ‰è¯šæ„ã€éå¸¸ä¼˜ç§€çš„è®²è§£é’ˆå¯¹æ•°æ®å¯†é›†åœºæ™¯ä¸‹ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„ç›®æ ‡ã€åŸåˆ™å’ŒæŠ€æœ¯é€‰å‹ç­‰çŸ¥è¯†ã€‚ä½œè€…ç»“åˆç†è®ºä¸å®è·µï¼Œä¸ºæˆ‘ä»¬å±•ç°äº†ä¸€äº›æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ï¼›åŒæ—¶è¿˜ä»‹ç»äº†ä¸€äº›å…³é”®æŠ€æœ¯ï¼ˆå¦‚å­˜å‚¨å¼•æ“ã€åºåˆ—åŒ–åè®®ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰ç­‰çš„å®ç°åŸç†ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿ<strong>çŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶</strong>ã€‚</p><a id="more"></a><p>å¥½ä¹¦è‡ªç„¶è¦ç²¾è¯»ç»†å“ï¼Œå†™ç‚¹è¯»ä¹¦ç¬”è®°æ‰èƒ½æŠŠæ¡è‡ªå·±çš„å­¦ä¹ è¿›åº¦å’Œç†è§£ç¨‹åº¦ã€‚æ€»çš„æ¥è¯´ï¼Œç¬”è®°å½¢å¼å°†ä»¥å›¾æ–‡ä¸ºä¸»ï¼Œæ€ç»´å¯¼å›¾ä¸ºè¾…çš„æ–¹å¼æ¥å‘ˆç°ã€‚<strong>ç”±äºè¯¥ä¹¦çš„å°é¢æ˜¯ä¸€å¤´é‡çŒªğŸ—ï¼Œæ•…å°†æœ¬ç³»åˆ—è¯»ä¹¦ç¬”è®°å‘½åä¸ºã€Šé‡çŒªä¹¦è¯»ä¹¦ç¬”è®°ã€‹</strong>ã€‚<br>ä¹¦ä¸­ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†å±•å¼€ï¼š</p><ul><li>è®¨è®ºæœ‰å…³å¢å¼ºæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿæ‰€éœ€è¦çš„è‹¥å¹²åŸºæœ¬åŸåˆ™ã€‚</li><li>ä»å•æœºæ•°æ®å­˜å‚¨ä¸“äº«è·¨æœºå™¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚</li><li>ä¸»è¦é’ˆå¯¹æ´¾ç”Ÿæ•°æ®çš„ç³»ç»Ÿè®¾è®¡ï¼Œå¹¶è®¨è®ºæ‰¹å¤„ç†å’Œæµå¼å¤„ç†ã€‚</li></ul><p>é‡çŒªä¹¦å­¦ä¹ å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹æ·±å…¥å­¦ä¹ è·¯çº¿ï¼š</p><ul><li>å…³ç³»å‹æ•°æ®åº“ï¼š<ul><li>MySQL </li><li>å­˜å‚¨å¼•æ“ï¼ˆInnoDB &amp; MyISAMï¼‰</li></ul></li><li>åˆ†å¸ƒå¼æ•°æ®åº“ï¼š<ul><li>ä¸€è‡´æ€§åè®®ï¼ˆPaxos, Raft, Zookeeperï¼‰</li><li>æ•°æ®åº“ï¼ˆTiDB ï¼‰</li><li>å­˜å‚¨å¼•æ“ï¼ˆTiKV &amp; RocksDB &amp; LevelDBï¼‰</li></ul></li><li>éå…³ç³»æ•°æ®åº“æˆ–ç¼“å­˜ç³»ç»Ÿï¼š<ul><li>Redisï¼ˆè®¾è®¡æ€æƒ³ã€æ•°æ®ç»“æ„ã€é›†ç¾¤ç®¡ç†ï¼‰</li><li>HBaseï¼ˆè®¾è®¡æ€æƒ³ã€ä½¿ç”¨æ–¹å¼å’Œåœºæ™¯ã€å­˜å‚¨ç®¡ç†ï¼‰</li></ul></li><li>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼š<ul><li>åº”ç”¨å±‚æ¡†æ¶ï¼ˆCeleryï¼‰</li><li>AMQP åè®®å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRabbitMQï¼‰</li><li>ç®€æ˜“çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆBeanstalkï¼‰</li><li>é«˜ååé‡çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRocksDBã€Kafkaï¼‰</li></ul></li><li>æœç´¢å¼•æ“ï¼šElasticSearch</li></ul><h1 id="å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ"><a href="#å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ" class="headerlink" title="å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ"></a>å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ</h1><ol><li><strong>æ•°æ®å¯†é›†å‹ï¼ˆData-Intensiveï¼‰</strong>æ˜¯æŒ‡å¯¹äºä¸€ä¸ªåº”ç”¨ç³»ç»Ÿè€Œè¨€ï¼Œã€Œæ•°æ®ã€æ˜¯å…¶æˆè´¥çš„å†³å®šæ€§å› ç´ ï¼ŒåŒ…æ‹¬<strong>æ•°æ®çš„è§„æ¨¡ã€æ•°æ®çš„å¤æ‚åº¦æˆ–æ•°æ®äº§ç”Ÿå’Œå˜åŒ–çš„é€Ÿç‡ç­‰</strong>ã€‚</li><li><strong>è®¡ç®—å¯†é›†å‹ï¼ˆCompute-Intensiveï¼‰</strong>ï¼Œä»¥è®¡ç®—ä¸ºä¸»çš„ç³»ç»Ÿï¼ŒCPU ä¸»é¢‘é€šå¸¸æ˜¯å®ƒçš„åˆ¶çº¦ç“¶é¢ˆ</li><li><strong>æ•°æ®ç³»ç»Ÿ</strong>ï¼š<ol><li>é€šå¸¸æ¥è¯´ï¼Œæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—è¢«è®¤ä¸ºæ˜¯ä¸åŒç±»å‹çš„ç³»ç»Ÿï¼Œæœ‰ä¸åŒçš„æ€§èƒ½å’Œè®¾è®¡å®ç°ï¼›</li><li>ä½†è¿‘å¹´æ¥ï¼ŒæŠ€æœ¯çš„å‘å±•å¯¼è‡´å®ƒä»¬ä¹‹é—´çš„ç•Œé™é€æ¸æ¨¡ç³Šã€‚æ¯”å¦‚ Redis æ—¢å¯ä»¥å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼›Kafka å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿå…·å¤‡æŒä¹…åŒ–çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œç»Ÿä¸€ç§°ä¸ºã€Œæ•°æ®ç³»ç»Ÿï¼ˆdata systemï¼‰ã€ï¼›</li><li>åº”ç”¨ç³»ç»Ÿçš„éœ€æ±‚æ›´åŠ å¹¿æ³›ï¼Œå•ä¸€ç»„ä»¶æ— æ³•æ»¡è¶³æ‰€æœ‰çš„æ•°æ®å¤„ç†å’Œå­˜å‚¨éœ€æ±‚ï¼›é€šå¸¸éœ€è¦ç»„åˆå¤šä¸ªç»„ä»¶ï¼Œå¹¶é€šè¿‡åº”ç”¨å±‚ä»£ç é©±åŠ¨å®ç°è¡”æ¥ã€‚</li></ol></li></ol><h2 id="å¯é æ€§ï¼ˆReliabilityï¼‰"><a href="#å¯é æ€§ï¼ˆReliabilityï¼‰" class="headerlink" title="å¯é æ€§ï¼ˆReliabilityï¼‰"></a>å¯é æ€§ï¼ˆReliabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>å½“æ„å¤–æƒ…å†µï¼ˆåŒ…æ‹¬ç¡¬ä»¶ã€è½¯ä»¶æ•…éšœä»¥åŠäººä¸ºå¤±è¯¯ï¼‰å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿåº”è¯¥å¯ä»¥ç»§ç»­æ­£å¸¸å·¥ä½œã€‚è™½ç„¶æ€§èƒ½ä¼šæœ‰æ‰€é™ä½ï¼Œä½†ä¼šç¡®ä¿åŠŸèƒ½æ­£ç¡®ã€‚</strong></li><li>å¯èƒ½å‡ºé”™çš„äº‹ç§°ä¸º<strong>é”™è¯¯ï¼ˆfaultsï¼‰æˆ–æ•…éšœ</strong>ï¼Œç³»ç»Ÿå¯åº”å¯¹é”™è¯¯ï¼Œåˆ™ç§°ä¸º<strong>å®¹é”™ï¼ˆfault-tolerantï¼‰</strong>æˆ–è€…**å¼¹æ€§ï¼ˆresilientï¼‰ã€‚</li><li><strong>å¤±æ•ˆï¼ˆfailureï¼‰</strong>æ¯” fault ä¸¥é‡ï¼Œæ„å‘³ç€æ•´ä¸ªç³»ç»Ÿæ— æ³•å¯¹å¤–æä¾›ç”¨æˆ·æ‰€éœ€æœåŠ¡ã€‚</li><li>ç¡¬ä»¶æ•…éšœé—®é¢˜å¯ä»¥é€šè¿‡å¢åŠ å†—ä½™çš„æ–¹å¼æ¥æœ‰æ•ˆè§£å†³ï¼Œä½†ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œè½¯ä»¶å®¹é”™çš„æ–¹å¼ä¹Ÿå¯ä»¥ç”¨æ¥å®¹å¿å¤šæœºå¤±æ•ˆçš„æ‰‹æ®µï¼Œä½œä¸ºç¡¬ä»¶å®¹é”™çš„è¡¥å……ã€‚</li><li>è½¯ä»¶æ•…éšœé—®é¢˜é€šå¸¸éš¾ä»¥é¢„æ–™ï¼Œä¸”ä¸€æ—¦å‘ç”Ÿäº§ç”Ÿçš„å½±å“ä¼šéå¸¸å¹¿æ³›ï¼Œæ¨ªè·¨æ•´ä¸ªç³»ç»Ÿéƒ½å¯èƒ½ã€‚å¹¶æ— å¿«é€Ÿè§£å†³ä¹‹æ³•ã€‚åœ¨ä½¿ç”¨ä¹‹å¤„ï¼Œéœ€è¦è€ƒè™‘å¥½å¾ˆå¤šç»†èŠ‚ï¼Œæ¢³ç†ä¾èµ–å‡è®¾å’Œç³»ç»Ÿé—´çš„äº¤äº’ã€‚å¦å¤–ï¼Œè¿›è¡Œå…¨é¢æµ‹è¯•ï¼Œåšå¥½è¿›ç¨‹éš”ç¦»ï¼Œå…è®¸å´©æºƒåè‡ªåŠ¨é‡å¯ã€‚</li><li>ä¿è¯ç³»ç»Ÿå¯é æ€§ï¼Œå‡å°‘äººä¸ºå¤±è¯¯ï¼š<ol><li>ä»¥æœ€å°å‡ºé”™çš„æ–¹å¼è®¾è®¡ç³»ç»Ÿ</li><li>æƒ³åŠæ³•åˆ†ç¦»æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€å®¹æ˜“å‘ç”Ÿæ•…éšœçš„æ¥å£</li><li>å……åˆ†åœ°æµ‹è¯•</li><li>å½“å‘ç”Ÿäººä¸ºå¤±è¯¯æ—¶ï¼Œæä¾›å¿«é€Ÿæ¢å¤æœºåˆ¶ï¼Œå‡å°‘æ•…éšœå½±å“</li><li>æä¾›è¯¦ç»†æ¸…æ™°çš„å­ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ€§èƒ½æŒ‡æ ‡å’Œé”™è¯¯ç‡</li><li>æ¨è¡Œç®¡ç†æµç¨‹å¹¶åŠ ä»¥åŸ¹è®­</li></ol></li></ol><h2 id="å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰"><a href="#å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰" class="headerlink" title="å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰"></a>å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>éšç€è§„æ¨¡å¢é•¿ï¼ˆåŒ…æ‹¬æ•°æ®é‡ã€æµé‡æˆ–è€…å¤æ‚åº¦ï¼‰ï¼Œç³»ç»Ÿåº”ç”¨èƒ½ä»¥åˆç†çš„æ–¹å¼åŒ¹é…è¿™ç§å¢é•¿ã€‚</strong></li><li>ç”¨æ¥æè¿°ç³»ç»Ÿåº”å¯¹è´Ÿè½½å¢åŠ èƒ½åŠ›çš„æœ¯è¯­ã€‚</li><li><strong>æè¿°è´Ÿè½½</strong>ï¼šéœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯è´Ÿè½½å‚æ•°ã€‚å‚æ•°çš„æœ€ä½³é€‰æ‹©å–å†³äºç³»ç»Ÿçš„ä½“ç³»ç»“æ„ï¼Œå¯èƒ½æ˜¯ Web æœåŠ¡çš„æ¯ç§’è¯·æ±‚é‡ï¼Œæ•°æ®åº“å†™å…¥æ¯”ä¾‹ï¼ŒèŠå¤©å®¤æ´»åŠ¨äººæ•°ï¼Œç¼“å­˜å‘½ä¸­ç‡ï¼Œç”¨æˆ·å…³æ³¨è€…åˆ†å¸ƒæƒ…å†µç­‰ã€‚</li><li><strong>æè¿°æ€§èƒ½</strong>ï¼š<ol><li>æ‰¹å¤„ç†ç³»ç»Ÿå…³æ³¨çš„æ˜¯ååé‡ï¼ˆthroughoutï¼‰</li><li>Web æœåŠ¡å™¨æ›´å…³æ³¨è¯·æ±‚å“åº”æ—¶é—´ï¼Œæ›´ç»å¸¸å…³æ³¨çš„æ˜¯å¹³å‡å“åº”æ—¶é—´</li><li>ä¸­ä½æ•°å“åº”æ—¶é—´é€šå¸¸ä¹Ÿå« p50</li><li>å¸¸è§çš„è¿˜ä¼šå…³æ³¨ p95, p99, p999 å€¼</li><li>æœåŠ¡è´¨é‡ç›®æ ‡ Service Level Objectives, SLO</li><li>æœåŠ¡è´¨é‡åè®® Service Level Agreements, SLA</li></ol></li></ol><h2 id="å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰"><a href="#å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰" class="headerlink" title="å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰"></a>å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ–°çš„äººå‘˜å‚ä¸åˆ°ç³»ç»Ÿçš„å¼€å‘å’Œè¿ç»´ï¼Œä»¥ç»´æŠ¤ç°æœ‰åŠŸèƒ½æˆ–é€‚é…æ–°åœºæ™¯ï¼Œç³»ç»Ÿéƒ½åº”è¯¥é«˜æ•ˆè¿è½¬ã€‚</strong></li><li>è°éƒ½ä¸æƒ…æ„¿ç»´æŠ¤é—ç•™ç³»ç»Ÿï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå¯èƒ½è¦ä¿®å¤åˆ«äººåŸ‹ä¸‹çš„å‘ï¼Œåšä¸å–œæ¬¢çš„äº‹æƒ…ã€‚æ‰€ä»¥åœ¨åšç³»ç»Ÿè®¾è®¡ä¹‹åˆï¼Œå°±åº”è¯¥å…³æ³¨ç³»ç»Ÿè®¾è®¡çš„ä¸‰å¤§åŸåˆ™ï¼Œå°½å¯èƒ½å‡å°‘ç»´æŠ¤æœŸçš„éº»çƒ¦ï¼š<ol><li>å¯è¿ç»´æ€§ï¼šè¿ç»´æ›´è½»æ¾</li><li>ç®€å•æ€§ï¼šç®€åŒ–ç³»ç»Ÿå¤æ‚åº¦ï¼Œä½†å¹¶éå‡å°‘äº§å“åŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡è¾ƒå¥½çš„æŠ½è±¡æ¥è®©ç³»ç»Ÿå˜å¾—æ›´æ¸…æ™°å’Œæ˜“äºç†è§£</li><li>å¯æ¼”åŒ–æ€§ï¼šæ˜“äºæ”¹å˜</li></ol></li></ol><h1 id="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€"><a href="#æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€" class="headerlink" title="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€"></a>æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€</h1><ol><li>å¤æ‚çš„åº”ç”¨ç¨‹åºä¼šæœ‰å¾ˆå¤šå±‚ï¼Œä½†æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ¯å±‚éƒ½é€šè¿‡æä¾›ä¸€ä¸ªç®€æ´çš„æ•°æ®æ¨¡å‹æ¥éšè—ä¸‹å±‚çš„å¤æ‚æ€§</li></ol><h2 id="å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“"><a href="#å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“" class="headerlink" title="å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“"></a>å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“</h2><ol><li><p>NoSQL æ•°æ®åº“å‡ å¤§é©±åŠ¨å› ç´ ï¼š</p><ol><li>æ¯”å…³ç³»æ•°æ®åº“æ‰©å±•æ€§å¥½ï¼Œæ”¯æŒè¶…å¤§æ•°æ®é›†æˆ–è¶…é«˜å†™å…¥ååé‡</li><li>å¼€æºå…è´¹å±…å¤š</li><li>å…³ç³»æ¨¡å‹ä¸èƒ½å¾ˆå¥½æ”¯æŒæŸäº›ç‰¹å®šæŸ¥è¯¢</li></ol></li><li><p>ä»»ä½•å¯¹äººç±»æœ‰æ„ä¹‰çš„ä¸œè¥¿éƒ½å¯èƒ½åœ¨å°†æ¥æŸä¸ªæ—¶åˆ»å‘ç”Ÿæ”¹å˜ã€‚æ‰€ä»¥åœ¨æ•°æ®åº“ä¸­æˆ‘ä»¬ä½¿ç”¨å…³è”çš„ ID ä½œä¸ºæ ‡å¿—çš„å¥½å¤„å°±æ˜¯å®ƒæ²¡æœ‰ç›´æ¥æ„ä¹‰ï¼Œæ°¸è¿œä¸éœ€è¦ç›´æ¥æ”¹å˜</p></li><li><p>å±‚æ¬¡æ¨¡å‹ï¼š</p><ol><li>ä»£è¡¨æ˜¯ IBM çš„ Information Mangagement System, IMS</li><li>ç±»ä¼¼ JSON ç»“æ„ï¼Œèƒ½å¤Ÿå¾ˆå¥½è¡¨ç¤ºä¸€å¯¹å¤šå…³ç³»ï¼›å¤šå¯¹å¤šå…³ç³»å¾ˆéš¾è¡¨ç¤º</li></ol></li><li><p>ç½‘ç»œæ¨¡å‹ï¼š</p><ol><li>å±‚æ¬¡æ¨¡å‹çš„æ¨å¹¿ï¼Œæ”¯æŒå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„å…³ç³»</li><li>æŸ¥è¯¢å›°éš¾ã€æ›´æ–°å¤æ‚ä¸”ä¸å¤Ÿçµæ´»</li><li>å¯¹åº”ç”¨ç¨‹åºçš„æ•°æ®æ¨¡å‹è¿›è¡Œæ›´æ”¹æ˜¯éå¸¸å›°éš¾çš„äº‹æƒ…</li><li>åº”ç”¨éœ€è¦å…³å¿ƒå¤æ‚çš„è®¿é—®è·¯å¾„</li></ol></li><li><p>å…³ç³»æ¨¡å‹ï¼š</p><ol><li>å®šä¹‰äº†æ‰€æœ‰æ•°æ®çš„æ ¼å¼ï¼šå…³ç³»ï¼ˆè¡¨ï¼‰åªæ˜¯å…ƒç»„ï¼ˆè¡Œï¼‰çš„é›†åˆ</li><li>æŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨å†³å®šæŸ¥è¯¢é¡ºåºæ‰§è¡Œï¼›ä½¿ç”¨ä½•ç§ç´¢å¼•ã€‚ç›¸å½“äºè‡ªåŠ¨ç»´æŠ¤ã€Œè®¿é—®è·¯å¾„ã€</li><li>åº”ç”¨æ·»åŠ æ–°åŠŸèƒ½å˜å¾—å®¹æ˜“</li></ol></li><li><p>å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“ï¼š</p><ol><li>è¡¨ç¤ºå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šéƒ½ä½¿ç”¨äº†æ ‡è¯†ç¬¦</li><li>å‰è€…å«ä½œå¤–é”®ï¼ˆæˆ–è€…å¯ä»¥åœ¨åº”ç”¨ä¸­å…³è”ï¼‰ï¼›åè€…å«ä½œæ–‡æ¡£å¼•ç”¨</li></ol></li><li><p>è¯»æ—¶æ¨¡å¼ï¼šæ–‡æ¡£æ•°æ®åº“ä¸­ï¼Œæ•°æ®ç»“æ„æ˜¯éšå¼çš„ï¼Œåªæœ‰åœ¨è¯»å–æ—¶æ‰è§£é‡Š</p></li><li>å†™æ—¶æ¨¡å¼ï¼šå…³ç³»æ•°æ®åº“ä¸­ï¼Œæ¨¡å¼æ˜¯æ˜¾å¼çš„ï¼Œæ•°æ®åº“ä¿è¯å†™å…¥æ—¶éµå¾ªæ¨¡å¼</li><li>èåˆå…³ç³»æ¨¡å‹å’Œæ–‡æ¡£æ¨¡å‹æ˜¯æœªæ¥å‘å±•çš„ä¸€ä¸ªè¾ƒå¥½çš„é€”å¾„</li></ol><h2 id="æŸ¥è¯¢è¯­è¨€"><a href="#æŸ¥è¯¢è¯­è¨€" class="headerlink" title="æŸ¥è¯¢è¯­è¨€"></a>æŸ¥è¯¢è¯­è¨€</h2><ol><li><p>SQLï¼š</p><ol><li>å£°æ˜å¼</li><li>ç®€æ´ã€æ˜“ä½¿ç”¨</li><li>å¾ˆå¤šé™åˆ¶çš„äº‹å®ï¼Œä¹Ÿæˆä¸ºæ•°æ®åº“è‡ªåŠ¨ä¼˜åŒ–æä¾›äº†ç©ºé—´</li><li>åº•å±‚æ˜“äºä½¿ç”¨å¹¶å‘æŸ¥è¯¢</li></ol></li><li><p>IMS/CODASYLï¼ˆå±‚æ¬¡æ¨¡å‹ã€ç½‘ç»œæ¨¡å‹ï¼‰ï¼š</p><ol><li>å‘½ä»¤å¼</li></ol></li><li><p>MapReduceï¼š</p><ol><li>ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¸å¤šæœºå™¨ä¸Šæ‰¹é‡å¤„ç†æµ·é‡æ•°æ®</li><li>æ—¢éå£°æ˜å¼ï¼Œä¹Ÿéå®Œå…¨å‘½ä»¤å¼ï¼›ä»‹äºäºŒè€…ä¹‹é—´</li><li>åº•å±‚ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¡ç®—é›†ç¾¤ä¸Šåˆ†å¸ƒæ‰§è¡Œï¼›å¯æ‰§è¡Œçš„æ“ä½œé™å®šä¸ºçº¯å‡½æ•°</li></ol></li></ol><h2 id="å›¾æ•°æ®åº“æ¨¡å‹"><a href="#å›¾æ•°æ®åº“æ¨¡å‹" class="headerlink" title="å›¾æ•°æ®åº“æ¨¡å‹"></a>å›¾æ•°æ®åº“æ¨¡å‹</h2><ol><li>å…³ç³»æ•°æ®åº“é€‚åˆå¤„ç†ç®€å•çš„å¤šå¯¹å¤šæ¨¡å‹ï¼›ä½†éšç€æ•°æ®ä¹‹é—´çš„å…³è”è¶Šæ¥è¶Šå¤æ‚ï¼Œè½¬æ¢ä¸ºå›¾æ¨¡å‹ä¼šæ›´åŠ è‡ªç„¶</li><li>é¡¶ç‚¹å’Œè¾¹ç»„æˆ</li><li>å»ºæ¨¡ç¤ºä¾‹ï¼š<ol><li>äººé™…å…³ç³»</li><li>Web ç½‘é¡µ</li><li>å…¬è·¯æˆ–è€…é“è·¯ç½‘</li></ol></li><li>æ›´å¼ºå¤§ç”¨å¤„ï¼šæä¾›äº†å•ä¸ªæ•°æ®å­˜å‚¨åŒºä¿å­˜å®Œå…¨ä¸åŒç±»å‹å¯¹è±¡çš„ä¸€è‡´æ€§æ–¹å¼</li></ol><h3 id="å±æ€§å›¾æ¨¡å‹ï¼ˆProperty-Graphï¼‰"><a href="#å±æ€§å›¾æ¨¡å‹ï¼ˆProperty-Graphï¼‰" class="headerlink" title="å±æ€§å›¾æ¨¡å‹ï¼ˆProperty Graphï¼‰"></a>å±æ€§å›¾æ¨¡å‹ï¼ˆProperty Graphï¼‰</h3><ol><li>ä»£è¡¨ï¼šNeo4j, Titan, InfiniteGraph</li><li><p>é¡¶ç‚¹ï¼ˆverticeï¼‰ï¼š</p><ol><li>å”¯ä¸€æ ‡å¿—</li><li>å‡ºè¾¹é›†åˆ</li><li>å…¥è¾¹é›†åˆ</li><li>å±æ€§é›†åˆ</li></ol></li><li><p>è¾¹ï¼ˆedgeï¼‰ï¼š</p><ol><li>å”¯ä¸€æ ‡å¿—</li><li>è¾¹å¼€å§‹é¡¶ç‚¹</li><li>è¾¹ç»“æŸçš„é¡¶ç‚¹</li><li>æ ‡ç­¾</li><li>å±æ€§é›†åˆ</li></ol></li></ol><h3 id="ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰"><a href="#ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰" class="headerlink" title="ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰"></a>ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰</h3><ol><li>ä»£è¡¨ï¼šDatomic, AllegroGraph</li><li>å‡ ä¹ç­‰åŒäºå±æ€§å›¾æ¨¡å‹ï¼Œå¯èƒ½ä½œä¸ºæ„å»ºåº”ç”¨ç¨‹åºçš„è¡¥å……</li><li>å½¢å¼ï¼š(ä¸»ä½“ï¼Œè°“è¯­ï¼Œå®¢ä½“)</li><li>ä¸»ä½“ç›¸å½“äºå›¾ä¸­çš„é¡¶ç‚¹ï¼Œå®¢ä½“åˆ™æ˜¯ä»¥ä¸‹ä¸¤ç§ä¹‹ä¸€ï¼š<ol><li>åŸå§‹æ•°æ®ç±»å‹ä¸­çš„å€¼ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰ï¼Œå¦‚ <code>(lucy, age, 40)</code></li><li>å›¾çš„å¦å¤–ä¸€ä¸ªé¡¶ç‚¹ï¼Œå¦‚ <code>(lucy, mariedTo, alain)</code></li></ol></li></ol><h3 id="æŸ¥è¯¢è¯­è¨€-1"><a href="#æŸ¥è¯¢è¯­è¨€-1" class="headerlink" title="æŸ¥è¯¢è¯­è¨€"></a>æŸ¥è¯¢è¯­è¨€</h3><ol><li>Cypherï¼Œæœ€æ—©ç”¨äº Neo4jã€‚å£°æ˜å¼æŸ¥è¯¢è¯­è¨€</li><li>SQL:1999 æ ‡å‡†åï¼Œå¯ä»¥ä½¿ç”¨é€’å½’å…¬ç”¨è¡¨è¾¾å¼ï¼ˆWITH RECURSIVEï¼‰æ¥è¡¨ç¤ºå¯å˜çš„éå†è·¯å¾„æŸ¥è¯¢</li><li>SPARQLï¼šé‡‡ç”¨ RDF æ•°æ®æ¨¡å‹çš„ä¸‰å…ƒå­˜å‚¨æŸ¥è¯¢è¯­è¨€</li><li>Datalogï¼šæ•°æ®æ¨¡å‹é‡‡ç”¨ã€Œè°“è¯­ï¼ˆä¸»ä½“ï¼Œå®¢ä½“ï¼‰ã€æ¨¡å¼ï¼›è§„åˆ™å¯ä»¥åœ¨ä¸åŒçš„æŸ¥è¯¢ä¸­ç»„åˆå’Œå¤ç”¨ï¼›å¯¹äºç®€å•æŸ¥è¯¢è™½ç„¶ç¹çï¼Œä½†é’ˆå¯¹å¤æ‚æ•°æ®ï¼Œåˆ™æ›´åŠ çµæ´»</li></ol><h1 id="æ•°æ®å­˜å‚¨å’Œæ£€ç´¢"><a href="#æ•°æ®å­˜å‚¨å’Œæ£€ç´¢" class="headerlink" title="æ•°æ®å­˜å‚¨å’Œæ£€ç´¢"></a>æ•°æ®å­˜å‚¨å’Œæ£€ç´¢</h1><h2 id="æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„"><a href="#æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„"></a>æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„</h2><ol><li>ç´¢å¼•å¯ä»¥å¸®åŠ©é«˜æ•ˆåœ°æŸ¥è¯¢æ•°æ®åº“ä¸­ç‰¹å®šçš„é”®ï¼›æ˜¯åŸºäºåŸå§‹æ•°æ®æ´¾ç”Ÿè€Œæ¥çš„é¢å¤–æ•°æ®ç»“æ„</li><li>ä»»ä½•ç±»å‹çš„ç´¢å¼•é€šå¸¸éƒ½ä¼šé™ä½å†™çš„é€Ÿåº¦</li></ol><h3 id="å“ˆå¸Œç´¢å¼•"><a href="#å“ˆå¸Œç´¢å¼•" class="headerlink" title="å“ˆå¸Œç´¢å¼•"></a>å“ˆå¸Œç´¢å¼•</h3><ol><li>ä»¥ Bitcast ä¸ºä»£è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œé‡‡ç”¨äº†å“ˆå¸Œç´¢å¼•</li><li>é€‚åˆæ¯ä¸ªé”®çš„å€¼æ›´æ–°é¢‘ç¹çš„åœºæ™¯</li><li>å“ˆå¸Œç´¢å¼•çš„ç‰¹ç‚¹ï¼š<ol><li>å“ˆå¸Œè¡¨å¿…é¡»å…¨éƒ¨å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œé”®å€¼æŒ‡å‘çš„æ˜¯æ–‡ä»¶æ®µä¸­çš„åç§»ï¼Œç”¨äºæŸ¥æ‰¾å…·ä½“çš„æ•°æ®</li><li>å¯é‡‡ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œå†é…åˆåå°åˆå¹¶ã€å‹ç¼©ç­‰æ‰‹æ®µæ¥é¿å…ç£ç›˜å†™å…¥è€—å°½çš„é—®é¢˜ï¼Œå‡å°‘ç£ç›˜ç¢ç‰‡</li><li>æ–°çš„æ•°æ®é‡‡ç”¨è¿½åŠ è€ŒéåŸåœ°ä¿®æ”¹çš„ç­–ç•¥ï¼Œæé«˜å†™å…¥ååé‡</li><li>åŒºé—´æŸ¥è¯¢æ•ˆç‡ä¸é«˜</li></ol></li></ol><h3 id="SSTables-å’Œ-LSM-Tree"><a href="#SSTables-å’Œ-LSM-Tree" class="headerlink" title="SSTables å’Œ LSM-Tree"></a>SSTables å’Œ LSM-Tree</h3><ol><li>SSTable çš„å…¨ç§°ï¼šSorted String Tableï¼Œæ’åºå­—ç¬¦ä¸²è¡¨</li><li>LSM-Tree çš„å…¨ç§°ï¼šLog-Structured Merge-Tree</li><li><p>ç›¸æ¯”å“ˆå¸Œç´¢å¼•çš„ä¼˜ç‚¹ï¼š</p><ol><li>åˆå¹¶æ®µæ›´ç®€å•é«˜æ•ˆï¼Œå¯¹äºå¤§æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤</li><li>æ®µæ–‡ä»¶ä¸­çš„ key-value é¡ºåºæ˜¯æŒ‰ç…§é”®æ’åºè¿‡çš„ï¼Œä¾¿äºåˆå¹¶å’ŒæŸ¥æ‰¾</li><li>åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾ç‰¹å®šé”®æ—¶æ— éœ€åœ¨å†…å­˜ä¸­ä¿å­˜æ‰€æœ‰é”®çš„ç´¢å¼•ï¼ˆç¨€ç–ç´¢å¼•æ”¾åœ¨å†…å­˜ä¸­ï¼‰</li><li>æ”¯æŒèŒƒå›´æŸ¥æ‰¾</li></ol></li><li><p>æ„å»ºå’Œç»´æŠ¤ SSTables</p><ol><li>åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå†…å­˜è¡¨ï¼Œå†™å…¥æ—¶å…ˆå†™å…¥è¯¥è¡¨ï¼ˆæœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå¦‚çº¢é»‘æ ‘æˆ–è€…è·³è¡¨ï¼‰</li><li>å†…å­˜è¡¨è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œç›´æ¥å†™ç›˜ï¼Œå½¢æˆ SSTableï¼›åœ¨å†™ç›˜åŒæ—¶ï¼Œå¯æ·»åŠ æ–°çš„å†…å­˜è¡¨å®ä¾‹ï¼Œæ¥æ”¶åç»­å†™è¯·æ±‚</li><li>å¯¹äºè¯»è¯·æ±‚ï¼Œå†…å­˜è¡¨-&gt;æœ€æ–°ç£ç›˜æ®µæ–‡ä»¶-&gt;æ¬¡æ–°æ®µæ–‡ä»¶-&gt;â€¦ç›´åˆ°æ‰¾åˆ°ç›®æ ‡æˆ–è€…ä¸ºç©º</li><li>åå°å®šæœŸåˆå¹¶ã€å‹ç¼©ï¼Œä¸¢å¼ƒè¢«è¦†ç›–æˆ–åˆ é™¤çš„å€¼</li></ol></li><li>é¿å…å´©æºƒçš„æ–¹å¼ï¼šæ¯ä¸ªå†™å…¥è®°å½•åˆ°æ—¥å¿—ï¼Œå½“å†…å­˜è¡¨å†™å…¥ SSTable åæ‰å¯ä»¥ä¸¢å¼ƒç›¸åº”æ—¥å¿—</li><li>åŸºäºåˆå¹¶å’Œå‹ç¼©æ’åºæ–‡ä»¶åŸç†çš„å­˜å‚¨å¼•æ“é€šå¸¸éƒ½å«ä½œ LSM å­˜å‚¨å¼•æ“</li><li>æ€§èƒ½ä¼˜åŒ–ï¼š<ol><li>åˆ†å±‚å‹ç¼©ï¼ŒLevelDB &amp; RocksDB</li><li>æŒ‰å¤§å°åˆ†çº§ï¼ŒHBase, Cassandra åˆ™ä¸¤ç§éƒ½æ”¯æŒ</li><li>å¸ƒéš†è¿‡æ»¤å™¨</li></ol></li></ol><h3 id="B-Trees"><a href="#B-Trees" class="headerlink" title="B-Trees"></a>B-Trees</h3><ol><li>å¹¿æ³›ä½¿ç”¨è®¤å¯çš„ç´¢å¼•ç»“æ„ï¼Œå¾ˆå¤šæ•°æ®åº“ä¸­æ ‡å‡†ç´¢å¼•å®ç°ï¼›å³ä½¿åœ¨éå…³ç³»æ•°æ®åº“ä¸­ä¹Ÿæœ‰ç”¨åˆ°</li><li>B-Tree æ˜¯é¢å‘å—æˆ–è€…é¡µè¿›è¡Œè®¾è®¡çš„ï¼Œå®ƒå°†æ•°æ®åº“åˆ†è§£æˆå›ºå®šå¤§å°çš„å—æˆ–é¡µï¼Œä¸€èˆ¬ä¸º 4 KBï¼Œé¡µæ˜¯å†…éƒ¨è¯»å†™çš„æœ€å°å•å…ƒ</li><li>æ¯ä¸ªé¡µé¢éƒ½æœ‰æ ‡è¯†ç¬¦ï¼Œå¯è¢«å¼•ç”¨</li><li>ä¸€ä¸ªé¡µæ‰€åŒ…å«çš„é¡µé¢å¼•ç”¨æ•°é‡ç§°ä¸ºåˆ†æ”¯å› å­</li><li><p>æ›´æ–°ç­–ç•¥ï¼š</p><ol><li>æœç´¢åŒ…å«æŒ‡å®šé”®çš„å­é¡µ</li><li>ä¿®æ”¹è¯¥é¡µçš„å€¼</li><li>æ•´é¡µå›å†™åˆ°ç£ç›˜ï¼ˆç›¸å½“äºè¦†ç›–åŸå…ˆçš„é¡µï¼Œå¯¹è¯¥é¡µçš„ä»»ä½•å¼•ç”¨ä¾ç„¶æœ‰æ•ˆï¼‰</li></ol></li><li><p>æ–°åŠ é”®ç­–ç•¥ï¼š</p><ol><li>æ‰¾åˆ°å¯å®¹çº³æ–°é”®èŒƒå›´çš„é¡µï¼Œç„¶åæ·»åŠ åˆ°è¯¥é¡µ</li><li>è‹¥é¡µé¢ç©ºé—´ä¸è¶³ï¼Œåˆ™å°†å…¶åˆ†è£‚ä¸ºä¸¤ä¸ªåŠæ»¡çš„é¡µï¼ŒåŒæ—¶ä¿®æ”¹çˆ¶é¡µï¼Œè®°å½•åˆ†è£‚åçš„æ–°çš„é”®çš„èŒƒå›´</li></ol></li><li><p>ä¸€ä¸ªå…·æœ‰ N ä¸ªé”®çš„ B-Tree çš„æ·±åº¦ä¸º O(log N)ï¼›å¤šæ•°æ•°æ®åº“å¯ä»¥é€‚åˆ 3~4 å±‚ B-Treeã€‚åˆ†æ”¯å› å­ä¸º 500 çš„ 4KB å››çº§æ ‘å¯å­˜å‚¨ 256TB çš„æ•°æ®</p></li><li>å´©æºƒæ¢å¤ï¼šWAL, Write-Ahead Logã€‚é€šè¿‡è¯¥æ—¥å¿—æ¥æ¢å¤</li><li>éœ€è¦è€ƒè™‘å¹¶å‘æ§åˆ¶</li><li>å†™æ”¾å¤§çš„é—®é¢˜ï¼ˆé¡µåˆ†è£‚ï¼‰</li><li>äº‹åŠ¡æ”¯æŒæ›´åŠ å®¹æ˜“</li></ol><h2 id="äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰"><a href="#äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰" class="headerlink" title="äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰"></a>äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰</h2><ol><li>äºŒè€…å¯¹æ¯”ï¼š<br> <img src="./compare-oltp-olap.png" alt=""></li><li>å¤§çš„ä¼ä¸šä¼šå•ç‹¬å»ºç«‹æ•°ä»“ï¼ŒåŒæ­¥æ¥è‡ª OLTP ç³»ç»Ÿçš„æ•°æ®ï¼Œåœ¨å•ç‹¬çš„æ•°ä»“ä¸­è¿›è¡Œåˆ†æå¤„ç†ï¼Œä¸ä¼šå½±å“çº¿ä¸Šä¸šåŠ¡</li><li>å¯¼å…¥æ•°ä»“ï¼šELT, Extract-&gt;Transform-&gt;Load<br> <img src="./etl.png" alt=""></li><li>å¸¸è§æ•°ä»“ç³»ç»Ÿï¼šApache Hive, Spark SQL, Cloudera Implala</li></ol><h3 id="æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼"><a href="#æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼" class="headerlink" title="æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼"></a>æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼</h3><ol><li>å¸¸è§çš„æ˜¯æ˜Ÿå‹æ¨¡å¼ï¼Œä¹Ÿç§°ä¸ºç»´åº¦å»ºæ¨¡ã€‚ç‰¹ç‚¹æ˜¯æœ‰ä¸€ä¸ª<strong>äº‹å®è¡¨</strong>ï¼Œå…³è”äº†å¾ˆå¤šä¸ª<strong>ç»´åº¦è¡¨</strong>ã€‚äº‹å®è¡¨æœ¬èº«å¯èƒ½ä¼šå¾ˆåºå¤§ï¼Œå…¶ä¸­çš„æ¯ä¸€è¡Œéƒ½ä»£è¡¨ä¸€ä¸ªäº‹ä»¶ï¼Œç»´åº¦é€šå¸¸ä»£è¡¨äº‹ä»¶çš„<strong>Who, What, Where, When, How, Why</strong><br> <img src="./star-pattern.png" alt=""></li><li>é›ªèŠ±â„ï¸ æ¨¡å‹æ˜¯æ˜Ÿå‹æ¨¡å‹çš„å˜ä½“ï¼Œå®ƒå°†ç»´åº¦è¿›ä¸€æ­¥ç»†åˆ†ä¸ºå­ç©ºé—´ï¼Œä»è€Œæ›´åŠ è§„èŒƒåŒ–ã€‚ä½†æ˜¯è¿™ä¸ªä¼šå¢åŠ åˆ†ææŸ¥è¯¢çš„å¤æ‚åº¦ï¼Œæ‰€ä»¥æ˜Ÿå‹åˆ†ææ¨¡å¼æ›´å—æ¬¢è¿</li></ol><h3 id="åˆ—å­˜å‚¨"><a href="#åˆ—å­˜å‚¨" class="headerlink" title="åˆ—å­˜å‚¨"></a>åˆ—å­˜å‚¨</h3><ol><li>æ•°ä»“ä¸­çš„åˆ—é€šå¸¸å¾ˆå®½ï¼Œæœ‰çš„å¯èƒ½å¤šè¾¾ 100 ä¸ª</li><li>æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ¯åˆ—ä¸­çš„æ‰€æœ‰å€¼å­˜å‚¨åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰çš„æ•°æ®æ—¶å­˜å‚¨åœ¨ä¸€ç»„åˆ—æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä»¥ç›¸åŒé¡ºåºä¿å­˜æ•°æ®è¡Œ</li><li><p>åˆ—å‹ç¼©ï¼š</p><ol><li>å¾ˆå®¹æ˜“è¿›è¡Œå‹ç¼©</li><li>å¸¸ç”¨ä½å›¾ç¼–ç ï¼Œå¹¶é…åˆæ¸¸ç¨‹ç¼–ç é™ä½å­˜å‚¨ç©ºé—´ï¼ˆè¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹é›¶ä½ç¨€ç–çš„æƒ…å†µï¼‰<br><img src="./bitmap.png" alt=""></li></ol></li><li><p>åˆ—æ’åºï¼š</p><ol><li>å¯ä»¥æ ¹æ®æŸ¥è¯¢éœ€æ±‚é€‰æ‹©æ’åºçš„åˆ—</li><li>æ’åºå¯å¸®åŠ©è¿›ä¸€æ­¥å‹ç¼©ï¼ˆé‡å¤å€¼ä¹Ÿå¯ä»¥é‡‡ç”¨ç®€å•çš„æ¸¸ç¨‹ç¼–ç ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯æ•°åäº¿è¡Œä¹Ÿä¸æ€•ï¼‰</li><li>åŸºäºç¬¬ä¸€ä¸ªæ’åºé”®çš„å‹ç¼©æ•ˆæœé€šå¸¸æœ€å¥½</li><li>æ’åºç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­ç”¨çš„ç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢</li></ol></li><li>å†™å…¥å¯ä»¥é‡‡å–ç±»ä¼¼ LSM-Tree çš„æ€è·¯</li><li>ç‰©åŒ–è§†å›¾ï¼šæŸ¥è¯¢ç»“æœçš„å®é™…å‰¯æœ¬ï¼Œè¢«å†™å…¥åˆ°ç£ç›˜äº†ï¼›è™šæ‹Ÿè§†å›¾åˆ™æ˜¯ç”¨äºç¼–å†™æŸ¥è¯¢çš„å¿«æ·æ–¹å¼</li></ol><h1 id="æ•°æ®ç¼–ç ä¸æ¼”åŒ–"><a href="#æ•°æ®ç¼–ç ä¸æ¼”åŒ–" class="headerlink" title="æ•°æ®ç¼–ç ä¸æ¼”åŒ–"></a>æ•°æ®ç¼–ç ä¸æ¼”åŒ–</h1><h2 id="æ•°æ®ç¼–ç æ ¼å¼"><a href="#æ•°æ®ç¼–ç æ ¼å¼" class="headerlink" title="æ•°æ®ç¼–ç æ ¼å¼"></a>æ•°æ®ç¼–ç æ ¼å¼</h2><ol><li>ç¨‹åºä¸­è‡³å°‘æœ‰ä¸¤ç§å¸¸ç”¨çš„æ•°æ®è¡¨ç¤ºå½¢å¼ï¼š<ol><li>å†…å­˜ä¸­ï¼Œæ•°æ®ä¿å­˜åœ¨å¯¹è±¡ã€ç»“æ„ä½“ã€åˆ—è¡¨ã€æ•°ç»„ã€å“ˆå¸Œè¡¨å’Œæ ‘ç­‰ç»“æ„ä¸­ï¼Œå¯¹äº CPU çš„é«˜æ•ˆè®¿é—®å’Œæ“ä½œåšäº†ä¼˜åŒ–</li><li>æ•°æ®å†™å…¥æ–‡ä»¶æˆ–è€…ç½‘ç»œä¼ è¾“æ—¶ï¼Œéœ€è¦è¿›è¡Œç¼–ç ä¸ºå­—èŠ‚åºåˆ—</li></ol></li></ol><h3 id="è¯­è¨€ç‰¹å®šçš„æ ¼å¼"><a href="#è¯­è¨€ç‰¹å®šçš„æ ¼å¼" class="headerlink" title="è¯­è¨€ç‰¹å®šçš„æ ¼å¼"></a>è¯­è¨€ç‰¹å®šçš„æ ¼å¼</h3><ol><li>å¸¸è§çš„åŒ…æ‹¬ï¼š<ol><li>java.io.Serializable</li><li>Ruby ä¸­çš„ Marshal</li><li>Python ä¸­çš„ pickle</li></ol></li><li>ä¼˜ç‚¹ï¼šå¯¹äºæŸç§è¯­è¨€è‡ªèº«æ¥è¯´ï¼Œç¼–è§£ç ä¼šå¾ˆæ–¹ä¾¿ï¼Œä¸éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–</li><li>ç¼ºç‚¹ï¼š<ol><li>ä¸ç‰¹å®šè¯­è¨€ç»‘å®šï¼Œä¸åˆ©äºå’Œå…¶å®ƒè¯­è¨€çš„å¼‚æ„ç³»ç»Ÿé€šè®¯</li><li>å¯èƒ½ä¼šæœ‰å®‰å…¨æ€§é—®é¢˜</li><li>å…¼å®¹æ€§ä¸èƒ½ä¿è¯</li><li>æ•ˆç‡é€šå¸¸æ¯”è¾ƒä½ï¼Œéœ€è¦èŠ±è´¹è¾ƒå¤šçš„ CPU æ—¶é—´æˆ–è€…å†…å­˜ç©ºé—´</li></ol></li></ol><h3 id="JSONã€XML-å’ŒäºŒè¿›åˆ¶å˜ä½“"><a href="#JSONã€XML-å’ŒäºŒè¿›åˆ¶å˜ä½“" class="headerlink" title="JSONã€XML å’ŒäºŒè¿›åˆ¶å˜ä½“"></a>JSONã€XML å’ŒäºŒè¿›åˆ¶å˜ä½“</h3><ol><li>JSONã€CSVã€XML éƒ½æ˜¯æ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå¥½</li><li><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p><ol><li>æ•°å­—ç¼–ç ä¸æ˜ç¡®ï¼ˆæ¯”å¦‚ CSV ä¸­å°±æ— æ³•åŒºåˆ†æ˜¯æ•°å­—è¿˜æ˜¯æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²ï¼›JSON ä¸­å¯¹äºå¤§äº 2^53 çš„æ•´æ•°å°±å‚»çœ¼äº†ï¼‰</li><li>ä¸æ”¯æŒäºŒè¿›åˆ¶ï¼ˆè™½ç„¶å¯ä»¥ç”¨ base64 æäº‹æƒ…ï¼Œä½†æ˜¯ä¼šå¢åŠ ç©ºé—´å’Œç¼–è§£ç çš„æ—¶é—´ï¼‰</li><li>CSV æ— ä»»ä½•æ¨¡å¼</li><li>XML å’Œ JSON å‡æœ‰å¯é€‰çš„æ¨¡å¼</li></ol></li><li><p>ä¸€äº›å˜ç§ï¼Œå®ƒä»¬çš„åº”ç”¨å¹¶ä¸æ˜¯å¾ˆå¹¿æ³›ï¼š</p><ol><li>JSONï¼ˆBSONã€BJSONã€UBJSONã€BISONã€Smile å’Œ Message Packï¼‰</li><li>XMLï¼ˆWBXML å’Œ Fast Infosetï¼‰</li></ol></li><li><p>åé¢çš„ğŸŒ°éƒ½ä»¥è¡¨è¾¾ä¸‹é¢çš„ä¿¡æ¯ä¸ºä¾‹ï¼Œæ¥åšå¯¹ç…§ï¼š</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"userName"</span>: <span class="string">"Martin"</span>,</span><br><span class="line">    <span class="attr">"favoriteNumber"</span>: <span class="number">1337</span>,</span><br><span class="line">    <span class="attr">"interests"</span>: [<span class="string">"daydreaming"</span>, <span class="string">"hacking"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Message Pack æ˜¯ JSON çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š<br> <img src="./msg-pack-encode.png" alt=""></p></li></ol><h3 id="Thrift-amp-Protocol-Buffers"><a href="#Thrift-amp-Protocol-Buffers" class="headerlink" title="Thrift &amp; Protocol Buffers"></a>Thrift &amp; Protocol Buffers</h3><ol><li>Thrift æ˜¯ Facebook å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº</li><li>Thrift æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ RPC æ¡†æ¶ï¼Œåœ¨å®ƒçš„åè®®å±‚æä¾›äº†å¤šç§ Protocol çš„å®ç°ï¼Œæ–¹ä¾¿åº”ä»˜å¤šç§åœºæ™¯ã€‚æ¯”å¦‚å¸¸è§çš„ <code>BinaryProtocol</code> å’Œ <code>CompactProtocol</code>ã€‚</li><li><p>BinaryProtocol ç¼–ç ç¤ºä¾‹ï¼š</p><ol><li>ä¸ Message Pack ç¼–ç ç›¸æ¯”ï¼Œæ²¡æœ‰äº†å­—æ®µå</li><li>ä½¿ç”¨äº† field tag æ¥æ˜ å°„ IDL å®šä¹‰çš„å„ä¸ªå­—æ®µ<br><img src="./thrift-bin-proto-encode.png" alt=""></li></ol></li><li><p>CompactProtocol ç¼–ç ç¤ºä¾‹ï¼š</p><ol><li>field tag å’Œ type ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤º</li><li>field tag ä½¿ç”¨äº†åç§»è®¡ç®—</li><li>æ•´æ•°é‡‡ç”¨å˜é•¿å­—èŠ‚ï¼Œè€Œé BinaryProtocol ä¸­ 1337 ä½¿ç”¨çš„ 8 å­—èŠ‚ï¼Œæ¢æˆå˜é•¿å­—èŠ‚åªéœ€è¦ 2 å­—èŠ‚å³å¯<br><img src="./thrift-comp-proto-encode.png" alt=""></li></ol></li><li><p>Protocol Buffers Google å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº</p></li><li><p>ä½¿ç”¨ PB ç¼–ç çš„ç¤ºä¾‹ï¼š<br> <img src="./pb-encode.png" alt=""></p></li><li><p><code>required</code> å’Œ <code>optional</code> è¿™ç§ä¿®é¥°æ˜¯ä¸ä¼šä½“ç°åœ¨ç¼–ç ä¸­çš„ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶åšçš„æ£€æŸ¥</p></li><li>ä¿è¯å‰åå‘å…¼å®¹ï¼š<ol><li>field tag è‡³å…³é‡è¦ï¼Œä¸å¯éšä¾¿æ›´æ”¹</li><li>optional å­—æ®µçš„ field tag å¯ä»¥åˆ é™¤ï¼Œä½†ä¸è¦å¤ç”¨å·²åˆ é™¤çš„ field tag</li><li>æ–°å¢å­—æ®µå¿…é¡»æ˜¯ optional æˆ–è€…å¸¦æœ‰é»˜è®¤å€¼ï¼Œä¿è¯å‘åå…¼å®¹</li><li>ä¸å¯è½»æ˜“ä¿®æ”¹ field ç±»å‹</li></ol></li></ol><h3 id="Avro"><a href="#Avro" class="headerlink" title="Avro"></a>Avro</h3><ol><li>Apache Avro æ˜¯ Hadoop çš„å­é¡¹ç›®ï¼Œæä¾›äº†ä¸¤ç§æ¨¡å¼è¯­è¨€ï¼šAvro IDL å’Œ JSON æ ¼å¼</li><li><p>ç‰¹ç‚¹ï¼š</p><ol><li>æ²¡æœ‰æ ‡ç­¾å·</li><li>ç¼–ç éå¸¸ç´§å‡‘</li><li>ç¼–ç ä¸­æ²¡æœ‰å­—æ®µç±»å‹</li></ol></li><li><p>ç¼–ç ç¤ºä¾‹ï¼š<br> <img src="./avro-encode.png" alt=""></p></li><li><p>åŒºåˆ†è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ã€‚å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸å¿…å®Œå…¨ä¸€æ¨¡ä¸€æ ·ï¼Œåªéœ€è¦ä¿æŒå…¼å®¹</p></li><li>å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸­çš„å­—æ®µé¡ºåºå¯ä¸åŒï¼Œå› ä¸ºåœ¨æ¨¡å¼è§£ææ—¶ä¼šä½¿ç”¨å­—æ®µååŒ¹é…</li><li>åŠ¨æ€ç”Ÿæˆæ¨¡å¼æ˜¯æœ€å¤§çš„ç‰¹ç‚¹ï¼Œä¸éœ€è¦åƒ PB æˆ–è€… Thrift ä¸­é‚£æ ·ï¼Œæ˜¾å¼åˆ†é… field tagï¼Œæ¯”è¾ƒçµæ´»ã€‚ç‰¹åˆ«é€‚åˆç¼–ç æ•°æ®åº“è¡¨ã€‚</li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">æ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ï¼šç¬¬ä¸€éƒ¨åˆ†</a></li><li><a href="http://thrift.apache.org/" target="_blank" rel="noopener">Thrift</a></li><li><a href="https://developers.google.cn/protocol-buffers/" target="_blank" rel="noopener">Protocol Buffers</a></li><li><a href="http://avro.apache.org/docs/current/gettingstartedpython.html" target="_blank" rel="noopener">Avro Python Examples</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDesign Data-Intensive Applicationsï¼‰æ˜¯ä¸€æœ¬éå¸¸æœ‰è¯šæ„ã€éå¸¸ä¼˜ç§€çš„è®²è§£é’ˆå¯¹æ•°æ®å¯†é›†åœºæ™¯ä¸‹ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„ç›®æ ‡ã€åŸåˆ™å’ŒæŠ€æœ¯é€‰å‹ç­‰çŸ¥è¯†ã€‚ä½œè€…ç»“åˆç†è®ºä¸å®è·µï¼Œä¸ºæˆ‘ä»¬å±•ç°äº†ä¸€äº›æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ï¼›åŒæ—¶è¿˜ä»‹ç»äº†ä¸€äº›å…³é”®æŠ€æœ¯ï¼ˆå¦‚å­˜å‚¨å¼•æ“ã€åºåˆ—åŒ–åè®®ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰ç­‰çš„å®ç°åŸç†ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿ&lt;strong&gt;çŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶&lt;/strong&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹" scheme="http://ifaceless.space/tags/%E3%80%8A%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1%E3%80%8B/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://ifaceless.space/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="æ•°æ®æ¨¡å‹" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/"/>
    
      <category term="æ•°æ®åº“å­˜å‚¨" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%82%A8/"/>
    
      <category term="æ•°æ®ç¼–ç " scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81/"/>
    
  </entry>
  
</feed>
