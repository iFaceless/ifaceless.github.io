<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é»‘ç™½ä¹‹é™¢</title>
  
  <subtitle>Valar Morghulis</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://ifaceless.space/"/>
  <updated>2019-11-24T09:45:59.962Z</updated>
  <id>http://ifaceless.space/</id>
  
  <author>
    <name>iFaceless</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ–ï¼Ÿ</title>
    <link href="http://ifaceless.space/2019/11/22/portal/"/>
    <id>http://ifaceless.space/2019/11/22/portal/</id>
    <published>2019-11-22T13:50:45.000Z</published>
    <updated>2019-11-24T09:45:59.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚</p><p>è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚</p><p>ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¹Ÿé‡åˆ°äº†è¯¸å¤šé—®é¢˜ï¼š</p><ol><li>API Schema çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®šä¹‰çš„ä¸åŒï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨å‘å·å™¨è·å¾—çš„ ID åœ¨ Model struct ä¸­å®šä¹‰çš„æ˜¯ int64ï¼Œä½†æ˜¯ä¸ºäº†é¿å… json.Marshal æ—¶æº¢å‡ºï¼ˆæµè§ˆå™¨æˆªæ–­ï¼‰ï¼Œç»Ÿä¸€è¿”å›äº† string ç±»å‹çš„ IDï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼›</li><li>API Schema çš„å­—æ®µåç§°å’Œ Model ä¸­å®šä¹‰çš„å¯èƒ½ä¸åŒï¼›</li><li>æ”¯æŒçµæ´»çš„ Schema å­—æ®µè¿‡æ»¤æ¯”è¾ƒéº»çƒ¦ï¼Œä¸åŒçš„é¡¹ç›®å®ç°å¯èƒ½ä¸åŒï¼›</li><li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚è¯¾ç¨‹ API Schema å…³è”çš„ä¸€äº›æ•°æ®æ¥è‡ªäºå…¶å®ƒæœåŠ¡ï¼ˆéœ€è¦é€šè¿‡ RPC è°ƒç”¨ï¼‰ï¼Œè¿™æ—¶å¦‚æœèƒ½å¤Ÿå¹¶å‘åŠ è½½å°±æœ‰æé«˜æ¥å£å“åº”é€Ÿåº¦çš„å¯èƒ½ï¼Œä½†æ˜¯éœ€è¦æ¯æ¬¡åœ¨åº”ç”¨å±‚é‡æ–°å®ç°ï¼ˆå½“ç„¶å¯ä»¥å†æŠ½ä¸€å±‚å‡ºæ¥ï¼Œä¸è¿‡è¿˜æ˜¯å¾ˆéº»çƒ¦ï¼Œä¼šæœ‰å¿ƒæ™ºè´Ÿæ‹…ï¼‰ã€‚</li><li>â€¦â€¦</li></ol><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ</p><h1 id="æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”"><a href="#æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”" class="headerlink" title="æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”"></a>æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”</h1><p>æˆ‘ä»¬ä¹‹å‰åœ¨ä½¿ç”¨ Python é¡¹ç›®å¼€å‘æ—¶ï¼Œä½¿ç”¨åˆ°äº† <a href="https://github.com/marshmallow-code/marshmallow" target="_blank" rel="noopener">marshmallow</a> è¿™ä¸ªè½»é‡çº§çš„å¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ã€‚å½“ç„¶ï¼Œå®ƒä¸ä»…ä»…æä¾›åºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œè¿˜æœ‰ååºåˆ—åŒ–ä»¥åŠå­—æ®µæ ¡éªŒçš„èƒ½åŠ›ã€‚å¦‚æœèƒ½å¤Ÿæ°å½“çš„ä½¿ç”¨å®ƒï¼Œæ˜¯å¯ä»¥æå‡å¼€å‘æ•ˆç‡çš„ã€‚å¦‚æœåœ¨ Go è¯­è¨€ç¤¾åŒºä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªæ¡†æ¶çš„è¯ï¼Œå®ƒæ˜¯å¯ä»¥è§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜çš„ã€‚</p><p>åœ¨ç»è¿‡ä¸€ç•ªæ€æƒ³æ–—äº‰åï¼Œæ–—èƒ†å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„æ¡†æ¶ <a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> ç”¨äºè§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜ã€‚<a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> èšç„¦äºä»¥ä¼˜é›…ä¸”ä¸€è‡´çš„æ–¹å¼å¤„ç†å¯¹è±¡åºåˆ—åŒ–çš„é—®é¢˜ï¼›è€Œå¯¹äº Struct Fields çš„æ ¡éªŒé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¬¬ä¸‰æ–¹åº“å¦‚ <a href="https://github.com/go-playground/validator" target="_blank" rel="noopener">go-playground/validator</a> æˆ– <a href="https://github.com/asaskevich/govalidator" target="_blank" rel="noopener">asaskevich/govalidator</a>ã€‚</p><p>ç›®å‰æ¥è¯´ï¼Œæ ¸å¿ƒåŠŸèƒ½å‡å·²æŒ‰ç…§æœ€åˆçš„è®¾è®¡å®ç°äº†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ol><li>æä¾›ç®€æ´æ˜“ç”¨çš„ API æ¥å£</li><li>æ”¯æŒéå¸¸çµæ´»çš„å­—æ®µè¿‡æ»¤èƒ½åŠ›ï¼ˆä»»æ„æ·±åº¦çš„åµŒå¥—å­—æ®µè¿‡æ»¤ï¼‰</li><li>è‡ªåŠ¨å°è¯•ç±»å‹è½¬æ¢ï¼Œè¿œç¦»æ‰‹åŠ¨ç¼–å†™å¤ªå¤šæ²¡ä»€ä¹ˆçµé­‚çš„ç±»å‹è½¬æ¢ä»£ç ï¼ˆæ—©ç‚¹ä¸‹ç­ä¸å¥½å—ï¼Ÿï¼‰</li><li>æ”¯æŒå¹¶å‘å¡«å……å­—æ®µå€¼ï¼š<ol><li>å¯æ‰‹åŠ¨æŒ‡å®šå“ªäº›å­—æ®µå¼‚æ­¥åŠ è½½</li><li>å¯è®¾ç½®å…¨å±€çš„ goroutine æ± å¤§å°</li></ol></li></ol><h1 id="ä½¿ç”¨-PORTAL"><a href="#ä½¿ç”¨-PORTAL" class="headerlink" title="ä½¿ç”¨ PORTAL"></a>ä½¿ç”¨ PORTAL</h1><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…è¯¥åŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get get -u github.com/ifaceless/portal</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ Model ç»“æ„ä½“</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotificationModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">int</span></span><br><span class="line">    Title   <span class="keyword">string</span></span><br><span class="line">    Content <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Fullname</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        <span class="comment">// åç§°ç”šè‡³å¯ä»¥æ¥è‡ª RPC è°ƒç”¨ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"user:%d"</span>, u.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notifications è¿”å›ç”¨æˆ·å…³è”çš„ä¸€äº›é€šçŸ¥ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Notifications</span><span class="params">()</span> <span class="params">(result []*NotificationModel)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1</span>; i++ &#123;</span><br><span class="line">        result = <span class="built_in">append</span>(result, &amp;NotificationModel&#123;</span><br><span class="line">            ID:      i,</span><br><span class="line">            Title:   fmt.Sprintf(<span class="string">"title_%d"</span>, i),</span><br><span class="line">            Content: fmt.Sprintf(<span class="string">"content_%d"</span>, i),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="keyword">int</span></span><br><span class="line">    UserID <span class="keyword">int</span></span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User è¿”å› Task å…³è”çš„ç”¨æˆ·æ˜¯è°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TaskModel)</span> <span class="title">User</span><span class="params">()</span> *<span class="title">UserModel</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserModel&#123;t.UserID&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒæ­¥ï¼šå®šä¹‰ API Schema ç»“æ„ä½“</strong></p><p>ä»¥ä¸‹ Schema åœ¨å®šä¹‰æ—¶ï¼Œéƒ½æ·»åŠ äº† json tagï¼Œå¹¶ä¸”æ ‡è®°ä¸º omitemptyã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œ<strong>å½“æˆ‘ä»¬é€‰æ‹©è¿‡æ»¤æŸäº›å­—æ®µçš„æ—¶å€™ï¼Œportal å°±ä¸ä¼šå¡«å……å¯¹åº”çš„ Schema Fields</strong>ã€‚å› æ­¤ï¼Œæ ‡è®°äº† omitempty çš„å­—æ®µåœ¨ json.Marshal åå°±ä¸ä¼šå‡ºç°ï¼Œä»è€Œè¾¾åˆ°å­—æ®µè¿‡æ»¤çš„ç›®çš„ã€‚ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotiSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">string</span> <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title   <span class="keyword">string</span> <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Content <span class="keyword">string</span> <span class="string">`json:"content,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID                   <span class="keyword">string</span>        <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    <span class="comment">// åç§°æ˜¯ä» User.Fullname() æ–¹æ³•ä¸­è·å–ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º User çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨ `attr` æ ‡è®°</span></span><br><span class="line">    Name                 <span class="keyword">string</span>        <span class="string">`json:"name,omitempty" portal:"attr:Fullname"`</span></span><br><span class="line">        <span class="comment">// nested è¡¨æ˜è¯¥å­—æ®µçš„å€¼æ˜¯ä¸€ä¸ªå¤åˆç±»å‹ï¼Œportal ä¼šè‡ªåŠ¨å°† notifications æ•°æ®å¡«å……åˆ°å¯¹åº”çš„ schema åˆ—è¡¨</span></span><br><span class="line">    Notifications        []*NotiSchema <span class="string">`json:"notifications,omitempty" portal:"nested"`</span></span><br><span class="line">    AnotherNotifications []*NotiSchema <span class="string">`json:"another_notifications,omitempty" portal:"nested;attr:Notifications"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID          <span class="keyword">string</span>      <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title       <span class="keyword">string</span>      <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Description <span class="keyword">string</span>      <span class="string">`json:"description,omitempty" portal:"meth:GetDescription"`</span></span><br><span class="line">    <span class="comment">// UserSchema is a nested schema</span></span><br><span class="line">    User        *UserSchema <span class="string">`json:"user,omitempty" portal:"nested"`</span></span><br><span class="line">    <span class="comment">// We just want `Name` field for `SimpleUser`.</span></span><br><span class="line">    <span class="comment">// Besides, the data source is the same with `UserSchema`</span></span><br><span class="line">    SimpleUser  *UserSchema <span class="string">`json:"simple_user,omitempty" portal:"nested;only:Name;attr:User"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetDescription æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•æ¥æä¾›æƒ³è¦çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿”å›ä¸åŒçš„æ–‡æ¡ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TaskSchema)</span> <span class="title">GetDescription</span><span class="params">(model *model.TaskModel)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Custom description"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ­¥ï¼šæŒ‰éœ€åºåˆ—åŒ–</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"github.com/ifaceless/portal"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// log debug info</span></span><br><span class="line">    portal.SetDebug(<span class="literal">true</span>)</span><br><span class="line">    <span class="comment">// set max worker pool size</span></span><br><span class="line">    portal.SetMaxPoolSize(<span class="number">1024</span>)</span><br><span class="line">    <span class="comment">// make sure to clean up.</span></span><br><span class="line">    <span class="keyword">defer</span> portal.CleanUp()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write to a specified task schema</span></span><br><span class="line">    <span class="keyword">var</span> taskSchema schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel)</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","title":"Finish your jobs.","description":"Custom description","user":&#123;"id":"1","name":"user:1","notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;],"another_notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// select specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"Title"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// select fields with alias defined in the json tag.</span></span><br><span class="line">    <span class="comment">// actually, the default alias tag is `json`, `portal.FieldAliasMapTagName("json")` is optional.</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"title"</span>, <span class="string">"SimpleUser"</span>), portal.FieldAliasMapTagName(<span class="string">"json"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// you can keep any fields for any nested schemas</span></span><br><span class="line">    <span class="comment">// multiple fields are separated with ','</span></span><br><span class="line">    <span class="comment">// nested fields are wrapped with '[' and ']'</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"ID"</span>, <span class="string">"User[ID,Notifications[ID],AnotherNotifications[Title]]"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","user":&#123;"id":"1","notifications":[&#123;"id":"0"&#125;],"another_notifications":[&#123;"title":"title_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ignore specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Exclude(<span class="string">"Description"</span>, <span class="string">"ID"</span>, <span class="string">"User[Name,Notifications[ID,Content],AnotherNotifications], SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","user":&#123;"id":"1","notifications":[&#123;"title":"title_0"&#125;]&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dump multiple tasks</span></span><br><span class="line">    <span class="keyword">var</span> taskSchemas []schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchemas, &amp;taskModels, portal.Only(<span class="string">"ID"</span>, <span class="string">"Title"</span>, <span class="string">"User[Name]"</span>))</span><br><span class="line">    <span class="comment">// data: [&#123;"id":"0","title":"Task #1","user":&#123;"name":"user:100"&#125;&#125;,&#123;"id":"1","title":"Task #2","user":&#123;"name":"user:101"&#125;&#125;]</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šä»…ä»…æ˜¯ PORTAL çš„ä¸€äº›ç®€å•åœºæ™¯çš„åº”ç”¨ï¼Œè¯¦ç»†å¯ä»¥æŸ¥çœ‹<a href="https://github.com/iFaceless/portal/blob/master/examples/todo" target="_blank" rel="noopener">å®Œæ•´ç¤ºä¾‹</a>ï¼Œåœ¨<a href="https://github.com/iFaceless/portal/blob/master/USERGUIDE.md" target="_blank" rel="noopener">ä½¿ç”¨æŒ‡å—</a>ä¸­æä¾›äº†ä¸€äº›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ã€‚</p><h1 id="æ ¸å¿ƒ-API"><a href="#æ ¸å¿ƒ-API" class="headerlink" title="æ ¸å¿ƒ API"></a>æ ¸å¿ƒ API</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ...Option)</span> <span class="params">(*Chell, error)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Dump</span><span class="params">(dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span> <span class="title">error</span> </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">DumpWithContext</span><span class="params">(ctx context.Context, dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetDebug</span><span class="params">(v <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetMaxPoolSize</span><span class="params">(size <span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">CleanUp</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h1 id="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"><a href="#å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥" class="headerlink" title="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"></a>å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥</h1><ul><li>å½“æŸä¸ª Schema ç»“æ„ä½“å­—æ®µæ ‡è®°äº† <code>portal:&quot;async&quot;</code> æ ‡ç­¾æ—¶ä¼šå¼‚æ­¥å¡«å……å­—æ®µå€¼ï¼›</li><li>å½“åºåˆ—åŒ– Schema åˆ—è¡¨æ—¶ï¼Œä¼šåˆ†æ Schema ä¸­æœ‰æ— æ ‡è®°äº† <code>async</code> çš„å­—æ®µï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ä½¿ç”¨å¹¶å‘å¡«å……ç­–ç•¥ï¼›å¦åˆ™åªåœ¨å½“å‰ goroutine ä¸­å®Œæˆåºåˆ—åŒ–ï¼›</li><li>å¯ä»¥åœ¨ Dump æ—¶æ·»åŠ  <code>portal.DisableConcurrency()</code> ç¦ç”¨å¹¶å‘åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚</li></ul><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p><strong>Q: ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€ worker pool å­˜åœ¨ï¼Ÿ</strong><br><strong>A:</strong> è€ƒè™‘åˆ°åœ¨ Web æœåŠ¡ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutine å¤„ç†ã€‚è€Œåœ¨å¤„ç†è¯·æ±‚ä¸­ï¼Œå¦‚æœä¸é™åˆ¶ PORTAL å¹¶å‘åŠ è½½å­—æ®µå€¼æ—¶çš„ goroutine æ•°é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„èµ„æºæ¶ˆè€—é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† ants æ¡†æ¶ã€‚</p><p><strong>Q: æ€§èƒ½ v.s å¼€å‘æ•ˆç‡ï¼Ÿ</strong><br><strong>A:</strong>å…¶å®å¼•å…¥è¿™ç§æ¡†æ¶ï¼ŒåŠ¿å¿…ä¼šå¯¹æ¥å£å¤„ç†æ—¶çš„å†…å­˜å ç”¨ï¼Œå¤„ç†æ€§èƒ½äº§ç”Ÿå½±å“ã€‚å› ä¸ºå†…éƒ¨å®ç°ä¸­ä¹Ÿä¸å¯é¿å…åœ°å¤§é‡ä½¿ç”¨äº†åå°„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½çš„è¯ï¼Œé‚£è¿˜æ˜¯ä¸æ¨èä½¿ç”¨äº†ã€‚å°±æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼Œå¾ˆå¤šæ¥å£çš„ QPS å¹¶ä¸é«˜ï¼ˆå°¤å…¶æ˜¯ä¸€äº›åå°æ¥å£ï¼‰ï¼Œä¸ç®¡æ˜¯ CPU è¿˜æ˜¯å†…å­˜èµ„æºéƒ½æ˜¯å……è¶³çš„ã€‚è¿™ä¸ªæ—¶å€™ä½¿ç”¨ PORTAL æ˜¯å¯ä»¥æœ‰æ•ˆæé«˜å¼€å‘æ•ˆç‡çš„ï¼ˆä¸ªäººæ„šè§ï¼‰ï¼Œæ¯•ç«Ÿå¯ä»¥å°‘å†™ä¸€äº›ä»£ç ï¼Œè®©æœºå™¨å¹²äº›è ¢æ´»è„æ´»ã€‚</p><p><strong>Q: å®é™…é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ portal çš„ï¼Ÿæœ‰ä»€ä¹ˆä½“ä¼šï¼Ÿå¸¦æ¥äº†ä»€ä¹ˆæ”¶ç›Šï¼Ÿ</strong><br><strong>A:</strong>å†ç»å°†è¿‘ä¸€ä¸ªæœˆçš„å®é™…é¡¹ç›®å®è·µï¼Œportal ç›®å‰å·²ç»è¶‹äºç¨³å®šï¼Œå¹¶ä¸”ä¿®å¤äº†å¤§é‡é—®é¢˜ï¼Œå‘å¸ƒäº† 22 ä¸ªç‰ˆæœ¬ã€‚ç›®å‰è¯¥å·¥å…·åŒ…åº”åº”ç”¨åœ¨å¤šä¸ªçº¿ä¸ŠæœåŠ¡ä¸­ï¼ˆåŒ…æ‹¬ HTTP RESTful API å’Œ RPC ä¸­ Model åˆ° thrift å®šä¹‰ç±»å‹çš„æ˜ å°„ï¼‰ï¼Œæ•´ä½“æ„Ÿå—å°±æ˜¯å¼€å‘ä½“éªŒæˆå€æé«˜ï¼Œè€Œä¸”å¸¦æ¥äº†æ€§èƒ½å½±å“å¹¶æ²¡æœ‰æœ€å¼€å§‹è®¤ä¸ºçš„é‚£ä¹ˆå¤§ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸ªäººè®¤ä¸ºï¼Œæ¡†æ¶çš„å¼•å…¥æ­£æ˜¯ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œæå‡é¡¹ç›®è´¨é‡çš„ã€‚æ¡†æ¶å±‚çš„æŠ½è±¡å’Œå°è£…å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½åœ¨ä¸šåŠ¡ä»£ç å±‚ç¼–å†™é‡å¤æœºæ¢°å¼çš„ä»£ç ï¼ŒåŒæ—¶èƒ½å¤Ÿä¿è¯ç¼–å†™æ–¹å¼çš„ä¸€è‡´æ€§ï¼Œæå‡é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚<strong>æ‰€è°“çš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿè®¸æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼›æ‰€è°“çš„æå‰ä¼˜åŒ–ï¼Œä¹Ÿè®¸åªæ˜¯è¿‡åº¦ä¼˜åŒ–ã€‚</strong>æˆ‘ä»¬åº”è¯¥ç”¨ 20% æ—¶é—´è§£å†³ 80% çš„å¸¸è§„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯é«˜æ•ˆç‡é«˜è´¨é‡çš„é‚£ç§ã€‚è€Œå‰©ä¸‹ 20% çš„éš¾é¢˜ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ«çš„æ–¹æ³•è§£å†³ã€‚åˆ‡å‹¿æœ¬æœ«å€’ç½®ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯
      
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="å¯¹è±¡åºåˆ—åŒ–" scheme="http://ifaceless.space/tags/%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="Web API" scheme="http://ifaceless.space/tags/Web-API/"/>
    
      <category term="portal" scheme="http://ifaceless.space/tags/portal/"/>
    
  </entry>
  
  <entry>
    <title>Python æ ‡å‡†åº“æºç ä¹‹ threading æ¨¡å—</title>
    <link href="http://ifaceless.space/2019/11/22/python-stdlib-threading/"/>
    <id>http://ifaceless.space/2019/11/22/python-stdlib-threading/</id>
    <published>2019-11-22T13:03:33.000Z</published>
    <updated>2019-11-24T09:45:59.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>è™½ç„¶è¯´ Python å—é™äº CPython çš„å®ç°ï¼Œå­˜åœ¨çš„ GIL ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œæ²¡æ³•åˆ©ç”¨å¤šæ ¸è·‘å¤šçº¿ç¨‹ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼šç”¨åˆ°çº¿ç¨‹çš„ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ä¸€äº› I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</p><p>åœ¨ä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬éšæ—¶éœ€è¦æ³¨æ„<strong>ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰</strong>å’Œ<strong>æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰</strong>çš„é—®é¢˜ï¼Œå‰è€…ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è¿è¡Œç¨‹åºå¾—åˆ°çš„è¾“å‡ºå¯èƒ½ä¸åŒï¼›è€Œåè€…åˆ™æ›´ä¸ºå¯æ€•ï¼Œå®¹æ˜“å¯¼è‡´å…±äº«çš„æ•°æ®ç»“æ„è¢«é”™è¯¯ä¿®æ”¹ï¼Œç”šè‡³å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…å‡ºç°è«åå…¶å¦™çš„ Bugã€‚è¿™ä¸ªæ—¶å€™è‡ªç„¶å°±è¦ç”¨åˆ° Python threading æ¨¡å—ä¸ºæˆ‘ä»¬æä¾›çš„è‹¥å¹²åŒæ­¥åŸè¯­äº†ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ Lockã€RLockã€æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰ã€ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ç­‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥çš„æºç å­¦ä¹ æ˜¯åŸºäº <a href="https://github.com/python/cpython/blob/master/Lib/threading.py" target="_blank" rel="noopener">CPython master åˆ†æ”¯çš„çº¿ç¨‹æ¨¡å—</a>ã€‚å¸Œæœ›åœ¨å­¦ä¹ å®Œå®ƒä»¬çš„å®ç°åï¼Œèƒ½å¤ŸåŠ æ·±ç†è§£ï¼Œåˆç†è¿ç”¨ã€‚</p><h1 id="æºç å­¦ä¹ "><a href="#æºç å­¦ä¹ " class="headerlink" title="æºç å­¦ä¹ "></a>æºç å­¦ä¹ </h1><p>CPython çš„ threading æ¨¡å—å®é™…ä¸Šæ˜¯åŸºäº Java çš„çº¿ç¨‹æ¨¡å‹å®ç°çš„ï¼Œæ‰€ä»¥ç†Ÿæ‚‰ Java çš„è¯ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå¯¹è¯¥æ¨¡å—çš„å®ç°æ„Ÿåˆ°é™Œç”Ÿã€‚è¯¥æ¨¡å—æ˜¯åŸºäºæ›´åº•å±‚çš„ <code>_thread</code> æ¨¡å—ï¼ŒæŠ½è±¡å‡ºæ›´åŠ æ–¹ä¾¿ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œæ ¸å¿ƒåŒ…æ‹¬ <code>threading.Thread</code> çº¿ç¨‹ç±»å°è£…ï¼Œä¾¿äºç”¨æˆ·ç»§æ‰¿æˆ–ç»„åˆï¼›æ­¤å¤–è¿˜æœ‰ä¸€äº›åŒæ­¥åŸè¯­çš„å®ç°ã€‚<code>Python/thread_nt.h</code> æ–‡ä»¶ä¸­æ˜¯ C è¯­è¨€å®ç°çš„åº•å±‚å’Œçº¿ç¨‹æœ‰å…³çš„å‡½æ•°ï¼ˆå¦‚é”çš„åˆ›å»ºå’Œç»´æŠ¤ã€çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ï¼‰ã€‚</p><h2 id="åŒæ­¥åŸè¯­"><a href="#åŒæ­¥åŸè¯­" class="headerlink" title="åŒæ­¥åŸè¯­"></a>åŒæ­¥åŸè¯­</h2><h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>è¯¥æ¨¡å—ä¸­ï¼Œ<code>Lock</code> å…¶å®æ˜¯ä½¿ç”¨äº†åº•å±‚ <code>_thread.allocate_lock</code> å‡½æ•°æ¥åˆ›å»ºé”çš„ã€‚ä»£ç ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lock = _allocate_lock</span><br></pre></td></tr></table></figure><p>Lock ä¸ºæˆ‘ä»¬æä¾›äº† <code>acquire()</code> å’Œ <code>release()</code> è¿™ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹è°ƒç”¨ <code>acquire()</code> æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼ˆæ­¤æ—¶çº¿ç¨‹ä¸€èˆ¬å°±æ˜¯ç¡çœ ç­‰å¾…äº†ï¼‰ï¼Œç›´åˆ°ä¸»åŠ¨ <code>release()</code> åï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p><p>å…³äº Lock æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š</p><ol><li>è¯¥é”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°ä¸­é€’å½’ <code>acquire()</code> ä¼šå¯¼è‡´æ­»é”çš„é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ <code>RLock</code> æ¥ä»£æ›¿</li><li>Lock å¹¶é Mutexï¼ˆäº’æ–¥é”ï¼‰ï¼Œä¸”å®ƒåº•å±‚æ˜¯é€šè¿‡ä¿¡å·é‡é‚£æ ·å®ç°çš„ï¼Œæœ¬èº«ä¸ä¼šè®°å½•è°æŒæœ‰äº†è¯¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ Lock å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¢«å¼•ç”¨ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹è·å–ï¼Œè€Œåœ¨å­çº¿ç¨‹é‡Šæ”¾å®ƒã€‚å…·ä½“å¯ä»¥åœ¨ <code>CPython/Python/thread_nt.h:PyThread_allocate_lock</code> å¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°å¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lock support. It has to be implemented as semaphores.</span></span><br><span class="line"><span class="comment"> * I [Dag] tried to implement it with mutex but I could find a way to</span></span><br><span class="line"><span class="comment"> * tell whether a thread already own the lock or not.</span></span><br><span class="line"><span class="comment"> * Lock æ”¯æŒï¼šå®ƒå¿…é¡»ä»¥ä¿¡å·é‡çš„æ–¹å¼æ¥å®ç°ã€‚æˆ‘å°è¯•ä½¿ç”¨äº’æ–¥é”å®ç°è¿‡ï¼Œä½†æ˜¯æˆ‘</span></span><br><span class="line"><span class="comment"> * å‘ç°äº†å¦å¤–ä¸€ç§æ–¹å¼å¯ä»¥å¾—çŸ¥ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦æŒæœ‰äº†é”ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PyThread_type_lock</span><br><span class="line">PyThread_allocate_lock(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    PNRMUTEX aLock;</span><br><span class="line">    dprintf((<span class="string">"PyThread_allocate_lock called\n"</span>));</span><br><span class="line">    <span class="keyword">if</span> (!initialized)</span><br><span class="line">        PyThread_init_thread();</span><br><span class="line">    aLock = AllocNonRecursiveMutex() ;</span><br><span class="line">    dprintf((<span class="string">"%lu: PyThread_allocate_lock() -&gt; %p\n"</span>, PyThread_get_thread_ident(), aLock));</span><br><span class="line">    <span class="keyword">return</span> (PyThread_type_lock) aLock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶ä¸­ PNRMUTEX å®šä¹‰å¦‚ä¸‹ï¼Œå®ƒå¹¶ä¸ä¼šå‘Šè¯‰æˆ‘ä»¬å½“å‰æ˜¯å“ªä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="comment">// æŒæœ‰äº†é”</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NRMUTEX</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PyMUTEX_T cs;</span><br><span class="line">    PyCOND_T cv;</span><br><span class="line">    <span class="keyword">int</span> locked;</span><br><span class="line">&#125; NRMUTEX;</span><br><span class="line"><span class="keyword">typedef</span> NRMUTEX *PNRMUTEX;</span><br></pre></td></tr></table></figure></li></ol><p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œå…¶å® <code>PyCOND</code> å³æ¡ä»¶å˜é‡æ˜¯é€šè¿‡ä¿¡å·é‡æ¥å®ç°çš„ï¼›è€Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåœ¨ Python çš„ threading æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Condition å®ç°äº†ä¿¡å·é‡ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-ee4c29657d4deb6d0953bc8531241697_hd.png" alt=""></p><h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>RLock å°±æ˜¯å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰ï¼Œå®ƒå¯ä»¥è¢«æŒæœ‰é”çš„çº¿ç¨‹å¤šæ¬¡æ‰§è¡Œ <code>acquire()</code>ï¼Œè€Œä¸ä¼šå‘ç”Ÿé˜»å¡å’Œæ­»é”çš„é—®é¢˜ã€‚å®ƒçš„å®ç°æ€è·¯å¾ˆç®€å•ï¼š</p><ol><li>è§„å®šå¦‚æœä¸€ä¸ªçº¿ç¨‹æˆåŠŸæŒæœ‰äº†è¯¥é”ï¼Œåˆ™å°†è¯¥é”çš„æ‰€æœ‰æƒäº¤ç»™è¯¥çº¿ç¨‹ï¼Œå¹¶ä¸”åªæœ‰è¯¥çº¿ç¨‹å¯ä»¥é‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹æ— æ³•é‡Šæ”¾ï¼›</li><li>å½“åœ¨æŒæœ‰é”çš„çº¿ç¨‹ä¸­é€’å½’è·å–é”çš„æ—¶å€™ï¼Œå®é™…å¹¶ä¸ä¼šæ‰§è¡Œåº•å±‚çš„ <code>_lock.acquire()</code> æ–¹æ³•ï¼Œè€Œæ˜¯åªç»™è®¡æ•°å™¨é€’å¢ï¼›ä¸”é‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿæ˜¯å…ˆç»™è®¡æ•°å™¨é€’å‡ï¼Œç›´åˆ°ä¸º 0 åæ‰ä¼šé‡Šæ”¾é”ã€‚</li></ol><p>æ‰€ä»¥åœ¨ä½¿ç”¨ RLock çš„æ—¶å€™ä¸€å®šè¦è®°å¾— <code>acquire()</code> å’Œ <code>release()</code> çš„è°ƒç”¨æ¬¡æ•°å¾—åŒ¹é…æ‰èƒ½çœŸæ­£é‡Šæ”¾é”ã€‚æ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹æºç å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RLock</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _CRLock <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># æ¥ä¸‹æ¥é‡ç‚¹çœ‹ Python ç‰ˆæœ¬çš„ RLock å®ç°</span></span><br><span class="line">        <span class="keyword">return</span> _PyRLock(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> _CRLock(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RLock</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œæ˜¯çœŸæ­£çš„é”</span></span><br><span class="line">        self._block = _allocate_lock()</span><br><span class="line">        <span class="comment"># è®°å½•è°å¯¹è¯¥é”æœ‰æ‰€æœ‰æƒ</span></span><br><span class="line">        self._owner = <span class="keyword">None</span></span><br><span class="line">        <span class="comment"># è®°å½•è¯¥é”è¢«è·å–çš„æ¬¡æ•°ï¼Œç±»ä¼¼å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=True, timeout=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        me = get_ident()</span><br><span class="line">        <span class="keyword">if</span> self._owner == me:</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰æŒæœ‰é”çš„çº¿ç¨‹å°±æ˜¯å½“å‰éœ€è¦è·å¾—é”çš„çº¿ç¨‹ï¼Œè®¡æ•°å™¨é€’å¢å³å¯</span></span><br><span class="line">            self._count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        rc = self._block.acquire(blocking, timeout)</span><br><span class="line">        <span class="keyword">if</span> rc:</span><br><span class="line">            <span class="comment"># å¦‚æœæˆåŠŸè·å–åˆ°é”åï¼Œä¼šæŠŠæŒæœ‰é”çš„çº¿ç¨‹è®°å½•ä¸‹æ¥ï¼Œæ ‡è®°è¯¥çº¿ç¨‹æ˜¯æ‰€æœ‰æƒæ‹¥æœ‰è€…</span></span><br><span class="line">            self._owner = me</span><br><span class="line">            self._count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> rc</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._owner != get_ident():</span><br><span class="line">            <span class="comment"># æ˜¾è€Œæ˜“è§ï¼Œéæ‹¥æœ‰è€…ä¸èƒ½é‡Šæ”¾é”ï¼Œæƒ³éƒ½ä¸ç”¨æƒ³ï¼</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot release un-acquired lock"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿™é‡Œåªæ˜¯é€’å‡è®¡æ•°å™¨ï¼Œåªæœ‰_count å‡æ²¡äº†æ‰ä¼šçœŸæ­£é‡Šæ”¾</span></span><br><span class="line">        self._count = count = self._count - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> count:</span><br><span class="line">            self._owner = <span class="keyword">None</span></span><br><span class="line">            self._block.release()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸‹é¢çš„æ–¹æ³•æ˜¯ç”¨äºæ¡ä»¶å˜é‡å®ç°æ—¶ä½¿ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, state)</span>:</span></span><br><span class="line">        <span class="comment"># æ¢å¤é”çš„è·å–ï¼Œå¹¶ä¸”æ¢å¤åµŒå¥—å±‚æ¬¡</span></span><br><span class="line">        self._block.acquire()</span><br><span class="line">        self._count, self._owner = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># éœ€è¦ä¿è¯ä¸ç®¡æœ‰å¤šå°‘å±‚åµŒå¥—ï¼Œéƒ½èƒ½çœŸæ­£é‡Šæ”¾é”ï¼Œä½†åŒæ—¶è¿”å›å½“å‰çš„åµŒå¥—çŠ¶æ€ç­‰ä¿¡æ¯ä¾¿äºæ¢å¤</span></span><br><span class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot release un-acquired lock"</span>)</span><br><span class="line">        count = self._count</span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line">        owner = self._owner</span><br><span class="line">        self._owner = <span class="keyword">None</span></span><br><span class="line">        self._block.release()</span><br><span class="line">        <span class="keyword">return</span> (count, owner)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._owner == get_ident()</span><br></pre></td></tr></table></figure></p><h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>æ¡ä»¶å˜é‡æ˜¯åé¢å‡ ä¸ªåŒæ­¥åŸè¯­å®ç°çš„åŸºç¡€ï¼Œå€¼å¾—é‡ç‚¹å­¦ä¹ ä¸‹ã€‚æ¡ä»¶å˜é‡çš„å®ç°åŸç†æ¯”è¾ƒç®€å•ï¼šæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™ä¼šè¢«å”¤é†’ï¼ˆå¯ä»¥æƒ³æƒ³å¦‚ä½•å®ç° waiter çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’å‘¢ï¼Ÿï¼‰ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-b4516542d0e21eab291382ac3f8ed364_hd.png" alt=""></p><p>åœ¨åˆ†ææºç å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>Condition</code> ç±»æä¾›äº†å“ªäº›ä¸»è¦æ¥å£ï¼š</p><ul><li><code>wait(timeout=None)</code>ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£ç­‰å¾…è¢«å”¤é†’</li><li><code>notify()</code>ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨è¯¥æ¥å£é€šçŸ¥é˜Ÿåˆ—ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç­‰å¾…çº¿ç¨‹è¢«å”¤é†’</li></ul><p>æ¥ä¸‹æ¥çœ‹çœ‹æºç å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Condition</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, lock=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> lock <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            lock = RLock()</span><br><span class="line">        self._lock = lock</span><br><span class="line">        <span class="comment"># Export the lock's acquire() and release() methods</span></span><br><span class="line">        self.acquire = lock.acquire</span><br><span class="line">        self.release = lock.release</span><br><span class="line">        <span class="comment"># If the lock defines _release_save() and/or _acquire_restore(),</span></span><br><span class="line">        <span class="comment"># these override the default implementations (which just call</span></span><br><span class="line">        <span class="comment"># release() and acquire() on the lock). Ditto for _is_owned().</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._release_save = lock._release_save</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._acquire_restore = lock._acquire_restore</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._is_owned = lock._is_owned</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        self._waiters = _deque()</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release_save</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._lock.release() <span class="comment"># No state to save</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_acquire_restore</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self._lock.acquire() <span class="comment"># Ignore saved state</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_owned</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Return True if lock is owned by current_thread.</span></span><br><span class="line">        <span class="comment"># This method is called only if _lock doesn't have _is_owned().</span></span><br><span class="line">        <span class="keyword">if</span> self._lock.acquire(<span class="keyword">False</span>):</span><br><span class="line">            self._lock.release()</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot wait on un-acquired lock"</span>)</span><br><span class="line">        waiter = _allocate_lock()</span><br><span class="line">        waiter.acquire()</span><br><span class="line">        self._waiters.append(waiter)</span><br><span class="line">        saved_state = self._release_save()</span><br><span class="line">        gotit = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">try</span>: <span class="comment"># restore state no matter what (e.g., KeyboardInterrupt)</span></span><br><span class="line">            <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                waiter.acquire()</span><br><span class="line">                gotit = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> timeout &gt; <span class="number">0</span>:</span><br><span class="line">                    gotit = waiter.acquire(<span class="keyword">True</span>, timeout)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    gotit = waiter.acquire(<span class="keyword">False</span>)</span><br><span class="line">            <span class="keyword">return</span> gotit</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._acquire_restore(saved_state)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> gotit:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self._waiters.remove(waiter)</span><br><span class="line">                <span class="keyword">except</span> ValueError:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_for</span><span class="params">(self, predicate, timeout=None)</span>:</span></span><br><span class="line">        endtime = <span class="keyword">None</span></span><br><span class="line">        waittime = timeout</span><br><span class="line">        result = predicate()</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">if</span> waittime <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">if</span> endtime <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                    endtime = _time() + waittime</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    waittime = endtime - _time()</span><br><span class="line">                    <span class="keyword">if</span> waittime &lt;= <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            self.wait(waittime)</span><br><span class="line">            result = predicate()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_owned():</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"cannot notify on un-acquired lock"</span>)</span><br><span class="line">        all_waiters = self._waiters</span><br><span class="line">        waiters_to_notify = _deque(_islice(all_waiters, n))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> waiters_to_notify:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> waiter <span class="keyword">in</span> waiters_to_notify:</span><br><span class="line">            waiter.release()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                all_waiters.remove(waiter)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span>:</span></span><br><span class="line">    <span class="string">"""This class implements semaphore objects.</span></span><br><span class="line"><span class="string">    Semaphores manage a counter representing the number of release() calls minus</span></span><br><span class="line"><span class="string">    the number of acquire() calls, plus an initial value. The acquire() method</span></span><br><span class="line"><span class="string">    blocks if necessary until it can return without making the counter</span></span><br><span class="line"><span class="string">    negative. If not given, value defaults to 1.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># After Tim Peters' semaphore class, but not quite the same (no maximum)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"semaphore initial value must be &gt;= 0"</span>)</span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=True, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Acquire a semaphore, decrementing the internal counter by one.</span></span><br><span class="line"><span class="string">        When invoked without arguments: if the internal counter is larger than</span></span><br><span class="line"><span class="string">        zero on entry, decrement it by one and return immediately. If it is zero</span></span><br><span class="line"><span class="string">        on entry, block, waiting until some other thread has called release() to</span></span><br><span class="line"><span class="string">        make it larger than zero. This is done with proper interlocking so that</span></span><br><span class="line"><span class="string">        if multiple acquire() calls are blocked, release() will wake exactly one</span></span><br><span class="line"><span class="string">        of them up. The implementation may pick one at random, so the order in</span></span><br><span class="line"><span class="string">        which blocked threads are awakened should not be relied on. There is no</span></span><br><span class="line"><span class="string">        return value in this case.</span></span><br><span class="line"><span class="string">        When invoked with blocking set to true, do the same thing as when called</span></span><br><span class="line"><span class="string">        without arguments, and return true.</span></span><br><span class="line"><span class="string">        When invoked with blocking set to false, do not block. If a call without</span></span><br><span class="line"><span class="string">        an argument would block, return false immediately; otherwise, do the</span></span><br><span class="line"><span class="string">        same thing as when called without arguments, and return true.</span></span><br><span class="line"><span class="string">        When invoked with a timeout other than None, it will block for at</span></span><br><span class="line"><span class="string">        most timeout seconds. If acquire does not complete successfully in</span></span><br><span class="line"><span class="string">        that interval, return false. Return true otherwise.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> blocking <span class="keyword">and</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"can't specify timeout for non-blocking acquire"</span>)</span><br><span class="line">        rc = <span class="keyword">False</span></span><br><span class="line">        endtime = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">while</span> self._value == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> blocking:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    <span class="keyword">if</span> endtime <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                        endtime = _time() + timeout</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        timeout = endtime - _time()</span><br><span class="line">                        <span class="keyword">if</span> timeout &lt;= <span class="number">0</span>:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                self._cond.wait(timeout)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._value -= <span class="number">1</span></span><br><span class="line">                rc = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> rc</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""Release a semaphore, incrementing the internal counter by one or more.</span></span><br><span class="line"><span class="string">        When the counter is zero on entry and another thread is waiting for it</span></span><br><span class="line"><span class="string">        to become larger than zero again, wake up that thread.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'n must be one or more'</span>)</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._value += n</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">                self._cond.notify()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedSemaphore</span><span class="params">(Semaphore)</span>:</span></span><br><span class="line">    <span class="string">"""Implements a bounded semaphore.</span></span><br><span class="line"><span class="string">    A bounded semaphore checks to make sure its current value doesn't exceed its</span></span><br><span class="line"><span class="string">    initial value. If it does, ValueError is raised. In most situations</span></span><br><span class="line"><span class="string">    semaphores are used to guard resources with limited capacity.</span></span><br><span class="line"><span class="string">    If the semaphore is released too many times it's a sign of a bug. If not</span></span><br><span class="line"><span class="string">    given, value defaults to 1.</span></span><br><span class="line"><span class="string">    Like regular semaphores, bounded semaphores manage a counter representing</span></span><br><span class="line"><span class="string">    the number of release() calls minus the number of acquire() calls, plus an</span></span><br><span class="line"><span class="string">    initial value. The acquire() method blocks if necessary until it can return</span></span><br><span class="line"><span class="string">    without making the counter negative. If not given, value defaults to 1.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value=<span class="number">1</span>)</span>:</span></span><br><span class="line">        Semaphore.__init__(self, value)</span><br><span class="line">        self._initial_value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self, n=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""Release a semaphore, incrementing the internal counter by one or more.</span></span><br><span class="line"><span class="string">        When the counter is zero on entry and another thread is waiting for it</span></span><br><span class="line"><span class="string">        to become larger than zero again, wake up that thread.</span></span><br><span class="line"><span class="string">        If the number of releases exceeds the number of acquires,</span></span><br><span class="line"><span class="string">        raise a ValueError.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'n must be one or more'</span>)</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">if</span> self._value + n &gt; self._initial_value:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"Semaphore released too many times"</span>)</span><br><span class="line">            self._value += n</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">                self._cond.notify()</span><br></pre></td></tr></table></figure><h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></span><br><span class="line">    <span class="string">"""Class implementing event objects.</span></span><br><span class="line"><span class="string">    Events manage a flag that can be set to true with the set() method and reset</span></span><br><span class="line"><span class="string">    to false with the clear() method. The wait() method blocks until the flag is</span></span><br><span class="line"><span class="string">    true. The flag is initially false.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># After Tim Peters' event class (without is_posted())</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._flag = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reset_internal_locks</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># private! called by Thread._reset_internal_locks by _after_fork()</span></span><br><span class="line">        self._cond.__init__(Lock())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_set</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return true if and only if the internal flag is true."""</span></span><br><span class="line">        <span class="keyword">return</span> self._flag</span><br><span class="line"></span><br><span class="line">    isSet = is_set</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Set the internal flag to true.</span></span><br><span class="line"><span class="string">        All threads waiting for it to become true are awakened. Threads</span></span><br><span class="line"><span class="string">        that call wait() once the flag is true will not block at all.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._flag = <span class="keyword">True</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Reset the internal flag to false.</span></span><br><span class="line"><span class="string">        Subsequently, threads calling wait() will block until set() is called to</span></span><br><span class="line"><span class="string">        set the internal flag to true again.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._flag = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Block until the internal flag is true.</span></span><br><span class="line"><span class="string">        If the internal flag is true on entry, return immediately. Otherwise,</span></span><br><span class="line"><span class="string">        block until another thread calls set() to set the flag to true, or until</span></span><br><span class="line"><span class="string">        the optional timeout occurs.</span></span><br><span class="line"><span class="string">        When the timeout argument is present and not None, it should be a</span></span><br><span class="line"><span class="string">        floating point number specifying a timeout for the operation in seconds</span></span><br><span class="line"><span class="string">        (or fractions thereof).</span></span><br><span class="line"><span class="string">        This method returns the internal flag on exit, so it will always return</span></span><br><span class="line"><span class="string">        True except if a timeout is given and the operation times out.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            signaled = self._flag</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> signaled:</span><br><span class="line">                signaled = self._cond.wait(timeout)</span><br><span class="line">            <span class="keyword">return</span> signaled</span><br></pre></td></tr></table></figure><h3 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h3><p>é€šå¸¸å¯ä»¥ä½¿ç”¨ Barrier å®ç°å¹¶å‘åˆå§‹åŒ–ï¼Œç„¶åä¸€åˆ‡å°±ç»ªåæ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚åº”ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> get_ident <span class="keyword">as</span> get_ident</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Barrier, Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signal_prepared</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"All are ready"</span>)</span><br><span class="line"></span><br><span class="line">barrier = Barrier(parties=<span class="number">4</span>, action=signal_prepared)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    Thread(target=load_disk_files).start()</span><br><span class="line">    Thread(target=make_cache).start()</span><br><span class="line">    Thread(target=init_db_pool).start()</span><br><span class="line">    print(<span class="string">"I'm ready, wait for other workers"</span>)</span><br><span class="line">    barrier.wait()</span><br><span class="line">    print(<span class="string">"Time to start our server"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_disk_files</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] load_disk_files"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_cache</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] make cache"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db_pool</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">u"[&#123;&#125;] init db pool"</span>.format(get_ident()))</span><br><span class="line">    barrier.wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œæ•ˆæœï¼š<br><img src="https://pic3.zhimg.com/80/v2-976ddfaeddc70d04ee29843cfd125713_hd.png" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ Barrier æ˜¯å¦‚ä½•å®ç°çš„ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Barrier æ˜¯åŸºäºéƒ¨åˆ†çš„ `pthread_barrier_*` API å’Œ Java ä¸­çš„ `CyclicBarrier`</span></span><br><span class="line"><span class="comment"># å‚è€ƒï¼š</span></span><br><span class="line"><span class="comment"># 1. http://sourceware.org/pthreads-win32/manual/pthread_barrier_init.html and</span></span><br><span class="line"><span class="comment"># 2. http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/CyclicBarrier.html</span></span><br><span class="line"><span class="comment"># åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸¤ç§ä¸»è¦çš„çŠ¶æ€ï¼š`filling` å’Œ `draining`ï¼Œä»è€Œè®©å±éšœå˜æˆå¯å¾ªç¯ä½¿ç”¨çš„ã€‚</span></span><br><span class="line"><span class="comment"># åªæœ‰ä¸Šä¸€ä¸ªå‘¨æœŸå®Œå…¨æ’æ°´ï¼ˆ`drained`ï¼‰å®Œæ¯•æ‰å¯ä»¥å…è®¸æ–°çš„çº¿ç¨‹è¿›å…¥ï¼ˆå¯¹æ¯”ä¸‹æ¼æ¡¶é™æµç®—æ³•ï¼‰</span></span><br><span class="line"><span class="comment"># æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æä¾›äº† `resetting` çŠ¶æ€ï¼Œå®ƒç±»ä¼¼äº `draining`ï¼Œä½†æ˜¯ä¼šè®©çº¿ç¨‹ç¦»å¼€çš„æ—¶å€™æŠ›å‡º `BrokeBarrierError`</span></span><br><span class="line"><span class="comment"># `broken` çŠ¶æ€è¡¨ç¤ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½äº§ç”Ÿäº†å¼‚å¸¸</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Barrier</span>:</span></span><br><span class="line">    <span class="string">"""I</span></span><br><span class="line"><span class="string">    æˆ‘ä»¬é€šå¸¸å¯ä»¥ä½¿ç”¨å±éšœè®©å¤šä¸ªçº¿ç¨‹åœ¨ç›¸åŒçš„åŒæ­¥ç‚¹åŒæ­¥å¼€å§‹ï¼ˆå¯ä»¥æƒ³è±¡ä¸‹æœ‰ä¸ªæ°´ç¼¸ï¼Œæ°´ä¸æ–­åœ°æµè¿›æ¥</span></span><br><span class="line"><span class="string">    ä½†æ˜¯ä¼šåœ¨æŸä¸ªç‚¹ä¸€èµ·æ”¾å¼€ï¼Œå½¢æˆæ´ªæµ...ï¼‰ã€‚æ‰€æœ‰è°ƒç”¨äº† `wait()` çš„çº¿ç¨‹ä¼šåœ¨æ¡ä»¶æ»¡è¶³æ—¶å‡ ä¹åŒæ—¶è¢«å”¤é†’ï¼Œ</span></span><br><span class="line"><span class="string">    ç„¶åå¤§å®¶å°±å¯ä»¥ä¸€èµ·å¿«ä¹åœ°å¹²æ´»äº†ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, parties, action=None, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Create a barrier, initialised to 'parties' threads.</span></span><br><span class="line"><span class="string">        'action' is a callable which, when supplied, will be called by one of</span></span><br><span class="line"><span class="string">        the threads after they have all entered the barrier and just prior to</span></span><br><span class="line"><span class="string">        releasing them all. If a 'timeout' is provided, it is used as the</span></span><br><span class="line"><span class="string">        default for all subsequent 'wait()' calls.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._cond = Condition(Lock())</span><br><span class="line">        self._action = action</span><br><span class="line">        self._timeout = timeout</span><br><span class="line">        self._parties = parties</span><br><span class="line">        self._state = <span class="number">0</span> <span class="comment">#0 filling, 1, draining, -1 resetting, -2 broken</span></span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self, timeout=None)</span>:</span></span><br><span class="line">        <span class="string">"""Wait for the barrier.</span></span><br><span class="line"><span class="string">        When the specified number of threads have started waiting, they are all</span></span><br><span class="line"><span class="string">        simultaneously awoken. If an 'action' was provided for the barrier, one</span></span><br><span class="line"><span class="string">        of the threads will have executed that callback prior to returning.</span></span><br><span class="line"><span class="string">        Returns an individual index number from 0 to 'parties-1'.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            timeout = self._timeout</span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._enter() <span class="comment"># Block while the barrier drains.</span></span><br><span class="line">            index = self._count</span><br><span class="line">            self._count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> index + <span class="number">1</span> == self._parties:</span><br><span class="line">                    <span class="comment"># We release the barrier</span></span><br><span class="line">                    self._release()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># We wait until someone releases us</span></span><br><span class="line">                    self._wait(timeout)</span><br><span class="line">                <span class="keyword">return</span> index</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self._count -= <span class="number">1</span></span><br><span class="line">                <span class="comment"># Wake up any threads waiting for barrier to drain.</span></span><br><span class="line">                self._exit()</span><br><span class="line">    <span class="comment"># Block until the barrier is ready for us, or raise an exception</span></span><br><span class="line">    <span class="comment"># if it is broken.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_enter</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> self._state <span class="keyword">in</span> (<span class="number">-1</span>, <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># It is draining or resetting, wait until done</span></span><br><span class="line">            self._cond.wait()</span><br><span class="line">        <span class="comment">#see if the barrier is in a broken state</span></span><br><span class="line">        <span class="keyword">if</span> self._state &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">assert</span> self._state == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optionally run the 'action' and release the threads waiting</span></span><br><span class="line">    <span class="comment"># in the barrier.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_release</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self._action:</span><br><span class="line">                self._action()</span><br><span class="line">            <span class="comment"># enter draining state</span></span><br><span class="line">            self._state = <span class="number">1</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment">#an exception during the _action handler. Break and reraise</span></span><br><span class="line">            self._break()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Wait in the barrier until we are released. Raise an exception</span></span><br><span class="line">    <span class="comment"># if the barrier is reset or broken.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_wait</span><span class="params">(self, timeout)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._cond.wait_for(<span class="keyword">lambda</span> : self._state != <span class="number">0</span>, timeout):</span><br><span class="line">            <span class="comment">#timed out. Break the barrier</span></span><br><span class="line">            self._break()</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">if</span> self._state &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> BrokenBarrierError</span><br><span class="line">        <span class="keyword">assert</span> self._state == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we are the last thread to exit the barrier, signal any threads</span></span><br><span class="line">    <span class="comment"># waiting for the barrier to drain.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_exit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._count == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> self._state <span class="keyword">in</span> (<span class="number">-1</span>, <span class="number">1</span>):</span><br><span class="line">                <span class="comment">#resetting or draining</span></span><br><span class="line">                self._state = <span class="number">0</span></span><br><span class="line">                self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Reset the barrier to the initial state.</span></span><br><span class="line"><span class="string">        Any threads currently waiting will get the BrokenBarrier exception</span></span><br><span class="line"><span class="string">        raised.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            <span class="keyword">if</span> self._count &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> self._state == <span class="number">0</span>:</span><br><span class="line">                    <span class="comment">#reset the barrier, waking up threads</span></span><br><span class="line">                    self._state = <span class="number">-1</span></span><br><span class="line">                <span class="keyword">elif</span> self._state == <span class="number">-2</span>:</span><br><span class="line">                    <span class="comment">#was broken, set it to reset state</span></span><br><span class="line">                    <span class="comment">#which clears when the last thread exits</span></span><br><span class="line">                    self._state = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._state = <span class="number">0</span></span><br><span class="line">            self._cond.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">abort</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Place the barrier into a 'broken' state.</span></span><br><span class="line"><span class="string">        Useful in case of error. Any currently waiting threads and threads</span></span><br><span class="line"><span class="string">        attempting to 'wait()' will have BrokenBarrierError raised.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">with</span> self._cond:</span><br><span class="line">            self._break()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_break</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># An internal error was detected. The barrier is set to</span></span><br><span class="line">        <span class="comment"># a broken state all parties awakened.</span></span><br><span class="line">        self._state = <span class="number">-2</span></span><br><span class="line">        self._cond.notify_all()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parties</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the number of threads required to trip the barrier."""</span></span><br><span class="line">        <span class="keyword">return</span> self._parties</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">n_waiting</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return the number of threads currently waiting at the barrier."""</span></span><br><span class="line">        <span class="comment"># We don't need synchronization here since this is an ephemeral result</span></span><br><span class="line">        <span class="comment"># anyway. It returns the correct value in the steady state.</span></span><br><span class="line">        <span class="keyword">if</span> self._state == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> self._count</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">broken</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Return True if the barrier is in a broken state."""</span></span><br><span class="line">        <span class="keyword">return</span> self._state == <span class="number">-2</span></span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>Python æºç çš„æ³¨é‡Šå¤ªä¸°å¯Œäº†ï¼Œä»¥è‡³äºæˆ‘éƒ½ä¸æƒ³ç¿»è¯‘æˆä¸­æ–‡ã€‚æ‰€ä»¥ç»“åˆæ³¨é‡Šçœ‹ä»£ç å³å¯~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;è™½ç„¶è¯´ Python å—é™äº CPython çš„å®ç°ï¼Œå­˜åœ¨çš„ GIL ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œæ²¡æ³•åˆ©ç”¨å¤šæ ¸è·‘å¤šçº¿ç¨‹ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™è¿˜æ˜¯ä¼š
      
    
    </summary>
    
      <category term="Python" scheme="http://ifaceless.space/categories/Python/"/>
    
    
      <category term="Python" scheme="http://ifaceless.space/tags/Python/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://ifaceless.space/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="æºç å­¦ä¹ " scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>é™æµç®—æ³•å­¦ä¹ ï¼šæ¼æ¡¶ &amp; ä»¤ç‰Œæ¡¶ç®—æ³•</title>
    <link href="http://ifaceless.space/2019/11/20/rate-limit-policies/"/>
    <id>http://ifaceless.space/2019/11/20/rate-limit-policies/</id>
    <published>2019-11-20T13:20:11.000Z</published>
    <updated>2019-11-24T09:45:59.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ¬èŠ‚ä¸»è¦å­¦ä¹ ä¸‹ä¸¤ç§å¸¸ç”¨çš„å•æœºé™æµæ€æƒ³ï¼Œåˆ†åˆ«æ˜¯<strong>æ¼æ¡¶ç®—æ³•</strong>å’Œ<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>ã€‚æ­¤å¤–ï¼Œè¿˜å°†ç»™å‡ºä½¿ç”¨ Python åŠ Go è¯­è¨€å®ç°ï¼Œä¾¿äºåŠ æ·±ç†è§£ã€‚å½“ç„¶ï¼Œç°å®ä¸­è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ä¸‹é¢çš„ä»£ç ã€‚å®é™…åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨å•æœºæ‰§è¡Œé™æµï¼Œä¸‹é¢çš„å®ç°ä¹Ÿå¹¶éçº¿ç¨‹æˆ– goroutine å®‰å…¨çš„ã€‚</p><p>å®é™…é™æµå¯ä»¥è€ƒè™‘åœ¨ Nginx å±‚å¯¹è¯·æ±‚é™æµï¼Œæˆ–è€…å¦‚æœçœŸçš„è¦è‡ªå·±åœ¨ä¸šåŠ¡æ–¹å®ç°ä¸€å¥—é™æµç­–ç•¥çš„è¯ï¼Œå¯ä»¥è€ƒè™‘åŸºäº Redis å®ç°åˆ†å¸ƒå¼é™æµç­–ç•¥ã€‚å¹¶ä¸”åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½è¿˜ä¼šåŸºäºä¸åŒçš„ç»´åº¦è¿›è¡Œé™æµï¼Œå¦‚ç”¨æˆ· idï¼Œè¯·æ±‚ IP ç­‰ï¼Œå®é™…åº”ç”¨éœ€è¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šã€‚</p><h1 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h1><p>å¯ä»¥æŠŠè¯·æ±‚å½“ä½œæ°´æµï¼Œæ°´æµå…¨éƒ¨è¿›å…¥æœ‰é™å¤§å°çš„æ°´ç¼¸ï¼ŒåŒæ—¶æ°´ç¼¸ä¼šæŒ‰ç…§å›ºå®šçš„é€Ÿç‡æ¼æ°´ã€‚å½“æ°´æµæ¹æ€¥ï¼Œæ°´ç¼¸æ¼æ°´å¤ªæ…¢çš„è¯ï¼Œä¼šå¾—çŸ¥æ°´ç¼¸ç§¯æ°´ï¼Œç›´åˆ°æº¢å‡ºï¼ˆæ­¤æ—¶æ‹’ç»æœåŠ¡ï¼‰ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-bdf9f813d2f9d8622174e9e58be308b6_hd.png" alt=""></p><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol><li>å®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»¥æ¯”è¾ƒæ’å®šçš„é€Ÿç‡æœåŠ¡è¯·æ±‚</li><li>ç¼ºç‚¹æ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æº¢å‡º</li></ol><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeakyBucketRateLimiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity=<span class="number">10</span>, leak_rate=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–æ¼æ¡¶</span></span><br><span class="line"><span class="string">        :param capacity: æ¡¶å®¹é‡</span></span><br><span class="line"><span class="string">        :param leak_rate: æ’å®šçš„æ¶ˆè´¹é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._capacity = float(capacity)</span><br><span class="line">        self._leak_rate = float(leak_rate)</span><br><span class="line">        self._water_level = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´</span></span><br><span class="line">        self._last_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, level=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="comment"># æ‰§è¡Œæ¼æ°´</span></span><br><span class="line">        now = time.time()</span><br><span class="line">        delta = self._water_level - self._leak_rate * (now - self._last_time)</span><br><span class="line">        self._water_level = min(<span class="number">0.0</span>, delta)</span><br><span class="line">        self._last_time = now</span><br><span class="line">        <span class="comment"># å°è¯•åŠ æ°´ï¼Œå¹¶çœ‹æ°´æ¡¶æ˜¯å¦æ»¡äº†</span></span><br><span class="line">        <span class="keyword">if</span> level + self._water_level &gt; self._capacity:</span><br><span class="line">            <span class="keyword">raise</span> RateLimitExceeded()</span><br><span class="line">        self._water_level += level</span><br></pre></td></tr></table></figure><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LeakyBucketRateLimiter <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    currentLevel <span class="keyword">int</span></span><br><span class="line">    leakRate <span class="keyword">int</span> <span class="comment">// consume how many requests per sec</span></span><br><span class="line">    lastLeakedAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLeakyBucketRateLimitter</span><span class="params">(capacity, leakRate <span class="keyword">int</span>)</span> *<span class="title">LeakyBucketRateLimiter</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;LeakyBucketRateLimiter&#123;</span><br><span class="line">        capacity: capacity,</span><br><span class="line">        currentLevel: <span class="number">0</span>,</span><br><span class="line">        leakRate: leakRate,</span><br><span class="line">        lastLeakedAt: time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *LeakyBucketRateLimiter)</span> <span class="title">Acquire</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    now := time.Now()</span><br><span class="line">    <span class="comment">// leak water</span></span><br><span class="line">    currentLevel := r.currentLevel - r.leakRate*<span class="keyword">int</span>(now.Sub(r.lastLeakedAt).Seconds())</span><br><span class="line">    r.currentLevel = max(currentLevel, <span class="number">0</span>)</span><br><span class="line">    r.lastLeakedAt = now</span><br><span class="line">    <span class="comment">// try to add water, test bucket is full or not.</span></span><br><span class="line">    currentLevel = n + r.currentLevel</span><br><span class="line">    <span class="keyword">if</span> currentLevel &gt; r.capacity &#123;</span><br><span class="line">        <span class="keyword">return</span> errRateLimitExceeds</span><br><span class="line">    &#125;</span><br><span class="line">    r.currentLevel = currentLevel</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h1><p>åŒæ ·æƒ³è±¡æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¡¶ï¼Œä¸“é—¨å­˜æ”¾ä»¤ç‰Œï¼Œä¼šä»¥æ’å®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå¹¶å°†å…¶æ”¾å…¥æ¡¶ä¸­ã€‚æ¯å½“æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œéœ€è¦å…ˆä»æ¡¶ä¸­å–åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»¤ç‰Œï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¦åˆ™æ‹’ç»æœåŠ¡ã€‚</p><p><img src="https://pic3.zhimg.com/80/v2-f2b510a893be6ff316bbde684b70c2e2_hd.png" alt=""></p><h2 id="ç‰¹ç‚¹-1"><a href="#ç‰¹ç‚¹-1" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol><li>å®ç°åŒæ ·æ˜¯å¾ˆç®€å•</li><li>å¯ä»¥åº”å¯¹çªå‘æµé‡ï¼Œé¢å¯¹ç¬é—´å¤§æµé‡ï¼Œå¯ä»¥åœ¨çŸ­æ—¶é—´å†…è·å¾—å¤§é‡ä»¤ç‰Œï¼Œä¸”ç”Ÿäº§ä»¤ç‰Œæ¯«ä¸è´¹åŠ›</li><li>å¯ä»¥åšæµé‡æ•´å½¢</li></ol><h2 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenBucketRateLimiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity=<span class="number">1</span>, fill_rate=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–ä»¤ç‰Œæ¡¶é™æµå™¨</span></span><br><span class="line"><span class="string">        :param capacity: ä»¤ç‰Œæ¡¶å®¹é‡</span></span><br><span class="line"><span class="string">        :param fill_rate: æ”¾å…¥ä»¤ç‰Œçš„é€Ÿåº¦ï¼ˆReqs/ç§’ï¼‰</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._capacity = float(capacity)</span><br><span class="line">        self._rate = float(fill_rate)</span><br><span class="line">        self._bucket_tokens = float(capacity)</span><br><span class="line">        <span class="comment"># ä¸Šæ¬¡æ·»åŠ ä»¤ç‰Œçš„æ—¶é—´</span></span><br><span class="line">        self._last_time = int(time.time())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, tokens=<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="comment"># å‘æ”¾ä»¤ç‰Œ</span></span><br><span class="line">        <span class="keyword">if</span> self._bucket_tokens &lt; self._capacity:</span><br><span class="line">            now = time.time()</span><br><span class="line">            delta = (now - self._last_time) * self._rate</span><br><span class="line">            self._last_time = now</span><br><span class="line">            self._bucket_tokens = min(self._capacity, self._bucket_tokens + delta)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tokens &gt; self._bucket_tokens:</span><br><span class="line">            <span class="comment"># æ— æ³•è·å–ä»¤ç‰Œäº†ï¼Œæ•°é‡ä¸å¤Ÿ</span></span><br><span class="line">            <span class="keyword">raise</span> RateLimitExceeded()</span><br><span class="line">        self._bucket_tokens -= tokens</span><br></pre></td></tr></table></figure><h3 id="Go-1"><a href="#Go-1" class="headerlink" title="Go"></a>Go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TokenBucketRateLimiter <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    tokens <span class="keyword">int</span></span><br><span class="line">    putRate <span class="keyword">int</span> <span class="comment">// put how many tokens per sec</span></span><br><span class="line">    lastPutAt time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTokenBucketRateLimiter</span><span class="params">(capacity, fillRate <span class="keyword">int</span>)</span> *<span class="title">TokenBucketRateLimiter</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;TokenBucketRateLimiter&#123;</span><br><span class="line">        capacity: capacity,</span><br><span class="line">        tokens: <span class="number">0</span>,</span><br><span class="line">        putRate: fillRate,</span><br><span class="line">        lastPutAt: time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *TokenBucketRateLimiter)</span> <span class="title">Acquire</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r.tokens &lt; r.capacity &#123;</span><br><span class="line">        <span class="comment">// put tokens in the bucket</span></span><br><span class="line">        now := time.Now()</span><br><span class="line">        howMany := r.putRate * <span class="keyword">int</span>(now.Sub(r.lastPutAt).Seconds())</span><br><span class="line">        r.tokens = min(r.capacity, howMany+r.tokens)</span><br><span class="line">        r.lastPutAt = now</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check if we have enough tokens</span></span><br><span class="line">    <span class="keyword">if</span> r.tokens &lt; n &#123;</span><br><span class="line">        <span class="keyword">return</span> errRateLimitExceeds</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// release tokens</span></span><br><span class="line">    r.tokens -= n</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://segmentfault.com/a/1190000015967922" target="_blank" rel="noopener">æ¥å£é™æµç®—æ³•ä»‹ç»</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ¬èŠ‚ä¸»è¦å­¦ä¹ ä¸‹ä¸¤ç§å¸¸ç”¨çš„å•æœºé™æµæ€æƒ³ï¼Œåˆ†åˆ«æ˜¯&lt;strong&gt;æ¼æ¡¶ç®—æ³•&lt;/strong&gt;å’Œ&lt;strong&gt;ä»¤ç‰Œæ¡¶ç®—æ³•&lt;/strong&gt;ã€‚æ­¤å¤–ï¼Œ
      
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/tags/Web-%E5%BC%80%E5%8F%91/"/>
    
      <category term="é™æµ" scheme="http://ifaceless.space/tags/%E9%99%90%E6%B5%81/"/>
    
  </entry>
  
  <entry>
    <title>Linux è°ƒåº¦å™¨å­¦ä¹ èµ„æ–™æ•´ç†</title>
    <link href="http://ifaceless.space/2019/11/18/linux-kernel-scheduler-papers/"/>
    <id>http://ifaceless.space/2019/11/18/linux-kernel-scheduler-papers/</id>
    <published>2019-11-18T13:18:35.000Z</published>
    <updated>2019-11-24T09:45:59.961Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f23_hd.png" alt=""></p><p>ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚</p><p>ä¸€ç›´ä»¥æ¥ï¼Œå„è·¯ Linux Hackers éƒ½å¸Œæœ›èƒ½ä¸º Linux æä¾›è¿™æ ·ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ¡Œé¢ç³»ç»Ÿä¸Šæœ‰è¾ƒå¥½çš„äº¤äº’æ€§ï¼Œè€Œåœ¨é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šæœ‰è¾ƒå¥½çš„ååé‡ã€‚</p><p>ä»¥ä¸‹åˆ—ä¸¾ä¸€äº›å­¦ä¹ èµ„æ–™ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£ï¼</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li>è®ºæ–‡ï¼š<a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a>ï¼Œè¿™ç¯‡è®ºæ–‡è®²å¾—æ¯”è¾ƒå¥½ï¼Œå‡†å¤‡ç¿»è¯‘å‡ºæ¥ä»¥ä¾›æ¬£èµ</li><li>GitBook: <a href="https://oska874.gitbooks.io/process-scheduling-in-linux/chapter1.html" target="_blank" rel="noopener">Process Scheduling in Linux</a></li><li>å†…æ ¸æ–‡æ¡£ï¼š<a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux scheduler doc, CFS</a></li><li><p>Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹</p><ul><li>å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</li><li>Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„</li></ul></li><li><p><a href="https://opensource.com/article/19/2/fair-scheduling-linux" target="_blank" rel="noopener">Linux å…¬å¹³è°ƒåº¦</a></p></li><li><p><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" target="_blank" rel="noopener">The Battle of Schedulers: FreeBSD ULE vs Linux CFS</a></p><ul><li>é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ†</li><li>å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ</li></ul></li><li><p><a href="https://zhuanlan.zhihu.com/p/33621500" target="_blank" rel="noopener">NUMA æ¶æ„æ·±ç©¶</a></p><ul><li>æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„</li><li>NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³»</li></ul></li><li><p><a href="https://jin-yang.github.io/post/linux-kernel-scheduler.html" target="_blank" rel="noopener">Kernel è°ƒåº¦ç³»ç»Ÿ</a></p><ul><li>é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—®</li><li>vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ</li><li>vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f2
      
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://ifaceless.space/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="CFS" scheme="http://ifaceless.space/tags/CFS/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Go è¯­è¨€å®ç°ä¸€ä¸ªç®€å•çš„ LRU Cache</title>
    <link href="http://ifaceless.space/2019/11/15/implement-lru-cache-in-go/"/>
    <id>http://ifaceless.space/2019/11/15/implement-lru-cache-in-go/</id>
    <published>2019-11-15T13:28:32.000Z</published>
    <updated>2019-11-24T09:45:59.949Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>LRU (Least-Recently-Used) Cache æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥å°†ä¸€äº›çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿›è€Œæé«˜æ¥å£çš„å“åº”é€Ÿåº¦ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œcache miss åï¼Œå®é™…å¯èƒ½ä¼šå›æºåˆ° Redis é›†ç¾¤è·å–ç¼“å­˜æ•°æ®ï¼Œå¦‚æœ Redis é›†ç¾¤ä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå›æºæ•°æ®åº“ã€‚ä¹Ÿå°±æ˜¯å¼•å…¥ LRU Cache åç›¸å½“äºç»™åº”ç”¨å±‚æ·»åŠ äº†ä¸€çº§é«˜é€Ÿç¼“å­˜ã€‚å½“ç„¶ï¼Œæ›´ä¸ºå®é™…ä¸€ç‚¹çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„ LRU Cacheï¼Œå¦åˆ™åå°æ›´æ–°äº†è¯¾ç¨‹æ•°æ®ï¼Œç”±äºå†…å­˜ç¼“å­˜çš„åŸå› è€Œå¾—ä¸åˆ°åŠæ—¶æ›´æ–°ã€‚</p><p>æœ¬èŠ‚ä¸»è¦æ˜¯å­¦ä¹ ä¸‹ LRU Cache å®ç°åŸç†ï¼Œåªæ¢è®¨æœ€æ ¸å¿ƒçš„å®ç°æ€æƒ³ï¼Œä¸è€ƒè™‘å¤æ‚çš„æƒ…å†µï¼ˆå¦‚ goroutine å®‰å…¨ï¼Œç¼“å­˜å¸¦è¿‡æœŸæ—¶é—´ç­‰ï¼‰ã€‚</p><h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><p>LRU Cache æä¾›çš„åŠŸèƒ½æœ‰ä¸¤ä¸ªï¼š</p><ol><li>é¡¾åæ€ä¹‰ï¼Œç¼“å­˜èƒ½åŠ›</li><li>å½“ç¼“å­˜ç©ºé—´æ»¡äº†åï¼Œä¼šå°†æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹åˆ é™¤æ‰ï¼Œä»è€Œä¸ºæ–°çš„ key/value æä¾›ç¼“å­˜ç©ºé—´</li></ol><p>å…·ä½“å®ç°çš„æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>éœ€è¦ä½¿ç”¨ä¸€ä¸ª map ç»´æŠ¤ key -&gt; entry node çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œèƒ½å¤ŸåŸºäºæ­¤å¿«é€Ÿæ‰¾åˆ°ç›¸å…³çš„èŠ‚ç‚¹ï¼›</li><li>éœ€è¦ä½¿ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥ç»´æŠ¤ entry nodeï¼›</li><li><code>cache.set</code> æ—¶ï¼Œéœ€è¦é¦–å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦è¶…å‡ºç•Œé™äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œéœ€è¦å°†é“¾è¡¨å°¾å·´ï¼ˆå³æœ€å°‘è®¿é—®çš„èŠ‚ç‚¹ï¼‰ç§»é™¤ï¼›ç„¶åå°†æ–°çš„èŠ‚ç‚¹æ’å…¥åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¹¶åœ¨ map ä¸­åˆ·æ–° key å¯¹åº”çš„ entry node æŒ‡é’ˆï¼›</li><li><code>cache.get</code> æ—¶ï¼Œå¦‚æœ hit åˆ°ç¼“å­˜äº†ï¼Œåˆ™å°†å¯¹åº”çš„ entry node è°ƒæ•´åœ¨é“¾è¡¨å¤´éƒ¨ï¼Œä¿è¯æœ€é¢‘ç¹çš„èŠ‚ç‚¹å§‹ç»ˆå¾€å‰é ã€‚</li></ol><h1 id="åŠ¨æ‰‹å®ç°"><a href="#åŠ¨æ‰‹å®ç°" class="headerlink" title="åŠ¨æ‰‹å®ç°"></a>åŠ¨æ‰‹å®ç°</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package lrucache implements a cache with limited capacity, which evicts</span></span><br><span class="line"><span class="comment">// least-used-entry when it overflows.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Caution: not production ready, not goroutine safe.</span></span><br><span class="line"><span class="keyword">package</span> lrucache</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"path/to/bit/zerzura/log"</span></span><br><span class="line">    <span class="string">"path/to/bit/zerzura/datastructures/list"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    defaultCapacity = <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LRUCache <span class="keyword">struct</span> &#123;</span><br><span class="line">    capacity <span class="keyword">int</span></span><br><span class="line">    cache <span class="keyword">map</span>[<span class="keyword">string</span>]*list.Node</span><br><span class="line">    list *list.List</span><br><span class="line">    stats *Stats</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(cache *LRUCache)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Capacity</span><span class="params">(<span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(cache *LRUCache)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">cap</span> &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">cap</span> = defaultCapacity</span><br><span class="line">        &#125;</span><br><span class="line">        cache.capacity = <span class="built_in">cap</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ...Option)</span> *<span class="title">LRUCache</span></span> &#123;</span><br><span class="line">    cache := &amp;LRUCache&#123;</span><br><span class="line">        capacity: defaultCapacity,</span><br><span class="line">        cache: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*list.Node, defaultCapacity),</span><br><span class="line">        list: list.New(),</span><br><span class="line">        stats: &amp;Stats&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">        opt(cache)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"LRUCache(cap=%d, len=%d, hits=%d, misses=%d)"</span>, lru.capacity, lru.Len(), lru.stats.hits, lru.stats.misses)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lru.capacity</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(lru.cache)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Set</span><span class="params">(key <span class="keyword">string</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    log.Debugf(<span class="string">"lru.set (%s, %v)"</span>, key, value)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(lru.cache) &gt;= lru.capacity &#123;</span><br><span class="line">        node := lru.list.Tail()</span><br><span class="line">        <span class="keyword">if</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">            entry := node.Value.(*entry)</span><br><span class="line">            log.Infof(<span class="string">"[lru.set] evict entry %v"</span>, entry)</span><br><span class="line">            <span class="built_in">delete</span>(lru.cache, entry.key)</span><br><span class="line">            lru.list.RemoveNode(node)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(<span class="string">"unexpected state, node is nil, that's impossible"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    node, ok := lru.cache[key]</span><br><span class="line">    <span class="keyword">if</span> ok &amp;&amp; node != <span class="literal">nil</span> &#123;</span><br><span class="line">        lru.list.RemoveNode(node)</span><br><span class="line">    &#125;</span><br><span class="line">    lru.cache[key] = lru.list.Insert(</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;entry&#123;key: key, value: value&#125;,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lru *LRUCache)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    node, ok := lru.cache[key]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        log.Infof(<span class="string">"[lru.get] cache misses for key %s"</span>, key)</span><br><span class="line">        lru.stats.miss()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    entry := node.Value.(*entry)</span><br><span class="line">    entry.hits++</span><br><span class="line">    lru.list.RemoveNode(node)</span><br><span class="line">    lru.cache[key] = lru.list.Insert(<span class="number">0</span>, entry)</span><br><span class="line">    lru.stats.hit()</span><br><span class="line">    log.Debugf(<span class="string">"[lru.get] cache hits, got entry %v."</span>, entry)</span><br><span class="line">    <span class="keyword">return</span> entry.value, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Stats <span class="keyword">struct</span> &#123;</span><br><span class="line">    hits <span class="keyword">int</span></span><br><span class="line">    misses <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">hit</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.hits++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stats)</span> <span class="title">miss</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.misses++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    key <span class="keyword">string</span></span><br><span class="line">    hits <span class="keyword">int</span></span><br><span class="line">    value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;LRU (Least-Recently-Used) Cache æ˜¯ç»å¸¸ä½¿ç”¨çš„ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥å°†ä¸€äº›çƒ­ç‚¹æ•°æ®å­˜æ”¾åœ¨å…¶ä¸­ï¼Œè¿›è€Œæé«˜æ¥å£çš„å“åº”é€Ÿ
      
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="LRU" scheme="http://ifaceless.space/tags/LRU/"/>
    
      <category term="ç¼“å­˜" scheme="http://ifaceless.space/tags/%E7%BC%93%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>Linux Kernel Development å­¦ä¹ ä¸æ€»ç»“</title>
    <link href="http://ifaceless.space/2019/10/31/linux-kernel-dev-notes/"/>
    <id>http://ifaceless.space/2019/10/31/linux-kernel-dev-notes/</id>
    <published>2019-10-31T09:47:22.000Z</published>
    <updated>2019-11-24T10:07:26.745Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æŠ½æ—¶é—´æŠŠ <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" target="_blank" rel="noopener"><em>Operating Systems: Three Easy Pieces</em></a> ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´æœ« ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆ<em>Linux Kernel Development</em>ï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚</p><p>åœ¨å­¦ä¹ ä¹‹å‰ï¼Œæ€è€ƒäº†ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥åœ¨å­¦ä¹ ä¸­æ¢ç´¢è¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼š</p><ol><li>Linux ä¸­è¿›ç¨‹ã€çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå„ç§è°ƒåº¦ç­–ç•¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li><li>å¹¶å‘é—®é¢˜è‚¯å®šéœ€è¦æ³¨æ„ï¼ŒLinux ä¸­å¦‚ä½•åº”å¯¹ç«æ€æ¡ä»¶ &amp; æ•°æ®ç«äº‰å‘¢ï¼Ÿå„ç§å¸¸è§çš„åŒæ­¥åŸè¯­åˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>Linux çš„å†…å­˜è™šæ‹ŸåŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå†…å­˜å¸ƒå±€ï¼Ÿè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Ÿ</li><li>æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ€ä¹ˆè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å¯¹ç”¨æˆ·æä¾›ä¸€è‡´ä¼˜é›…çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„å‘¢ï¼Ÿ</li><li>Linux å†…æ ¸ä¸­æœ‰å“ªäº›éå¸¸ç»å…¸çš„ç®—æ³•å’Œæ•°æ®ç»“æ„çš„åº”ç”¨ï¼Ÿå®ƒä»¬ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li></ol><h1 id="Linux-å†…æ ¸ç®€ä»‹"><a href="#Linux-å†…æ ¸ç®€ä»‹" class="headerlink" title="Linux å†…æ ¸ç®€ä»‹"></a>Linux å†…æ ¸ç®€ä»‹</h1><p><img src="https://pic4.zhimg.com/80/v2-e0c1aced72034fd29160b2a0dbc73fa5_r.png" alt=""></p><p>è¯´åˆ° Linuxï¼Œå°±ä¸å¾—ä¸æåˆ°å®ƒçš„ç¥–å…ˆ Unix ç³»ç»Ÿã€‚Unix åœ¨ 1970 å¹´å·¦å³è¢« Ken Thompson é¦–å…ˆåœ¨ä¸€å° PDP-7 æœºå‹ä¸Šå®ç°ï¼Œè€Œåç§»æ¤åˆ° PDP-11 æœºå™¨ä¸Šï¼Œ1973 å¹´å®ƒè¢«ä½¿ç”¨ C è¯­è¨€é‡å†™ï¼Œæä¾›äº†æ›´åŠ å¼ºå¤§çš„å¯ç§»æ¤æ€§ã€‚</p><p>ç»è¿‡å¤šå¹´å‘å±•ï¼ŒUnix ç³»ç»Ÿæˆä¸ºäº†ä¸€ä¸ªå¼ºå¤§ã€å¥å£®ä¸”ç¨³å®šçš„æ“ä½œç³»ç»Ÿã€‚å…¶å¼ºå¤§çš„æ ¹æœ¬åŸå› å¦‚ä¸‹ï¼š</p><ol><li>ç®€æ´ï¼Œä»…æä¾›æ•°ç™¾ä¸ªè®¾è®¡ç›®æ ‡æ˜ç¡®çš„ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>æ‰€æœ‰çš„ä¸œè¥¿éƒ½è¢«å½“ä½œæ–‡ä»¶çœ‹å¾…</li><li>å¾ˆå¼ºçš„ç§»æ¤èƒ½åŠ›</li><li>è¿›ç¨‹åˆ›å»ºéå¸¸è¿…é€Ÿï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨</li><li>æ‹¥æœ‰ç®€å•ä¸”ç¨³å®šçš„è¿›ç¨‹é—´é€šä¿¡åŸè¯­</li></ol><p>Linux æ˜¯ç±» Unix ç³»ç»Ÿï¼Œå®ƒçš„å®ç°å’Œ Unix ä¹Ÿæœ‰ä¸€äº›å¤§ç›¸å¾„åº­çš„æ–¹é¢ï¼Œä½†æ˜¯å®ƒä¾ç„¶ç»§æ‰¿äº† Unix çš„è®¾è®¡ç›®æ ‡ï¼Œä¿è¯äº† API çš„ä¸€è‡´æ€§ï¼ˆæœ‰å“ä½çš„ç¨‹åºå‘˜éƒ½åº”è¯¥è¦å­¦ä¹ è¿™ä¸€æ€æƒ³ï¼‰ã€‚</p><p>Linux è¯æ±‡ä¸€èˆ¬ç”¨æ¥æŒ‡ä»£å†…æ ¸ã€‚å®ƒçš„åŸºç¡€åŒ…æ‹¬ï¼š</p><ol><li>å†…æ ¸</li><li>C åº“</li><li>å·¥å…·é›†</li><li>ç³»ç»Ÿçš„åŸºæœ¬å·¥å…·ï¼Œå¦‚ Shell</li></ol><p>ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿå®½æ³›çš„æ“ä½œç³»ç»Ÿæ˜¯æŒ‡æ•´ä¸ªç³»ç»Ÿä¸­è´Ÿè´£å®Œæˆæœ€åŸºæœ¬åŠŸèƒ½å’Œç³»ç»Ÿç®¡ç†çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬<strong>å†…æ ¸ã€è®¾å¤‡é©±åŠ¨ã€å¯åŠ¨å¼•å¯¼ç¨‹åºã€å‘½ä»¤è¡Œ Shell æˆ–ç”¨æˆ·ç•Œé¢ã€æ–‡ä»¶ç®¡ç†å·¥å…·å’Œç³»ç»Ÿå·¥å…·</strong>ã€‚å†…æ ¸åˆ™æ˜¯é‚£ä¸ªæœ€äº®çš„ä»”ï¼Œå®ƒé€šå¸¸ç”±å¦‚ä¸‹å‡ ä¸ªé‡è¦éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>ä¸­æ–­æœåŠ¡</li><li>ä»»åŠ¡è°ƒåº¦ç¨‹åº</li><li>å†…å­˜ç®¡ç†ç¨‹åº</li><li>ç½‘ç»œ</li><li>è¿›ç¨‹é—´é€šä¿¡ç­‰ç³»ç»ŸæœåŠ¡</li></ol><p>Linux çš„ä¸­æ–­æœåŠ¡æ˜¯ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªä¸æ‰€æœ‰è¿›ç¨‹æ— å…³ã€ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ç¬¬ä¸€æ—¶é—´èƒ½å¤Ÿå“åº”å’Œå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œç„¶åå¿«é€Ÿé€€å‡ºã€‚</p><p>å¤„ç†å™¨åœ¨ä»»æ„æ—¶é—´ç‚¹æ´»åŠ¨å¯æ¦‚æ‹¬ä¸ºä»¥ä¸‹ä¸‰ç§ä¹‹ä¸€ï¼š</p><ol><li>è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä»£è¡¨æŸä¸ªç‰¹å®šçš„è¿›ç¨‹æ‰§è¡Œï¼ˆå¦‚æŸä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸è¿›ç¨‹æ— å…³ï¼Œå¤„ç†ç‰¹å®šçš„ä¸­æ–­</li></ol><h2 id="å¾®å†…æ ¸å’Œå®å†…æ ¸"><a href="#å¾®å†…æ ¸å’Œå®å†…æ ¸" class="headerlink" title="å¾®å†…æ ¸å’Œå®å†…æ ¸"></a>å¾®å†…æ ¸å’Œå®å†…æ ¸</h2><p>è¿™ä¸ªæ˜¯æ¯”è¾ƒæœ‰è¶£çš„å†å²äº†ï¼Œæ“ä½œç³»ç»Ÿè®¾è®¡æœ‰ä¸¤å¤§ä¸»è¦é˜µè¥ï¼šå¾®å†…æ ¸å’Œå®å†…æ ¸ã€‚</p><p>å¾®å†…æ ¸çš„åŠŸèƒ½åˆ’åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æ˜¯ä¸€ä¸ªæœåŠ¡ï¼ˆC/S æ¨¡å‹ï¼ŒæœåŠ¡ä¸å†…æ ¸äº¤äº’ï¼‰ã€‚ç³»ç»Ÿé‡‡ç”¨ IPC ç¦æ­¢äº’é€šæ¶ˆæ¯ï¼Œäº’æ¢ã€ŒæœåŠ¡ã€ã€‚æœåŠ¡çš„ç‹¬ç«‹æ€§å¯ä»¥é¿å…ä¸€ä¸ªæœåŠ¡å¤±è´¥æ®ƒåŠå…¶å®ƒæœåŠ¡ã€‚æ¨¡å—åŒ–è®¾è®¡ä¹Ÿéå¸¸é€‚åˆçƒ­æ’æ‹”ã€‚ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯ IPC çš„å¼€é”€å¤šäºå‡½æ•°è°ƒç”¨ï¼ˆç±»æ¯”å¾®æœåŠ¡çš„ç½‘ç»œå¼€é”€å’Œåœ¨æœ¬åœ°è°ƒç”¨å‡½æ•°çš„å¼€é”€ï¼‰ã€‚</p><p>å®å†…æ ¸åˆ™æ˜¯å®ç”¨ä¸»ä¹‰è€…å–œæ¬¢çš„è®¾è®¡ï¼Œå®ƒæ˜¯æ¯”è¾ƒç®€å•çš„è®¾è®¡ï¼Œæ•´ä½“ä¸Šå°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿‡ç¨‹ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ã€‚å†…æ ¸ä¹‹é—´çš„é€šä¿¡å¾®ä¸è¶³é“ï¼Œæ€§èƒ½é«˜ã€‚</p><p>Linux è‡ªç„¶æ˜¯å®å†…æ ¸è®¾è®¡ï¼ŒLinux å†…æ ¸è¿è¡Œåœ¨å•ç‹¬çš„å†…æ ¸åœ°å€ç©ºé—´ä¸Šã€‚åŒæ—¶å®ƒä¹Ÿé‡‡çº³äº†å¾®å†…æ ¸çš„ç²¾åï¼Œä½¿å®ƒæˆä¸ºæ¨¡å—åŒ–çš„ã€å¤šçº¿ç¨‹çš„ä»¥åŠå†…æ ¸æœ¬èº«å¯è°ƒåº¦çš„æ“ä½œç³»ç»Ÿã€‚</p><h2 id="ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«"><a href="#ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«" class="headerlink" title="ä¸ä¼ ç»Ÿ Unix åŒºåˆ«"></a>ä¸ä¼ ç»Ÿ Unix åŒºåˆ«</h2><ol><li>æ”¯æŒåŠ¨æ€åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆè¿™ä¸ªä¸æ˜¯å¾®å†…æ ¸å®£ç§°çš„å¥½å¤„å—ï¼Ÿå’±ä¹Ÿæœ‰ï¼‰</li><li>æ”¯æŒå¯¹ç§°å¤šå¤„ç†æœºåˆ¶ï¼ˆSMPï¼‰</li><li>å†…æ ¸å¯ä»¥æŠ¢å ï¼ˆpreemptiveï¼‰ï¼šä»»åŠ¡å¯ä»¥æœ‰ä¼˜å…ˆçº§</li><li>å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒå¾ˆç‰¹åˆ«ï¼šå†…æ ¸ä¸åŒºåˆ†çº¿ç¨‹å’Œä¸€èˆ¬çš„è¿›ç¨‹ï¼Œå¯¹äºå†…æ ¸è€Œè¨€ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸€æ ·ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€äº›å…±äº«èµ„æºè€Œå·²</li><li>å…·æœ‰è®¾å¤‡ç±»çš„é¢å‘å¯¹è±¡çš„è®¾å¤‡æ¨¡å‹ã€çƒ­æ’æ‹”äº‹ä»¶ï¼Œç”¨æˆ·ç©ºé—´çš„è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆsysfsï¼‰</li><li>å¿½ç•¥äº†ä¸€äº›æ‹™åŠ£ç‰¹æ€§</li><li>è‡ªç”±ï¼šä»»ä½•æ”¹å˜éƒ½å¿…é¡»è¦èƒ½é€šè¿‡ç®€æ´çš„è®¾è®¡åŠæ­£ç¡®å¯é çš„å®ç°æ¥è§£å†³ç°å®ä¸­ç¡®å®å­˜åœ¨çš„é—®é¢˜</li></ol><h2 id="å†…æ ¸ç‰ˆæœ¬"><a href="#å†…æ ¸ç‰ˆæœ¬" class="headerlink" title="å†…æ ¸ç‰ˆæœ¬"></a>å†…æ ¸ç‰ˆæœ¬</h2><p><code>&lt;ä¸»ç‰ˆæœ¬&gt;.&lt;ä»ç‰ˆæœ¬&gt;.&lt;ä¿®è®¢&gt;[.&lt;ç¨³å®šç‰ˆæœ¬å·&gt;]</code>ï¼Œå…¶ä¸­<strong>ä»ç‰ˆæœ¬å·</strong>ä¸ºå¶æ•°ï¼Œåˆ™ä¸ºç¨³å®šç‰ˆæœ¬ï¼Œå¦åˆ™ä¸ºå¼€å‘ç‰ˆæœ¬ã€‚</p><h2 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h2><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>å¯ä»¥ä½¿ç”¨çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><code>make config</code></li><li><code>make menuconfig1</code></li><li><code>make gconfig</code></li><li>é»˜è®¤é…ç½®ï¼š<code>make defconfig</code></li></ol><p>éªŒè¯å’Œæ›´æ–°é…ç½®ï¼š<code>make oldconfig</code></p><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><ol><li>ç›´æ¥ç¼–è¯‘ï¼š<code>make</code></li><li>å¯¼å‡ºä¸å…³å¿ƒçš„ infoï¼š<code>make &gt;/dev/null</code></li><li>æŒ‡å®šå¹¶è¡Œç¼–è¯‘æ•°é‡ï¼š<code>make -j4 &gt;/dev/null</code></li></ol><h2 id="å†…æ ¸å¼€å‘ç‰¹ç‚¹"><a href="#å†…æ ¸å¼€å‘ç‰¹ç‚¹" class="headerlink" title="å†…æ ¸å¼€å‘ç‰¹ç‚¹"></a>å†…æ ¸å¼€å‘ç‰¹ç‚¹</h2><ol><li>ä¸èƒ½ä½¿ç”¨æ ‡å‡† C åº“</li><li><p>å¿…é¡»ä½¿ç”¨ GNU Cï¼ˆéœ€è¦ç”¨åˆ°å®ƒçš„ä¸€äº›æ‰©å±•ç‰¹æ€§ï¼‰</p><ol><li><code>inline</code>ï¼šé€šå¸¸å°†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå‡½æ•°æœ¬èº«æ¯”è¾ƒçŸ­çš„å®šä¹‰æˆå†…è”å‡½æ•°ã€‚åœ¨å†…æ ¸ä¸­ï¼Œä¸ºäº†ç±»å‹å®‰å…¨å’Œæ˜“è¯»æ€§ï¼Œä¼˜å…ˆä½¿ç”¨ inline å‡½æ•°ï¼Œè€Œéå¤æ‚çš„å®</li><li>å†…è”ç¼–è¯‘ï¼šæ”¯æŒä½¿ç”¨ <code>asm()</code> åµŒå…¥æ±‡ç¼–ä»£ç </li><li>åˆ†æ”¯å£°æ˜ï¼šå¯ä»¥ä½¿ç”¨ <code>likely()</code> å’Œ <code>unlikely()</code> å£°æ˜åˆ†æ”¯æ˜¯å¦ç»å¸¸å‡ºç°æˆ–å¾ˆå°‘å‡ºç°ï¼ŒæŒ‡å¯¼ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ï¼ˆè¦ææ¸…æ¥šï¼Œå¦åˆ™ä¼˜åŒ–åè€Œå˜æˆäº†æ‹–ç´¯ï¼‰</li></ol></li><li><p>ç¼ºä¹åƒç”¨æˆ·ç©ºé—´ä¸­çš„å†…å­˜ä¿æŠ¤æœºåˆ¶</p><ol><li>å†…æ ¸ä¸­å‘ç”Ÿå†…å­˜é”™è¯¯ä¼šå¯¼è‡´ oopsï¼Œå†…æ ¸å¯èƒ½ä¼šæ­»æ‰</li><li>å†…æ ¸ä¸­çš„å†…å­˜æ˜¯<strong>ä¸åˆ†é¡µ</strong>çš„ï¼Œæ¯ç”¨æ‰ä¸€ä¸ªå­—èŠ‚ï¼Œç‰©ç†å†…å­˜å°±å‡å°‘ä¸€ä¸ªå­—èŠ‚</li></ol></li><li><p>éš¾ä»¥æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—</p><ol><li>ä¸èƒ½åƒç”¨æˆ·ç©ºé—´æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—é‚£æ ·ï¼Œå¯ä»¥é€šè¿‡ trap çš„æ–¹å¼å°†æ•´æ•°æ¨¡å¼è½¬æ¢åˆ°æµ®ç‚¹æ•°æ¨¡å¼è®¡ç®—</li><li>å†…æ ¸ä¸èƒ½å®Œç¾æ”¯æŒæµ®ç‚¹æ•°è®¡ç®—ï¼Œæœ¬èº«ä¹Ÿæ— æ³•é™·å…¥ã€‚éè¦æ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦æ‰‹åŠ¨ä¿å­˜å’Œæ¢å¤æµ®ç‚¹å¯„å­˜å™¨ï¼Œéå¸¸éº»çƒ¦</li></ol></li><li><p>å†…æ ¸ç»™æ¯ä¸ªè¿›ç¨‹<strong>åªæœ‰ä¸€ä¸ªå¾ˆå°çš„å®šé•¿å †æ ˆ</strong></p><ol><li>ç”¨æˆ·ç©ºé—´çš„æ ˆå¯ä»¥åŠ¨æ€å¢é•¿ï¼Œå¯æ”¯æŒéå¸¸å¤§çš„æ•°æ®ç»“æ„</li><li>å†…æ ¸æ ˆçš„å¤§å°å’Œä½“ç³»ç»“æ„æœ‰å…³ï¼ˆå¦‚ x86 å¯ä»¥æ˜¯ 4KB/8KBï¼‰</li><li>å†å²ä¸Šæ¥è¯´ï¼Œå†…æ ¸æ ˆå¤§å°æ˜¯ä¸¤é¡µï¼Œ32 ä½æ˜¯ 8KBï¼Œ64 ä½æ˜¯ 16KBï¼›æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„æ ˆ</li></ol></li><li><p>ç”±äºè¦æ”¯æŒå¼‚æ­¥ä¸­æ–­ã€æŠ¢å å’Œ SMPï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å®‰å…¨å’ŒåŒæ­¥</p></li><li>è€ƒè™‘å¯ç§»æ¤æ€§<ol><li>ä¿æŒå­—èŠ‚åº</li><li>64 ä½å¯¹é½</li><li>ä¸å‡å®šå­—é•¿å’Œé¡µé¢é•¿åº¦</li></ol></li></ol><h1 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h1><h2 id="ç®¡ç†è¿›ç¨‹"><a href="#ç®¡ç†è¿›ç¨‹" class="headerlink" title="ç®¡ç†è¿›ç¨‹"></a>ç®¡ç†è¿›ç¨‹</h2><ol><li>å†…æ ¸æŠŠè¿›ç¨‹çš„åˆ—è¡¨å­˜æ”¾åœ¨ task list åŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ª entry çš„ç±»å‹æ˜¯ <code>task_struct</code>ï¼Œè¢«ç§°ä¸º <code>process descriptor</code></li><li>é€šè¿‡ slabï¼ˆæ›´æ–°çš„åº”è¯¥æ˜¯ SLUBï¼‰ åˆ†é…å™¨åˆ†é… task_struct ç»“æ„ä½“ï¼ˆå¯¹è±¡å¤ç”¨å’Œç¼“å­˜ç€è‰²ï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡çš„ <code>thread_info</code> ä½äºå†…æ ¸æ ˆçš„å°¾ç«¯ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘ <code>task_struct</code> çš„æŒ‡é’ˆåŠå…¶å®ƒä¿¡æ¯</li><li>è¿›ç¨‹é€šè¿‡ PID è¿›è¡ŒåŒºåˆ†ï¼Œå…¶å€¼å­˜æ”¾åœ¨ <code>process descriptor</code> ä¸­ã€‚ç”±äºè¿›ç¨‹å¤„ç†ä»£ç éœ€è¦é¢‘ç¹è®¿é—® <code>task_struct</code> ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ PowerPC ç­‰æœºå™¨ä¸Šï¼Œæœ‰ä¸“é—¨çš„å¯„å­˜å™¨å­˜å‚¨äº†ç›¸åº”çš„æŒ‡é’ˆï¼›è€Œåœ¨ x86 ä½“ç³»ä¸‹ï¼Œåˆ™æ˜¯åˆ©ç”¨å†…æ ¸æ ˆå°¾åˆ›å»ºçš„ <code>thread_info</code>ï¼Œå¹¶å€ŸåŠ©åç§»è®¡ç®—é—´æ¥æŸ¥æ‰¾ <code>task_struct</code> ç»“æ„ä½“</li><li><p>è¿›ç¨‹çŠ¶æ€ï¼š</p><ol><li>TASK_RUNNING</li><li>TASK_INTERRUPTABLE</li><li>TASK_UNINTERRUPTABLE</li><li>__TASK_TRACED: è¢«å…¶å®ƒè¿›ç¨‹è·Ÿè¸ªçš„è¿›ç¨‹ï¼ˆå¦‚ ptrace å¯¹è°ƒè¯•ç¨‹åºè¿›è¡Œè·Ÿè¸ªï¼‰</li><li><p>__TASK_STOPPED: è¿›ç¨‹åœæ­¢æ‰§è¡Œï¼Œæ²¡æœ‰æŠ•å…¥è¿è¡Œä¹Ÿæ— æ³•æŠ•å…¥è¿è¡Œ</p><p><img src="https://pic2.zhimg.com/80/v2-ad2075f3f165ab1ab983605446be9b28_r.png" alt=""></p></li></ol></li><li><p>æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ PID ä¸º 1 çš„ init è¿›ç¨‹çš„åä»£ï¼Œinit è¿›ç¨‹çš„æè¿°ç¬¦æ˜¯ä½œä¸º init_task é™æ€åˆ†é…çš„ï¼ˆæ¯”è¾ƒç‰¹æ®Šï¼‰</p></li><li><p>Unix ç³»ç»Ÿè¿›ç¨‹åˆ›å»ºï¼š</p><ol><li>é€šè¿‡ <code>fork()</code> æ‹·è´å½“å‰è¿›ç¨‹åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆåŒºåˆ«çˆ¶è¿›ç¨‹ï¼šæœ‰æ–°çš„ PIDï¼Œæœ‰æŸäº›èµ„æºå’Œç»Ÿè®¡é‡ï¼‰</li><li><code>exec()</code> å‡½æ•°è´Ÿè´£è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¹¶å°†å…¶è½½å…¥åœ°å€ç©ºé—´å¼€å§‹è¿è¡Œ</li></ol></li><li><p>å†™æ—¶æ‹·è´ï¼šå†…æ ¸å¹¶éå¼€å§‹å°±å¤åˆ¶æ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè€Œæ˜¯è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ‹·è´ï¼Œåªæœ‰åœ¨éœ€è¦å†™å…¥çš„æ—¶å€™ï¼Œæ•°æ®æ‰ä¼šè¢«å¤åˆ¶ï¼Œä»è€Œæ‹¥æœ‰å„è‡ªçš„æ‹·è´ã€‚<code>fork()</code> å®é™…å¼€é”€ï¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œç»™å­è¿›ç¨‹åˆ›å»ºå”¯ä¸€çš„è¿›ç¨‹æè¿°ç¬¦</p></li><li>Linux ä¸­çš„ <code>fork()</code> å’Œ <code>vfork()</code> éƒ½æ˜¯é€šè¿‡ <code>clone()</code> ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚<code>vfork()</code> çš„ç‰¹ç‚¹æ˜¯ï¼šä¸æ‹·è´çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä¸”å­è¿›ç¨‹ä½œä¸ºçˆ¶è¿›ç¨‹çš„å•ç‹¬çº¿ç¨‹åœ¨å®ƒçš„åœ°å€ç©ºé—´æ‰§è¡Œï¼Œçˆ¶è¿›ç¨‹é˜»å¡ç›´åˆ°å­è¿›ç¨‹é€€å‡ºæˆ–æ‰§è¡Œ <code>exec()</code></li><li><p>Linux ä¸­çš„çº¿ç¨‹å®ç°ï¼š</p><ol><li>ä»å†…æ ¸è§’åº¦çœ‹ï¼Œæ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹çœ‹å¾…ï¼Œåªæ˜¯ä¸å…¶å®ƒè¿›ç¨‹å…±äº«æŸäº›èµ„æºã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰å±äºè‡ªå·±çš„ task_struct</li><li>å…¶å®ƒç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹è¢«æŠ½è±¡æˆä¸€ç§è€—è´¹èµ„æºè¾ƒå°‘çš„èµ„æºï¼Œè¿è¡Œè¿…é€Ÿçš„æ‰§è¡Œå•å…ƒ</li><li>é€šè¿‡ <code>clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, 0);</code> åˆ›å»ºçº¿ç¨‹</li><li>å¯¹æ¯” <code>fork()</code> å®ç°ï¼š<code>clone(SIGCHLD, 0)</code></li><li>å¯¹æ¯” <code>vfork()</code> å®ç°ï¼š<code>clone(CLONE_VFORK | CLONE_VM | SIGCHLD, 0)</code></li></ol></li><li><p>å†…æ ¸çº¿ç¨‹ï¼š</p><ol><li>å†…æ ¸é€šå¸¸éœ€è¦åœ¨åå°æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè¿™äº›ä»»åŠ¡å¯é€šè¿‡ kernel thread å®Œæˆã€‚è¿™ç§æ˜¯è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„æ ‡å‡†è¿›ç¨‹</li><li>å†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¯è¢«è°ƒåº¦ï¼Œå¯è¢«æŠ¢å </li></ol></li><li><p>è¿›ç¨‹ç»ˆç»“ï¼š</p><ol><li>é€šå¸¸é€šè¿‡ <code>do_exit()</code> å®Œæˆé€€å‡ºï¼ŒæœŸé—´ä¼šé‡Šæ”¾ç›¸å…³çš„èµ„æºï¼Œæœ€ç»ˆå°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º <code>EXIT_ZOMBIE</code>ï¼Œä½†æ˜¯æ­¤æ—¶çš„å†…æ ¸æ ˆã€thread_info å’Œ task_struct ç»“æ„ä½“è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œç»™çˆ¶è¿›ç¨‹æä¾›ä¿¡æ¯</li><li>çˆ¶è¿›ç¨‹è·å¾—å·²ç»ˆç»“çš„å­è¿›ç¨‹ä¿¡æ¯åï¼ˆçˆ¶è¿›ç¨‹å¯é€šè¿‡ <code>wait()</code> ç³»ç»Ÿè°ƒç”¨æ”¶é›†ä¿¡æ¯ï¼‰ï¼Œæˆ–è€…é€šçŸ¥å†…æ ¸å®ƒä¸å…³æ³¨è¿™äº›ä¿¡æ¯ï¼Œæ‰ä¼šé‡Šæ”¾å‰©ä½™çš„å†…å­˜ç©ºé—´</li></ol></li><li><p>å­¤å„¿è¿›ç¨‹ï¼š</p><ol><li>é€€å‡ºæ—¶æ°¸è¿œå¤„äºåƒµæ­»çŠ¶æ€ï¼Œç™½ç™½æµªè´¹å†…å­˜</li><li>è§£å†³åŠæ³•å°±æ˜¯åœ¨å½“å‰çº¿ç¨‹ç»„å¯»æ‰¾æŸä¸ªçº¿ç¨‹ä½œä¸ºçˆ¶äº²ï¼Œå®åœ¨ä¸è¡Œï¼Œå°±è®© init æ¥ç›˜</li></ol></li></ol><h2 id="è°ƒåº¦è¿›ç¨‹"><a href="#è°ƒåº¦è¿›ç¨‹" class="headerlink" title="è°ƒåº¦è¿›ç¨‹"></a>è°ƒåº¦è¿›ç¨‹</h2><ol><li><p>å¤šä»»åŠ¡ç³»ç»Ÿåˆ†ä¸ºä¸¤ç±»ï¼š</p><ol><li>éæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆcooperative multitaskingï¼‰</li><li>æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆpreemptive multitaskingï¼‰</li></ol></li><li><p>è¿›ç¨‹è°ƒåº¦ç­–ç•¥ä¼šå…³å¿ƒè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡</p></li><li>Linux ä¸­çš„è¿›ç¨‹åˆ†ä¸ºæ™®é€šè¿›ç¨‹å’Œå®æ—¶è¿›ç¨‹ï¼Œå…¶ä¸­å‰è€…çš„ä¼˜å…ˆçº§åœ¨ (-20, +19ï¼‰ï¼Œè€Œåè€…åˆ™æ˜¯ (0, 99)ã€‚æ­¤å¤–ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºæ™®é€šè¿›ç¨‹ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜ å°„è¿‡æ¥å°±æ˜¯ (100, 139)</li><li>Linux ä¸­å¯ä»¥é€šè¿‡ <code>nice</code> è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¶Šå°çš„å€¼æ‹¥æœ‰è¶Šé«˜çš„æƒé‡ï¼›åä¹‹ï¼Œåˆ™æƒé‡è¶Šä½ï¼ˆä½“ç°åœ¨æ—¶é—´ç‰‡ä¸Šï¼‰</li></ol><h3 id="CFS-è°ƒåº¦å™¨"><a href="#CFS-è°ƒåº¦å™¨" class="headerlink" title="CFS è°ƒåº¦å™¨"></a>CFS è°ƒåº¦å™¨</h3><ol><li>Linux 2.6 å†…æ ¸å¼•å…¥äº† CFS è°ƒåº¦å™¨ï¼ˆä½äº <code>sched/fair.c</code>ï¼‰ä½œä¸ºæ™®é€šè¿›ç¨‹çš„è°ƒåº¦å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿‘ä¹å®Œç¾çš„å…¬å¹³è°ƒåº¦å™¨ï¼ˆæƒè¡¡å‘¨è½¬æ—¶é—´å’Œå“åº”æ—¶é—´ï¼‰ã€‚å¹¶éé‡‡ç”¨æ—¶é—´ç‰‡è¿›è¡Œåˆ†é…ï¼Œè€Œæ˜¯ç»™è¿›ç¨‹åˆ†é…äº†å¤„ç†å™¨ä½¿ç”¨çš„æ¯”é‡ï¼Œä»è€Œç¡®ä¿è¿›ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿæœ‰æ’å®šçš„å…¬å¹³æ€§ï¼Œä»è€Œå°†åˆ‡æ¢é¢‘ç‡ç½®äºä¸æ–­å˜åŠ¨ä¸­</li><li>CFS åŸºäºä¸€ä¸ªç®€å•çš„ç†å¿µï¼šè¿›ç¨‹è°ƒåº¦çš„æ•ˆæœåº”è¯¥ç­‰åŒäºç³»ç»Ÿæ‹¥æœ‰ä¸€ä¸ªå®Œç¾çš„å¤šä»»åŠ¡å¤„ç†å™¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½èƒ½è·å¾— 1/n_running å¤„ç†å™¨æ—¶é—´</li><li>CFS å…è®¸æ¯ä¸ªè¿›ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå¾ªç¯è½®è½¬ï¼Œæ€»æ˜¯é€‰æ‹© vruntime æœ€å°çš„è¿›ç¨‹ä½œä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯é€šè¿‡æ‰€æœ‰å¯è¿è¡Œç»å¸¸æ€»æ•°ä¸ºåŸºç¡€æ¥è®¡ç®—å‡ºè¿›ç¨‹åº”è¯¥è¿è¡Œå¤šä¹…ï¼Œè€Œéä¾é  nice å€¼æ¥è®¡ç®—æ—¶é—´ç‰‡ï¼ˆä¼ ç»Ÿçš„åšæ³•å°±æ˜¯è¿™ç§ï¼‰</li><li>è°ƒåº¦å™¨å®ç°æ¦‚è¦ï¼š<ol><li><code>sched_entity</code> ç»“æ„ä½“è·Ÿè¸ªè¿è¡Œè®°è´¦ï¼ˆå…¶ä¸­åŒ…å« vruntimeï¼‰</li><li>æ‰€æœ‰å¯è¿è¡Œçš„è¿›ç¨‹éƒ½ä½äºä¸€æ£µé»‘çº¢æ ‘ä¸­ï¼ˆO(logN) æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾ï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½ä¼šä»æ ‘çš„æœ€å·¦å¶å­èŠ‚ç‚¹ä¸Šï¼ˆleftmostï¼‰æ‰¾åˆ° vruntime æœ€å°çš„é‚£ä¸ªè¿›ç¨‹è¿è¡Œï¼ˆå®æ—¶ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯æå‰ç¼“å­˜å¥½çš„ï¼‰</li><li>è°ƒåº¦å™¨å…¥å£å¤„ä¼šæ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„è°ƒåº¦ç±»ï¼Œç„¶åè·å–åˆ°è°æ˜¯ä¸‹ä¸€ä¸ªè¯¥è¿è¡Œçš„è¿›ç¨‹</li><li>ç¡çœ ï¼šè¿›ç¨‹ä¼šæŠŠè‡ªå·±æ ‡è®°æˆä¼‘çœ çŠ¶æ€ï¼Œä»å¯æ‰§è¡Œçº¢é»‘æ ‘ä¸­æº¢å‡ºï¼Œå¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè°ƒç”¨ <code>schedule()</code> æ‰§è¡Œä¸€ä¸ªå…¶ä»–è¿›ç¨‹</li><li>å”¤é†’ï¼šè¿›ç¨‹è¢«è®¾ç½®ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ç§»é™¤ï¼Œæ·»åŠ åˆ°å¯æ‰§è¡Œçº¢é»‘æ ‘</li></ol></li><li>CFS å®ç°äº†å¦‚ä¸‹å‡ ç§è°ƒåº¦ç­–ç•¥ï¼š<ol><li>SCHED_NORMALï¼ˆä»¥å‰å«åš SCHED_OTHERï¼‰ï¼šç”¨äºæ™®é€šä»»åŠ¡è°ƒåº¦</li><li>SCHED_BATCHï¼šå¹¶éåƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œä¼šå°½å¯èƒ½å…è®¸ä»»åŠ¡è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ä¸Š CPU äº²å’Œæ€§ä»¥åŠæ›´å¥½åœ°å¤ç”¨ç¼“å­˜</li><li>SCHED_IDLEï¼šè¿™ç§ä»»åŠ¡ä¼˜å…ˆçº§æ¯” nice 19 è¿˜è¦ä½</li></ol></li></ol><h3 id="æŠ¢å "><a href="#æŠ¢å " class="headerlink" title="æŠ¢å "></a>æŠ¢å </h3><ol><li>ç”¨æˆ·æŠ¢å ï¼ˆæ£€æŸ¥ need_resched æ ‡è¯†ç¬¦ï¼‰ï¼šä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼›ä»ä¸­æ–­å¤„ç†è¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li><li>å†…æ ¸æŠ¢å ï¼ˆthread_info ä¸­å­˜åœ¨ preemt_count è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰æ²¡æœ‰é”è¢«æŒæœ‰ï¼‰ï¼šå°±æ˜¯è°ƒåº¦ç¨‹åºèƒ½å¤Ÿåœ¨å†…æ ¸ä»»åŠ¡æ‰§è¡ŒæœŸé—´è¢«æ‰§è¡Œ<ol><li>åªè¦é‡æ–°è°ƒåº¦æ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰æŒæœ‰é”ï¼‰ï¼Œå†…æ ¸å°±å¯ä»¥åœ¨ä»»ä½•æ—¶é—´æŠ¢å æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li><li>å†…æ ¸æŠ¢å æ—¶æœºï¼š<ol><li>ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œä¸”è¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰</li><li>å†…æ ¸ä»£ç å†æ¬¡å…·æœ‰å¯æŠ¢å æ€§æ—¶</li><li>å†…æ ¸ä»»åŠ¡æ˜¾å¼è°ƒç”¨ <code>schedule()</code></li><li>å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡ï¼ˆæ­¤æ—¶ä¼šå¯¼è‡´è°ƒç”¨ <code>schedule()</code>ï¼‰</li></ol></li></ol></li></ol><h3 id="å®æ—¶è°ƒåº¦å™¨"><a href="#å®æ—¶è°ƒåº¦å™¨" class="headerlink" title="å®æ—¶è°ƒåº¦å™¨"></a>å®æ—¶è°ƒåº¦å™¨</h3><ol><li>å®æ—¶è°ƒåº¦å™¨æ˜¯åœ¨ <code>sched/rt.c</code> ä¸­å®ç°çš„ï¼Œå®ƒä½¿ç”¨äº† 100 ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼ˆå¯¹åº” 1~99 ä»»åŠ¡ä¼˜å…ˆçº§ï¼‰ï¼Œå®ç°äº† SCHED_FIFO å’Œ SCHED_RR ç­–ç•¥ã€‚</li><li><p>SCHED_FIFO:</p><ol><li>ç®€å•çš„å…ˆå…¥å…ˆå‡ºè°ƒåº¦ç®—æ³•ï¼Œä¸ä¾èµ–æ—¶é—´ç‰‡</li><li>è¯¥çº§åˆ«ä»»åŠ¡æ¯” SCHED_NORMAL çº§åˆ«çš„è¿›ç¨‹å…ˆå¾—åˆ°è°ƒåº¦</li><li>ä¸€æ—¦ä»»åŠ¡å¤„äºæ‰§è¡ŒæœŸé—´ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼›åªæœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ SCHED_FIFO/SCHED_RR ä»»åŠ¡æ‰å¯ä»¥æŠ¢å </li></ol></li><li><p>SCHED_RR:</p><ol><li>ç±»ä¼¼ FIFOï¼Œä½†æ˜¯æ¯ä¸ªä»»åŠ¡ä¼šæœ‰åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡è€—å°½åå°±è¦æ¢å…¶å®ƒä»»åŠ¡æ‰§è¡Œ</li><li>å¯¹äº FIFO è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§å§‹ç»ˆæŠ¢å ä½ä¼˜å…ˆçº§è¿›ç¨‹ï¼›ä½ä¼˜å…ˆçº§è¿›ç¨‹ä¸èƒ½æŠ¢å  SCHED_RR è¿›ç¨‹ï¼Œå³ä¾¿å…¶è€—å°½äº†æ—¶é—´ç‰‡</li></ol></li><li><p>Linux æä¾›çš„æ˜¯è½¯å®æ—¶å·¥ä½œæ–¹å¼ï¼Œå°½åŠ›ä½¿å¾—è¿›ç¨‹èƒ½å¤Ÿåœ¨é™å®šçš„æ—¶é—´åˆ°æ¥å‰æ‰§è¡Œï¼Œä½†å†…æ ¸ä¸ä¿è¯æ€»èƒ½æ»¡è¶³è¿™äº›è¿›ç¨‹çš„è¦æ±‚</p></li></ol><h3 id="è°ƒåº¦å™¨ç±»"><a href="#è°ƒåº¦å™¨ç±»" class="headerlink" title="è°ƒåº¦å™¨ç±»"></a>è°ƒåº¦å™¨ç±»</h3><p>è°ƒåº¦å™¨ç±»éœ€è¦å®ç°ä¸€äº› hooksï¼Œè¿™æ ·å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åšåˆé€‚çš„æ“ä½œã€‚éƒ¨åˆ† hooks å¦‚ä¸‹ï¼š</p><ul><li><code>enqueue_task</code></li><li><code>dequeue_task</code></li><li><code>yield_task</code></li><li><code>check_preempt_cur</code></li><li><code>pick_next_task</code></li><li><code>set_curr_task</code></li><li><code>task_tick</code></li></ul><h3 id="è°ƒåº¦ç›¸å…³çš„-syscall"><a href="#è°ƒåº¦ç›¸å…³çš„-syscall" class="headerlink" title="è°ƒåº¦ç›¸å…³çš„ syscall"></a>è°ƒåº¦ç›¸å…³çš„ syscall</h3><table><thead><tr><th>ç³»ç»Ÿè°ƒç”¨</th><th>æè¿°</th></tr></thead><tbody><tr><td>nice()</td><td>è®¾ç½®è¿›ç¨‹çš„ nice å€¼</td></tr><tr><td>sched_setscheduler()</td><td>è®¾ç½®è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_getscheduler()</td><td>è·å–è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_setparam()</td><td>è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</td></tr><tr><td>sched_getparam()</td><td></td></tr><tr><td>sched_rr_get_interval()</td><td>æ—¶é—´ç‰‡å€¼</td></tr><tr><td>sched_setaffinity()</td><td>è®¾ç½®å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>sched_getaffinity()</td><td>è·å–è¿›ç¨‹å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>shced_yield()</td><td>æš‚æ—¶è®©å‡ºå¤„ç†å™¨</td></tr></tbody></table><h1 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œè¿›ç¨‹æ˜¯åœ¨æ“ä½œç³»ç»Ÿæä¾›çš„ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ï¼Œè€Œå¦‚æœéœ€è¦æ‰“å¼€æ–‡ä»¶ç­‰æ“ä½œï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥åˆ°å†…æ ¸æ€ï¼Œç”±æ“ä½œç³»ç»Ÿä»£æ›¿å®Œæˆå’Œç¡¬ä»¶çš„äº¤äº’ï¼Œä»è€Œä¸ºè¿›ç¨‹æä¾›æœåŠ¡ã€‚æ‰€ä»¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨æ—¶åœ¨ç”¨æˆ·ç©ºé—´å’Œè¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚ã€‚è¿™ä¸ªä¸­é—´å±‚çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li>ä¸ºç”¨æˆ·ç©ºé—´æä¾›ç¡¬ä»¶æ¥å£æŠ½è±¡</li><li>ç³»ç»Ÿè°ƒç”¨ä¿è¯ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®š</li><li>æ“ä½œç³»ç»Ÿå¯ä»¥æŒæ§è¿›ç¨‹çš„ç¡¬ä»¶è®¿é—®æ„å›¾ï¼Œå¹¶ä¸”ä»£åŠ³</li></ol><p>é‚£ä¹ˆç³»ç»Ÿè°ƒç”¨åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä¸€å¥è¯æ€»ç»“ä¸ºï¼š<strong>å½“ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶ï¼Œä¼šé™·å…¥åˆ°å†…æ ¸ï¼Œä¼ é€’ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•°ï¼Œæ‰§è¡Œæ­£ç¡®çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼å¸¦å›ç”¨æˆ·ç©ºé—´ã€‚</strong>å¯è§ï¼Œç³»ç»Ÿè°ƒç”¨éå¸¸ç‰¹æ®Šï¼Œå®Œå…¨ä¸åŒäºå¸¸è§„çš„å‡½æ•°è°ƒç”¨ï¼Œçœ‹èµ·æ¥éå¸¸ Hackã€‚</p><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡å‡ ä¸ªé—®é¢˜ï¼ŒåŠ æ·±å¯¹ä¸Šè¿°æè¿°çš„ç†è§£ï¼š</p><ol><li><strong>å¦‚ä½•é™·å…¥åˆ°å†…æ ¸ï¼Ÿ</strong>é€šè¿‡è½¯ä¸­æ–­çš„æ–¹å¼å®ç°ï¼Œé€šè¿‡å¼•å‘ä¸€ä¸ªå¼‚å¸¸è§¦å‘ç³»ç»Ÿåˆ‡æ¢åˆ°å†…æ ¸æ€æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</li><li><strong>ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>åœ¨ Linux ä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªç¼–å·ï¼Œè¿›ç¨‹å…¶å®æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·è€Œä¸æ˜¯åç§°æ¥å‘ŠçŸ¥å†…æ ¸è‡ªå·±ä¸­æ„å“ªä¸ªç³»ç»Ÿè°ƒç”¨çš„ã€‚</li><li><strong>å¦‚ä½•ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œåœ¨ x86 ä¸­ï¼Œå°±æ˜¯å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨ eax å¯„å­˜å™¨ä¼ é€’ç»™å†…æ ¸çš„ã€‚</li><li><strong>å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Ÿ</strong>    <ol><li>ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯å°†å‚æ•°æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸€èˆ¬æ¥è¯´ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸ä¼šå¾ˆå¤šã€‚åœ¨ x86 ä¸­ï¼Œå¯ä»¥ç”¨ ebx, ecx, edx, esi å’Œ edi æŒ‰é¡ºåºå­˜æ”¾äº”ä¸ªå‚æ•°ã€‚</li><li>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯å°†å‚æ•°å­˜æ”¾åœ¨ç”¨æˆ·ç©ºé—´å†…å­˜ä¸­ï¼Œå¹¶å°†å‚æ•°æŒ‡é’ˆå­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è¿™ç§æ˜¯ä¸ºäº†åº”ä»˜å‚æ•°è¶…è¿‡ 6 ä¸ªæƒ…å†µã€‚</li></ol></li><li><strong>è¿”å›å€¼å¦‚ä½•å¸¦ç»™ç”¨æˆ·ç©ºé—´ï¼Ÿ</strong>å½“ç„¶ä¹Ÿæ˜¯é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’çš„ï¼Œåœ¨ x86 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ eax å¯„å­˜å™¨ã€‚</li></ol><h1 id="å†…æ ¸æ•°æ®ç»“æ„"><a href="#å†…æ ¸æ•°æ®ç»“æ„" class="headerlink" title="å†…æ ¸æ•°æ®ç»“æ„"></a>å†…æ ¸æ•°æ®ç»“æ„</h1><p><img src="https://pic1.zhimg.com/80/v2-2bbaf34ff51ed6c19c0390d1fd118b40_hd.png" alt="å†…æ ¸æ•°æ®ç»“æ„"></p><p>Linux å†…æ ¸é“¾è¡¨å®ç°ç‹¬æ ‘ä¸€å¸œã€‚å®ƒæ˜¯å°†é“¾è¡¨å¡å…¥åˆ°æ•°æ®ç»“æ„ï¼Œè€Œéå¸¸è§„çš„é‚£ç§åœ¨æ•°æ®ç»“æ„ä¸­å¡å…¥é“¾è¡¨ã€‚</p><p>å¯ä»¥çœ‹ä¸‹å¯¹æ¯”å°±çŸ¥é“ä¸ºä½•ç‰¹åˆ«äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸¸è§„å®šä¹‰æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Linux å†…æ ¸é“¾è¡¨å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">// æ‰€æœ‰çš„ node å½¢æˆé“¾è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œé€šç”¨çš„é“¾è¡¨æ“ä½œå°±å¯ä»¥åŸºäº <code>struct list_head</code> æ¥å®ç°äº†ã€‚é‚£å¦‚ä½•å’Œæ ¹æ®é“¾è¡¨æŒ‡é’ˆè·å¾—å¯¹åº”çš„ <code>node</code> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ <code>container_of()</code> å®ï¼Œå®é™…ä¸Š C è¯­è¨€ä¸­ï¼Œä¸€ä¸ªç»™å®šç»“æ„ä½“ä¸­çš„å˜é‡åç§»åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¯ä»¥å€Ÿæ­¤è·å¾—çˆ¶ç»“æ„ä¸­çš„ä»»æ„å˜é‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define container_of(ptr, type, member) (&#123; \</span><br><span class="line">    const typeof( ((type *)0)-&gt;member) *__mptr = (ptr); \</span><br><span class="line">    (type *)( (char *)__mptr - offsetof(type, member) );&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å’Œä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"></a>ä¸­æ–­å’Œä¸­æ–­å¤„ç†</h1><p><img src="https://pic4.zhimg.com/80/v2-78cb6999358bdd22b1a00c221f1d606e_r.png" alt=""></p><p>ä¸­æ–­æ˜¯å„ç§ç¡¬ä»¶è®¾å¤‡ä¸å¤„ç†å™¨ååŒé«˜æ•ˆå·¥ä½œçš„æ–¹å¼ä¹‹ä¸€ã€‚å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸€äº›å¤–éƒ¨è®¾å¤‡åˆ™ä¼šæ…¢å¾ˆå¤šï¼›ä¸ºäº†èƒ½å¤Ÿä¿è¯ CPU ä¸æµªè´¹æ—¶é—´è½®è¯¢è®¾å¤‡çŠ¶æ€ï¼Œè€Œé™ä½åˆ©ç”¨ç‡ï¼Œæ‰€ä»¥éœ€è¦ä¸­æ–­æœºåˆ¶æ¥é€šçŸ¥ CPUã€‚å½“å¤„ç†å™¨æ¥æ”¶åˆ°ä¸­æ–­åï¼Œä¼šå»æ‰§è¡Œå·²æ³¨å†Œçš„ç›¸å…³ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–­å’Œå‰é¢æåˆ°çš„å¼‚å¸¸ï¼ˆFaultï¼‰æ˜¯ä¸åŒçš„ï¼š</p><ol><li>ä¸­æ–­é€šå¸¸æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¸è€ƒè™‘æ—¶é’ŸåŒæ­¥ï¼›</li><li>å¼‚å¸¸åˆ™å¿…é¡»ä¸å¤„ç†å™¨æ—¶é’ŸåŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥ä¸­æ–­ï¼ˆå¦‚é™¤ 0 é”™è¯¯ã€ç¼ºé¡µï¼‰ã€‚</li></ol><p>Linux ä¸­å¯¹äºä¸­æ–­çš„å“åº”å’Œå¤„ç†åˆ†æˆ<strong>ä¸ŠåŠéƒ¨</strong>å’Œ<strong>ä¸‹åŠéƒ¨</strong>ã€‚å…¶ä¸­ä¸ŠåŠéƒ¨ä¼šåœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·åå¿«é€Ÿå®Œæˆå¿…è¦å·¥ä½œçš„ï¼ˆæœ‰ä¸¥æ ¼çš„æ—¶é™ï¼‰ï¼Œè€Œæ›´åŠ ç¹é‡çš„ä»»åŠ¡åˆ™ä¼šåœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚åœ¨ä¸ŠåŠéƒ¨éœ€è¦å¿«é€Ÿæ‰§è¡Œï¼Œä¸”æ— æ³•ç¡çœ ï¼›ä½†ä¸‹åŠéƒ¨åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚</p><h2 id="æ— é¡»é‡å…¥"><a href="#æ— é¡»é‡å…¥" class="headerlink" title="æ— é¡»é‡å…¥"></a>æ— é¡»é‡å…¥</h2><p>Linux ä¸­çš„ä¸­æ–­å¤„ç†ä¸ç”¨è€ƒè™‘é‡å…¥ï¼Œå› ä¸ºå½“ç»™å®šä¸­æ–­å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œå¯¹åº”ä¸­æ–­çº¿åœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šè¢«å±è”½ï¼Œé¿å…åŒä¸€ä¸­æ–­çº¿æ¥æ”¶å¦å¤–çš„ä¸­æ–­ã€‚è¿™æ ·åšç®€åŒ–äº†ä¸­æ–­å¤„ç†ç¨‹åºçš„ç¼–å†™ã€‚</p><h2 id="ä¸­æ–­ä¸Šä¸‹æ–‡"><a href="#ä¸­æ–­ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸­æ–­ä¸Šä¸‹æ–‡"></a>ä¸­æ–­ä¸Šä¸‹æ–‡</h2><p>æ‰€è°“çš„ä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆinterrupt contextï¼‰ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚ä¸­æ–­ä¸Šä¸‹æ–‡å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡æ²¡æœ‰åŠæ¯›é’±å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œè¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œä¸€ç•ªå¯¹æ¯”ï¼š</p><table><thead><tr><th>ä¸­æ–­ä¸Šä¸‹æ–‡</th><th>è¿›ç¨‹ä¸Šä¸‹æ–‡</th></tr></thead><tbody><tr><td>æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡</td><td>å†…æ ¸ä»£è¡¨è¿›ç¨‹æ‰§è¡Œï¼ˆç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œå†…æ ¸çº¿ç¨‹ï¼‰æ—¶ï¼Œæ‰€å¤„çš„æ“ä½œæ¨¡å¼</td></tr><tr><td>ä¸è¿›ç¨‹æ— ç“œï¼Œä¸ current å®æ— ç“œ</td><td>å¯é€šè¿‡ current å®å…³è”å½“å‰è¿›ç¨‹</td></tr><tr><td>æ²¡æœ‰åå¤‡è¿›ç¨‹ï¼Œæ— æ³•ç¡çœ ï¼Œä¹Ÿä¸èƒ½è°ƒç”¨ä¼šå¯¼è‡´ç¡çœ çš„å‡½æ•°</td><td>å¯ç¡çœ ï¼Œå¯è°ƒç”¨è°ƒåº¦ç¨‹åº</td></tr><tr><td>æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶é™</td><td>æ²¡æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚</td></tr></tbody></table><h2 id="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"><a href="#ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ" class="headerlink" title="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"></a>ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ</h2><p>ä¸‹åŠéƒ¨å°±æ˜¯æ‰§è¡Œå’Œä¸­æ–­å¤„ç†ç›¸å…³ï¼Œä½†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºä¸­ä¸ä¼šæ‰§è¡Œçš„å·¥ä½œã€‚å¼•å…¥ä¸‹åŠéƒ¨çš„ç›®çš„å°±æ˜¯è®©ä¸­æ–­å¤„ç†ç¨‹åºå°½å¯èƒ½åœ°ç®€çŸ­ã€å¿«é€Ÿï¼Œé¿å…å±è”½ä¸­æ–­å¤ªä¹…ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å“åº”èƒ½åŠ›å’Œæ€§èƒ½å—åˆ°å½±å“ï¼›è€Œæ¯”è¾ƒç¹é‡çš„å·¥ä½œå¯ä»¥åœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚</p><p>ä¸‹åŠéƒ¨ä¸»è¦å®ç°æ–¹å¼ï¼š</p><ol><li><strong>è½¯ä¸­æ–­</strong><ol><li>å¯¹äºæ—¶é—´è¦æ±‚ä¸¥æ ¼ï¼Œä¸”èƒ½è‡ªå·±é«˜æ•ˆå®ŒæˆåŠ é”çš„å·¥ä½œï¼Œå¯ä½¿ç”¨è½¯ä¸­æ–­ï¼ˆå¦‚ç½‘ç»œã€SCSIï¼‰</li><li>è½¯ä¸­æ–­æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸å“åº”ä¸­æ–­ï¼Œä½†å®ƒè‡ªèº«<strong>ä¸èƒ½ç¡çœ </strong></li></ol></li><li><strong>tasklet</strong><ol><li>åŸºäºè½¯ä¸­æ–­å®ç°ï¼ŒåŒä¸€ä¸ªå¤„ç†ç¨‹åºçš„å¤šä¸ªå®ä¾‹ä¸èƒ½å†å¤šä¸ªå¤„ç†å™¨åŒæ—¶è¿è¡Œ</li><li>ç”¨é€”å¹¿æ³›ï¼Œæ¥å£ç®€å•ï¼Œæ€§èƒ½ä¸é”™</li><li>ä¸èƒ½ç¡çœ </li></ol></li><li><strong>å·¥ä½œé˜Ÿåˆ—</strong>ä¸­çš„å·¥ä½œå¯ä»¥äº¤ç»™å†…æ ¸çº¿ç¨‹æ¨åæ‰§è¡Œï¼ˆä¼šåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¼˜åŠ¿ï¼Œä¸”å¯ä»¥é‡æ–°è°ƒåº¦å’Œç¡çœ </li></ol><h1 id="å†…æ ¸åŒæ­¥"><a href="#å†…æ ¸åŒæ­¥" class="headerlink" title="å†…æ ¸åŒæ­¥"></a>å†…æ ¸åŒæ­¥</h1><p>åœ¨è¿›è¡Œå†…æ ¸ç¼–ç¨‹æ—¶ï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ä¸´ç•ŒåŒºï¼Œæ­£ç¡®åŠ é”ã€è§£é”ï¼Œä¿è¯å…³é”®æ•°æ®ç»“æ„ä¸è¢«é”™è¯¯ä¿®æ”¹ã€‚é‚£ä¹ˆæœ‰å“ªäº›æƒ…å†µèƒ½é€ æˆå¹¶å‘é—®é¢˜å‘¢ï¼Ÿ</p><ol><li><strong>ä¸­æ–­</strong>ï¼šå¼‚æ­¥å‘ç”Ÿï¼Œä¼šä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>è½¯ä¸­æ–­å’Œ tasklet</strong>ï¼šå†…æ ¸ä¼šåœ¨ä»»æ„æ—¶åˆ»å”¤é†’è½¯ä¸­æ–­å’Œ taskletï¼Œæ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>å†…æ ¸æŠ¢å </strong>ï¼šå†…æ ¸ä¸­çš„ä»»åŠ¡å¯èƒ½è¢«å…¶å®ƒä»»åŠ¡æŠ¢å </li><li><strong>ç¡çœ åŠä¸ç”¨æˆ·ç©ºé—´åŒæ­¥</strong>ï¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œçš„è¿›ç¨‹å¯èƒ½ä¼šç¡çœ ï¼Œä»è€Œå¯¼è‡´è°ƒåº¦ç¨‹åºè¢«å”¤é†’ï¼Œå¹¶è¿è¡Œæ–°çš„ç”¨æˆ·è¿›ç¨‹</li><li><strong>SMP</strong>ï¼šå¤šä¸ªå¤„ç†å™¨ä¼šå¹¶è¡Œæ‰§è¡Œ</li></ol><p><img src="https://pic3.zhimg.com/80/v2-de0df74c2c0f79723ab558d3b2727e71.png" alt=""></p><h1 id="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"><a href="#å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†" class="headerlink" title="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"></a>å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†</h1><p>å†…æ ¸éœ€è¦åœ¨ç¡¬ä»¶ï¼ˆRTC å’Œ Timerï¼‰çš„å¸®åŠ©ä¸‹æ‰èƒ½è®¡ç®—å’Œç®¡ç†æ—¶é—´ï¼Œå†…æ ¸é€šè¿‡<strong>å·²çŸ¥çš„</strong>ï¼ˆè¿™ä¸ªæ—¶é’Ÿå‘¨æœŸæ˜¯å¯ç¼–ç¨‹çš„ï¼Œå¯ç¡®å®šçš„ï¼‰æ—¶é’Ÿä¸­æ–­é—´éš”æ¥è®¡ç®— wall time å’Œ jiffiesï¼ˆç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ€»æ•°ï¼‰ã€‚é‚£ä¹ˆï¼Œåœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ç©¶ç«Ÿä¼šåšå“ªäº›å·¥ä½œå‘¢ï¼Ÿä»¥ä¸‹ç»™å‡ºä¸€äº›ä¼šå‘¨æœŸæ‰§è¡Œçš„å·¥ä½œï¼š</p><ol><li>æ›´æ–°ç³»ç»Ÿè¿è¡Œæ—¶é—´å’Œå®é™…æ—¶é—´</li><li>å¯¹äº SMP ç³»ç»Ÿï¼Œéœ€è¦å‡è¡¡å„å¤„ç†å™¨ä¸Šçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœè¿è¡Œé˜Ÿåˆ—è´Ÿè½½ä¸å‡è¡¡ï¼Œéœ€è¦å°½é‡è®©å®ƒä»¬å‡è¡¡</li><li>æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦ç”¨å°½äº†è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œå¦‚æœæ—¶ï¼Œåˆ™é‡æ–°è¿›è¡Œè°ƒåº¦</li><li>è¿è¡Œè¶…æ—¶çš„åŠ¨æ€å®šæ—¶å™¨</li><li>æ›´æ–°èµ„æºæ¶ˆè€—å’Œå¤„ç†å™¨æ—¶é—´ç»Ÿè®¡å€¼</li></ol><h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><h2 id="é¡µ"><a href="#é¡µ" class="headerlink" title="é¡µ"></a>é¡µ</h2><p>å†…æ ¸æ˜¯æŠŠç‰©ç†å†…å­˜åˆ†é¡µç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µï¼ˆpageï¼‰æ˜¯æœ€åŸºæœ¬çš„ç®¡ç†å•å…ƒã€‚MMU ä¹Ÿæ˜¯ä»¥é¡µå¤§å°ä¸ºå•ä½è½¬æ¢è™šæ‹Ÿåœ°å€åˆ°ç¡¬ä»¶åœ°å€çš„ã€‚ä¸åŒçš„ä½“ç³»ç»“æ„ï¼Œé¡µå¤§å°ä¸åŒï¼Œä¸€èˆ¬ 32 ä½ç³»ç»Ÿæ˜¯ 4KBï¼Œ64 ä½ç³»ç»Ÿæ˜¯ 8KBã€‚</p><h2 id="åŒº"><a href="#åŒº" class="headerlink" title="åŒº"></a>åŒº</h2><p>å› ä¸ºç¡¬ä»¶å­˜åœ¨é™åˆ¶ï¼Œå†…æ ¸æ— æ³•å¯¹æ‰€æœ‰çš„é¡µä¸€è§†åŒä»ã€‚å› æ­¤éœ€è¦æŠŠé¡µåˆ’åˆ†æˆä¸åŒçš„åŒºï¼ˆzoneï¼‰ï¼Œå†…æ ¸éœ€è¦å¤„ç†å¦‚ä¸‹å› ä¸ºç¡¬ä»¶ç¼ºé™·è€Œå¼•èµ·çš„å†…å­˜å¯»å€é—®é¢˜ï¼š</p><ol><li>ä¸€äº›ç¡¬ä»¶åªèƒ½ç”¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œ DMA æ“ä½œ</li><li>ä¸€äº›ä½“ç³»ç»“æ„çš„å†…å­˜ç‰©ç†å¯»å€èŒƒå›´æ¯”è™šæ‹Ÿåœ°å€èŒƒå›´å¤§</li></ol><p>å†…æ ¸çš„åˆ†åŒºæœ‰å››ç§ï¼š</p><ol><li><strong>ZONE_DMA</strong>ï¼šå¯æ‰§è¡Œ DMA æ“ä½œçš„é¡µé›†åˆ</li><li>ZONE_DMA32ï¼šåŒä¸Šï¼Œä½†ä»…é™äº 32 ä½è®¾å¤‡</li><li><strong>ZONE_NORMAL</strong>ï¼šèƒ½å¤Ÿæ­£å¸¸æ˜ å°„çš„é¡µ</li><li>ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­çš„é¡µä¸èƒ½æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼ˆè¿™é‡Œé™äº 32 ä½åœ°å€ç©ºé—´ï¼Œ64 ä½å°±ä¸ä¼šæœ‰é—®é¢˜äº†ï¼‰</li></ol><h2 id="é¡µç”³è¯·å’Œé‡Šæ”¾"><a href="#é¡µç”³è¯·å’Œé‡Šæ”¾" class="headerlink" title="é¡µç”³è¯·å’Œé‡Šæ”¾"></a>é¡µç”³è¯·å’Œé‡Šæ”¾</h2><ol><li><code>alloc_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘é¡µç»“æ„çš„æŒ‡é’ˆ</li><li><code>alloc_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­é¡µ</li><li><code>__get_free_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘å…¶é€»è¾‘åœ°å€çš„æŒ‡é’ˆ</li><li><code>__get_free_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­ç‰©ç†é¡µï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>get_zeroed_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œä¸”å¡«å…… 0 ï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>__free_pages(struct page *page, unsinged int order)</code></li><li><code>free_pages(unsigned long addr, unsinged int order)</code></li><li><code>free_page(unsigned long addr)</code></li></ol><h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p><code>void *kmalloc(size_t size, gfp_t flags)</code>ï¼Œ<code>kmalloc()</code> ç±»ä¼¼äº <code>malloc()</code>ï¼Œå¯ä»¥è·å¾—æŒ‡å®šå­—èŠ‚å¤§å°çš„å†…æ ¸å†…å­˜ï¼Œå®ƒåˆ†é…å¾—åˆ°çš„é¡µçš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯è¿ç»­çš„ã€‚<br><code>void kfree(const void *ptr)</code> é‡Šæ”¾åˆ†é…çš„å†…å­˜ç©ºé—´</p><p>å…³äºæ ‡è®°ä½ï¼Œå¸¸ç”¨çš„æ˜¯ GFP_KERNELï¼Œå…è®¸ç¡çœ ï¼Œç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ç©ºé—´ï¼›å¦å¤–çš„ GFP_ATOMICï¼Œåˆ™ä¸å¯ä»¥ç¡çœ ï¼Œå¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ã€ä¸­æ–­å¤„ç†ç¨‹åºã€è½¯ä¸­æ–­ã€taskletã€‚</p><h2 id="vmalloc"><a href="#vmalloc" class="headerlink" title="vmalloc"></a>vmalloc</h2><p><code>vmalloc()</code> ç±»ä¼¼ <code>kmalloc()</code>ï¼Œä¸åŒçš„æ˜¯ï¼Œå®ƒåˆ†é…çš„å†…å­˜è™šæ‹Ÿåœ°å€è™½ç„¶æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å®é™…çš„ç‰©ç†åœ°å€æ— éœ€è¿ç»­ã€‚å®ƒé€šè¿‡åˆ†é…éè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†ã€Œä¿®æ­£ã€é¡µè¡¨ï¼Œä»è€ŒæŠŠå†…å­˜æ˜ å°„åˆ°é€»è¾‘åœ°å€ç©ºé—´è¿ç»­çš„åŒºåŸŸã€‚å®ƒéœ€è¦ä¸“é—¨çš„é¡µè¡¨æ¥å®Œæˆè¿ç»­è™šæ‹Ÿåœ°å€åˆ°å®é™…éè¿ç»­ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œå¼€é”€è¾ƒå¤§ï¼Œä¸”å®¹æ˜“å¼•èµ· TLB æŠ–åŠ¨ï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­æ›´å€¾å‘äºä½¿ç”¨ <code>kmalloc()</code>ã€‚</p><h2 id="slab-å±‚"><a href="#slab-å±‚" class="headerlink" title="slab å±‚"></a>slab å±‚</h2><p>slab å±‚å……å½“é€šç”¨æ•°æ®ç»“æ„çš„ç¼“å­˜å±‚çš„è§’è‰²ï¼Œå®ƒä¼šä¸ºä¸åŒçš„å¯¹è±¡åˆ’åˆ†æˆä¸åŒçš„é«˜é€Ÿç¼“å­˜ç»„ï¼Œæ¯ç»„å­˜æ”¾ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œå­˜æ”¾ task_struct å’Œ inode å°±åˆ†å±äºä¸åŒçš„ç»„ã€‚kmalloc() ä¹Ÿæ˜¯åŸºäº slab å±‚ä¹‹ä¸Šï¼Œä½¿ç”¨äº†ä¸€ç»„é€šç”¨é«˜é€Ÿç¼“å­˜ã€‚</p><p>slab åˆ†é…å™¨å¼•å…¥çš„ç›®çš„ï¼š</p><ol><li>é¿å…é¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡éœ€è¦é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾ï¼Œé™ä½å¼€é”€</li><li>é¢‘ç¹åˆ†é…å›æ”¶å®¹æ˜“å¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œå‡å°‘ç¢ç‰‡é—®é¢˜</li><li>æé«˜æ€§èƒ½</li><li>éƒ¨åˆ†ç¼“å­˜ä¸“å±äºæŸä¸ªå¤„ç†å™¨æ—¶ï¼Œå¯ä»¥å®ç°æ— é”åˆ†é…å’Œé‡Šæ”¾ï¼ˆtcmallocï¼‰</li></ol><p><img src="https://pic1.zhimg.com/80/v2-1540217805cb1d2ee083d293209bbbaf_r.png" alt=""></p><h1 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰" class="headerlink" title="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"></a>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</h1><p>VFS æ˜¯ Linux æä¾›çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼Œæ¶µç›–äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¸¸ç”¨åŠŸèƒ½é›†å’Œè¡Œä¸ºï¼Œä»è€Œæ”¯æŒå„ç§å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NTFS, FAT, EXT4ï¼‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ç©ºé—´ write() -&gt; VFS sys_write() -&gt; æ–‡ä»¶ç³»ç»Ÿçš„å†™æ–¹æ³• -&gt; å­˜å‚¨è®¾å¤‡</span><br></pre></td></tr></table></figure></p><p>Unix æ–‡ä»¶ç³»ç»Ÿä¼ ç»ŸæŠ½è±¡æ¦‚å¿µï¼šFile, DirectoryEntry, Index Node å’Œ Mount Pointã€‚Unix æ–‡ä»¶çš„ç‰¹ç‚¹æ˜¯é¢å‘å­—èŠ‚æµæŠ½è±¡è®¾è®¡çš„ï¼Œå…·æœ‰ç®€å•ã€çµæ´»çš„ç‰¹æ€§ã€‚åœ¨ Unix ä¸­ï¼Œç›®å½•ä¹Ÿæ˜¯æ™®é€šæ–‡ä»¶ï¼Œå…¶åˆ—å‡ºäº†åŒ…å«åœ¨ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ã€‚</p><p>VFS ä¸­çš„ä¸»è¦å¯¹è±¡ï¼š</p><ol><li>è¶…çº§å—å¯¹è±¡ï¼Œä»£è¡¨å…·ä½“å·²å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶</li><li>ç›®å½•é¡¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ†</li><li>æ–‡ä»¶å¯¹è±¡ï¼Œä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼ˆå…¶å®å®ƒä¼šæŒ‡å‘ç›®å½•é¡¹å¯¹è±¡ï¼Œè€Œç›®å½•é¡¹å¯¹è±¡æ‰æ˜¯çœŸæ­£è¡¨ç¤ºå·²æ‰“å¼€çš„å®é™…æ–‡ä»¶ï¼Œå› ä¸ºå…¶ä¸­åŒ…å«äº†æŒ‡å‘ inode çš„æŒ‡é’ˆï¼‰</li></ol><h1 id="å—-I-O"><a href="#å—-I-O" class="headerlink" title="å— I/O"></a>å— I/O</h1><p>Linux ä¸­ï¼Œè®¾å¤‡åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li><strong>å—è®¾å¤‡</strong>ï¼šæ”¯æŒéšæœºè®¿é—®å›ºå®šå¤§å°çš„æ•°æ®å—ï¼Œå¦‚ç¡¬ç›˜ã€é—ªå­˜</li><li><strong>å­—ç¬¦è®¾å¤‡</strong>ï¼šä»¥å­—ç¬¦æµçš„å½¢å¼è¢«è®¿é—®ï¼Œå¦‚é”®ç›˜</li><li><strong>ç½‘ç»œè®¾å¤‡</strong></li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹å—è®¾å¤‡çš„è¯·æ±‚ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·åœ¨ I/O è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå¹¶ä¸”ç”± I/O è°ƒåº¦ç¨‹åºæ¥ç®¡ç†è¯·æ±‚é˜Ÿåˆ—ã€‚å®ƒä¼šå†³å®šè¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚<strong>å¦‚ä½•æ’åº</strong>ï¼Œä»¥åŠ<strong>ä½•æ—¶</strong>å‘é€åˆ°å…·ä½“çš„å—è®¾å¤‡ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œå°±æ˜¯æœŸæœ›å€ŸåŠ© I/O è°ƒåº¦ç¨‹åºï¼Œå¯¹è¯·æ±‚è¿›è¡Œ<strong>åˆå¹¶</strong>å’Œ<strong>æ’åº</strong>ï¼Œä»è€Œæœ‰æ•ˆæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼ˆä¹Ÿå¯èƒ½é€ æˆæŸäº›è¯·æ±‚å¾—ä¸åˆ°å…¬å¹³å¯¹å¾…ï¼Œç”šè‡³å‡ºç°é¥¥é¥¿çš„æƒ…å†µï¼‰ã€‚ä»¥ä¸‹è®°å½•çš„æ˜¯ Linux ä¸­å·²ç»å®ç°çš„å‡ ç§ I/O è°ƒåº¦ç®—æ³•ï¼š</p><ol><li><p><strong>Linus ç”µæ¢¯</strong></p><ol><li>æ”¯æŒå‘å‰å’Œå‘ååˆå¹¶ï¼ˆé€šå¸¸éƒ½æ˜¯è¿™ç§å±…å¤šï¼‰</li><li>æœ‰è¾ƒå¥½çš„å…¨å±€ååé‡</li><li>ä¼šå‘ç”Ÿè¯·æ±‚é¥¥é¥¿é—®é¢˜</li></ol></li><li><p><strong>æœ€ç»ˆæœŸé™ï¼ˆdeadlineï¼‰ I/O è°ƒåº¦</strong></p><ol><li>é™ä½äº†ç³»ç»Ÿçš„å…¨å±€ååé‡</li><li>è¯»è¯·æ±‚è¶…æ—¶ 500msï¼Œå†™è¯·æ±‚è¶…æ—¶ 5sï¼Œè¶…æ—¶å¿…ç„¶å¾—åˆ°æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´é¥¥é¥¿çš„é—®é¢˜</li></ol></li><li><p><strong>é¢„æµ‹ï¼ˆanticipatoryï¼‰ I/O è°ƒåº¦</strong></p><ol><li>ç›®æ ‡æ˜¯ä¿æŒè¾ƒå¥½çš„è¯»å“åº”åŒæ—¶ï¼Œæä¾›è‰¯å¥½çš„å…¨å±€ååé‡ã€‚è§†å›¾å‡å°‘åœ¨è¿›è¡Œ I/O æ“ä½œæœŸé—´ï¼Œå¤„ç†æ–°åˆ°çš„è¯»è¯·æ±‚å¸¦æ¥çš„å¯»å€æ•°é‡</li><li>è¯·æ±‚æäº¤åä¸ä¼šç›´æ¥è¿”å›å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œè€Œä¼šç©ºé—²ç‰‡åˆ»ï¼ˆå‡ æ¯«ç§’ï¼‰ï¼Œç­‰å¾…åº”ç”¨æäº¤å…¶å®ƒè¯»è¯·æ±‚</li></ol></li><li><p><strong>å®Œå…¨å…¬å¹³æ’é˜Ÿ I/O è°ƒåº¦ï¼ˆCFQï¼‰</strong></p><ol><li>ä¸ºç‰¹æ®Šå·¥ä½œè´Ÿè½½çš„åœºæ™¯è®¾è®¡ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è¯·æ±‚é˜Ÿåˆ—</li><li>ä»¥æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚</li></ol></li></ol><h1 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h1><p>ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡é‡‡ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œç»™æ¯ä¸ªè¿›ç¨‹è¥é€ äº†ç‹¬äº«å†…å­˜çš„å‡è±¡ï¼Œè¿™æ˜¯å†…å­˜è™šæ‹ŸåŒ–çš„é‡è¦æœºåˆ¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°ä»£é‡‡ç”¨è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿé€šå¸¸éƒ½ä½¿ç”¨å¹³å¦åœ°å€ç©ºé—´ï¼Œè€Œéåˆ†æ®µå¼çš„å†…å­˜æ¨¡å¼ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å­˜åœ°å€ç©ºé—´ä¼šæ ¹æ®éœ€è¦åˆ’åˆ†æˆä¸åŒçš„åŒºåŸŸã€‚å†…æ ¸å¯ä»¥ç»™è¿›ç¨‹åœ°å€ç©ºé—´åŠ¨æ€æ·»åŠ æˆ–å‡å°‘å†…å­˜åŒºåŸŸã€‚æ¯ä¸ªè¿›ç¨‹åªèƒ½è®¿é—®æœ‰æ•ˆå†…å­˜åŒºåŸŸå†…çš„å†…å­˜åœ°å€ï¼Œæ¯ä¸ªå†…å­˜åŒºåŸŸä¼šåŒ…å«æƒé™ç­‰å±æ€§ã€‚<strong>è¿›ç¨‹ä¸­ä»»æ„æœ‰æ•ˆåœ°å€åªèƒ½ä½äºå”¯ä¸€çš„åŒºåŸŸï¼Œä¸”è¿™äº›åŒºåŸŸä¸èƒ½ç›¸äº’è¦†ç›–</strong>ã€‚</p><p>å†…å­˜åŒºåŸŸå¯ä»¥åŒ…å«å„ç§å†…å­˜å¯¹è±¡ï¼š</p><ol><li>å¯æ‰§è¡Œæ–‡ä»¶ä»£ç çš„å†…å­˜æ˜ å°„ï¼Œtext section</li><li>å¯æ‰§è¡Œæ–‡ä»¶å·²åˆå§‹åŒ–å…¨å±€å˜é‡çš„å†…å­˜æ˜ å°„ï¼Œdata section</li><li>åŒ…å«æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒBSS æ®µçš„é›¶é¡µçš„å†…å­˜æ˜ å°„</li><li>è¿›ç¨‹ç”¨æˆ·ç©ºé—´æ ˆçš„é›¶é¡µå†…å­˜æ˜ å°„</li><li>æ¯ä¸ªä¸€ä¸ªè¯¸å¦‚ C åº“æˆ–åŠ¨æ€è¿æ¥ç¨‹åºç­‰å…±äº«çš„  text section, data section å’Œ bss ä¹Ÿè¢«è½½å…¥åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</li><li>å†…å­˜æ˜ å°„æ–‡ä»¶</li><li>å…±äº«å†…å­˜æ®µ</li><li>åŒ¿åæ˜ å°„ï¼Œå¦‚ malloc() åˆ†é…çš„å†…å­˜</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm_struct -&gt; vm_area_struct</span><br></pre></td></tr></table></figure><h2 id="64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"><a href="#64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€" class="headerlink" title="64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"></a>64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€</h2><p><img src="https://pic4.zhimg.com/80/v2-5f2b9c321b7100a11e2dae9e48bce81f_r.png" alt=""><br>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ 64bit çš„åœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨ä¸€åŠçš„åœ°å€ç©ºé—´ï¼ˆ128 TiBï¼‰ï¼Œè€Œå¦ä¸€åŠåˆ™æ˜¯å†…æ ¸ç©ºé—´ä½¿ç”¨ã€‚å†…æ ¸é€šå¸¸é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šè¢«æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å½“ä¸­ã€‚è€Œåœ¨å†…æ ¸ä¸­ï¼Œæ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚è¯¦ç»†çš„å†…å­˜å¸ƒå±€å¯ä»¥å‚è€ƒåé¢çš„å­¦ä¹ èµ„æ–™~</p><h2 id="é¡µè¡¨"><a href="#é¡µè¡¨" class="headerlink" title="é¡µè¡¨"></a>é¡µè¡¨</h2><p>Linux ä¸­ä½¿ç”¨ä¸‰çº§é¡µè¡¨å®Œæˆåœ°å€è½¬æ¢ï¼Œä½¿ç”¨å¤šçº§é¡µè¡¨å¯ä»¥èŠ‚çº¦åœ°å€è½¬æ¢éœ€è¦å ç”¨çš„ç©ºé—´ã€‚ä½†ç”±äºå®Œæˆè™šæ‹Ÿé¡µåœ°å€åˆ°ç‰©ç†é¡µåœ°å€è½¬æ¢éƒ½éœ€è¦åœ¨ä¸‰çº§é¡µè¡¨ä¸­æŸ¥æ‰¾åˆ°æ˜ å°„ï¼Œå¼€é”€æ¯”è¾ƒé«˜ã€‚æ‰€ä»¥å¾ˆå¤šä½“ç³»ç»“æ„æä¾›äº† TLB ä½œä¸ºåœ°å€æ˜ å°„çš„ç¡¬ä»¶ç¼“å­˜ã€‚<br><img src="https://pic4.zhimg.com/80/v2-e7ae1f0fcc4b3a1d0af4e65a1ca04101_r.png" alt=""><br><img src="https://pic4.zhimg.com/80/v2-ff24fef84f1c136922f8bf1f5679ea99_hd.png" alt=""></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»ä½“ä¸Šæ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯æ¯”è¾ƒé€‚åˆå¯¹æ“ä½œç³»ç»ŸåŸºæœ¬æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¸”å¯¹äº Linux å†…æ ¸ä¹Ÿæœ‰ä¸€ç‚¹äº†è§£çš„å‰æä¸‹é˜…è¯»ï¼Œå¦åˆ™åœ¨çœ‹åˆ°ä¸€äº›æ¦‚å¿µçš„æ—¶å€™ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ¯”å¦‚å¯¹äºè¿›ç¨‹ã€çº¿ç¨‹çš„æŠ½è±¡å®šä¹‰ï¼Œè™šæ‹Ÿå†…å­˜ä¸­è®²åˆ°çš„åˆ†é¡µã€åˆ†æ®µæ¦‚å¿µä»¥åŠå¤šçº§é¡µè¡¨çš„æ¦‚å¿µã€‚å¦å¤–ï¼Œå¯¹äºå¸¸ç”¨æ•°æ®ç»“æ„éœ€è¦æœ‰æ¸…æ™°çš„è®¤è¯†ï¼›å¹¶å‘ç›¸å…³çš„åŒæ­¥é—®é¢˜ä¹Ÿæœ‰äº†è§£ã€‚<br>è™½ç„¶æ•´æœ¬ä¹¦æ˜¯åŸºäº Linux 2.6.3x å†…æ ¸ä¸ºåŸºç¡€çš„ï¼Œå¦‚ä»Šçš„ Linux å†…æ ¸å·²ç»å‘å±•åˆ° 5.x æ—¶ä»£äº†ï¼Œè¿™æœŸé—´å˜åŒ–è‚¯å®šæœ‰å¾ˆå¤šã€‚ä½†è¿™æœ¬ä¹¦çš„ä»·å€¼è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå…¶ä¸­è®²å¾—å¾ˆå¤šæ€æƒ³ã€æ–¹æ³•ä¾ç„¶å®ç”¨ï¼Œå¯ä»¥å˜é€šåœ°å»çœ‹å¾…å’Œç†è§£ã€‚</p><h1 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h1><ol><li>POSIX: Portable Operating System Interface</li><li>TLB: Translation Lookup Buffer</li><li>CFS: Complete Fair Scheduler</li><li>CFQ: Complete Fair Queueingï¼Œè¿™ä¸ªæ˜¯ IO è°ƒåº¦å™¨ä¹‹ä¸€</li><li>VFS: Virtual File System</li><li>VMA: Virtual Memory Area</li><li>MMU: Memory Map Unit</li><li>jiffies: Linux ä¸­ç”¨æ¥è®°å½•ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ•°çš„å…¨å±€å˜é‡ï¼Œè¿˜æœ‰ä¸€ä¸ª jiffies_64</li><li>ISR: Interrupt Service Routine</li></ol><h1 id="æ·±å…¥å­¦ä¹ "><a href="#æ·±å…¥å­¦ä¹ " class="headerlink" title="æ·±å…¥å­¦ä¹ "></a>æ·±å…¥å­¦ä¹ </h1><ul><li>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç° Linux Kernel Developmentï¼Œç¬¬ 3 ç‰ˆã€‹</li><li><a href="https://unix.stackexchange.com/questions/364660/are-threads-implemented-as-processes-on-linux" target="_blank" rel="noopener">Are Threads Implemented As Processes on Linux</a></li><li><a href="https://zh.wikipedia.org/wiki/POSIX%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">POSIX çº¿ç¨‹</a></li><li><a href="https://juejin.im/post/5d23326d6fb9a07efe2de11e" target="_blank" rel="noopener">Linux çº¿ç¨‹å®ç°</a></li><li><a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux Sched Doc CFS</a></li><li><a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a></li><li><a href="https://www.win.tue.nl/~aeb/linux/lk/lk-9.html" target="_blank" rel="noopener">Linux Memory</a></li><li><a href="https://www.it.iitb.ac.in/frg/wiki/images/f/fc/113050076_Rajesh_Prodduturi_week5_presentation_3_2012-08-04.pdf" target="_blank" rel="noopener">Linux memory management</a></li><li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">x86_64 å†…å­˜æ˜ å°„</a></li><li><a href="https://simonis.github.io/Memory/" target="_blank" rel="noopener">The Memory Layout of a 64-bit Linux Process</a></li><li><a href="https://stackoverflow.com/questions/55443733/linux-kernel-memory-layout" target="_blank" rel="noopener">Linux kernel memory layout</a></li><li><a href="https://www.kernel.org/doc/gorman/html/understand/understand006.html" target="_blank" rel="noopener">Chapter 3 Page Table Management</a></li><li><a href="https://ifaceless.space/2019/11/18/linux-kernel-scheduler-papers/">Linux è°ƒåº¦å™¨èµ„æ–™æ•´ç†</a></li><li><a href="https://makelinux.github.io/kernel_map/" target="_blank" rel="noopener">Linux Kernel Map</a></li><li><a href="https://hackernoon.com/entering-god-mode-the-kernel-space-mirroring-attack-8a86b749545f" target="_blank" rel="noopener">Entering God Mode â€” The Kernel Space Mirroring Attack</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æŠ½æ—¶é—´æŠŠ &lt;a href=&quot;http://pages.cs.wisc.edu/~remzi/OSTEP/&quot; target=&quot;_blank
      
    
    </summary>
    
      <category term="Linux" scheme="http://ifaceless.space/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://ifaceless.space/tags/Linux/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="http://ifaceless.space/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="http://ifaceless.space/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://ifaceless.space/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
      <category term="æ–‡ä»¶ç³»ç»Ÿ" scheme="http://ifaceless.space/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Go ç¼–å†™å§¿åŠ¿</title>
    <link href="http://ifaceless.space/2019/10/29/golang-traps/"/>
    <id>http://ifaceless.space/2019/10/29/golang-traps/</id>
    <published>2019-10-29T13:44:19.000Z</published>
    <updated>2019-11-24T09:45:59.948Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinterface å¯ä»¥ç›´æ¥è¿›è¡Œå€¼ä¼ é€’ï¼Œé™¤éä½ éœ€è¦ä¿®æ”¹ interface æŒ‡å‘çš„æ•°æ®ã€‚interface æœ¬èº«å¾ˆè½»é‡ï¼Œå…¶åŒ…æ‹¬æŒ‡å‘æ•°æ®ç±»å‹çš„æŒ‡é’ˆå’Œå­˜å‚¨æ•°æ®çš„æŒ‡é’ˆã€‚</li><li>Value Receiver æ–¹æ³•å¯ä»¥é€šè¿‡å€¼æˆ–è€…æŒ‡é’ˆè°ƒç”¨ï¼›Pointer Receiver åˆ™åªæ¥å—æŒ‡é’ˆè°ƒç”¨ã€‚æ¢å¥è¯è¯´ï¼ŒæŒ‡é’ˆè°ƒç”¨æ–¹æ³•æ›´åŠ è½»æ¾ï¼Œé™åˆ¶æ›´å°‘ã€‚</li><li>Mutex å’Œ RWMutex å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶é›¶å€¼ï¼Œé›¶å€¼è¡¨ç¤º Unlock çŠ¶æ€ã€‚å·²ç»è¢«ä½¿ç”¨çš„ Mutex ä¸èƒ½è¢«æ‹·è´ã€‚</li><li><p>å¯¹äº Map &amp; Sliceï¼Œéœ€è¦æ³¨æ„å…¶ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå—åˆ°å¤–ç•Œæ“ä½œçš„å½±å“ã€‚ å®‰å…¨çš„åšæ³•æ˜¯åœ¨å†…éƒ¨åšä¸€æ¬¡æ‹·è´ï¼Œå†…éƒ¨å¯å®‰å…¨ä½¿ç”¨ã€‚</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d.trips = <span class="built_in">make</span>([]Trip, <span class="built_in">len</span>(trips))</span><br><span class="line"><span class="built_in">copy</span>(d.trips, trips)</span><br></pre></td></tr></table></figure></li><li><p>Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ï¼ˆè¿™ä¸ªè¿˜æ˜¯è¦çœ‹æƒ…å†µå§ï¼‰</p></li><li>å¸¸è§„æƒ…å†µä¸‹ï¼Œæšä¸¾ä» 1 å¼€å§‹è®¡æ•°ï¼›é™¤é 0 æ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚å¦‚ï¼š<code>LogToStdout = 0</code></li><li><p>ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯è¦å°å¿ƒï¼Œæœ€å¥½<strong>åªå…¬å¼€é”™è¯¯åŒ¹é…å™¨</strong>ï¼Œæ–¹ä¾¿è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼š</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> errNotFound <span class="keyword">struct</span> &#123;</span><br><span class="line">file <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e errNotFound)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">"file %q not found"</span>, e.file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsNotFoundError</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">_, ok := err.(errNotFound)</span><br><span class="line"><span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆç†ä½¿ç”¨ Error Wrappingï¼Œä¸ç”¨æ·»åŠ è¿‡å¤šå†—ä½™ä¿¡æ¯ï¼Œå¦‚ï¼š<code>failed to : error message</code>ã€‚</p></li><li>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿è¡Œçš„ç¨‹åºé¿å… panicï¼Œpanic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œè€Œæ˜¯å½“ä¸å¯æ¢å¤çš„äº‹æƒ…å‘ç”Ÿæ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚</li><li>ä½¿ç”¨ <a href="https://godoc.org/go.uber.org/atomic" target="_blank" rel="noopener">go.uber.org/atomic</a> æ›¿ä»£æ ‡å‡†åº“ <code>sync/atomic</code>ï¼Œé¿å…å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œã€‚</li><li><code>import _</code> åº”è¯¥åªç”¨äº <code>main</code> æ–‡ä»¶ä¸­ï¼Œå°½å¯èƒ½é è¿‘ç¨‹åºå¯åŠ¨ä½ç½®ã€‚</li></ul><h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><ul><li>ä¼˜å…ˆä½¿ç”¨ <code>strconv</code> è€Œé <code>fmt</code> è½¬æ¢ç±»å‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚</li><li>ä¸è¦åå¤ï¼ˆå¦‚å¾ªç¯ä¸­ï¼‰ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceï¼Œåä¹‹äº¦ç„¶ã€‚</li><li>map åˆ›å»ºæ—¶å°½é‡æä¾›å®¹é‡ hintï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ·»åŠ å…ƒç´ æœŸé—´è¿‡å¤šæ¬¡åœ°åˆ†é…ã€‚map è™½ç„¶ä¸èƒ½ä¿è¯åˆ†é… hint ä¸ªå®¹é‡ï¼Œæ·»åŠ å…ƒç´ æ—¶ä¾ç„¶å¯ä»¥è¿›è¡Œåˆ†é…ï¼Œä½†å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶æœ‰æ›´å°‘çš„åˆ†é…ã€‚</li></ul><h2 id="è§„èŒƒ"><a href="#è§„èŒƒ" class="headerlink" title="è§„èŒƒ"></a>è§„èŒƒ</h2><ol><li>ä¿è¯ä¸€è‡´æ€§ï¼Œä¾¿äºä»£ç çš„ç»´æŠ¤ã€å‡å°‘å­¦ä¹ æˆæœ¬</li><li>ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªåˆ†ç»„ï¼ˆimport/var/const/typeï¼‰ã€‚ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åˆ°ä¸€èµ·ï¼</li><li>åŒ…å‘½åè§„åˆ™ï¼š<ol><li>å…¨éƒ¨å°å†™ã€‚æ— å¤§å†™æˆ–ä¸‹åˆ’çº¿</li><li>å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œæ— éœ€é‡å‘½ååŒ…</li><li>ç®€çŸ­ &amp; ç®€æ´</li><li>ä¸è¦ä½¿ç”¨å¤æ•°</li></ol></li><li>å‡½æ•°åˆ†ç»„ä¸é¡ºåºï¼š<ol><li>å‡½æ•°ç²—ç•¥æŒ‰ç…§è°ƒç”¨é¡ºåºæ’åº</li><li>åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå‡½æ•°åº”è¯¥æŒ‰ç…§æ¥æ”¶è€…åˆ†ç»„</li><li>å¯¼å‡ºçš„å‡½æ•°åº”è¯¥å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨ <code>var</code>, <code>struct</code>, <code>const</code> å®šä¹‰çš„åé¢</li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> something <span class="keyword">struct</span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSomething</span><span class="params">()</span> *<span class="title">something</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;something&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Cost</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> calcCost(s.weights)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *something)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcCost</span><span class="params">(n []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;...&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨ <code>_</code> ä½œä¸ºå‰ç¼€</strong>ã€‚æœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œä½¿ç”¨ <code>err</code> å¼€å¤´ã€‚åŸå› ï¼šé¡¶å±‚å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸï¼Œä½¿ç”¨é€šç”¨åç§°å¯èƒ½ä¼šå¯¼è‡´åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯å€¼ã€‚</li><li>ç»“æ„ä½“åµŒå…¥ï¼Œå¤šä¸€è¡Œç©ºè¡Œéš”å¼€</li><li><p><code>nil</code> æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ sliceï¼›<strong>é›¶å€¼åˆ‡ç‰‡ï¼ˆä½¿ç”¨ <code>var</code> å£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨ <code>make()</code> åˆ›å»ºã€‚</strong></p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nums []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">if</span> add1 &#123;</span><br><span class="line">nums = <span class="built_in">append</span>(nums, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> add2 &#123;</span><br><span class="line">nums = <span class="built_in">append</span>(nums, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœè¦å£°æ˜æ ¼å¼å­—ç¬¦ä¸²ï¼Œè®¾ç½®ä¸º <code>const</code> ç±»å‹ï¼Œæœ‰åŠ©äº <code>go vet</code> æ‰§è¡Œå­—ç¬¦ä¸²é™æ€æ£€æŸ¥ï¼š</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> msg = <span class="string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li></ul><h1 id="æ›´å¤šå‚è€ƒ"><a href="#æ›´å¤šå‚è€ƒ" class="headerlink" title="æ›´å¤šå‚è€ƒ"></a>æ›´å¤šå‚è€ƒ</h1><ul><li><a href="https://github.com/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener">Uber Go Guide</a></li><li><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener">The Go common mistakes guide</a></li><li><a href="https://www.kancloud.cn/kancloud/effective/72199" target="_blank" rel="noopener">Effective ä¸­æ–‡ç‰ˆ</a></li><li><a href="https://golang.org/doc/effective_go.html#pointers_vs_values" target="_blank" rel="noopener">Pointers v.s. Values</a></li><li><a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" target="_blank" rel="noopener">Donâ€™t just checked errors, handle them gracefully</a></li><li><a href="https://blog.golang.org/package-names" target="_blank" rel="noopener">Package Names</a></li><li><a href="https://rakyll.org/style-packages/" target="_blank" rel="noopener">Go åŒ…æ ·å¼æŒ‡å—</a></li><li><a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html" target="_blank" rel="noopener">Self-referential functions and the design of options</a></li><li><a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis" target="_blank" rel="noopener">Functional options for friendly APIs</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œinterface å¯ä»¥ç›´æ¥è¿›è¡Œå€¼ä¼ é€’ï¼Œé™¤éä½ éœ€è¦ä¿®æ”¹ interface æŒ‡å‘çš„æ•°æ®ã€‚interface æœ¬èº«å¾ˆè½»é‡ï¼Œå…¶åŒ…æ‹¬æŒ‡å‘æ•°æ®ç±»å‹çš„æŒ‡é’ˆå’Œå­˜å‚¨æ•°æ®çš„æŒ‡é’ˆã€‚&lt;/li&gt;
&lt;li&gt;Value Receiver æ–¹æ³•å¯ä»¥é€šè¿‡å€¼æˆ–è€…æŒ‡é’ˆè°ƒç”¨ï¼›Point
      
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="å‘" scheme="http://ifaceless.space/tags/%E5%9D%91/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹äº‹åŠ¡</title>
    <link href="http://ifaceless.space/2019/08/24/ddia-transaction/"/>
    <id>http://ifaceless.space/2019/08/24/ddia-transaction/</id>
    <published>2019-08-24T03:37:50.000Z</published>
    <updated>2019-11-24T09:45:59.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ç”±äºæ•°æ®å­˜å‚¨æœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿé”™è¯¯ã€æ•…éšœçš„ç‚¹ç‰¹åˆ«å¤šï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€ç£ç›˜å†™æ»¡ç­‰ï¼Œé¢å¯¹è¿™äº›å¤æ‚çš„æƒ…å†µï¼Œåº”ç”¨å±‚åº”ä»˜èµ·æ¥éå¸¸å›°éš¾ã€‚æ‰€ä»¥å°±æœ‰äº†äº‹åŠ¡çš„æ¦‚å¿µï¼Œè¯´é“äº‹åŠ¡ï¼Œæˆ‘ä»¬æœ€å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šå¯ä»¥ä¸€æ¬¡äº‹åŠ¡ä¸­å°†å¾ˆå¤šè¯»å†™å…¥æ“ä½œæ‰“åŒ…æˆä¸€ä¸ªé€»è¾‘æ“ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æˆåŠŸï¼ˆCommittedï¼‰ä¾¿æˆä»ï¼ˆRollbackï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æƒ…å†µå®‰å…¨åœ°é‡è¯•ï¼Œä¸ç”¨æ‹…å¿ƒéƒ¨åˆ†å†™å…¥çš„é—®é¢˜ã€‚</p><a id="more"></a><p>æ€»çš„æ¥è¯´ï¼Œäº‹åŠ¡å°±æ˜¯ä¸€å±‚æŠ½è±¡ï¼Œä¸ºç®€åŒ–åº”ç”¨å±‚ç¼–ç¨‹æ¨¡å‹è€Œç”Ÿï¼å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰çš„æ•°æ®åº“éƒ½æ”¯æŒäº‹åŠ¡ï¼Œä½†æ˜¯å¯¹å…³ç³»å‹æ•°æ®åº“è€Œè¨€ï¼Œè¿™ä¸ªåŸºæœ¬æ˜¯æ ‡é…ï¼›æŸäº› NoSQL æ•°æ®åº“å¯èƒ½å› ä¸ºæ€§èƒ½ã€å¯ç”¨æ€§ä»¥åŠæ‰©å±•æ€§è€ƒè™‘ï¼Œè€Œæ”¾å¼ƒäº†å¯¹äº‹åŠ¡çš„æ”¯æŒã€‚å¦å¤–ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸‹ï¼Œäº‹åŠ¡çš„å®ç°ä¼šæ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”æ‰§è¡Œå¼€é”€ä¹Ÿå¾ˆå¤§ï¼Œä½†å¹¶ä¸ä»£è¡¨å®ƒä¸èƒ½å®ç°ã€‚å…¸å‹çš„ åˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“å¦‚ TiDB ä»¥åŠ Google Spanner å°±æä¾›äº†äº‹åŠ¡æ”¯æŒã€‚</p><h1 id="æ·±å…¥ç†è§£-ACID"><a href="#æ·±å…¥ç†è§£-ACID" class="headerlink" title="æ·±å…¥ç†è§£ ACID"></a>æ·±å…¥ç†è§£ ACID</h1><ol><li><strong>Atomicityï¼ˆåŸå­æ€§ï¼‰</strong>ï¼šå°†å¤šä¸ªå†™æ“ä½œçº³å…¥ä¸€ä¸ªåŸå­äº‹åŠ¡ä¸­ï¼Œå¹¶åœ¨æ•…éšœï¼ˆè¿›ç¨‹å´©æºƒã€ç½‘ç»œä¸­æ–­ã€ç£ç›˜æ•…éšœï¼‰å‘ç”Ÿæ—¶èƒ½å¤ŸåŠæ—¶ä¸­æ­¢äº‹åŠ¡ï¼Œå¹¶å°†éƒ¨åˆ†å®Œæˆçš„å†™å…¥å…¨éƒ¨ä¸¢å¼ƒã€‚</li><li><p><strong>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</strong>ï¼š</p><ol><li>å¯¹æ•°æ®æœ‰ç‰¹å®šçš„çŠ¶æ€é¢„æœŸï¼Œä»»ä½•æ•°æ®å˜æ›´å¿…é¡»æ»¡è¶³è¿™äº›çŠ¶æ€çº¦æŸï¼ˆæˆ–è€…æ’ç­‰æ¡ä»¶ï¼‰</li><li>åº”ç”¨ç¨‹åºåº”è¯¥è´Ÿè´£ä¿è¯è¿™ç§ä¸€è‡´æ€§ï¼Œæ•°æ®åº“åªæ˜¯å­˜å‚¨</li><li><strong>è¿™ä¸ªæ›´å¤šçš„æ˜¯åº”ç”¨å±‚å±æ€§</strong>ï¼Œæ‰€ä»¥ C åŸæœ¬ä¸å±äº ACIDï¼Œåªæ˜¯ä½œè€… Joe Hellerstein è®¤ä¸ºå¬èµ·æ¥é¡ºå£å°±åŠ äº†è¿›æ¥ğŸ˜¢</li></ol></li><li><p><strong>Isolationï¼ˆéš”ç¦»æ€§ï¼‰</strong>ï¼šå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½ç›¸äº’äº¤å‰ã€‚ç»å…¸çš„æ•™ææŠŠå…¶ç§°ä¸º<em>å¯ä¸²è¡ŒåŒ–</em>ã€‚ä½†å®è·µä¸­ï¼Œä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«è¾ƒå°‘ä½¿ç”¨ï¼Œæ›´å¤šçš„è¿˜æ˜¯è¾ƒå¼±çš„éš”ç¦»çº§åˆ«ã€‚</p></li><li><p><strong>Durabilityï¼ˆæŒä¹…æ€§ï¼‰</strong>ï¼šæ•°æ®åº“æ‰¿è¯ºï¼Œä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå³ä¾¿ç¡¬ä»¶æ•…éšœæˆ–æ•°æ®åº“å´©æºƒï¼Œäº‹åŠ¡å†™å…¥çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p><ol><li>å¯¹äºå¦‚ä¸»ä»å¤åˆ¶çš„æ•°æ®åº“é›†ç¾¤ï¼Œæ„å‘³ç€å†™å…¥çš„æ•°æ®å¤åˆ¶åˆ°äº†å¤šä¸ªèŠ‚ç‚¹</li><li>å®Œç¾çš„æŒä¹…æ€§æ— æ³•ä¿è¯ï¼ˆæŠŠç¡¬ç›˜æ‹”äº†ã€å…¨éƒ¨æœºæˆ¿çƒ§äº†ğŸ”¥å‘¢ï¼Ÿï¼‰</li></ol></li><li><p>ç†æ€§çœ‹å¾…å„å®¶æ•°æ®åº“å®£ç§°çš„ ACID å…¼å®¹ï¼›å®é™…å„å®¶å®ç°éƒ½å¯èƒ½ä¸åŒ</p></li><li>ä¸ç¬¦åˆ ACID æ ‡å‡†çš„ç³»ç»Ÿé€šå¸¸ç§°ä¸º BASEï¼š<ul><li>Basically Available</li><li>Soft State</li><li>Eventually Consistency</li></ul></li><li>ACID æ•°æ®åº“åŸºäºè¿™æ ·çš„ç†å¿µï¼š<strong>å¦‚æœå­˜åœ¨è¿å AID çš„é£é™©ï¼Œå°±æ”¾å¼ƒæ•´ä¸ªäº‹åŠ¡ï¼Œè€Œééƒ¨åˆ†æ”¾å¼ƒ</strong>ï¼</li></ol><h1 id="å¼±éš”ç¦»çº§åˆ«"><a href="#å¼±éš”ç¦»çº§åˆ«" class="headerlink" title="å¼±éš”ç¦»çº§åˆ«"></a>å¼±éš”ç¦»çº§åˆ«</h1><ol><li>å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼šä¸¤ä¸ªäº‹åŠ¡é—´æ²¡æ•°æ®ä¾èµ–å…³ç³»ï¼Œæ“ä½œçš„æ˜¯å®Œå…¨ä¸åŒçš„æ•°æ®</li><li>ä¸å®‰å…¨çš„å¹¶è¡Œäº‹åŠ¡ï¼ˆä¼šå¼•å…¥ç«äº‰æ¡ä»¶ï¼‰ï¼š<ol><li>A äº‹åŠ¡ä¿®æ”¹äº†<strong>æŸæ•°æ®</strong>ï¼›B äº‹åŠ¡åˆè¯»å–<strong>è¯¥æ•°æ®</strong>ï¼›</li><li>A äº‹åŠ¡å’Œ B äº‹åŠ¡<strong>åŒæ—¶ä¿®æ”¹ç›¸åŒ</strong>çš„æ•°æ®ã€‚</li></ol></li><li>éš”ç¦»å°±æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡èƒ½å¤Ÿå®‰å…¨åœ°å¹¶å‘æ‰§è¡Œï¼Œå‡è£…æ²¡æœ‰å‘ç”Ÿå¹¶å‘ï¼›å¯ä¸²è¡Œåœ°éš”ç¦»æ„å‘³ç€æ•°æ®åº“ä¼šä¿è¯äº‹åŠ¡çš„æ‰§è¡Œç»“æœå’Œä¸²è¡Œæ‰§è¡Œç»“æœä¸€è‡´ã€‚</li><li>ä¸ºä½•äº§ç”Ÿå¼±éš”ç¦»çº§åˆ«ï¼Ÿ<ol><li>ä¸²è¡Œéš”ç¦»æ€§èƒ½ä¸å¥½</li><li>å¼±éš”ç¦»å¯è§£å†³éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼›ä½†æ˜¯è¿˜æ˜¯éœ€è¦å½»åº•ç†è§£å„ç§éš”ç¦»çº§åˆ«ä»¥åŠå®ƒä»¬å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼Œæ‰èƒ½æ›´å¥½åœ°å®Œæˆä¸šåŠ¡éœ€æ±‚</li></ol></li></ol><h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><p>åœ¨å­¦ä¹ å„ç§éš”ç¦»çº§åˆ«å‰ï¼Œæœ‰å¿…è¦äº†è§£å¦‚ä¸‹å‡ ä¸ªå…³é”®è¦ç‚¹ï¼š</p><table><thead><tr><th>è¦ç‚¹</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>è„è¯» Dirty Read</td><td>åœ¨äº‹åŠ¡ A ä¸­è¯»å–åˆ°äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚<em>é‡‡ç”¨ <strong>Read Committed</strong> åŠä»¥ä¸Šçº§åˆ«å¯é˜²èŒƒ</em>ã€‚</td></tr><tr><td>è„å†™ Dirty Write</td><td>åœ¨äº‹åŠ¡ A ä¸­è¦†ç›–äº†äº‹åŠ¡ B å°šæœªæäº¤çš„å†™å…¥ã€‚<em>å‡ ä¹æ‰€æœ‰çš„æ•°æ®åº“éƒ½å¯ä»¥é˜²æ­¢è„å†™ï¼Œæœ€ç®€å•å°±æ˜¯åŠ é”</em>ã€‚</td></tr><tr><td>è¯»å€¾æ–œï¼ˆä¸å¯é‡å¤è¯»ï¼‰ Non-Repeatable Read</td><td>åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œä¸åŒçš„æ—¶é—´ç‚¹è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¾—åˆ°çš„å€¼ä¸åŒã€‚<em>å¿«ç…§éš”ç¦»å¯è½»æ¾åº”ä»˜ï¼Œé€šå¸¸ä½¿ç”¨ MVCC å®ç°å¿«ç…§éš”ç¦»ï¼ˆå¦‚ InnoDBï¼‰</em>ã€‚</td></tr><tr><td>æ›´æ–°ä¸¢å¤± Lost Update</td><td>ä¸¤ä¸ªäº‹åŠ¡ä¸­éƒ½æ‰§è¡Œäº† Read-Modify-Write çš„æ“ä½œåºåˆ—ï¼Œå‡ºç°äº†å…¶ä¸­ä¸€ä¸ªè¦†ç›–äº†å¦ä¸€ä¸ªçš„å†™å…¥ï¼Œä½†æ²¡æœ‰åŒ…å«å¯¹æ–¹æœ€æ–°å€¼çš„æƒ…å†µï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ï¼šè¯»å–æŸä¸ªå­—æ®µ-&gt;å­—æ®µå€¼åŠ  1-&gt;å†™å…¥è¯¥å­—æ®µçš„æ–°å€¼ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œäº† +1ï¼Œä½†æœ€ç»ˆç»“æœä¸æ˜¯é¢„æœŸçš„ +2 æ•ˆæœï¼‰ã€‚<em>é€šå¸¸å¯ä»¥é‡‡ç”¨æ•°æ®æ”¯æŒçš„åŸå­å†™æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨ SELECTâ€¦FOR UPDATE æ˜¾å¼åŠ é”çš„æ–¹å¼è§£å†³ï¼›å½“ç„¶ï¼ŒæŸäº›å¿«ç…§éš”ç¦»çš„å®ç°å¯ä»¥è‡ªåŠ¨é˜²æ­¢è¿™ç§å¼‚å¸¸</em></td></tr><tr><td>å†™å€¾æ–œ Write Skew</td><td>å…¸å‹çš„åœºæ™¯æ˜¯ï¼šäº‹åŠ¡ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå†æ ¹æ®æŸ¥è¯¢ç»“æœåšå‡ºå†³ç­–ï¼Œæœ€åä¿®æ”¹æ•°æ®åº“ã€‚ä½†æ˜¯å¦‚æœäº‹åŠ¡æäº¤æ—¶ï¼Œæ”¯æŒå†³ç­–çš„å‰ææ¡ä»¶ä¸å†æˆç«‹ï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªäº‹åŠ¡ä¸­åšäº†ä¿®æ”¹ï¼Œå¯¼è‡´åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¾—åˆ°çš„ç»“æœä¸åŒï¼‰ã€‚<em>åªæœ‰ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«æ‰èƒ½çœŸæ­£é˜²æ­¢è¿™ç§å¼‚å¸¸</em></td></tr><tr><td>å¹»è¯» Phantom Read</td><td>äº‹åŠ¡è¯»å–äº†æŸäº›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼ŒåŒæ—¶å¦ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå†™å…¥ï¼Œæ”¹å˜äº†å…ˆå‰çš„æŸ¥è¯¢ç»“æœã€‚<em>å¿«ç…§éš”ç¦»å¯é˜²æ­¢ç®€å•çš„å¹»è¯»</em></td></tr></tbody></table><h2 id="ANSI-SQL-å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š"><a href="#ANSI-SQL-å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š" class="headerlink" title="ANSI SQL å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š"></a>ANSI SQL å‡ ç§éš”ç¦»çº§åˆ«å®šä¹‰ï¼š</h2><p>å®é™…ä¸Šå„å®¶æ•°æ®åº“çš„æ”¯æŒæ˜¯ä¸å°½ç›¸åŒçš„ğŸ˜£ã€‚</p><table><thead><tr><th>çº§åˆ«</th><th>P1 è„è¯»</th><th>P2 ä¸å¯é‡å¤è¯»</th><th>P3 å¹»è¯»</th></tr></thead><tbody><tr><td>Read Uncommitted</td><td>å…è®¸</td><td>å…è®¸</td><td>å…è®¸</td></tr><tr><td>Read Committed</td><td>ç¦æ­¢</td><td>å…è®¸</td><td>å…è®¸</td></tr><tr><td>Repeatable Read</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td><td>å…è®¸</td></tr><tr><td>Serializable</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td><td>ç¦æ­¢</td></tr></tbody></table><h2 id="è¯»å·²æäº¤"><a href="#è¯»å·²æäº¤" class="headerlink" title="è¯»å·²æäº¤"></a>è¯»å·²æäº¤</h2><ol><li><p>æœ€åŸºæœ¬çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéœ€è¦æä¾›ä¸‹é¢ä¸¤ä¸ªä¿è¯ï¼š</p><ol><li>é˜²æ­¢è„è¯»</li><li>é˜²æ­¢è„å†™</li></ol></li><li><p>å®ç°ï¼š</p><ol><li>ä¸ºäº†é˜²æ­¢è„å†™ï¼Œå½“äº‹åŠ¡éœ€è¦ä¿®æ”¹æŸä¸ªå¯¹è±¡ï¼ˆæ¯”å¦‚è¡Œæˆ–æ–‡æ¡£ï¼‰æ—¶ï¼Œå¿…é¡»è¦è·å¾—è¯¥å¯¹è±¡çš„é”ï¼Œä¸€ç›´æŒæœ‰è¯¥é”ç›´åˆ°äº‹åŠ¡æäº¤æˆ–ä¸­æ­¢ï¼›    </li><li>ä¸ºäº†é˜²æ­¢è„è¯»ï¼Œä½¿ç”¨é”çš„æ–¹å¼è™½ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†åœ¨è¿è¡Œè¾ƒé•¿æ—¶é—´çš„å†™äº‹åŠ¡ä¼šå¯¼è‡´è®¸å¤šåªè¯»äº‹åŠ¡ç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå½±å“åªè¯»äº‹åŠ¡çš„å“åº”å»¶è¿Ÿï¼Œå¯æ“ä½œæ€§å·®ã€‚é€šå¸¸å¯¹äºæ¯ä¸ªå¾…æ›´æ–°çš„å¯¹è±¡ï¼Œæ•°æ®åº“ç»´æŠ¤å…¶æ—§å€¼å’Œå½“å‰æŒé”äº‹åŠ¡å°†è¦è®¾ç½®çš„æ–°å€¼ä¸¤ä¸ªç‰ˆæœ¬ã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼Œæ‰€æœ‰å…¶å®ƒè¯»æ“ä½œéƒ½è¯»å–æ—§å€¼ï¼›ä»…å½“å†™äº‹åŠ¡æäº¤åï¼Œæ‰ä¼šåˆ‡æ¢åˆ°è¯»å–æ–°å€¼ã€‚</li></ol></li></ol><h2 id="å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»"><a href="#å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»" class="headerlink" title="å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»"></a>å¿«ç…§éš”ç¦»çº§åˆ«å’Œå¯é‡å¤è¯»</h2><ol><li><p>Rread Committed ä¸èƒ½è§£å†³<strong>ä¸å¯é‡å¤è¯»</strong>çš„é—®é¢˜ï¼Œè€Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å°±ä¸èƒ½å®¹å¿ï¼š</p><ol><li>å¤‡ä»½</li><li>åˆ†ææŸ¥è¯¢å’Œå®Œæ•´æ€§æ£€æŸ¥</li></ol></li><li><p>å¿«ç…§éš”ç¦»ä¿è¯æ¯ä¸ªäº‹åŠ¡åªçœ‹åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„æ—§æ•°æ®ï¼Œä¸æ„ŸçŸ¥å…¶å®ƒäº‹åŠ¡ä¸­å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚è¯»å–æ“ä½œä¸ä¼šé˜»æ­¢å†™æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚</p></li><li>æ•°æ®åº“ä½¿ç”¨äº†<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Control, MVCCï¼‰</strong>æŠ€æœ¯æ¥å®ç°å¿«ç…§éš”ç¦»ã€‚è€Œ MVCC ä¹Ÿå¯ä»¥ç”¨æ¥å®ç° Read Committed éš”ç¦»çº§åˆ«ï¼ˆåªéœ€è¦ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬å³å¯ï¼Œå·²æäº¤çš„æ—§æ•°æ®å’Œå°šæœªæäº¤çš„æ–°ç‰ˆæœ¬æ•°æ®ï¼‰ï¼Œå…¸å‹çš„åšæ³•æ˜¯å¯¹æ¯ä¸ªä¸åŒçš„æŸ¥è¯¢å•ç‹¬åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼›è€Œå¿«ç…§éš”ç¦»çº§åˆ«åˆ™ä½¿ç”¨ä¸€ä¸ªå¿«ç…§è¿è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚<br> <img src="./mvvc.png" alt=""></li><li>ä¸€è‡´æ€§å¿«ç…§ä¸­æ•°æ®å¯è§æ€§è§„åˆ™ï¼š<ol><li>äº‹åŠ¡å¼€å§‹æ—¶ï¼Œåˆ›å»ºè¯¥å¯¹è±¡çš„äº‹åŠ¡å·²ç»å®Œæˆæäº¤</li><li>å¯¹è±¡æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼›æˆ–è€…å³ä¾¿æ ‡è®°äº†ï¼Œä½†æ˜¯åˆ é™¤äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å°šæœªæäº¤</li></ol></li></ol><h2 id="é˜²æ­¢æ›´æ–°ä¸¢å¤±"><a href="#é˜²æ­¢æ›´æ–°ä¸¢å¤±" class="headerlink" title="é˜²æ­¢æ›´æ–°ä¸¢å¤±"></a>é˜²æ­¢æ›´æ–°ä¸¢å¤±</h2><ol><li><p>äº§ç”Ÿæ›´æ–°ä¸¢å¤±çš„å…¸å‹åœºæ™¯æ˜¯ï¼šRead-Modify-Writeï¼Œå½“ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡åœ¨åŒæ ·çš„æ•°æ®è®°å½•ä¸Šæ‰§è¡Œç±»ä¼¼æ“ä½œæ—¶ï¼ŒäºŒè€…ç›¸äº’ä¸ä¼šæ„ŸçŸ¥å¯¹æ–¹çš„ä¿®æ”¹å€¼ï¼Œæœ€ç»ˆå¯¼è‡´æŸä¸ªäº‹åŠ¡çš„ä¿®æ”¹å€¼å¯èƒ½ä¸¢å¤±ã€‚åœºæ™¯å¦‚ä¸‹ï¼š</p><ol><li>é€’å¢è®¡æ•°å™¨ï¼›æ›´æ–°è´¦æˆ·ä½™é¢</li><li>å¯¹å¤æ‚å¯¹è±¡çš„ä¸€éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼ˆå¦‚ä¸€ä¸ªå¤§ JSON å¯¹è±¡ï¼‰</li></ol></li><li><p>å¦‚ä½•è§£å†³ï¼Ÿ</p><ol><li><p>é‡‡ç”¨<strong>åŸå­å†™æ“ä½œ</strong>ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒçš„è¯ï¼‰ï¼š</p><ol><li><code>UPDATE counter SET value = value + 1 WHERE id = 1</code>;</li><li>é€šå¸¸é‡‡ç”¨è¯»å–å¯¹è±¡å¹¶åŠ ç‹¬å é”çš„æ–¹å¼æ¥å®ç°ï¼ˆåœ¨å½“å‰äº‹åŠ¡æœªæäº¤å‰ï¼Œå…¶å®ƒäº‹åŠ¡ä¹Ÿä¸å¯è¯»ï¼‰ï¼›æˆ–è€…å¯ä»¥é‡‡ç”¨å•çº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œ</li></ol></li><li><p><strong>æ˜¾å¼åŠ é”</strong>ï¼š</p><ol><li><code>SELECT * FROM figures WHERE name = &#39;robot&#39; FOR UPDATE</code></li><li>å¯¹æ‰€é€‰è¡ŒåŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡è‹¥è¦åŒæ—¶å°è¯•è¯»å–å¯¹è±¡ï¼Œåˆ™è¦ç­‰å¾…å½“å‰æ­£åœ¨æ‰§è¡Œçš„åºåˆ—å…¨éƒ¨å®Œæˆ</li></ol></li><li><p><strong>è‡ªåŠ¨æ£€æµ‹æ›´æ–°ä¸¢å¤±</strong>ï¼š</p><ol><li>äº‹åŠ¡ç®¡ç†å™¨å¦‚æœæ£€æµ‹åˆ°æ›´æ–°ä¸¢å¤±é£é™©ï¼Œä¼šä¸­æ­¢å½“å‰äº‹åŠ¡ï¼Œå¼ºåˆ¶é€€å›åˆ°å®‰å…¨çš„ R-M-W æ–¹å¼</li><li>MySQL InnoDB ä¸æ”¯æŒæ£€æµ‹ï¼›PostgreSQL çš„å¯é‡å¤è¯»ã€Oracle å¯ä¸²è¡ŒåŒ–å’Œ SQL Server å¿«ç…§éš”ç¦»çº§åˆ«éƒ½æ”¯æŒ</li></ol></li><li><strong>åŸå­æ¯”è¾ƒå’Œè®¾ç½®</strong>ï¼š<ol><li>åªæœ‰åœ¨ä¸Šæ¬¡è¯»å–çš„æ•°æ®æœªå‘ç”Ÿå˜åŒ–æ—¶æ‰å…è®¸æ›´æ–°ï¼›å¦åˆ™å›é€€åˆ° R-M-W æ–¹å¼</li><li>ä½¿ç”¨å‰éœ€è¦ä»”ç»†æ£€æŸ¥</li></ol></li></ol></li></ol><h2 id="å†™å€¾æ–œä¸å¹»è¯»"><a href="#å†™å€¾æ–œä¸å¹»è¯»" class="headerlink" title="å†™å€¾æ–œä¸å¹»è¯»"></a>å†™å€¾æ–œä¸å¹»è¯»</h2><p><img src="./write-skew.png" alt=""></p><ol><li><p>å†™å€¾æ–œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§æ›´å¹¿ä¹‰çš„æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼Œå³å¦‚æœä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„ä¸€ç»„å¯¹è±¡ï¼Œç„¶åæ›´æ–°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼š</p><ol><li>ä¸åŒçš„äº‹åŠ¡æ›´æ–°ä¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå†™å€¾æ–œ</li><li>ä¸åŒçš„äº‹åŠ¡æ›´æ–°ç›¸åŒçš„å¯¹è±¡ï¼Œåˆ™å¯èƒ½å‘ç”Ÿè„å†™æˆ–æ›´æ–°ä¸¢å¤±</li></ol></li><li><p>ç›¸å…³åœºæ™¯ï¼š</p><ol><li>ä¼šè®®å®¤é¢„å®šç³»ç»Ÿ</li><li>å¤šäººæ¸¸æˆ</li><li>å£°æ˜ä¸€ä¸ªç”¨æˆ·å</li><li>é˜²æ­¢åŒé‡å¼€æ”¯ï¼ˆç§¯åˆ†ç­‰ï¼‰</li></ol></li><li><p>å¦‚ä½•åº”å¯¹å†™å€¾æ–œï¼š</p><ol><li>å¦‚å€¼ç­åŒ»ç”Ÿçš„ä¾‹å­ï¼Œå¯ä»¥é‡‡ç”¨ <code>SELECT...FOR UPDATE</code> æ–¹å¼<strong>æ˜¾å¼åŠ é”</strong>ï¼Œä½†å¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œè¿™æ ·åšä¹Ÿä¸èƒ½å¥æ•ˆ</li><li>å®ä½“åŒ–å†²çªï¼Œæ¯”å¦‚ä¼šè®®å®¤é¢„å®šï¼Œå¯ä»¥æå‰å°†æœªæ¥ N ä¸ªæœˆçš„å¯¹åº”çš„æ‰€æœ‰æ—¶é—´å’Œæˆ¿é—´ç»„åˆåˆ›å»ºå¥½ï¼Œè¿™æ ·æ˜¾ç¤ºåŠ é”å¯ä»¥ç”Ÿæ•ˆ</li><li>é‡‡ç”¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«</li></ol></li></ol><h1 id="ä¸²è¡ŒåŒ–"><a href="#ä¸²è¡ŒåŒ–" class="headerlink" title="ä¸²è¡ŒåŒ–"></a>ä¸²è¡ŒåŒ–</h1><h2 id="ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ"><a href="#ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ" class="headerlink" title="ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ"></a>ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ</h2><ol><li>é‡‡ç”¨å•çº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œäº‹åŠ¡ï¼Œé¿å…æ£€æµ‹ã€äº‹åŠ¡å†²çªç­‰é—®é¢˜ï¼›åŒæ—¶å¯èƒ½ä¼šæ¯”æ”¯æŒå¹¶å‘çš„ç³»ç»Ÿæ•ˆç‡æ›´é«˜ï¼Œé¿å…é”çš„å¼€é”€</li><li>ä¸ºä»€ä¹ˆå¯è¡Œï¼Ÿ<ol><li>å†…å­˜æ›´ä¾¿å®œ</li><li>OLTP äº‹åŠ¡é€šå¸¸å¾ˆå¿«æ‰§è¡Œå®Œï¼Œåªäº§ç”Ÿå°‘é‡è¯»å–</li></ol></li><li>å…¸å‹çš„ä»£è¡¨ï¼šVoltDB / H-Store, Redis å’Œ Datomic</li><li>é€šå¸¸ä¸èƒ½æ”¯æŒäº¤äº’å¼çš„å¤šè¯­å¥äº‹åŠ¡ï¼ˆå¦åˆ™å¾—ç­‰å¾…å¤ªä¹…äº†ï¼‰<br> <img src="./procedure.png" alt=""></li><li>æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼Œä¸²è¡Œæ‰§è¡Œäº‹åŠ¡ç§‘å®ç°ä¸²è¡ŒåŒ–éš”ç¦»ï¼š<ol><li>äº‹åŠ¡å¿…é¡»<strong>ç®€çŸ­é«˜æ•ˆ</strong></li><li>ä»…é™äºæ´»åŠ¨æ•°æ®é›†å®Œå…¨å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„åœºæ™¯</li><li>å†™å…¥ååå¿…é¡»è¶³å¤Ÿä½ï¼Œæ‰èƒ½åœ¨å•æ ¸ä¸Šå¤„ç†ï¼›å¦åˆ™éœ€è¦é‡‡ç”¨åˆ†åŒºï¼Œä½†æœ€å¥½ä¸è¦ä½¿ç”¨è·¨åˆ†åŒºäº‹åŠ¡ï¼ˆé¿å…åè°ƒå¼€é”€ï¼‰</li><li>è·¨åˆ†åŒºäº‹åŠ¡å¯ä»¥æ”¯æŒï¼Œä½†å æ¯”å¿…é¡»è¦å°</li></ol></li></ol><h2 id="ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase-Lock-2PLï¼‰"><a href="#ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase-Lock-2PLï¼‰" class="headerlink" title="ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lock, 2PLï¼‰"></a>ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lock, 2PLï¼‰</h2><ol><li>2PL æ˜¯æ¯”è¾ƒè€ç‰Œçš„ä¸²è¡ŒåŒ–ç®—æ³•ï¼Œåº”ç”¨äº MySQL InnoDB å’Œ SQL Server çš„ã€Œå¯ä¸²è¡ŒåŒ–éš”ç¦»ã€å’Œ DB2 çš„ã€Œå¯é‡å¤è¯»éš”ç¦»ã€ã€‚æ‚²è§‚äº‹åŠ¡æ¨¡å‹ã€‚</li><li>å…¸å‹ç‰¹å¾ï¼š<ol><li>è¯»å†™äº’æ–¥</li><li>å¹¶å‘å†™äº’æ–¥</li></ol></li><li><p>åŸºæœ¬æ€è·¯ï¼ˆæ•°æ®åº“ä¼šä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤è¯»å†™é”æ¥éš”ç¦»è¯»å†™æ“ä½œï¼Œé”å¯ä»¥å¤„äº<strong>å…±äº«æ¨¡å¼</strong>æˆ–<strong>ç‹¬å æ¨¡å¼</strong>ï¼‰ï¼š</p><ol><li>å¦‚æœäº‹åŠ¡è¦è¯»å–å¯¹è±¡ï¼Œå¿…é¡»å…ˆä»¥å…±äº«æ¨¡å¼è·å¾—é”ã€‚å¤šä¸ªäº‹åŠ¡å¯åŒæ—¶ä»¥è·å¾—å¯¹è±¡çš„å…±äº«é”ï¼›ä½†å¦‚æœæŸä¸ªäº‹åŠ¡è·å¾—äº†å¯¹è±¡çš„ç‹¬å é”ï¼Œåˆ™å…¶ä»–äº‹åŠ¡éƒ½éœ€è¦ç­‰å¾…</li><li>å¦‚æœäº‹åŠ¡è¦ä¿®æ”¹å¯¹è±¡ï¼Œå¿…é¡»ä»¥ç‹¬å æ¨¡å¼è·å–é”ã€‚å¦‚æœå¯¹è±¡å·²ç»åŠ é”ï¼ˆä¸ç®¡æ˜¯è¯»è¿˜æ˜¯å†™ï¼‰ï¼Œåˆ™è¯¥äº‹åŠ¡å¿…é¡»ç­‰å¾…</li><li>å¦‚æœäº‹åŠ¡å…ˆè¯»åå†™ï¼Œåˆ™å°†å…±äº«é”å‡çº§ä¸ºç‹¬å é”</li><li>äº‹åŠ¡è·å–é”åï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæ‰ä¼šé‡Šæ”¾</li></ol></li><li><p>ä¸¤é˜¶æ®µçš„å«ä¹‰ï¼š</p><ol><li>äº‹åŠ¡æ‰§è¡Œå‰<strong>è·å–é”</strong></li><li>äº‹åŠ¡ç»“æŸå<strong>é‡Šæ”¾é”</strong></li></ol></li><li><p>2PL çš„é—®é¢˜ï¼š</p><ol><li>ç³»ç»Ÿååé‡å’ŒæŸ¥è¯¢å“åº”æ—¶é—´ç›¸å¯¹äºå¼±éš”ç¦»çº§åˆ«ä¸‹é™å¾ˆå¤š</li><li>é”çš„å¼€é”€å¤šï¼›äº‹åŠ¡çš„å¹¶å‘æ€§é™ä½</li><li>è®¿é—®å»¶è¿Ÿä¸ç¡®å®šæ€§é«˜</li><li>æ­»é”é—®é¢˜ï¼Œå¦‚æœæ£€æµ‹åˆ°æ­»é”ï¼Œäº‹åŠ¡ä¼šè¢«å¼ºè¡Œä¸­æ­¢ï¼ˆåº”ç”¨å±‚å¯é€‰æ‹©é‡è¯•ï¼‰</li></ol></li><li><p>è°“è¯é”ï¼š</p><ol><li>ä¸å±äºç‰¹å®šçš„å¯¹è±¡ï¼Œä½œç”¨äºç‰¹å®šçš„æœç´¢æ¡ä»¶æŸ¥è¯¢åˆ°çš„æ‰€æœ‰å¯¹è±¡</li><li>å¯ä»¥ä¿æŠ¤æ•°æ®åº“ä¸­å°šä¸å­˜åœ¨ä½†å¯èƒ½é©¬ä¸Šä¼šè¢«æ’å…¥çš„å¯¹è±¡ï¼ˆä¼šå¼•èµ·å¹»è¯»ï¼‰</li><li>2PL å’Œè°“è¯é”ç»“ç›Ÿï¼Œå¯é˜»æ­¢ä»»ä½•å½¢å¼çš„å†™å€¾æ–œå’Œå…¶å®ƒç«äº‰æ¡ä»¶ï¼Œä½¿å¾—éš”ç¦»çœŸæ­£ä¸²è¡ŒåŒ–</li><li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸ä½³</li></ol></li><li><p>ç´¢å¼•åŒºé—´é”ï¼ˆnext-key lockingï¼‰</p><ol><li>æ ¸å¿ƒå°±æ˜¯å°†ä¿æŠ¤å¯¹è±¡æ‰©å¤§åŒ–ï¼Œä¸å¦‚ä¸ºè°“è¯é”ç²¾ç¡®ï¼Œä½†å¼€é”€ä½ï¼Œæ‰€ä»¥å®è·µä¸­å¸¸ç”¨</li><li>ä¼šå¯¹åˆé€‚çš„ç´¢å¼•åŠ åŒºé—´é”ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„ç´¢å¼•ï¼Œå°±å›é€€åˆ°æ•´å¼ è¡¨åŠ å…±äº«é”</li></ol></li></ol><h2 id="å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable-Snapshot-Isolation-SSIï¼‰"><a href="#å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable-Snapshot-Isolation-SSIï¼‰" class="headerlink" title="å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰"></a>å¯ä¸²è¡ŒåŒ–å¿«ç…§éš”ç¦»ï¼ˆSerializable Snapshot Isolation, SSIï¼‰</h2><ol><li>SSI æ˜¯ä¹è§‚äº‹åŠ¡æ¨¡å‹å®ç°ï¼Œå¦‚æœå¯èƒ½å‘ç”Ÿå†²çªï¼Œä¹Ÿä¸ä¼šé˜»æ­¢äº‹åŠ¡æäº¤ï¼Œè€Œæ˜¯åœ¨çœŸæ­£æäº¤æ—¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å†²çªï¼ˆå³è¿åéš”ç¦»æ€§åŸåˆ™ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šä¸­æ­¢å¹¶æ¥ä¸‹æ¥é‡è¯•ã€‚</li><li>é€‚ç”¨äºäº‹åŠ¡ä¹‹é—´ç«äº‰ä¸å¤§ï¼Œå†²çªè¾ƒå°‘çš„åœºæ™¯ï¼Œä¼šæ¯”æ‚²è§‚æ–¹å¼é«˜æ•ˆå¾ˆå¤šï¼ˆæ‰€ä»¥ä¹Ÿæ¯”è¾ƒé€‚ç”¨äºäº’è”ç½‘ç¯å¢ƒï¼‰ã€‚</li><li>äº‹åŠ¡æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡æ‰€æŒæœ‰çš„é”ï¼Œè¦æ±‚è¯»å†™å‹äº‹åŠ¡è¦ç®€çŸ­ï¼ˆé•¿æ—¶é—´çš„è¯»å–äº‹åŠ¡æ²¡æœ‰é™åˆ¶ï¼‰<br><img src="./collision-detection.png" alt=""></li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ†</a></li><li><a href="https://www.zhihu.com/question/280650327" target="_blank" rel="noopener">çŸ¥ä¹ï¼šSQL å››ç§éš”ç¦»çº§åˆ«çš„è‹¥å¹²è¿·æƒ‘ï¼Ÿ</a></li><li><a href="https://zhuanlan.zhihu.com/p/38214642" target="_blank" rel="noopener">æ•°æ®åº“äº‹åŠ¡éš”ç¦»æ ‡å‡†åˆ†æ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ç”±äºæ•°æ®å­˜å‚¨æœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿé”™è¯¯ã€æ•…éšœçš„ç‚¹ç‰¹åˆ«å¤šï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€ç£ç›˜å†™æ»¡ç­‰ï¼Œé¢å¯¹è¿™äº›å¤æ‚çš„æƒ…å†µï¼Œåº”ç”¨å±‚åº”ä»˜èµ·æ¥éå¸¸å›°éš¾ã€‚æ‰€ä»¥å°±æœ‰äº†äº‹åŠ¡çš„æ¦‚å¿µï¼Œè¯´é“äº‹åŠ¡ï¼Œæˆ‘ä»¬æœ€å…ˆèƒ½æƒ³åˆ°çš„å°±æ˜¯ï¼šå¯ä»¥ä¸€æ¬¡äº‹åŠ¡ä¸­å°†å¾ˆå¤šè¯»å†™å…¥æ“ä½œæ‰“åŒ…æˆä¸€ä¸ªé€»è¾‘æ“ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸æˆåŠŸï¼ˆCommittedï¼‰ä¾¿æˆä»ï¼ˆRollbackï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æƒ…å†µå®‰å…¨åœ°é‡è¯•ï¼Œä¸ç”¨æ‹…å¿ƒéƒ¨åˆ†å†™å…¥çš„é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹" scheme="http://ifaceless.space/tags/%E3%80%8A%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1%E3%80%8B/"/>
    
      <category term="äº‹åŠ¡" scheme="http://ifaceless.space/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®å¤åˆ¶å’Œåˆ†åŒº</title>
    <link href="http://ifaceless.space/2019/08/18/ddia-data-replication-and-partition/"/>
    <id>http://ifaceless.space/2019/08/18/ddia-data-replication-and-partition/</id>
    <published>2019-08-18T11:27:19.000Z</published>
    <updated>2019-11-24T09:45:59.823Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ç³»ç»ŸåŸºç¡€å­¦ä¹ åï¼Œå°±å¼€å§‹è¿›å…¥åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿçš„ä¸–ç•Œäº†ã€‚å‰é¢å­¦ä¹ çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„æƒ…å†µï¼›ç„¶è€Œï¼Œåœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„<strong>æ‰©å±•æ€§</strong>ã€<strong>å®¹é”™æ€§</strong>ä»¥åŠ<strong>å»¶è¿Ÿæ€§</strong>ç­‰ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é€šå¸¸ä¼šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚åº¦è‡ªç„¶ä¹Ÿä¸Šæ¥äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä¸»è¦å­¦ä¹ æ•°æ®ç³»ç»Ÿçš„å¤åˆ¶ã€åˆ†åŒºã€äº‹åŠ¡ã€ä¸€è‡´æ€§å…±è¯†ç®—æ³•ã€ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„ä¸€äº›æŒ‘æˆ˜ç­‰ï¼Œè¿™äº›çŸ¥è¯†éƒ½æ¯”è¾ƒç¡¬æ ¸ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚æ‰€ä»¥ï¼Œã€Œä¸Šè½¦ï¼Œèµ°å§~ã€</p><p>æœ¬ç¯‡ç¬”è®°é‡ç‚¹æ˜¯å…³äºæ•°æ®ç³»ç»Ÿçš„å¤åˆ¶å’Œåˆ†åŒºï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§„çš„ä¸»ä»å¤åˆ¶åŸç†ã€å¤šä¸»å¤åˆ¶çš„åº”ç”¨åœºæ™¯ï¼Œå¦å¤–è¿˜ä»‹ç»äº†æ— ä¸»å¤åˆ¶çš„ç³»ç»Ÿï¼ˆå¦‚äºšé©¬é€Š Dynamo ç³»ç»Ÿï¼‰ã€‚æœ€åå°±æ˜¯å…³äºæ•°æ®åˆ†åŒºçš„ä»‹ç»ï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§çš„åˆ†åŒºç­–ç•¥ï¼ŒåŠ¨æ€å¹³è¡¡ç­–ç•¥ç­‰ã€‚</p><a id="more"></a><h1 id="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ</h1><h2 id="å…±äº«æ¶æ„"><a href="#å…±äº«æ¶æ„" class="headerlink" title="å…±äº«æ¶æ„"></a>å…±äº«æ¶æ„</h2><p>é’ˆå¯¹å…±äº«æ¶æ„ï¼Œå¦‚æœè´Ÿè½½å¢åŠ ï¼Œæœ€å¸¸è§çš„æ‰©å±•æ–¹å¼å°±æ˜¯é‡‡ä¹°æ›´å¼ºå¤§çš„ CPUã€æ·»åŠ æ›´å¤šçš„å†…å­˜ç­‰ã€‚è¿™ç§è¢«ç§°ä¸ºå‚ç›´æ‰©å±•ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸ä¸€å®šå¥æ•ˆï¼Œå¤©èŠ±æ¿æ˜¯çœ‹å¾—è§çš„ã€‚å¹¶ä¸”æ‰©å±•çš„æˆæœ¬éçº¿æ€§ï¼Œè€Œåº”å¯¹è´Ÿè½½çš„èƒ½åŠ›å´ä¸ä¸€å®šèƒ½çº¿æ€§æé«˜ã€‚</p><h2 id="æ— å…±äº«æ¶æ„"><a href="#æ— å…±äº«æ¶æ„" class="headerlink" title="æ— å…±äº«æ¶æ„"></a>æ— å…±äº«æ¶æ„</h2><p>åœ¨æ— å…±äº«æ¶æ„ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹çš„ CPUã€å†…å­˜å’Œç£ç›˜ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡é‡‡ç”¨ä»¥å¤ªç½‘ã€‚è¯¥æ¶æ„æ— éœ€ç‰¹æ®Šçš„ç¡¬ä»¶æ”¯æŒï¼Œæ€§ä»·æ¯”é«˜ã€‚æ‰©å±•æ€§å¥½ï¼ˆæ°´å¹³æ‰©å±•ï¼‰ï¼Œå¹¶ä¸”æœ‰å¼ºå¤§çš„å®¹é”™èƒ½åŠ›å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚ä¸è¿‡è¿™ç§æ¶æ„æœ€å¤§çš„é—®é¢˜æ˜¯ä¼šå¸¦æ¥æ›´å¤§çš„å¤æ‚æ€§ï¼Œç”šè‡³ä¼šé™åˆ¶å®é™…å¯ä½¿ç”¨çš„æ•°æ®æ¨¡å‹ã€‚</p><h1 id="æ•°æ®å¤åˆ¶"><a href="#æ•°æ®å¤åˆ¶" class="headerlink" title="æ•°æ®å¤åˆ¶"></a>æ•°æ®å¤åˆ¶</h1><h2 id="ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹"><a href="#ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹" class="headerlink" title="ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹"></a>ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹</h2><ol><li>æ¯ä¸ªä¿å­˜äº†æ•°æ®åº“å®Œæ•´æ•°æ®é›†çš„èŠ‚ç‚¹å«ä½œå‰¯æœ¬</li><li>ä¸»ä»å¤åˆ¶æ–¹æ¡ˆï¼š<ol><li>æŒ‡å®šæŸä¸ªå‰¯æœ¬ä¸ºä¸»å‰¯æœ¬ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ã€‚å†™å…¥ä¼šå‘ç»™ä¸»èŠ‚ç‚¹</li><li>ä¸»èŠ‚ç‚¹åœ¨å°†æ–°æ•°æ®å­˜å‚¨åï¼Œå°†æ›´æ”¹ä½œä¸ºå¤åˆ¶çš„æ—¥å¿—æˆ–è€…æ›´æ”¹æµçš„æ–¹å¼å‘ç»™ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹è·å–æ›´æ”¹æ—¥å¿—ï¼Œå¹¶åº”ç”¨åˆ°æœ¬åœ°ï¼Œè¿™é‡Œå¿…é¡»è¦ä¿æŒå’Œä¸»å‰¯æœ¬ç›¸åŒçš„å†™å…¥é¡ºåº</li><li>å®¢æˆ·ç«¯è¯»å–æ—¶ï¼Œå¯è¯»å–ä»å‰¯æœ¬çš„æ•°æ®<br><img src="./master-slave-replication.png" alt=""></li></ol></li></ol><h3 id="åŒæ­¥å¤åˆ¶-v-s-å¼‚æ­¥å¤åˆ¶"><a href="#åŒæ­¥å¤åˆ¶-v-s-å¼‚æ­¥å¤åˆ¶" class="headerlink" title="åŒæ­¥å¤åˆ¶ v.s. å¼‚æ­¥å¤åˆ¶"></a>åŒæ­¥å¤åˆ¶ v.s. å¼‚æ­¥å¤åˆ¶</h3><p><img src="./data-sync.png" alt=""></p><ol><li>å¯¹äºå…³ç³»æ•°æ®åº“ï¼Œä¸¤ç§å¤åˆ¶æ–¹å¼é€šå¸¸æ˜¯å¯é…ç½®çš„ï¼›è€Œå…¶ä»–ç³»ç»Ÿå¯èƒ½åªå¯æŒ‡å®šå…¶ä¸­ä¸€ç§æ–¹å¼ã€‚</li><li>åŒæ­¥å¤åˆ¶ï¼š<ol><li>ä¼˜ç‚¹ï¼šä¸€æ—¦å‘ç”¨æˆ·ç¡®è®¤å†™å…¥è¯·æ±‚ï¼Œåˆ™ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œå¹¶éƒ½å¤„äºæœ€æ–°ç‰ˆæœ¬ã€‚ä¸»åº“å®•æœºï¼Œä¹Ÿå¯ä»¥æ”¾å¿ƒä»ä»åº“è¯»å–ã€‚</li><li>ç¼ºç‚¹ï¼šå¦‚æœä»èŠ‚ç‚¹æ— æ³•å®Œæˆç¡®è®¤ï¼ˆå¦‚ç½‘ç»œæ‹¥å¡ã€æ•…éšœç­‰ï¼‰ï¼Œå†™å…¥ä¼šå¤±è´¥ã€‚ä¸»èŠ‚ç‚¹ä¼šé˜»å¡åç»­å†™è¯·æ±‚ï¼Œé™ä½ç³»ç»Ÿååé‡å’Œå¯é æ€§ã€‚</li></ol></li><li><strong>åŠåŒæ­¥</strong>ï¼šå®è·µä¸­ï¼Œå¦‚æœå¼€å¯äº†åŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œé€šå¸¸æ˜¯å…¶ä¸­çš„<strong>æŸä¸ªä»èŠ‚</strong>ï¼ˆå¯æ ¹æ®æƒ…å†µé€‰æ‹©å…¶ä»–ä»èŠ‚ç‚¹æå‡ä¸ºåŒæ­¥æ¨¡å¼ï¼‰ç‚¹ä¸ºåŒæ­¥å¤åˆ¶ï¼Œè€Œå…¶ä»–ä¸ºå¼‚æ­¥å¤åˆ¶æ¨¡å¼ã€‚</li><li><strong>å…¨å¼‚æ­¥</strong>ï¼š<ol><li>ä¼˜ç‚¹ï¼šç³»ç»Ÿçš„ååæ€§èƒ½å¾ˆå¥½</li><li>ç¼ºç‚¹ï¼šæ•°æ®çš„æŒä¹…åŒ–æ— æ³•å¾—åˆ°ä¿è¯ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±çš„æƒ…å†µ</li></ol></li></ol><h3 id="é…ç½®æ–°çš„ä»èŠ‚ç‚¹"><a href="#é…ç½®æ–°çš„ä»èŠ‚ç‚¹" class="headerlink" title="é…ç½®æ–°çš„ä»èŠ‚ç‚¹"></a>é…ç½®æ–°çš„ä»èŠ‚ç‚¹</h3><ol><li><p>ä»€ä¹ˆæ—¶å€™éœ€è¦ï¼Ÿ</p><ol><li>æé«˜è´Ÿè½½èƒ½åŠ›</li><li>æä¾›å®¹é”™èƒ½åŠ›</li><li>æ›¿æ¢å¤±è´¥çš„å‰¯æœ¬</li></ol></li><li><p>è¦æƒ³åšåˆ°ä¸åœæœºå®Œæˆæ–°èŠ‚ç‚¹æ·»åŠ ï¼Œé€»è¾‘ä¸Šä¸»è¦æ“ä½œå¦‚ä¸‹ï¼š</p><ol><li><strong>ç”Ÿæˆå¿«ç…§</strong>ï¼šåœ¨æŸåˆ»å¯¹ä¸»èŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬äº§ç”Ÿä¸€ä¸ªä¸€è‡´æ€§å¿«ç…§ï¼ˆé¿å…é•¿æ—¶é—´é”åº“ï¼‰</li><li><strong>å¿«ç…§å‘é€</strong>ï¼šå¿«ç…§å‘é€åˆ°æ–°çš„ä»èŠ‚ç‚¹ï¼ˆè¿™æ ·å¤§éƒ¨åˆ†çš„å†å²æ•°æ®å°±æœ‰äº†ï¼‰</li><li><strong>å˜æ›´æ—¥å¿—</strong>ï¼šä»èŠ‚ç‚¹ä¸Šçº¿è¿æ¥åˆ°ä¸»èŠ‚ç‚¹ï¼Œ<strong>è¯·æ±‚å¿«ç…§ç‚¹ä¹‹åå‘ç”Ÿçš„æ‰€æœ‰æ•°æ®æ›´æ”¹æ—¥å¿—</strong>ï¼ˆå¢é‡ï¼‰</li><li><strong>è¿½èµ¶</strong>ï¼šè·å¾—æ—¥å¿—åï¼Œä»èŠ‚ç‚¹åº”ç”¨å¿«ç…§åçš„æ•°æ®å˜æ›´ã€‚ç»§ç»­å¤„ç†ä¸»èŠ‚ç‚¹ä¸Šæ–°æ•°æ®å˜åŒ–ã€‚å¹¶é‡å¤æ­¥éª¤ 1~4</li></ol></li></ol><h3 id="èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ"><a href="#èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ"></a>èŠ‚ç‚¹å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ</h3><ol><li><strong>ä»èŠ‚ç‚¹å¤±æ•ˆï¼šè¿½èµ¶å¼æ¢å¤</strong>ã€‚ä»èŠ‚ç‚¹å¯æ ¹æ®å‰¯æœ¬çš„å¤åˆ¶æ—¥å¿—å¾—çŸ¥æ•…éšœå‰æœ€åä¸€ç¬”äº‹åŠ¡ï¼Œç„¶åå‘ä¸»èŠ‚ç‚¹è¯·æ±‚è¯¥äº‹åŠ¡ä¹‹åä¸­æ–­æœŸé—´å†…çš„æ‰€æœ‰æ•°æ®å˜æ›´ï¼Œå¹¶åº”ç”¨å˜æ›´ï¼Œå®Œæˆè¿½èµ¶ã€‚</li><li><p><strong>ä¸»èŠ‚ç‚¹å¤±æ•ˆï¼šèŠ‚ç‚¹åˆ‡æ¢</strong>ï¼š</p><ol><li>æ•…éšœåˆ‡æ¢å¯æ‰‹åŠ¨ï¼Œå¯è‡ªåŠ¨ã€‚</li><li>è‡ªåŠ¨åˆ‡æ¢å¸¸è§„æ­¥éª¤ï¼š<ol><li><em>ç¡®å®šä¸»èŠ‚ç‚¹å¤±æ•ˆ</em>ã€‚å¤šé‡‡ç”¨åŸºäºè¶…æ—¶çš„æœºåˆ¶ï¼Œå¯ä»¥å‘¨æœŸæ€§åœ°å‘é€å¿ƒè·³åŒ…ã€‚</li><li><em>é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹</em>ã€‚æ¶‰åŠåˆ°å…±è¯†çš„ç®—æ³•ï¼ŒåŸåˆ™æ˜¯è¦ä¿è¯æ–°çš„ä¸»èŠ‚ç‚¹ä¸åŸæ¥çš„æ•°æ®å·®å¼‚æœ€å°ï¼Œå°½å¯èƒ½å‡å°‘æ•°æ®ä¸¢å¤±é£é™©ã€‚</li><li><em>é‡æ–°é…ç½®ç³»ç»Ÿï¼Œç”Ÿæ•ˆä¸»èŠ‚ç‚¹</em>ã€‚å®¢æˆ·ç«¯éœ€è¦å°†å†™è¯·æ±‚å‘é€åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¯¹äºåŸä¸»èŠ‚ç‚¹æ¢å¤åéœ€è¦ç¡®ä¿å…¶è¢«é™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œè®¤å¯æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li></ol></li></ol></li><li><p>éœ€è¦æ€è€ƒçš„é—®é¢˜ï¼š</p><ol><li>å¦‚æœé‡‡ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹é€‰ä¸¾åï¼ŒåŸä¸»èŠ‚ç‚¹ä¹Ÿä¸Šçº¿ï¼Œæ–°çš„ä¸»èŠ‚ç‚¹å¯èƒ½ä¼šæ”¶åˆ°<strong>å†™å†²çª</strong>ã€‚ç®€å•ç²—æš´çš„æ–¹å¼å°±æ˜¯ï¼ŒæŠ›å¼ƒåŸä¸»èŠ‚ç‚¹æœªå®Œæˆå¤åˆ¶çš„å†™è¯·æ±‚ï¼Œè¿èƒŒæ•°æ®æŒä¹…åŒ–æ‰¿è¯ºã€‚</li><li><strong>è„‘è£‚ï¼ˆBrain-Splitï¼‰</strong>é—®é¢˜ï¼Œä¸¤ä¸ªä¸»èŠ‚ç‚¹éƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œä¼šå¯¼è‡´æ•°æ®å†²çªã€ä¸¢å¤±æˆ–è€…ç ´åç­‰ã€‚å¯ç²—æš´åœ°å…³é—­æŸä¸ªä¸»èŠ‚ç‚¹ã€‚</li><li>è¶…æ—¶è®¾ç½®å¤šä¹…æ‰åˆé€‚ï¼Ÿå¤ªé•¿ï¼Œæ„å‘³ç€ä¸»èŠ‚ç‚¹å®•æœºåï¼Œæ€»ä½“æ¢å¤æ—¶é—´å˜é•¿ï¼›å¤ªçŸ­ï¼Œä¼šå¯¼è‡´å¾ˆå¤šä¸å¿…è¦çš„åˆ‡æ¢ã€‚å°¤å…¶æ˜¯ç³»ç»Ÿå¤„äºé«˜è´Ÿè½½çš„å‹åŠ›ä¸‹ï¼ŒåŒæ—¶ç½‘ç»œæ‹¥å¡ä¸¥é‡ï¼Œä¸å¿…è¦çš„åˆ‡æ¢ä¼šå¯¼è‡´æƒ…å†µæ›´åŠ ç³Ÿç³•ã€‚</li></ol></li></ol><h3 id="å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°"><a href="#å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°" class="headerlink" title="å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°"></a>å¤åˆ¶æ—¥å¿—å¦‚ä½•å®ç°</h3><ol><li><p><strong>åŸºäºè¯­å¥çš„å¤åˆ¶</strong>ï¼š</p><ol><li>çœ‹èµ·æ¥ä¸å¤æ‚</li><li>ä¸é€‚ç”¨çš„åœºæ™¯ï¼šè°ƒç”¨éç¡®å®šæ€§å‡½æ•°çš„è¯­å¥ï¼›å‰¯æœ¬éœ€è¦ä¸¥æ ¼æŒ‰ç…§å®Œå…¨ç›¸åŒçš„é¡ºåºæ‰§è¡Œè¯­å¥ï¼ˆé’ˆå¯¹ä¾èµ–æ•°æ®åº“çš„ç°æœ‰æ•°æ®çš„æƒ…å†µï¼‰ï¼›æœ‰å‰¯ä½œç”¨çš„è¯­å¥ï¼Œåœ¨ä¸åŒçš„èŠ‚ç‚¹å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„å‰¯ä½œç”¨</li></ol></li><li><p><strong>åŸºäº WAL ä¼ è¾“</strong>ï¼š</p><ol><li>å¯ä»¥åŸºäº WAL æ„å»ºä¸€ä¸ªå®Œæ•´çš„å‰¯æœ¬</li><li>æ—¥å¿—æè¿°çš„æ•°æ®ç»“æ„å¾ˆåº•å±‚ï¼Œå¤åˆ¶æ–¹æ¡ˆä¸å­˜å‚¨å¼•æ“ç´§å¯†è€¦åˆï¼›åè®®ç‰ˆæœ¬å‡çº§éœ€è¦é¡¾è™‘çš„è¾ƒå¤š</li></ol></li><li><p><strong>åŸºäºè¡Œçš„é€»è¾‘æ—¥å¿—å¤åˆ¶</strong>ï¼š</p><ol><li>é€»è¾‘æ—¥å¿—ï¼ŒåŒºåˆ†ç‰©ç†å­˜å‚¨å¼•æ“çš„æ•°æ®è¡¨ç¤ºã€‚æè¿°æ•°æ®è¡¨è¡Œçº§åˆ«çš„å†™è¯·æ±‚ã€‚</li><li>ä¸å­˜å‚¨å¼•æ“é€»è¾‘è§£è€¦ï¼Œä¾¿äºä¿æŒå‘åå…¼å®¹ã€‚è¿™æ ·ä¸»ä»èŠ‚ç‚¹ç”šè‡³å¯ä»¥è¿è¡Œä¸åŒçš„ç‰ˆæœ¬æˆ–è€…ä½¿ç”¨ä¸åŒçš„å­˜å‚¨å¼•æ“ã€‚</li><li>å®¹æ˜“è§£æï¼Œæ˜“äºå¤–éƒ¨ç³»ç»Ÿå¤„ç†</li></ol></li><li><p><strong>åŸºäºè§¦å‘å™¨çš„å¤åˆ¶</strong>ï¼šç»™åº”ç”¨å±‚æä¾›äº†ä¸€å®šçš„çµæ´»æ€§ï¼Œä½†æ˜¯å¤åˆ¶å¼€é”€æ›´é«˜ã€‚</p></li></ol><h2 id="å¤åˆ¶æ»åé—®é¢˜"><a href="#å¤åˆ¶æ»åé—®é¢˜" class="headerlink" title="å¤åˆ¶æ»åé—®é¢˜"></a>å¤åˆ¶æ»åé—®é¢˜</h2><h3 id="è¯»è‡ªå·±çš„å†™ï¼ˆRead-After-Writeï¼‰"><a href="#è¯»è‡ªå·±çš„å†™ï¼ˆRead-After-Writeï¼‰" class="headerlink" title="è¯»è‡ªå·±çš„å†™ï¼ˆRead After Writeï¼‰"></a>è¯»è‡ªå·±çš„å†™ï¼ˆRead After Writeï¼‰</h3><p><img src="./read-after-write.png" alt=""></p><ol><li>è¯¥æœºåˆ¶è¦ä¿è¯ç”¨æˆ·æ€»èƒ½çœ‹åˆ°è‡ªå·±æœ€è¿‘æäº¤çš„æ›´æ–°ã€‚</li><li>å¦‚ä½•å®ç°ï¼Ÿ<ol><li>å¦‚æœç”¨æˆ·è®¿é—®å¯èƒ½è¢«ä¿®æ”¹çš„å†…å®¹ï¼Œåˆ™ä»ä¸»èŠ‚ç‚¹è¯»ï¼›å¦åˆ™ä»ä»èŠ‚ç‚¹è¯»ã€‚</li><li>é’ˆå¯¹å¤§éƒ¨åˆ†éƒ½ä¼šè¢«ä¿®æ”¹çš„åœºæ™¯ï¼Œä¸Šè¿°æ–¹å¼ä¼šä¸§å¤±ä»èŠ‚ç‚¹çš„å­˜åœ¨æ„ä¹‰ã€‚å¯ä»¥è€ƒè™‘è·Ÿè¸ªæœ€æ–°çš„æ›´æ–°æ—¶é—´ï¼Œå¯¹äºæ›´æ–°æ—¶é—´åœ¨æœ€è¿‘ä¸€åˆ†é’Ÿçš„ï¼Œä»ä¸»èŠ‚ç‚¹è¯»å–ã€‚åŒæ—¶éœ€è¦æ·»åŠ ç›‘æ§ã€‚</li></ol></li></ol><h3 id="å•è°ƒè¯»"><a href="#å•è°ƒè¯»" class="headerlink" title="å•è°ƒè¯»"></a>å•è°ƒè¯»</h3><p><img src="./monotonic-read.png" alt=""></p><ol><li>ç”¨æˆ·åœ¨è¯»å–ä¿®æ”¹äº†çš„æ•°æ®æ—¶ï¼Œå‡ºç°ã€Œå›æ»šã€çš„ç°è±¡ã€‚ä¹Ÿå°±æ˜¯æ˜æ˜ä¿®æ”¹äº†ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™çœ‹åˆ°äº†æ–°çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¯»å–çš„æ—¶å€™å´çœ‹åˆ°äº†æ—§çš„æ•°æ®ï¼ˆå¤šèŠ‚ç‚¹æ•°æ®æœªåŒæ­¥ï¼‰ã€‚</li><li>å•è°ƒè¯»è¦æä¾›çš„ä¿è¯å°±æ˜¯é¿å…è¿™ç§å¥‡æ€ªçš„å›æ»šç°è±¡ï¼Œå®ƒæ¯”å¼ºä¸€è‡´æ€§è¦å¼±ï¼Œä½†æ¯”æœ€ç»ˆä¸€è‡´æ€§è¦å¼ºã€‚</li><li>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥è€ƒè™‘åŒä¸€ä¸ªç”¨æˆ·æ€»æ˜¯ä»æŸä¸ªå›ºå®šçš„å‰¯æœ¬è¯»å–ï¼ˆä¸åŒçš„ç”¨æˆ·åˆ†å‘åˆ°ä¸åŒçš„å‰¯æœ¬ï¼‰ã€‚</li></ol><h3 id="å‰ç¼€ä¸€è‡´è¯»"><a href="#å‰ç¼€ä¸€è‡´è¯»" class="headerlink" title="å‰ç¼€ä¸€è‡´è¯»"></a>å‰ç¼€ä¸€è‡´è¯»</h3><p><img src="./prefix-read.png" alt=""></p><ol><li>è¯¥æœºåˆ¶è¦ä¿è¯å¯¹äºä¸€ç³»åˆ—æŒ‰ç…§ç‰¹å®šé¡ºåºçš„å†™è¯·æ±‚ï¼Œåœ¨è¯»å–è¿™äº›å†…å®¹æ—¶è¦è¦éµå¾ªåŒæ ·çš„é¡ºåºã€‚å¦åˆ™å¯èƒ½ä¼šçœ‹åˆ°å…ˆæœ‰æœï¼Œå†æœ‰å› çš„å¥‡æ€ªç°è±¡ï¼Œä»¿ä½›é‡åˆ°äº†å…ˆçŸ¥ã€‚</li><li>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æ‹¥æœ‰å› æœå…³ç³»çš„å†™å…¥éƒ½æäº¤ç»™æŸä¸ªç‰¹å®šåˆ†åŒºå®Œæˆï¼Œä½†æ˜¯å®é™…æ•ˆç‡æ¯”è¾ƒä½ã€‚</li></ol><h2 id="å¤šä¸»èŠ‚ç‚¹å¤åˆ¶"><a href="#å¤šä¸»èŠ‚ç‚¹å¤åˆ¶" class="headerlink" title="å¤šä¸»èŠ‚ç‚¹å¤åˆ¶"></a>å¤šä¸»èŠ‚ç‚¹å¤åˆ¶</h2><p><img src="./multi-master-nodes.png" alt=""></p><ol><li>ä¸»ä»æ¨¡å¼çš„ç¼ºç‚¹ï¼šç³»ç»Ÿä»…æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ‰¿è½½æ‰€æœ‰çš„å†™è¯·æ±‚ã€‚å¦‚æœä¸»èŠ‚ç‚¹å®•æœºï¼Œä¼šå½±å“æ‰€æœ‰çš„å†™å…¥æ“ä½œã€‚</li><li>å¤šä¸»èŠ‚ç‚¹å¤åˆ¶ï¼š<ol><li>æ¯ä¸ªä¸»èŠ‚ç‚¹åˆ†åˆ«æ¥å—å†™è¯·æ±‚ï¼Œå¹¶å¤åˆ¶ï¼ˆå¼‚æ­¥ or åŒæ­¥ï¼‰ç»™å¯¹åº”çš„ä»èŠ‚ç‚¹</li><li>æ¯ä¸ªä¸»èŠ‚ç‚¹æ‰®æ¼”å…¶å®ƒä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹</li></ol></li></ol><h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><ol><li>å¤šæ•°æ®ä¸­å¿ƒ</li><li>ç¦»çº¿å®¢æˆ·ç«¯æ“ä½œï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯ WizNoteï¼‰ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½å……å½“ä¸»èŠ‚ç‚¹çš„æœ¬åœ°æ•°æ®åº“ï¼Œè®¾å¤‡ä¹‹é—´é‡‡ç”¨å¼‚æ­¥åŒæ­¥æ–¹å¼å®Œæˆæ•°æ®åŒæ­¥ã€‚åŒæ­¥æ»åæ—¶é—´ä¸å®šã€‚</li><li>åä½œç¼–è¾‘</li></ol><h2 id="æ— ä¸»èŠ‚ç‚¹å¤åˆ¶"><a href="#æ— ä¸»èŠ‚ç‚¹å¤åˆ¶" class="headerlink" title="æ— ä¸»èŠ‚ç‚¹å¤åˆ¶"></a>æ— ä¸»èŠ‚ç‚¹å¤åˆ¶</h2><ol><li>äºšé©¬é€Šçš„ Dynamo ç³»ç»Ÿæ˜¯å…¸å‹çš„ä»£è¡¨ï¼ŒRiakã€Cassandra ä¹Ÿå—åˆ°äº†å¯å‘ã€‚</li><li>å®¢æˆ·ç«¯ç›´æ¥å°†å†™è¯·æ±‚å‘é€ç»™å¤šä¸ªå‰¯æœ¬ï¼Œæˆ–è€…äº¤ç»™åè°ƒè€…ï¼ˆä¸ä¿è¯å†™å…¥é¡ºåºï¼‰æ¥å‘é€ã€‚</li><li><p>æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼Ÿ</p><ol><li>è¯»æ—¶ä¿®å¤</li><li>åç†µï¼šè¡¥å¿æœºåˆ¶ï¼Œå¯»æ‰¾èŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œå°†ç¼ºå°‘çš„æ•°æ®ç»™è¡¥å……å¥½ã€‚è¯¥è¿‡ç¨‹ä¸ä¿è¯ç‰¹å®šé¡ºåºçš„å¤åˆ¶å†™å…¥ã€‚<br><img src="./repair-on-read.png" alt=""></li></ol></li><li><p>è¯»å†™ quorumï¼š</p><ol><li>ä¿è¯ï¼šw + r &gt; nï¼ˆæ€»èŠ‚ç‚¹æ•°ï¼‰</li><li>é€šå¸¸ n ä¸ºå¥‡æ•°ï¼Œw = r = (n+1)/2 ï¼ˆå‘ä¸Šèˆå…¥ï¼‰</li><li>quorum ä¸ä¸€å®šéå¾—æ˜¯å¤šæ•°ï¼Œè¯»å†™èŠ‚ç‚¹é›†åˆä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯é‡å çš„èŠ‚ç‚¹æ‰æœ€ä¸ºå…³é”®ï¼</li><li>ä¸èƒ½ä¿è¯æ€»èƒ½è¯»å–åˆ°æœ€æ–°å€¼ï¼ŒDynamo æ•°æ®åº“é€šå¸¸é’ˆå¯¹æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ä¼˜åŒ–çš„ã€‚</li></ol></li><li>å¹¶å‘æ£€æµ‹ï¼ˆè¿™å—è¿˜æ˜¯å»ºè®®çœ‹ä¹¦ä¸­çš„ä¾‹å­å§ï¼‰ï¼š<ol><li>æœ€åå†™å…¥è€…è·èƒœï¼ˆLWWï¼‰ï¼Œä¸¢å¼ƒå¹¶å‘å†™å…¥ã€‚å¯å®ç°æœ€ç»ˆæ”¶æ•›ç›®æ ‡ï¼Œä½†æ˜¯ç‰ºç‰²äº†æ•°æ®æŒä¹…æ€§ä¸ºä»£ä»·ã€‚</li><li>Happens-before å…³ç³»ä¸å¹¶å‘</li><li>ç¡®å®šå‰åå…³ç³»ï¼šä½¿ç”¨ç‰ˆæœ¬å·</li><li>åˆå¹¶åŒæ—¶å†™å…¥çš„å€¼</li><li>ç‰ˆæœ¬çŸ¢é‡</li></ol></li></ol><h1 id="æ•°æ®åˆ†åŒº"><a href="#æ•°æ®åˆ†åŒº" class="headerlink" title="æ•°æ®åˆ†åŒº"></a>æ•°æ®åˆ†åŒº</h1><ol><li>å®šä¹‰ï¼šæ¯æ¡æ•°æ®ï¼ˆæˆ–è€…è®°å½•ã€æ–‡æ¡£ï¼‰åªå±äºæŸä¸ªç‰¹å®šåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯è§†ä¸ºä¸€ä¸ªå®Œæ•´çš„å°å‹æ•°æ®åº“ï¼Œæ˜¯æ•´ä¸ªæ•°æ®é›†çš„ä¸€éƒ¨åˆ†ã€‚</li><li><p>ä¸ºä»€ä¹ˆè¦åˆ†åŒºï¼Ÿ</p><ol><li>æé«˜ç³»ç»Ÿæ‰©å±•æ€§ï¼šå°†å¤§çš„æ•°æ®é›†åˆ†æ•£åˆ°æ›´å¤šçš„èŠ‚ç‚¹ï¼Œè´Ÿè½½å‡è¡¡</li><li>æé«˜æŸ¥è¯¢ååé‡ï¼šè·¨åˆ†åŒºå¹¶å‘æŸ¥è¯¢</li></ol></li><li><p>åˆ†åŒºå’Œå¤åˆ¶é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œæ¯ä¸ªåˆ†åŒºåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å‰¯æœ¬ï¼Œæé«˜ç³»ç»Ÿçš„å®¹é”™æ€§ï¼š<br> <img src="./partition.png" alt=""></p></li></ol><h2 id="KV-æ•°æ®åˆ†åŒº"><a href="#KV-æ•°æ®åˆ†åŒº" class="headerlink" title="KV æ•°æ®åˆ†åŒº"></a>KV æ•°æ®åˆ†åŒº</h2><ol><li><p>åˆ†åŒºå¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼š</p><ol><li>åˆ†åŒºä¸å‡åŒ€ï¼Œä¼šé€ æˆè®¿é—®å€¾æ–œçš„é—®é¢˜ï¼Œç”šè‡³å¯èƒ½é€ æˆçƒ­ç‚¹</li><li>å¯é‡‡ç”¨éšæœºåˆ†é…åˆ°æ‰€æœ‰èŠ‚ç‚¹é¿å…çƒ­ç‚¹é—®é¢˜ï¼Œä½†æ˜¯æŸ¥è¯¢ä¼šå¾ˆå›°éš¾ï¼ˆå¯èƒ½éœ€è¦å¹¶å‘è¯·æ±‚æ‰€æœ‰åˆ†åŒºï¼‰</li></ol></li><li><p>åŸºäºå…³é”®å­—åŒºé—´åˆ†åŒºï¼š</p><ol><li>æ ¸å¿ƒæ˜¯<strong>ä¸ºæ¯ä¸ªåˆ†åŒºåˆ†é…ä¸€æ®µè¿ç»­çš„å…³é”®å­—æˆ–è€…å…³é”®å­—åŒºé—´</strong>ï¼ˆä»¥æœ€å°å€¼å’Œæœ€å¤§å€¼æ¥è¡¨ç¤ºï¼‰</li><li>å…³é”®å­—åŒºé—´æ®µä¸ä¸€å®šè¦å‡åŒ€åˆ†å¸ƒ</li><li>æ”¯æŒåŒºé—´æŸ¥è¯¢æ–¹ä¾¿ï¼ˆæœ‰ä¸€å®šé¡ºåºï¼‰</li><li>å¯èƒ½ä¼šæœ‰çƒ­ç‚¹é—®é¢˜ï¼ˆæ¯”å¦‚æŒ‰ç…§æ—¶é—´æˆ³èŒƒå›´åˆ’åˆ†ï¼Œå¯èƒ½æœ€æ–°çš„æ—¥æœŸè¯»å†™å°±å¾ˆå¤šï¼‰ï¼Œå¯ä»¥è€ƒè™‘å†æ·»åŠ åˆ«çš„å­—æ®µæ¥ç»„åˆå†³å®šåˆ†åŒº</li></ol></li><li><p>åŸºäºå…³é”®å­—å“ˆå¸Œå€¼åˆ†åŒºï¼š</p><ol><li>å¥½çš„å“ˆå¸Œå‡½æ•°å¯å¤„ç†æ•°æ®å€¾æ–œï¼Œå‡åŒ€åˆ†å¸ƒ</li><li>ä¸§å¤±è‰¯å¥½çš„åŒºé—´æŸ¥è¯¢ç‰¹æ€§<br><img src="./partition-with-hash.png" alt=""></li></ol></li><li><p>è´Ÿè½½å€¾æ–œå’Œçƒ­ç‚¹ï¼š</p><ol><li>å³ä¾¿é€šè¿‡å“ˆå¸Œå€¼åˆ†åŒºçš„æ–¹æ¡ˆï¼Œä¹Ÿä¸èƒ½å®Œå…¨é¿å…çƒ­ç‚¹é—®é¢˜ã€‚æç«¯æƒ…å†µæ˜¯ï¼Œæ‰€æœ‰çš„è¯»å†™éƒ½é’ˆå¯¹åŒä¸€ä¸ªå…³é”®å­—ï¼ˆå¦‚å¾®åšå¤§ Vï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½åˆ°äº†åŒä¸€ä¸ªåˆ†åŒºã€‚</li><li>å¤§å¤šæ•°ç³»ç»Ÿæ— æ³•è‡ªåŠ¨æ¶ˆé™¤è¿™ç§é«˜åº¦å€¾æ–œçš„è´Ÿè½½ï¼Œéœ€è¦åº”ç”¨å±‚ä»‹å…¥ã€‚</li></ol></li></ol><h2 id="åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•"><a href="#åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•" class="headerlink" title="åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•"></a>åˆ†åŒºå’ŒäºŒçº§ç´¢å¼•</h2><ol><li>äºŒçº§ç´¢å¼•çš„æŒ‘æˆ˜æ˜¯ä¸èƒ½è§„æ•´åœ°æ˜ å°„åˆ°åˆ†åŒºä¸­ã€‚</li><li><p>åŸºäºæ–‡æ¡£åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š</p><ol><li>æ¯ä¸ªåˆ†åŒºåªå…³æ³¨è‡ªå·±çš„åˆ†åŒºçš„æ–‡æ¡£ï¼Œå¹¶å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•</li><li>æŸ¥è¯¢æ—¶å»¶è¿Ÿæ”¾å¤§ä¸¥é‡ï¼Œéœ€è¦åˆ†æ•£æŸ¥è¯¢å¹¶åˆå¹¶ç»“æœï¼Œä»£ä»·è¾ƒé«˜<br><img src="./secondary-index-on-doc.png" alt=""></li></ol></li><li><p>åŸºäºè¯æ¡åˆ†åŒºçš„äºŒçº§ç´¢å¼•ï¼š</p><ol><li>å¯¹æ‰€æœ‰æ•°æ®æ„å»ºå…¨å±€ç´¢å¼•ï¼›å…¨å±€ç´¢å¼•å¹¶éå­˜å‚¨åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆä¼šè¿›è¡Œåˆ†åŒºï¼‰ï¼Œå¯ä»¥å’Œå…³é”®å­—é‡‡å–ä¸åŒçš„åˆ†åŒºç­–ç•¥</li><li>å¯æ”¯æŒé«˜æ•ˆåœ°åŒºé—´æŸ¥è¯¢</li><li>è¯»å–é«˜æ•ˆï¼Œä¸éœ€è¦ scatter/gather æ¨¡å¼</li><li>å†™å…¥é€Ÿåº¦æ…¢ï¼Œä¸”å¾ˆå¤æ‚ï¼Œä¼šæœ‰æ˜¾è‘—çš„å†™æ”¾å¤§é—®é¢˜</li><li>æ‰€æœ‰ç°æœ‰çš„æ•°æ®åº“éƒ½éš¾ä»¥æ”¯æŒåŒæ­¥æ›´æ–°äºŒçº§ç´¢å¼•ï¼Œæ‰€ä»¥é€šå¸¸éƒ½æ˜¯å¼‚æ­¥æ›´æ–°<br><img src="./secondary-index-on-terms.png" alt=""></li></ol></li></ol><h2 id="åˆ†åŒºå†å¹³è¡¡"><a href="#åˆ†åŒºå†å¹³è¡¡" class="headerlink" title="åˆ†åŒºå†å¹³è¡¡"></a>åˆ†åŒºå†å¹³è¡¡</h2><ol><li>å³å°†æ•°æ®å’Œè¯·æ±‚ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§è¿ç§»è´Ÿè½½çš„è¿‡ç¨‹è¢«å«ä½œå†å¹³è¡¡ï¼ˆåŠ¨æ€å¹³è¡¡ï¼‰</li><li><p>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ï¼Ÿ</p><ol><li>æŸ¥è¯¢å‹åŠ›å¢åŠ ï¼Œéœ€è¦å¢åŠ  CPU å¤„ç†è´Ÿè½½</li><li>æ•°æ®è§„æ¨¡å¢åŠ </li><li>èŠ‚ç‚¹æ•…éšœ</li></ol></li><li><p>å†å¹³è¡¡éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼š</p><ol><li>å¹³è¡¡ä¹‹åï¼Œè´Ÿè½½ã€æ•°æ®å­˜å‚¨ã€è¯»å†™è¯·æ±‚ç­‰åœ¨é›†ç¾¤èŒƒå›´æ›´åŠ å‡åŒ€åˆ†å¸ƒ</li><li>å¹³è¡¡è¿‡ç¨‹ä¸èƒ½å½±å“çº¿ä¸ŠæœåŠ¡</li><li>é¿å…ä¸å¿…è¦çš„è´Ÿè½½è¿ç§»ï¼Œå°½é‡å‡å°‘ç½‘ç»œå’Œç£ç›˜ I/O å½±å“</li></ol></li></ol><h3 id="åŠ¨æ€å¹³è¡¡ç­–ç•¥"><a href="#åŠ¨æ€å¹³è¡¡ç­–ç•¥" class="headerlink" title="åŠ¨æ€å¹³è¡¡ç­–ç•¥"></a>åŠ¨æ€å¹³è¡¡ç­–ç•¥</h3><ol><li><p>ç›´æ¥å–æ¨¡æ€ä¹ˆæ ·ï¼Ÿ</p><ol><li>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåº”ç”¨å±‚å¯æ ¹æ®æ¯”å¦‚ç”¨æˆ· ID å’Œåˆ†åŒºæ•°é‡å–æ¨¡ï¼Œå¾—åˆ°å…·ä½“è¦è®¿é—®çš„åˆ†åŒºå¯¹åº”çš„èŠ‚ç‚¹</li><li>æ‰©å±•æˆ–ç§»é™¤èŠ‚ç‚¹å›°éš¾ï¼Œæ¶‰åŠåˆ°å¤§é‡æ•°æ®çš„ç§»åŠ¨ï¼Œåº”ç”¨å±‚ä»£ç ä¹Ÿå¯èƒ½ä¼šè¢«æ³¢åŠ</li></ol></li><li><p>å›ºå®šæ•°é‡çš„åˆ†åŒºï¼š</p><ol><li>åˆå§‹æ—¶æ ¹æ®é•¿è¿œè§„åˆ’ï¼Œè®¾ç½®ä¸€ä¸ªè¿œè¶…å®é™…èŠ‚ç‚¹æ•°çš„åˆ†åŒºæ•°ï¼ˆæ¯”å¦‚ 1000ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å¤šä¸ªåˆ†åŒºã€‚<strong>æ¯ä¸ªåˆ†åŒºçš„å¤§å°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³</strong>ã€‚</li><li>æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œä»å…¶ä»–èŠ‚ç‚¹åŒ€èµ°è‹¥å¹²åˆ†åŒºï¼Œç›´åˆ°å†æ¬¡è¾¾åˆ°å…¨å±€å¹³è¡¡ï¼›åˆ é™¤èŠ‚ç‚¹ï¼Œåˆ™é‡‡å–ç›¸åçš„æªæ–½ã€‚</li><li>éœ€è¦æ”¹å˜åˆ†åŒºå’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼›ä½†æ˜¯æ€»çš„åˆ†åŒºæ•°ä¸ä¼šå˜ï¼Œå…³é”®å­—æ˜ å°„ä¹Ÿä¸ä¼šå˜ã€‚</li><li>å¯¹äºæ•°æ®è§„æ¨¡é«˜åº¦ä¸ç¡®å®šæˆ–è€…å¯å˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚</li><li>Riak, ES, Couchbase ç­‰æ”¯æŒè¿™ç§åŠ¨æ€å¹³è¡¡ç­–ç•¥ã€‚<br><img src="./rebalance.png" alt=""></li></ol></li><li><p>åŠ¨æ€åˆ†åŒº</p><ol><li>å¦‚ HBase å’Œ RethinkDBï¼Œå¯ä»¥åœ¨åˆ†åŒºæ•°æ®å¢é•¿åˆ°æŸä¸ªé˜ˆå€¼ï¼ˆHBase é»˜è®¤é˜ˆå€¼ä¸º 10GBï¼‰è‡ªåŠ¨æ‹†åˆ†æˆä¸¤ä¸ªåˆ†åŒºï¼›å¦‚æœæ•°æ®è¢«å¤§é‡åˆ é™¤ï¼Œä¸”åˆ†åŒºç¼©å°åˆ°æŸä¸ªé˜ˆå€¼ï¼Œå°†ç›¸é‚»çš„åˆ†åŒºè¿›è¡Œåˆå¹¶ã€‚<strong>ç±»ä¼¼ B æ ‘åˆ†è£‚</strong>ã€‚</li><li>åˆ†åŒºæ•°é‡è‡ªåŠ¨é€‚é…åˆ†åŒºæ€»é‡ï¼Œå°‘é‡æ•°æ®-&gt;å°‘é‡åˆ†åŒº-&gt;è¾ƒå°çš„ç³»ç»Ÿå¼€é”€ï¼›æ¯ä¸ªåˆ†åŒºæœ€å¤§å€¼å¯è¢«é™åˆ¶ã€‚<strong>åˆ†åŒºæ€»æ•°å’Œæ•°æ®é›†å¤§å°æˆæ­£æ¯”ï¼Œå’ŒèŠ‚ç‚¹æ•°æ— å…³</strong>ã€‚</li><li>é¢„åˆ†è£‚å¯é¿å…åˆæœŸå…ˆéªŒæ¡ä»¶ä¸è¶³ï¼Œæ— æ³•ç¡®å®šè¾ƒé€‚åˆçš„è¾¹ç•Œï¼Œå¯¼è‡´å†™å…¥éƒ½é›†ä¸­åœ¨å•ä¸ªèŠ‚ç‚¹å¤„ç†çš„é—®é¢˜ã€‚HBase å’Œ MongoDB éƒ½æ”¯æŒé…ç½®åˆå§‹åˆ†åŒºã€‚</li><li>é€‚åˆå…³é”®å­—åŒºé—´åˆ†åŒºå’Œå“ˆå¸Œåˆ†åŒºç­–ç•¥ã€‚</li></ol></li><li><p>æŒ‰èŠ‚ç‚¹æ¯”ä¾‹åˆ†åŒºï¼šCassandra å’Œ Ketama é‡‡ç”¨äº†å°†åˆ†åŒºæ•°å’Œé›†ç¾¤èŠ‚ç‚¹æ•°æˆæ­£æ¯”å…³ç³»çš„æ–¹å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºæ•°å›ºå®šï¼š</p><ol><li>èŠ‚ç‚¹æ•°ä¸å˜æ—¶ï¼Œåˆ†åŒºå¤§å°å’Œæ•°æ®é›†æ€»é‡æˆæ­£æ¯”</li><li>èŠ‚ç‚¹æ•°å¢åŠ æ—¶ï¼Œåˆ†åŒºåˆ™ä¼šå˜å°</li><li>åˆ†åŒºå¤§å°ä¿æŒç¨³å®šï¼Œå¯æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹æ‰¿è½½æ›´å¤šçš„æ•°æ®</li></ol></li></ol><h2 id="è¯·æ±‚è·¯ç”±"><a href="#è¯·æ±‚è·¯ç”±" class="headerlink" title="è¯·æ±‚è·¯ç”±"></a>è¯·æ±‚è·¯ç”±</h2><ol><li><p>å…¸å‹çš„æœåŠ¡å‘ç°é—®é¢˜ï¼Œå¤„ç†ç­–ç•¥å¦‚ä¸‹ï¼š</p><ol><li><strong>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ„ŸçŸ¥åˆ†åŒºæƒ…å†µ</strong>ï¼šå…è®¸å®¢æˆ·ç«¯è¿æ¥ä»»æ„èŠ‚ç‚¹ã€‚å¦‚æœæŸä¸ªèŠ‚ç‚¹æ°å¥½æ‹¥æœ‰è¯·æ±‚çš„åˆ†åŒºï¼Œåˆ™ç›´æ¥å¤„ç†ï¼›å¦åˆ™å°†è¯·æ±‚è½¬å‘ç»™åˆ«çš„èŠ‚ç‚¹ï¼Œç­‰å¾…ç­”å¤ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li><strong>è·¯ç”±å±‚æ„ŸçŸ¥åˆ†åŒºæƒ…å†µ</strong>ï¼šæ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚å‘é€è‡³ä¸€ä¸ªè·¯ç”±ä»£ç†å±‚ï¼Œç”±å®ƒæ¥åšè½¬å‘ã€‚</li><li><strong>å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ†åŒºå’ŒèŠ‚ç‚¹åˆ†é…å…³ç³»</strong>ï¼šå®¢æˆ·ç«¯å¯å†³å®šè¿æ¥åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œæ— éœ€ä¸­ä»‹ã€‚<br><img src="./route-policies.png" alt=""></li></ol></li><li><p>å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨äº†ç‹¬ç«‹çš„åè°ƒæœåŠ¡ï¼ˆå¦‚ ZooKeeperï¼‰è·Ÿè¸ªé›†ç¾¤ä¸­çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ HBaseï¼ŒKafka ç­‰ã€‚<br><img src="./zookeeper-save-meta.png" alt="">  </p></li><li><p>å¦å¤–ä¸€ç§æ€è·¯æ˜¯èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨ gossip åè®®åŒæ­¥é›†ç¾¤çŠ¶æ€å˜åŒ–ï¼Œæ­¤æ—¶è¯·æ±‚å¯å‘åˆ°ä»»æ„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹è´Ÿè´£å¤„ç†æˆ–è½¬å‘ã€‚æœ€å¤§çš„å¥½å¤„æ˜¯ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä½†æ˜¯èŠ‚ç‚¹å¤æ‚æ€§ä¹Ÿå¢åŠ äº†ã€‚å…¸å‹çš„ä»£è¡¨æ˜¯ Cassandra å’Œ Riakï¼Œå½“ç„¶è¿˜æœ‰ Redis Clusterã€‚</p></li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹ç¬¬äºŒéƒ¨åˆ†</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;å®Œæˆç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ç³»ç»ŸåŸºç¡€å­¦ä¹ åï¼Œå°±å¼€å§‹è¿›å…¥åˆ†å¸ƒå¼æ•°æ®ç³»ç»Ÿçš„ä¸–ç•Œäº†ã€‚å‰é¢å­¦ä¹ çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹å•èŠ‚ç‚¹çš„æƒ…å†µï¼›ç„¶è€Œï¼Œåœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„&lt;strong&gt;æ‰©å±•æ€§&lt;/strong&gt;ã€&lt;strong&gt;å®¹é”™æ€§&lt;/strong&gt;ä»¥åŠ&lt;strong&gt;å»¶è¿Ÿæ€§&lt;/strong&gt;ç­‰ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é€šå¸¸ä¼šæœ‰å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚åº¦è‡ªç„¶ä¹Ÿä¸Šæ¥äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°†ä¸»è¦å­¦ä¹ æ•°æ®ç³»ç»Ÿçš„å¤åˆ¶ã€åˆ†åŒºã€äº‹åŠ¡ã€ä¸€è‡´æ€§å…±è¯†ç®—æ³•ã€ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„ä¸€äº›æŒ‘æˆ˜ç­‰ï¼Œè¿™äº›çŸ¥è¯†éƒ½æ¯”è¾ƒç¡¬æ ¸ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚æ‰€ä»¥ï¼Œã€Œä¸Šè½¦ï¼Œèµ°å§~ã€&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡ç¬”è®°é‡ç‚¹æ˜¯å…³äºæ•°æ®ç³»ç»Ÿçš„å¤åˆ¶å’Œåˆ†åŒºï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§„çš„ä¸»ä»å¤åˆ¶åŸç†ã€å¤šä¸»å¤åˆ¶çš„åº”ç”¨åœºæ™¯ï¼Œå¦å¤–è¿˜ä»‹ç»äº†æ— ä¸»å¤åˆ¶çš„ç³»ç»Ÿï¼ˆå¦‚äºšé©¬é€Š Dynamo ç³»ç»Ÿï¼‰ã€‚æœ€åå°±æ˜¯å…³äºæ•°æ®åˆ†åŒºçš„ä»‹ç»ï¼Œå¯ä»¥äº†è§£ä¸‹å¸¸è§çš„åˆ†åŒºç­–ç•¥ï¼ŒåŠ¨æ€å¹³è¡¡ç­–ç•¥ç­‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="åˆ†å¸ƒå¼æ•°æ®åº“" scheme="http://ifaceless.space/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="æ•°æ®å¤åˆ¶" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/"/>
    
      <category term="æ•°æ®åˆ†åŒº" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/"/>
    
  </entry>
  
  <entry>
    <title>é‡çŒªğŸ—ä¹¦è¯»ä¹¦ç¬”è®°ä¹‹æ•°æ®ç³»ç»ŸåŸºç¡€</title>
    <link href="http://ifaceless.space/2019/08/14/ddia-data-sys-basics/"/>
    <id>http://ifaceless.space/2019/08/14/ddia-data-sys-basics/</id>
    <published>2019-08-14T14:12:51.000Z</published>
    <updated>2019-11-24T09:45:59.880Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDesign Data-Intensive Applicationsï¼‰æ˜¯ä¸€æœ¬éå¸¸æœ‰è¯šæ„ã€éå¸¸ä¼˜ç§€çš„è®²è§£é’ˆå¯¹æ•°æ®å¯†é›†åœºæ™¯ä¸‹ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„ç›®æ ‡ã€åŸåˆ™å’ŒæŠ€æœ¯é€‰å‹ç­‰çŸ¥è¯†ã€‚ä½œè€…ç»“åˆç†è®ºä¸å®è·µï¼Œä¸ºæˆ‘ä»¬å±•ç°äº†ä¸€äº›æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ï¼›åŒæ—¶è¿˜ä»‹ç»äº†ä¸€äº›å…³é”®æŠ€æœ¯ï¼ˆå¦‚å­˜å‚¨å¼•æ“ã€åºåˆ—åŒ–åè®®ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰ç­‰çš„å®ç°åŸç†ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿ<strong>çŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶</strong>ã€‚</p><a id="more"></a><p>å¥½ä¹¦è‡ªç„¶è¦ç²¾è¯»ç»†å“ï¼Œå†™ç‚¹è¯»ä¹¦ç¬”è®°æ‰èƒ½æŠŠæ¡è‡ªå·±çš„å­¦ä¹ è¿›åº¦å’Œç†è§£ç¨‹åº¦ã€‚æ€»çš„æ¥è¯´ï¼Œç¬”è®°å½¢å¼å°†ä»¥å›¾æ–‡ä¸ºä¸»ï¼Œæ€ç»´å¯¼å›¾ä¸ºè¾…çš„æ–¹å¼æ¥å‘ˆç°ã€‚<strong>ç”±äºè¯¥ä¹¦çš„å°é¢æ˜¯ä¸€å¤´é‡çŒªğŸ—ï¼Œæ•…å°†æœ¬ç³»åˆ—è¯»ä¹¦ç¬”è®°å‘½åä¸ºã€Šé‡çŒªä¹¦è¯»ä¹¦ç¬”è®°ã€‹</strong>ã€‚<br>ä¹¦ä¸­ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†å±•å¼€ï¼š</p><ul><li>è®¨è®ºæœ‰å…³å¢å¼ºæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿæ‰€éœ€è¦çš„è‹¥å¹²åŸºæœ¬åŸåˆ™ã€‚</li><li>ä»å•æœºæ•°æ®å­˜å‚¨ä¸“äº«è·¨æœºå™¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚</li><li>ä¸»è¦é’ˆå¯¹æ´¾ç”Ÿæ•°æ®çš„ç³»ç»Ÿè®¾è®¡ï¼Œå¹¶è®¨è®ºæ‰¹å¤„ç†å’Œæµå¼å¤„ç†ã€‚</li></ul><p>é‡çŒªä¹¦å­¦ä¹ å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹æ·±å…¥å­¦ä¹ è·¯çº¿ï¼š</p><ul><li>å…³ç³»å‹æ•°æ®åº“ï¼š<ul><li>MySQL </li><li>å­˜å‚¨å¼•æ“ï¼ˆInnoDB &amp; MyISAMï¼‰</li></ul></li><li>åˆ†å¸ƒå¼æ•°æ®åº“ï¼š<ul><li>ä¸€è‡´æ€§åè®®ï¼ˆPaxos, Raft, Zookeeperï¼‰</li><li>æ•°æ®åº“ï¼ˆTiDB ï¼‰</li><li>å­˜å‚¨å¼•æ“ï¼ˆTiKV &amp; RocksDB &amp; LevelDBï¼‰</li></ul></li><li>éå…³ç³»æ•°æ®åº“æˆ–ç¼“å­˜ç³»ç»Ÿï¼š<ul><li>Redisï¼ˆè®¾è®¡æ€æƒ³ã€æ•°æ®ç»“æ„ã€é›†ç¾¤ç®¡ç†ï¼‰</li><li>HBaseï¼ˆè®¾è®¡æ€æƒ³ã€ä½¿ç”¨æ–¹å¼å’Œåœºæ™¯ã€å­˜å‚¨ç®¡ç†ï¼‰</li></ul></li><li>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼š<ul><li>åº”ç”¨å±‚æ¡†æ¶ï¼ˆCeleryï¼‰</li><li>AMQP åè®®å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRabbitMQï¼‰</li><li>ç®€æ˜“çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆBeanstalkï¼‰</li><li>é«˜ååé‡çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼ˆRocksDBã€Kafkaï¼‰</li></ul></li><li>æœç´¢å¼•æ“ï¼šElasticSearch</li></ul><h1 id="å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ"><a href="#å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ" class="headerlink" title="å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ"></a>å¯é ã€å¯æ‰©å±•ä¸å¯ç»´æŠ¤çš„åº”ç”¨ç³»ç»Ÿ</h1><ol><li><strong>æ•°æ®å¯†é›†å‹ï¼ˆData-Intensiveï¼‰</strong>æ˜¯æŒ‡å¯¹äºä¸€ä¸ªåº”ç”¨ç³»ç»Ÿè€Œè¨€ï¼Œã€Œæ•°æ®ã€æ˜¯å…¶æˆè´¥çš„å†³å®šæ€§å› ç´ ï¼ŒåŒ…æ‹¬<strong>æ•°æ®çš„è§„æ¨¡ã€æ•°æ®çš„å¤æ‚åº¦æˆ–æ•°æ®äº§ç”Ÿå’Œå˜åŒ–çš„é€Ÿç‡ç­‰</strong>ã€‚</li><li><strong>è®¡ç®—å¯†é›†å‹ï¼ˆCompute-Intensiveï¼‰</strong>ï¼Œä»¥è®¡ç®—ä¸ºä¸»çš„ç³»ç»Ÿï¼ŒCPU ä¸»é¢‘é€šå¸¸æ˜¯å®ƒçš„åˆ¶çº¦ç“¶é¢ˆ</li><li><strong>æ•°æ®ç³»ç»Ÿ</strong>ï¼š<ol><li>é€šå¸¸æ¥è¯´ï¼Œæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—è¢«è®¤ä¸ºæ˜¯ä¸åŒç±»å‹çš„ç³»ç»Ÿï¼Œæœ‰ä¸åŒçš„æ€§èƒ½å’Œè®¾è®¡å®ç°ï¼›</li><li>ä½†è¿‘å¹´æ¥ï¼ŒæŠ€æœ¯çš„å‘å±•å¯¼è‡´å®ƒä»¬ä¹‹é—´çš„ç•Œé™é€æ¸æ¨¡ç³Šã€‚æ¯”å¦‚ Redis æ—¢å¯ä»¥å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼›Kafka å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿå…·å¤‡æŒä¹…åŒ–çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œç»Ÿä¸€ç§°ä¸ºã€Œæ•°æ®ç³»ç»Ÿï¼ˆdata systemï¼‰ã€ï¼›</li><li>åº”ç”¨ç³»ç»Ÿçš„éœ€æ±‚æ›´åŠ å¹¿æ³›ï¼Œå•ä¸€ç»„ä»¶æ— æ³•æ»¡è¶³æ‰€æœ‰çš„æ•°æ®å¤„ç†å’Œå­˜å‚¨éœ€æ±‚ï¼›é€šå¸¸éœ€è¦ç»„åˆå¤šä¸ªç»„ä»¶ï¼Œå¹¶é€šè¿‡åº”ç”¨å±‚ä»£ç é©±åŠ¨å®ç°è¡”æ¥ã€‚</li></ol></li></ol><h2 id="å¯é æ€§ï¼ˆReliabilityï¼‰"><a href="#å¯é æ€§ï¼ˆReliabilityï¼‰" class="headerlink" title="å¯é æ€§ï¼ˆReliabilityï¼‰"></a>å¯é æ€§ï¼ˆReliabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>å½“æ„å¤–æƒ…å†µï¼ˆåŒ…æ‹¬ç¡¬ä»¶ã€è½¯ä»¶æ•…éšœä»¥åŠäººä¸ºå¤±è¯¯ï¼‰å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿåº”è¯¥å¯ä»¥ç»§ç»­æ­£å¸¸å·¥ä½œã€‚è™½ç„¶æ€§èƒ½ä¼šæœ‰æ‰€é™ä½ï¼Œä½†ä¼šç¡®ä¿åŠŸèƒ½æ­£ç¡®ã€‚</strong></li><li>å¯èƒ½å‡ºé”™çš„äº‹ç§°ä¸º<strong>é”™è¯¯ï¼ˆfaultsï¼‰æˆ–æ•…éšœ</strong>ï¼Œç³»ç»Ÿå¯åº”å¯¹é”™è¯¯ï¼Œåˆ™ç§°ä¸º<strong>å®¹é”™ï¼ˆfault-tolerantï¼‰</strong>æˆ–è€…**å¼¹æ€§ï¼ˆresilientï¼‰ã€‚</li><li><strong>å¤±æ•ˆï¼ˆfailureï¼‰</strong>æ¯” fault ä¸¥é‡ï¼Œæ„å‘³ç€æ•´ä¸ªç³»ç»Ÿæ— æ³•å¯¹å¤–æä¾›ç”¨æˆ·æ‰€éœ€æœåŠ¡ã€‚</li><li>ç¡¬ä»¶æ•…éšœé—®é¢˜å¯ä»¥é€šè¿‡å¢åŠ å†—ä½™çš„æ–¹å¼æ¥æœ‰æ•ˆè§£å†³ï¼Œä½†ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œè½¯ä»¶å®¹é”™çš„æ–¹å¼ä¹Ÿå¯ä»¥ç”¨æ¥å®¹å¿å¤šæœºå¤±æ•ˆçš„æ‰‹æ®µï¼Œä½œä¸ºç¡¬ä»¶å®¹é”™çš„è¡¥å……ã€‚</li><li>è½¯ä»¶æ•…éšœé—®é¢˜é€šå¸¸éš¾ä»¥é¢„æ–™ï¼Œä¸”ä¸€æ—¦å‘ç”Ÿäº§ç”Ÿçš„å½±å“ä¼šéå¸¸å¹¿æ³›ï¼Œæ¨ªè·¨æ•´ä¸ªç³»ç»Ÿéƒ½å¯èƒ½ã€‚å¹¶æ— å¿«é€Ÿè§£å†³ä¹‹æ³•ã€‚åœ¨ä½¿ç”¨ä¹‹å¤„ï¼Œéœ€è¦è€ƒè™‘å¥½å¾ˆå¤šç»†èŠ‚ï¼Œæ¢³ç†ä¾èµ–å‡è®¾å’Œç³»ç»Ÿé—´çš„äº¤äº’ã€‚å¦å¤–ï¼Œè¿›è¡Œå…¨é¢æµ‹è¯•ï¼Œåšå¥½è¿›ç¨‹éš”ç¦»ï¼Œå…è®¸å´©æºƒåè‡ªåŠ¨é‡å¯ã€‚</li><li>ä¿è¯ç³»ç»Ÿå¯é æ€§ï¼Œå‡å°‘äººä¸ºå¤±è¯¯ï¼š<ol><li>ä»¥æœ€å°å‡ºé”™çš„æ–¹å¼è®¾è®¡ç³»ç»Ÿ</li><li>æƒ³åŠæ³•åˆ†ç¦»æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€å®¹æ˜“å‘ç”Ÿæ•…éšœçš„æ¥å£</li><li>å……åˆ†åœ°æµ‹è¯•</li><li>å½“å‘ç”Ÿäººä¸ºå¤±è¯¯æ—¶ï¼Œæä¾›å¿«é€Ÿæ¢å¤æœºåˆ¶ï¼Œå‡å°‘æ•…éšœå½±å“</li><li>æä¾›è¯¦ç»†æ¸…æ™°çš„å­ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ€§èƒ½æŒ‡æ ‡å’Œé”™è¯¯ç‡</li><li>æ¨è¡Œç®¡ç†æµç¨‹å¹¶åŠ ä»¥åŸ¹è®­</li></ol></li></ol><h2 id="å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰"><a href="#å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰" class="headerlink" title="å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰"></a>å¯æ‰©å±•æ€§ï¼ˆScalabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>éšç€è§„æ¨¡å¢é•¿ï¼ˆåŒ…æ‹¬æ•°æ®é‡ã€æµé‡æˆ–è€…å¤æ‚åº¦ï¼‰ï¼Œç³»ç»Ÿåº”ç”¨èƒ½ä»¥åˆç†çš„æ–¹å¼åŒ¹é…è¿™ç§å¢é•¿ã€‚</strong></li><li>ç”¨æ¥æè¿°ç³»ç»Ÿåº”å¯¹è´Ÿè½½å¢åŠ èƒ½åŠ›çš„æœ¯è¯­ã€‚</li><li><strong>æè¿°è´Ÿè½½</strong>ï¼šéœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯è´Ÿè½½å‚æ•°ã€‚å‚æ•°çš„æœ€ä½³é€‰æ‹©å–å†³äºç³»ç»Ÿçš„ä½“ç³»ç»“æ„ï¼Œå¯èƒ½æ˜¯ Web æœåŠ¡çš„æ¯ç§’è¯·æ±‚é‡ï¼Œæ•°æ®åº“å†™å…¥æ¯”ä¾‹ï¼ŒèŠå¤©å®¤æ´»åŠ¨äººæ•°ï¼Œç¼“å­˜å‘½ä¸­ç‡ï¼Œç”¨æˆ·å…³æ³¨è€…åˆ†å¸ƒæƒ…å†µç­‰ã€‚</li><li><strong>æè¿°æ€§èƒ½</strong>ï¼š<ol><li>æ‰¹å¤„ç†ç³»ç»Ÿå…³æ³¨çš„æ˜¯ååé‡ï¼ˆthroughoutï¼‰</li><li>Web æœåŠ¡å™¨æ›´å…³æ³¨è¯·æ±‚å“åº”æ—¶é—´ï¼Œæ›´ç»å¸¸å…³æ³¨çš„æ˜¯å¹³å‡å“åº”æ—¶é—´</li><li>ä¸­ä½æ•°å“åº”æ—¶é—´é€šå¸¸ä¹Ÿå« p50</li><li>å¸¸è§çš„è¿˜ä¼šå…³æ³¨ p95, p99, p999 å€¼</li><li>æœåŠ¡è´¨é‡ç›®æ ‡ Service Level Objectives, SLO</li><li>æœåŠ¡è´¨é‡åè®® Service Level Agreements, SLA</li></ol></li></ol><h2 id="å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰"><a href="#å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰" class="headerlink" title="å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰"></a>å¯ç»´æŠ¤æ€§ï¼ˆMaintainabilityï¼‰</h2><ol><li>ç›®æ ‡ï¼š<strong>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ–°çš„äººå‘˜å‚ä¸åˆ°ç³»ç»Ÿçš„å¼€å‘å’Œè¿ç»´ï¼Œä»¥ç»´æŠ¤ç°æœ‰åŠŸèƒ½æˆ–é€‚é…æ–°åœºæ™¯ï¼Œç³»ç»Ÿéƒ½åº”è¯¥é«˜æ•ˆè¿è½¬ã€‚</strong></li><li>è°éƒ½ä¸æƒ…æ„¿ç»´æŠ¤é—ç•™ç³»ç»Ÿï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå¯èƒ½è¦ä¿®å¤åˆ«äººåŸ‹ä¸‹çš„å‘ï¼Œåšä¸å–œæ¬¢çš„äº‹æƒ…ã€‚æ‰€ä»¥åœ¨åšç³»ç»Ÿè®¾è®¡ä¹‹åˆï¼Œå°±åº”è¯¥å…³æ³¨ç³»ç»Ÿè®¾è®¡çš„ä¸‰å¤§åŸåˆ™ï¼Œå°½å¯èƒ½å‡å°‘ç»´æŠ¤æœŸçš„éº»çƒ¦ï¼š<ol><li>å¯è¿ç»´æ€§ï¼šè¿ç»´æ›´è½»æ¾</li><li>ç®€å•æ€§ï¼šç®€åŒ–ç³»ç»Ÿå¤æ‚åº¦ï¼Œä½†å¹¶éå‡å°‘äº§å“åŠŸèƒ½ã€‚å¯ä»¥é€šè¿‡è¾ƒå¥½çš„æŠ½è±¡æ¥è®©ç³»ç»Ÿå˜å¾—æ›´æ¸…æ™°å’Œæ˜“äºç†è§£</li><li>å¯æ¼”åŒ–æ€§ï¼šæ˜“äºæ”¹å˜</li></ol></li></ol><h1 id="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€"><a href="#æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€" class="headerlink" title="æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€"></a>æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢è¯­è¨€</h1><ol><li>å¤æ‚çš„åº”ç”¨ç¨‹åºä¼šæœ‰å¾ˆå¤šå±‚ï¼Œä½†æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ¯å±‚éƒ½é€šè¿‡æä¾›ä¸€ä¸ªç®€æ´çš„æ•°æ®æ¨¡å‹æ¥éšè—ä¸‹å±‚çš„å¤æ‚æ€§</li></ol><h2 id="å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“"><a href="#å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“" class="headerlink" title="å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“"></a>å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“</h2><ol><li><p>NoSQL æ•°æ®åº“å‡ å¤§é©±åŠ¨å› ç´ ï¼š</p><ol><li>æ¯”å…³ç³»æ•°æ®åº“æ‰©å±•æ€§å¥½ï¼Œæ”¯æŒè¶…å¤§æ•°æ®é›†æˆ–è¶…é«˜å†™å…¥ååé‡</li><li>å¼€æºå…è´¹å±…å¤š</li><li>å…³ç³»æ¨¡å‹ä¸èƒ½å¾ˆå¥½æ”¯æŒæŸäº›ç‰¹å®šæŸ¥è¯¢</li></ol></li><li><p>ä»»ä½•å¯¹äººç±»æœ‰æ„ä¹‰çš„ä¸œè¥¿éƒ½å¯èƒ½åœ¨å°†æ¥æŸä¸ªæ—¶åˆ»å‘ç”Ÿæ”¹å˜ã€‚æ‰€ä»¥åœ¨æ•°æ®åº“ä¸­æˆ‘ä»¬ä½¿ç”¨å…³è”çš„ ID ä½œä¸ºæ ‡å¿—çš„å¥½å¤„å°±æ˜¯å®ƒæ²¡æœ‰ç›´æ¥æ„ä¹‰ï¼Œæ°¸è¿œä¸éœ€è¦ç›´æ¥æ”¹å˜</p></li><li><p>å±‚æ¬¡æ¨¡å‹ï¼š</p><ol><li>ä»£è¡¨æ˜¯ IBM çš„ Information Mangagement System, IMS</li><li>ç±»ä¼¼ JSON ç»“æ„ï¼Œèƒ½å¤Ÿå¾ˆå¥½è¡¨ç¤ºä¸€å¯¹å¤šå…³ç³»ï¼›å¤šå¯¹å¤šå…³ç³»å¾ˆéš¾è¡¨ç¤º</li></ol></li><li><p>ç½‘ç»œæ¨¡å‹ï¼š</p><ol><li>å±‚æ¬¡æ¨¡å‹çš„æ¨å¹¿ï¼Œæ”¯æŒå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„å…³ç³»</li><li>æŸ¥è¯¢å›°éš¾ã€æ›´æ–°å¤æ‚ä¸”ä¸å¤Ÿçµæ´»</li><li>å¯¹åº”ç”¨ç¨‹åºçš„æ•°æ®æ¨¡å‹è¿›è¡Œæ›´æ”¹æ˜¯éå¸¸å›°éš¾çš„äº‹æƒ…</li><li>åº”ç”¨éœ€è¦å…³å¿ƒå¤æ‚çš„è®¿é—®è·¯å¾„</li></ol></li><li><p>å…³ç³»æ¨¡å‹ï¼š</p><ol><li>å®šä¹‰äº†æ‰€æœ‰æ•°æ®çš„æ ¼å¼ï¼šå…³ç³»ï¼ˆè¡¨ï¼‰åªæ˜¯å…ƒç»„ï¼ˆè¡Œï¼‰çš„é›†åˆ</li><li>æŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨å†³å®šæŸ¥è¯¢é¡ºåºæ‰§è¡Œï¼›ä½¿ç”¨ä½•ç§ç´¢å¼•ã€‚ç›¸å½“äºè‡ªåŠ¨ç»´æŠ¤ã€Œè®¿é—®è·¯å¾„ã€</li><li>åº”ç”¨æ·»åŠ æ–°åŠŸèƒ½å˜å¾—å®¹æ˜“</li></ol></li><li><p>å…³ç³»æ•°æ®åº“å’Œæ–‡æ¡£æ•°æ®åº“ï¼š</p><ol><li>è¡¨ç¤ºå¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šéƒ½ä½¿ç”¨äº†æ ‡è¯†ç¬¦</li><li>å‰è€…å«ä½œå¤–é”®ï¼ˆæˆ–è€…å¯ä»¥åœ¨åº”ç”¨ä¸­å…³è”ï¼‰ï¼›åè€…å«ä½œæ–‡æ¡£å¼•ç”¨</li></ol></li><li><p>è¯»æ—¶æ¨¡å¼ï¼šæ–‡æ¡£æ•°æ®åº“ä¸­ï¼Œæ•°æ®ç»“æ„æ˜¯éšå¼çš„ï¼Œåªæœ‰åœ¨è¯»å–æ—¶æ‰è§£é‡Š</p></li><li>å†™æ—¶æ¨¡å¼ï¼šå…³ç³»æ•°æ®åº“ä¸­ï¼Œæ¨¡å¼æ˜¯æ˜¾å¼çš„ï¼Œæ•°æ®åº“ä¿è¯å†™å…¥æ—¶éµå¾ªæ¨¡å¼</li><li>èåˆå…³ç³»æ¨¡å‹å’Œæ–‡æ¡£æ¨¡å‹æ˜¯æœªæ¥å‘å±•çš„ä¸€ä¸ªè¾ƒå¥½çš„é€”å¾„</li></ol><h2 id="æŸ¥è¯¢è¯­è¨€"><a href="#æŸ¥è¯¢è¯­è¨€" class="headerlink" title="æŸ¥è¯¢è¯­è¨€"></a>æŸ¥è¯¢è¯­è¨€</h2><ol><li><p>SQLï¼š</p><ol><li>å£°æ˜å¼</li><li>ç®€æ´ã€æ˜“ä½¿ç”¨</li><li>å¾ˆå¤šé™åˆ¶çš„äº‹å®ï¼Œä¹Ÿæˆä¸ºæ•°æ®åº“è‡ªåŠ¨ä¼˜åŒ–æä¾›äº†ç©ºé—´</li><li>åº•å±‚æ˜“äºä½¿ç”¨å¹¶å‘æŸ¥è¯¢</li></ol></li><li><p>IMS/CODASYLï¼ˆå±‚æ¬¡æ¨¡å‹ã€ç½‘ç»œæ¨¡å‹ï¼‰ï¼š</p><ol><li>å‘½ä»¤å¼</li></ol></li><li><p>MapReduceï¼š</p><ol><li>ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¸å¤šæœºå™¨ä¸Šæ‰¹é‡å¤„ç†æµ·é‡æ•°æ®</li><li>æ—¢éå£°æ˜å¼ï¼Œä¹Ÿéå®Œå…¨å‘½ä»¤å¼ï¼›ä»‹äºäºŒè€…ä¹‹é—´</li><li>åº•å±‚ç¼–ç¨‹æ¨¡å‹ï¼Œç”¨äºåœ¨è®¡ç®—é›†ç¾¤ä¸Šåˆ†å¸ƒæ‰§è¡Œï¼›å¯æ‰§è¡Œçš„æ“ä½œé™å®šä¸ºçº¯å‡½æ•°</li></ol></li></ol><h2 id="å›¾æ•°æ®åº“æ¨¡å‹"><a href="#å›¾æ•°æ®åº“æ¨¡å‹" class="headerlink" title="å›¾æ•°æ®åº“æ¨¡å‹"></a>å›¾æ•°æ®åº“æ¨¡å‹</h2><ol><li>å…³ç³»æ•°æ®åº“é€‚åˆå¤„ç†ç®€å•çš„å¤šå¯¹å¤šæ¨¡å‹ï¼›ä½†éšç€æ•°æ®ä¹‹é—´çš„å…³è”è¶Šæ¥è¶Šå¤æ‚ï¼Œè½¬æ¢ä¸ºå›¾æ¨¡å‹ä¼šæ›´åŠ è‡ªç„¶</li><li>é¡¶ç‚¹å’Œè¾¹ç»„æˆ</li><li>å»ºæ¨¡ç¤ºä¾‹ï¼š<ol><li>äººé™…å…³ç³»</li><li>Web ç½‘é¡µ</li><li>å…¬è·¯æˆ–è€…é“è·¯ç½‘</li></ol></li><li>æ›´å¼ºå¤§ç”¨å¤„ï¼šæä¾›äº†å•ä¸ªæ•°æ®å­˜å‚¨åŒºä¿å­˜å®Œå…¨ä¸åŒç±»å‹å¯¹è±¡çš„ä¸€è‡´æ€§æ–¹å¼</li></ol><h3 id="å±æ€§å›¾æ¨¡å‹ï¼ˆProperty-Graphï¼‰"><a href="#å±æ€§å›¾æ¨¡å‹ï¼ˆProperty-Graphï¼‰" class="headerlink" title="å±æ€§å›¾æ¨¡å‹ï¼ˆProperty Graphï¼‰"></a>å±æ€§å›¾æ¨¡å‹ï¼ˆProperty Graphï¼‰</h3><ol><li>ä»£è¡¨ï¼šNeo4j, Titan, InfiniteGraph</li><li><p>é¡¶ç‚¹ï¼ˆverticeï¼‰ï¼š</p><ol><li>å”¯ä¸€æ ‡å¿—</li><li>å‡ºè¾¹é›†åˆ</li><li>å…¥è¾¹é›†åˆ</li><li>å±æ€§é›†åˆ</li></ol></li><li><p>è¾¹ï¼ˆedgeï¼‰ï¼š</p><ol><li>å”¯ä¸€æ ‡å¿—</li><li>è¾¹å¼€å§‹é¡¶ç‚¹</li><li>è¾¹ç»“æŸçš„é¡¶ç‚¹</li><li>æ ‡ç­¾</li><li>å±æ€§é›†åˆ</li></ol></li></ol><h3 id="ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰"><a href="#ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰" class="headerlink" title="ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰"></a>ä¸‰å…ƒå›¾å­˜å‚¨æ¨¡å‹ï¼ˆTriplestoreï¼‰</h3><ol><li>ä»£è¡¨ï¼šDatomic, AllegroGraph</li><li>å‡ ä¹ç­‰åŒäºå±æ€§å›¾æ¨¡å‹ï¼Œå¯èƒ½ä½œä¸ºæ„å»ºåº”ç”¨ç¨‹åºçš„è¡¥å……</li><li>å½¢å¼ï¼š(ä¸»ä½“ï¼Œè°“è¯­ï¼Œå®¢ä½“)</li><li>ä¸»ä½“ç›¸å½“äºå›¾ä¸­çš„é¡¶ç‚¹ï¼Œå®¢ä½“åˆ™æ˜¯ä»¥ä¸‹ä¸¤ç§ä¹‹ä¸€ï¼š<ol><li>åŸå§‹æ•°æ®ç±»å‹ä¸­çš„å€¼ï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰ï¼Œå¦‚ <code>(lucy, age, 40)</code></li><li>å›¾çš„å¦å¤–ä¸€ä¸ªé¡¶ç‚¹ï¼Œå¦‚ <code>(lucy, mariedTo, alain)</code></li></ol></li></ol><h3 id="æŸ¥è¯¢è¯­è¨€-1"><a href="#æŸ¥è¯¢è¯­è¨€-1" class="headerlink" title="æŸ¥è¯¢è¯­è¨€"></a>æŸ¥è¯¢è¯­è¨€</h3><ol><li>Cypherï¼Œæœ€æ—©ç”¨äº Neo4jã€‚å£°æ˜å¼æŸ¥è¯¢è¯­è¨€</li><li>SQL:1999 æ ‡å‡†åï¼Œå¯ä»¥ä½¿ç”¨é€’å½’å…¬ç”¨è¡¨è¾¾å¼ï¼ˆWITH RECURSIVEï¼‰æ¥è¡¨ç¤ºå¯å˜çš„éå†è·¯å¾„æŸ¥è¯¢</li><li>SPARQLï¼šé‡‡ç”¨ RDF æ•°æ®æ¨¡å‹çš„ä¸‰å…ƒå­˜å‚¨æŸ¥è¯¢è¯­è¨€</li><li>Datalogï¼šæ•°æ®æ¨¡å‹é‡‡ç”¨ã€Œè°“è¯­ï¼ˆä¸»ä½“ï¼Œå®¢ä½“ï¼‰ã€æ¨¡å¼ï¼›è§„åˆ™å¯ä»¥åœ¨ä¸åŒçš„æŸ¥è¯¢ä¸­ç»„åˆå’Œå¤ç”¨ï¼›å¯¹äºç®€å•æŸ¥è¯¢è™½ç„¶ç¹çï¼Œä½†é’ˆå¯¹å¤æ‚æ•°æ®ï¼Œåˆ™æ›´åŠ çµæ´»</li></ol><h1 id="æ•°æ®å­˜å‚¨å’Œæ£€ç´¢"><a href="#æ•°æ®å­˜å‚¨å’Œæ£€ç´¢" class="headerlink" title="æ•°æ®å­˜å‚¨å’Œæ£€ç´¢"></a>æ•°æ®å­˜å‚¨å’Œæ£€ç´¢</h1><h2 id="æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„"><a href="#æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„"></a>æ•°æ®åº“æ ¸å¿ƒï¼šæ•°æ®ç»“æ„</h2><ol><li>ç´¢å¼•å¯ä»¥å¸®åŠ©é«˜æ•ˆåœ°æŸ¥è¯¢æ•°æ®åº“ä¸­ç‰¹å®šçš„é”®ï¼›æ˜¯åŸºäºåŸå§‹æ•°æ®æ´¾ç”Ÿè€Œæ¥çš„é¢å¤–æ•°æ®ç»“æ„</li><li>ä»»ä½•ç±»å‹çš„ç´¢å¼•é€šå¸¸éƒ½ä¼šé™ä½å†™çš„é€Ÿåº¦</li></ol><h3 id="å“ˆå¸Œç´¢å¼•"><a href="#å“ˆå¸Œç´¢å¼•" class="headerlink" title="å“ˆå¸Œç´¢å¼•"></a>å“ˆå¸Œç´¢å¼•</h3><ol><li>ä»¥ Bitcast ä¸ºä»£è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œé‡‡ç”¨äº†å“ˆå¸Œç´¢å¼•</li><li>é€‚åˆæ¯ä¸ªé”®çš„å€¼æ›´æ–°é¢‘ç¹çš„åœºæ™¯</li><li>å“ˆå¸Œç´¢å¼•çš„ç‰¹ç‚¹ï¼š<ol><li>å“ˆå¸Œè¡¨å¿…é¡»å…¨éƒ¨å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œé”®å€¼æŒ‡å‘çš„æ˜¯æ–‡ä»¶æ®µä¸­çš„åç§»ï¼Œç”¨äºæŸ¥æ‰¾å…·ä½“çš„æ•°æ®</li><li>å¯é‡‡ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œå†é…åˆåå°åˆå¹¶ã€å‹ç¼©ç­‰æ‰‹æ®µæ¥é¿å…ç£ç›˜å†™å…¥è€—å°½çš„é—®é¢˜ï¼Œå‡å°‘ç£ç›˜ç¢ç‰‡</li><li>æ–°çš„æ•°æ®é‡‡ç”¨è¿½åŠ è€ŒéåŸåœ°ä¿®æ”¹çš„ç­–ç•¥ï¼Œæé«˜å†™å…¥ååé‡</li><li>åŒºé—´æŸ¥è¯¢æ•ˆç‡ä¸é«˜</li></ol></li></ol><h3 id="SSTables-å’Œ-LSM-Tree"><a href="#SSTables-å’Œ-LSM-Tree" class="headerlink" title="SSTables å’Œ LSM-Tree"></a>SSTables å’Œ LSM-Tree</h3><ol><li>SSTable çš„å…¨ç§°ï¼šSorted String Tableï¼Œæ’åºå­—ç¬¦ä¸²è¡¨</li><li>LSM-Tree çš„å…¨ç§°ï¼šLog-Structured Merge-Tree</li><li><p>ç›¸æ¯”å“ˆå¸Œç´¢å¼•çš„ä¼˜ç‚¹ï¼š</p><ol><li>åˆå¹¶æ®µæ›´ç®€å•é«˜æ•ˆï¼Œå¯¹äºå¤§æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤</li><li>æ®µæ–‡ä»¶ä¸­çš„ key-value é¡ºåºæ˜¯æŒ‰ç…§é”®æ’åºè¿‡çš„ï¼Œä¾¿äºåˆå¹¶å’ŒæŸ¥æ‰¾</li><li>åœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾ç‰¹å®šé”®æ—¶æ— éœ€åœ¨å†…å­˜ä¸­ä¿å­˜æ‰€æœ‰é”®çš„ç´¢å¼•ï¼ˆç¨€ç–ç´¢å¼•æ”¾åœ¨å†…å­˜ä¸­ï¼‰</li><li>æ”¯æŒèŒƒå›´æŸ¥æ‰¾</li></ol></li><li><p>æ„å»ºå’Œç»´æŠ¤ SSTables</p><ol><li>åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå†…å­˜è¡¨ï¼Œå†™å…¥æ—¶å…ˆå†™å…¥è¯¥è¡¨ï¼ˆæœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå¦‚çº¢é»‘æ ‘æˆ–è€…è·³è¡¨ï¼‰</li><li>å†…å­˜è¡¨è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œç›´æ¥å†™ç›˜ï¼Œå½¢æˆ SSTableï¼›åœ¨å†™ç›˜åŒæ—¶ï¼Œå¯æ·»åŠ æ–°çš„å†…å­˜è¡¨å®ä¾‹ï¼Œæ¥æ”¶åç»­å†™è¯·æ±‚</li><li>å¯¹äºè¯»è¯·æ±‚ï¼Œå†…å­˜è¡¨-&gt;æœ€æ–°ç£ç›˜æ®µæ–‡ä»¶-&gt;æ¬¡æ–°æ®µæ–‡ä»¶-&gt;â€¦ç›´åˆ°æ‰¾åˆ°ç›®æ ‡æˆ–è€…ä¸ºç©º</li><li>åå°å®šæœŸåˆå¹¶ã€å‹ç¼©ï¼Œä¸¢å¼ƒè¢«è¦†ç›–æˆ–åˆ é™¤çš„å€¼</li></ol></li><li>é¿å…å´©æºƒçš„æ–¹å¼ï¼šæ¯ä¸ªå†™å…¥è®°å½•åˆ°æ—¥å¿—ï¼Œå½“å†…å­˜è¡¨å†™å…¥ SSTable åæ‰å¯ä»¥ä¸¢å¼ƒç›¸åº”æ—¥å¿—</li><li>åŸºäºåˆå¹¶å’Œå‹ç¼©æ’åºæ–‡ä»¶åŸç†çš„å­˜å‚¨å¼•æ“é€šå¸¸éƒ½å«ä½œ LSM å­˜å‚¨å¼•æ“</li><li>æ€§èƒ½ä¼˜åŒ–ï¼š<ol><li>åˆ†å±‚å‹ç¼©ï¼ŒLevelDB &amp; RocksDB</li><li>æŒ‰å¤§å°åˆ†çº§ï¼ŒHBase, Cassandra åˆ™ä¸¤ç§éƒ½æ”¯æŒ</li><li>å¸ƒéš†è¿‡æ»¤å™¨</li></ol></li></ol><h3 id="B-Trees"><a href="#B-Trees" class="headerlink" title="B-Trees"></a>B-Trees</h3><ol><li>å¹¿æ³›ä½¿ç”¨è®¤å¯çš„ç´¢å¼•ç»“æ„ï¼Œå¾ˆå¤šæ•°æ®åº“ä¸­æ ‡å‡†ç´¢å¼•å®ç°ï¼›å³ä½¿åœ¨éå…³ç³»æ•°æ®åº“ä¸­ä¹Ÿæœ‰ç”¨åˆ°</li><li>B-Tree æ˜¯é¢å‘å—æˆ–è€…é¡µè¿›è¡Œè®¾è®¡çš„ï¼Œå®ƒå°†æ•°æ®åº“åˆ†è§£æˆå›ºå®šå¤§å°çš„å—æˆ–é¡µï¼Œä¸€èˆ¬ä¸º 4 KBï¼Œé¡µæ˜¯å†…éƒ¨è¯»å†™çš„æœ€å°å•å…ƒ</li><li>æ¯ä¸ªé¡µé¢éƒ½æœ‰æ ‡è¯†ç¬¦ï¼Œå¯è¢«å¼•ç”¨</li><li>ä¸€ä¸ªé¡µæ‰€åŒ…å«çš„é¡µé¢å¼•ç”¨æ•°é‡ç§°ä¸ºåˆ†æ”¯å› å­</li><li><p>æ›´æ–°ç­–ç•¥ï¼š</p><ol><li>æœç´¢åŒ…å«æŒ‡å®šé”®çš„å­é¡µ</li><li>ä¿®æ”¹è¯¥é¡µçš„å€¼</li><li>æ•´é¡µå›å†™åˆ°ç£ç›˜ï¼ˆç›¸å½“äºè¦†ç›–åŸå…ˆçš„é¡µï¼Œå¯¹è¯¥é¡µçš„ä»»ä½•å¼•ç”¨ä¾ç„¶æœ‰æ•ˆï¼‰</li></ol></li><li><p>æ–°åŠ é”®ç­–ç•¥ï¼š</p><ol><li>æ‰¾åˆ°å¯å®¹çº³æ–°é”®èŒƒå›´çš„é¡µï¼Œç„¶åæ·»åŠ åˆ°è¯¥é¡µ</li><li>è‹¥é¡µé¢ç©ºé—´ä¸è¶³ï¼Œåˆ™å°†å…¶åˆ†è£‚ä¸ºä¸¤ä¸ªåŠæ»¡çš„é¡µï¼ŒåŒæ—¶ä¿®æ”¹çˆ¶é¡µï¼Œè®°å½•åˆ†è£‚åçš„æ–°çš„é”®çš„èŒƒå›´</li></ol></li><li><p>ä¸€ä¸ªå…·æœ‰ N ä¸ªé”®çš„ B-Tree çš„æ·±åº¦ä¸º O(log N)ï¼›å¤šæ•°æ•°æ®åº“å¯ä»¥é€‚åˆ 3~4 å±‚ B-Treeã€‚åˆ†æ”¯å› å­ä¸º 500 çš„ 4KB å››çº§æ ‘å¯å­˜å‚¨ 256TB çš„æ•°æ®</p></li><li>å´©æºƒæ¢å¤ï¼šWAL, Write-Ahead Logã€‚é€šè¿‡è¯¥æ—¥å¿—æ¥æ¢å¤</li><li>éœ€è¦è€ƒè™‘å¹¶å‘æ§åˆ¶</li><li>å†™æ”¾å¤§çš„é—®é¢˜ï¼ˆé¡µåˆ†è£‚ï¼‰</li><li>äº‹åŠ¡æ”¯æŒæ›´åŠ å®¹æ˜“</li></ol><h2 id="äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰"><a href="#äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰" class="headerlink" title="äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰"></a>äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰å’Œåˆ†æå¤„ç†ï¼ˆOLAPï¼‰</h2><ol><li>äºŒè€…å¯¹æ¯”ï¼š<br> <img src="./compare-oltp-olap.png" alt=""></li><li>å¤§çš„ä¼ä¸šä¼šå•ç‹¬å»ºç«‹æ•°ä»“ï¼ŒåŒæ­¥æ¥è‡ª OLTP ç³»ç»Ÿçš„æ•°æ®ï¼Œåœ¨å•ç‹¬çš„æ•°ä»“ä¸­è¿›è¡Œåˆ†æå¤„ç†ï¼Œä¸ä¼šå½±å“çº¿ä¸Šä¸šåŠ¡</li><li>å¯¼å…¥æ•°ä»“ï¼šELT, Extract-&gt;Transform-&gt;Load<br> <img src="./etl.png" alt=""></li><li>å¸¸è§æ•°ä»“ç³»ç»Ÿï¼šApache Hive, Spark SQL, Cloudera Implala</li></ol><h3 id="æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼"><a href="#æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼" class="headerlink" title="æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼"></a>æ˜Ÿå‹ä¸é›ªèŠ±å‹åˆ†ææ¨¡å¼</h3><ol><li>å¸¸è§çš„æ˜¯æ˜Ÿå‹æ¨¡å¼ï¼Œä¹Ÿç§°ä¸ºç»´åº¦å»ºæ¨¡ã€‚ç‰¹ç‚¹æ˜¯æœ‰ä¸€ä¸ª<strong>äº‹å®è¡¨</strong>ï¼Œå…³è”äº†å¾ˆå¤šä¸ª<strong>ç»´åº¦è¡¨</strong>ã€‚äº‹å®è¡¨æœ¬èº«å¯èƒ½ä¼šå¾ˆåºå¤§ï¼Œå…¶ä¸­çš„æ¯ä¸€è¡Œéƒ½ä»£è¡¨ä¸€ä¸ªäº‹ä»¶ï¼Œç»´åº¦é€šå¸¸ä»£è¡¨äº‹ä»¶çš„<strong>Who, What, Where, When, How, Why</strong><br> <img src="./star-pattern.png" alt=""></li><li>é›ªèŠ±â„ï¸ æ¨¡å‹æ˜¯æ˜Ÿå‹æ¨¡å‹çš„å˜ä½“ï¼Œå®ƒå°†ç»´åº¦è¿›ä¸€æ­¥ç»†åˆ†ä¸ºå­ç©ºé—´ï¼Œä»è€Œæ›´åŠ è§„èŒƒåŒ–ã€‚ä½†æ˜¯è¿™ä¸ªä¼šå¢åŠ åˆ†ææŸ¥è¯¢çš„å¤æ‚åº¦ï¼Œæ‰€ä»¥æ˜Ÿå‹åˆ†ææ¨¡å¼æ›´å—æ¬¢è¿</li></ol><h3 id="åˆ—å­˜å‚¨"><a href="#åˆ—å­˜å‚¨" class="headerlink" title="åˆ—å­˜å‚¨"></a>åˆ—å­˜å‚¨</h3><ol><li>æ•°ä»“ä¸­çš„åˆ—é€šå¸¸å¾ˆå®½ï¼Œæœ‰çš„å¯èƒ½å¤šè¾¾ 100 ä¸ª</li><li>æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ¯åˆ—ä¸­çš„æ‰€æœ‰å€¼å­˜å‚¨åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰çš„æ•°æ®æ—¶å­˜å‚¨åœ¨ä¸€ç»„åˆ—æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä»¥ç›¸åŒé¡ºåºä¿å­˜æ•°æ®è¡Œ</li><li><p>åˆ—å‹ç¼©ï¼š</p><ol><li>å¾ˆå®¹æ˜“è¿›è¡Œå‹ç¼©</li><li>å¸¸ç”¨ä½å›¾ç¼–ç ï¼Œå¹¶é…åˆæ¸¸ç¨‹ç¼–ç é™ä½å­˜å‚¨ç©ºé—´ï¼ˆè¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹é›¶ä½ç¨€ç–çš„æƒ…å†µï¼‰<br><img src="./bitmap.png" alt=""></li></ol></li><li><p>åˆ—æ’åºï¼š</p><ol><li>å¯ä»¥æ ¹æ®æŸ¥è¯¢éœ€æ±‚é€‰æ‹©æ’åºçš„åˆ—</li><li>æ’åºå¯å¸®åŠ©è¿›ä¸€æ­¥å‹ç¼©ï¼ˆé‡å¤å€¼ä¹Ÿå¯ä»¥é‡‡ç”¨ç®€å•çš„æ¸¸ç¨‹ç¼–ç ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯æ•°åäº¿è¡Œä¹Ÿä¸æ€•ï¼‰</li><li>åŸºäºç¬¬ä¸€ä¸ªæ’åºé”®çš„å‹ç¼©æ•ˆæœé€šå¸¸æœ€å¥½</li><li>æ’åºç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­ç”¨çš„ç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢</li></ol></li><li>å†™å…¥å¯ä»¥é‡‡å–ç±»ä¼¼ LSM-Tree çš„æ€è·¯</li><li>ç‰©åŒ–è§†å›¾ï¼šæŸ¥è¯¢ç»“æœçš„å®é™…å‰¯æœ¬ï¼Œè¢«å†™å…¥åˆ°ç£ç›˜äº†ï¼›è™šæ‹Ÿè§†å›¾åˆ™æ˜¯ç”¨äºç¼–å†™æŸ¥è¯¢çš„å¿«æ·æ–¹å¼</li></ol><h1 id="æ•°æ®ç¼–ç ä¸æ¼”åŒ–"><a href="#æ•°æ®ç¼–ç ä¸æ¼”åŒ–" class="headerlink" title="æ•°æ®ç¼–ç ä¸æ¼”åŒ–"></a>æ•°æ®ç¼–ç ä¸æ¼”åŒ–</h1><h2 id="æ•°æ®ç¼–ç æ ¼å¼"><a href="#æ•°æ®ç¼–ç æ ¼å¼" class="headerlink" title="æ•°æ®ç¼–ç æ ¼å¼"></a>æ•°æ®ç¼–ç æ ¼å¼</h2><ol><li>ç¨‹åºä¸­è‡³å°‘æœ‰ä¸¤ç§å¸¸ç”¨çš„æ•°æ®è¡¨ç¤ºå½¢å¼ï¼š<ol><li>å†…å­˜ä¸­ï¼Œæ•°æ®ä¿å­˜åœ¨å¯¹è±¡ã€ç»“æ„ä½“ã€åˆ—è¡¨ã€æ•°ç»„ã€å“ˆå¸Œè¡¨å’Œæ ‘ç­‰ç»“æ„ä¸­ï¼Œå¯¹äº CPU çš„é«˜æ•ˆè®¿é—®å’Œæ“ä½œåšäº†ä¼˜åŒ–</li><li>æ•°æ®å†™å…¥æ–‡ä»¶æˆ–è€…ç½‘ç»œä¼ è¾“æ—¶ï¼Œéœ€è¦è¿›è¡Œç¼–ç ä¸ºå­—èŠ‚åºåˆ—</li></ol></li></ol><h3 id="è¯­è¨€ç‰¹å®šçš„æ ¼å¼"><a href="#è¯­è¨€ç‰¹å®šçš„æ ¼å¼" class="headerlink" title="è¯­è¨€ç‰¹å®šçš„æ ¼å¼"></a>è¯­è¨€ç‰¹å®šçš„æ ¼å¼</h3><ol><li>å¸¸è§çš„åŒ…æ‹¬ï¼š<ol><li>java.io.Serializable</li><li>Ruby ä¸­çš„ Marshal</li><li>Python ä¸­çš„ pickle</li></ol></li><li>ä¼˜ç‚¹ï¼šå¯¹äºæŸç§è¯­è¨€è‡ªèº«æ¥è¯´ï¼Œç¼–è§£ç ä¼šå¾ˆæ–¹ä¾¿ï¼Œä¸éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–</li><li>ç¼ºç‚¹ï¼š<ol><li>ä¸ç‰¹å®šè¯­è¨€ç»‘å®šï¼Œä¸åˆ©äºå’Œå…¶å®ƒè¯­è¨€çš„å¼‚æ„ç³»ç»Ÿé€šè®¯</li><li>å¯èƒ½ä¼šæœ‰å®‰å…¨æ€§é—®é¢˜</li><li>å…¼å®¹æ€§ä¸èƒ½ä¿è¯</li><li>æ•ˆç‡é€šå¸¸æ¯”è¾ƒä½ï¼Œéœ€è¦èŠ±è´¹è¾ƒå¤šçš„ CPU æ—¶é—´æˆ–è€…å†…å­˜ç©ºé—´</li></ol></li></ol><h3 id="JSONã€XML-å’ŒäºŒè¿›åˆ¶å˜ä½“"><a href="#JSONã€XML-å’ŒäºŒè¿›åˆ¶å˜ä½“" class="headerlink" title="JSONã€XML å’ŒäºŒè¿›åˆ¶å˜ä½“"></a>JSONã€XML å’ŒäºŒè¿›åˆ¶å˜ä½“</h3><ol><li>JSONã€CSVã€XML éƒ½æ˜¯æ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå¥½</li><li><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p><ol><li>æ•°å­—ç¼–ç ä¸æ˜ç¡®ï¼ˆæ¯”å¦‚ CSV ä¸­å°±æ— æ³•åŒºåˆ†æ˜¯æ•°å­—è¿˜æ˜¯æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²ï¼›JSON ä¸­å¯¹äºå¤§äº 2^53 çš„æ•´æ•°å°±å‚»çœ¼äº†ï¼‰</li><li>ä¸æ”¯æŒäºŒè¿›åˆ¶ï¼ˆè™½ç„¶å¯ä»¥ç”¨ base64 æäº‹æƒ…ï¼Œä½†æ˜¯ä¼šå¢åŠ ç©ºé—´å’Œç¼–è§£ç çš„æ—¶é—´ï¼‰</li><li>CSV æ— ä»»ä½•æ¨¡å¼</li><li>XML å’Œ JSON å‡æœ‰å¯é€‰çš„æ¨¡å¼</li></ol></li><li><p>ä¸€äº›å˜ç§ï¼Œå®ƒä»¬çš„åº”ç”¨å¹¶ä¸æ˜¯å¾ˆå¹¿æ³›ï¼š</p><ol><li>JSONï¼ˆBSONã€BJSONã€UBJSONã€BISONã€Smile å’Œ Message Packï¼‰</li><li>XMLï¼ˆWBXML å’Œ Fast Infosetï¼‰</li></ol></li><li><p>åé¢çš„ğŸŒ°éƒ½ä»¥è¡¨è¾¾ä¸‹é¢çš„ä¿¡æ¯ä¸ºä¾‹ï¼Œæ¥åšå¯¹ç…§ï¼š</p> <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"userName"</span>: <span class="string">"Martin"</span>,</span><br><span class="line">    <span class="attr">"favoriteNumber"</span>: <span class="number">1337</span>,</span><br><span class="line">    <span class="attr">"interests"</span>: [<span class="string">"daydreaming"</span>, <span class="string">"hacking"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Message Pack æ˜¯ JSON çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š<br> <img src="./msg-pack-encode.png" alt=""></p></li></ol><h3 id="Thrift-amp-Protocol-Buffers"><a href="#Thrift-amp-Protocol-Buffers" class="headerlink" title="Thrift &amp; Protocol Buffers"></a>Thrift &amp; Protocol Buffers</h3><ol><li>Thrift æ˜¯ Facebook å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº</li><li>Thrift æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ RPC æ¡†æ¶ï¼Œåœ¨å®ƒçš„åè®®å±‚æä¾›äº†å¤šç§ Protocol çš„å®ç°ï¼Œæ–¹ä¾¿åº”ä»˜å¤šç§åœºæ™¯ã€‚æ¯”å¦‚å¸¸è§çš„ <code>BinaryProtocol</code> å’Œ <code>CompactProtocol</code>ã€‚</li><li><p>BinaryProtocol ç¼–ç ç¤ºä¾‹ï¼š</p><ol><li>ä¸ Message Pack ç¼–ç ç›¸æ¯”ï¼Œæ²¡æœ‰äº†å­—æ®µå</li><li>ä½¿ç”¨äº† field tag æ¥æ˜ å°„ IDL å®šä¹‰çš„å„ä¸ªå­—æ®µ<br><img src="./thrift-bin-proto-encode.png" alt=""></li></ol></li><li><p>CompactProtocol ç¼–ç ç¤ºä¾‹ï¼š</p><ol><li>field tag å’Œ type ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤º</li><li>field tag ä½¿ç”¨äº†åç§»è®¡ç®—</li><li>æ•´æ•°é‡‡ç”¨å˜é•¿å­—èŠ‚ï¼Œè€Œé BinaryProtocol ä¸­ 1337 ä½¿ç”¨çš„ 8 å­—èŠ‚ï¼Œæ¢æˆå˜é•¿å­—èŠ‚åªéœ€è¦ 2 å­—èŠ‚å³å¯<br><img src="./thrift-comp-proto-encode.png" alt=""></li></ol></li><li><p>Protocol Buffers Google å¼€å‘ï¼Œ2007~2008 å¹´å¼€æº</p></li><li><p>ä½¿ç”¨ PB ç¼–ç çš„ç¤ºä¾‹ï¼š<br> <img src="./pb-encode.png" alt=""></p></li><li><p><code>required</code> å’Œ <code>optional</code> è¿™ç§ä¿®é¥°æ˜¯ä¸ä¼šä½“ç°åœ¨ç¼–ç ä¸­çš„ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶åšçš„æ£€æŸ¥</p></li><li>ä¿è¯å‰åå‘å…¼å®¹ï¼š<ol><li>field tag è‡³å…³é‡è¦ï¼Œä¸å¯éšä¾¿æ›´æ”¹</li><li>optional å­—æ®µçš„ field tag å¯ä»¥åˆ é™¤ï¼Œä½†ä¸è¦å¤ç”¨å·²åˆ é™¤çš„ field tag</li><li>æ–°å¢å­—æ®µå¿…é¡»æ˜¯ optional æˆ–è€…å¸¦æœ‰é»˜è®¤å€¼ï¼Œä¿è¯å‘åå…¼å®¹</li><li>ä¸å¯è½»æ˜“ä¿®æ”¹ field ç±»å‹</li></ol></li></ol><h3 id="Avro"><a href="#Avro" class="headerlink" title="Avro"></a>Avro</h3><ol><li>Apache Avro æ˜¯ Hadoop çš„å­é¡¹ç›®ï¼Œæä¾›äº†ä¸¤ç§æ¨¡å¼è¯­è¨€ï¼šAvro IDL å’Œ JSON æ ¼å¼</li><li><p>ç‰¹ç‚¹ï¼š</p><ol><li>æ²¡æœ‰æ ‡ç­¾å·</li><li>ç¼–ç éå¸¸ç´§å‡‘</li><li>ç¼–ç ä¸­æ²¡æœ‰å­—æ®µç±»å‹</li></ol></li><li><p>ç¼–ç ç¤ºä¾‹ï¼š<br> <img src="./avro-encode.png" alt=""></p></li><li><p>åŒºåˆ†è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ã€‚å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸å¿…å®Œå…¨ä¸€æ¨¡ä¸€æ ·ï¼Œåªéœ€è¦ä¿æŒå…¼å®¹</p></li><li>å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ä¸­çš„å­—æ®µé¡ºåºå¯ä¸åŒï¼Œå› ä¸ºåœ¨æ¨¡å¼è§£ææ—¶ä¼šä½¿ç”¨å­—æ®µååŒ¹é…</li><li>åŠ¨æ€ç”Ÿæˆæ¨¡å¼æ˜¯æœ€å¤§çš„ç‰¹ç‚¹ï¼Œä¸éœ€è¦åƒ PB æˆ–è€… Thrift ä¸­é‚£æ ·ï¼Œæ˜¾å¼åˆ†é… field tagï¼Œæ¯”è¾ƒçµæ´»ã€‚ç‰¹åˆ«é€‚åˆç¼–ç æ•°æ®åº“è¡¨ã€‚</li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.douban.com/subject/30329536/" target="_blank" rel="noopener">æ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ï¼šç¬¬ä¸€éƒ¨åˆ†</a></li><li><a href="http://thrift.apache.org/" target="_blank" rel="noopener">Thrift</a></li><li><a href="https://developers.google.cn/protocol-buffers/" target="_blank" rel="noopener">Protocol Buffers</a></li><li><a href="http://avro.apache.org/docs/current/gettingstartedpython.html" target="_blank" rel="noopener">Avro Python Examples</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ï¼ˆDesign Data-Intensive Applicationsï¼‰æ˜¯ä¸€æœ¬éå¸¸æœ‰è¯šæ„ã€éå¸¸ä¼˜ç§€çš„è®²è§£é’ˆå¯¹æ•°æ®å¯†é›†åœºæ™¯ä¸‹ç³»ç»Ÿè®¾è®¡ç›¸å…³çš„ç›®æ ‡ã€åŸåˆ™å’ŒæŠ€æœ¯é€‰å‹ç­‰çŸ¥è¯†ã€‚ä½œè€…ç»“åˆç†è®ºä¸å®è·µï¼Œä¸ºæˆ‘ä»¬å±•ç°äº†ä¸€äº›æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å¯¹æ¯”ï¼›åŒæ—¶è¿˜ä»‹ç»äº†ä¸€äº›å…³é”®æŠ€æœ¯ï¼ˆå¦‚å­˜å‚¨å¼•æ“ã€åºåˆ—åŒ–åè®®ã€åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼‰ç­‰çš„å®ç°åŸç†ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿ&lt;strong&gt;çŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶&lt;/strong&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç³»ç»Ÿè®¾è®¡" scheme="http://ifaceless.space/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡ã€‹" scheme="http://ifaceless.space/tags/%E3%80%8A%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1%E3%80%8B/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://ifaceless.space/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="æ•°æ®æ¨¡å‹" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/"/>
    
      <category term="æ•°æ®åº“å­˜å‚¨" scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%82%A8/"/>
    
      <category term="æ•°æ®ç¼–ç " scheme="http://ifaceless.space/tags/%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Go æºç å­¦ä¹ ä¹‹ Context</title>
    <link href="http://ifaceless.space/2019/08/02/go-context-intro/"/>
    <id>http://ifaceless.space/2019/08/02/go-context-intro/</id>
    <published>2019-08-02T12:33:11.000Z</published>
    <updated>2019-11-24T09:45:59.939Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨ä¸€æ¬¡æ’æŸ¥æŸ HTTP æ¥å£è¯·æ±‚é¢‘ç¹å›  context canceled é”™è¯¯å¯¼è‡´è¯·æ±‚å¤„ç†å¤±è´¥çš„é—®é¢˜æœŸé—´ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ Go è¯­è¨€çš„ Context å®ç°ã€‚æœ¬æ–‡å°†é¦–å…ˆä»‹ç»æˆ‘ä»¬æ˜¯å¦‚ä½•æ’æŸ¥è¯¡å¼‚çš„ <code>context canceled</code> äº§ç”ŸåŸå› ï¼ˆä¹Ÿå°±æ˜¯åœ¨å“ªå„¿å› ä¸ºä»€ä¹ˆè€Œå¯¼è‡´å–æ¶ˆçš„ï¼‰ï¼›æ¥ä¸‹æ¥å°†æ·±å…¥ä»‹ç» Context è¯ç”Ÿçš„ç›®çš„ã€æºç è§£æåŠåº”ç”¨åœºæ™¯ç­‰ï¼Œä¾¿äºæ›´è¿›ä¸€æ­¥åŠ æ·±å¯¹å®ƒçš„ç†è§£ï¼›æœ€åæˆ‘ä»¬ä¹Ÿä¼šè°ˆåŠä½¿ç”¨ Context çš„ä¸€äº›ç—›ç‚¹ã€‚</p><a id="more"></a><h1 id="æ’æŸ¥-context-canceled-çš„è‰°è¾›å†ç¨‹"><a href="#æ’æŸ¥-context-canceled-çš„è‰°è¾›å†ç¨‹" class="headerlink" title="æ’æŸ¥ context canceled çš„è‰°è¾›å†ç¨‹"></a>æ’æŸ¥ context canceled çš„è‰°è¾›å†ç¨‹</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æˆ‘ä»¬éƒ¨ç½²åœ¨ç”Ÿäº§ç¯å¢ƒçš„ HTTP æœåŠ¡ä¸­æä¾›äº†ä¸€ä¸ªç”¨äºè®°å½•ç”¨æˆ·è¯¾ç¨‹å­¦ä¹ è¿›åº¦çš„æ¥å£ï¼Œåœ¨ Sentry ä¸­å‘ç°ï¼Œæœ‰å¤§é‡ context canceled æŠ¥é”™å‡ºç°ï¼Œå¯¼è‡´åœ¨æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶å¤±è´¥ï¼Œä»è€Œå¯¼è‡´å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹æ²¡æœ‰èµ°å®Œï¼ˆç”¨æˆ·çš„å­¦ä¹ è¿›åº¦è®¡ç®—ã€ä¸šåŠ¡æ–¹æ¶ˆæ¯é€šçŸ¥ç­‰æ²¡æœ‰æ‰§è¡Œï¼‰ã€‚ä½†æ—©æœŸç”±äº Sentry æ¥å…¥å­˜åœ¨é—®é¢˜ï¼Œå¯¼è‡´é”™è¯¯è®°å½•æ²¡æœ‰ä¸ŠæŠ¥ï¼›ç›´åˆ°é—®é¢˜ä¿®å¤åï¼Œæ‰åœ¨ Sentry ä¸Šè§‚å¯Ÿåˆ°å¤§é‡æŠ¥é”™æç¤ºã€‚ç”±æ­¤ï¼Œå¼€å¯äº†<strong>å®šä½ context canceled é—®é¢˜</strong>ä¹‹æ—…~</p><h2 id="æŠ¥å‘Šè¯¦ç»†é”™è¯¯æ—¥å¿—"><a href="#æŠ¥å‘Šè¯¦ç»†é”™è¯¯æ—¥å¿—" class="headerlink" title="æŠ¥å‘Šè¯¦ç»†é”™è¯¯æ—¥å¿—"></a>æŠ¥å‘Šè¯¦ç»†é”™è¯¯æ—¥å¿—</h2><p>æˆ‘ä»¬é¦–å…ˆå¯¹å‘ç”Ÿé”™è¯¯çš„ä½ç½®ï¼Œæ·»åŠ äº†æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œå¦‚è¯·æ±‚ä¸Šä¸‹æ–‡ä»¥åŠé”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆã€‚å¾…ä¸Šçº¿åï¼Œåœ¨ Sentry ä¸­è§‚å¯Ÿåˆ°äº†å‡ºé”™æ—¶è¯¦ç»†çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">File &quot;git.xixi.com/group/project-foo/pkg/models/prog/learn_progress.go&quot;, line 109, in Create</span><br><span class="line">    d.Detect()</span><br><span class="line">  File &quot;git.xixi.com/group/project-foo/pkg/controller/learn_progress.go&quot;, line 46, in Update</span><br><span class="line">    success := learnProgress.Create(ctx, memberID, unitID, bizType, progress, clientUpdatedAt) != nil</span><br><span class="line">  File &quot;git.xixi.com/group/project-foo/pkg/web/handlers/learn_progress.go&quot;, line 77, in Post</span><br><span class="line">    success := h.ctrl.Update(h.R.Context(), memberID, unitID, bizType, progress, item.ClientUpdateAt)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/handler.go&quot;, line 53, in ServeHTTP</span><br><span class="line">    render(handler.Post())</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 291, in func1</span><br><span class="line">    handler.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 424, in routeHTTP</span><br><span class="line">    h.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/middleware/sentry_meta.go&quot;, line 19, in func1</span><br><span class="line">    next.ServeHTTP(w, r.WithContext(ctx))</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/auth/nginx.go&quot;, line 200, in func1</span><br><span class="line">    next.ServeHTTP(w, r1)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/context.go&quot;, line 67, in func1</span><br><span class="line">    next.ServeHTTP(w, r1)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/cors@v1.0.0/cors.go&quot;, line 199, in func1</span><br><span class="line">    next.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/cors.go&quot;, line 51, in 1</span><br><span class="line">    defaultCORS.Handler(next).ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/heartbeat.go&quot;, line 21, in 1</span><br><span class="line">    h.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/recoverer.go&quot;, line 35, in func1</span><br><span class="line">    next.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/middleware/logger.go&quot;, line 46, in 1</span><br><span class="line">    next.ServeHTTP(ww, WithLogEntry(r, entry))</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/realip.go&quot;, line 18, in func1</span><br><span class="line">    h.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/go/box@v0.0.0-20190710074902-1cbc4c2abdad/zapi/middleware/sentry.go&quot;, line 83, in func1</span><br><span class="line">    next.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/git.xixi.com/bit/zerzura@v4.1.1+incompatible/rest/middleware/stats.go&quot;, line 66, in 1</span><br><span class="line">    next.ServeHTTP(lw, r1)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1995, in ServeHTTP</span><br><span class="line">    f(w, r)</span><br><span class="line">  File &quot;/go/pkg/mod/github.com/go-chi/chi@v3.3.2+incompatible/mux.go&quot;, line 81, in ServeHTTP</span><br><span class="line">    mx.handler.ServeHTTP(w, r)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 2774, in ServeHTTP</span><br><span class="line">    handler.ServeHTTP(rw, req)</span><br><span class="line">  File &quot;net/http/server.go&quot;, line 1878, in serve</span><br><span class="line">    serverHandler&#123;c.server&#125;.ServeHTTP(w, w.req)</span><br></pre></td></tr></table></figure></p><p>ç”±äºæˆ‘ä»¬æ˜¯å°†è¯·æ±‚çš„ <code>Context</code> ä¸€ç›´ä¼ é€’åˆ°æœ€ä¸‹å±‚çš„ï¼Œè€Œåœ¨çˆ¶ Context æ”¶åˆ°å–æ¶ˆä¿¡å·åä¹Ÿä¼šé€šçŸ¥åˆ°å­ Contextï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡è¿™ä¸ªå–æ¶ˆçš„è§¦å‘æ˜¯åœ¨æŸä¸ªçˆ¶ Context èŠ‚ç‚¹ã€‚ä½†å…·ä½“æ˜¯åœ¨å“ªå„¿ï¼Œä»€ä¹ˆåŸå› å¯¼è‡´çš„å¹¶ä¸æ¸…æ¥šã€‚</p><h2 id="ä¿®å¤é—®é¢˜-amp-æ·»åŠ æ£€æµ‹"><a href="#ä¿®å¤é—®é¢˜-amp-æ·»åŠ æ£€æµ‹" class="headerlink" title="ä¿®å¤é—®é¢˜ &amp; æ·»åŠ æ£€æµ‹"></a>ä¿®å¤é—®é¢˜ &amp; æ·»åŠ æ£€æµ‹</h2><p>ä¸è¿‡ä¸ºäº†é¿å…å› ä¸º <code>sql/driver</code> å±‚æ”¶åˆ° Context Cancel ä¿¡å·è€Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œè¿›è€Œå¯¼è‡´åç»­çš„å¤„ç†æµç¨‹æœªèƒ½æ‰§è¡Œï¼Œæˆ‘ä»¬å†³å®šå…ˆä¿®å¤é—®é¢˜ï¼Œå†æ’æŸ¥åŸå› ã€‚é‚£æ€ä¹ˆä¿®å¤å‘¢ï¼Ÿå…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªä¸å¸¦ Cancel çš„ Context ç»§ç»­å¾€ <code>sql/driver</code> å±‚ä¼ é€’ï¼Œä½†è¯¥ Context åŒæ ·ç»§æ‰¿äº†çˆ¶ Context çš„ Valueï¼Œè¿™æ ·ä¸€äº›å…ƒä¿¡æ¯ä¹Ÿå¯ä»¥è¢«ç»§ç»­ä¼ é€’ä¸‹å»ã€‚åŒæ—¶ä¸ºäº†åœ¨æ£€æŸ¥åˆ°åŸæœ‰å­ Context æ”¶åˆ° Cancel ä¿¡å·æ—¶ï¼ŒæŠ¥å‘Šè¯¦ç»†çš„é”™è¯¯å’Œ Context Stringï¼Œæˆ‘ä»¬ä¹Ÿå®ç°äº†ä¸€ä¸ªç®€å•çš„æ£€æµ‹å™¨ã€‚ç›¸å…³æºç å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> noCancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    ctx context.Context</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *noCancelCtx)</span> <span class="title">Deadline</span><span class="params">()</span> <span class="params">(time.Time, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> time.Time&#123;&#125;, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *noCancelCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *noCancelCtx)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *noCancelCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> c.ctx.Value(key)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithoutCancel</span><span class="params">(ctx context.Context)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;noCancelCtx&#123;ctx: ctx&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Detector <span class="keyword">struct</span> &#123;</span><br><span class="line">    where <span class="keyword">string</span></span><br><span class="line">    isDone <span class="keyword">bool</span></span><br><span class="line">    ctx context.Context</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewContextDoneDetector</span><span class="params">(ctx context.Context)</span> *<span class="title">Detector</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Detector&#123;ctx: ctx&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Detector)</span> <span class="title">Detect</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isDone &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-d.ctx.Done():</span><br><span class="line">        d.isDone = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">var</span> where <span class="keyword">string</span></span><br><span class="line">        _, file, line, ok := runtime.Caller(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> ok &#123;</span><br><span class="line">            where = fmt.Sprintf(<span class="string">"%s:%d"</span>, file, line)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            where = <span class="string">"unknown"</span></span><br><span class="line">        &#125;</span><br><span class="line">        log.WithContext(d.ctx).Errorf(<span class="string">"detect context done signal in \"%s\". context is %s"</span>, where, d.ctx)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç„¶åå¯¹åŸæœ‰çš„ä¸šåŠ¡ä»£ç è¿›è¡Œä¸€äº›æ”¹é€ å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create åˆ›å»ºç”¨æˆ·å­¦ä¹ è¿›åº¦</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(learnProgressDB *LearnProgressDAO)</span> <span class="title">Create</span><span class="params">(ctx context.Context, memberID <span class="keyword">int64</span>, unitID <span class="keyword">int64</span>, bizType <span class="keyword">int16</span>, progress <span class="keyword">int32</span>, clientUpdatedAt <span class="keyword">int64</span>)</span> *<span class="title">LearnProgress</span></span> &#123; </span><br><span class="line">    d := utils.NewContextDoneDetector(ctx)</span><br><span class="line">    d.Detect()</span><br><span class="line">    <span class="comment">// ...æ­¤å¤„çœç•¥ N è¡Œ</span></span><br><span class="line">    d.Detect()</span><br><span class="line">    <span class="comment">// æ›¿æ¢æˆä¸å¸¦ Cancel çš„ Context</span></span><br><span class="line">    ctxWithoutCancel := utils.WithoutCancel(ctx)</span><br><span class="line">    result, err := db.Exec(ctxWithoutCancel, i, args...)</span><br><span class="line">    <span class="comment">// ...ç»§ç»­çœç•¥</span></span><br><span class="line">    d.Detect()</span><br><span class="line">    object :=  db.QueryRow(ctxWithoutCancel, <span class="string">"SELECT id, member_id, unit_id, biz_type, progress, "</span>+</span><br><span class="line">        <span class="string">"client_updated_at FROM learn_progress WHERE id = ?"</span>, id)</span><br><span class="line">    learnProgress := &amp;LearnProgress&#123;&#125;</span><br><span class="line">    d.Detect()</span><br><span class="line">    err = object.Scan(&amp;learnProgress.ID, &amp;learnProgress.MemberID, &amp;learnProgress.UnitID, &amp;learnProgress.BizType,</span><br><span class="line">        &amp;learnProgress.Progress, &amp;learnProgress.ClientUpdatedAt)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.WithContext(ctx).WithError(err).Errorf(<span class="string">"create and get progress %d error"</span>, id)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    d.Detect()</span><br><span class="line">    <span class="keyword">return</span> learnProgress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ä¸Šçº¿åï¼Œå› ä¸º context canceled è€Œå¯¼è‡´è¯·æ±‚å¤„ç†æµç¨‹ä¸èƒ½èµ°å®Œçš„é—®é¢˜è§£å†³äº†ã€‚åŒæ—¶ä¹ŸæŠ¥å‘Šå‡ºå¾ˆå¤šæ£€æŸ¥åˆ°ä¸Šå±‚ Context å–æ¶ˆçš„ä¿¡å·ï¼Œè¯¦ç»†çš„æ—¥å¿—å¦‚ä¸‹ï¼š<br><img src="./context-log.png" alt="context log"></p><h2 id="åˆ†æ-HTTP-Server-æºç "><a href="#åˆ†æ-HTTP-Server-æºç " class="headerlink" title="åˆ†æ HTTP Server æºç "></a>åˆ†æ HTTP Server æºç </h2><p>æ˜¾ç„¶ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤å¤„ <code>Cancel Context</code> æœ‰æå¤§çš„å«Œç–‘ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„é—®é¢˜å°±æ˜¯è¦ç¡®å®šè¿™ä¸¤ä¸ª Cancel Context æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿè¿™æ ·ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†å»ç¡®è®¤æ˜¯<strong>å“ªä¸ª Cancel Context åœ¨å“ª</strong>ä¼˜å…ˆè¢« cancel ä»è€Œå¯¼è‡´å­èŠ‚ç‚¹æ”¶åˆ°äº† <code>ctx.Done()</code> ä¿¡å·ï¼Œä¸å°±å¯ä»¥è§£ç­”ç–‘æƒ‘äº†å—ï¼Ÿ</p><p>åˆ†æè¿™æ£µ Context æ ‘å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä¼˜å…ˆå»çœ‹ HTTP Server å¤„ç†è¯·æ±‚éƒ¨åˆ†çš„ä»£ç ï¼Œå°±æœ€å®¹æ˜“æ‰¾é¡ºç€è¯·æ±‚å¤„ç†çš„å„ä¸ªæµç¨‹æ¥å®šä½åˆ° Cancel Context æ˜¯åœ¨ä½•å¤„ç”Ÿæˆçš„ï¼Œä»¥åŠåœ¨ä½•å¤„ä¼šè¢«è°ƒç”¨çš„ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬å¯åŠ¨ Server æ˜¯è°ƒç”¨äº† <code>ListenAndServe</code> æ¥å£ï¼Œé¡ºç€è¯¥æ¥å£å¾€ä¸‹åˆ†æå³å¯æ‰¾åˆ°çº¿ç´¢ï¼Œè¯¦ç»†çš„åˆ†æå¦‚ä¸‹ï¼ˆå’Œæˆ‘ä»¬ç¡®å®šé—®é¢˜æ— å…³ç´§è¦çš„ä»£ç å…ˆå¿½ç•¥äº†ï¼‰ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListenAndServe ç”¨äºå¯åŠ¨æœåŠ¡å¹¶ç›‘å¬æŒ‡å®šçš„ç«¯å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">ListenAndServe</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    addr := srv.Addr</span><br><span class="line">    ln, err := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> srv.Serve(tcpKeepAliveListener&#123;ln.(*net.TCPListener)&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serve ç”¨äºæ¥æ”¶è¯·æ±‚è¿æ¥ï¼Œå¹¶ä¸ºæ¯ä¸ªæ–°çš„è¿æ¥æœåŠ¡åˆ›å»ºä¸€ä¸ª service goroutineã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span> <span class="title">Serve</span><span class="params">(l net.Listener)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// ... æ­¤å¤„çœç•¥ä¸å°‘</span></span><br><span class="line">    <span class="keyword">var</span> tempDelay time.Duration <span class="comment">// how long to sleep on accept failure</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ ¹ context</span></span><br><span class="line">    baseCtx := context.Background() <span class="comment">// base is always background, per Issue 16220</span></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ª WithValue æ­£æ˜¯ `http.&amp;contextKey&#123;"http-server"&#125;`</span></span><br><span class="line">    ctx := context.WithValue(baseCtx, ServerContextKey, srv)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        rw, e := l.Accept()</span><br><span class="line">        <span class="comment">// ...æ­¤å¤„çœç•¥å¾ˆå¤š</span></span><br><span class="line">        c := srv.newConn(rw)</span><br><span class="line">        c.setState(c.rwc, StateNew) <span class="comment">// before Serve can return</span></span><br><span class="line">        <span class="comment">// å¯åŠ¨æ–°çš„ service goroutine å¤„ç†è¿æ¥æœåŠ¡ï¼Œä¸Šé¢çš„ ctx è¢«ä¼ é€’è¿›å»äº†ï¼ï¼</span></span><br><span class="line">        <span class="keyword">go</span> c.serve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// serve è¯»å–è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ `srv.Handler` æ¥å¤„ç†è¯·æ±‚ï¼Œè¿›è€Œæ‰§è¡Œåˆ°ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œè¯·æ±‚å</span></span><br><span class="line"><span class="comment">// ç»™å®¢æˆ·ç«¯è¿”å›å“åº”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *conn)</span> <span class="title">serve</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œæ·»åŠ äº† `http.&amp;contextKey&#123;"local-addr"&#125;` å­ Context</span></span><br><span class="line">    ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr())</span><br><span class="line">    <span class="comment">// ...æ­¤å¤„çœç•¥å¾ˆå¤š</span></span><br><span class="line">    <span class="comment">// HTTP/1.x from here on.</span></span><br><span class="line">    <span class="comment">// Bingoï¼Œè¿™é‡Œçœ‹åˆ°äº†ç¬¬ä¸€ä¸ª WithCancel åˆ›å»ºçš„å­ Context äº†</span></span><br><span class="line">    ctx, cancelCtx := context.WithCancel(ctx)</span><br><span class="line">    c.cancelCtx = cancelCtx</span><br><span class="line">    <span class="keyword">defer</span> cancelCtx()</span><br><span class="line">    c.r = &amp;connReader&#123;conn: c&#125;</span><br><span class="line">    c.bufr = newBufioReader(c.r)</span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œçš„ checkConnErrorWriterï¼Œåé¢åˆ†æä¼šæ¶‰åŠ</span></span><br><span class="line">    c.bufw = newBufioWriterSize(checkConnErrorWriter&#123;c&#125;, <span class="number">4</span>&lt;&lt;<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// readRequest ä¼šè¿”å›ä¸€ä¸ª responseï¼Œå…¶ä¸­åŒ…æ‹¬æ·»åŠ å­ Cancel Context</span></span><br><span class="line">        w, err := c.readRequest(ctx)</span><br><span class="line">        <span class="comment">// ...æ­¤å¤„çœç•¥å¾ˆå¤š</span></span><br><span class="line">        <span class="comment">// æ³¨æ„è¿™é‡Œçš„ startBackgroundReadï¼Œä¸‹é¢åˆ†æä¼šçœ‹åˆ°</span></span><br><span class="line">        <span class="keyword">if</span> requestBodyRemains(req.Body) &#123;</span><br><span class="line">            registerOnHitEOF(req.Body, w.conn.r.startBackgroundRead)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w.conn.r.startBackgroundRead()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ ServeHTTPï¼Œè¿›è€Œå°†è¯·æ±‚ä¼ é€’åˆ°ä¸šåŠ¡ä»£ç ä¸­ï¼Œç­‰å¾…å¤„ç†å®Œæ¯•</span></span><br><span class="line">        <span class="comment">// åœ¨ä¸Šè¿°æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªè°ƒç”¨æ²¡æœ‰ç»“æŸçš„æ—¶å€™ï¼Œcontext</span></span><br><span class="line">        <span class="comment">// å·²ç» cancel äº†ã€‚è€Œè¿™ä¸ªè°ƒç”¨ä¸­ æˆ‘ä»¬ç¡®è®¤æ²¡æœ‰å¼‚æ­¥ cancel context çš„ä»£ç </span></span><br><span class="line">        <span class="comment">// å¹¶ä¸”ï¼Œ`*http.response` å³ `w` è¿™ä¸ªç»“æ„ä½“ä¸­ `cancelCtx` æ˜¯ä¸ªç§æœ‰å­—æ®µï¼Œä¸ä¼š</span></span><br><span class="line">        <span class="comment">// è¢«å¤–éƒ¨è®¿é—®åˆ°ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨ ServeHTTP æœŸé—´è°ƒç”¨äº† `cancelCtx` å‡½æ•°</span></span><br><span class="line">        serverHandler&#123;c.server&#125;.ServeHTTP(w, w.req)</span><br><span class="line">        <span class="comment">// é€šè¿‡å¯¹ä»£ç çš„åˆ†æï¼Œåªæœ‰æ­¤å¤„è°ƒç”¨äº†ä¸€æ¬¡ `*http.response` é‡Œé¢çš„ cancelCtx</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥æˆ‘ä»¬ç¡®è®¤å¯¼è‡´ä¸‹å±‚æ”¶åˆ° context cancel ä¿¡å·çš„è§¦å‘ç‚¹ä¸åœ¨æ­¤å¤„ï¼</span></span><br><span class="line">        w.cancelCtx()</span><br><span class="line">        w.finishRequest()</span><br><span class="line">        <span class="keyword">if</span> !w.shouldReuseConnection() &#123;</span><br><span class="line">            <span class="keyword">if</span> w.requestBodyLimitHit || w.closedRequestBodyEarly() &#123;</span><br><span class="line">                c.closeWriteAndWait()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ... æ­¤å¤„çœç•¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// readRequest ä»è¿æ¥ä¸­è¯»å–ä¸‹ä¸€ä¸ªè¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *conn)</span> <span class="title">readRequest</span><span class="params">(ctx context.Context)</span> <span class="params">(w *response, err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...æ­¤å¤„çœç•¥å¾ˆå¤š</span></span><br><span class="line">    <span class="comment">// å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ª cancel context èŠ‚ç‚¹è¯ç”Ÿäº†</span></span><br><span class="line">    ctx, cancelCtx := context.WithCancel(ctx)</span><br><span class="line">    req.ctx = ctx</span><br><span class="line">    <span class="comment">// ...æ­¤å¤„çœç•¥å¾ˆå¤š</span></span><br><span class="line">    w = &amp;response&#123;</span><br><span class="line">        conn: c,</span><br><span class="line">        cancelCtx: cancelCtx,</span><br><span class="line">        req: req,</span><br><span class="line">        reqBody: req.Body,</span><br><span class="line">        handlerHeader: <span class="built_in">make</span>(Header),</span><br><span class="line">        contentLength: <span class="number">-1</span>,</span><br><span class="line">        closeNotifyCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="comment">// We populate these ahead of time so we're not</span></span><br><span class="line">        <span class="comment">// reading from req.Header after their Handler starts</span></span><br><span class="line">        <span class="comment">// and maybe mutates it (Issue 14940)</span></span><br><span class="line">        wants10KeepAlive: req.wantsHttp10KeepAlive(),</span><br><span class="line">        wantsClose: req.wantsClose(),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> isH2Upgrade &#123;</span><br><span class="line">        w.closeAfterReply = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    w.cw.res = w</span><br><span class="line">    w.w = newBufioWriterSize(&amp;w.cw, bufferBeforeChunkingSize)</span><br><span class="line">    <span class="keyword">return</span> w, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ ¹æ®è¯¦ç»†æ‰“å°çš„ Context æ—¥å¿—ï¼Œå¹¶ç»“åˆ HTTP Server å¤„ç†éƒ¨åˆ†çš„ä»£ç åˆ†æï¼Œå¯ä»¥ç®€å•ç»˜åˆ¶å‡ºè¿™æ£µ Context æ ‘å¤§ä½“å¦‚ä¸‹ï¼š<br><img src="context-tree.png" alt="context tree"></p><p>åœ¨è¿›è¡Œ Server å¤„ç†è¿æ¥è¯·æ±‚çš„æºç ä¸­ï¼Œå¯ä»¥å‘ç°ä¸å¤ªå¯èƒ½æ˜¯ç¬¬äºŒä¸ª Cancel Context å‘é€çš„å–æ¶ˆä¿¡å·ã€‚é‚£ä¹ˆï¼Œé—®é¢˜åªèƒ½å‡ºç°åœ¨ä¸€ä¸ª Cancel Context ä¸Šé¢äº†ã€‚<br>æ¥ä¸‹æ¥ï¼Œå°±çœ‹çœ‹ Connection å…³è”çš„ <code>cancelCtx()</code> ç©¶ç«Ÿä¼šåœ¨å“ªå‡ å¤„è°ƒç”¨ï¼Ÿåˆ©ç”¨æœç´¢å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä¸¤ä¸ªå«Œç–‘å¾ˆå¤§çš„åœ°æ–¹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handleReadError åœ¨ä»å®¢æˆ·ç«¯è¯»å–å¤±è´¥æ—¶ä¼šè¢«è°ƒç”¨ã€‚è¿™é‡Œçš„é”™è¯¯ä¹‹æ‰€ä»¥</span></span><br><span class="line"><span class="comment">// è¢«çœç•¥ï¼Œæ˜¯å› ä¸ºé”™è¯¯é€šå¸¸å°±æ˜¯ io.EOF æˆ–è€… "use of closed network connection"</span></span><br><span class="line"><span class="comment">// æ ‡å‡†åº“è®¤ä¸ºæˆ‘ä»¬å¯¹å…·ä½“æŠ¥é”™ä¸æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥è¿ error æ˜¯ä»€ä¹ˆåœ¨ä¸šåŠ¡ä»£ç ä¸­æ˜¯æ— æ³•è·å–</span></span><br><span class="line"><span class="comment">// åˆ°çš„ã€‚</span></span><br><span class="line"><span class="comment">// æ€»ä¹‹ï¼Œæ‰§è¡Œåˆ°æ­¤å¤„ï¼Œå°±æ„å‘³ç€è¿æ¥å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥ä¸€å®šè¦é€šçŸ¥å–æ¶ˆ context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cr *connReader)</span> <span class="title">handleReadError</span><span class="params">(_ error)</span></span> &#123;</span><br><span class="line">    cr.conn.cancelCtx()</span><br><span class="line">    cr.closeNotify()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w checkConnErrorWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line">    n, err = w.c.rwc.Write(p)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; w.c.werr == <span class="literal">nil</span> &#123;</span><br><span class="line">        w.c.werr = err</span><br><span class="line">        w.c.cancelCtx()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡è¿›ä¸€æ­¥åˆ†æï¼Œ<code>checkConnErrorWriter</code> åªæœ‰åœ¨è¯·æ±‚å¤„ç†å®Œæ¯•ï¼Œ<code>w.finishRequest()</code> æ—¶æ‰å¯èƒ½ä¼šåœ¨æŸä¸ªæ—¶åˆ»è¢«è°ƒç”¨ã€‚æ‰€ä»¥ä¸å¯èƒ½æ˜¯è¿™é‡Œçš„ <code>cancelCtx()</code> è°ƒç”¨å¯¼è‡´çš„ï¼Œå› ä¸ºåœ¨æŠ¥é”™æ—¶ï¼Œæ˜¾ç„¶è¿˜æ²¡æœ‰å®Œæˆ <code>ServeHTTP()</code> çš„æµç¨‹ã€‚ä¸€é€šæ’æŸ¥ä¸‹æ¥ï¼Œåªå¯èƒ½æ˜¯åœ¨ <code>handleReadError()</code> æ—¶æŠ¥é”™äº†ã€‚ç»“åˆç½‘ä¸Šçš„æœç´¢ä¿¡æ¯ï¼Œæˆ‘ä»¬åˆ¤æ–­ææœ‰å¯èƒ½æ˜¯å®¢æˆ·ç«¯è¿æ¥æ–­å¼€å¯¼è‡´çš„å¤§é‡æŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>handleReadError()</code> è¢«è°ƒç”¨æ‰å¯¼è‡´çš„ã€‚</p><h2 id="æ·»åŠ -HTTP-Middleware-ç›‘æµ‹è¿æ¥æ–­å¼€"><a href="#æ·»åŠ -HTTP-Middleware-ç›‘æµ‹è¿æ¥æ–­å¼€" class="headerlink" title="æ·»åŠ  HTTP Middleware ç›‘æµ‹è¿æ¥æ–­å¼€"></a>æ·»åŠ  HTTP Middleware ç›‘æµ‹è¿æ¥æ–­å¼€</h2><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•éªŒè¯çš„ç¡®æ˜¯ connection closed å¯¼è‡´çš„å‘¢ï¼Ÿé€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¤„ç†é”™è¯¯æ—¶è°ƒç”¨äº† <code>closeNotify()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°† <code>*http.response</code> çš„ <code>closeNotifyCh</code> å‘é€ä¸€ä¸ª true å€¼ã€‚è¿›ä¸€æ­¥å‘ç°ï¼Œ<code>*http.response</code> å®ç°äº†æ¥å£ <code>CloseNotifier</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­ç›‘å¬è¿™ä¸ªä¿¡å·æ¥è¿›ä¸€æ­¥éªŒè¯è¿æ¥æ˜¯ä¸æ˜¯çœŸçš„æ–­å¼€äº†ã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶ï¼Œå¯åŠ¨ä¸€ä¸ª goroutine å»ç›‘å¬å…³é—­ä¿¡å·ï¼Œå¹¶åœ¨æ”¶åˆ°ä¿¡å·æ—¶å‘ Sentry ä¸­æ‰“å°ç›¸å…³æŠ¥é”™ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MonitorCloseNotifier</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> r.Method == <span class="string">"GET"</span> &amp;&amp; strings.EqualFold(r.URL.Path, <span class="string">"/check_health"</span>) &#123;</span><br><span class="line">            next.ServeHTTP(w, r)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        log.Warn(err)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;()</span><br><span class="line">                cc := w.(http.CloseNotifier).CloseNotify()</span><br><span class="line">                value := &lt;-cc</span><br><span class="line">                ctx := context.WithValue(</span><br><span class="line">                    r.Context(),</span><br><span class="line">                    log.SentrySpecificMetaCtxKey,</span><br><span class="line">                    collectSentryMeta(r, <span class="string">"login_id"</span>),</span><br><span class="line">                )</span><br><span class="line">                log.WithContext(ctx).Errorf(</span><br><span class="line">                    <span class="string">"connection read error, maybe 'use of closed network connection' or 'io.EOF'. return value: %v"</span>, value)</span><br><span class="line">            &#125;()</span><br><span class="line">            next.ServeHTTP(w, r)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨å®Œæˆä»£ç å˜æ›´ï¼Œå¹¶è¿›è¡Œé‡‘ä¸é›€å°æµé‡éªŒè¯æ—¶ï¼Œåœ¨ Sentry ä¸Šçœ‹åˆ°äº†ç›¸å…³çš„æŠ¥é”™ã€‚ç”±æ­¤ç¡®è®¤æ˜¯åœ¨ä½•å¤„å› ä¸ºä»€ä¹ˆå¯¼è‡´äº† Context Cancelã€‚<br><img src="./conn-close-error.png" alt="connection error"></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å†ç»å¤šæ¬¡ä»£ç å˜æ›´å’Œæ—¥å¿—åˆ†ææ‰æœ€ç»ˆç¡®å®š<strong>åœ¨ä½•å¤„å› ä¸ºä»€ä¹ˆ</strong>å¯¼è‡´äº† Context Cancelï¼Œæ•´ä¸ªè¿‡ç¨‹éå¸¸åå·ã€‚é‚£ä¸ºä»€ä¹ˆæ²¡æœ‰ç›´æ¥è¿›è¡Œè°ƒè¯•å‘¢ï¼Ÿé‚£æ ·å®šä½é—®é¢˜ä¸æ˜¯æ›´å¿«é€Ÿäº›å—ï¼ŸåŸå› æ˜¯è¿™æ ·ï¼Œæœ€å¼€å§‹æˆ‘ä»¬å¹¶ä¸çŸ¥é“ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼›è¿™æ ·ä¹Ÿå°±æ²¡æ³•åœ¨æœ¬åœ°å¤ç°é—®é¢˜ï¼Œç”±äºè¿™äº›é—®é¢˜æ˜¯åœ¨çº¿ä¸Šäº§ç”Ÿçš„ï¼Œä¹Ÿä¸å¤§å¯èƒ½ç›´æ¥åœ¨çº¿ä¸Šæ‹¦æˆªç”¨æˆ·è¯·æ±‚å¹¶è°ƒè¯•ï¼Œé‚£æ ·å¯èƒ½æ›´åŠ ç¹çã€è€—æ—¶ï¼Œä¸”å®æ–½æˆæœ¬æ›´å¤§ï¼ˆå› ä¸ºæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“å“ªä¸ªç”¨æˆ·ä½¿ç”¨ä»€ä¹ˆè®¾å¤‡åœ¨ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿé—®é¢˜ï¼‰ã€‚</p><p>æ‰€ä»¥é‡‡å–åˆ†æé”™è¯¯æ—¥å¿—åŠ éªŒè¯çš„æ–¹å¼æ¥ç¡®å®šé—®é¢˜æ‰€åœ¨ã€‚å½“ç„¶ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆéº»çƒ¦ä¹Ÿæ˜¯å› ä¸º Context Cancel æ—¶æä¾›çš„ Error å¤ªå•ä¸€äº†ã€‚å¦‚æœæœ€åˆ API è®¾è®¡æ—¶å°±èƒ½æä¾›è‡ªå®šä¹‰çš„é”™è¯¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“é”™è¯¯æ¥å®šä½åˆ°å¯èƒ½äº§ç”ŸæŠ¥é”™çš„ä½ç½®ï¼Œè¿™æ ·ä¼šæ›´åŠ å¿«æ·ï¼</p><h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><p><code>context</code> åŒ…æœ€åˆæ˜¯ç”± Google å®˜æ–¹å¼€å‘ï¼Œå¹¶åœ¨ Go 1.7 ç‰ˆæœ¬æ­£å¼å¼•å…¥åˆ°æ ‡å‡†åº“ä¸­çš„ã€‚å¼•å…¥è¯¥åŒ…çš„ç›®çš„æ˜¯ä¸ºäº†æä¾›ç»Ÿä¸€çš„å§¿åŠ¿<strong>å¤„ç†è¶…æ—¶ã€å–æ¶ˆä¿¡å·ä¼ é€’å’Œåœ¨ API ä¹‹é—´ä¼ é€’è¯·æ±‚ä¸Šä¸‹æ–‡æ•°æ®</strong>ã€‚å®ƒæä¾›äº†å‡ ä¸ªé‡è¦çš„æ¥å£ç”¨äºåˆ›å»º Context æ ‘ğŸŒ²ï¼š</p><ul><li><code>WithCancel</code></li><li><code>WithDeadline</code></li><li><code>WithTimeout</code></li><li><code>WithValue</code></li></ul><p>è¿™äº›æ¥å£ä¼šæ¥æ”¶ä¸€ä¸ª parent contextï¼Œå¹¶è¿”å›ä¸€ä¸ª derived contextã€‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œåº”è¯¥å±‚å±‚ä¼ é€’è¯¥ contextï¼Œä¸€èˆ¬çº¦å®šå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ contextï¼Œç­¾åç±»ä¼¼ï¼š<code>func foo(ctx context.Context)</code>ã€‚</p><p>å¯¹äº <code>WithCancel</code>, <code>WithDeadline</code>, <code>WithTimeout</code> è€Œè¨€ï¼Œå®ƒä»¬éƒ½ä¼šè¿”å› <code>cancelFunc</code> ä¾›ä½¿ç”¨è€…è°ƒç”¨ã€‚å½“ <code>cancelFunc</code> è¢«è°ƒç”¨æ—¶ï¼Œé™¤äº†è‡ªèº«ä¼šè¢«å–æ¶ˆå¤–ï¼Œå…¶å­ context éƒ½ä¼šè¢«å–æ¶ˆã€‚ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š<br><img src="./context-cancel.png" alt="context cancel"></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Context-Interface"><a href="#Context-Interface" class="headerlink" title="Context Interface"></a>Context Interface</h3><p><code>Context</code> æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Deadline ä¼šè¿”å›ä»€ä¹ˆæ—¶é—´ context ä¼šè¢«å–æ¶ˆã€‚å¦‚æœæ²¡æœ‰è®¾ç½®</span></span><br><span class="line">    <span class="comment">// è¿‡æœŸæ—¶é—´ï¼Œåˆ™ ok è¿”å› falseã€‚</span></span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Done åœ¨ context è¢«å–æ¶ˆæ—¶å¯¹åº”çš„ channel ä¼šè¢«å…³é—­ï¼Œä»è€Œè¾¾åˆ°</span></span><br><span class="line">    <span class="comment">// é€šçŸ¥æ­£åœ¨ç›‘å¬çš„ goroutine ç»ˆæ­¢æ‰‹å¤´å·¥ä½œçš„ç›®çš„ã€‚å¯¹äºä¸å¯å–æ¶ˆçš„</span></span><br><span class="line">    <span class="comment">// contextï¼Œåˆ™è¿”å› nilã€‚</span></span><br><span class="line">    <span class="comment">// å¯¹äº WithCancel, WithDeadline, WithTimeout è€Œè¨€ï¼Œæœ€ç»ˆéƒ½ä¼š</span></span><br><span class="line">    <span class="comment">// å…³é—­ done channelã€‚</span></span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Err ä¼šåœ¨ Done è¢«å…³é—­æ—¶ï¼Œè¿”å›é”™è¯¯ï¼ˆè¿™é‡Œçš„é”™è¯¯åœ¨ context åŒ…å†…ä»…é™ Canceled å’Œè¶…æ—¶ DeadlineExceededï¼‰</span></span><br><span class="line">    Err() error</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Value ç”¨äºè¿”å›å­˜å‚¨åœ¨ Context ä¸­æŒ‡å®š key å¯¹åº”çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚å¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›ç©ºã€‚</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¦‚æœåœ¨å½“å‰ context æ‰¾ä¸åˆ°ï¼Œå°±ä¼šä¸€ç›´å¾€ä¸Šæ‰¾ parent ç›´åˆ°æ ¹èŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="comment">// ä»…é™äºä½¿ç”¨ Context å­˜å‚¨ä¸€äº›è¯·æ±‚ç›¸å…³ï¼ˆrequest-scopedï¼‰æ•°æ®ï¼Œå¹¶åœ¨åº”ç”¨ä¸­ä¼ é€’ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¯¹äºä¸€äº›é¢å¤–çš„å‚æ•°ï¼Œä¼ é€’ç»å¯¹ä¸æ¨èä½¿ç”¨å®ƒï¼</span></span><br><span class="line">    Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="TODO-amp-Background"><a href="#TODO-amp-Background" class="headerlink" title="TODO &amp; Background"></a>TODO &amp; Background</h3><p>åœ¨ <code>context</code> åŒ…ä¸­å®šä¹‰äº†ä¸¤ç§ <code>emptyCtx</code>ï¼Œåˆ†åˆ«æ˜¯ <code>todo</code> å’Œ <code>background</code>ã€‚ç›¸å…³å®ç°éå¸¸ç®€å•ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// emptyCtx æ˜¯ä¸ä¼šè¢«å–æ¶ˆï¼Œæ— ä»»ä½•å€¼å’Œ deadline çš„ã€‚ä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ç©ºç»“æ„ä½“ï¼ˆstruct&#123;&#125;ï¼‰</span></span><br><span class="line"><span class="comment">// æ˜¯å› ä¸ºè¦ä¿è¯è¯¥ç±»å‹çš„æ¯ä¸ªå€¼éƒ½è¦æœ‰ä¸åŒçš„åœ°å€</span></span><br><span class="line"><span class="keyword">type</span> emptyCtx <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Deadline</span><span class="params">()</span> <span class="params">(deadline time.Time, ok <span class="keyword">bool</span>)</span></span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    background = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">    todo = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Background é€šå¸¸åœ¨ main å‡½æ•°ã€æµ‹è¯•ä¸­åˆå§‹åŒ–ï¼Œæˆ–è€…è¯·æ±‚å¯¹åº”çš„é¡¶å±‚ Context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Background</span><span class="params">()</span> <span class="title">Context</span></span> &#123; <span class="keyword">return</span> background &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO é€šå¸¸åœ¨ä¸çŸ¥é“è¯¥ç”¨ä»€ä¹ˆ Context çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å®ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TODO</span><span class="params">()</span> <span class="title">Context</span></span> &#123; <span class="keyword">return</span> todo &#125;</span><br></pre></td></tr></table></figure></p><h3 id="WithCancel"><a href="#WithCancel" class="headerlink" title="WithCancel"></a>WithCancel</h3><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>WithCancel()</code> æ¥å£æ¥åˆ›å»ºä¸€ä¸ªå¯è¢«å–æ¶ˆçš„ Contextï¼Œè¯¥æ¥å£ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å­ Context èŠ‚ç‚¹å’Œç”¨äºå–æ¶ˆæ—¶è°ƒç”¨çš„å‡½æ•° <code>cancelFunc</code>ã€‚ç›¸å…³æºç å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CancelFunc é€šçŸ¥å–æ¶ˆä»»åŠ¡ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼›åªèƒ½è¢«æœ‰æ•ˆè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line"><span class="keyword">type</span> CancelFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">WithCancel</span> ä¼šè¿”å›ä¸€ä¸ª <span class="title">parent</span> çš„æ‹·è´ï¼ŒåŒæ—¶å¸¦æœ‰ <span class="title">Done</span> <span class="title">channel</span>ã€‚</span></span><br><span class="line"><span class="function">// å–æ¶ˆè¯¥ <span class="title">context</span> æ—¶ä¼šé‡Šæ”¾å…³è”çš„èµ„æºï¼Œæ‰€ä»¥å½“è¯¥ <span class="title">Context</span> å®Œæˆæ—¶éœ€è¦å°½å¿«è°ƒç”¨ <span class="title">cancel</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span> <span class="params">(ctx Context, cancel CancelFunc)</span></span> &#123;</span><br><span class="line">    c := newCancelCtx(parent)</span><br><span class="line">    propagateCancel(parent, &amp;c)</span><br><span class="line">    <span class="keyword">return</span> &amp;c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// newCancelCtx ä¼šè¿”å›ä¸€ä¸ªåˆå§‹åŒ–å¥½çš„ cancelCtx å®ä¾‹</span></span><br><span class="line"><span class="comment">// å…³äºä»€ä¹ˆæ˜¯ cancelCtx ä¼šåœ¨ä¸‹é¢åˆ†æå®ƒçš„æºç </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCancelCtx</span><span class="params">(parent Context)</span> <span class="title">cancelCtx</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cancelCtx&#123;Context: parent&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// propagateCancel æœ¬è´¨ä¸Šæ˜¯ä¸ºäº†å°†å­ canceler æŒ‚è½½åˆ°çˆ¶ canceler èŠ‚ç‚¹ä¸Š</span></span><br><span class="line"><span class="comment">// è¿™æ ·åœ¨çˆ¶èŠ‚ç‚¹æ”¶åˆ°å–æ¶ˆé€šçŸ¥æ—¶ï¼Œæ‰èƒ½ä¸€ä¸€é€šçŸ¥åˆ°å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">propagateCancel</span><span class="params">(parent Context, child canceler)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> parent.Done() == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// parent ä¸æ”¯æŒå–æ¶ˆçš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// parent is never canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œåªæ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰ context åŒ…ä¸­å®šä¹‰çš„</span></span><br><span class="line">    <span class="comment">// cancelCtx ç»“æ„è€Œå·²</span></span><br><span class="line">    <span class="comment">// parentCancelCtx(parent) ç¡®è®¤ parent æ˜¯å¦ä¸º</span></span><br><span class="line">    <span class="comment">// cancelCtx æˆ–è€… timerCtx ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;</span><br><span class="line">        p.mu.Lock()</span><br><span class="line">        <span class="keyword">if</span> p.err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// parent has already been canceled</span></span><br><span class="line">            <span class="comment">// parent å¦‚æœè¢«å–æ¶ˆï¼Œè‡ªç„¶ä¸éœ€è¦ removeChildï¼Œå› ä¸º</span></span><br><span class="line">            <span class="comment">// parent å¯¹åº”çš„å­æ ‘ä¼šè¢« detatch æ‰ï¼Œç¡®ä¿é‡Šæ”¾èµ„æº</span></span><br><span class="line">            child.cancel(<span class="literal">false</span>, p.err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å»¶è¿Ÿåˆå§‹åŒ–äº† children</span></span><br><span class="line">            <span class="keyword">if</span> p.children == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// ä¸ºä»€ä¹ˆæ˜¯æ”¾åœ¨å­—å…¸ï¼Œè€Œéåˆ—è¡¨å‘¢ï¼Ÿ</span></span><br><span class="line">                <span class="comment">// åŸå› å¾ˆç®€å•ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿åˆ é™¤ child</span></span><br><span class="line">                <span class="comment">// delete(p.children, child)</span></span><br><span class="line">                p.children = <span class="built_in">make</span>(<span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æŠŠå­èŠ‚ç‚¹æŒ‚è½½åˆ° cancel context çš„çˆ¶èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">            p.children[child] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        p.mu.Unlock()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> &lt;-parent.Done():</span><br><span class="line">                <span class="comment">// å¯¹äºçˆ¶èŠ‚ç‚¹è¿”å› Done channel çš„è¿›è¡Œç›‘å¬</span></span><br><span class="line">                child.cancel(<span class="literal">false</span>, parent.Err())</span><br><span class="line">            <span class="keyword">case</span> &lt;-child.Done():</span><br><span class="line">                <span class="comment">// ç­‰å¾… cancel ctx è¢«ç»“æŸ</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œåªå¯èƒ½æ˜¯ timerCtx, cancelCtx</span></span><br><span class="line">                <span class="comment">// goroutine é€€å‡º</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºå¯è¢«å–æ¶ˆçš„ Context éƒ½å®ç°äº†ä¸‹é¢çš„æ¥å£ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// canceler å°±æ˜¯å®ç°äº† cancel çš„ context ç±»å‹ã€‚åœ¨æ ‡å‡†åº“ä¸­</span></span><br><span class="line"><span class="comment">// ä»…æœ‰ `cancelCtx` å’Œ `timerCtx` å®ç°äº†è¯¥æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> canceler <span class="keyword">interface</span> &#123;</span><br><span class="line">    cancel(removeFromParent <span class="keyword">bool</span>, err error)</span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨åˆ†æ WithCancel çš„æºç æ—¶ï¼Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>cancelCtx</code> å®ä¾‹ï¼Œå¹¶å°†åŸæœ‰çš„ Context ä½œä¸ºçˆ¶èŠ‚ç‚¹è®°å½•äº†ä¸‹æ¥ã€‚é‚£ä¹ˆ <code>cancelCtx</code> æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•å¤„ç†å–æ¶ˆé€»è¾‘çš„å‘¢ï¼Ÿ<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A cancelCtx can be canceled. When canceled, it also cancels any children</span></span><br><span class="line"><span class="comment">// that implement canceler.</span></span><br><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Context ä¼šæŒ‡å‘ parent</span></span><br><span class="line">    Context</span><br><span class="line">    <span class="comment">// mu ç”¨æ¥ä¿è¯ goroutine å®‰å…¨</span></span><br><span class="line">    mu sync.Mutex <span class="comment">// protects following fields</span></span><br><span class="line">    done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// created lazily, closed by first cancel call</span></span><br><span class="line">     <span class="comment">// ä¹‹æ‰€ä»¥ä½¿ç”¨å­—å…¸æ¥å­˜å‚¨ï¼Œæ˜¯å› ä¸ºä¸å…³å¿ƒå­èŠ‚ç‚¹é¡ºåºï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿åˆ é™¤</span></span><br><span class="line">    children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// set to nil by the first cancel call</span></span><br><span class="line">    err error <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Done ä¼šè¿”å›ä¸€ä¸ªå»¶è¿Ÿåˆå§‹åŒ–çš„ chan ä¾›ä¸‹æ¸¸ç›‘å¬å®Œæˆä¿¡å·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// å»¶è¿Ÿåˆå§‹åŒ–</span></span><br><span class="line">        c.done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    d := c.done</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Err</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    err := c.err</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cancel è´Ÿè´£å…³é—­ c.done chanï¼ŒåŒæ—¶å–æ¶ˆæ¯ä¸ªå­èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// å¹¶æ ¹æ®éœ€è¦å°†å¯¹åº”çš„èŠ‚ç‚¹ä»å®ƒçš„çˆ¶èŠ‚ç‚¹çš„ children ä¸­ç§»é™¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">cancel</span><span class="params">(removeFromParent <span class="keyword">bool</span>, err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"context: internal error: missing cancel error"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.mu.Unlock()</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// already canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.err = err</span><br><span class="line">    <span class="keyword">if</span> c.done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ç¡®ä¿ä¸‹æ¬¡è°ƒç”¨æ—¶å·²ç»å…³é—­äº†</span></span><br><span class="line">        c.done = closedchan</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(c.done)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> child := <span class="keyword">range</span> c.children &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> acquiring the child's lock while holding parent's lock.</span></span><br><span class="line">        <span class="comment">// ä¾æ¬¡ cancel æ‰€æœ‰çš„å­èŠ‚ç‚¹</span></span><br><span class="line">        child.cancel(<span class="literal">false</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    c.children = <span class="literal">nil</span></span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">        removeChild(c.Context, c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="WithDeadline-amp-WithTimeout"><a href="#WithDeadline-amp-WithTimeout" class="headerlink" title="WithDeadline &amp; WithTimeout"></a>WithDeadline &amp; WithTimeout</h3><p>å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹ goroutine è®¾ç½®è¶…æ—¶æˆ–è€…åˆ°è¾¾æŒ‡å®šæ—¶é—´åé€€å‡ºçš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>WithDeadline()</code> æˆ– <code>WithTimeout()</code> æ¥å®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithDeadline ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆ°æœŸæ—¶é—´æ§åˆ¶çš„ contextï¼Œåœ¨æ—¶é—´åˆ°è¾¾åä¼šè‡ªåŠ¨</span></span><br><span class="line"><span class="comment">// å…³é—­ done channelï¼ŒåŒæ—¶ä¸‹æ¸¸çš„èŠ‚ç‚¹ä¹Ÿä¼šæ”¶åˆ°å–æ¶ˆé€šçŸ¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº</span></span><br><span class="line"><span class="comment">// è¿™ç§ç±»å‹çš„ cancelï¼Œå¯¹åº”çš„ Error æ˜¯ DeadlineExceeded</span></span><br><span class="line"><span class="comment">// å¦å¤–ï¼Œè¿”å›çš„ cancelFunc ä¸€å®šè¦è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿èµ„æºæœ€ç»ˆèƒ½è¢«é‡Šæ”¾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, d time.Time)</span> <span class="params">(Context, CancelFunc)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœçˆ¶èŠ‚ç‚¹æå‰ç»“æŸï¼Œåˆ™ä¸ç”¨å†ä¸ºå­èŠ‚ç‚¹æ·»åŠ é¢å¤–çš„è®¡æ—¶èµ„æºäº†</span></span><br><span class="line">    <span class="comment">// å› ä¸ºå½“çˆ¶èŠ‚ç‚¹ç»“æŸæ—¶ï¼Œå­èŠ‚ç‚¹ä¹Ÿä¼šè¢«é€šçŸ¥åˆ°</span></span><br><span class="line">    <span class="keyword">if</span> cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œï¼Œå¦‚æœè¯´å·²ç»åˆ°æœŸäº†ï¼Œè‡ªç„¶æ²¡å¿…è¦å¼•å…¥ä¸€ä¸ªè®¡æ—¶å™¨èµ„æº</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ç›´æ¥è¿”å›ä¸€ä¸ª Cancel Context äº†</span></span><br><span class="line">        <span class="keyword">return</span> WithCancel(parent)</span><br><span class="line">    &#125;</span><br><span class="line">    c := &amp;timerCtx&#123;</span><br><span class="line">        cancelCtx: newCancelCtx(parent),</span><br><span class="line">        deadline: d,</span><br><span class="line">    &#125;</span><br><span class="line">    propagateCancel(parent, c)</span><br><span class="line">    dur := time.Until(d)</span><br><span class="line">    <span class="keyword">if</span> dur &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæŒ‡å®šçš„æ—¶é—´ç‚¹å·²ç»è¿‡äº†çš„è¯ï¼Œåˆ™ç›´æ¥å–æ¶ˆ</span></span><br><span class="line">        c.cancel(<span class="literal">true</span>, DeadlineExceeded)</span><br><span class="line">        <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">false</span>, Canceled) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.err == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.timer = time.AfterFunc(dur, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// å½“æ—¶é—´åˆ°äº†åï¼Œä¼šæ‰§è¡Œ cancel æ–¹æ³•</span></span><br><span class="line">            c.cancel(<span class="literal">true</span>, DeadlineExceeded)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WithTimeout æŒ‡å®šè¶…æ—¶æ—¶é—´çš„ Contextï¼Œå…¶å®å°±æ˜¯å¤ç”¨äº† WithDeadline æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span> <span class="params">(Context, CancelFunc)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>timerCtx</code> æ˜¯å®ç°å¸¦å®šæ—¶åŠŸèƒ½çš„ Context ç±»å‹ï¼Œå®ƒçš„å®ç°æ¯”è¾ƒç®€å•ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> timerCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    cancelCtx</span><br><span class="line">    timer *time.Timer <span class="comment">// timer èµ„æºçš„è®¿é—®æ˜¯ç”± cancelCtx ä¸­çš„ Lock æ¥ä¿éšœçš„</span></span><br><span class="line">    deadline time.Time</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span> <span class="title">Deadline</span><span class="params">()</span> <span class="params">(deadline time.Time, ok <span class="keyword">bool</span>)</span></span> &#123; <span class="keyword">return</span> c.deadline, <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cancel ä¸»è¦åœ¨ timerCtx å–æ¶ˆæ—¶ï¼Œé‡Šæ”¾æ‰ timer èµ„æº</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span> <span class="title">cancel</span><span class="params">(removeFromParent <span class="keyword">bool</span>, err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„ done channel close æ‰ï¼ŒåŒæ—¶å–æ¶ˆç›¸å…³å­èŠ‚ç‚¹</span></span><br><span class="line">    c.cancelCtx.cancel(<span class="literal">false</span>, err)</span><br><span class="line">    <span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">        removeChild(c.cancelCtx.Context, c)</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.timer != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ timer èµ„æº</span></span><br><span class="line">        c.timer.Stop()</span><br><span class="line">        c.timer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="WithValue"><a href="#WithValue" class="headerlink" title="WithValue"></a>WithValue</h3><p>é€šå¸¸ä½¿ç”¨ <code>WithValue()</code> æ–¹æ³•ç»™ Context é™„åŠ ä¸€äº›è¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">Context</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> key == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"nil key"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿è¯ Key æœ¬èº«æ˜¯å¯æ¯”è¾ƒçš„å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> !reflectlite.TypeOf(key).Comparable() &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"key is not comparable"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> valueCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    Context</span><br><span class="line">    key, val <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">if</span> c.key == key &#123;</span><br><span class="line">        <span class="keyword">return</span> c.val</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾€ parent å»æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">return</span> c.Context.Value(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><h3 id="ä¼ é€’è¯·æ±‚ç›¸å…³çš„æ•°æ®"><a href="#ä¼ é€’è¯·æ±‚ç›¸å…³çš„æ•°æ®" class="headerlink" title="ä¼ é€’è¯·æ±‚ç›¸å…³çš„æ•°æ®"></a>ä¼ é€’è¯·æ±‚ç›¸å…³çš„æ•°æ®</h3><p>ä½¿ç”¨ WithValue å°†éœ€è¦çš„è¯·æ±‚æ•°æ®å­˜å‚¨åœ¨ Context ä¸­ï¼Œæ–¹ä¾¿å‘ä¸‹ä¼ é€’ã€‚æˆ‘ä»¬ä¸€èˆ¬è¦å°½é‡é¿å…åœ¨ä¸šåŠ¡ä»£ç ä¸­ç›´æ¥è§£æ Context ä¸­çš„æŸäº› Keyã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> contextKey <span class="keyword">struct</span>&#123; name <span class="keyword">string</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    <span class="comment">// ä¸è¦ä½¿ç”¨ string keyï¼Œé¿å…å†²çª</span></span><br><span class="line">    traceIDCtxKey = &amp;contextKey&#123;name: <span class="string">"request-trace-id"</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºè®®ä½¿ç”¨å‡½æ•°å°è£…ä¸‹ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£æ–¹ä¾¿ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTraceID</span><span class="params">(ctx context.Context, id <span class="keyword">string</span>)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> context.WithValue(ctx, traceIDCtxKey, id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TraceIDFrom</span><span class="params">(ctx context.Context)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> traceID, ok := ctx.Value(traceIDCtxKey).(<span class="keyword">string</span>); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> traceID</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exampleWithValue</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    doStuff := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">        traceID := TraceIDFrom(ctx)</span><br><span class="line">        fmt.Printf(<span class="string">"got request trace id: %s\n"</span>, traceID)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿä¼ é€’è¯·æ±‚ trace idï¼Œè¿™äº›å¯ä»¥è¢«æ—¥å¿—æ¡†æ¶ç­‰æå–å¹¶å­˜å‚¨åˆ°æ—¥å¿—ä¸­</span></span><br><span class="line">    id, _ := uuid.GenerateUUID()</span><br><span class="line">    ctx = WithTraceID(ctx, id)</span><br><span class="line">    doStuff(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¶…æ—¶æ§åˆ¶"><a href="#è¶…æ—¶æ§åˆ¶" class="headerlink" title="è¶…æ—¶æ§åˆ¶"></a>è¶…æ—¶æ§åˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exampleWithTimeout æ¨¡æ‹Ÿä¸€ç»„è¯·æ±‚ï¼Œå¹¶ä¸”å‡è®¾æ¯ä¸ªè¯·æ±‚å¤„ç†æ—¶é—´ä¸º 0~3 ç§’çš„éšæœºæ—¶é—´</span></span><br><span class="line"><span class="comment">// åŒæ—¶æˆ‘ä»¬å°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 1 ç§’ï¼Œè¿™æ ·åœ¨è¯·æ±‚æœŸé—´å°±ä¼šæœ‰äº›å› ä¸ºè¶…æ—¶è€Œä¸»åŠ¨ç»“æŸåç»­æ‰§è¡Œæµç¨‹</span></span><br><span class="line"><span class="comment">// çš„ goroutine æ”¶åˆ°å–æ¶ˆä¿¡å·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exampleWithTimeout</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    doRequest := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè¯·æ±‚</span></span><br><span class="line">        time.Sleep(time.Duration(rand.Int63n(<span class="number">3</span>)) * time.Second)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Printf(<span class="string">"[%d]request canceled\n"</span>, id)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// å¤„ç†å…¶å®ƒä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx, cancel := context.WithTimeout(ctx, time.Second*<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            doRequest(ctx, id+<span class="number">1</span>)</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>ä¸å»ºè®®å°† Context å­˜æ”¾åœ¨ç»“æ„ä½“ä¸­ï¼Œè€Œåº”è¯¥ä½œä¸ºå‚æ•°æ˜¾å¼ä¼ é€’ï¼›ä¸€èˆ¬æ¥æ”¶ Context ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œåº”è¯¥å°†è¯¥å‚æ•°æ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®ï¼ˆè¿™ä¸ªæ˜¯æƒ¯ä¾‹äº†ï¼‰ï¼›</li><li>åœ¨ç»™å‡½æ•°ä¼ é€’ Context æ—¶ï¼Œå¦‚æœä¸çŸ¥é“ç”¨ä»€ä¹ˆ Contextï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>Context.TODO()</code>ï¼Œé¿å…ä¼ é€’ nil</li><li>Context Value éœ€è¦æœ‰çº¦æŸï¼Œå¿…é¡»åº”è¯¥ç¬¦åˆ<strong>è¯·æ±‚ç›¸å…³</strong>çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå¹¶ä¸”ä¸€èˆ¬æ˜¯åœ¨æ¡†æ¶æˆ–è€… HTTP ä¸­é—´ä»¶ä¸­è®¾ç½® Valueï¼Œä¸šåŠ¡ä»£ç ä¸­å°½å¯èƒ½é¿å…ç›´æ¥æ“ä½œ Context Valueã€‚åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¸­åº”å½“æ˜¾å¼ä¼ å‚ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨é™æ€è¯­è¨€çš„ç‰¹æ€§ï¼Œä½¿å¾—ä¸€äº›é—®é¢˜å¯ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå°±èƒ½å‘ç°ï¼›ä¸è¦ä¸ºäº†å›¾æ–¹ä¾¿ï¼Œç”¨ Context å¸¦ä¸€äº›å¯é€‰å‚æ•°ã€‚</li><li>åœ¨ä½¿ç”¨ <code>WithValue(key, value)</code> æ—¶ï¼ŒKey åº”è¯¥é¿å…ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œé˜²æ­¢åå­—å†²çªå’Œæ±¡æŸ“ï¼›</li><li>åœ¨ä½¿ç”¨ <code>WithCancel</code>, <code>WithTimeout</code>, <code>WithDeadline</code> æ—¶ï¼Œä¸€å®šè¦ä¿è¯è¿”å›çš„ cancel æ–¹æ³•è‡³å°‘è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œé¿å… goroutine æ³„éœ²æˆ–è€…å…¶å®ƒèµ„æºæ³„éœ²ï¼›</li><li>ç”±äºç›®å‰åœ¨æ ‡å‡†åº“ä»¥åŠä¸€äº›ç¬¬ä¸‰æ–¹åº“ä¸­éƒ½åœ¨ä½¿ç”¨ Contextï¼Œä¸€è·¯ä¼ é€’ä¸‹æ¥ï¼Œæ•´ä½“é“¾è·¯å¾ˆé•¿ã€‚è€Œå½“å‘ç”Ÿ Context Cancel æ—¶ï¼Œæ’æŸ¥èµ·æ¥å°±éå¸¸éº»çƒ¦ã€‚æ‰€ä»¥éœ€è¦å¯¹æ‰€ä½¿ç”¨å„ç±»æ¡†æ¶æˆ–è€…åº“åœ¨æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„ç”Ÿå‘½å‘¨æœŸéœ€è¦æœ‰ä¸€å®šçš„äº†è§£ï¼Œå†é…åˆæ—¥å¿—ç­‰æ‰‹æ®µè¿›è¡Œæ’æŸ¥èµ·æ¥ä¼šæ›´åŠ æœ‰æ•ˆã€‚</li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://www.flysnow.org/2017/05/12/go-in-action-go-context.html" target="_blank" rel="noopener">Goè¯­è¨€å®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰| Go Context</a></li><li><a href="https://blog.golang.org/context" target="_blank" rel="noopener">Go Concurrency Patterns: Context</a></li><li><a href="https://medium.com/@cep21/how-to-correctly-use-context-context-in-go-1-7-8f2c0fafdf39" target="_blank" rel="noopener">How to correctly use context.Context in Go 1.7</a></li><li><a href="https://medium.com/@cep21/go-1-7-httptrace-and-context-debug-patterns-608ae887224a" target="_blank" rel="noopener">Go 1.7 httptrace and context debug patterns</a></li><li><a href="https://medium.com/@blanchon.vincent/go-context-and-cancellation-by-propagation-7a808bbc889c" target="_blank" rel="noopener">Go: Context and Cancellation by Propagation</a></li><li><a href="https://medium.com/@cep21/how-to-correctly-use-context-context-in-go-1-7-8f2c0fafdf39" target="_blank" rel="noopener">How to correctly use context.Context in Go 1.7</a></li><li><a href="https://liudanking.com/sitelog/understanding-golang-http-timeout/" target="_blank" rel="noopener">æ·±å…¥ç†è§£ Golang HTTP Timeout</a></li><li><a href="https://www.calhoun.io/pitfalls-of-context-values-and-how-to-avoid-or-mitigate-them/" target="_blank" rel="noopener">Pitfalls of context values and how to avoid or mitigate them in Go</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ä¸€æ¬¡æ’æŸ¥æŸ HTTP æ¥å£è¯·æ±‚é¢‘ç¹å›  context canceled é”™è¯¯å¯¼è‡´è¯·æ±‚å¤„ç†å¤±è´¥çš„é—®é¢˜æœŸé—´ï¼Œæ·±å…¥äº†è§£äº†ä¸‹ Go è¯­è¨€çš„ Context å®ç°ã€‚æœ¬æ–‡å°†é¦–å…ˆä»‹ç»æˆ‘ä»¬æ˜¯å¦‚ä½•æ’æŸ¥è¯¡å¼‚çš„ &lt;code&gt;context canceled&lt;/code&gt; äº§ç”ŸåŸå› ï¼ˆä¹Ÿå°±æ˜¯åœ¨å“ªå„¿å› ä¸ºä»€ä¹ˆè€Œå¯¼è‡´å–æ¶ˆçš„ï¼‰ï¼›æ¥ä¸‹æ¥å°†æ·±å…¥ä»‹ç» Context è¯ç”Ÿçš„ç›®çš„ã€æºç è§£æåŠåº”ç”¨åœºæ™¯ç­‰ï¼Œä¾¿äºæ›´è¿›ä¸€æ­¥åŠ æ·±å¯¹å®ƒçš„ç†è§£ï¼›æœ€åæˆ‘ä»¬ä¹Ÿä¼šè°ˆåŠä½¿ç”¨ Context çš„ä¸€äº›ç—›ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Go" scheme="http://ifaceless.space/categories/Go/"/>
    
    
      <category term="Go" scheme="http://ifaceless.space/tags/Go/"/>
    
      <category term="æ ‡å‡†åº“" scheme="http://ifaceless.space/tags/%E6%A0%87%E5%87%86%E5%BA%93/"/>
    
      <category term="æºç è§£è¯»" scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Context" scheme="http://ifaceless.space/tags/Context/"/>
    
  </entry>
  
  <entry>
    <title>CSS å­¦ä¹ ç¬”è®°</title>
    <link href="http://ifaceless.space/2019/07/16/css-learning-notes/"/>
    <id>http://ifaceless.space/2019/07/16/css-learning-notes/</id>
    <published>2019-07-16T14:35:57.000Z</published>
    <updated>2019-11-24T09:45:59.821Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ä» 0 åˆ° 1 å®ç°ä¸€ä¸ªç½‘ç«™ï¼Œå‰ç«¯éƒ¨åˆ†è‡ªç„¶æ˜¯è¦äº†è§£ CSS çš„ã€‚CSS çš„å…¨ç§°æ˜¯ Cascading Style Sheetsï¼Œå®ƒæ˜¯ä¸€ç§ä¸“é—¨ç”¨äºç»™ç»“æ„åŒ–æ–‡æ¡£ï¼ˆå¦‚ Web HTMLï¼‰æ·»åŠ æ ·å¼çš„è¯­è¨€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ CSS æ¥ä¸ºç½‘é¡µå¸ƒå±€ï¼Œè®¾å®šå­—ä½“çš„æ ·å¼ï¼Œè®¾å®šåŠ¨ç”»ç­‰ï¼Œè®©æˆ‘ä»¬çš„ç½‘ç«™æ›´åŠ ç‚«é…·ï¼Œæ›´åŠ ç°ä»£åŒ–ã€‚è€Œè¿™äº›é€šè¿‡ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ä¼šéå¸¸ç¹çï¼Œä½¿ç”¨ CSS åªéœ€è¦æŒ‰éœ€å®šä¹‰å³å¯ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚æœ¬ç¯‡ç¬”è®°ä¸»è¦æ˜¯è®°å½•æ ¸å¿ƒçš„ CSS æŠ€å·§ï¼Œç›¸å…³çš„ç»ƒä¹ ä½äº GitHub <a href="https://www.github.com/ifaceless/learning-css" target="_blank" rel="noopener">learning-css ä»“åº“</a>ã€‚</p><a id="more"></a><h1 id="CSS-åŸºç¡€"><a href="#CSS-åŸºç¡€" class="headerlink" title="CSS åŸºç¡€"></a>CSS åŸºç¡€</h1><ul><li><p>å¤šé‡æ ·å¼ä¼˜å…ˆçº§é¡ºåºï¼ˆä¾æ¬¡å¢åŠ ï¼‰ï¼š</p><ol><li>é€šç”¨é€‰æ‹©å™¨ï¼ˆ<code>*</code>ï¼‰</li><li>å…ƒç´ ï¼ˆç±»å‹ï¼‰é€‰æ‹©å™¨</li><li>ç±»é€‰æ‹©å™¨</li><li>å±æ€§é€‰æ‹©å™¨</li><li>ä¼ªç±»</li><li>ID é€‰æ‹©å™¨</li><li>å†…è”æ ·å¼</li></ol></li><li><p><code>!important</code> è§„åˆ™åœ¨è¢«åº”ç”¨æ ·å¼å£°æ˜ä¸­æ—¶ï¼Œè¯¥æ ·å¼å£°æ˜ä¼šè¦†ç›– CSS ä¸­ä»»ä½•å…¶ä»–çš„å£°æ˜ï¼Œä½¿ç”¨å®ƒå¹¶éå¥½ä¹ æƒ¯ï¼š</p><ol><li><strong>Always</strong>ï¼šè¦ä¼˜åŒ–è€ƒè™‘ä½¿ç”¨æ ·å¼è§„åˆ™çš„ä¼˜å…ˆçº§æ¥è§£å†³é—®é¢˜ï¼Œè€Œé <code>!important</code></li><li><strong>Only</strong>ï¼šåªæœ‰åœ¨éœ€è¦è¦†ç›–å…¨ç«™æˆ–å¤–éƒ¨ CSS çš„ç‰¹å®šé¡µé¢ä¸­ä½¿ç”¨å®ƒ</li><li><strong>Never</strong>ï¼šæ°¸è¿œä¸è¦åœ¨å…¨ç«™èŒƒå›´ä½¿ç”¨å®ƒ</li><li><strong>Never</strong>ï¼šæ°¸è¿œä¸è¦åœ¨ä½ çš„æ’ä»¶ä¸­ä½¿ç”¨å®ƒ</li></ol></li><li><p>CSS é“¾æ¥æ ·å¼ï¼š</p><ol><li>å››ç§ç‰¹æ®ŠçŠ¶æ€å¯ä»¥åˆ†åˆ«è®¾ç½®ï¼š<ol><li><code>a:link</code>: æ­£å¸¸ï¼Œæœªè®¿é—®è¿‡çš„é“¾æ¥</li><li><code>a:visited</code>: å·²è®¿é—®è¿‡çš„é“¾æ¥</li><li><code>a:hover</code>: é¼ æ ‡æ”¾åœ¨é“¾æ¥ä¸Šæ—¶</li><li><code>a:active</code>: é“¾æ¥è¢«ç‚¹å‡»çš„é‚£åˆ»</li></ol></li><li>ä¸Šè¿°é¡ºåºå¾ˆé‡è¦ï¼Œç®€è®°ï¼š<code>L(ink)OV(isited)E and H(over)A(ctive)TE</code></li></ol></li><li><p>æ‰€æœ‰çš„ HTML å…ƒç´ éƒ½å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª Boxã€‚CSS ç›’æ¨¡å‹æœ¬è´¨ä¸Šå°±æ˜¯å°è£…äº† HTML å…ƒç´ çš„ç›’å­ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š<img src="./box.png" alt=""></p></li><li><p>å½“æŒ‡å®š CSS å…ƒç´ çš„é«˜åº¦å’Œå®½åº¦æ—¶ï¼Œåªæ˜¯åœ¨è®¾ç½®<strong>å†…å®¹åŒºåŸŸ</strong>çš„é«˜åº¦å’Œé«˜åº¦ã€‚å®é™…å…ƒç´ å°ºå¯¸è®¡ç®—ï¼š</p><ol><li>æ€»å®½åº¦ = å†…å®¹å®½åº¦ + å·¦å¡«å…… + å³å¡«å…… + å·¦è¾¹æ¡† + å³è¾¹æ¡† + å·¦è¾¹è· + å³è¾¹è·</li><li>æ€»é«˜åº¦ = å†…å®¹é«˜åº¦ + é¡¶éƒ¨å¡«å…… + åº•éƒ¨å¡«å…… + ä¸Šè¾¹æ¡† + ä¸‹è¾¹æ¡† + ä¸Šè¾¹è· + ä¸‹è¾¹è·</li></ol></li><li><p>ç›’æ ·å¼åº”ç”¨ï¼ˆé€‚ç”¨äº margin, padding ç­‰ç®€å†™æ ·å¼çš„æƒ…å†µï¼‰ï¼š</p><ul><li>å››ä¸ªå€¼ï¼ša, b, c, d -&gt; ä¸Šï¼Œä¸‹ï¼Œå·¦ï¼Œå³ï¼ˆé€†æ—¶é’ˆæ–¹å‘ï¼‰</li><li>ä¸‰ä¸ªå€¼ï¼ša, b, c -&gt; ä¸Šï¼Œå·¦å³ï¼Œä¸‹</li><li>ä¸¤ä¸ªå€¼ï¼ša, b -&gt; ä¸Šä¸‹ï¼Œå·¦å³</li><li>ä¸€ä¸ªå€¼ï¼ša -&gt; ä¸Šä¸‹å·¦å³</li></ul></li><li><p>outline æ˜¯åœ¨ border å¤–éƒ¨çš„ï¼Œåœ¨å…ƒç´ å‘¨å›´ç»˜åˆ¶å‡ºå…ƒç´ çš„è¾¹ç¼˜ï¼Œèµ·åˆ°çªå‡ºå…ƒç´ çš„ä½œç”¨ã€‚ä½¿ç”¨æ–¹å¼ç±»ä¼¼ <code>border</code>ï¼Œå¯è®¾å®šçš„å±æ€§åŒ…æ‹¬ï¼š<code>outline-style</code>, <code>outline-color</code>, <code>outline-width</code> ç­‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>outline</code> æ˜¯ä¸å ç©ºé—´çš„ï¼Œä¸ä¼šå¢åŠ é¢å¤–çš„å®½åº¦å’Œé«˜åº¦ã€‚<code>outline</code> ä¹Ÿå¯èƒ½æ˜¯éçŸ©å½¢çš„ï¼Œå’Œæµè§ˆå™¨å®ç°æœ‰å…³ã€‚</p></li><li><p>margin &amp; paddingï¼š<img src="./margin-padding.png" alt=""></p></li><li><p>éšè—å…ƒç´ ï¼š</p><ul><li><code>display:none</code>ï¼šä¸ä¼šå æ®ç©ºé—´ï¼Œä¼šä»å¸ƒå±€ä¸­ç§»é™¤</li><li><code>visibility:hidden</code>ï¼šä¼šå æ®ç©ºé—´ï¼Œå½±å“å¸ƒå±€</li></ul></li><li><p><strong>å—ï¼ˆ blockï¼‰å…ƒç´ </strong>ï¼š</p><ul><li>å æ®å…¨éƒ¨å®½åº¦ï¼Œå¹¶ä¸”ä¼šäº§ç”Ÿæ¢è¡Œ</li><li>width, height, padding, margin éƒ½æ˜¯å¯æ§åˆ¶çš„</li><li>å—å…ƒç´ ï¼š<code>&lt;address/&gt;</code>, <code>&lt;blockquote/&gt;</code>, <code>&lt;center/&gt;</code>, <code>&lt;dir/&gt;</code>, <code>&lt;div/&gt;</code>, <code>&lt;dl/&gt;</code>, <code>&lt;fieldset/&gt;</code>, <code>&lt;form/&gt;</code>, <code>&lt;h1/&gt;</code>, <code>&lt;h2/&gt;</code>, <code>&lt;h3/&gt;</code>, <code>&lt;h4/&gt;</code>, <code>&lt;h5/&gt;</code>, <code>&lt;h6/&gt;</code>, <code>&lt;hr/&gt;</code>, <code>&lt;isindex/&gt;</code>, <code>&lt;menu/&gt;</code>, <code>&lt;noframes/&gt;</code>, <code>&lt;noscript&gt;</code>, <code>&lt;ol/&gt;</code>, <code>&lt;p/&gt;</code>, <code>&lt;pre/&gt;</code>, <code>&lt;table/&gt;</code>, <code>&lt;ul/&gt;</code>, <code>&lt;li/&gt;</code></li></ul></li><li><p><strong>å†…è”ï¼ˆinlineï¼‰å…ƒç´ </strong>ï¼š</p><ul><li>åªå æ®å¿…è¦çš„å®½åº¦ï¼Œä¸ä¼šæ¢è¡Œ</li><li>width, height, padding-top, padding-bottom, margin-top, margin-bottom éƒ½ä¸å¯æ”¹å˜</li><li>å†…è”å…ƒç´ ï¼š<code>&lt;a/&gt;</code>, <code>&lt;abbr/&gt;</code>, <code>&lt;acronym/&gt;</code>, <code>&lt;b/&gt;</code>, <code>&lt;bdo/&gt;</code>, <code>&lt;big/&gt;</code>,  <code>&lt;br /&gt;</code>, <code>&lt;cite/&gt;</code>, <code>&lt;code/&gt;</code>, <code>&lt;dfn/&gt;</code>, <code>&lt;em/&gt;</code>, <code>&lt;font/&gt;</code>, <code>&lt;i/&gt;</code>, <code>&lt;img/&gt;</code>, <code>&lt;input/&gt;</code>, <code>&lt;kbd/&gt;</code>, <code>&lt;label/&gt;</code>, <code>&lt;q/&gt;</code>, <code>&lt;s/&gt;</code>, <code>&lt;samp/&gt;</code>, <code>&lt;select/&gt;</code>, <code>&lt;small/&gt;</code>, <code>&lt;span/&gt;</code>, <code>&lt;strike/&gt;</code>, <code>&lt;strong/&gt;</code>, <code>&lt;sub/&gt;</code>, <code>&lt;sup/&gt;</code>, <code>&lt;textarea/&gt;</code>, <code>&lt;tt/&gt;</code>, <code>&lt;u/&gt;</code>, <code>&lt;var/&gt;</code></li></ul></li><li><p>ä¸»è¦ä½¿ç”¨çš„ä¸‰ç§æ ·å¼ï¼š</p><ul><li><code>display:block</code>ï¼šæ˜¾å¼ä¸ºå—å…ƒç´ </li><li><code>display:inline</code>ï¼šæ˜¾ç¤ºä¸ºå†…è”å…ƒç´ </li><li><code>display:inline-block</code>ï¼šæ˜¾ç¤ºä¸ºå†…è”å—å…ƒç´ ï¼Œè¡¨ç°ä¸ºåŒè¡Œæ˜¾ç¤ºï¼ŒåŒæ—¶å¯ä»¥ä¿®æ”¹ width/height/padding/margin ç­‰ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š<br>  <img src="./list.png" alt=""></li></ul></li><li><p>CSS å®šä½ï¼ˆPositionï¼‰ï¼š</p><ul><li>staticï¼šå…ƒç´ é»˜è®¤å®šä½æ–¹å¼ï¼Œä¸å— top/bottom/left/right çš„å½±å“</li><li>relativeï¼šç›¸å¯¹æ­£å¸¸ä½ç½®çš„åç§»ï¼›åŸæœ¬<strong>ç©ºé—´ä¾ç„¶ä¼šè¢«é¢„ç•™</strong>å‡ºæ¥ï¼Œå¯èƒ½ä¼šä¸åˆ«çš„å…ƒç´ é‡å </li><li>fixedï¼šå…ƒç´ çš„ä½ç½®ç›¸å¯¹äºæµè§ˆå™¨çª—å£æ˜¯å›ºå®šçš„ï¼Œä¼šå’Œå…¶å®ƒå…ƒç´ é‡å ï¼›å…ƒç´ çš„ä½ç½®å’Œæ–‡æ¡£æµæ— å…³ï¼Œ<strong>ä¸å æ®ç©ºé—´</strong></li><li>absoluteï¼šç»å¯¹å®šä½çš„å…ƒç´ çš„ä½ç½®æ˜¯ç›¸å¯¹äºæœ€è¿‘çš„å·²å®šä½çˆ¶å…ƒç´ ï¼Œè‹¥å…ƒç´ æ— å·²å®šä½çˆ¶å…ƒç´ ï¼Œåˆ™å®ƒçš„ä½ç½®æ˜¯ç›¸å¯¹äº <html>ï¼›ä¸æ–‡æ¡£æµæ— å…³ï¼Œ<strong>ä¸å æ®ç©ºé—´</strong>ï¼Œä¼šä¸å…¶å®ƒå…ƒç´ é‡å </html></li><li>stickyï¼šç²˜æ€§å®šä½ï¼Œä¸æ»šåŠ¨æœ‰å…³ï¼Œå—é™äºæµè§ˆå™¨</li><li>å¯ä»¥ä½¿ç”¨ <code>overflow</code> æŒ‡å®šå½“å†…å®¹æº¢å‡ºæ—¶çš„è¡Œä¸ºï¼ˆå¯é€‰æ‹©æ˜¯å¦å±•ç¤ºæ»šåŠ¨æ¡ï¼‰ï¼Œä½†å…¶åªå¯ç”¨äºæŒ‡å®šäº†é«˜åº¦çš„å—å…ƒç´ ä¸Š</li></ul></li><li><p>å…ƒç´ çš„æµ®åŠ¨ï¼š</p><ul><li>ä¼šè®©å…ƒç´ å‘å·¦æˆ–å‘å³æµ®åŠ¨ï¼Œå‘¨å›´å…ƒç´ ä¹Ÿä¼šé‡æ–°æ’åˆ—</li><li>å…ƒç´ æ°´å¹³æµ®åŠ¨ï¼Œæ„å‘³ç€åªèƒ½å·¦å³ç§»åŠ¨</li><li>æµ®åŠ¨å…ƒç´ ä¼šå°½é‡å‘å·¦æˆ–å‘å³ç§»åŠ¨ï¼Œç›´åˆ°å®ƒçš„å¤–è¾¹ç¼˜ç¢°åˆ°åŒ…æ‹¬æ¡†æˆ–å¦ä¸€ä¸ªæµ®åŠ¨æ¡†çš„è¾¹ç¼˜ä¸ºæ­¢</li></ul></li><li><p>è®¾ç½®å±…ä¸­ï¼š</p><ul><li>å…ƒç´ å±…ä¸­ï¼šå¯ä»¥é€šè¿‡ <code>margin: auto</code> è§£å†³ï¼Œä½†æ˜¯å¿…é¡»è¦è®¾ç½®å…ƒç´ çš„å®½åº¦</li><li>æ–‡æœ¬å±…ä¸­ï¼šå¯ä½¿ç”¨ <code>text-align</code></li></ul></li><li><p>ç»„åˆé€‰æ‹©å™¨ï¼š</p><ul><li>åä»£é€‰æ‹©å™¨ï¼š<code>div p</code></li><li>å­å…ƒç´ é€‰æ‹©å™¨ï¼š<code>div&gt;p</code></li><li>ç›¸é‚»å…„å¼Ÿé€‰æ‹©å™¨ï¼š<code>div+p</code></li><li>æ™®é€šå…„å¼Ÿé€‰æ‹©å™¨ï¼š<code>div~p</code></li></ul></li><li><p>ä¼ªç±»ï¼ˆpseudo-classesï¼‰ï¼š</p><ul><li>ç”¨äºæ·»åŠ ä¸€äº›é€‰æ‹©å™¨çš„ç‰¹æ®Šæ•ˆæœ</li><li>ä¼ªç±»é€‰æ‹©çš„å…ƒç´ æ˜¯<strong>åŸºäºå½“å‰å…ƒç´ æ‰€å¤„çš„çŠ¶æ€</strong>ï¼Œæˆ–è€…æ˜¯å…ƒç´ æ‰€å…·æœ‰çš„ç‰¹æ€§ï¼Œè€Œéé™æ€æ ‡å¿—ï¼ˆå¦‚ class, id, å±æ€§ï¼‰ã€‚è€ŒçŠ¶æ€æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå…ƒç´ åˆ°è¾¾ä¸€ä¸ªç‰¹å®šçŠ¶æ€çš„æ—¶å€™ï¼Œå¯èƒ½å¾—åˆ°ä¸€ä¸ªä¼ªç±»çš„æ ·å¼ï¼›å½“çŠ¶æ€æ”¹å˜æ—¶ï¼Œå®ƒä¼šå¤±å»è¿™ä¸ªæ ·å¼ã€‚åŸºäºæ–‡æ¡£ä¹‹å¤–çš„æŠ½è±¡ï¼Œæ•…ç§°ä¸ºä¼ªç±»ã€‚</li><li>è¯­æ³•ï¼š<ul><li><code>selector:psedudo-class { property: value }</code></li><li><code>selector.class:pseudo-class { property: value }</code></li></ul></li><li>ä¼ªç±»åç§°ä¸åŒºåˆ†å¤§å°å†™</li><li>ç¤ºä¾‹ï¼š<code>a:hover { color: red }</code></li></ul></li><li><p>ä¼ªå…ƒç´ ï¼ˆpseudo-elementï¼‰ï¼š</p><ul><li>ç”¨äºæ·»åŠ ä¸€äº›é€‰æ‹©å™¨çš„ç‰¹æ®Šæ•ˆæœ</li><li>è¯­æ³•ï¼šç±»ä¼¼ä¼ªç±»</li><li>ä¼ªå…ƒç´ æ˜¯å¯¹å…ƒç´ ä¸­<strong>ç‰¹å®šå†…å®¹</strong>é€‰æ‹©å¹¶æ“ä½œï¼Œæ“ä½œå±‚æ¬¡è¦æ¯”ä¼ªç±»æ›´æ·±ï¼ŒåŠ¨æ€æ€§æ¯”ä¼ªç±»ä½ã€‚è®¾è®¡ä¼ªå…ƒç´ çš„ç›®çš„å°±æ˜¯é€‰å–è¯¸å¦‚ç¬¬ä¸€ä¸ªå­—æ¯ï¼ˆè¡Œï¼‰ç­‰ï¼Œé€‰å–å†…å®¹çš„å‰åå¹¶æ“ä½œç­‰ï¼Œè¿™äº›æ™®é€šçš„é€‰æ‹©å™¨æ˜¯æ— æ³•å®Œæˆçš„ã€‚æœ¬èº«æ˜¯åŸºäºå…ƒç´ çš„æŠ½è±¡ï¼Œä¸å­˜åœ¨äºæ–‡æ¡£ä¸­ï¼Œæ•…ç§°ä¸ºä¼ªå…ƒç´ ã€‚</li></ul></li><li><p>å±æ€§é€‰æ‹©å™¨ï¼š</p><ul><li>è¯­æ³•ï¼š<code>&lt;element&gt;[attr] { }</code> æˆ–è€… <code>&lt;element&gt;[attr&lt;op&gt;value]{ }</code></li><li>é€‰æ‹©èŒƒå›´ï¼š<ul><li><code>=</code>: <code>equal_word</code></li><li><code>*=</code>: ç›¸å½“äº <code>contains</code>ï¼Œå¦‚ <code>&lt;p title=&quot;buyfflowerrr&quot;&gt;&lt;/p&gt;</code></li><li><code>~=</code>:  ç›¸å½“äº <code>contains_word</code>ï¼Œå¦‚ <code>&lt;p title=&quot;buy flower&quot;&gt;&lt;/p&gt;</code> ä¸­çš„ flower</li><li><code>|=</code> : ç›¸å½“äº <code>starts_with_word</code>ï¼Œå½“ç„¶è¿™é‡Œçš„å•è¯åº”æ˜¯å”¯ä¸€çš„ï¼Œæˆ–è€…æ˜¯ç”¨ <code>-</code> åˆ†éš”çš„</li><li><code>^=</code>: ç›¸å½“äº <code>starts_with</code></li><li><code>$=</code>: ç›¸å½“äº <code>ends_with</code></li></ul></li></ul></li></ul><h1 id="CSS-3-ç®€è®°"><a href="#CSS-3-ç®€è®°" class="headerlink" title="CSS 3 ç®€è®°"></a>CSS 3 ç®€è®°</h1><ul><li><p>CSS 3 è¢«æ‹†åˆ†æˆäº†ã€Œæ¨¡å—ã€ï¼Œä¸€äº›é‡è¦çš„æ¨¡å—å¦‚ä¸‹ï¼š</p><ul><li>é€‰æ‹©å™¨</li><li>ç›’æ¨¡å‹</li><li>èƒŒæ™¯å’Œè¾¹æ¡†</li><li>æ–‡å­—ç‰¹æ•ˆ</li><li>2D/3D è½¬æ¢</li><li>åŠ¨æ€</li><li>å¤šåˆ—å¸ƒå±€</li><li>ç”¨æˆ·ç•Œé¢</li></ul></li><li><p>æ¸å˜ï¼ˆGradientsï¼‰ï¼š</p><ul><li><strong>çº¿æ€§æ¸å˜</strong>ï¼ˆLinear Gradientsï¼‰ï¼šå‘ä¸‹/å‘ä¸Š/å‘å·¦/å‘å³/å¯¹è§’çº¿</li><li><strong>å¾„å‘æ¸å˜</strong>ï¼ˆRadius Gradientsï¼‰ï¼šç”±ç›¸åº”çš„ä¸­å¿ƒå®šä¹‰</li><li>è¯­æ³•ï¼š<code>background: linear-gradient (direction, color-stop1, color-stop2, ...)</code></li></ul></li><li><code>box-shadow</code> é¡ºåºï¼š<img src="./box-shadow.png" alt=""></li><li><p>2D è½¬æ¢ï¼š</p><ul><li><code>translate</code>, <code>translateX</code>, <code>translateY</code></li><li><code>rotate</code>, <code>rotateX</code>, <code>rotateY</code></li><li><code>scale</code>, <code>scaleX</code>, <code>scaleY</code></li><li><code>skew</code>, <code>skewX</code>, <code>scaleY</code></li><li><p><code>matrix</code>ï¼š</p><ul><li>æ¥æ”¶å…­ä¸ªå‚æ•°ï¼š<code>a, b, c, d, tx, ty</code></li><li><p>å¯¹ç…§ï¼š</p><ul><li>ä½ç§»ï¼š<code>matrix(1, 0, 0, 1, tx, ty)</code> = <code>translate(tx + &quot;px&quot;, ty + &quot;px&quot;)</code></li><li>ç¼©æ”¾ï¼š<code>matrix(sx, 0, 0, sy, 0, 0)</code> = <code>scale(sx, sy)</code></li><li>æ—‹è½¬ï¼š<code>matrix(cosÎ¸, sinÎ¸, -sinÎ¸, cosÎ¸, 0, 0)</code> = <code>rotate(Î¸ + &quot;deg&quot;)</code></li><li>å€¾æ–œï¼š<code>matrix(1, tan(Î¸y), tan(Î¸x), 1, 0, 0)</code> = <code>skew(Î¸x + &quot;deg&quot;, Î¸y + &quot;deg&quot;)</code></li></ul></li><li><p>è®¡ç®—æ–¹å¼ï¼š<img src="./matrix-calc.png" alt=""></p></li></ul></li></ul></li></ul><ul><li><p>è¿‡æ¸¡æ•ˆæœï¼š<code>transition: property duration timing-function delay</code></p><ul><li>å…¶ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œduration ä¸º 0ï¼Œæ‰€ä»¥å¦‚æœä¸è®¾ç½®è¯¥å€¼ï¼Œå°†çœ‹ä¸åˆ°æ•ˆæœ</li><li>è¿‡æ¸¡åŠ¨ç”»æ—¶é—´æ›²çº¿ï¼š<ul><li>easeï¼šé»˜è®¤å€¼</li><li>linear</li><li>ease-in    </li><li>ease-out</li><li>ease-in-out</li><li>cubic-bezier(n, n, n, n)ï¼šè´å¡å°”æ›²çº¿å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šå€¼æ¥å®ç°ä¸Šè¿°æ•ˆæœï¼ŒåŒæ—¶å¯ä»¥è‡ªå®šä¹‰å…¶å®ƒå€¼å®ç°è‡ªå®šä¹‰æ•ˆæœ</li></ul></li></ul></li><li><p>å…³é”®å¸§åŠ¨ç”»ï¼š</p><ul><li>ä½¿ç”¨ <code>@keyframes</code> åˆ›å»ºåŠ¨ç”»ï¼Œå¯ä»¥ä½¿ç”¨ <code>n%</code> è®¾å®šå¤„äºä¸åŒé˜¶æ®µæ—¶çš„å±æ€§ï¼Œè€Œ <code>from</code> å’Œ <code>to</code> åˆ†åˆ«ä»£è¡¨ <code>0%</code> å’Œ <code>100%</code></li><li>ä½¿ç”¨ <code>animation</code> å±æ€§ç»‘å®šåŠ¨ç”»åˆ°é€‰æ‹©å™¨ä¸Šï¼Œéœ€è¦è®¾å®šä¸¤ä¸ªå€¼ï¼š<ul><li>åŠ¨ç”»åç§°</li><li>åŠ¨ç”»æ—¶é•¿</li></ul></li></ul></li><li><p>Flex å¸ƒå±€ï¼š</p><ul><li>å½“é¡µé¢éœ€è¦é€‚åº”ä¸åŒçš„å±å¹•å¤§å°åŠè®¾å¤‡ç±»å‹æ—¶ï¼Œç¡®ä¿å…ƒç´ æ‹¥æœ‰æ°å½“çš„è¡Œä¸ºå¸ƒå±€æ–¹å¼</li><li>æä¾›ä¸€ç§æ›´åŠ æœ‰æ•ˆçš„æ–¹å¼å¯¹ä¸€ä¸ªå®¹å™¨ä¸­çš„å­å…ƒç´ è¿›è¡Œæ’åˆ—ã€å¯¹é½å’Œåˆ†é…ç©ºé—´</li><li>ç»„æˆï¼š<ul><li>Flex container</li><li>Flex item</li></ul></li><li>å±æ€§è®¾ç½®ï¼š<code>display: flex/inline-flex</code></li><li>è®¾ç½®ä¸»è½´å¯¹é½æ–¹å¼ï¼š<code>justify-content</code></li><li>è®¾ç½®ä¾§è½´å¯¹é½æ–¹å¼ï¼š<code>align-items</code></li><li>è®¾ç½®æ¢è¡Œï¼š<code>flex-wrap</code></li><li>è®¾ç½®å„ä¸ªè¡Œçš„å¯¹é½æ–¹å¼ï¼š<code>align-content</code></li></ul></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://www.runoob.com/css3" target="_blank" rel="noopener">èœé¸Ÿæ•™ç¨‹ï¼šCSS </a></li><li><a href="https://www.cnblogs.com/KeithWang/p/3139517.html" target="_blank" rel="noopener">block, inline-block å¯¹æ¯”</a></li><li><a href="https://dev.opera.com/articles/understanding-the-css-transforms-matrix/" target="_blank" rel="noopener">Understanding the CSS Transforms Matrix</a></li><li><a href="https://www.cnblogs.com/cc156676/p/5784629.html" target="_blank" rel="noopener">CSS 2D è½¬æ¢è¯¦è§£</a></li><li><a href="https://zhuanlan.zhihu.com/p/67988244" target="_blank" rel="noopener">CSS 3 ä¸­ Flex å¼¹æ€§å¸ƒå±€è¯¥å¦‚ä½•çµæ´»è¿ç”¨ï¼Ÿ</a></li><li><a href="https://zhuanlan.zhihu.com/p/25303493" target="_blank" rel="noopener">30 åˆ†é’Ÿå­¦ä¼š Flex å¸ƒå±€</a></li><li><a href="https://www.zhihu.com/question/271492607/answer/364298001" target="_blank" rel="noopener">Flex å¸ƒå±€å¯¹æ€§èƒ½çš„å½±å“ä¸»è¦ä½“ç°åœ¨å“ªæ–¹é¢ï¼Ÿ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ä» 0 åˆ° 1 å®ç°ä¸€ä¸ªç½‘ç«™ï¼Œå‰ç«¯éƒ¨åˆ†è‡ªç„¶æ˜¯è¦äº†è§£ CSS çš„ã€‚CSS çš„å…¨ç§°æ˜¯ Cascading Style Sheetsï¼Œå®ƒæ˜¯ä¸€ç§ä¸“é—¨ç”¨äºç»™ç»“æ„åŒ–æ–‡æ¡£ï¼ˆå¦‚ Web HTMLï¼‰æ·»åŠ æ ·å¼çš„è¯­è¨€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ CSS æ¥ä¸ºç½‘é¡µå¸ƒå±€ï¼Œè®¾å®šå­—ä½“çš„æ ·å¼ï¼Œè®¾å®šåŠ¨ç”»ç­‰ï¼Œè®©æˆ‘ä»¬çš„ç½‘ç«™æ›´åŠ ç‚«é…·ï¼Œæ›´åŠ ç°ä»£åŒ–ã€‚è€Œè¿™äº›é€šè¿‡ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ä¼šéå¸¸ç¹çï¼Œä½¿ç”¨ CSS åªéœ€è¦æŒ‰éœ€å®šä¹‰å³å¯ï¼Œæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ã€‚æœ¬ç¯‡ç¬”è®°ä¸»è¦æ˜¯è®°å½•æ ¸å¿ƒçš„ CSS æŠ€å·§ï¼Œç›¸å…³çš„ç»ƒä¹ ä½äº GitHub &lt;a href=&quot;https://www.github.com/ifaceless/learning-css&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;learning-css ä»“åº“&lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="CSS" scheme="http://ifaceless.space/tags/CSS/"/>
    
      <category term="å¸ƒå±€" scheme="http://ifaceless.space/tags/%E5%B8%83%E5%B1%80/"/>
    
      <category term="æ ·å¼" scheme="http://ifaceless.space/tags/%E6%A0%B7%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Redux ç®€è®°</title>
    <link href="http://ifaceless.space/2019/07/03/react-redux-notes/"/>
    <id>http://ifaceless.space/2019/07/03/react-redux-notes/</id>
    <published>2019-07-03T15:03:18.000Z</published>
    <updated>2019-11-24T09:45:59.965Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æ ¹æ®å®˜ç½‘ä»‹ç»ï¼ŒRedux æ˜¯ä¸€ä¸ª JavaScript çŠ¶æ€ç®¡ç†å®¹å™¨ï¼Œæä¾›äº†å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚å¯ä»¥æ„å»ºä¸€è‡´çš„åº”ç”¨ï¼Œè¿è¡Œäºå¤šç§ç¯å¢ƒä¸‹ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å’ŒåŸç”Ÿåº”ç”¨ç­‰ï¼‰ï¼Œä¸”æ˜“äºæµ‹è¯•ï¼ˆç”šè‡³éƒ½ä¸è¦åœ¨å†™ç•Œé¢ä¹‹å‰è¿›è¡Œæµ‹è¯•ï¼‰ã€‚</p><a id="more"></a><h1 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h1><h2 id="æ ¸å¿ƒæ€æƒ³"><a href="#æ ¸å¿ƒæ€æƒ³" class="headerlink" title="æ ¸å¿ƒæ€æƒ³"></a>æ ¸å¿ƒæ€æƒ³</h2><p>Redux çš„æ ¸å¿ƒå°±æ˜¯ç®¡ç†çŠ¶æ€ï¼Œæ‰€æœ‰çš„çŠ¶æ€æ˜¯åœ¨ store å¯¹è±¡æ ‘ä¸­ç»´æŠ¤ã€‚ä½¿ç”¨ action æ¥æè¿° state å˜åŒ–ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿå°† action å’Œ state ä¸²è”åœ¨ä¸€å—ï¼Œå°±æœ‰äº† reducer å‡½æ•°ï¼Œå®ƒè´Ÿè´£æ ¹æ®ä¸åŒçš„ action dispatch åˆ°ä¸åŒçš„åˆ†æ”¯ï¼Œç„¶åè¿”å›æ–°çš„çŠ¶æ€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œreducer æ˜¯çº¯å‡½æ•°ï¼Œä¸åº”è¯¥ inplace é‚£ç§æ–¹å¼ä¿®æ”¹ stateï¼Œè€Œæ˜¯ç”Ÿæˆæ–°çš„ nextState å¹¶è¿”å›ã€‚<br>é€šå¸¸ä¸€ä¸ªåº”ç”¨ä¸­å¯èƒ½æœ‰å¤šä¸ªå°çš„ reducers ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>combineReducers</code> å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚</p><h2 id="ä¸‰å¤§åŸåˆ™"><a href="#ä¸‰å¤§åŸåˆ™" class="headerlink" title="ä¸‰å¤§åŸåˆ™"></a>ä¸‰å¤§åŸåˆ™</h2><ul><li><strong>å•ä¸€æ•°æ®æº</strong>ï¼šæ•´ä¸ªåº”ç”¨çš„ state æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ª obj tree ä¸­çš„ï¼Œå¹¶ä¸”è¯¥ obj tree åªå­˜åœ¨äºå”¯ä¸€ä¸€ä¸ª store ä¸­</li><li><strong>state æ˜¯åªè¯»çš„</strong>ï¼šå”¯æœ‰è§¦å‘ action æ‰ä¼šæ”¹å˜ stateï¼Œä½¿ç”¨ action æ¥æè¿°å‘ç”Ÿäº†ä»€ä¹ˆ</li><li><strong>ä½¿ç”¨çº¯å‡½æ•°æ‰§è¡Œä¿®æ”¹</strong>ï¼šéœ€è¦ç¼–å†™ reducer å®ç°çŠ¶æ€æ”¹å˜</li></ul><h1 id="ä¸‰é©¾é©¬è½¦"><a href="#ä¸‰é©¾é©¬è½¦" class="headerlink" title="ä¸‰é©¾é©¬è½¦"></a>ä¸‰é©¾é©¬è½¦</h1><h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><ul><li>Action æ˜¯æŠŠæ•°æ®ä»åº”ç”¨ä¼ é€’åˆ° store çš„æœ‰æ•ˆè½½è·ï¼Œæ˜¯ store æ•°æ®çš„å”¯ä¸€æ¥æº</li><li>ä¸€èˆ¬é€šè¿‡ <code>store.dispatch()</code> åˆ†å‘ actionï¼Œä¼ é€’åˆ° store</li><li>å½“åº”ç”¨è§„æ¨¡å˜å¤§æ—¶ï¼Œå»ºè®®å°† Action ä½¿ç”¨å•ç‹¬çš„æ¨¡å—å­˜æ”¾</li><li>å°½é‡å‡å°‘åœ¨ action ä¸­ä¼ é€’çš„æ•°æ®</li><li><strong>Action åˆ›å»ºå‡½æ•°</strong>ï¼šè¿”å› action çš„å‡½æ•°ï¼Œä½¿ç”¨ <code>bindActionCreators()</code> å¯ä»¥è‡ªåŠ¨å°†å¤šä¸ª action åˆ›å»ºå‡½æ•°ç»‘å®šåˆ° <code>dispatch()</code> æ–¹æ³•ä¸Š</li><li>Action åªæ˜¯æè¿°äº†<em>æœ‰äº‹æƒ…å‘ç”Ÿäº†</em>è¿™æ ·çš„äº‹å®ï¼Œä½†ä¸ä¼šæè¿°åº”ç”¨å¦‚ä½•æ›´æ–° state</li></ul><h2 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h2><ul><li>åœ¨ reducer ä¸­å“åº” actionï¼Œå¹¶äº§ç”Ÿæ–°çš„ stateï¼Œè¾¾åˆ°æ”¹å˜ state çš„ç›®çš„</li><li><p>ä¸ºä»€ä¹ˆå« <strong>reducer</strong>ï¼Ÿå‚è€ƒ <code>Array.prototype.reduce(reducer, ?initialValue)</code> é‡Œé¢çš„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½å¿…é¡»æ˜¯çº¯å‡½æ•°ã€‚reducer å‡½æ•°ä¸æ¬¢è¿å¦‚ä¸‹æ“ä½œï¼š</p><ul><li><strong>ä¿®æ”¹ä¼ å…¥å‚æ•°</strong></li><li><strong>æ‰§è¡Œå«æœ‰å‰¯ä½œç”¨çš„æ“ä½œ</strong>ï¼Œå¦‚ API è¯·æ±‚å’Œè·¯ç”±è·³è½¬</li><li><strong>è°ƒç”¨éçº¯å‡½æ•°</strong>ï¼Œå¦‚ <code>Date.now()</code> æˆ– <code>Math.random()</code></li></ul></li><li><p>å¯ä»¥æŠŠæ‰€æœ‰é¡¶çº§ reducer æ”¾åœ¨ç‹¬ç«‹çš„æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>export</code> æš´éœ²æ¯ä¸ª reducer å‡½æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> reducers <span class="keyword">from</span> <span class="string">'./reducers'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoApp = combineReducers(recuders)</span><br></pre></td></tr></table></figure></li></ul><h2 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h2><ul><li><p>Store çš„èŒè´£å¦‚ä¸‹ï¼š</p><ul><li>ç»´æŒåº”ç”¨çš„ state</li><li>æä¾› <code>getState()</code> è¯»å–çŠ¶æ€</li><li>æä¾› <code>dispatch(action)</code> æ–¹æ³•æ›´æ–°çŠ¶æ€<br>-æä¾›  <code>subscribe(listener)</code> æ–¹æ³•æ³¨å†Œç›‘è§†å™¨ï¼Œå…¶è¿”å›çš„å‡½æ•°ç”¨äºæ³¨é”€ç›‘è§†å™¨</li></ul></li><li><p>Redux åº”ç”¨çš„ store åªä¼šæœ‰ä¸€ä¸ªï¼Œä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥æ‹†åˆ†å­çŠ¶æ€åˆ†ç»„ï¼Œå¯ä»¥é€šè¿‡ <code>reducers</code> ç»„åˆå®Œæˆ</p></li><li><code>createStore(reducer, ?initialState)</code>  åˆ›å»ºåº”ç”¨ store</li></ul><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todos</span>(<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Add todo: '</span> + action)</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                ...state,</span><br><span class="line">                todo(<span class="literal">undefined</span>, action)</span><br><span class="line">            ]</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'REMOVE_TODO'</span>:</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Remove todo: '</span> + action)</span><br><span class="line">            <span class="keyword">return</span> state.map(<span class="function">(<span class="params">item</span>) =&gt;</span> todo(item, action))</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Toggle todo: '</span> + action)</span><br><span class="line">            <span class="keyword">return</span> state.map(<span class="function">(<span class="params">item</span>) =&gt;</span> todo(item, action))</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todo</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                id: action.id,</span><br><span class="line">                text: action.text,</span><br><span class="line">                completed: action.completed,</span><br><span class="line">                isDeleted: <span class="literal">false</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'REMOVE_TODO'</span>:</span><br><span class="line">            <span class="keyword">if</span> (state.id !== action.id) &#123;</span><br><span class="line">                <span class="keyword">return</span> state</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                isDeleted: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">            <span class="keyword">if</span> (state.id !== action.id) &#123;</span><br><span class="line">                <span class="keyword">return</span> state</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                completed: !state.completed</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> todoApp = combineReducers(&#123;</span><br><span class="line">    todos</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> store = createStore(todoApp)</span><br><span class="line"><span class="keyword">let</span> nextTodoId = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TodoItem</span>(<span class="params">&#123; todo &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">            &lt;label</span><br><span class="line">                style=&#123;&#123; <span class="attr">textDecoration</span>: todo.completed ? <span class="string">'line-through'</span> : <span class="string">'none'</span> &#125;&#125;</span><br><span class="line">                onClick=&#123;() =&gt; store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, <span class="attr">id</span>: todo.id &#125;)&#125;</span><br><span class="line">            &gt;</span><br><span class="line">                &#123;todo.text&#125;</span><br><span class="line">            &lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">            &lt;button</span></span><br><span class="line"><span class="regexp">                style=&#123;&#123; marginLeft: 10 &#125;&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; &#123; store.dispatch(&#123; type: 'REMOVE_TODO', id: todo.id &#125;) &#125;&#125;</span></span><br><span class="line"><span class="regexp">            &gt;ç§»é™¤&lt;/</span>button&gt;</span><br><span class="line">        &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">function TodoApp(&#123; todos = [] &#125;) &#123;</span></span><br><span class="line"><span class="regexp">    const todoItems = todos</span></span><br><span class="line"><span class="regexp">        .filter((todo) =&gt; !todo.isDeleted)</span></span><br><span class="line"><span class="regexp">        .map((todo) =&gt; &lt;TodoItem key=&#123;todo.id&#125; todo=&#123;todo&#125; /</span>&gt;)</span><br><span class="line">    <span class="keyword">const</span> input = useRef()</span><br><span class="line">    <span class="keyword">const</span> handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> text = input.current.value</span><br><span class="line">        <span class="keyword">if</span> (!text) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">id</span>: nextTodoId++, <span class="attr">text</span>: input.current.value &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;input ref=&#123;input&#125; /&gt;</span><br><span class="line">            &lt;button onClick=&#123;handleClick&#125; style=&#123;&#123; <span class="attr">marginLeft</span>: <span class="number">10</span> &#125;&#125;&gt;æ·»åŠ &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">            &lt;ul&gt;</span></span><br><span class="line"><span class="regexp">                &#123;todoItems&#125;</span></span><br><span class="line"><span class="regexp">            &lt;/u</span>l&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">const render = () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const state = store.getState()</span></span><br><span class="line"><span class="regexp">    ReactDOM.render(</span></span><br><span class="line"><span class="regexp">        &lt;TodoApp</span></span><br><span class="line"><span class="regexp">            todos=&#123;state.todos&#125;</span></span><br><span class="line"><span class="regexp">        /</span>&gt;,</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(store.getState())</span><br><span class="line">    render()</span><br><span class="line">&#125;)</span><br><span class="line">render()</span><br></pre></td></tr></table></figure><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>æŒ‰ç…§ Redux æä¾›çš„å‡ ä¸ªå®˜æ–¹ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹å‡ºç¼–å†™ä¸€ä¸ªç®€å•çš„ Todo åº”ç”¨å…¶å®è¦è€ƒè™‘çš„è¿˜æ˜¯æŒºå¤šçš„ï¼Œå°¤å…¶æ˜¯éœ€è¦åœ¨åˆ†æ•£çš„æ¨¡å—ä¸­åˆ†åˆ«å®šä¹‰ actions, reducers, containers, dumb components ç­‰ï¼Œç„¶åæ­é… react-redux æ¥å®ç°æ•´ä½“åŠŸèƒ½ã€‚<br>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»å…¸çš„  React Redux åº”ç”¨çš„ç¤ºä¾‹çš„æ–‡ä»¶ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">    actions/</span><br><span class="line">    components/</span><br><span class="line">    consts/</span><br><span class="line">    containers/</span><br><span class="line">    reducers/</span><br><span class="line">    sotore.js</span><br><span class="line">    index.js</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥ï¼Œåˆ†å±‚ç»“æ„å¾ˆæ˜æ™°ã€‚ä½†è¿™é‡Œæœ‰å‡ ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼š</p><ol><li>components å’Œ containers å¯èƒ½ä¼šå‡ºç°ç›¸äº’å¼•ç”¨çš„é—®é¢˜ï¼›</li><li>å¯¹äºæŸäº›æƒ…å½¢ï¼Œä¸¥æ ¼åŒºåˆ† smart components å’Œ dumb components æ¯”è¾ƒæ­»æ¿ï¼›</li><li>ç¼–å†™èµ·æ¥å¾ˆå¤æ‚ã€å•°å—¦ã€å†—ä½™ã€‚</li></ol><p>é’ˆå¯¹è¿™ä¸ªç—›ç‚¹ï¼Œå¯ä»¥å€ŸåŠ© <a href="https://github.com/rematch/rematch" target="_blank" rel="noopener">rematch</a> æ¡†æ¶è§£å†³ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäº Redux å°è£…çš„æ¡†æ¶ï¼Œç›®çš„æ˜¯æä¾›æœ€ä½³çš„ Redux å®è·µï¼Œå‡å°‘å¤§é‡çš„æ ·æ¿ä»£ç ç¼–å†™ï¼Œè§£æ”¾ç”Ÿäº§åŠ›ï¼</p><p>ä½¿ç”¨ Rematch æ—¶ï¼Œæœ‰ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µå«åš <code>model</code>ã€‚ä½ å¯ä»¥åœ¨ <code>models</code> é‡Œé¢å°†<strong>çŠ¶æ€</strong>ã€å¼•èµ·çŠ¶æ€å˜åŒ–<strong>reducers</strong> åŠå¼‚æ­¥ actions å’Œ action creators æ”¶æ•›åˆ°ä¸€èµ·ï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œæµ‹è¯•ã€‚æ€»çš„æ¥è¯´ï¼Œ<code>model</code> å®šä¹‰åŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><strong>state</strong>: åˆå§‹çŠ¶æ€æ˜¯ä»€ä¹ˆ</li><li><strong>reducers</strong>: å¦‚ä½•æ”¹å˜çŠ¶æ€</li><li><strong>effects</strong>: å¤„ç†å¼‚æ­¥çš„ actionsï¼Œå¸¦æœ‰å‰¯ä½œç”¨çš„æ“ä½œ</li></ul><p>ä¸€ä¸ªå…¸å‹çš„ model å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> count = &#123;</span><br><span class="line">  state: <span class="number">0</span>, <span class="comment">// initial state</span></span><br><span class="line">  reducers: &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨åŒæ­¥å‡½æ•°ï¼Œå¤„ç†çŠ¶æ€å˜æ›´</span></span><br><span class="line">    increment(state, payload) &#123;</span><br><span class="line">      <span class="keyword">return</span> state + payload</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  effects: <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨çº¯å‡½æ•°å¤„ç†çŠ¶æ€å˜æ›´ï¼ˆå¼‚æ­¥ actionsï¼‰</span></span><br><span class="line">    <span class="keyword">async</span> incrementAsync(payload, rootState) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, <span class="number">1000</span>))</span><br><span class="line">      dispatch.count.increment(payload)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº† models åï¼Œå°±å¯ä»¥åˆ›å»º Redux storeï¼Œå¹¶ä½¿ç”¨ <code>dispatch</code> æ¥è§¦å‘ reducers å’Œ effects è°ƒç”¨ï¼ˆæ— éœ€æ‰‹åŠ¨ç¼–å†™ action creators å•¦~ï¼‰ã€‚å½“ç„¶ï¼Œåœ¨å±•ç¤ºå±‚ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ç»“åˆ react-redux æ¥ä½¿ç”¨ã€‚å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹ï¼Œæ›´è¯¦ç»†çš„æ–‡æ¡£å¯ä»¥å‚è€ƒ <a href="https://github.com/rematch/rematch/tree/master/docs" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://redux.js.org/" target="_blank" rel="noopener">Redux å®˜ç½‘æ–‡æ¡£</a></li><li><a href="https://cn.redux.js.org/" target="_blank" rel="noopener">Redux ä¸­æ–‡è¯‘æ–‡</a></li><li><a href="https://egghead.io/lessons/react-redux-the-single-immutable-state-tree" target="_blank" rel="noopener">Redux å…¥é—¨è§†é¢‘æ•™ç¨‹</a></li><li><a href="https://egghead.io/series/building-react-applications-with-idiomatic-redux" target="_blank" rel="noopener">ä»¥åœ°é“çš„æ–¹å¼ä½¿ç”¨ Redux æ„å»º React åº”ç”¨</a></li><li><a href="https://www.fullstackreact.com/articles/redux-with-mark-erikson/" target="_blank" rel="noopener">Redux and Why itâ€™s Good For You</a></li><li><a href="https://daveceddia.com/what-does-redux-do/" target="_blank" rel="noopener">What Does Redux Do</a></li><li><a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0" target="_blank" rel="noopener">Presentational and Container Components</a>ï¼Œ<em>ä½œè€…å…¶å®å·²ç»ä¸æ¨èè¿™ç§å†™æ³•äº†</em></li><li><a href="https://react-redux.js.org/introduction/quick-start" target="_blank" rel="noopener">React Redux å®˜æ–¹æ–‡æ¡£</a></li></ul><h1 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h1><ul><li><a href="https://css-tricks.com/react-router-4/" target="_blank" rel="noopener">All About React Router 4</a></li><li><a href="https://css-tricks.com/learning-react-redux/" target="_blank" rel="noopener">Learning React Redux</a></li><li><a href="https://css-tricks.com/learning-react-container-components/" target="_blank" rel="noopener">Leveling Up With React: Container Components</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æ ¹æ®å®˜ç½‘ä»‹ç»ï¼ŒRedux æ˜¯ä¸€ä¸ª JavaScript çŠ¶æ€ç®¡ç†å®¹å™¨ï¼Œæä¾›äº†å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚å¯ä»¥æ„å»ºä¸€è‡´çš„åº”ç”¨ï¼Œè¿è¡Œäºå¤šç§ç¯å¢ƒä¸‹ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å’ŒåŸç”Ÿåº”ç”¨ç­‰ï¼‰ï¼Œä¸”æ˜“äºæµ‹è¯•ï¼ˆç”šè‡³éƒ½ä¸è¦åœ¨å†™ç•Œé¢ä¹‹å‰è¿›è¡Œæµ‹è¯•ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="JavaScript" scheme="http://ifaceless.space/tags/JavaScript/"/>
    
      <category term="React" scheme="http://ifaceless.space/tags/React/"/>
    
      <category term="Redux" scheme="http://ifaceless.space/tags/Redux/"/>
    
  </entry>
  
  <entry>
    <title>React æ ¸å¿ƒæ¦‚å¿µ</title>
    <link href="http://ifaceless.space/2019/07/02/react-core-concepts/"/>
    <id>http://ifaceless.space/2019/07/02/react-core-concepts/</id>
    <published>2019-07-02T11:44:22.000Z</published>
    <updated>2019-11-24T09:45:59.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>React æ˜¯ä¸€ä¸ªç”¨äºæ„å»º UI çš„ JavaScript åº“ï¼Œå®ƒæœ‰<strong>å£°æ˜å¼</strong>ã€<strong>ç»„ä»¶åŒ–</strong>çš„ç‰¹ç‚¹ã€‚ä½¿ç”¨ JSX çš„è¯­æ³•å¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™å„ç§ç»„ä»¶ï¼Œè€ŒåŸºäºå„ç§ç»„ä»¶åˆå¯ä»¥æ„é€ å‡ºæ›´åŠ å¤æ‚çš„å‰ç«¯é¡µé¢ã€‚</p><a id="more"></a><h1 id="åŸºç¡€ç¯‡"><a href="#åŸºç¡€ç¯‡" class="headerlink" title="åŸºç¡€ç¯‡"></a>åŸºç¡€ç¯‡</h1><h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><ul><li>JSX å¯ä»¥å¾ˆå¥½åœ°æè¿° UIï¼š<code>const element = &lt;h1&gt;Hello, world&lt;/h1&gt;</code></li><li>React ä¸­è®¤ä¸ºæ¸²æŸ“é€»è¾‘æœ¬è´¨ä¸Šå’Œ UI é€»è¾‘å¤©ç„¶è€¦åˆï¼Œå¹¶æ²¡æœ‰è®¤ä¸ºåœ°å°†<strong>æ ‡è®°ä¸é€»è¾‘</strong>åˆ†ç±»åˆ°ä¸åŒæ–‡ä»¶ï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾åœ¨<strong>ç»„ä»¶</strong>è¿™ç§æ¾æ•£è€¦åˆå•å…ƒä¸­ï¼Œå®ç°<strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong></li><li>JSX æœ¬èº«ä¹Ÿæ˜¯è¡¨è¾¾å¼ï¼Œå¯ä»¥åœ¨ <code>{}</code> ä¸­ä½¿ç”¨ä»»æ„ JavaScript çš„åŠŸèƒ½ã€‚åœ¨è¿›è¡Œç¼–è¯‘åï¼ŒJSX ä¼šè¢«è½¬æ¢æˆæ™®é€šçš„ JavaScript å‡½æ•°è°ƒç”¨ï¼Œå¹¶å¯¹å…¶å–å€¼åå¾—åˆ° JavaScript å¯¹è±¡</li><li>JSX å¯ä»¥é˜²æ­¢æ³¨å…¥æ”»å‡»ï¼ŒReactDOM åœ¨æ¸²æŸ“æ‰€æœ‰è¾“å…¥å†…å®¹å‰ï¼Œé»˜è®¤ä¼šè¿›è¡Œè½¬ä¹‰</li></ul><h2 id="å…ƒç´ æ¸²æŸ“"><a href="#å…ƒç´ æ¸²æŸ“" class="headerlink" title="å…ƒç´ æ¸²æŸ“"></a>å…ƒç´ æ¸²æŸ“</h2><ul><li>ä¸çœŸå®çš„æµè§ˆå™¨ DOM å…ƒç´ ç›¸æ¯”ï¼ŒReact å…ƒç´ æ˜¯éå¸¸è½»é‡çº§ä¸”åˆ›å»ºå¼€é”€å¾ˆå°çš„æ™®é€šå¯¹è±¡ï¼ŒReactDOM è´Ÿè´£æ›´æ–° DOM ä¿æŒä¸ React å…ƒç´ ä¸€è‡´</li><li>æ¸²æŸ“å…ƒç´ ï¼š<code>ReactDOM.render(element, container)</code></li><li>ReactDOM ä¼šå°†å…ƒç´ åŠå…¶å­å…ƒç´ ä¸ä¹‹å‰çš„çŠ¶æ€å¯¹æ¯”ï¼Œåªè¿›è¡Œå¿…è¦çš„æ›´æ–°ä¿è¯ DOM è¾¾åˆ°é¢„æœŸçŠ¶æ€</li></ul><h2 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h2><ul><li><p>ç»„ä»¶çš„å®šä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°ç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Welcome</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    reuturn &lt;h1&gt;Welcome&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ åŸºäº ES6 class å®šä¹‰çš„ç»„ä»¶</span></span><br><span class="line"><span class="regexp">class Welcome2 extends Component &#123;</span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        return &lt;h1&gt;Welcome&lt;/</span>h1&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„å±æ€§ï¼ˆpropsï¼‰å’ŒçŠ¶æ€ï¼ˆstateï¼‰</p></li><li>ç»„ä»¶çš„ <code>props</code> æ˜¯åªè¯»çš„ã€‚<strong>React ç»„ä»¶å¿…é¡»è¦åƒçº¯å‡½æ•°ä¸€æ ·ä¿æŠ¤å®ƒä»¬çš„ props ä¸è¢«ä¿®æ”¹</strong></li></ul><h3 id="çŠ¶æ€-state"><a href="#çŠ¶æ€-state" class="headerlink" title="çŠ¶æ€ state"></a>çŠ¶æ€ state</h3><ul><li>ç»„ä»¶çš„ <code>state</code> æ˜¯ç»„ä»¶ç§æœ‰çš„ï¼Œä¸”å®Œå…¨å—æ§äºå½“å‰ç»„ä»¶</li><li>é™¤äº†åœ¨æ„é€ å‡½æ•°ä¸­å¯ä»¥ç›´æ¥ç»™ <code>this.state</code> èµ‹å€¼å¤–ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹ <code>state</code>ï¼Œå¦åˆ™ä¸ä¼šæ¸²æŸ“ç»„ä»¶ï¼Œè¦ä½¿ç”¨ <code>setState()</code> æ›´æ–°çŠ¶æ€</li><li><p><code>this.props</code> å’Œ <code>this.state</code> å¯èƒ½æ˜¯å¼‚æ­¥æ›´æ–°ï¼Œä¸è¦ä¾èµ–å®ƒä»¬çš„å€¼è¿›è¡Œä¸‹ä¸€ä¸ªçŠ¶æ€æ›´æ–°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯çš„åšæ³•ï¼Œè¿™ç§å¯èƒ½æ— æ³•å¾—åˆ°é¢„æœŸç»“æœ</span></span><br><span class="line"><span class="keyword">this</span>.setState(&#123;</span><br><span class="line">    counter: <span class="keyword">this</span>.state.counter + <span class="keyword">this</span>.props.incr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®çš„åšæ³•ï¼Œä½¿ç”¨ä¸€ä¸ªç®­å¤´å‡½æ•°</span></span><br><span class="line"><span class="keyword">this</span>.setState(<span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">    counter: state.counter + props.incr</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure></li><li><p>ä¸ç®¡æ˜¯çˆ¶ç»„ä»¶è¿˜æ˜¯å­ç»„ä»¶éƒ½æ— æ³•çŸ¥é“æŸä¸ªç»„ä»¶æœ‰æ— çŠ¶æ€ï¼Œä¸”ä¹Ÿä¸ä¼šå…³å¿ƒæ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ class ç»„ä»¶ã€‚<strong>æ•°æ®æµåŠ¨æ˜¯å•å‘å‘ä¸‹çš„</strong>ï¼Œä»æŸä¸ªç»„ä»¶ <code>state</code> äº§ç”Ÿçš„ä»»ä½•æ•°æ®æˆ– UI åªä¼šå½±å“æ ‘ä¸­<strong>ä½äº</strong>å®ƒä»¬çš„ç»„ä»¶</p></li></ul><h2 id="äº‹ä»¶å¤„ç†"><a href="#äº‹ä»¶å¤„ç†" class="headerlink" title="äº‹ä»¶å¤„ç†"></a>äº‹ä»¶å¤„ç†</h2><ul><li>React äº‹ä»¶å‘½åæ˜¯ camelCase é£æ ¼ï¼Œè€Œéåƒ HTML DOM ä¸­çº¯å°å†™çš„é£æ ¼</li><li>å¦‚æœæƒ³è¦é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Œå¿…é¡»æ˜¾å¼ä½¿ç”¨ <code>e.preventDefault()</code>ï¼›è¿™é‡Œçš„ <code>e</code> æ˜¯ React æ ¹æ® W3C è§„èŒƒå®šä¹‰çš„åˆæˆäº‹ä»¶ï¼Œæ— éœ€æ‹…å¿ƒè·¨æµè§ˆå™¨å…¼å®¹é—®é¢˜</li><li>React ä¸­è‡ªå®šä¹‰çš„æ–¹æ³•é»˜è®¤ä¸ä¼šç»‘å®š <code>this</code>ï¼Œæ‰€ä»¥æœ‰å¤šç§æ–¹å¼å¯ä»¥è¿›è¡Œç»‘å®šï¼š<ul><li><strong>å¸¸è§„</strong>ï¼šåœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ <code>this.handleChange = this.handleChange.bind(this)</code></li><li><strong>æ¨è</strong>ï¼šä½¿ç”¨ <code>public class fields</code> è¯­æ³•ï¼š<code>handleChange = () =&gt; {}</code></li><li>åœ¨è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ç®­å¤´å‡½æ•°æˆ–è€… <code>bind</code> ç»‘å®šï¼ˆæ³¨æ„ï¼Œè¿™ç§å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œæ¯æ¬¡éƒ½ä¼šåˆ›å»ºå‡½æ•°ï¼Œå¦‚æœæ˜¯ä¼ é€’ç»™å­ç»„ä»¶çš„ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´å­ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼‰</li></ul></li></ul><h2 id="åˆ—è¡¨-amp-Key"><a href="#åˆ—è¡¨-amp-Key" class="headerlink" title="åˆ—è¡¨ &amp; Key"></a>åˆ—è¡¨ &amp; Key</h2><ul><li>åœ¨åˆ—è¡¨å…ƒç´ æˆ–è€…ç»„ä»¶ä¸­ï¼Œå¿…é¡»è¦æŒ‡å®š Keyã€‚è€Œå¦‚æœæ²¡æœ‰è®¾å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨ç´¢å¼•ã€‚ä½†æ˜¯ä½¿ç”¨ç´¢å¼•å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜å’ŒçŠ¶æ€é—®é¢˜</li><li>Key å¹¶ä¸éœ€è¦å…¨å±€å”¯ä¸€ï¼Œåªæ˜¯åœ¨ç›¸é‚»èŠ‚ç‚¹ä¹‹é—´éœ€è¦ä¿æŒå”¯ä¸€å³å¯</li><li>Key ä¼šè¢«ä¼ é€’ç»™ Reactï¼Œä½†ä¸ä¼šä¼ é€’ç»™ç»„ä»¶</li></ul><h2 id="è¡¨å•"><a href="#è¡¨å•" class="headerlink" title="è¡¨å•"></a>è¡¨å•</h2><ul><li><strong>å—æ§ç»„ä»¶</strong>ï¼šæŠŠ HTML è¡¨å•å…ƒç´ å’Œ React state ç»“åˆèµ·æ¥ï¼Œè®©æ¸²æŸ“è¡¨å•çš„ React ç»„ä»¶è¿˜æ§åˆ¶ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­è¡¨å•å‘ç”Ÿçš„äº‹æƒ…</li><li>åœ¨å—æ§ç»„ä»¶ä¸ŠæŒ‡å®š value çš„ prop å¯ä»¥é˜²æ­¢ç”¨æˆ·æ›´æ”¹è¾“å…¥</li></ul><h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><ul><li>é€šå¸¸ï¼Œå¦‚æœå¤šä¸ªç»„ä»¶åæ˜ ç›¸åŒçš„æ•°æ®å˜æ›´ï¼Œå¯ä»¥å°†çŠ¶æ€æå‡åˆ°æœ€è¿‘çš„å…¬å…±çˆ¶ç»„ä»¶</li><li>ç»„åˆä¼˜äºç»§æ‰¿</li><li>æœ‰äº›ç»„ä»¶æ— æ³•æå‰çŸ¥æ™“å®ƒä»¬å­ç»„ä»¶çš„å…·ä½“å†…å®¹ï¼Œå¯ä»¥é€šè¿‡ <code>props.children</code> è·å–å­ç»„ä»¶æ¸²æŸ“</li></ul><h1 id="é«˜çº§ç¯‡"><a href="#é«˜çº§ç¯‡" class="headerlink" title="é«˜çº§ç¯‡"></a>é«˜çº§ç¯‡</h1><h2 id="Contextï¼ˆæ­¤-Context-æœ‰ç‚¹ç‰¹æ®Šï¼‰"><a href="#Contextï¼ˆæ­¤-Context-æœ‰ç‚¹ç‰¹æ®Šï¼‰" class="headerlink" title="Contextï¼ˆæ­¤ Context æœ‰ç‚¹ç‰¹æ®Šï¼‰"></a>Contextï¼ˆæ­¤ Context æœ‰ç‚¹ç‰¹æ®Šï¼‰</h2><ul><li>è™½ç„¶å¯ä»¥é€šè¿‡ <code>props</code> å°†å±æ€§ä»çˆ¶ç»„ä»¶ä¸€çº§çº§ä¼ é€’åˆ°å­ç»„ä»¶æ ‘ï¼Œä½†è¿™æ ·æ¯•ç«Ÿæ¯”è¾ƒç¹çã€‚è€Œæœ‰äº›æ¯”è¾ƒå…¨å±€çš„é…ç½®ï¼ˆå¦‚ä¸»é¢˜ã€åœ°åŒºç­‰ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>Context</code> è¿›è¡Œå…±äº«ï¼Œæ–¹ä¾¿ç»„ä»¶æ ‘è®¿é—®è¿™äº›å…¨å±€é…ç½®</li><li>åˆ›å»º <code>contextï¼š</code>const ThemeContext = React.createContext(â€˜lightâ€™)`</li><li><p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> ThemeContext = React.createContext(<span class="string">'light'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æŒ‡å®šè¦è¯»å–çš„ Context ç±»å‹</span></span><br><span class="line">  <span class="comment">// React ä¼šè‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘çš„ theme provider</span></span><br><span class="line">  <span class="comment">// ç„¶åä½¿ç”¨å®ƒçš„å€¼</span></span><br><span class="line">  <span class="keyword">static</span> contextType = ThemeContext</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// ä½¿ç”¨ `this.context` å¯ä»¥è·å–å€¼</span></span><br><span class="line">      &lt;button className=<span class="string">"Button"</span>&gt;&#123;<span class="keyword">this</span>.props.text&#125; + &#123;<span class="keyword">this</span>.context&#125;&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">function ToolBar(props) &#123;</span></span><br><span class="line"><span class="regexp">  return &lt;Button text=&#123;props.text&#125;&gt;&lt;/</span>Button&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ Provider æŒ‡å®š ctx value</span></span><br><span class="line">    &lt;ThemeContext.Provider value=<span class="string">"yellow"</span>&gt;</span><br><span class="line">      &lt;ToolBar text=<span class="string">"å·¥å…·æŒ‰é’®"</span>&gt;&lt;/ToolBar&gt;</span><br><span class="line">    &lt;<span class="regexp">/ThemeContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure></li><li><p>Context ä½¿ç”¨ä¼šå¯¼è‡´ç»„ä»¶çš„å¤ç”¨æ€§å˜å·®ï¼Œä¼šä¾èµ– Contextã€‚<strong>å¦‚æœåªæ˜¯æƒ³è¦é¿å…å±‚å±‚ä¼ é€’å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ç»„ä»¶ç»„åˆçš„æ–¹å¼</strong></p><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3></li><li><p><code>createContext</code>: <code>const myCtx = React.createContext(defaultValue)</code></p><ul><li>å¯¹äºè®¢é˜…äº†ä¸Šè¿° ctx çš„å­ç»„ä»¶ï¼Œä¼šè‡ªåŠ¨åœ¨ç¦»è‡ªå·±æœ€è¿‘çš„åŒ¹é… Provider å¤„è·å–è®¾ç½®çš„å€¼</li><li>å¦‚æœæœªèƒ½æ‰¾åˆ° Providerï¼Œåˆ™ä½¿ç”¨ defaultValue</li></ul></li><li><p><code>Provider</code></p><ul><li>å…è®¸æ¶ˆè´¹ç»„ä»¶è®¢é˜… context çš„å˜åŒ–</li><li>å¯ä»¥ä¼ é€’ value ç»™æ¶ˆè´¹ç»„ä»¶ï¼Œå¯ä»¥åµŒå¥—</li><li>Provider value å˜åŒ–æ—¶ï¼Œå†…éƒ¨æ¶ˆè´¹ç»„ä»¶ä¹Ÿä¼šé‡æ–°æ¸²æŸ“</li><li>Provider åŠæ¶ˆè´¹ç»„ä»¶ä¸å— <code>shouldComponentUpdate</code> å‡½æ•°é™åˆ¶</li></ul></li><li><p><code>contextType</code></p><ul><li>æŒ‚è½½åœ¨ <code>class</code> å¯¹è±¡ä¸Šï¼ŒæŒ‡å‘åˆ›å»ºçš„ Context å¯¹è±¡</li><li>å¯ä»¥åœ¨ä»»æ„ç”Ÿå‘½å‘¨æœŸé€šè¿‡ <code>this.context</code> è®¿é—®åˆ°æœ€è¿‘ Context çš„å€¼</li></ul></li><li><p><code>Consumer</code>ï¼šè®¢é˜… context å˜æ›´</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;MyContext.Consumer&gt;</span><br><span class="line">    &#123;value =&gt; <span class="comment">/* do stuff */</span>&#125;</span><br><span class="line">&lt;<span class="regexp">/MyContext.Consumer&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>Context ä½¿ç”¨äº† reference identity æ¥å†³å®šä½•æ—¶è¿›è¡Œæ¸²æŸ“ï¼Œä½†ä¹Ÿå­˜åœ¨é™·é˜±ã€‚å½“ Provider çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ¶ˆè´¹ç»„ä»¶æ„å¤–è¢«æ¸²æŸ“</p></li></ul><h2 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h2><ul><li>å¸¸è§æ¨¡å¼æ˜¯ä¸€ä¸ªç»„ä»¶è¦è¿”å›å¤šä¸ªå…ƒç´ ï¼Œä½¿ç”¨ <code>Fragment</code> å¯ä»¥å°†å­åˆ—è¡¨åˆ†ç»„ï¼Œä¸”æ— éœ€å‘ DOM æ·»åŠ é¢å¤–èŠ‚ç‚¹<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Column</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;td&gt;hello <span class="number">1</span>&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">      &lt;td&gt;hello 2&lt;/</span>td&gt;</span><br><span class="line">      &lt;td&gt;hello <span class="number">3</span>&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Row</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt;</span><br><span class="line">      &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt;</span><br><span class="line">      &lt;tr&gt;&lt;Column&gt;&lt;/Column&gt;&lt;/tr&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Table(props) &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;table&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Row&gt;&lt;/</span>Row&gt;</span><br><span class="line">    &lt;<span class="regexp">/table&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="é«˜é˜¶ç»„ä»¶ï¼ˆHigh-Order-Component-HOCï¼‰"><a href="#é«˜é˜¶ç»„ä»¶ï¼ˆHigh-Order-Component-HOCï¼‰" class="headerlink" title="é«˜é˜¶ç»„ä»¶ï¼ˆHigh Order Component, HOCï¼‰"></a>é«˜é˜¶ç»„ä»¶ï¼ˆHigh Order Component, HOCï¼‰</h2><ul><li>HOC æ˜¯ React ä¸­åŸºäºç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ï¼Œæ˜¯ä¸€ç§å¤ç”¨ç»„ä»¶é€»è¾‘çš„æŠ€å·§</li><li>HOC çš„å‚æ•°æ˜¯ç»„ä»¶ï¼Œè¿”å›å€¼æ˜¯æ–°ç»„ä»¶çš„å‡½æ•°ï¼š<code>const NewComponent = hoc(WrappedComponent)</code></li><li>é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæ›¿ä»£ Mixin æ¨¡å¼ï¼›çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨</li><li><p><strong>çº¦å®š</strong>ï¼šHOC åº”è¯¥é€ä¼ ä¸è‡ªèº«æ— å…³çš„ propsï¼Œä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„æ–¹å¼ç¼–å†™ <code>render</code>ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logProps</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;level, ...props&#125; = <span class="keyword">this</span>.props</span><br><span class="line">      <span class="built_in">console</span>.log(level)</span><br><span class="line">      <span class="built_in">console</span>.log(props)</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;WrappedComponent level=&#123;level&#125; &#123;...props&#125;&gt;&lt;/WrappedComponent&gt;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>çº¦å®š</strong>ï¼šæœ€å¤§åŒ–å¯ç»„åˆæ€§</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compose è¾¾åˆ°çš„æ•ˆæœå°±æ˜¯ï¼šwithRouter(connect(componentSelector)(WrappedComponent)))</span></span><br><span class="line"><span class="keyword">const</span> enhance = compose(</span><br><span class="line">    <span class="comment">// å•çº¯çš„ HOC</span></span><br><span class="line">    withRouter,</span><br><span class="line">    connect(componentSelector)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> EnhancedComponent = enhance(WrappedComponent)</span><br></pre></td></tr></table></figure></li><li><p><strong>çº¦å®š</strong>ï¼šè¿”å›æ¸…æ™°çš„åç§°ï¼Œä¾¿äºè°ƒè¯•ã€‚å‘½åä¹ æƒ¯ï¼šHOCName(wrappedComponentName)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logProps</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">WithLogComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;WrappedComponent &#123;...props&#125;&gt;&lt;/WrappedComponent&gt;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  WithLogComponent.displayName = <span class="string">`WithLogComponent(<span class="subst">$&#123;getDisplayName(WrappedComponent)&#125;</span>)`</span></span><br><span class="line">  <span class="keyword">return</span> WithLogComponent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDisplayName</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> c.displayName || c.name || <span class="string">'Component'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>ä¸è¦åœ¨ <code>render()</code> ä¸­ä½¿ç”¨ HOCï¼Œé¿å… React æ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼ˆä¸æ˜¯æ›´æ–°å­æ ‘ï¼Œè€Œæ˜¯å¸è½½æ—§å­æ ‘ï¼ŒæŒ‚è½½æ–°å­æ ‘ï¼Œä¸”å¯¼è‡´ç»„ä»¶çŠ¶æ€ä¹Ÿä¼šä¸¢å¤±ï¼‰ã€‚å¦‚æœçš„ç¡®éœ€è¦åŠ¨æ€è°ƒç”¨ HOCï¼Œå¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æˆ–æ„é€ å‡½æ•°ä¸­è¿›è¡Œ</li><li>é™æ€æ–¹æ³•éœ€è¦æ˜¾å¼æ‹·è´ï¼Œå¯ä»¥ä½¿ç”¨ <code>hoistNonReactStatic</code> å‡½æ•°æ‹·è´æ‰€æœ‰é React é™æ€æ–¹æ³•</li><li>Ref ä¸ä¼šè¢«ä¼ é€’</li></ul></li></ul><h2 id="PropTypes"><a href="#PropTypes" class="headerlink" title="PropTypes"></a>PropTypes</h2><ul><li>å¯¹ç»„ä»¶ props ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œé…ç½® <code>propTypes</code> å±æ€§å³å¯</li><li>è€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ç”Ÿæ•ˆ</li><li>å¯ä»¥é…ç½® <code>defaultProps</code> è®¾å®šé»˜è®¤å€¼</li></ul><h2 id="ç”Ÿå‘½å‘¨æœŸå›¾è°±"><a href="#ç”Ÿå‘½å‘¨æœŸå›¾è°±" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸå›¾è°±"></a>ç”Ÿå‘½å‘¨æœŸå›¾è°±</h2><p><img src="./react-lifecycle.png" alt="react-lifecycle"></p><h1 id="åˆæˆäº‹ä»¶ï¼ˆSynthetic-Eventï¼‰"><a href="#åˆæˆäº‹ä»¶ï¼ˆSynthetic-Eventï¼‰" class="headerlink" title="åˆæˆäº‹ä»¶ï¼ˆSynthetic Eventï¼‰"></a>åˆæˆäº‹ä»¶ï¼ˆSynthetic Eventï¼‰</h1><ul><li><code>SyntheticEvent</code> å®ä¾‹æ˜¯ä¼ é€’ç»™äº‹ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ï¼Œå®ƒæ˜¯å¯¹æµè§ˆå™¨äº‹ä»¶çš„åŒ…è£…ï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼ŒåŒæ—¶æä¾›äº†æ¥è¿‘åŸç”Ÿäº‹ä»¶çš„æ¥å£ã€‚å½“ç„¶ï¼Œä¹Ÿæä¾›äº† <code>.nativeEvent</code> ä¾›ä½ è·å–åº•å±‚äº‹ä»¶</li><li><p>é‡è¦çš„å±æ€§å’Œæ–¹æ³•ï¼š</p><ul><li><code>boolean bubbles</code></li><li><code>boolean cancelable</code></li><li><code>DOMEventTarget currentTarget</code></li><li><code>boolean defaultPrevented</code></li><li><code>number eventPhase</code></li><li><code>boolean isTrusted</code></li><li><code>DOMEvent nativeEvent</code></li><li><code>void preventDefault()</code></li><li><code>boolean isDefaultPrevented()</code></li><li><code>void stopPropagation()</code></li><li><code>boolean isPropagationStopped()</code></li><li><code>DOMEventTarget target</code></li><li><code>number timeStamp</code></li><li><code>string type</code></li></ul></li><li><p><code>SyntheticEvent</code> åœ¨å®Œæˆäº‹ä»¶å›è°ƒåï¼Œå…¶å±æ€§ä¼šæ— æ•ˆï¼Œæ— æ³•å¼‚æ­¥è®¿é—®è¯¥äº‹ä»¶</p></li></ul><h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><ul><li>Hook æ˜¯ React 16.8 ä»¥åæ–°å¢çš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸ç¼–å†™ <code>class</code> ç»„ä»¶çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>state</code>, <code>props</code> ç­‰ React ç‰¹æ€§</li><li>Why Hook:<ul><li>åŸæœ‰çš„å†™æ³•ä¸­ï¼Œç»„ä»¶ä¹‹é—´çŠ¶æ€é€»è¾‘å¤ç”¨å¾ˆå›°éš¾ã€‚<strong>Hook å¯ä»¥æå–çŠ¶æ€é€»è¾‘ï¼Œå•ç‹¬æµ‹è¯•å’Œå¤ç”¨ï¼Œå¹¶ä¸”æ— éœ€ä¿®æ”¹åŸæœ‰ç»„ä»¶çš„ç»“æ„</strong></li><li>å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£ã€‚<strong>Hook ä¼šå°†ç»„ä»¶ä¸­ç›¸äº’å…³è”çš„éƒ¨åˆ†æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°ï¼Œä¸ä¼šå¼ºåˆ¶æŒ‰ç…§ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†</strong></li><li>éš¾ä»¥ç†è§£çš„ classã€‚<strong>Hook å¯ä»¥åœ¨é class çš„æƒ…å†µä¸‹ä½¿ç”¨æ›´å¤šçš„ React ç‰¹æ€§</strong></li></ul></li><li>Hook å¯ä»¥ç†è§£ä¸ºåœ¨å‡½æ•°ç»„ä»¶ä¸­ã€Œé’©å…¥ã€React State ä»¥åŠç”Ÿå‘½å‘¨æœŸç­‰ç‰¹æ€§çš„å‡½æ•°ï¼Œå¹¶ä¸”ä¸èƒ½å† class ç»„ä»¶ä¸­ä½¿ç”¨</li><li>ä½¿ç”¨è§„åˆ™ï¼š<ul><li>åªèƒ½åœ¨å‡½æ•°æœ€å¤–å±‚è°ƒç”¨ Hookï¼Œä¸è¦åœ¨<strong>å¾ªç¯ã€æ¡ä»¶æˆ–åµŒå¥—å‡½æ•°</strong>ä¸­è°ƒç”¨ Hook</li><li>åªèƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨ Hook</li></ul></li><li>åŸå…ˆæˆ‘ä»¬åœ¨ç¼–å†™å‡½æ•°ç»„ä»¶æ—¶ï¼Œå¦‚æœéœ€è¦ç»™å…¶å¼•å…¥çŠ¶æ€ï¼Œæˆ–è€…æ·»åŠ ç”Ÿå‘½å‘¨æœŸçš„é’©å­ï¼Œéœ€è¦è½¬æ¢æˆ class ç»„ä»¶ã€‚ä½†æœ‰äº† Hook ç‰¹æ€§åï¼Œå¯ä»¥ä½¿ç”¨ <code>useState</code> å’Œ <code>useEffect</code> æ¥ä»£æ›¿äº†ã€‚æ–°çš„å†™æ³•å°†ä¼šæ›´åŠ ç®€æ´ï¼Œæ˜“äºæŠ½è±¡å¤ç”¨å’Œæµ‹è¯•</li></ul><h2 id="State-Hook"><a href="#State-Hook" class="headerlink" title="State Hook"></a>State Hook</h2><ul><li>ä½¿ç”¨ <code>useState</code> Hook å¯ä»¥åœ¨å‡½æ•°ç»„ä»¶ä¸­æ·»åŠ å†…éƒ¨ stateï¼ŒReact åœ¨é‡å¤æ¸²æŸ“æ—¶ä¿ç•™è¯¥ state</li><li><code>useState</code> è¿”å›çš„æ›´æ–° state çš„å‡½æ•°å’Œ <code>this.setState</code> è¡Œä¸ºæœ‰åŒºåˆ«ï¼Œ<strong>å‰è€…ä¸ä¼šæŠŠæ–°æ—§ state åˆå¹¶ï¼Œè€Œåè€…ä¼š</strong></li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;button onClick=&#123;() =&gt; setCount(count + <span class="number">1</span>)&#125;&gt;ç‚¹æˆ‘&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">            &lt;p&gt;ç‚¹å‡»è®¡æ•°ï¼š&#123;count&#125;&lt;/</span>p&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Event-Hook"><a href="#Event-Hook" class="headerlink" title="Event Hook"></a>Event Hook</h2><ul><li>ä½¿ç”¨ <code>useEffect</code> Hook ç»™å‡½æ•°ç»„ä»¶æ·»åŠ æ“ä½œå‰¯ä½œç”¨çš„èƒ½åŠ›ã€‚ç›¸å½“äº class ç»„ä»¶ä¸­ <code>componentDidMount</code>, <code>componentDidUpdate</code> å’Œ <code>componentWillUnmount</code> çš„åˆä½“ï¼Œå°†å‰¯ä½œç”¨æ“ä½œéƒ½èšé›†åˆ°è¯¥ Hook ä¸­</li><li>è°ƒç”¨ <code>useEffect</code> æ—¶ï¼Œå°±è¡¨æ˜è®© React åœ¨å¯¹ DOM å®Œæˆæ›´æ”¹åè°ƒç”¨ç›¸åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼›åŒæ—¶å¯ä»¥è¿”å›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºåœ¨æ¸…é™¤æ—¶æ‰§è¡Œä¸€äº›æ“ä½œã€‚React ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶æ‰§è¡Œæ¸…é™¤æ“ä½œ</li><li><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [userInfo, setUserInfo] = useState(&#123; <span class="attr">username</span>: <span class="string">'æ¸¸å®¢'</span>, <span class="attr">clickCount</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        alert(<span class="string">"å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š"</span> + userInfo.username)</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"é”€æ¯ç»„ä»¶ï¼Œé‡æ–°æ¸²æŸ“"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;button onClick=&#123;() =&gt; setUserInfo(&#123; <span class="attr">username</span>: <span class="string">'iFaceless'</span>, <span class="attr">clickCount</span>: userInfo.clickCount &#125;)&#125;&gt;è®¾ç½®ç”¨æˆ·&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">            &lt;button onClick=&#123;() =&gt; setUserInfo(&#123; clickCount: userInfo.clickCount + 1, username: userInfo.username &#125;)&#125;&gt;ç‚¹å‡»è®¡æ•°&lt;/</span>button&gt;</span><br><span class="line">            &lt;p&gt;ä½ å¥½ï¼Œ&#123;userInfo.username&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">            &lt;p&gt;ç‚¹å‡»è®¡æ•° &#123;userInfo.clickCount&#125;&lt;/</span>p&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒuseEffect ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œï¼ˆå½“ç„¶å¯ä»¥æ§åˆ¶ï¼‰ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€ŒæŒ‚è½½ã€å’Œã€Œæ›´æ–°ã€è¿™ç§æ¦‚å¿µ</p></li><li>ä¸ <code>componentDidMount</code> å’Œ <code>componentDidUpdate</code> ä¸åŒçš„æ˜¯ï¼Œ<code>uesEffect</code> è°ƒåº¦çš„ effect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•ï¼Œä»è€Œè·å¾—æ›´å¥½çš„å“åº”é€Ÿåº¦ã€‚å¦‚æœéœ€è¦åŒæ­¥æ‰§è¡Œï¼Œåˆ™ä½¿ç”¨ <code>useLayoutEffect</code> Hook</li></ul><h2 id="è‡ªå®šä¹‰-Hook"><a href="#è‡ªå®šä¹‰-Hook" class="headerlink" title="è‡ªå®šä¹‰ Hook"></a>è‡ªå®šä¹‰ Hook</h2><ul><li>è‡ªå®šä¹‰ Hook éœ€è¦ä»¥ <code>use</code> å¼€å¤´ï¼Œè¿™æ˜¯çº¦å®šï¼Œå¯ä»¥è®© React è‡ªåŠ¨æ£€æŸ¥ Hook æ˜¯å¦è¿åç›¸å…³è§„åˆ™</li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://react.docschina.org/docs" target="_blank" rel="noopener">React å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://medium.com/@robinpokorny/index-as-a-key-is-an-anti-pattern-e0349aece318" target="_blank" rel="noopener">Index as a key is an anti-pattern</a></li><li><a href="https://jaredpalmer.com/formik/" target="_blank" rel="noopener">Formik</a></li><li><a href="http://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener">ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå›¾è°±</a></li><li><a href="https://www.robinwieruch.de/react-hooks-fetch-data/" target="_blank" rel="noopener">How to fetch data with React Hooks?</a></li><li><a href="https://www.robinwieruch.de/react-fetching-data/" target="_blank" rel="noopener">How to fetch data in React</a></li><li><a href="https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889" target="_blank" rel="noopener">Making Sense of React Hooks</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;React æ˜¯ä¸€ä¸ªç”¨äºæ„å»º UI çš„ JavaScript åº“ï¼Œå®ƒæœ‰&lt;strong&gt;å£°æ˜å¼&lt;/strong&gt;ã€&lt;strong&gt;ç»„ä»¶åŒ–&lt;/strong&gt;çš„ç‰¹ç‚¹ã€‚ä½¿ç”¨ JSX çš„è¯­æ³•å¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™å„ç§ç»„ä»¶ï¼Œè€ŒåŸºäºå„ç§ç»„ä»¶åˆå¯ä»¥æ„é€ å‡ºæ›´åŠ å¤æ‚çš„å‰ç«¯é¡µé¢ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="JavaScript" scheme="http://ifaceless.space/tags/JavaScript/"/>
    
      <category term="å‰ç«¯æ¡†æ¶" scheme="http://ifaceless.space/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
      <category term="React" scheme="http://ifaceless.space/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript ES6 å­¦ä¹ ç¬”è®°</title>
    <link href="http://ifaceless.space/2019/06/23/javascript-es6-learning-note/"/>
    <id>http://ifaceless.space/2019/06/23/javascript-es6-learning-note/</id>
    <published>2019-06-23T10:02:35.000Z</published>
    <updated>2019-11-24T09:45:59.950Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>2015 å¹´ï¼ŒECMAScript ç¬¬å…­ç‰ˆå¾—ä»¥å‘å¸ƒï¼Œè¿™å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ES6 æ ‡å‡†ï¼Œæ ‡å¿—ç€ JavaScript è¯­è¨€è¿æ¥æ–°çºªå…ƒã€‚ES6 å¼•å…¥äº†ä¸€äº›æ–°çš„è¯­æ³•ç³–ï¼ŒåŒæ—¶å¼¥è¡¥äº†ä¸€äº›åœ¨ ES5 ä¸­å­˜åœ¨çš„ä¸€äº›ç¼ºé™·ã€‚</p><p>æœ¬ç¯‡ç¬”è®°æ˜¯åœ¨å­¦ä¹ é˜®ä¸€å³°è€å¸ˆçš„ã€ŠES6 å…¥é—¨æ•™ç¨‹ã€‹ä¸­åšçš„ç¬”è®°ï¼Œä¸»è¦æ˜¯è®°å½•ä¸€äº›è‡ªå·±ä¸å¤ªç†Ÿæ‚‰çš„æˆ–è€…å’Œ ES5 å·®å¼‚å¾ˆå¤§çš„ç‰¹æ€§ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å’Œåˆ«çš„è¯­è¨€ï¼ˆå¦‚ Pythonï¼‰è¿›è¡Œå¯¹æ¯”ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°åœ¨æŸäº›è®¾è®¡æ€æƒ³ä¸Šï¼Œè¿™äº›è¯­è¨€ä¹Ÿæ˜¯ç›¸é€šçš„ã€‚</p><a id="more"></a><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><ul><li>ES5 å…¶å®æ˜¯ ES3 çš„å‡çº§ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ ES3.1</li><li>ES4 å…¶å®å¹¶æ²¡æœ‰å‘å¸ƒï¼Œä½†æ˜¯å¢åŠ çš„ä¸€äº›åŠŸèƒ½åœ¨ ES6 ä¸­å‘å¸ƒäº†</li><li>æ¯å¹´ 6 æœˆå‘å¸ƒæ–°çš„æ ‡å‡†ï¼ŒES6 æ³›æŒ‡ä¸‹ä¸€ä»£ JavaScript æ ‡å‡†</li><li>Babel è½¬ç å™¨ï¼šå°† ES6 ä»£ç è½¬æ¢æˆ ES5 ä»£ç </li><li>Google çš„ <code>Traceur</code> è½¬ç å™¨ä¹Ÿå¯ä»¥å°† ES6 ä»£ç è½¬ä¸º ES5 ä»£ç </li></ul><h1 id="æ‚è®°"><a href="#æ‚è®°" class="headerlink" title="æ‚è®°"></a>æ‚è®°</h1><ul><li>æš‚æ—¶æ€§æ­»åŒºæœ¬è´¨ï¼šåªè¦ä¸€è¿›å…¥å½“å‰ä½œç”¨åŸŸï¼Œæ‰€éœ€è¦ä½¿ç”¨çš„å˜é‡å°±å·²ç»å­˜åœ¨ï¼Œä½†æ˜¯ä¸å¯è·å–ï¼Œåªæœ‰ç­‰åˆ°å£°æ˜å˜é‡çš„é‚£ä¸€è¡Œä»£ç å‡ºç°ï¼Œæ‰å¯ä»¥è·å–å’Œä½¿ç”¨è¯¥å˜é‡</li><li>å—ä½œç”¨åŸŸå¯ä»¥ä»»æ„åµŒå¥—</li><li>å—ä½œç”¨åŸŸå†…å¯ä»¥å£°æ˜å‡½æ•°ï¼Œä½†æ˜¯åªèƒ½åœ¨è¯¥ä½œç”¨åŸŸä¸‹ä½¿ç”¨</li><li>æµè§ˆå™¨ä¸ºäº†å…¼å®¹å†å²ä»£ç ï¼Œåœ¨å—ä½œç”¨åŸŸä¸­å£°æ˜çš„å‡½æ•°ä¼šæå‡åˆ°å…¨å±€ï¼Œç±»ä¼¼ <code>var</code> å£°æ˜çš„å˜é‡äº†</li><li><p>ES6 æ”¯æŒ 6 ä¸­å£°æ˜å…³é”®å­—ï¼š</p><ul><li><code>var</code></li><li><code>function</code></li><li><code>let</code></li><li><code>const</code></li><li><code>import</code></li><li><code>class</code></li></ul></li><li><p><code>var</code>, <code>function</code> å‘½ä»¤å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä¾ç„¶æ˜¯é¡¶å±‚å¯¹è±¡çš„å±æ€§ï¼›<code>let</code>, <code>const</code>, <code>class</code> å£°æ˜çš„å…¨å±€å˜é‡ï¼Œåˆ™ä¸å†å±äºé¡¶å±‚å¯¹è±¡çš„å±æ€§ã€‚äºŒè€…éœ€è¦è„±é’©</p></li><li>JavaScript ä¸­çš„é¡¶å±‚å¯¹è±¡åœ¨å„ä¸ªç¯å¢ƒä¸‹éƒ½æ˜¯éœ€è¦å­˜åœ¨çš„ï¼Œä½†æ˜¯åœ¨ Node å’Œæµè§ˆå™¨ç¯å¢ƒä¸­ç”¨ä¸€å¥—ä»£ç æƒ³è¦æ‹¿åˆ°é¡¶å±‚å¯¹è±¡è¿˜æ˜¯æœ‰äº›è´¹åŠ²çš„ã€‚å¯è¡Œçš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span></span><br><span class="line">   ? <span class="built_in">window</span></span><br><span class="line">   : (<span class="keyword">typeof</span> process === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> <span class="built_in">require</span> === <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> global === <span class="string">'object'</span>)</span><br><span class="line">     ? global</span><br><span class="line">     : <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getGlobal = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> self !== <span class="string">'undefined'</span>) &#123; <span class="keyword">return</span> self; &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span>) &#123; <span class="keyword">return</span> <span class="built_in">window</span>; &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> global !== <span class="string">'undefined'</span>) &#123; <span class="keyword">return</span> global; &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'unable to locate global object'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h2 id="è§£æ„"><a href="#è§£æ„" class="headerlink" title="è§£æ„"></a>è§£æ„</h2><ul><li><p>è§£æ„ï¼ˆç±»ä¼¼ Python ä¸­çš„ç”¨æ³•ï¼Œæˆ–è€… Rust ä¸­çš„æ¨¡å¼åŒ¹é…ï¼‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [a, b, c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// c å°†æ¥æ”¶å‰©ä½™çš„æ•°ç»„å…ƒç´ </span></span><br><span class="line">[a, b, ...c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">[, , c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="comment">// ä¸å®Œå…¨è§£æ„ä¹Ÿæ˜¯æ”¯æŒçš„</span></span><br><span class="line">[a, b] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å³å€¼å¿…é¡»è¦æ˜¯å¯è¿­ä»£çš„ï¼Œå³å®ç°äº† Iterator æ¥å£ï¼Œå¦åˆ™ä¼šå‡ºé”™</span></span><br><span class="line">[a, b] = <span class="literal">NaN</span> <span class="comment">// TypeError: undefined is not a function</span></span><br></pre></td></tr></table></figure></li><li><p>å¯è®¾ç½®é»˜è®¤å€¼ï¼š<code>let [foo = true] = [];</code>ï¼Œåªæœ‰æ•°ç»„æˆå‘˜ä¸¥æ ¼ç­‰äº <code>undefined</code> æ‰ä¼šè®©é»˜è®¤å€¼ç”Ÿæ•ˆ</p></li><li>è§£æ„å¤±è´¥ï¼Œå˜é‡å€¼ä¸º <code>undefined</code></li><li><p>å¯¹è±¡ä¹Ÿå¯ä»¥è§£æ„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o = &#123;<span class="attr">name</span>: <span class="string">"chris"</span>, <span class="attr">age</span>: <span class="number">26</span>&#125;</span><br><span class="line"><span class="keyword">let</span> &#123; name, age &#125; = o</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥å°†å¯¹è±¡èµ‹å€¼ç»™æŸä¸ªå·²æœ‰çš„å˜é‡</span></span><br><span class="line"><span class="keyword">const</span> &#123; log &#125; = <span class="built_in">console</span></span><br><span class="line">log(<span class="string">'hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥æœ‰åˆ«åï¼Œname æ˜¯æ¨¡å¼ï¼Œn æ‰æ˜¯è¢«èµ‹å€¼çš„å˜é‡</span></span><br><span class="line">(&#123;<span class="attr">name</span>: n, <span class="attr">age</span>: a&#125; = o)</span><br></pre></td></tr></table></figure></li><li><p>å¯¹è±¡è§£æ„çš„æœ¬è´¨æ˜¯ï¼Œå…ˆæ‰¾åˆ°åŒåå±æ€§ï¼Œå†èµ‹å€¼ç»™å¯¹åº”çš„å˜é‡</p></li><li>è§£æ„èµ‹å€¼çš„åŸåˆ™æ˜¯ï¼Œåªè¦å³å€¼ä¸æ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œéƒ½è¦å…ˆè½¬ä¸ºå¯¹è±¡ï¼ˆå¦‚æ•°å­—ä¼šè½¬æˆ Numberï¼‰ï¼›è€Œ <code>undefined</code> å’Œ <code>null</code> æ— æ³•è½¬æ¢ä¸ºå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™</li><li><strong>å‡½æ•°çš„å‚æ•°ä¹Ÿæ”¯æŒè§£æ„èµ‹å€¼</strong></li></ul><h2 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h2><ul><li><code>&quot;\u{xxxx}&quot;</code> å¯ä»¥è¡¨ç¤ºè¶…è¿‡ä¸¤ä¸ªå­—èŠ‚çš„ Unicode å­—ç¬¦</li><li><code>for (let c of &#39;foo&#39;)</code> å¯ä»¥ç›´æ¥éå†å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å¯ä»¥è¯†åˆ«å¤§äº <code>0xFFFF</code> çš„ç ç‚¹</li><li><p><code>String.raw</code> è¿”å›è½¬ä¹‰å­—ç¬¦ä¸²ï¼š</p></li><li><p><code>String.includes()</code> æ˜¯å¦å­˜åœ¨å­ä¸²</p></li><li><code>String.startsWith()</code> + <code>String.endsWith()</code></li><li><code>String.repeat()</code></li></ul><h2 id="æ•°å€¼"><a href="#æ•°å€¼" class="headerlink" title="æ•°å€¼"></a>æ•°å€¼</h2><ul><li><p>å¤šç§è¿›åˆ¶å†™æ³•ï¼š</p><ul><li>äºŒè¿›åˆ¶ï¼š<code>0b010101</code></li><li>å…«è¿›åˆ¶ï¼š<code>0o123</code></li><li>åå…­è¿›åˆ¶ï¼š<code>0x1234</code></li></ul></li><li><p>å°†å­—ç¬¦ä¸²çš„å¤šç§è¿›åˆ¶è½¬æ¢æˆåè¿›åˆ¶ï¼š<code>Number(target)</code></p></li><li>æ–°å¢äº† <code>Number.isFinite</code> å’Œ <code>Number.isNaN</code> æ–¹æ³•ï¼Œä½†è¿™ä¸¤ç§æ–¹æ³•åªå¯¹æ•°å€¼æœ‰æ•ˆï¼Œå…¶å®ƒä¸€å¾‹ä¸º falseã€‚æ³¨æ„ä¹Ÿæœ‰ä¸€å¯¹å…¨å±€çš„å‡½æ•° <code>isFinite</code> å’Œ <code>isNaN</code>ï¼Œå®ƒä»¬åˆ™ä¼šå°è¯•å…ˆå°†è¾“å…¥çš„å‚æ•°è½¬æ¢ä¸º Number åå†è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ˜¯æœ€é‡è¦çš„åŒºåˆ«</li><li>ES6 å°† <code>parseInt</code> å’Œ <code>parseFloat</code> æŒªåˆ° <code>Number</code> ä¸Šäº†ï¼Œè¿™æ ·ä¼šæ›´åŠ ç»Ÿä¸€</li><li><code>Number.EPSILON</code> æµ®ç‚¹æ•°è®¡ç®—ä¼šæœ‰ç²¾åº¦æŸå¤±ï¼Œè¿™ä¸ªæå°å€¼å¯ä»¥ç”¨æ¥æŒ‡å®šè¯¯å·®èŒƒå›´</li><li>æŒ‡æ•°è¿ç®—ç¬¦ <code>**</code>ï¼Œé‡‡ç”¨çš„æ˜¯å³ç»“åˆçš„æ¨¡å¼</li><li>V8 å¼•æ“ä¸­ï¼ŒæŒ‡æ•°è¿ç®—ç¬¦å’Œ <code>Math.pow</code> ç®—æ³•å®ç°æ˜¯ä¸åŒçš„ï¼Œå¯¹äºç‰¹åˆ«å¤§çš„ç»“æœï¼ŒäºŒè€…ä¼šæœ‰ç»†å¾®å·®åˆ«</li></ul><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><ul><li>é»˜è®¤å‚æ•°ï¼š<ul><li><code>function say(word = &#39;hi&#39;) { console.log(word) }</code></li><li>åŒä¸€ä½œç”¨åŸŸä¸­ï¼Œä¸èƒ½å‡ºç°åŒåå‡½æ•°çš„å£°æ˜</li><li>é»˜è®¤å‚æ•°æ˜¯<strong>æƒ°æ€§è®¡ç®—</strong>ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°è®¡ç®—ï¼Œè¿™ç‚¹å’Œ Python éå¸¸ä¸åŒï¼ï¼</li></ul></li></ul><ul><li>å‡½æ•°å‚æ•°æ”¯æŒè§£æ„ï¼Œä¸”æ”¯æŒé»˜è®¤å€¼</li><li>æŒ‡å®šäº†å‚æ•°é»˜è®¤å€¼åï¼Œå‡½æ•°çš„ <code>length</code> å±æ€§åªä¼šè¿”å›æœªè®¾ç½®é»˜è®¤å€¼çš„å‚æ•°ä¸ªæ•°</li><li>å¦‚æœè®¾ç½®äº†å‚æ•°ï¼Œä¸”ä¸æ˜¯å°¾å‚æ•°ï¼Œåˆ™å…¶ä¹‹åçš„å‚æ•°éƒ½ä¸ç®—åˆ° <code>length</code> äº†ï¼š<code>(function (a = 0, b, c) {}).length // 0</code></li><li><p>å‡½æ•°å¦‚æœè®¾ç½®äº†é»˜è®¤å€¼ï¼Œåˆ™åœ¨åˆå§‹åŒ–æ—¶ä¼šå½¢æˆä¸€ä¸ªç‰¹æ®Šçš„ä½œç”¨åŸŸï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> x = <span class="number">100</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„å‚æ•° `x` å’Œ `y` å¤„äºä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œæ•… `y` çš„é»˜è®¤å€¼å°±æ˜¯æŒ‡å‘å‚æ•° `x`</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x, y = x</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x, y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(<span class="number">200</span>) <span class="comment">//200, 200</span></span><br></pre></td></tr></table></figure></li><li><p>ES6 è§„å®šï¼Œåªè¦å‡½æ•°ä½¿ç”¨äº†é»˜è®¤å€¼ã€è§£æ„å’Œæ‰©å±•è¿ç®—ç¬¦ï¼Œå°±ä¸èƒ½åœ¨å†…éƒ¨æ˜¾å¼æŒ‡å®šä¸º<strong>ä¸¥æ ¼æ¨¡å¼</strong></p></li><li>ç®­å¤´å‡½æ•°ï¼ˆæ›´ç®€æ´çš„åŒ¿åå‡½æ•°å†™æ³•ï¼‰ï¼š<ul><li>å¦‚æœç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦å°†å¯¹è±¡ç”¨åœ†æ‹¬å·åŒ…å›´ï¼Œå¦åˆ™ä¼šè¢«è§£é‡Šä¸ºä»£ç å—ï¼š<code>let getObj = id =&gt; ({ id: id })</code></li><li><strong>å‡½æ•°ä½“å†…çš„ <code>this</code> æ˜¯å®šä¹‰æ—¶æ‰€åœ¨çš„å¯¹è±¡ï¼Œè€Œéä½¿ç”¨æ—¶æ‰€åœ¨çš„å¯¹è±¡</strong>ï¼Œä¹Ÿå°±æ˜¯åœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œ<code>this</code> æ˜¯å›ºå®šçš„ã€‚æœ¬è´¨ä¸Šæ˜¯å› ä¸ºåœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œæ ¹æœ¬å°±æ²¡æœ‰ <code>this</code>ï¼Œå®ƒæŒ‡å‘çš„æ˜¯å¤–å±‚çš„ <code>this</code></li></ul></li></ul><pre><code>- ä¸å¯ä»¥ä½œä¸ºæ„é€ å‡½æ•°ï¼Œä¸èƒ½å¯¹å®ƒä½¿ç”¨ `new` å‘½ä»¤- æ²¡æœ‰ `arguments` å¯¹è±¡- ä¸èƒ½ä½¿ç”¨ `yield`ï¼Œä¸å¯ä»¥ä½œä¸º `Generator`</code></pre><ul><li><p>å°¾è°ƒç”¨ï¼š</p><ul><li>å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯å‡½æ•°çš„æœ€åä¸€æ­¥æ“ä½œï¼ˆä¸ä¸€å®šæ˜¯æœ€åä¸€è¡Œï¼Œé€»è¾‘ä¸Šæ˜¯æœ€åä¸€æ­¥ï¼‰æ˜¯<strong>ç›´æ¥è°ƒç”¨</strong>å¦ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›å…¶ç»“æœï¼š<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> bar(x) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹ä¸ç¬¦åˆ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">let</span> y = bar(x); <span class="keyword">return</span> y &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123; bar(x) &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> bar(x) + <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>å°¾è°ƒç”¨ä¼˜åŒ–ï¼šåªä¿ç•™å†…å±‚å‡½æ•°çš„è°ƒç”¨å¸§ï¼ŒèŠ‚çº¦å†…å­˜</p></li><li>ES6 ä¸­åªè¦ä½¿ç”¨äº†å°¾é€’å½’ï¼Œå°±ä¸ä¼šå‡ºç°è°ƒç”¨æ ˆæº¢å‡ºï¼Œå› ä¸ºåªéœ€è¦ç»´æŠ¤ä¸€ä¸ªè°ƒç”¨å¸§å³å¯ã€‚ä½†å…¶å®è¿™ä¸ªä¼˜åŒ–åªæœ‰åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹æ‰ä¼šå¯ç”¨ã€‚æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œéœ€è¦é€šè¿‡å˜é‡ <code>arguments</code>, <code>func.caller</code> æ¥è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨æ ˆ</li></ul><h2 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h2><ul><li>æ•°ç»„å¤åˆ¶ï¼š<code>const a2 = [...a1]</code> æˆ–è€… <code>const [...a2] = a1</code></li><li>å¯ä»¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„ï¼š<code>const a = [...&#39;hello&#39;]</code></li><li>æ‰©å±•è¿ç®—ç¬¦ <code>...</code> å¯ä»¥å°†ä»»ä½•å®ç°äº† <code>Iterator</code> æ¥å£çš„å¯¹è±¡è½¬æ¢æˆæ•°ç»„</li><li><code>Array.from</code> å¯ä»¥æ¥å—ä»»æ„å®ç°äº† <code>Iterator</code> æ¥å£çš„å¯¹è±¡ï¼Œè½¬æ¢æˆæ•°ç»„ï¼›ä¹Ÿæ”¯æŒ array-like å¯¹è±¡</li><li><code>Array.of</code> å°†ä¸€ç»„å€¼è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¼¥è¡¥ <code>Array</code> æ„é€ å‡½æ•°åœ¨å‚æ•°ä¸ªæ•°ä¸åŒæ—¶ï¼Œè¡Œä¸ºä¹Ÿä¸åŒçš„æ¯›ç—…ã€‚å®Œå…¨å¯ä»¥æ›¿ä»£ <code>Array()</code> æˆ–è€… <code>new Array()</code></li><li><p>æä¾›äº†å‡ ä¸ªéå†çš„æ¥å£ï¼š</p><ul><li><code>keys()</code> å®é™…å°±æ˜¯ç´¢å¼•</li><li><code>values()</code> å€¼</li><li><code>entries()</code> é”®å€¼</li></ul></li><li><p><code>includes()</code> åˆ¤æ–­æ˜¯å¦åŒ…å«å…ƒç´ </p></li><li><code>flat</code> ç”¨äºå°†åµŒå¥—æ•°ç»„å±•å¼€ï¼Œæ‹‰å¹³ï¼Œé»˜è®¤åªå±•å¼€ä¸€å±‚ï¼Œå¯æŒ‡å®šå¤šå±‚æˆ–è€… <code>Infinity</code></li><li><code>flatMap</code> å’Œ <code>flat</code> ç±»ä¼¼ï¼Œä½†æ˜¯ä¼šå¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œä½†å®ƒåªèƒ½å±•å¼€ä¸€å±‚</li></ul><h2 id="å¯¹è±¡"><a href="#å¯¹è±¡" class="headerlink" title="å¯¹è±¡"></a>å¯¹è±¡</h2><ul><li><p>å±æ€§æˆ–è€…æ–¹æ³•éƒ½å¯ä»¥ç®€å†™å•¦ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [x, y] = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="keyword">const</span> a = &#123;x, y&#125;</span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line"><span class="keyword">const</span> a = &#123;<span class="attr">x</span>: x, <span class="attr">y</span>: y&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•çš„ç®€å†™</span></span><br><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">    doSomething() &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="comment">// å¸¸è§„å†™æ³•</span></span><br><span class="line">    doSomething: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å…è®¸ä½¿ç”¨è¡¨è¾¾å¼ä½œä¸ºå¯¹è±¡çš„å±æ€§åï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> propKey = <span class="string">'foo'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    [properKey]: <span class="literal">true</span>,</span><br><span class="line">    [<span class="string">'a'</span> + <span class="string">'bc'</span>]: <span class="number">123</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ES6 ä¸­å±æ€§éå†çš„æ–¹æ³•ï¼š</p><ul><li><code>for...in</code>ï¼šéå†å¯¹è±¡è‡ªèº«å’Œç»§æ‰¿çš„<strong>å¯æšä¸¾å±æ€§</strong>ï¼ˆä¸å« Symbol å±æ€§ï¼‰</li><li><code>Object.keys(obj)</code>ï¼šå¯¹è±¡è‡ªèº«<strong>å¯æšä¸¾å±æ€§</strong>ï¼ˆä¸å« Symbol å±æ€§ï¼‰</li><li><code>Object.getOwnPropertyNames(obj)</code>ï¼šå¯¹è±¡è‡ªèº«çš„<strong>æ‰€æœ‰å±æ€§</strong>çš„é”®åï¼ˆä¸å« Symbol å±æ€§ï¼‰</li><li><code>Object.getOwnPropertySymbols(obj)</code>ï¼šå¯¹è±¡è‡ªèº«æ‰€æœ‰ <code>Symbol</code> å±æ€§çš„é”®å</li><li><code>Reflect.ownKeys(obj)</code>ï¼šå¯¹è±¡è‡ªèº«æ‰€æœ‰çš„é”®åï¼ˆæ— è®ºæ˜¯ Symbol å±æ€§æˆ–è€…æ˜¯åˆ«çš„å±æ€§ï¼Œä¸å…³å¿ƒå¯å¦æšä¸¾ï¼‰</li></ul></li><li><p><code>super</code>ï¼š</p><ul><li>æŒ‡å‘å¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼Œåœ¨è¿™ç§ç”¨æ³•ä¸‹ï¼Œåªèƒ½åœ¨<strong>å¯¹è±¡æ–¹æ³•</strong>ä¸­ä½¿ç”¨</li><li>å¯¹è±¡æ–¹æ³•ï¼šå¿…é¡»é‡‡ç”¨ ES6 æ–¹æ³•ç®€å†™çš„æ–¹å¼ï¼Œæ‰ä¼šè¢«è®¤å®šä¸ºå¯¹è±¡æ–¹æ³•</li></ul></li><li><p>å¯¹è±¡è§£æ„èµ‹å€¼ï¼š</p><ul><li><code>let { x, y, ...z }  = { x: 1, y: 2, a: 10, b: 20 }</code></li><li>è§£æ„èµ‹å€¼å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°</li><li>å³å€¼å¿…é¡»æ˜¯å¯¹è±¡</li><li>é‡‡ç”¨çš„æ˜¯æµ…æ‹·è´</li></ul></li><li><p><code>Object.is()</code>ï¼š</p><ul><li>æ›´åŠ æ˜ç¡®çš„æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç¬¦åˆ <strong>Same-value equlity</strong></li><li><code>Object.is(NaN, NaN) // true</code> </li><li><code>Object.is(+0, -0) // false</code></li></ul></li><li><p><code>Object.assign()</code> ç”¨äºå¯¹è±¡åˆå¹¶ï¼Œå°±æ˜¯å°†æºå¯¹è±¡æ‰€æœ‰å¯æšä¸¾çš„å±æ€§å¤åˆ¶åˆ°ç›®æ ‡å¯¹è±¡ï¼ˆåŒ…æ‹¬ <code>Symbol</code> å±æ€§ï¼‰ã€‚æ³¨æ„ç‚¹ï¼š</p><ul><li>æµ…æ‹·è´</li><li>åŒåå±æ€§ç›´æ¥æ›¿æ¢ï¼Œä¸è€ƒè™‘åµŒå¥—</li><li>ç”±äº <code>Object.assign</code> åªèƒ½è¿›è¡Œå€¼å¤åˆ¶ï¼Œå¯¹äºå–å€¼å‡½æ•°ï¼Œåˆ™ä¼šå…ˆå–å€¼å†å¤åˆ¶</li></ul></li><li><p><code>Object.assign()</code> å¸¸è§ç”¨é€”ï¼š</p><ul><li>ä¸ºå¯¹è±¡æ·»åŠ å±æ€§ï¼š<code>Object.assign(this, { x, y })</code></li><li>ä¸ºå¯¹è±¡æ·»åŠ æ–¹æ³•ï¼š<code>Object.assign(Foo.prototype, { barMethod() { ... } })</code></li><li>å¯¹è±¡å…‹éš†ï¼š<code>Object.assign(Object.create(originProto), origin)</code></li><li>å±æ€§æä¾›é»˜è®¤å€¼ï¼š<code>Object.assign({}, DEFAULTS, options)</code></li></ul></li></ul><h2 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h2><ul><li><p>ES6 å¼•å…¥ Symbol çš„åŸå› ï¼š</p><ul><li>ES5 ä¸­ï¼Œå±æ€§åæ˜¯å­—ç¬¦ä¸²ï¼Œå®¹æ˜“é€ æˆå±æ€§åå†²çª</li><li>Symbol å¯ä»¥ä¿è¯æ¯ä¸ªå±æ€§ç‹¬ä¸€æ— äºŒ</li></ul></li><li><p><code>Symbol</code> æ˜¯æ–°å¢çš„åŸå§‹ç±»å‹ï¼Œè¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼ã€‚ç”¨äºå¯¹è±¡çš„å±æ€§ã€‚ä½¿ç”¨ <code>Symbol()</code> å‡½æ•°æ„é€ </p></li><li><code>Symbol</code> æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºå¯¹ <code>Symbol</code> å®ä¾‹çš„æè¿°ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œåˆ™ä¼šè°ƒç”¨ <code>obj.toString()</code> å¾—åˆ°å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œå†ç”Ÿæˆä¸€ä¸ª Symbol å€¼</li><li>æ³¨æ„ç‚¹ï¼š<ul><li>ä¸å¯ä»¥ç›´æ¥ä¸å…¶å®ƒç±»å‹å€¼è¿ç®—ï¼Œä¸ä¼šéšå¼è½¬æ¢ä¸º string</li><li>å¯ä»¥æ˜¾å¼è½¬æ¢ä¸º string</li></ul></li><li><code>symbol.description</code> å¯ä»¥è·å– Symbol çš„æè¿°ä¿¡æ¯</li><li><p>ä½œä¸ºå¯¹è±¡çš„å±æ€§ï¼ˆåªèƒ½æ˜¯å…¬å¼€å±æ€§ï¼‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="built_in">Symbol</span>(<span class="string">'name'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> person = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ç§å®šä¹‰æ–¹å¼</span></span><br><span class="line">person[name] = <span class="string">"Foo"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–çš„æ–¹å¼</span></span><br><span class="line">person[name]</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒç§å®šä¹‰æ–¹å¼</span></span><br><span class="line"><span class="keyword">let</span> person2 = &#123;</span><br><span class="line">    [name]: <span class="string">'Bar'</span> <span class="comment">// å¿…é¡»è¦æ”¾åœ¨æ–¹æ‹¬å·ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰ç§å®šä¹‰æ–¹å¼</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(a, mySymbol, &#123; <span class="attr">value</span>: <span class="string">'Hello!'</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥ä½œä¸ºå¸¸é‡ï¼Œä¿è¯å€¼ä¸åŒ</p></li><li>å¯ä»¥ç±»ä¼¼æˆ‘ä»¬åœ¨ Python ä¸­é‚£æ ·å®šä¹‰ Enumï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userType = &#123;</span><br><span class="line">    guest: <span class="built_in">Symbol</span>(),</span><br><span class="line">    org: <span class="built_in">Symbol</span>(),</span><br><span class="line">    member: <span class="built_in">Symbol</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”±äºä¸ä¼šè¢«å¸¸è§„çš„æ–¹æ³•å¦‚ <code>getOwnPropertyNames</code> ç­‰éå†åˆ°ï¼Œä½†å…¶å®åˆæ˜¯å…¬å¼€ã€‚è¿™ç§ç‰¹æ€§å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€äº›éç§æœ‰ã€ä»…å¸Œæœ›å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•</li><li><p><code>Symbol.for</code> å’Œ <code>Symbol.keyFor</code>ï¼šå¤ç”¨ç›¸åŒå‚æ•°æ„å»ºçš„ <code>Symbol</code>ï¼Œå®ƒä¼šåœ¨å…¨å±€æ³¨å†Œå‚æ•°ï¼Œå¹¶åœ¨åˆ›å»ºå‰è¿›è¡Œæœç´¢ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œå¦åˆ™æ–°å»ºã€‚æ³¨æ„è¿™ä¸ªå…¨å±€æ˜¯å…¨å±€ç¯å¢ƒï¼Œå¯ä»¥åœ¨ä¸åŒçš„ <code>iframe</code> å’Œ <code>service worker</code> ä¸­å–åˆ°åŒæ ·çš„å€¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">Symbol</span>.for(<span class="string">'s1'</span>)</span><br><span class="line"><span class="built_in">Symbol</span>.for(<span class="string">'s1'</span>) === s1 <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Symbol</span>.keyFor(s1) <span class="comment">// 's1'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s2 = <span class="built_in">Symbol</span>(<span class="string">'s2'</span>)</span><br><span class="line"><span class="built_in">Symbol</span>.keyFor(s2) <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure></li><li><p>å†…ç½®çš„ Symbol å€¼ï¼ŒæŒ‡å‘è¯­è¨€å†…éƒ¨ä½¿ç”¨çš„æ–¹æ³•ï¼š</p><ul><li><code>Symbol.hasInstance</code>ï¼Œæ¯ä¸ªå¯¹åº”å¯ä»¥è‡ªå®šä¹‰è¿™ä¸ª Symbol æ–¹æ³•ï¼Œä»è€Œè®© <code>instanceof</code> è¿ç®—ç¬¦æŒ‰ç…§æœŸæœ›çš„è¡¨ç°</li><li><code>Symbol.isConcatSpreadable</code> å±æ€§ï¼Œè¡¨ç¤ºåœ¨ <code>Array.prototype.concat()</code> æ—¶ï¼Œèƒ½å¦å±•å¼€</li><li><code>Symbol.species</code> å±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚åœ¨åˆ›å»ºè¡ç”Ÿå¯¹è±¡æ—¶ï¼Œä¼šä½¿ç”¨è¯¥å±æ€§</li><li><code>Symbol.iterator</code> æŒ‡å‘å¯¹è±¡çš„é»˜è®¤éå†å™¨</li><li><code>Symbol.toPrimitive</code> æŒ‡å‘è½¬æ¢æˆåŸå§‹ç±»å‹çš„æ–¹æ³•</li></ul></li></ul><h2 id="Set-å’Œ-Map-æ•°æ®ç»“æ„"><a href="#Set-å’Œ-Map-æ•°æ®ç»“æ„" class="headerlink" title="Set å’Œ Map æ•°æ®ç»“æ„"></a>Set å’Œ Map æ•°æ®ç»“æ„</h2><ul><li><code>Set</code> æ„é€ å‡½æ•°å¯æ¥å—ä»»æ„ <code>Iterable</code> çš„å¯¹è±¡</li><li><p>æ¥çœ‹ä¸‹æ¶ˆé™¤æ•°ç»„ä¸­é‡å¤å…ƒç´ çš„æ–¹æ³•ä¸ Python çš„åŒºåˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Python ä¸­çš„å†™æ³•</span><br><span class="line">list(set([1, 1, 2]))</span><br><span class="line"></span><br><span class="line">// JS ES6 ä¸­çš„å†™æ³•</span><br><span class="line">[...new Set([1, 1, 2])]</span><br><span class="line"></span><br><span class="line">// æˆ–è€…</span><br><span class="line">Array.from(new Set([1, 1, 2)])</span><br></pre></td></tr></table></figure></li><li><p><code>WeakSet</code> å¼±å¼•ç”¨è®¡æ•°ï¼Œåªèƒ½å­˜æ”¾å¯¹è±¡ã€‚ä¸å¯éå†</p></li><li><p><code>Map</code> çš„æ„é€ ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆçœ‹çœ‹ Python ä¸­ä¸€ä¸ªç±»ä¼¼çš„æ„é€ æ–¹å¼</span></span><br><span class="line">dict(zip([<span class="string">'name'</span>, <span class="string">'age'</span>], [<span class="string">'chris'</span>, <span class="number">22</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‚£ä¹ˆåœ¨ ES6 ä¸­çš„å†™æ³•</span></span><br><span class="line"><span class="comment">// å®é™…ä¸Šä»»æ„ Iterable çš„å¯¹è±¡ï¼Œä¸”æˆå‘˜å‡ä¸ºåŒå…ƒç´ çš„æ•°ç»„çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥ä½œä¸º Map çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="string">'name'</span>, <span class="string">'age'</span>], [<span class="string">'chris'</span>, <span class="number">22</span>]])</span><br></pre></td></tr></table></figure></li><li><p><code>WeakMap</code></p></li></ul><h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><ul><li>å±äºå…ƒç¼–ç¨‹èŒƒç•´ï¼Œå¯ä»¥æ‹¦æˆªä¸€äº›æ“ä½œï¼Œå¹¶è¿›è¡Œé‡å®šä¹‰</li><li>æ„é€ å‡½æ•°ï¼š<code>var proxy = new Proxy(target, handler)</code></li><li><p>è¦æƒ³è®© <code>Proxy</code> èµ·ä½œç”¨ï¼Œå¿…é¡»è¦é’ˆå¯¹å…¶å®ä¾‹è¿›è¡Œæ“ä½œï¼Œè€Œéç›®æ ‡å¯¹è±¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> handler = &#123;</span><br><span class="line">    get (target, name, receiver) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name === <span class="string">"name"</span> || name == <span class="string">"age"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, name, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">ReferenceError</span>(<span class="string">`property '<span class="subst">$&#123;name&#125;</span>' not found`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> user = &#123;</span><br><span class="line">    name: <span class="string">"Chris"</span>,</span><br><span class="line">    age: <span class="number">26</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(user, handler)</span><br><span class="line"><span class="built_in">console</span>.log(proxy)</span><br><span class="line"><span class="built_in">console</span>.log(proxy.age)</span><br><span class="line"><span class="built_in">console</span>.log(proxy.name)</span><br><span class="line"><span class="built_in">console</span>.log(proxy.foo)</span><br></pre></td></tr></table></figure></li><li><p><code>Proxy.revocable</code> å¯ä»¥è¿”å›ä¸€ä¸ªå¯å–æ¶ˆçš„ Proxy å®ä¾‹</p></li></ul><h2 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h2><ul><li><code>Reflect</code> ä¹Ÿæ˜¯ä¸ºäº†æ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–°çš„ APIï¼Œè®¾è®¡ç›®æ ‡ï¼š<ul><li>å°† <code>Object</code> å¯¹è±¡ä¸­æ˜æ˜¾å±äºå†…éƒ¨çš„æ–¹æ³•å‰¥ç¦»å‡ºæ¥ï¼Œæ”¾åˆ° <code>Reflect</code> å¯¹è±¡ä¸Š</li><li>ä¿®æ”¹æŸäº› <code>Object</code> æ–¹æ³•çš„è¿”å›ç»“æœï¼Œæ›´åŠ æ–¹ä¾¿ä½¿ç”¨</li><li>å°†æŸäº›å‘½ä»¤å¼çš„æ“ä½œï¼Œå˜æˆå‡½æ•°ï¼Œå¦‚ï¼š<code>name in obj =&gt; Reflect.has(obj, name)</code>ï¼Œ<code>delete obj[name] =&gt; Reflect.deleteProperty(obj, name)</code></li><li>ä¸ <code>Proxy</code> ä¸­æ‹¦æˆªæ–¹æ³•ä¸€æ ·ï¼Œå¯ä»¥æ›¿ä»£æ‰§è¡Œå¯¹è±¡çš„é»˜è®¤è¡Œä¸º</li><li><code>Reflect.apply(Math.floor, undefined, [1])</code></li></ul></li></ul><h2 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h2><ul><li>å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆã€‚æ‰€è°“ Promiseï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„å®¹å™¨ï¼Œä¿å­˜ç€æœªæ¥æ‰ä¼šç»“æŸçš„äº‹æƒ…ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥ç»“æœï¼‰</li><li><p>ç‰¹ç‚¹ï¼š</p><ul><li>å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ï¼ˆpending, fulfilled, rejectedï¼‰</li><li>ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°ç»“æœ</li><li>ä»¥æ›´åŠ åŒæ­¥çš„æ–¹å¼ç¼–ç¨‹ï¼Œæ˜“äºæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä¾¿äºç»´æŠ¤</li></ul></li><li><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•å–æ¶ˆ</li><li>è‹¥ä¸è®¾ç½®å›è°ƒï¼ŒPromise å†…éƒ¨æŠ›å‡ºé”™è¯¯ä¸ä¼šåé¦ˆåˆ°å¤–éƒ¨</li><li>pending çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥å…·ä½“è¿›å±•æƒ…å†µ</li></ul></li><li><p><code>Promise.prototype.then()</code> å¯æ¥å—ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæ˜¯ <code>resolved</code> æ—¶çš„ å›è°ƒï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ <code>rejected</code>  æ—¶çš„å›è°ƒã€‚ç¬¬äºŒä¸ªå›è°ƒå¯é€‰</p></li><li><code>Promise.prototype.then()</code> è¿”å›çš„æ˜¯ä¸€å€‹æ–°çš„ <code>Promise</code> å¯¦ä¾‹</li><li><code>Promise.prototype.catch()</code> æ˜¯ <code>.then(undefined, rejection)</code> æˆ– <code>.then(null, rejection)</code> çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°</li><li>Promise å¯¹è±¡çš„é”™è¯¯å…·æœ‰å†’æ³¡çš„æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚é”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª <code>catch</code> æ•è·</li><li><code>Promise.prototype.finally</code> ç”¨äºæŒ‡å®šä¸ç®¡ <code>Promise</code> å¯¹è±¡æœ€ç»ˆå¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œï¼ŒES2018 å¼•å…¥ã€‚æ— æ³•åœ¨ finally ä¸­è·å– Promise çš„çŠ¶æ€ï¼Œå®ƒçš„æ‰§è¡Œä¸çŠ¶æ€æ— å…³</li><li><p><code>Promise.all</code>ï¼š</p><ul><li>å‚æ•°å¿…é¡»æ˜¯ Iterable çš„å¯¹è±¡ï¼Œå…ƒç´ åº”å½“æ˜¯ Promise å®ä¾‹</li><li>çŠ¶æ€ç”±æˆå‘˜å†³å®šï¼Œåªæœ‰éƒ½æ˜¯ <code>fulfilled</code> æ—¶ï¼Œæ•´ä½“çš„çŠ¶æ€æ‰ä¼šå˜æˆ <code>fulfilled</code></li><li>å¦‚æœä»»ä½•ä¸€ä¸ª <code>rejcted</code> ï¼Œåˆ™æ•´ä½“æ•´ä½“å°±æ˜¯ <code>rejected</code>ï¼Œå¹¶ä¸”è¿”å›ç¬¬ä¸€ä¸ªè¢« <code>reject</code> çš„å®ä¾‹çš„è¿”å›å€¼</li></ul></li><li><p><code>Promise.race</code>ï¼Œç±»ä¼¼ <code>Promise.any</code> çš„æ„Ÿè§‰ï¼Œå°±æ˜¯åªè¦æœ‰ä¸€ä¸ªçŠ¶æ€æ”¹å˜ï¼Œæ•´ä½“çŠ¶æ€å°±å˜åŒ–ï¼›ç‡å…ˆå˜åŒ–çš„ Promise å®ä¾‹è¿”å›å€¼ä¼šä¼ é€’ç»™ <code>p</code> çš„å›è°ƒå‡½æ•°</p></li></ul><h2 id="Iterator-amp-forâ€¦of"><a href="#Iterator-amp-forâ€¦of" class="headerlink" title="Iterator &amp; forâ€¦of"></a>Iterator &amp; forâ€¦of</h2><ul><li><p>Iterator éå†è¿‡ç¨‹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªæŒ‡å‘å¯è¿­ä»£å¯¹è±¡çš„æŒ‡é’ˆå¯¹è±¡</li><li>è°ƒç”¨ <code>next</code>ï¼Œå¯å¾—åˆ°ç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆè¿”å›ç»“æœåŒ…æ‹¬ä¸¤ä¸ªå±æ€§ï¼š<code>value</code> + <code>done</code>ï¼Œå¯åˆ†åˆ«çœç•¥ï¼‰</li><li>ä¸æ–­è°ƒç”¨ <code>next</code> ç›´åˆ°æ¶ˆè´¹å®Œ</li></ul></li><li><p>å®ç°äº† <code>Iterator</code> æ¥å£çš„æ•°æ®ç»“æ„ï¼Œå°±æ˜¯å¯éå†çš„ï¼ˆIterableï¼‰ã€‚ç¤ºä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RangeIterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(start = 0, stop = 100) &#123;</span><br><span class="line">        <span class="keyword">this</span>._value = start</span><br><span class="line">        <span class="keyword">this</span>._stop = stop</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="built_in">Symbol</span>.iterator]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    next() &#123;</span><br><span class="line">        <span class="keyword">let</span> val = <span class="keyword">this</span>._value</span><br><span class="line">        <span class="keyword">if</span> (val &lt; <span class="keyword">this</span>._stop) &#123;</span><br><span class="line">            <span class="keyword">this</span>._value++</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: val&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>, <span class="attr">value</span>: <span class="literal">undefined</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> x <span class="keyword">of</span> <span class="keyword">new</span> RangeIterator()) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½•æ—¶è§¦å‘ Iterator ï¼ˆå³ <code>Symbol.iterator</code>ï¼‰æ¥å£è°ƒç”¨ï¼Ÿ</p><ul><li>è§£æ„èµ‹å€¼</li><li>æ‰©å±•è¿ç®—ç¬¦</li><li><code>yield*</code></li><li><code>for...of</code></li><li><code>Array.from()</code></li><li><code>Map()</code>, <code>Set()</code>, <code>WeakMap()</code>, <code>WeakSet()</code></li><li><code>Promise.all()</code></li><li><code>Promise.race()</code></li></ul></li><li><p>å¯ä»¥ä½¿ç”¨ Generator å‡½æ•°å®ç°å¯è¿­ä»£ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RangeIterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(start = 0, stop = 10) &#123;</span><br><span class="line">        <span class="keyword">this</span>._value = start</span><br><span class="line">        <span class="keyword">this</span>._stop = stop</span><br><span class="line">    &#125;</span><br><span class="line">    *[<span class="built_in">Symbol</span>.iterator]() &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">this</span>._value &lt; <span class="keyword">this</span>._stop) &#123;</span><br><span class="line">            <span class="keyword">this</span>._value++</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">this</span>._value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> x <span class="keyword">of</span> <span class="keyword">new</span> RangeIterator()) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>éå†å™¨å¯¹è±¡é™¤äº†æœ‰ <code>next</code> æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ª <code>return</code> æ–¹æ³•ï¼Œç”¨äºå¤„ç† <code>for...of</code> æå‰é€€å‡ºï¼ˆå¦‚å‡ºé”™ï¼Œæˆ–è€… <code>break</code>ï¼‰æ—¶è¦åšçš„äº‹æƒ…ã€‚è€Œ <code>throw</code> æ–¹æ³•ä¸€èˆ¬æ˜¯é…åˆ Generator å‡½æ•°ä½¿ç”¨</p></li></ul><h2 id="Generator-å‡½æ•°"><a href="#Generator-å‡½æ•°" class="headerlink" title="Generator å‡½æ•°"></a>Generator å‡½æ•°</h2><ul><li>å®šä¹‰æ–¹å¼ï¼š<code>function* funcName() { yield 1; return &quot;end&quot; }</code></li><li>è°ƒç”¨ Generator å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä»£è¡¨ Generator å‡½æ•°å†…éƒ¨æŒ‡é’ˆ</li><li><code>yield</code> åªèƒ½ç”¨äº Generator å‡½æ•°ä¸­ï¼ˆè¿™ä¸ªå’Œ Python ä¸åŒã€‚åœ¨ Python ä¸­ï¼ŒGenerator å‡½æ•°ä»è¡¨æ˜ä¸Šçœ‹å’Œæ™®é€šå‡½æ•°å®šä¹‰æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å®ç°ä¸åŒï¼‰</li><li><code>yield</code> è¡¨è¾¾å¼æœ¬èº«æ— è¿”å›å€¼ï¼Œæˆ–è€…æ€»è¿”å› <code>undefined</code>ã€‚<code>next</code> æ–¹æ³•å¯ä»¥å¸¦å‚æ•°ï¼Œä½œä¸º <code>yield</code> è¡¨è¾¾å¼çš„è¿”å›å€¼</li><li>ç¬¬ä¸€æ¬¡å¸¦å‚æ•°è°ƒç”¨ <code>next</code> æ–¹æ³•æ—¶ï¼Œå‚æ•°æ˜¯æ— æ•ˆçš„ã€‚å› ä¸º <code>next</code> æ–¹æ³•çš„å‚æ•°è¡¨ç¤ºä¸Šä¸€ä¸ª <code>yield</code> è¡¨è¾¾å¼çš„è¿”å›å€¼</li><li>è¯­ä¹‰ä¸Šï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ <code>next</code> æ˜¯å¯åŠ¨éå†å™¨å¯¹è±¡</li><li><code>Generator.prototype.throw()</code> å¯ä»¥åœ¨å‡½æ•°ä½“å¤–å‘ Generator å‡½æ•°æŠ›é”™ã€‚å¦‚æœç”Ÿæˆå™¨ä¸­æ²¡æœ‰ <code>try...catch</code> å—ï¼Œé”™è¯¯ä¼šä¼ é€’åˆ°å¤–éƒ¨</li><li>å¦‚æœä¸€ä¸ª Generator æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¸”æ²¡æœ‰å†…éƒ¨æ•è·ï¼Œåˆ™ä¼šè®¤ä¸ºå®ƒå·²ç»æ‰§è¡Œç»“æŸäº†</li><li><code>Generator.prototype.return()</code> å¯ä»¥ç»ˆæ­¢ Generatorï¼Œå¦‚æœ <code>return</code> å¸¦å‚æ•°ï¼Œåˆ™ä¼šä½œä¸ºæœ€åçš„è¿”å›å€¼ã€‚å¦‚æœ Generator ä¸­å«æœ‰ <code>try...finally</code> è¯­å¥å—ï¼Œåˆ™ä¼šä¼˜å…ˆæ‰§è¡Œ <code>finally</code>ï¼Œå»¶è¿Ÿè¿”å›</li><li><code>yield*</code> è¡¨è¾¾å¼å¯ä»¥å‚è€ƒ Python ä¸­çš„ <code>yield from</code></li><li>å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼š<ul><li>å›è°ƒå‡½æ•°</li><li>äº‹ä»¶ç›‘å¬</li><li>å‘å¸ƒ/è®¢é˜…</li><li>Promise å¯¹è±¡</li></ul></li></ul><h2 id="async-å‡½æ•°"><a href="#async-å‡½æ•°" class="headerlink" title="async å‡½æ•°"></a>async å‡½æ•°</h2><ul><li><code>async</code> æ˜¯ Generator è¯­æ³•ç³–ï¼Œå†™å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°æ›´åŠ ä¾¿æ·</li><li><p>æ”¹è¿›ç‚¹ï¼š</p><ul><li><strong>å†…ç½®æ‰§è¡Œå™¨</strong>ï¼Œæ— éœ€ <code>co</code> ä¹‹ç±»çš„æ¨¡å—æ§åˆ¶ Generator æ‰§è¡Œæµç¨‹äº†</li><li><strong>æ›´å¥½çš„è¯­ä¹‰</strong></li><li><strong>æ›´å¹¿çš„é€‚ç”¨æ€§</strong>ã€‚<code>await</code> å¯ä»¥æ˜¯ Promise å¯¹è±¡ï¼Œå¦‚æœæ˜¯åŸå§‹ç±»å‹å€¼ï¼Œåˆ™ä¼šè‡ªåŠ¨è½¬æ¢ä¸º resolved Promise å¯¹è±¡</li><li><strong>è¿”å›å€¼æ˜¯ Promise</strong></li></ul></li><li><p>å®šä¹‰æ–¹å¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°å£°æ˜</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"><span class="comment">// å‡½æ•°è¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"><span class="comment">// å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">let</span> o = &#123; <span class="keyword">async</span> foo() &#123; &#125; &#125;</span><br><span class="line"><span class="comment">// ç±»ä¸­å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.cachePromise = caches.open(<span class="string">"avatars"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> getAvatar(name) &#123;</span><br><span class="line">        <span class="keyword">const</span> cache = <span class="keyword">await</span> <span class="keyword">this</span>.cachePromise</span><br><span class="line">        <span class="keyword">return</span> cache.match(<span class="string">`/avatars/<span class="subst">$&#123;name&#125;</span>.jpg`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Storage()</span><br><span class="line">store.getAvatar(<span class="string">"jake"</span>).then().cach()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®­å¤´å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">async</span> () =&gt; &#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>é”™è¯¯å¤„ç†ï¼šå¦‚æœ <code>await</code> åé¢çš„å¼‚æ­¥æ“ä½œå‡ºé”™ï¼Œç­‰åŒäº <code>async</code> å‡½æ•°è¿”å›çš„ Promise å¯¹è±¡è¢« rejectã€‚æ•è·é”™è¯¯çš„ä¸¤ç§æ–¹å¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> doSomething()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦å¤–ä¸€ç§</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">await</span> doSomething().catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123; <span class="built_in">console</span>.error(e) &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯¹äºä¸ç›¸äº’ä¾èµ–çš„ç‹¬ç«‹æ“ä½œï¼Œä¸å»ºè®®åˆ†åˆ« awaitï¼Œé‚£æ ·å’ŒåŒæ­¥æœ‰æ¯›çº¿åŒºåˆ«ã€‚å»ºè®®ç”¨ä¸‹é¢çš„æ–¹å¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [foo, bar] = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([foo(), bar()])</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦å¤–ä¸€ç§å†™æ³•</span></span><br><span class="line"><span class="keyword">let</span> fooPromise = foo()</span><br><span class="line"><span class="keyword">let</span> bar <span class="built_in">Promise</span> = bar()</span><br><span class="line"><span class="keyword">let</span> fooResult = <span class="keyword">await</span> fooPromise</span><br><span class="line"><span class="keyword">let</span> barResult = <span class="keyword">await</span> barPromise</span><br></pre></td></tr></table></figure></li><li><p>å®ç°åŸç†ï¼šå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨åŒ…è£…åœ¨ä¸€èµ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»·äº</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spaw(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h2><ul><li>ES6 ä¸­çš„ class æœ¬è´¨ä¸Šè¿˜æ˜¯ <code>Function</code> å¯¹è±¡ï¼Œæ‰€æœ‰å®šä¹‰çš„æ–°æ–¹æ³•éƒ½æ˜¯åœ¨ <code>prototype</code> ä¸Šã€‚ä½†æ˜¯ï¼Œç±»å†…éƒ¨å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ä¸å¯æšä¸¾çš„ï¼Œè¿™ç‚¹å’Œ ES5 ä¸­ç›´æ¥ç»™ <code>prototype</code> æŒ‚è½½æ–¹æ³•ä¸åŒ</li><li>æ¯ä¸ªç±»éƒ½å¿…è¦æœ‰ <code>constructor</code>ï¼Œå¦‚æœæ²¡æœ‰ä¼šæœ‰ä¸€ä¸ªç©ºçš„ <code>constructor</code> å­˜åœ¨</li><li>ç±»å¿…é¡»ä½¿ç”¨ <code>new</code> è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™</li><li><p>this æŒ‡å‘ï¼š</p><ul><li>ç±»çš„æ–¹æ³•å†…éƒ¨å¦‚æœå«æœ‰ <code>this</code>ï¼Œé»˜è®¤æŒ‡å‘ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯å¦‚æœå•ç‹¬ä½¿ç”¨ï¼Œå¯èƒ½å‡ºé”™</li><li>è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼Œå›ºå®š <code>this</code>ï¼š<ul><li>é‡‡ç”¨ <code>bind</code></li><li>ä½¿ç”¨ç®­å¤´å‡½æ•°</li></ul></li></ul></li><li><p>é™æ€æ–¹æ³•ï¼š</p><ul><li>ä½¿ç”¨ <code>static</code> å…³é”®å­—ä¿®é¥°</li><li>ä¸ä¼šè¢«å®ä¾‹ç»§æ‰¿å’Œè°ƒç”¨ï¼ˆè¿™ç‚¹å’Œ Python ä¸åŒï¼Œåœ¨ Python ä¸­ static æ–¹æ³•å¯ä»¥è¢«å®ä¾‹è°ƒç”¨ï¼Œè€Œä¸éœ€è¦é€šè¿‡ç±»åï¼‰</li><li>å¦‚æœé™æ€æ–¹æ³•ä¸­åŒ…å« <code>this</code>ï¼Œ<strong>å…¶æŒ‡å‘çš„ä¸æ˜¯å®ä¾‹ï¼Œè€Œæ˜¯ç±»</strong></li><li>é™æ€æ–¹æ³•å¯ä»¥å’Œéé™æ€æ–¹æ³•é‡å</li><li>çˆ¶ç±»çš„é™æ€æ–¹æ³•å¯ä»¥è¢«å­ç±»ç»§æ‰¿</li></ul></li><li><p>ç»§æ‰¿ï¼š</p><ul><li>ä½¿ç”¨ <code>extends</code> å…³é”®å­—</li><li>å•ç»§æ‰¿</li><li>å­ç±»å¿…é¡»è¦åœ¨è‡ªå®šä¹‰çš„ <code>constructor</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>super</code>ï¼Œè§¦å‘çˆ¶ç±»æ„é€ å‡½æ•°è°ƒç”¨åï¼Œæ‰å¯ä»¥ä½¿ç”¨ <code>this</code></li></ul></li><li><p>åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦ç»§æ‰¿è‡ªæŸä¸ªç±»å®ä¾‹ï¼š<code>Reflect.getPrototypeOf(ColoredPoint) === Point</code></p></li><li><p><code>super</code> å…³é”®å­—ï¼š</p><ul><li>å½“ä½œå‡½æ•°ä½¿ç”¨ï¼Œä»£è¡¨è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶ <code>super</code> è°ƒç”¨åè¿”å›çš„æ˜¯åŸºç±»çš„å®ä¾‹ï¼‰ï¼Œåªèƒ½ç”¨äºæ„é€ å‡½æ•°</li><li>å½“ä½œå¯¹è±¡ï¼Œåœ¨æ™®é€šæ–¹æ³•ä¸­æŒ‡å‘çˆ¶ç±»çš„åŸå‹å¯¹è±¡ï¼›åœ¨é™æ€æ–¹æ³•ä¸­ï¼ŒæŒ‡å‘çˆ¶ç±»</li><li>ES6 è§„å®šï¼Œåœ¨å­ç±»æ™®é€šæ–¹æ³•ä¸­è°ƒç”¨ <code>super.xxx()</code> æ—¶ï¼Œæ–¹æ³•ä¸­çš„ <code>this</code> æŒ‡å‘çš„æ˜¯<strong>å½“å‰çš„å­ç±»å®ä¾‹</strong></li><li>åœ¨å­ç±»é™æ€æ–¹æ³•ä¸­é€šè¿‡ <code>super</code> è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶ï¼Œå†…éƒ¨çš„ <code>this</code> æŒ‡å‘å½“å‰çš„å­ç±»ï¼Œè€Œéå­ç±»çš„å®ä¾‹</li></ul></li><li><p>ES5 åŸç”Ÿæ„é€ å‡½æ•°æ— æ³•ç»§æ‰¿ï¼ˆå­ç±»æ— æ³•è·å¾—åŸç”Ÿæ„é€ å‡½æ•°çš„å†…éƒ¨å±æ€§ï¼‰ã€‚å…·ä½“åŸå› æ˜¯ ES5 ä¸­ï¼Œæ˜¯æ–°å»ºå­ç±»çš„å®ä¾‹å¯¹è±¡ <code>this</code>ï¼Œå†å°†çˆ¶ç±»çš„å±æ€§æ·»åŠ éƒ½å­ç±»ä¸Šï¼›è€Œçˆ¶ç±»çš„å†…éƒ¨å±æ€§æ— æ³•è·å–ï¼Œæ•…æ— æ³•ç»§æ‰¿ï¼š</p><ul><li>Boolean()</li><li>Number()</li><li>String()</li><li>Array()</li><li>Date()</li><li>Function()</li><li>RegExp()</li><li>Error()</li><li>Object()</li></ul></li><li><p>ES6 åˆ™å…è®¸ç»§æ‰¿ä¸Šè¿°åŸç”Ÿæ„é€ å‡½æ•°äº†ã€‚åŸå› æ˜¯ ES6 ä¸­ï¼Œæ˜¯å…ˆæ–°å»ºçˆ¶ç±»çš„å®ä¾‹å¯¹è±¡ <code>this</code>ï¼Œå†ç”¨å­ç±»çš„æ„é€ å‡½æ•°ä¿®é¥° <code>this</code>ï¼Œä½¿å¾—çˆ¶ç±»çš„è¡Œä¸ºå¯ä»¥ç»§æ‰¿</p></li></ul><h2 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h2><ul><li>æ—©æœŸ JS æ— æ¨¡å—ç®¡ç†æœºåˆ¶ï¼Œä¸åˆ©äºå¼€å‘å¤§å‹é¡¹ç›®</li><li>ç¤¾åŒºæä¾›äº† CommonJS å’Œ AMD ä¸¤ç§æ–¹æ¡ˆï¼Œåˆ†åˆ«ç”¨äºæœåŠ¡ç«¯å’Œæµè§ˆå™¨ç«¯ï¼›äºŒè€…éƒ½æ˜¯è¿è¡Œæ—¶ç¡®å®šæ¨¡å—ä¾èµ–</li><li>ES6 æ¨¡å—çš„è®¾è®¡æ€æƒ³æ˜¯å°½å¯èƒ½é™æ€åŒ–ï¼Œç¼–è¯‘æ—¶ç¡®å®šæ¨¡å—ä¾èµ–å…³ç³»åŠè¾“å…¥è¾“å‡ºå˜é‡</li><li><p><code>import</code> ä½¿ç”¨æ³¨æ„ï¼š</p><ul><li><code>import { foo } from &#39;mod&#39;</code></li><li>å¯¼å…¥çš„å˜é‡éƒ½æ˜¯åªè¯»çš„</li><li>å¯¼å…¥çš„è·¯å¾„æ—¢å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„</li><li><code>.js</code> åç¼€å¯çœç•¥</li><li>å¦‚æœåªæ˜¯æ¨¡å—åç§°ï¼Œæ— è·¯å¾„åˆ™éœ€è¦é…ç½®æ–‡ä»¶å‘ŠçŸ¥ JS å¼•æ“å…·ä½“çš„æ¨¡å—ä½ç½®</li><li>å…·æœ‰æå‡çš„æ•ˆæœ</li><li>é™æ€æ‰§è¡Œï¼Œæ— æ³•ä½¿ç”¨è¡¨è¾¾å¼å’Œå˜é‡</li><li>Single æ¨¡å¼ï¼Œæœ‰ç¼“å­˜æœºåˆ¶</li><li>æ•´ä½“åŠ è½½å¸¦åˆ«åï¼š<code>import * as mod from &#39;longNameMod&#39;</code></li></ul></li><li><p><code>export default</code> æœ¬è´¨ä¸Šæ˜¯è¾“å‡ºä¸€ä¸ªå«åš <code>default</code> çš„å˜é‡å’Œæ–¹æ³•ï¼Œç„¶åç³»ç»Ÿå…è®¸é‡å</p></li><li>åœ¨ä¸€æ¡è¯­å¥ä¸­åŒæ—¶è¾“å…¥é»˜è®¤æ–¹æ³•å’Œå…¶å®ƒæ¥å£ï¼š<code>import _, { each } from &#39;lodash&#39;</code></li><li>å¤åˆå†™æ³•ï¼š<code>export { foo, bar } from &#39;my_mod&#39;</code>ï¼Œæ³¨æ„ä¸ä¼šåœ¨å½“å‰æ¨¡å—å¯¼å…¥è¿™ä¸¤ä¸ªå˜é‡ï¼Œè€Œåªæ˜¯è½¬å‘åˆ°å¤–é¢äº†</li></ul><h2 id="æ¨¡å—åŠ è½½è§„åˆ™"><a href="#æ¨¡å—åŠ è½½è§„åˆ™" class="headerlink" title="æ¨¡å—åŠ è½½è§„åˆ™"></a>æ¨¡å—åŠ è½½è§„åˆ™</h2><ul><li><p>æµè§ˆå™¨ä¸­å¯ä½¿ç”¨çš„æ–¹å¼ï¼š</p><ul><li><code>&lt;script src=&quot;path/to/foo.js&quot; [async/defer]/&gt;</code></li><li>ES6 æ¨¡å—åŠ è½½ï¼ˆé»˜è®¤å°±æ˜¯ defer æ¨¡å¼ï¼‰ï¼š<code>&lt;script type=&quot;module&quot; src=&quot;./mod.js&quot;/&gt;</code></li><li><code>&lt;script type=&quot;model&quot;&gt;</code> /<em>å¯ä»¥æ­£å¸¸å†™ import xx from xxx è¿™ç§ï¼Œæ¨¡å—ä½œç”¨åŸŸ</em>/`</li></ul></li><li><p>ES6 ä¸ CommonJS</p><ul><li>å‰è€…è¾“å‡ºæ˜¯<strong>å€¼å¼•ç”¨</strong>ï¼Œåè€…è¾“å‡ºçš„æ˜¯<strong>å€¼æ‹·è´</strong></li><li>å‰è€…æ˜¯ç¼–è¯‘æ—¶è¾“å‡ºæ¥å£ï¼Œåè€…æ˜¯è¿è¡Œæ—¶åŠ è½½</li><li>å‰è€…æ˜¯åŠ¨æ€å¼•ç”¨ï¼Œåè€…ä¼šç¼“å­˜å€¼</li><li>åœ¨ Node ä¸­ <code>import</code> æ˜¯å¼‚æ­¥åŠ è½½</li><li>ES6 æ¨¡å—ä¸­ï¼Œé¡¶å±‚ <code>this</code> æŒ‡å‘ <code>undefined</code>ï¼›åè€…åˆ™æŒ‡å‘å½“å‰æ¨¡å—</li></ul></li></ul><h2 id="äºŒè¿›åˆ¶æ•°ç»„ï¼ˆç±»æ•°ç»„ï¼‰"><a href="#äºŒè¿›åˆ¶æ•°ç»„ï¼ˆç±»æ•°ç»„ï¼‰" class="headerlink" title="äºŒè¿›åˆ¶æ•°ç»„ï¼ˆç±»æ•°ç»„ï¼‰"></a>äºŒè¿›åˆ¶æ•°ç»„ï¼ˆç±»æ•°ç»„ï¼‰</h2><ul><li><p>äºŒè¿›åˆ¶æ•°ç»„ç»„æˆå¯¹è±¡ï¼š</p><ul><li><code>ArrayBuffer</code> å¯¹è±¡ï¼šä»£è¡¨å†…å­˜ä¸­çš„ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯é€šè¿‡ã€Œè§†å›¾ã€æ“ä½œ</li><li><p><code>TypedArray</code> è§†å›¾ï¼šå¯ç”¨äºè¯»å†™ç®€å•çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒåŒ…æ‹¬ 9 ç§ç±»å‹è§†å›¾ï¼š</p><ul><li><code>Int8</code></li><li><code>Uint8</code></li><li><code>Uint8C</code>ï¼šè‡ªåŠ¨è¿‡æ»¤æº¢å‡ºï¼Œ<code>DataView</code> è§†å›¾ä¸æ”¯æŒ</li><li><code>Int16</code></li><li><code>Uint16</code></li><li><code>Int32</code></li><li><code>Uint32</code></li><li><code>Float32</code></li><li><code>Float64</code></li></ul></li><li><p><code>DateView</code> è§†å›¾ï¼šå¯è‡ªå®šä¹‰å¤åˆæ ¼å¼çš„è§†å›¾ï¼Œè¯»å†™å¤æ‚ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®</p></li></ul></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="http://es6.ruanyifeng.com/#docs/function" target="_blank" rel="noopener">ECMAScript 6 å…¥é—¨</a></li><li><a href="http://keenwon.com/1524.html" target="_blank" rel="noopener">ES5 å’Œ ES6 ä¸­çš„ç»§æ‰¿</a></li><li><a href="https://babeljs.io/" target="_blank" rel="noopener">Babel</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;2015 å¹´ï¼ŒECMAScript ç¬¬å…­ç‰ˆå¾—ä»¥å‘å¸ƒï¼Œè¿™å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ES6 æ ‡å‡†ï¼Œæ ‡å¿—ç€ JavaScript è¯­è¨€è¿æ¥æ–°çºªå…ƒã€‚ES6 å¼•å…¥äº†ä¸€äº›æ–°çš„è¯­æ³•ç³–ï¼ŒåŒæ—¶å¼¥è¡¥äº†ä¸€äº›åœ¨ ES5 ä¸­å­˜åœ¨çš„ä¸€äº›ç¼ºé™·ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡ç¬”è®°æ˜¯åœ¨å­¦ä¹ é˜®ä¸€å³°è€å¸ˆçš„ã€ŠES6 å…¥é—¨æ•™ç¨‹ã€‹ä¸­åšçš„ç¬”è®°ï¼Œä¸»è¦æ˜¯è®°å½•ä¸€äº›è‡ªå·±ä¸å¤ªç†Ÿæ‚‰çš„æˆ–è€…å’Œ ES5 å·®å¼‚å¾ˆå¤§çš„ç‰¹æ€§ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å’Œåˆ«çš„è¯­è¨€ï¼ˆå¦‚ Pythonï¼‰è¿›è¡Œå¯¹æ¯”ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°åœ¨æŸäº›è®¾è®¡æ€æƒ³ä¸Šï¼Œè¿™äº›è¯­è¨€ä¹Ÿæ˜¯ç›¸é€šçš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="JavaScript" scheme="http://ifaceless.space/tags/JavaScript/"/>
    
      <category term="ES6" scheme="http://ifaceless.space/tags/ES6/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript ES5 å…¥é—¨ç¬”è®°</title>
    <link href="http://ifaceless.space/2019/06/23/javascript-es5-learning-note/"/>
    <id>http://ifaceless.space/2019/06/23/javascript-es5-learning-note/</id>
    <published>2019-06-23T10:02:26.000Z</published>
    <updated>2019-11-24T09:45:59.950Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æŠ½ç©ºå­¦ä¹ äº†ä¸‹ JavaScript è¯­è¨€ï¼Œå½“ç„¶è¿˜æ˜¯å…¥é—¨çº§åˆ«çš„é‚£ç§ã€‚å­¦ä¹ è¿‡ç¨‹ä¸­ä¹Ÿåšäº†äº›ç¬”è®°ã€‚æ€»çš„æ¥è¯´ï¼ŒES5 å­¦å®Œåï¼Œå¯¹ JavaScript æœ¬èº«äº†è§£äº†å¤§æ¦‚ï¼Œè¯­è¨€æœ¬èº«è®¾è®¡ä¸Šä¹Ÿå­˜åœ¨ä¸€äº›å‘ï¼Œæ‰€ä»¥æ­é…ã€ŠJavaScript ç²¾ç²¹ã€‹è¿™æœ¬ä¹¦çœ‹çœ‹ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£æœ‰å“ªäº›æ¯”è¾ƒå¥½çš„å†™æ³•é¿å…è¸©å‘ã€‚</p><a id="more"></a><h1 id="åŸºç¡€ç¯‡"><a href="#åŸºç¡€ç¯‡" class="headerlink" title="åŸºç¡€ç¯‡"></a>åŸºç¡€ç¯‡</h1><ul><li><p>åˆ¤æ–­æ˜¯å¦ä¸ºæœªå®šä¹‰çš„å˜é‡ï¼š</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯çš„å†™æ³•</span></span><br><span class="line"><span class="keyword">if</span> (v) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ReferenceError: v is not defined</span></span><br><span class="line"><span class="comment">// æ­£ç¡®çš„å†™æ³•</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> v === <span class="string">"undefined"</span>) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>typeof null</code> ä¹Ÿæ˜¯ <code>object</code></p></li><li>ä½¿ç”¨ <code>instanceof</code> å¯ä»¥åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„ï¼š<code>v instanceof Array</code></li><li><p><code>null</code> å’Œ <code>undefined</code> éå¸¸ç±»ä¼¼ï¼Œç”šè‡³ <code>null == undefined</code> éƒ½æˆç«‹ï¼Œä½†æ˜¯å®ƒä»¬åœ¨ JavaScript ä¸­è¿˜æ˜¯æœ‰åŒºåˆ«ï¼š</p><ul><li><code>null</code> è¡¨ç¤ºç©ºå¯¹è±¡ï¼Œå¯è½¬æ¢ä¸ºæ•°å€¼ 0ï¼š<code>Number(null) //0</code></li><li><code>undefined</code> è¡¨ç¤ºæ²¡æœ‰å®šä¹‰çš„åŸå§‹å€¼ï¼Œè½¬æ¢ä¸ºæ•°å€¼ä¸º NaN</li></ul></li><li><p>JS ä¸­æ‰€æœ‰æ•°å­—éƒ½æ˜¯ä»¥ 64 ä½æµ®ç‚¹æ•°å­˜å‚¨çš„ï¼Œå¯¹äºæŸäº›è¿ç®—ï¼Œåªèƒ½ç”¨æ•´æ•°ï¼ŒJS ä¼šå°†æ•°å­—è½¬æ¢ä¸º 32 ä½æ•´æ•°å†åšè¿ç®—</p></li><li>æ•°å€¼è®¡ç®—æ¯”è¾ƒéœ€è¦æ³¨æ„ï¼Œå› ä¸ºæµ®ç‚¹æ•°æœ‰ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ã€‚æ¯”å¦‚ï¼š<code>0.3-0.2 !== 0.2-0.</code>ã€‚</li><li>JavaScript å¯¹ 15 ä½çš„åè¿›åˆ¶æ•°éƒ½å¯ä»¥ç²¾ç¡®å¤„ç†ã€‚</li><li>å¯¹äºç ç‚¹åœ¨ U+10000 åˆ° U+10FFFF ä¹‹é—´çš„å­—ç¬¦ï¼ŒJavaScript æ€»æ˜¯è®¤ä¸ºå®ƒä»¬æ˜¯ä¸¤ä¸ªå­—ç¬¦ï¼ˆlength å±æ€§ä¸º 2ï¼‰</li><li>base64 è½¬æ¢ï¼š<code>btoa</code>, <code>atob</code></li><li><p>å±æ€§åˆ é™¤ <code>delete</code>ï¼š</p><ul><li>ä¸èƒ½åˆ é™¤å¯¹è±¡æœ¬èº«</li><li>æ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ï¼Œåˆ é™¤æ€»ä¼šè¿”å› <code>true</code></li><li>ç»§æ‰¿çš„å±æ€§ä¸èƒ½åˆ é™¤ï¼Œè™½ç„¶ä¹Ÿä¼šè¿”å› <code>true</code></li><li>ä½¿ç”¨ <code>defineProperty</code> å®šä¹‰çš„æ ‡è®°ä¸ºä¸å¯åˆ é™¤çš„å±æ€§ï¼Œ<code>delete</code> è¿”å› <code>false</code></li></ul></li><li><p>å¯¹è±¡å±æ€§å­˜åœ¨æ–°åˆ¤æ–­ï¼š</p><ul><li><code>in</code> å¯ä»¥åˆ¤æ–­ï¼Œä½†æ˜¯ä¸èƒ½åŒºåˆ†æ˜¯ç»§æ‰¿çš„è¿˜æ˜¯è‡ªèº«æ‹¥æœ‰çš„</li><li><code>hasOwnProperty</code> å¯ä»¥å¼¥è¡¥ä¸Šè¿°ç¼ºç‚¹</li></ul></li><li><p><code>for...in</code> ç”¨äºéå†å¯¹è±¡çš„å±æ€§ï¼š</p><ul><li>å¯¹è±¡å±æ€§å¿…é¡»æ˜¯å¯éå†çš„ï¼ˆenumerableï¼‰</li><li>å¯¹äºç»§æ‰¿çš„å±æ€§ä¹Ÿä¼šè¢«éå†åˆ°ï¼Œå¦‚æœä¸æƒ³è¦ï¼Œå¯ä»¥æ­é… <code>hasOwnProperty</code> è¿‡æ»¤æ‰</li></ul></li><li><p>ä¸€èˆ¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>Object.keys(o).map(k =&gt; { /*do stuff*/ }</code> </p></li><li>å‡½æ•°å£°æ˜å‡ ç§æ–¹å¼ï¼š<ul><li><code>function func_name(params) {}</code></li><li><code>let say = function (word) {}</code>ï¼ŒåŒ¿åå‡½æ•°</li><li><code>let say = function f(word) { console.log(f) }</code>ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„å‡½æ•°å <code>f</code> åªå¯ä»¥åœ¨è¯¥å‡½æ•°å†…éƒ¨è®¿é—®åˆ°ï¼Œæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š<ul><li>éå†åœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨è‡ªå·±</li><li>æ–¹ä¾¿è°ƒè¯•ï¼Œæ’é”™æ—¶çœ‹åˆ°å…·ä½“çš„å‡½æ•°åï¼Œè€Œä¸å†æ˜¯åŒ¿åå‡½æ•°</li></ul></li><li>ä½¿ç”¨ <code>Function</code> æ„é€ å‡½æ•°ï¼Œæ³¨æ„ï¼Œè¿”å›çš„å‡½æ•°çš„ <code>type</code> çš„ç¡®ä¹Ÿæ˜¯ <code>function</code>ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰</li></ul></li><li>JS å¼•æ“å°†å‡½æ•°åè§†ä¸ºå˜é‡åï¼Œæ‰€ä»¥ä¹Ÿå­˜åœ¨ã€Œå‡½æ•°åæå‡ã€çš„æ•ˆæœï¼Œå› æ­¤ï¼Œåœ¨å‡½æ•°å£°æ˜ä½ç½®çš„ä¸Šæ–¹è°ƒç”¨ä¹Ÿä¸ä¼šå‡ºé”™</li><li>å‡½æ•°æ‰§è¡Œæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸï¼Œæ˜¯å®šä¹‰æ—¶çš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯è°ƒç”¨æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸ</li><li><p><code>arguments</code> å¯¹è±¡å¯ä»¥è·å–åˆ°å‡½æ•°ä¼ å…¥çš„å‚æ•°å€¼ï¼š</p><ul><li>è¯¥å¯¹è±¡ä¸æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åƒ <code>slice</code>, <code>forEach</code> æ–¹æ³•å°±ä¸å­˜åœ¨</li><li>å¦‚æœæƒ³è¦è½¬æ¢æˆæ•°ç»„ï¼Œä¸€ç§æ–¹å¼å°±æ˜¯ï¼š<code>let args = Array.prototype.slice.call(arguments)</code></li><li>åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä¸èƒ½é€šè¿‡ <code>arguments.callee</code> è°ƒç”¨å‡½æ•°è‡ªèº«ï¼›å¯¹ <code>arguments</code> çš„ä¿®æ”¹ä¸ä¼šå¯¹åŸå§‹ä¼ å…¥çš„å‚æ•°äº§ç”Ÿå½±å“</li></ul></li><li><p>ç«‹å³è°ƒç”¨å‡½æ•°çš„ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><code>(function () {console.log(10)})()</code></li><li><code>(function () {console.log(10)}())</code></li></ul></li><li><p>æ•°ç»„æ˜¯ç‰¹æ®Šçš„å¯¹è±¡ï¼Œå…¶é”®åå°±æ˜¯ä¸€ç»„æ•°å­—ï¼Œå¯ä»¥é€šè¿‡ <code>Object.keys</code> è¿”å›æ‰€æœ‰çš„é”®å</p></li><li>æ•°ç»„çš„ <code>length</code> å±æ€§ä¸è¿‡æ»¤ç©ºä½ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ length å±æ€§è¿›è¡Œæ•°ç»„éå†ï¼Œä¸€å®šè¦éå¸¸å°å¿ƒã€‚å¦‚ <code>delete arr[3]</code> ä¹‹åï¼Œä¾ç„¶ä¸ä¼šå½±å“ <code>length</code>ï¼Œåªæ˜¯äº§ç”Ÿäº†ä¸€ä¸ªç©ºä½ï¼›æ‰€ä»¥å¯ä»¥ä½¿ç”¨ <code>forEach</code> æ›¿ä»£ï¼Œå¯ä»¥è¿‡æ»¤ç©ºä½ï¼ˆä½†ç©ºä½ä¸ç­‰åŒäº <code>undefined</code>ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ <code>var a = [, , ,]</code> è¡¨ç¤ºçš„æ¯ä¸ªä½ç½®éƒ½æ˜¯ç©ºä½ï¼›<code>var a = [undefined, undefined]</code> åˆ™æ˜¯å¯éå†åˆ°çš„ï¼Œåªæ˜¯å€¼ä¸º <code>undefined</code> è€Œå·²</li><li>ç±»ä¼¼æ•°ç»„çš„æ•°ç»„ï¼ˆArray like objectï¼‰ï¼š<ul><li>å¯¹è±¡æ‹¥æœ‰ç±»ä¼¼ä¸‹é¢çš„å®šä¹‰ï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// æ‰€æœ‰çš„é”®éƒ½æ˜¯æ•°å­—</span><br><span class="line">// å¸¦æœ‰ length å±æ€§</span><br><span class="line">var obj = &#123;</span><br><span class="line">  0: &apos;a&apos;,</span><br><span class="line">  1: &apos;b&apos;,</span><br><span class="line">  2: &apos;c&apos;,</span><br><span class="line">  length: 3</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>å‡½æ•°çš„ <code>arguments</code>ï¼Œå­—ç¬¦ä¸²ï¼Œè¿˜æœ‰å¤šæ•°çš„ DOM å…ƒç´ éƒ½æ˜¯ array-like çš„å¯¹è±¡ã€‚å¯ä»¥ä½¿ç”¨ <code>Array.prototype.slice.call(xx)</code> è½¬æ¢æˆæ•°ç»„</p></li><li><p><code>void</code> è¿ç®—ç¬¦ï¼šä½œç”¨æ˜¯æ‰§è¡Œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¸è¿”å›ä»»ä½•å€¼ï¼ˆè¿”å› undefinedï¼‰ï¼š</p><ul><li>æ¨èç”¨æ³•ï¼š<code>void (x = 5)</code></li><li>ä½¿ç”¨åœºæ™¯ï¼Œé˜²æ­¢ç½‘é¡µè·³è½¬ï¼š<code>&lt;a href=&quot;javascript: void f()&quot;&gt;æ–‡å­—&lt;/a&gt;</code></li></ul></li><li><p>é€—å·è¿ç®—ç¬¦è¿”å›æœ€åä¸€ä¸ªå€¼ <code>&#39;a&#39;, &#39;b&#39; // &quot;b&quot;</code></p></li></ul><h1 id="è¯­æ³•ä¸“é¢˜"><a href="#è¯­æ³•ä¸“é¢˜" class="headerlink" title="è¯­æ³•ä¸“é¢˜"></a>è¯­æ³•ä¸“é¢˜</h1><ul><li><code>Number</code> ç”¨äºå¼ºåˆ¶è½¬æ¢æˆæ•°å€¼ç±»å‹ï¼Œä¸ <code>parseInt</code> ç›¸æ¯”ï¼Œè½¬æ¢è¦ä¸¥æ ¼å¾—å¤šï¼Œåªè¦é‡åˆ°ä¸å¯è½¬æ¢ä¸ºæ•°å€¼çš„å­—ç¬¦ï¼Œè½¬æ¢å°±å¤±è´¥</li><li><code>Boolean</code> æ‰€æœ‰å¯¹è±¡ï¼ˆå«ç©ºå¯¹è±¡ï¼‰çš„è½¬æ¢ç»“æœéƒ½æ˜¯ <code>true</code>ï¼Œå¦‚ <code>Boolean(new Boolean(false)) // true</code></li><li><p>JS ä¸­æ‰€æœ‰æŠ›å‡ºçš„é”™è¯¯éƒ½æ˜¯ <code>new Error(xx)</code> å‡ºæ¥çš„ï¼ŒError çš„åŸºæœ¬å±æ€§ï¼š</p><ul><li><code>message</code>ï¼šé”™è¯¯æç¤ºä¿¡æ¯ï¼ˆå¿…é¡»ï¼‰</li><li><code>name</code>ï¼šé”™è¯¯åç§°ï¼ˆéæ ‡å‡†å±æ€§ï¼Œçœ‹ JS å¼•æ“ï¼‰</li><li><code>stack</code>ï¼šé”™è¯¯çš„å †æ ˆï¼ˆéæ ‡å‡†å±æ€§ï¼Œçœ‹ JS å¼•æ“ï¼‰</li></ul></li><li><p>æ´¾ç”Ÿé”™è¯¯å¯¹è±¡ï¼š    </p><ul><li><code>SyntaxError</code></li><li><code>ReferenceError</code></li><li><code>RangeError</code>ï¼šæ•°ç»„é•¿åº¦ä¸ºè´Ÿæ•°ï¼›<code>Number</code> å¯¹è±¡çš„æ–¹æ³•å‚æ•°è¶…å‡ºèŒƒå›´ï¼›å‡½æ•°å †æ ˆè¶…è¿‡æœ€å¤§å€¼</li><li><code>TypeError</code></li><li><code>URIError</code></li></ul></li><li><p><code>throw</code> å¯ä»¥æŠ›å‡ºä»»æ„ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”åœ¨ <code>throw</code> çš„ä½ç½®å°±ä¸­æ–­äº†æ‰§è¡Œï¼ŒJS å¼•æ“ä¼šæ¥æ”¶åˆ°æŠ›å‡ºçš„ä¿¡æ¯</p></li><li><p><code>console</code> ä¸€äº›é‡è¦çš„æ–¹æ³•ï¼š</p><ul><li><code>info</code></li><li><code>error</code></li><li><code>debug</code></li><li><code>warn</code></li><li><code>table</code></li><li><code>log</code></li><li><code>dir</code>ï¼šç±»ä¼¼ <code>inspect</code></li></ul></li><li><p>å¯ä»¥åœ¨éœ€è¦çš„åœ°æ–¹åŠ  <code>debugger</code> ä½œä¸ºæ–­ç‚¹ï¼Œç”¨äºè°ƒè¯•</p></li></ul><h1 id="æ ‡å‡†åº“"><a href="#æ ‡å‡†åº“" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h1><ul><li><code>Object()</code> å‡½æ•°å¯ä»¥å°†ä»»æ„å€¼è½¬æ¢æˆå¯¹è±¡ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯åŸå§‹ç±»å‹å€¼ï¼Œåˆ™ä¼šè½¬æ¢æˆå…¶åŒ…è£…å¯¹è±¡çš„å®ä¾‹ï¼›å¦‚æœå…¥å‚å·²ç»æ˜¯å¯¹è±¡äº†ï¼Œåˆ™ä¸ä¼šè½¬æ¢</li><li>å¯ä»¥åˆ©ç”¨ä¸Šè¿°ç‰¹æ€§åˆ¤æ–­å˜é‡æ˜¯å¦ä¸ºå¯¹è±¡ï¼š<code>value === Object(value)</code></li><li><code>Object.keys()</code> é™æ€æ–¹æ³•å¯ä»¥è¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§åï¼ˆéç»§æ‰¿ï¼Œä¸”å¯æšä¸¾ï¼‰ï¼Œè¯¥éå†æ–¹æ³•ä¼˜å…ˆ</li><li><code>Object.getOwnPropertyNames()</code> é™æ€æ–¹æ³•åˆ™ä¼šè¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§åï¼ˆåŒ…æ‹¬ä¸å¯æšä¸¾çš„ï¼‰</li><li><p><code>Object.prototype.xxx</code> å®ä¾‹æ–¹æ³•ï¼š</p><ul><li><code>valueOf()</code>ï¼šè¿”å›å¯¹è±¡çš„å€¼ï¼Œé»˜è®¤ä¸ºè‡ªèº«</li><li><code>toString()</code>ï¼šè¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤º</li><li><code>Object.prototype.toString.call(value)</code> è¿”å› <code>[object &lt;TypeName&gt;]</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ å¯ä»¥å¾—åˆ°å…·ä½“çš„å€¼ç±»å‹</li></ul></li><li><p>JS æä¾›äº†å†…éƒ¨æ•°æ®ç»“æ„ï¼Œæè¿°å¯¹è±¡çš„å±æ€§ï¼Œæ§åˆ¶å…¶è¡Œä¸ºï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    value: <span class="number">123</span>,</span><br><span class="line">    writeable: <span class="literal">false</span>,</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">false</span>,</span><br><span class="line">    get: <span class="literal">undefined</span>,</span><br><span class="line">    set: <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>Object.getOwnPropertyDescriptor(obj, &#39;a&#39;)</code> å¯ä»¥è·å–å±æ€§æè¿°å¯¹è±¡</p></li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå±æ€§è¢«è®¾ç½®ä¸º <code>writeable=false</code> åï¼Œç»§æ‰¿è€…å°†æ— æ³•é‡æ–°å®šä¹‰åŒåå±æ€§ï¼›é™¤éå¯ä»¥é€šè¿‡è¦†ç›–å±æ€§æè¿°å¯¹è±¡æ¥ç»•è¿‡é™åˆ¶ </li><li><p>å¦‚æœå±æ€§çš„ <code>enumerable</code> ä¸º <code>false</code>ï¼Œåˆ™æœ‰ä¸‰ç§æ“ä½œä¸èƒ½å–åˆ°è¯¥å±æ€§ï¼š</p><ul><li><code>for...in</code> </li><li><code>Object.keys</code>ï¼šæ— æ³•è·å–å¯¹è±¡ç»§æ‰¿çš„å±æ€§ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ <code>getOwnPropertyNames</code></li><li><code>JSON.stringify</code></li></ul></li><li><p><code>configurable</code>ï¼šæ§åˆ¶æ˜¯å¦å¯ä»¥ä¿®æ”¹æè¿°ç¬¦å±æ€§ï¼Œå¹¶ä¸”å½“ <code>configurable=fasle</code> æ—¶ï¼Œæ— æ³•åˆ é™¤</p></li><li>åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºæ•°ç»„ï¼š<code>Array.isArray</code></li></ul><h1 id="é¢å‘å¯¹è±¡"><a href="#é¢å‘å¯¹è±¡" class="headerlink" title="é¢å‘å¯¹è±¡"></a>é¢å‘å¯¹è±¡</h1><ul><li>JavaScript ä¸­çš„å¯¹è±¡ä½“ç³»ï¼Œæ˜¯åŸºäºæ„é€ å‡½æ•° <code>constructor</code> å’ŒåŸå‹é“¾ <code>prototype</code> çš„ã€‚æ„é€ å‡½æ•°å°±æ˜¯å¯¹è±¡ç”Ÿæˆçš„ã€Œæ¨¡æ¿ã€</li><li><p>æ„é€ å‡½æ•°ç‰¹ç‚¹ï¼š</p><ul><li>å†…éƒ¨ä½¿ç”¨ <code>this</code>ï¼ŒæŒ‡å‘ç”Ÿæˆçš„å¯¹è±¡å®ä¾‹</li><li>éœ€è¦é…åˆ <code>new</code> å…³é”®å­—</li></ul></li><li><p><code>new</code> å¹²äº†ä»€ä¹ˆï¼š</p><ul><li>æ–°å»ºç©ºå¯¹è±¡ï¼Œä½œä¸ºè¦è¿”å›çš„å¯¹è±¡</li><li>å°†ç©ºå¯¹è±¡çš„ <code>__proto__</code> æŒ‡å‘æ„é€ å‡½æ•°çš„ <code>prototype</code></li><li>å°†è¯¥ç©ºå¯¹è±¡èµ‹å€¼ç»™å‡½æ•°å†…éƒ¨çš„ <code>this</code> å…³é”®å­—</li><li>æ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„ä»£ç </li></ul></li><li><p>å‡½æ•°å†…éƒ¨å¯ä½¿ç”¨ <code>new.target</code> åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº† <code>new</code> è°ƒç”¨æ„é€ å‡½æ•°</p></li><li><code>this</code> åœ¨å‡½æ•°ä½“å†…éƒ¨ï¼ŒæŒ‡å‘å½“å‰çš„è¿è¡Œç¯å¢ƒ</li><li>å¦‚æœ <code>this</code> æ‰€åœ¨çš„æ–¹æ³•ä¸åœ¨å¯¹è±¡çš„ç¬¬ä¸€å±‚ï¼Œè¿™æ—¶ <code>this</code> åªæ˜¯æŒ‡å‘å½“å‰ä¸€å±‚çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šç»§æ‰¿æ›´ä¸Šé¢çš„å±‚</li><li>å‡½æ•°å®ä¾‹çš„ <code>call</code> æ–¹æ³•å¯ä»¥æŒ‡å®š <code>this</code> æŒ‡å‘çš„ç¯å¢ƒï¼Œæ­¤å¤–å¯ä»¥è·³è¿‡åŒåå‡½æ•°è¦†ç›–ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹çš„å‡½æ•°ï¼›<code>appy</code> å’Œ <code>call</code> ç±»ä¼¼ï¼Œåªæ˜¯æ¥æ”¶ä¸€ä¸ªåˆ—è¡¨å‚æ•°</li><li><code>bind</code> ä¹Ÿå¯ä»¥ç»‘å®šå¯¹è±¡ï¼Œå˜æ¢ <code>this</code> æŒ‡å‘</li><li>JS ç»§æ‰¿æœºåˆ¶çš„æ ¸å¿ƒï¼šåŸå‹ä¸­æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½å¯ä»¥è¢«å¤šä¸ªå®ä¾‹å…±äº«</li><li><code>instanceof</code> è¿ç®—ç¬¦ï¼š<ul><li>åªèƒ½ç”¨äºéåŸå§‹ç±»å‹å¯¹è±¡</li><li>å¯¹è±¡çš„åŸå‹ <code>prototype</code> å‡ä¸º null æ—¶å¤±æ•ˆ</li><li><code>undefined instanceof Object</code> å’Œ <code>null instanceof Object</code> å‡ä¸º <code>false</code></li></ul></li></ul><h1 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h1><ul><li>Promise çš„å›è°ƒå‡½æ•°ä¸æ˜¯æ­£å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼Œè€Œæ˜¯<strong>å¾®ä»»åŠ¡</strong>ã€‚å‰è€…ä¼šè¿½åŠ åˆ°ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯ï¼Œè€Œå¾®ä»»åŠ¡åˆ™è¿½åŠ åˆ°æœ¬è½®äº‹ä»¶å¾ªç¯ã€‚æ‰€ä»¥å¾®ä»»åŠ¡æ‰§è¡Œè¦æ—©äºå¸¸è§„å¼‚æ­¥ä»»åŠ¡ã€‚</li><li><code>setTimeout(f, 0)</code> å¯ä»¥è®©ä»»åŠ¡åœ¨ä¸‹è½®äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œ</li></ul><h1 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h1><ul><li>å…ƒç´ çš„ <code>hidden</code> å±æ€§åªæœ‰åœ¨ CSS æ²¡æœ‰æ˜ç¡®è®¾å®šå½“å‰å…ƒç´ çš„å¯è§æ€§æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯ CSS çš„ <code>display</code> ç”¨äºå¯è§æ€§æ§åˆ¶çš„ä¼˜å…ˆçº§é«˜äºå…ƒç´ è‡ªèº«çš„ <code>hidden</code> å±æ€§</li><li>ç½‘é¡µå…ƒç´ å¯ä»¥è‡ªå®šä¹‰ <code>data-*</code> å±æ€§ï¼Œæ·»åŠ æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ <code>.dataset</code> è¿”å›æ•°æ®å¯¹è±¡</li><li>ä¸ºé˜²æ­¢é­å—æ”»å‡»ï¼Œå¯¹äºæ–‡æœ¬å†…å®¹ï¼Œå»ºè®®ä½¿ç”¨ <code>textContent</code> æ›¿ä»£ <code>innerHTML</code> è®¾ç½®æ–‡æœ¬</li></ul><h2 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h2><ul><li>CSS è´Ÿè´£è§†è§‰æ•ˆæœï¼›JavaScript è´Ÿè´£ä¸ç”¨æˆ·çš„è¡Œä¸ºäº’åŠ¨</li><li>å¯ä»¥é€šè¿‡ <code>style</code> å±æ€§è®¾ç½® CSS æ ·å¼</li><li><p><code>CSSStyleDeclaration</code> å¯¹è±¡ç”¨äºæ“ä½œå…ƒç´ çš„æ ·å¼ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å…ƒç´ çš„ <code>style</code> å±æ€§</li><li><code>CSSStyle</code> å®ä¾‹çš„ <code>style</code> å±æ€§</li><li><code>window.getComputedStyle()</code> è¿”å›å€¼ï¼ˆå…ƒç´ çš„å…¨éƒ¨æ ·å¼éœ€è¦å®ƒè·å–åˆ°ï¼‰</li></ul></li><li><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>CSSStyleDeclaration</code> çš„å±æ€§åå’ŒåŸç”Ÿ CSS è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼Œå‘½åéœ€è¦ä¿®æ”¹ï¼Œå¦‚ <code>backgroud-color</code> -&gt; <code>backgroudColor</code>ï¼›å¦‚æœæ˜¯ JS çš„ä¿ç•™å­—ï¼Œåˆ™éœ€è¦åŠ ä¸Š <code>css</code> å‰ç¼€</p></li><li>å±æ€§æ“ä½œï¼š<ul><li><code>setProperty</code></li><li><code>removeProperty</code></li></ul></li></ul><h2 id="DOM-å˜åŠ¨ç›‘æ§"><a href="#DOM-å˜åŠ¨ç›‘æ§" class="headerlink" title="DOM å˜åŠ¨ç›‘æ§"></a>DOM å˜åŠ¨ç›‘æ§</h2><ul><li>Mutation Observer APIï¼šDOM çš„å˜åŠ¨ï¼ˆèŠ‚ç‚¹å¢å‡ã€å±æ€§å˜åŠ¨ã€æ–‡æœ¬å†…å®¹å˜åŠ¨ï¼‰ï¼Œéƒ½å¯ä»¥é€šè¿‡è¯¥ API è·å¾—é€šçŸ¥</li><li>ä¸äº‹ä»¶çš„åŒºåˆ«ï¼š<ul><li>MO äº‹ä»¶æ˜¯åœ¨ DOM å˜åŠ¨æ—¶å¼‚æ­¥è§¦å‘ï¼Œå¹¶ä¸”æ˜¯ç­‰åˆ°å½“å‰æ‰€æœ‰ DOM æ“ä½œéƒ½ç»“æŸæ‰è§¦å‘</li><li>äº‹ä»¶åˆ™æ˜¯åŒæ­¥è§¦å‘ï¼ŒDOM å˜åŠ¨ç«‹åˆ»è§¦å‘</li></ul></li><li><p>æ€»ç»“æ¥è¯´ï¼š</p><ul><li>ç­‰å¾…æ‰€æœ‰è„šæœ¬ä»»åŠ¡å®Œæˆåï¼Œæ‰ä¼šè§¦å‘</li><li>æŠŠ DOM å˜åŠ¨è®°å½•å°è£…æˆä¸€ä¸ªæ•°ç»„å¤„ç†ï¼Œè€Œéæ¯æ¡éƒ½åˆ†åˆ«å¤„ç†</li><li>æ—¢å¯ä»¥è§‚å¯Ÿ DOM æ‰€æœ‰ç±»å‹å˜åŠ¨ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè§‚å¯ŸæŸç±»å˜åŠ¨</li></ul></li><li><p>ç”¨æ³•ï¼š  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutations, observer</span>) =&gt;</span> &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®šç›‘å¬çš„å…ƒç´ å’Œç±»å‹</span></span><br><span class="line"><span class="keyword">const</span> article = <span class="built_in">document</span>.querySelector(<span class="string">"article"</span>)</span><br><span class="line">observer.observe(article, &#123;<span class="string">'childList'</span>: <span class="literal">true</span>, <span class="string">'attritubes'</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure></li></ul><h1 id="äº‹ä»¶"><a href="#äº‹ä»¶" class="headerlink" title="äº‹ä»¶"></a>äº‹ä»¶</h1><ul><li><p>DOM çš„äº‹ä»¶æ“ä½œï¼ˆç›‘å¬ã€è§¦å‘ï¼‰ï¼Œéƒ½æ˜¯ <code>EventTarget</code> ä¸­å®šä¹‰çš„ã€‚ä¸»è¦æ¥å£å¦‚ä¸‹ï¼š</p><ul><li><code>addEventListener</code></li><li><code>removeEventListener</code></li><li><code>dispatchEvent</code></li></ul></li><li><p>HTML ä¸­å¯ä»¥ç›´æ¥åœ¨å…ƒç´ å±æ€§ä¸­ï¼Œå®šä¹‰æŸäº›ç›‘å¬ä»£ç ã€‚å¦‚ <code>onload</code>ï¼Œè¿™ç±»ç›‘å¬ä»£ç åªåœ¨å†’æ³¡é˜¶æ®µè§¦å‘</p></li><li>å…ƒç´ çš„ <code>onclick</code> å±æ€§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç›‘å¬å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å†’æ³¡é˜¶æ®µè§¦å‘</li><li>äº‹ä»¶ä¼ æ’­ï¼š<ul><li>ç¬¬ä¸€é˜¶æ®µï¼šä» <code>window</code> å¯¹è±¡ä¼ å¯¼åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼ˆä¸Šå±‚ä¼ åˆ°åº•å±‚ï¼‰ï¼Œå³ä¸ºã€Œæ•è·é˜¶æ®µã€ï¼ˆcapture phaseï¼‰</li><li>ç¬¬äºŒé˜¶æ®µï¼šä»ç›®æ ‡èŠ‚ç‚¹ä¸Šè§¦å‘ï¼Œå«åšã€Œç›®æ ‡é˜¶æ®µã€ï¼ˆtarget phaseï¼‰</li><li>ç¬¬ä¸‰é˜¶æ®µï¼šä»ç›®æ ‡èŠ‚ç‚¹ä¼ å¯¼å› <code>window</code> å¯¹è±¡ï¼ˆä»åº•å±‚ä¼ å›ä¸Šå±‚ï¼‰ï¼Œå«åšã€Œå†’æ³¡é˜¶æ®µã€ï¼ˆbubbling phaseï¼‰</li></ul></li><li><code>e.StopPropagation</code> åˆ™æ˜¯ä¼šé˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œä½†ä¸ä¼šå¤„ç†å…¶å®ƒçš„ç›‘å¬äº‹ä»¶</li><li><code>e.stopImmediatePropagation</code> ä¼šå½»åº•å–æ¶ˆåŒåçš„æ—¶é—´</li><li>ç½‘é¡µä¸­é™¤äº†å…ƒç´ èŠ‚ç‚¹é»˜è®¤ä¸å¯ä»¥æ‹–æ‹‰ï¼Œå…¶å®ƒï¼ˆå›¾ç‰‡ã€é“¾æ¥ã€é€‰ä¸­çš„æ–‡å­—ï¼‰éƒ½æ˜¯å¯ä»¥æ‹–æ‹‰çš„ï¼Œå¯é€šè¿‡å°†å…ƒç´ èŠ‚ç‚¹çš„ <code>draggable</code> å±æ€§è®¾ç½®ä¸º <code>true</code> å®ç°</li><li>ä¸€æ—¦æŸä¸ªå…ƒç´ èŠ‚ç‚¹è¢«è®¾ç½®ä¸ºå¯æ‹–æ‹½åï¼Œå°±æ— æ³•é€šè¿‡é¼ æ ‡é€‰ä¸­èŠ‚ç‚¹å†…éƒ¨çš„æ–‡å­—æˆ–å­èŠ‚ç‚¹äº†</li></ul><h1 id="æµè§ˆå™¨å¯¹è±¡"><a href="#æµè§ˆå™¨å¯¹è±¡" class="headerlink" title="æµè§ˆå™¨å¯¹è±¡"></a>æµè§ˆå™¨å¯¹è±¡</h1><ul><li>åµŒå…¥è„šæœ¬æ—¶ï¼Œ<code>&lt;script&gt;</code> å…ƒç´ çš„ <code>type</code> å±æ€§é»˜è®¤ä¸º <code>text/javascript</code>ï¼Œæ–°æµè§ˆå™¨å¯ä»¥å†™æˆ <code>application/javascript</code>ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸å¡«å†™ã€‚å¦å¤–ï¼Œ<code>integrity</code> å±æ€§å¯ä»¥è®¾ç½®è„šæœ¬çš„ SHA256 ç­¾åï¼Œå¯¹äºéæ³•è„šæœ¬æµè§ˆå™¨ä¼šæ‹’ç»åŠ è½½</li><li><code>async</code> å’Œ <code>defer</code> åŒæ—¶å­˜åœ¨ï¼Œåˆ™åè€…ä¸èµ·ä½œç”¨</li><li><code>window.navigator</code> æŒ‡å‘åŒ…å«æµè§ˆå™¨å’Œç³»ç»Ÿä¿¡æ¯çš„ <code>Navigator</code> å¯¹è±¡ï¼Œå¯ä»¥äº†è§£ç”¨æˆ·çš„ç¯å¢ƒä¿¡æ¯</li><li>Cookie æ˜¯æœåŠ¡å™¨ä¿å­˜åœ¨æµè§ˆå™¨çš„ä¸€å°æ®µæ–‡æœ¬ä¿¡æ¯ï¼Œæ¯ä¸ª Cookie çš„å¤§å°ä¸€èˆ¬ä¸è¶…è¿‡ 4KBï¼Œæ¯æ¬¡è¯·æ±‚æœåŠ¡å™¨ï¼Œéƒ½ä¼šé™„å¸¦è¯¥ä¿¡æ¯</li><li><p>Cookie åŒ…æ‹¬çš„ä¿¡æ¯ï¼š</p><ul><li>åå­—</li><li>å€¼</li><li>åˆ°æœŸæ—¶é—´</li><li>æ‰€å±åŸŸåï¼ˆé»˜è®¤å½“å‰åŸŸåï¼‰</li><li>ç”Ÿæ•ˆçš„è·¯å¾„ï¼ˆé»˜è®¤å½“å‰ç½‘ç«™ï¼‰</li></ul></li><li><p><strong>æµè§ˆå™¨çš„å®‰å…¨åŸºç¡€æ˜¯ã€ŒåŒæºæ”¿ç­–ã€ï¼ˆsame-origin policyï¼‰</strong></p></li><li><p>åŒæºçš„å«ä¹‰ï¼š</p><ul><li>ç›¸åŒçš„åè®®</li><li>ç›¸åŒçš„åŸŸå</li><li>ç›¸åŒçš„ç«¯å£</li></ul></li><li><p>éåŒæºçš„é™åˆ¶ï¼š</p><ul><li>æ— æ³•è¯»å–éåŒæºç½‘é¡µçš„ Cookie, LocalStorage å’Œ IndexedDB</li><li>æ— æ³•æ¥è§¦éåŒæºç½‘é¡µçš„ DOM</li><li>æ— æ³•å‘éåŒæºåœ°å€å‘é€ AJAX è¯·æ±‚ï¼ˆå³ä¾¿å‘é€ï¼Œæµè§ˆå™¨ä¹Ÿä¼šæ‹’ç»æ¥å—å“åº”ï¼‰</li></ul></li><li><p><code>document.domain</code> è®¾ç½®å¯å…±äº« Cookieï¼Œé€‚ç”¨äº ifame å’Œ Cookieï¼Œå¯¹äº LocalStorage å’Œ IndexedDB æ— æ•ˆï¼›æ­¤å¤–ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨è®¾ç½® Cookie æ—¶å°±æŒ‡å®šå¥½æ‰€å±ä¸€çº§åŸŸåï¼š<code>.example.com</code>ï¼Œä¹Ÿå¯ä»¥å¯¹å­åŸŸåè¾¾åˆ°å…±äº« Cookie çš„ç›®çš„</p></li><li><p>å¯¹äºå®Œå…¨ä¸åŒæºçš„çª—å£ï¼Œæƒ³è¦é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><code>fragment identifier</code>ï¼šç‰‡æ®µæ ‡è¯†ç¬¦ã€‚<code>http://example.com/x.html#fragment</code> åªæ˜¯æ”¹å˜ <code>#fragment</code> ä¸ä¼šå¯¼è‡´ç½‘é¡µåˆ·æ–°ï¼Œå±äºç ´è§£æ— æ³•é€šä¿¡ä¹‹æ³•</li><li>H5 æä¾›äº†æ–°çš„ <code>postMessage</code> æ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œç›‘å¬æ–¹å¯ä»¥ç›‘å¬ <code>message</code> äº‹ä»¶è·å–æ¶ˆæ¯</li></ul></li><li><p>AJAX çªç ´åŒæºé™åˆ¶çš„æ–¹æ³•ï¼š</p><ul><li>JSONP</li><li>WebSocket</li><li>CORS (Cross-Origin Resource Sharing)</li></ul></li><li><p>CORS é€šä¿¡ï¼š</p><ul><li>W3C æ ‡å‡†ï¼Œå…è®¸æµè§ˆå™¨è·¨åŸŸè¯·æ±‚</li><li><a href="https://wangdoc.com/javascript/bom/cors.html" target="_blank" rel="noopener">è¯¦ç»†ä»‹ç»</a></li><li>åŒºåˆ†ç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ï¼Œæµç¨‹ä¸åŒ</li><li>ç®€å•è¯·æ±‚ä¸­ï¼ŒOrigin Header å¾ˆé‡è¦</li><li>éç®€å•è¯·æ±‚ï¼Œå…ˆè¿›è¡Œ <code>/OPTIONS</code> é¢„å…ˆæ£€æŸ¥ï¼Œç„¶ååç»­æµç¨‹ç±»ä¼¼ç®€å•è¯·æ±‚</li></ul></li><li><p>Storage æ¥å£ï¼š</p><ul><li><code>sessionStorage</code>ï¼šä¿å­˜çš„æ•°æ®ç”¨äºæµè§ˆå™¨ä¸€æ¬¡ä¼šè¯ï¼Œç»“æŸåä¼šè¢«æ¸…ç†</li><li><code>localStorage</code> ä¿å­˜æ•°æ®é•¿æœŸå­˜åœ¨</li><li>åªæœ‰åŒåŸŸåä¸‹çš„ç½‘é¡µæ‰å¯ä»¥è¯»å–ï¼Œè·¨åŸŸä¼šæŠ¥é”™</li><li><code>length</code> è¿”å›æ•°æ®é¡¹ä¸ªæ•°</li><li><code>setItem</code> ä¿å­˜ key + value</li><li><code>getItem</code> è¿”å›ä¿å­˜çš„ key å¯¹åº”çš„ value</li><li><code>clear</code></li><li><code>key</code> è¿”å›å¯¹åº”ä½ç½®çš„é”®å€¼ </li></ul></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://wangdoc.com/javascript/events/eventtarget.html" target="_blank" rel="noopener">JavaScript å…¥é—¨</a></li></ul><ol><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript" target="_blank" rel="noopener">MDN JavaScript</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æŠ½ç©ºå­¦ä¹ äº†ä¸‹ JavaScript è¯­è¨€ï¼Œå½“ç„¶è¿˜æ˜¯å…¥é—¨çº§åˆ«çš„é‚£ç§ã€‚å­¦ä¹ è¿‡ç¨‹ä¸­ä¹Ÿåšäº†äº›ç¬”è®°ã€‚æ€»çš„æ¥è¯´ï¼ŒES5 å­¦å®Œåï¼Œå¯¹ JavaScript æœ¬èº«äº†è§£äº†å¤§æ¦‚ï¼Œè¯­è¨€æœ¬èº«è®¾è®¡ä¸Šä¹Ÿå­˜åœ¨ä¸€äº›å‘ï¼Œæ‰€ä»¥æ­é…ã€ŠJavaScript ç²¾ç²¹ã€‹è¿™æœ¬ä¹¦çœ‹çœ‹ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£æœ‰å“ªäº›æ¯”è¾ƒå¥½çš„å†™æ³•é¿å…è¸©å‘ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="å‰ç«¯" scheme="http://ifaceless.space/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="JavaScript" scheme="http://ifaceless.space/tags/JavaScript/"/>
    
      <category term="ES5" scheme="http://ifaceless.space/tags/ES5/"/>
    
  </entry>
  
  <entry>
    <title>Rocket Web æ¡†æ¶å…¥é—¨</title>
    <link href="http://ifaceless.space/2019/02/24/rust-rocket-quick-start/"/>
    <id>http://ifaceless.space/2019/02/24/rust-rocket-quick-start/</id>
    <published>2019-02-24T15:23:30.000Z</published>
    <updated>2019-06-24T00:49:40.533Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><a href="https://rocket.rs/" target="_blank" rel="noopener">Rocket æ¡†æ¶</a> æ˜¯ Rust ç”Ÿæ€ä¸­æ¯”è¾ƒæµè¡Œçš„ Web æ¡†æ¶ä¹‹ä¸€ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ‹¥æœ‰ç±»ä¼¼ Flask é‚£æ ·æ¯”è¾ƒç®€æ´çš„å†™æ³•ï¼Œå¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™ RESTful APIï¼ŒåŒæ—¶è¿˜æ”¯æŒä¸­é—´ä»¶ç­‰æœºåˆ¶ï¼Œæ˜“äºæ‰©å±•ã€‚å½“ç„¶ï¼Œç›®å‰è¯¥æ¡†æ¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯ä½¿ç”¨äº†å¾ˆå¤š rust-nightly ç‰ˆæœ¬ä¸­çš„ç‰¹æ€§ï¼Œå¯¼è‡´æ— æ³•åœ¨ rust-stable åˆ†æ”¯ä¸‹ç¼–è¯‘ã€‚è¿™å¯¹äºä¸€ä¸ªéœ€è¦é•¿æœŸç»´æŠ¤çš„è¾ƒå¤§çš„é¡¹ç›®æ¥è¯´ï¼Œå°±å­˜åœ¨ä¸€å®šçš„å‡çº§é£é™©ã€‚ä¸è¿‡é‰´äºç›®å‰æˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Rust æ¥ç¼–å†™ Web APIï¼Œæš‚ä¸”è¿˜ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚</p><a id="more"></a><h1 id="ä½ å¥½ï¼ŒRocket"><a href="#ä½ å¥½ï¼ŒRocket" class="headerlink" title="ä½ å¥½ï¼ŒRocket"></a>ä½ å¥½ï¼ŒRocket</h1><p><em>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯åœ¨ <code>rustc 1.34.0-nightly</code> ç¯å¢ƒä¸‹ç¼–è¯‘å¹¶è¿è¡Œçš„~</em></p><p>é¦–å…ˆï¼Œéœ€è¦æ–°å»ºé¡¹ç›® <code>hello-rocket</code>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new hello-rocket --bin</span><br></pre></td></tr></table></figure></p><p>ç”±äºéœ€è¦ä½¿ç”¨ rust-nightly ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åˆ‡æ¢ç‰ˆæœ¬å¹¶æ›´æ–°å·¥å…·é“¾ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å°†å½“å‰é¡¹ç›®ç¯å¢ƒåˆ‡åˆ° nightly ç‰ˆæœ¬</span><br><span class="line">rustup override set nightly &amp;&amp; rustup update</span><br></pre></td></tr></table></figure></p><p>å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬å°±éœ€è¦ç»™é¡¹ç›®æ·»åŠ  <code>rocket</code> crate ä¾èµ–å•¦ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo add rocket</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨ <code>Cargo.toml</code> ä¸­çœ‹åˆ°æ·»åŠ çš„ä¾èµ–ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rocket</span> = <span class="string">"0.4.0"</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <code>main.rs</code> ä¸­ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„ APIï¼Œè´Ÿè´£åœ¨è®¿é—®å¯¹åº”è·¯ç”±æ—¶æ‰“å°å‡º <code>Hello, Rocket</code>ã€‚å¯ä»¥å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°ä½ çš„æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(proc_macro_hygiene, decl_macro)]</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬éœ€è¦ä½¿ç”¨ rocket ä¸­å®šä¹‰çš„è·¯ç”±åˆ›å»ºå® `routes!`</span></span><br><span class="line"><span class="meta">#[macro_use]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> rocket;</span><br><span class="line"><span class="meta">#[get(<span class="meta-string">"/"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">index</span></span>() -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="string">"Hello, Rocket"</span>.to_string()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    rocket::ignite().mount(<span class="string">"/"</span>, routes![index]).launch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±å®Œæˆäº†ä¸€ä¸ªæœ€ç®€å•çš„ API ç¼–å†™ã€‚æœ€åç¼–è¯‘å¹¶å¯åŠ¨ Web æœåŠ¡åï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚ä½ å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>localhost:8000</code> æ¥æŸ¥çœ‹å“åº”å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Configured for development.</span><br><span class="line">    =&gt; address: localhost</span><br><span class="line">    =&gt; port: 8000</span><br><span class="line">    =&gt; log: normal</span><br><span class="line">    =&gt; workers: 8</span><br><span class="line">    =&gt; secret key: generated</span><br><span class="line">    =&gt; limits: forms = 32KiB</span><br><span class="line">    =&gt; keep-alive: 5s</span><br><span class="line">    =&gt; tls: disabled</span><br><span class="line">Mounting /:</span><br><span class="line">    =&gt; GET / (index)</span><br><span class="line">Rocket has launched from http://localhost:8000</span><br></pre></td></tr></table></figure><h1 id="Rocket-çš„ç‰¹æ€§"><a href="#Rocket-çš„ç‰¹æ€§" class="headerlink" title="Rocket çš„ç‰¹æ€§"></a>Rocket çš„ç‰¹æ€§</h1><p>åœ¨å…¶å®˜ç½‘çš„ Overview ä¸­ï¼Œå¯ä»¥çœ‹åˆ° Rocket æ¡†æ¶çš„ä¸»è¦ç‰¹æ€§ã€‚</p><h2 id="è·¯ç”±ï¼ˆRoutingï¼‰"><a href="#è·¯ç”±ï¼ˆRoutingï¼‰" class="headerlink" title="è·¯ç”±ï¼ˆRoutingï¼‰"></a>è·¯ç”±ï¼ˆRoutingï¼‰</h2><p>Rocket çš„ä¸»è¦ä»»åŠ¡ä¾¿æ˜¯è·¯ç”±è¯·æ±‚åˆ°åˆé€‚çš„è¯·æ±‚å¤„ç† Handlerã€‚è·¯ç”±æ˜¯é€šè¿‡ <code>get</code> å±æ€§å£°æ˜çš„ï¼Œçœ‹èµ·æ¥åƒæ˜¯ Python ä¸­çš„è£…é¥°å™¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[get(<span class="meta-string">"/"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">index</span></span>() -&gt; &amp;<span class="symbol">'static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">    <span class="string">"Hello, Rocket!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé¢çš„ä»£ç å—ä¸ºä¾‹ï¼Œè¿™ä¸ªè·¯ç”±çš„åç§°ä¸º <code>index</code>ï¼Œå’Œ <code>HTTP GET /</code> åŒ¹é…ã€‚è¯·æ±‚å¤„ç†å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º HTTP å“åº”çš„ bodyã€‚</p><h2 id="åŠ¨æ€å‚æ•°ï¼ˆDynamic-Paramsï¼‰"><a href="#åŠ¨æ€å‚æ•°ï¼ˆDynamic-Paramsï¼‰" class="headerlink" title="åŠ¨æ€å‚æ•°ï¼ˆDynamic Paramsï¼‰"></a>åŠ¨æ€å‚æ•°ï¼ˆDynamic Paramsï¼‰</h2><p>Rocket å¯ä»¥åŠ¨æ€åœ°è¯†åˆ«è¯·æ±‚è·¯å¾„å¤šä¸ªéƒ¨åˆ†ï¼Œå¹¶å’Œå¤„ç†å‡½æ•°çš„å‚æ•°ä¸€ä¸€åŒ¹é…ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[get(<span class="meta-string">"/hello/&lt;name&gt;/&lt;age&gt;"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>(name: <span class="built_in">String</span>, age: <span class="built_in">u8</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">"Hello, &#123;&#125; year old, named &#123;&#125;!"</span>, age, name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹è¡¨ç¤ºï¼Œ<code>hello</code> è·¯ç”±ä¼šåŠ¨æ€åŒ¹é…åˆ°è·¯å¾„ä¸­çš„ <code>&lt;name&gt;</code> å’Œ <code>&lt;age&gt;</code> éƒ¨åˆ†ã€‚æ¯ä¸ªåŠ¨æ€å‚æ•°éƒ½è¦æœ‰å…·ä½“çš„ç±»å‹ï¼ŒRocket ä¼šå°è¯•å°† <code>path</code> ä¸­å¯¹åº”ä½ç½®çš„å‚æ•°è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ã€‚åªæœ‰å‚æ•°æ­£ç¡®è½¬æ¢åï¼Œæ‰ä¼šè°ƒç”¨ç›¸åº”çš„è·¯ç”±å¤„ç†å‡½æ•°ã€‚ä¸ºäº†è§£æå­—ç¬¦ä¸²ï¼ŒRocket ä¼šä½¿ç”¨ <code>FromParam</code> traitï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºè‡ªå®šä¹‰ç±»å‹å®ç°è¯¥ traitã€‚</p><h2 id="è¯·æ±‚æ•°æ®å¤„ç†ï¼ˆHandling-Dataï¼‰"><a href="#è¯·æ±‚æ•°æ®å¤„ç†ï¼ˆHandling-Dataï¼‰" class="headerlink" title="è¯·æ±‚æ•°æ®å¤„ç†ï¼ˆHandling Dataï¼‰"></a>è¯·æ±‚æ•°æ®å¤„ç†ï¼ˆHandling Dataï¼‰</h2><p>è¯·æ±‚çš„ body æ•°æ®æ˜¯é€šè¿‡ <code>FromData</code> trait æ¥å¤„ç†çš„ã€‚è¯·æ±‚çš„ body æ•°æ®å¯ä»¥æ´¾ç”Ÿä»»ä½•å®ç°äº† <code>FromData</code> çš„ç±»å‹ã€‚ä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·æŒ‡å®šæœŸæœ›é€šè¿‡å“ªä¸ªå‚æ•°ä½¿ç”¨è¯·æ±‚çš„ bodyï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[post(<span class="meta-string">"/login"</span>, data = <span class="meta-string">"&lt;user_form&gt;"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">login</span></span>(user_form: Form&lt;UserLogin&gt;) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">"Hello, &#123;&#125;!"</span>, user_form.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Form</code> ç±»å‹æ˜¯ Rocket å†…å»ºçš„ç±»å‹ï¼Œå®ƒå¯ä»¥å°† Web è¡¨å•è½¬æ¢æˆç»“æ„ä½“ã€‚Rocket ä¼šè‡ªåŠ¨å°è¯•å°†è¯·æ±‚çš„ body æ•°æ®è½¬æ¢æˆ <code>Form</code>ï¼Œç„¶ååœ¨è½¬æ¢æˆåŠŸåè°ƒç”¨ <code>login</code> å¤„ç†å‡½æ•°ã€‚å…¶å®ƒå†…å»ºçš„ <code>FormData</code> ç±»å‹è¿˜æœ‰ <code>Data</code>ã€<code>Json</code> å’Œ <code>Flash</code>ã€‚</p><h2 id="è¯·æ±‚æŠ¤å«ï¼ˆRequest-Guardsï¼‰"><a href="#è¯·æ±‚æŠ¤å«ï¼ˆRequest-Guardsï¼‰" class="headerlink" title="è¯·æ±‚æŠ¤å«ï¼ˆRequest Guardsï¼‰"></a>è¯·æ±‚æŠ¤å«ï¼ˆRequest Guardsï¼‰</h2><p>é™¤äº†åŠ¨æ€è·¯å¾„å’Œæ•°æ®å‚æ•°å¤–ï¼Œè¯·æ±‚å¤„ç†å‡½æ•°è¿˜å¯ä»¥åŒ…å«ç¬¬ä¸‰ç§ç±»å‹çš„å‚æ•°ï¼š<em>request guards</em>ã€‚<em>Request guards</em> ä¸ç”¨åœ¨è·¯ç”±å±æ€§ä¸­å£°æ˜ï¼Œè€Œæ˜¯å‡ºç°åœ¨è¯·æ±‚å¤„ç†å‡½æ•°çš„å‚æ•°ç­¾åä¸­ï¼Œå¹¶ä¸”æ”¯æŒä»»æ„å¤šä¸ªã€‚</p><p><em>Request guards</em> çš„ä½œç”¨æ˜¯å¯¹è¯·æ±‚çš„å…ƒä¿¡æ¯è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³æŒ‡å®šæ¡ä»¶ï¼Œæ‰è¿è¡Œå¤„ç†å‡½æ•°ï¼Œèµ·åˆ°ä¿æŠ¤ä½œç”¨ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[get(<span class="meta-string">"/sensitive"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">sensitive</span></span>(key: ApiKey) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å­ä¸­ <code>ApiKey</code> ç”¨äºä¿æŠ¤ <code>sensitive</code> å¤„ç†å‡½æ•°ï¼Œåªæœ‰åœ¨è¯·æ±‚å¤´ä¸­çš„ API å¯†é’¥è®¤è¯é€šè¿‡åï¼Œæ‰ä¼šæ‰§è¡Œã€‚<code>ApiKey</code> ç±»å‹éœ€è¦è¿‡å®ç° <code>FromRequest</code> traitï¼Œç„¶ååœ¨å®ç°é€»è¾‘ä¸­æ£€æŸ¥ API å¯†é’¥å¤´ã€‚<em>Request guards</em> æ˜¯ Rocket ä¸­éå¸¸å¼ºå¤§ä¸”ç‹¬ç‰¹çš„æ¦‚å¿µã€‚</p><h2 id="å“åº”ï¼ˆResponderï¼‰"><a href="#å“åº”ï¼ˆResponderï¼‰" class="headerlink" title="å“åº”ï¼ˆResponderï¼‰"></a>å“åº”ï¼ˆResponderï¼‰</h2><p>è¯·æ±‚å¤„ç†å‡½æ•°çš„è¿”å›ç±»å‹å¯ä»¥æ˜¯ä»»ä½•å®ç°äº† <code>Responder</code> çš„ç±»å‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[get(<span class="meta-string">"/"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">route</span></span>() -&gt; T &#123;&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>T</code> å¿…é¡»è¦å®ç° <code>Responder</code>ã€‚Rocket å·²ç»ä¸ºæ ‡å‡†åº“ä¸­å¾ˆå¤šç±»å‹å®ç°äº† <code>Responder</code>ï¼š<code>&amp;str</code>ã€<code>String</code>ã€<code>File</code>ã€<code>Option</code> ä»¥åŠ <code>Result</code>ã€‚Rocket ä¹Ÿå®ç°äº†ä¸€äº›è‡ªå®šä¹‰çš„ <code>Responder</code>ï¼Œå¦‚ <code>Redirect</code>ã€<code>Flash</code> å’Œ <code>Template</code>ã€‚</p><p><code>Responder</code> çš„ä»»åŠ¡å°±æ˜¯å°½å¯èƒ½ç”Ÿæˆ <code>Response</code>ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å¤±è´¥æ—¶æä¾›çŠ¶æ€ç ã€‚å¦‚æœæŒ‡å®šäº†çŠ¶æ€ç ï¼ŒRocket å°±ä¼šè°ƒç”¨ç›¸åº”çš„é”™è¯¯æ•è·å‡½æ•°ã€‚<code>catch</code> è·¯ç”±çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[catch(404)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">not_found</span></span>() -&gt; T &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿è¡Œï¼ˆLaunchingï¼‰"><a href="#è¿è¡Œï¼ˆLaunchingï¼‰" class="headerlink" title="è¿è¡Œï¼ˆLaunchingï¼‰"></a>è¿è¡Œï¼ˆLaunchingï¼‰</h2><p>ä¸ºäº†è¿è¡Œ Rocket åº”ç”¨ï¼Œé¦–å…ˆéœ€è¦æŒ‚è½½è·¯ç”±ï¼›ç„¶åæ‰å¯ä»¥å¯åŠ¨ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rocket::ignite()</span><br><span class="line">    .mount(<span class="string">"/base"</span>, routes![index, another])</span><br><span class="line">    .launch();</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>launch</code> åä¼šå¯åŠ¨æœåŠ¡å™¨ï¼Œå¼€å‘ç¯å¢ƒä¸­ï¼ŒRocket ä¼šæ‰“å°å‡ºä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„çŠ¶æ€ä¿¡æ¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ğŸš€  Rocket has launched from http:<span class="comment">//localhost:8000</span></span><br></pre></td></tr></table></figure><h1 id="Rocket-æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"><a href="#Rocket-æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ" class="headerlink" title="Rocket æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"></a>Rocket æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h1><p>æ¯ä¸€ä¸ª Rocket Web åº”ç”¨ä»æ¥å—åˆ°è¯·æ±‚åˆ°è¿›è¡Œå“åº”ï¼Œéƒ½ä¼šç»å†æ ‡å‡†çš„ä¸‰ä¸ªæ­¥éª¤ï¼ˆè¿™ä¹Ÿæ˜¯å¸¸è§„ Web æ¡†æ¶éƒ½ä¼šåšçš„äº‹æƒ…ï¼‰ã€‚</p><h2 id="æ ¡éªŒ"><a href="#æ ¡éªŒ" class="headerlink" title="æ ¡éªŒ"></a>æ ¡éªŒ</h2><p>é¦–å…ˆï¼ŒRocket ä¼šæ ¡éªŒåŒ¹é…çš„è¯·æ±‚ï¼Œç¡®ä¿å¤„ç†å‡½æ•°ä¸­çš„æ¯ä¸ªç±»å‹éƒ½å¯ä»¥æ´¾ç”Ÿè‡ªå½“å‰è¯·æ±‚ã€‚å¦‚æœæŸä¸ªç±»å‹æ— æ³•æ´¾ç”Ÿï¼Œåˆ™ä¼šå®šå‘åˆ°ä¸‹ä¸€ä¸ªåŒ¹é…çš„è·¯ç”±ï¼Œç›´åˆ°æ‰€æœ‰ç±»å‹æ ¡éªŒéƒ½æ²¡é—®é¢˜æˆ–è€…æ²¡æœ‰ä»»ä½•å¯å°è¯•çš„è·¯ç”±ä¸ºæ­¢ã€‚å¦‚æœæ‰€æœ‰çš„è·¯ç”±éƒ½ä¸åŒ¹é…ï¼Œåˆ™ä¼šè¿”å›è‡ªå®šä¹‰çš„ 404 é”™è¯¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[post(<span class="meta-string">"/user"</span>, data = <span class="meta-string">"&lt;new_user&gt;"</span>)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">new_user</span></span>(admin: AdminUser, new_user: Form&lt;User&gt;) -&gt; T &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿°ä¾‹å­æ¥è¯´æ˜ï¼š</p><ol><li>è¯·æ±‚æ–¹æ³•å¿…é¡»æ˜¯ <code>POST</code></li><li>è¯·æ±‚è·¯å¾„å¿…é¡»æ˜¯ <code>/user</code></li><li>è¯·æ±‚ä¸­å¿…é¡»åŒ…å« <code>body</code> æ•°æ®</li><li>è¯·æ±‚çš„å…ƒä¿¡æ¯å¿…é¡»æ˜¯é€šè¿‡è®¤è¯çš„ <code>AdminUser</code></li><li>è¯·æ±‚ä½“å¿…é¡»èƒ½å¤Ÿè½¬æ¢æˆ <code>User</code> ç»“æ„ä½“</li></ol><h2 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h2><p>æ¥ä¸‹æ¥ï¼Œè¯·æ±‚ä¼šè¢«ä»»æ„çš„ Handler å¤„ç†ã€‚è¿™é‡Œå°±æ˜¯æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘äº†ã€‚Rocket ä¸­çš„ Handler å°±æ˜¯ç®€å•çš„å‡½æ•°ï¼Œå”¯ä¸€è¦æ³¨æ„çš„æ˜¯è¿”å›å€¼å¿…é¡»è¦æ˜¯å®ç°äº† <code>Responder</code> trait çš„ç±»å‹ã€‚</p><h2 id="å“åº”"><a href="#å“åº”" class="headerlink" title="å“åº”"></a>å“åº”</h2><p>æœ€åï¼ŒRocket ä¼šå°† Handler è¿”å›å€¼è½¬æ¢æˆ HTTP å“åº”ï¼Œç„¶åç»™å®¢æˆ·ç«¯å‘é€å“åº”ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">route</span></span>() -&gt; T &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¾‹å­ä¸­çš„ <code>T</code> å¿…é¡»æ˜¯å®ç°äº† <code>Responder</code> çš„ç±»å‹ï¼ŒRocket ç›®å‰æä¾›äº†å¾ˆå¤šå¸¸ç”¨çš„å“åº”ç±»å‹ï¼š</p><ol><li><code>Json&lt;T&gt;</code>: å°†ç±»å‹ <code>T</code> è½¬æ¢æˆ JSON å¹¶è¿”å›</li><li><code>Template</code>: æ¸²æŸ“æ¨¡æ¿å¹¶è¿”å›</li><li><code>Redirect</code>: è¿”å›åˆé€‚çš„é‡å®šå‘å“åº”</li><li><code>NamedFile</code>: å‘å®¢æˆ·ç«¯æµä¼ è¾“æŒ‡å®šçš„æ–‡ä»¶ï¼Œ<code>Content-Type</code> è®¾ç½®ä¸ºæ–‡ä»¶å¤¹çš„æ‰©å±•å</li><li><code>Stream</code>: å‘å®¢æˆ·ç«¯æµä¼ è¾“ä»»æ„ <code>Read</code> å€¼</li></ol><h1 id="æ›´å¤šæ‰©å±•åŠŸèƒ½"><a href="#æ›´å¤šæ‰©å±•åŠŸèƒ½" class="headerlink" title="æ›´å¤šæ‰©å±•åŠŸèƒ½"></a>æ›´å¤šæ‰©å±•åŠŸèƒ½</h1><p>Rocket æ¡†æ¶å¯æ’æ‹”çš„ç‰¹æ€§èƒ½èƒ½å¤Ÿç»™ä½ å¸¦æ¥å¾ˆå¤šé¢å¤–çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨å…¶æ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚</p><ol><li><a href="https://rocket.rs/v0.4/guide/responses/#templates" target="_blank" rel="noopener">æ¨¡æ¿</a></li><li><a href="https://rocket.rs/v0.4/guide/requests/#cookies" target="_blank" rel="noopener">Cookies</a></li><li><a href="https://rocket.rs/v0.4/guide/requests/#streaming" target="_blank" rel="noopener">æµä¼ è¾“</a></li><li><a href="https://rocket.rs/v0.4/guide/configuration/#environment" target="_blank" rel="noopener">æ˜“äºé…ç½®çš„å¼€å‘ç¯å¢ƒ</a></li><li><a href="https://rocket.rs/v0.4/guide/testing#testing" target="_blank" rel="noopener">å†…å»ºå•å…ƒæµ‹è¯•å·¥å…·</a></li><li><a href="https://rocket.rs/v0.4/guide/responses/#typed-uris" target="_blank" rel="noopener">ç±»å‹å®‰å…¨çš„ URIs</a></li></ol><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://rocket.rs/v0.4/overview/" target="_blank" rel="noopener">Rocket Overview</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://rocket.rs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Rocket æ¡†æ¶&lt;/a&gt; æ˜¯ Rust ç”Ÿæ€ä¸­æ¯”è¾ƒæµè¡Œçš„ Web æ¡†æ¶ä¹‹ä¸€ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ‹¥æœ‰ç±»ä¼¼ Flask é‚£æ ·æ¯”è¾ƒç®€æ´çš„å†™æ³•ï¼Œå¯ä»¥éå¸¸è½»æ¾åœ°ç¼–å†™ RESTful APIï¼ŒåŒæ—¶è¿˜æ”¯æŒä¸­é—´ä»¶ç­‰æœºåˆ¶ï¼Œæ˜“äºæ‰©å±•ã€‚å½“ç„¶ï¼Œç›®å‰è¯¥æ¡†æ¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯ä½¿ç”¨äº†å¾ˆå¤š rust-nightly ç‰ˆæœ¬ä¸­çš„ç‰¹æ€§ï¼Œå¯¼è‡´æ— æ³•åœ¨ rust-stable åˆ†æ”¯ä¸‹ç¼–è¯‘ã€‚è¿™å¯¹äºä¸€ä¸ªéœ€è¦é•¿æœŸç»´æŠ¤çš„è¾ƒå¤§çš„é¡¹ç›®æ¥è¯´ï¼Œå°±å­˜åœ¨ä¸€å®šçš„å‡çº§é£é™©ã€‚ä¸è¿‡é‰´äºç›®å‰æˆ‘ä»¬ä¸å¤§å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Rust æ¥ç¼–å†™ Web APIï¼Œæš‚ä¸”è¿˜ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="http://ifaceless.space/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Web" scheme="http://ifaceless.space/tags/Web/"/>
    
      <category term="Rust" scheme="http://ifaceless.space/tags/Rust/"/>
    
      <category term="Rocket" scheme="http://ifaceless.space/tags/Rocket/"/>
    
  </entry>
  
  <entry>
    <title>Thrift åˆæ¢</title>
    <link href="http://ifaceless.space/2019/02/18/explore-thrift/"/>
    <id>http://ifaceless.space/2019/02/18/explore-thrift/</id>
    <published>2019-02-18T09:27:18.000Z</published>
    <updated>2019-11-24T09:45:59.935Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>çŸ¥ä¹ä½¿ç”¨çš„ RPC æ¡†æ¶æ˜¯åŸºäº Thrift æ„å»ºçš„ã€‚è‡ªç„¶å°±å¾ˆæœ‰å¿…è¦äº†è§£ä¸‹ Thrift æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿä»¥åŠæœ‰ä»€ä¹ˆæœ€ä½³å®è·µï¼Ÿ</p><p>Thrift å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»è‡ªå·±çš„ï¼š</p><blockquote><p>Thrift is a software framework for scalable cross-language services development. It combines a software stack with a code generation engine to build services that work efficiently and seamlessly between C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, and OCaml.</p></blockquote><h1 id="Thrift-åè®®æ ˆæ¦‚è§ˆ"><a href="#Thrift-åè®®æ ˆæ¦‚è§ˆ" class="headerlink" title="Thrift åè®®æ ˆæ¦‚è§ˆ"></a><a name="thrift-protocol-stack-overview"></a>Thrift åè®®æ ˆæ¦‚è§ˆ</h1><p>ä»¥ä¸‹æ˜¯ Thrift åè®®æ ˆç¤ºæ„å›¾ï¼š</p><p><img src="./thrift-proto-stack.png" alt=""></p><ul><li><code>Input Code</code>ï¼šæ˜¯ä¾ç…§ Thrift è¯­æ³•ç¼–å†™çš„æœåŠ¡ï¼ˆåŒ…å«å˜é‡ã€æœåŠ¡æ–¹æ³•ã€å¼‚å¸¸ç­‰å®šä¹‰ï¼‰</li><li><code>Generated Code</code>ï¼šä½¿ç”¨ <code>thrift gen</code> ç¼–è¯‘ç”Ÿæˆçš„æŒ‡å®šæŸç§è¯­è¨€çš„å®¢æˆ·ç«¯ä»£ç ï¼Œä»¥ä¾¿äºåœ¨ä¸šåŠ¡ä¸­è°ƒç”¨æœåŠ¡çš„ RPC æ¥å£<ul><li><code>Service Client</code></li><li><code>write()/read()</code></li></ul></li><li><code>TProtocol</code>ï¼šæä¾›äº†å¯é€‰çš„åè®®å±‚</li><li><code>TTransport</code>ï¼šæä¾›äº†æ»¡è¶³ä¸åŒéœ€æ±‚çš„ä¼ è¾“å±‚æœåŠ¡</li></ul><h2 id="è¿è¡Œæ—¶åº“ï¼ˆRuntime-Libraryï¼‰"><a href="#è¿è¡Œæ—¶åº“ï¼ˆRuntime-Libraryï¼‰" class="headerlink" title="è¿è¡Œæ—¶åº“ï¼ˆRuntime Libraryï¼‰"></a>è¿è¡Œæ—¶åº“ï¼ˆRuntime Libraryï¼‰</h2><p>æ•´ä¸ªåè®®å±‚å’Œä¼ è¾“å±‚éƒ½æ˜¯è¿è¡Œæ—¶åº“çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šå±‚å®šä¹‰å¥½æœåŠ¡åï¼Œåœ¨éœ€è¦çš„æ—¶å€™éšæ—¶æ›¿æ¢åè®®å±‚æˆ–ä¼ è¾“å±‚ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ã€‚</p><h3 id="åè®®å±‚ï¼ˆProtocol-Layerï¼‰"><a href="#åè®®å±‚ï¼ˆProtocol-Layerï¼‰" class="headerlink" title="åè®®å±‚ï¼ˆProtocol Layerï¼‰"></a>åè®®å±‚ï¼ˆProtocol Layerï¼‰</h3><p>åè®®å±‚çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œç›®å‰æ”¯æŒçš„ç±»å‹å¦‚ä¸‹ï¼š</p><ul><li><code>TBinaryProtocol</code>ï¼šç›´æ¥äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ•°å­—ä¼šè¢«ç¼–ç æˆäºŒè¿›åˆ¶ï¼Œè€Œéæ–‡æœ¬</li><li><code>TCompactProtocol</code>ï¼šå¼‚å¸¸é«˜æ•ˆã€ç´§å‡‘çš„æ•°æ®ç¼–ç æ ¼å¼</li><li><code>TDenseProtocol</code>ï¼šç±»ä¼¼äº <code>TCompactProtocol</code>ï¼Œä½†æ˜¯åœ¨ä¼ è¾“æ—¶ä¼šç§»é™¤ meta ä¿¡æ¯ï¼Œè€Œåœ¨æ¥æ”¶æ—¶è¡¥å› meta ä¿¡æ¯</li><li><code>TJSONProtocol</code>ï¼šä½¿ç”¨ JSON æ ¼å¼è¿›è¡Œç¼–ç </li><li><code>TSimpleJSONProtocol</code>ï¼šä½¿ç”¨ JSON ç¼–ç ï¼Œä¸”åªç”¨äºå†™çš„åè®®ã€‚é€‚ç”¨äºè„šæœ¬è¯­è¨€è§£æ</li><li><code>TDebugProtocol</code>ï¼šä½¿ç”¨äººç±»å‹å¥½çš„æ–‡æœ¬æ ¼å¼ï¼Œä¾¿äºè°ƒè¯•</li></ul><h3 id="æœåŠ¡ç«¯æ”¯æŒ"><a href="#æœåŠ¡ç«¯æ”¯æŒ" class="headerlink" title="æœåŠ¡ç«¯æ”¯æŒ"></a>æœåŠ¡ç«¯æ”¯æŒ</h3><p>ä¼ è¾“å±‚è´Ÿè´£è¯»å–å’Œå†™å…¥ã€‚ç›®å‰æ”¯æŒçš„å‡ ç§æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li><code>TSocket</code>ï¼šä½¿ç”¨é˜»å¡å¼ç½‘ç»œ IO ä¼ è¾“</li><li><code>TFramedTransport</code>ï¼šé€å¸§å‘é€æ•°æ®ï¼Œæ¯å¸§æ•°æ®éƒ½åœ¨å‰é¢åŠ ä¸Šé•¿åº¦ä¿¡æ¯ã€‚å¯¹äºä½¿ç”¨éé˜»å¡å¼çš„æœåŠ¡æ¥è¯´ï¼Œéœ€è¦ä½¿ç”¨è¿™ç§ä¼ è¾“æ–¹æ³•</li><li><code>TFileTransport</code>ï¼šä½¿ç”¨æ–‡ä»¶ä½œä¸ºä¼ é€åª’ä»‹</li><li><code>TMemoryTransport</code>ï¼šå€ŸåŠ©å†…å®¹ä¼ è¾“ã€‚Java çš„å®ç°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ <code>ByteArrayOutputStream</code> æ¥å®ç°</li><li><code>TZlibTransport</code>ï¼šä½¿ç”¨ <code>zlib</code> å‹ç¼©ï¼Œå¯ä»¥å’Œå…¶å®ƒä¼ è¾“æ–¹å¼ç»„åˆåœ¨ä¸€å—</li></ul><h2 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h2><p><code>Processor</code> å°†è¾“å…¥å’Œè¾“å‡ºåè®®ä½œä¸ºå‚æ•°ã€‚å®ƒè´Ÿè´£ä»è¾“å…¥è¯»å–æ•°æ®ï¼Œé€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰çš„ Handler å¤„ç†æ•°æ®ï¼Œç„¶åå†å°†æ•°æ®å†™åˆ°è¾“å‡ºã€‚</p><h2 id="æ”¯æŒçš„æœåŠ¡æ¨¡å¼ï¼ˆSupported-Serversï¼‰"><a href="#æ”¯æŒçš„æœåŠ¡æ¨¡å¼ï¼ˆSupported-Serversï¼‰" class="headerlink" title="æ”¯æŒçš„æœåŠ¡æ¨¡å¼ï¼ˆSupported Serversï¼‰"></a>æ”¯æŒçš„æœåŠ¡æ¨¡å¼ï¼ˆSupported Serversï¼‰</h2><p>æœåŠ¡å™¨è‡ªç„¶æ˜¯ç”¨äºåœ¨æŒ‡å®šç«¯å£ç›‘å¬è¯·æ±‚ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®å‘é€åˆ° <code>Processor</code> å¤„ç†ã€‚æœ‰è¿™ä¹ˆå‡ ç§æœåŠ¡å¯ä»¥ç”¨ä½¿ç”¨ï¼š</p><ul><li><code>TSimpleServer</code>ï¼šå•çº¿ç¨‹é˜»å¡ IOï¼Œæ–¹ä¾¿æµ‹è¯•</li><li><code>ThreadPoolServer</code>ï¼šå¤šçº¿ç¨‹é˜»å¡ IO</li><li><code>TNonblockingServer</code>ï¼šå¤šçº¿ç¨‹éé˜»å¡ IOï¼Œéœ€è¦ä½¿ç”¨ <code>TFramedTransport</code> ä¼ è¾“æ–¹å¼</li></ul><h1 id="Thrift-è¯­è¨€æŒ‡å—"><a href="#Thrift-è¯­è¨€æŒ‡å—" class="headerlink" title="Thrift è¯­è¨€æŒ‡å—"></a>Thrift è¯­è¨€æŒ‡å—</h1><h2 id="ç±»å‹ç³»ç»Ÿ"><a href="#ç±»å‹ç³»ç»Ÿ" class="headerlink" title="ç±»å‹ç³»ç»Ÿ"></a>ç±»å‹ç³»ç»Ÿ</h2><p>Thrift ç±»å‹ç³»ç»Ÿä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>é¢„å®šä¹‰çš„åŸºæœ¬ç±»å‹</li><li>ç”¨æˆ·å®šä¹‰çš„ç»“æ„ä½“</li><li>å®¹å™¨ç±»å‹</li><li>å¼‚å¸¸</li><li>æœåŠ¡</li></ul><h3 id="åŸºæœ¬ç±»å‹"><a href="#åŸºæœ¬ç±»å‹" class="headerlink" title="åŸºæœ¬ç±»å‹"></a>åŸºæœ¬ç±»å‹</h3><ul><li><code>bool</code>ï¼šå¸ƒå°”ç±»å‹ï¼ˆå¯é€‰å€¼ <code>true</code> æˆ– <code>false</code>ï¼‰ï¼Œå ç”¨ä¸€ä¸ªå­—èŠ‚</li><li><code>byte</code>ï¼šæœ‰ç¬¦å·å•å­—èŠ‚</li><li><code>i16</code>ï¼š16 ä½æœ‰ç¬¦å·æ•´å‹</li><li><code>i32</code>ï¼š32 ä½æœ‰ç¬¦å·æ•´å‹</li><li><code>i64</code>ï¼š64 ä½æœ‰ç¬¦å·æ•´å‹</li><li><code>double</code>ï¼š64 ä½æµ®ç‚¹æ•°ç±»å‹</li><li><code>binary</code>ï¼šå­—èŠ‚ä¸²</li><li><code>string</code>ï¼šç¼–ç æœªçŸ¥æ–‡æœ¬æˆ–äºŒè¿›åˆ¶å­—ç¬¦ä¸²</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒThrfit å¹¶ä¸æ”¯æŒæ— ç¬¦å·æ•´æ•°ï¼Œå› ä¸ºåœ¨å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸­å¹¶æ²¡æœ‰ç›´æ¥çš„æ˜ å°„ã€‚</p><h3 id="å®¹å™¨"><a href="#å®¹å™¨" class="headerlink" title="å®¹å™¨"></a>å®¹å™¨</h3><ul><li><code>list&lt;T&gt;</code>ï¼šåˆ—è¡¨ï¼Œç±»ä¼¼ Python ä¸­çš„ <code>list</code></li><li><code>set&lt;T&gt;</code>ï¼šæ— åºé›†åˆ</li><li><code>map&lt;K, V&gt;</code>ï¼šå­—å…¸ï¼Œç±»ä¼¼ Python ä¸­çš„ <code>dict</code></li></ul><p>å®¹å™¨ä½¿ç”¨çš„ç±»å‹å¯ä»¥æ˜¯ä»»æ„åˆæ³•çš„ Thrfit ç±»å‹ï¼ˆå¦‚ç»“æ„ä½“ã€å¼‚å¸¸ç­‰ï¼‰ï¼Œä½†ã€ŒæœåŠ¡ã€é™¤å¤–ã€‚</p><h3 id="ç»“æ„ä½“ä¸å¼‚å¸¸"><a href="#ç»“æ„ä½“ä¸å¼‚å¸¸" class="headerlink" title="ç»“æ„ä½“ä¸å¼‚å¸¸"></a>ç»“æ„ä½“ä¸å¼‚å¸¸</h3><p>Thrift ç»“æ„ä½“å®šä¹‰ç±»ä¼¼ C è¯­è¨€ä¸­çš„ <code>struct</code>ï¼Œå¯¹äºæŸäº› OO è¯­è¨€ï¼Œç»“æ„ä½“ä¼šè¢«ç¿»è¯‘æˆ Classã€‚</p><p>å¼‚å¸¸çš„å®šä¹‰ç±»ä¼¼ç»“æ„ä½“ï¼Œå¯ä»¥åŒ…å«ä¸åŒçš„å­—æ®µç»„æˆï¼Œä½†æ˜¯ç”¨ <code>exception</code> å…³é”®å­—ã€‚æˆ‘ä»¬åœ¨å®šä¹‰æœåŠ¡ RPC æ—¶ï¼Œå¯ä»¥è®©æŸäº›æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼ˆå¦‚èµ„æºæœªæ‰¾åˆ°ï¼‰ã€‚</p><h3 id="æœåŠ¡"><a href="#æœåŠ¡" class="headerlink" title="æœåŠ¡"></a>æœåŠ¡</h3><p>æœåŠ¡çš„å®šä¹‰ç±»ä¼¼ OO ç¼–ç¨‹ä¸­å®šä¹‰çš„ <code>interface</code>ï¼Œæˆ–è€… Rust ä¸­çš„ <code>trait</code>ã€‚Thrift ç¼–è¯‘å™¨ä¼šç”Ÿæˆå®Œæ•´çš„å®ç°äº†æ¥å£çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¡©ï¼ˆStubï¼‰ã€‚</p><h2 id="ç±»å‹å®šä¹‰"><a href="#ç±»å‹å®šä¹‰" class="headerlink" title="ç±»å‹å®šä¹‰"></a>ç±»å‹å®šä¹‰</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef i32 int</span><br><span class="line">typedef Tweet ReTweet</span><br></pre></td></tr></table></figure><h2 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h2><p>ç±» C çš„æšä¸¾å®šä¹‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enum TweetType &#123;</span><br><span class="line">    TWEET,</span><br><span class="line">    RETWEET = 2,</span><br><span class="line">    DM = 0xa,</span><br><span class="line">    REPLY </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åƒ Protocol Buffersï¼ŒThrift è¿˜ä¸æ”¯æŒåµŒå¥— Enum å®šä¹‰ï¼ˆæˆ–è€…åµŒå¥—ç»“æ„ä½“ï¼‰ï¼Œæšä¸¾å€¼å¿…é¡»æ˜¯ 32 ä½æ­£æ•´æ•°ã€‚</p><h2 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># è¿™æ˜¯åˆæ³•çš„æ³¨é‡Š</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * å¤šè¡Œæ³¨é‡Šï¼Œç±»ä¼¼ C è¯­è¨€æ”¯æŒçš„é‚£æ ·</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">// å•è¡Œæ³¨é‡Š</span><br></pre></td></tr></table></figure><h2 id="å‘½åç©ºé—´"><a href="#å‘½åç©ºé—´" class="headerlink" title="å‘½åç©ºé—´"></a>å‘½åç©ºé—´</h2><p>Thrift ä¸­çš„å‘½åç©ºé—´ç±»ä¼¼ C++ ä¸­çš„é‚£æ ·ï¼Œæˆ–è€… Java ä¸­çš„åŒ…çš„æ¦‚å¿µã€‚ç”±äºæ¯ç§è¯­è¨€éƒ½æœ‰è‡ªå·±çš„åŒ…ç®¡ç†æœºåˆ¶ï¼ˆå¦‚ Python æœ‰æ¨¡å—çš„æ¦‚å¿µï¼‰ï¼ŒThrift å…è®¸é’ˆå¯¹ä¸åŒçš„è¯­è¨€å®šåˆ¶å‘½åç©ºé—´è¡Œä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ç¿»è¯‘æˆ C++ `namespace com &#123; namespace example &#123; namespace project &#123;`</span><br><span class="line">namespace cpp com.example.project</span><br><span class="line"></span><br><span class="line">// ç¿»è¯‘æˆ Java åŒ…å°±æ˜¯ `package com.example.project`</span><br><span class="line">namespace java com.example.project</span><br></pre></td></tr></table></figure><h3 id="Includes"><a href="#Includes" class="headerlink" title="Includes"></a>Includes</h3><p>æˆ‘ä»¬é€šå¸¸å¯ä»¥å°† Thrift å®šä¹‰æ‹†åˆ†åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ä»¥ä¾¿ç»´æŠ¤ã€å¤ç”¨ï¼Œä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼è¿›è¡Œç»„ç»‡ã€‚Thrift è¿è¡Œåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ <code>include</code> å…¶å®ƒæ–‡ä»¶ã€‚è¢« <code>include</code> çš„æ–‡ä»¶ä¼šåœ¨å½“å‰ç›®å½•æˆ–è€…ä½¿ç”¨ <code>-I</code> ç¼–è¯‘æ ‡å¿—æŒ‡å®šçš„ç›®å½•ä¸­æŸ¥æ‰¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include &quot;tweet.thrift&quot; // æ³¨æ„æ²¡æœ‰ `;` ç»“å°¾</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">struct TweetSearchResult &#123;</span><br><span class="line">    1: list&lt;tweet.Tweet&gt; tweets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const i32 MAX_PROCS = 120;  // åˆ†å·æ˜¯å¯é€‰çš„</span><br><span class="line"></span><br><span class="line">// ä¹Ÿå¯ä»¥å®šä¹‰å¤æ‚ç±»å‹çš„å¸¸é‡ï¼Œæ”¯æŒç»“æ„ä½“ã€å­—å…¸ç­‰</span><br><span class="line">// ä½¿ç”¨ JSON çš„æ ¼å¼åˆå§‹åŒ–</span><br><span class="line">const map&lt;string, string&gt; MAP_CONST = &#123;&quot;hello&quot;: &quot;world&quot;&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h3><p>åœ¨ Thrfit IDL (Interface Defenition Language) ä¸­ï¼Œç»“æ„ä½“æ˜¯åŸºæœ¬çš„æ„å»ºåŸºçŸ³ã€‚ç»“æ„ä½“ç»„åˆäº†å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µæœ‰ç‹¬ç«‹çš„æ ‡è¯†ç¬¦ï¼Œç±»å‹ï¼Œåç§°ä»¥åŠå¯é€‰çš„é»˜è®¤å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct Location &#123;</span><br><span class="line">    1: required double latitude;</span><br><span class="line">    2: required double longitude;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Tweet &#123;</span><br><span class="line">    1: required i32 user_id;</span><br><span class="line">    2: required string user_name;</span><br><span class="line">    3: required: string description;</span><br><span class="line">    4: optional: Location loc;</span><br><span class="line">    5: optional: string contry = &quot;China&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä½¿ç”¨ <code>required</code> æ ‡è®°çš„å­—æ®µï¼Œå®ä¾‹åŒ–æ—¶å¿…é¡»è¦èµ‹å€¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚å¯¹äº <code>optional</code> å­—æ®µï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å€¼ï¼Œå°±ä¸ä¼šåœ¨åºåˆ—åŒ–æ—¶ä¼ è¾“ã€‚å¦‚æœ <code>optional</code> å­—æ®µè®¾ç½®äº†é»˜è®¤å€¼ï¼Œå½“è§£æç»“æ„ä½“çš„æ—¶å€™ä¼šç»™ç›¸åº”å­—æ®µèµ‹äºˆé»˜è®¤å€¼ã€‚</p><p>ä¸åŒäºæœåŠ¡ï¼Œç»“æ„ä½“æ˜¯ä¸å…è®¸ç»§æ‰¿çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å…è®¸æ‰©å±•è‡ªå…¶å®ƒç»“æ„ä½“ã€‚</p><blockquote><h4 id="Required-Is-Forever"><a href="#Required-Is-Forever" class="headerlink" title="Required Is Forever"></a>Required Is Forever</h4><p>åœ¨å°†ä¸€ä¸ªå­—æ®µè®¾ç½®ä¸º <code>required</code> ä¹‹å‰ä¸€å®šè¦ä¸‰æ€å•Šï¼å¦‚æœä½ æƒ³åœ¨ä»€ä¹ˆæ—¶å€™åœæ­¢å‘é€æŸä¸ª <code>required</code> å­—æ®µæ—¶ï¼ˆå¦‚è®¾ç½®ä¸º <code>optional</code>ï¼‰ï¼Œå°±å¾ˆå®¹æ˜“å‡ºé—®é¢˜ï¼šæ—§ç‰ˆæœ¬çš„è¯»å–å™¨ä¼šè®¤ä¸ºæ²¡æœ‰åŸå…ˆ <code>required</code> å­—æ®µçš„æ¶ˆæ¯æ˜¯ä¸å®Œæ•´çš„ï¼Œå¯èƒ½ä¼šæ‹’ç»ç”šè‡³æ— æ„ä¸­ä¸¢å¼ƒæ‰ã€‚æ‰€ä»¥è¿™æ—¶å¯èƒ½å°±éœ€è¦ç¼–å†™ç‰¹å®šçš„è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘æ¥è§£å†³é—®é¢˜ã€‚æœ‰äº›äººè®¤ä¸ºä½¿ç”¨ <code>required</code> å¼Šå¤§äºåˆ©ï¼›ä»–ä»¬æ›´å–œæ¬¢åªç”¨ <code>optional</code>ã€‚ç„¶è€Œï¼Œè¿™ä¸ªä¹Ÿæ˜¯å› äººè€Œå¼‚ï¼Œçœ‹åœºæ™¯éœ€è¦çš„äº†ã€‚</p></blockquote><h3 id="å®šä¹‰æœåŠ¡"><a href="#å®šä¹‰æœåŠ¡" class="headerlink" title="å®šä¹‰æœåŠ¡"></a>å®šä¹‰æœåŠ¡</h3><p>è™½ç„¶å·²ç»æœ‰å¾ˆå¤šæµè¡Œçš„<strong>åºåˆ—åŒ–/ååºåˆ—åŒ–</strong>æ¡†æ¶ï¼ˆå¦‚ Protocol Buffersï¼‰äº†ï¼Œä½†å¾ˆå°‘æœ‰æ¡†æ¶æä¾›å¼€ç®±å³ç”¨çš„è·¨è¯­è¨€ RPC æœåŠ¡çš„æ”¯æŒï¼Œè¿™ä¹Ÿæ˜¯ Thrift æœ€ä¸»è¦çš„äº®ç‚¹ä¹‹ä¸€ã€‚</p><p>å¯ä»¥æŠŠæœåŠ¡å®šä¹‰å½“åš Java ä¸­çš„æ¥å£å®šä¹‰ï¼Œä½ éœ€è¦æä¾›ç›¸åº”çš„æ–¹æ³•åç§°ã€ç­¾åç­‰ï¼›æ­¤å¤–ï¼ŒæœåŠ¡ä¹Ÿå¯ä»¥æ‰©å±•è‡ªå…¶å®ƒæœåŠ¡ï¼ˆä½¿ç”¨ <code>extends</code> å…³é”®å­—ï¼‰ã€‚</p><p>Thrift ç¼–è¯‘å™¨ä¼šæ ¹æ®é€‰æ‹©çš„ç›®æ ‡ç¼–ç¨‹è¯­è¨€ç”Ÿæˆç›¸åº”çš„æ¥å£ä»£ç ï¼ˆServer ç«¯ï¼‰ä»¥åŠ Stubsï¼ˆå®¢æˆ·ç«¯ï¼‰ã€‚Thrift ä¸ºå¤§å¤šæ•°è¯­è¨€æä¾›äº†ç”¨äºè¿è¡Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ RPC åº“ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">service Twitter &#123;</span><br><span class="line">    // æ–¹æ³•å®šä¹‰æ ¼å¼ç±»ä¼¼ C è¯­è¨€ã€‚éœ€è¦æŒ‡å®šè¿”å›ç±»å‹ã€å‚æ•°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæŠ›çš„å¼‚å¸¸åˆ—è¡¨</span><br><span class="line">    // éœ€è¦æ³¨æ„çš„æ˜¯å‚æ•°åˆ—è¡¨å’Œå¼‚å¸¸åˆ—è¡¨ä½¿ç”¨çš„å®šä¹‰æ–¹å¼ç±»ä¼¼ç»“æ„ä½“å­—æ®µå®šä¹‰</span><br><span class="line">    void ping();</span><br><span class="line">    // çœ‹åˆ°æ²¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€—å·ç»“å°¾</span><br><span class="line">    // ä¸è¿‡è¿˜æ˜¯å»ºè®®ä½¿ç”¨åˆ†å·å§</span><br><span class="line">    bool post_tweet(1: Tweet tweet) throws (1: TwitterUnavailable unavailable), </span><br><span class="line">    TweetSearchResult search_tweets(1: string query);</span><br><span class="line">    </span><br><span class="line">    // `async` è¡¨ç¤ºå®¢æˆ·ç«¯å°½ç®¡è¯·æ±‚ï¼Œè€Œæ— éœ€ç­‰å¾…å…¶å“åº”ã€‚è¿™ç§æ–¹æ³•å¿…é¡»æ˜¯ `void`</span><br><span class="line">    async void zip();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä»£ç ç”Ÿæˆ"><a href="#ä»£ç ç”Ÿæˆ" class="headerlink" title="ä»£ç ç”Ÿæˆ"></a>ä»£ç ç”Ÿæˆ</h1><p>åœ¨å‰é¢çš„ <a href="#thrift-protocol-stack-overview">åè®®æ ˆ</a> å°èŠ‚å¯¹æ•´ä¸ª Thrift åè®®æ ˆæœ‰äº†æ¦‚æ‹¬æ€§çš„äº†è§£ï¼Œæ¥ä¸‹æ¥å°†ä»ä»£ç ç”Ÿæˆçš„è§’åº¦è®²è®² Thrift åè®®æ ˆã€‚</p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>ä»¥ä¸‹æ˜¯ Thrift ç½‘ç»œæ ˆçš„æ¦‚å¿µå›¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------+</span><br><span class="line">| cGRE                                      |</span><br><span class="line">| Server                                    |</span><br><span class="line">| (single-threaded, event-driven etc)       |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| cBLU                                      |</span><br><span class="line">| Processor                                 |</span><br><span class="line">| (compiler generated)                      |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| cGRE                                      |</span><br><span class="line">| Protocol                                  |</span><br><span class="line">| (JSON, compact etc)                       |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| cGRE                                      |</span><br><span class="line">| Transport                                 |</span><br><span class="line">| (raw TCP, HTTP etc)                       |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="ä¼ è¾“å±‚ï¼ˆTransport-Layerï¼‰"><a href="#ä¼ è¾“å±‚ï¼ˆTransport-Layerï¼‰" class="headerlink" title="ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰"></a>ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰</h3><p>ä¼ è¾“å±‚æä¾›äº†ç½‘ç»œè¯»å†™çš„ç®€å•æŠ½è±¡ï¼Œè¿™æ ·å¯ä»¥å°†åº•å±‚çš„ä¼ è¾“å’Œç³»ç»Ÿå…¶å®ƒéƒ¨åˆ†è§£è€¦å¼€æ¥ï¼ˆå¦‚åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç­‰ï¼‰ã€‚<br>ä»¥ä¸‹æ˜¯ <code>Transport</code> æ¥å£æä¾›çš„æ–¹æ³•ï¼š</p><ul><li><code>open</code></li><li><code>close</code></li><li><code>read</code></li><li><code>write</code></li><li><code>flush</code></li></ul><p>é™¤äº† <code>Transport</code> æ¥å£ï¼ŒThrift ä¹Ÿä½¿ç”¨äº† <code>ServerTransport</code> æ¥å£æ¥æ”¶æˆ–åˆ›å»ºåŸå§‹çš„ä¼ è¾“å¯¹è±¡ã€‚é¡¾åæ€ä¹‰ï¼Œ<code>ServerTransport</code> ä¸»è¦ç”¨äºæœåŠ¡ç«¯ä¸ºè¿›å…¥çš„è¿æ¥åˆ›å»º <code>Transport</code> å¯¹è±¡ã€‚å…¶æä¾›çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><code>open</code></li><li><code>listen</code></li><li><code>accept</code></li><li><code>close</code></li></ul><p>ä»¥ä¸‹æ˜¯å¤§éƒ¨åˆ† Thrift æ”¯æŒçš„è¯­è¨€éƒ½ä¼šæä¾›çš„ä¼ è¾“æ–¹å¼ï¼š</p><ul><li><code>file</code>: ä»ç£ç›˜è¿™ä¸¤ä¸ªè¯»å–æˆ–å†™å…¥</li><li><code>http</code></li></ul><h3 id="åè®®å±‚ï¼ˆProtocol-Layerï¼‰-1"><a href="#åè®®å±‚ï¼ˆProtocol-Layerï¼‰-1" class="headerlink" title="åè®®å±‚ï¼ˆProtocol Layerï¼‰"></a>åè®®å±‚ï¼ˆProtocol Layerï¼‰</h3><p>åè®®æŠ½è±¡æä¾›äº†å°†å†…å­˜æ•°æ®ç»“æ„æ˜ å°„æˆä¼ è¾“æ ¼å¼çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåè®®å®šä¹‰äº†æ•°æ®ç±»å‹å¦‚ä½•åˆ©ç”¨åº•å±‚çš„ Transport å±‚æ¥ç¼–è§£ç è‡ªå·±ã€‚å› æ­¤ï¼Œåè®®å±‚å®ç°è´Ÿè´£ Schema ç¼–ç ä»¥åŠåºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚å¸¸ç”¨çš„åè®®åŒ…æ‹¬ï¼šJSONã€XMLã€çº¯æ–‡æœ¬å’Œå‹ç¼©äºŒè¿›åˆ¶ç­‰ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>Protocol</code> æ¥å£å®šä¹‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">writeMessageBegin(name, type, seq)</span><br><span class="line">writeMessageEnd()</span><br><span class="line">writeStructBegin(name)</span><br><span class="line">writeStructEnd()</span><br><span class="line">writeFieldBegin(name, type, id)</span><br><span class="line">writeFieldEnd()</span><br><span class="line">writeFieldStop()</span><br><span class="line">writeMapBegin(ktype, vtype, size)</span><br><span class="line">writeMapEnd()</span><br><span class="line">writeListBegin(etype, size)</span><br><span class="line">writeListEnd()</span><br><span class="line">writeSetBegin(etype, size)</span><br><span class="line">writeSetEnd()</span><br><span class="line">writeBool(bool)</span><br><span class="line">writeByte(byte)</span><br><span class="line">writeI16(i16)</span><br><span class="line">writeI32(i32)</span><br><span class="line">writeI64(i64)</span><br><span class="line">writeDouble(double)</span><br><span class="line">writeString(string)</span><br><span class="line"></span><br><span class="line">name, type, seq = readMessageBegin()</span><br><span class="line">                  readMessageEnd()</span><br><span class="line">name = readStructBegin()</span><br><span class="line">       readStructEnd()</span><br><span class="line">name, type, id = readFieldBegin()</span><br><span class="line">                 readFieldEnd()</span><br><span class="line">k, v, size = readMapBegin()</span><br><span class="line">             readMapEnd()</span><br><span class="line">etype, size = readListBegin()</span><br><span class="line">              readListEnd()</span><br><span class="line">etype, size = readSetBegin()</span><br><span class="line">              readSetEnd()</span><br><span class="line">bool = readBool()</span><br><span class="line">byte = readByte()</span><br><span class="line">i16 = readI16()</span><br><span class="line">i32 = readI32()</span><br><span class="line">i64 = readI64()</span><br><span class="line">double = readDouble()</span><br><span class="line">string = readString()</span><br></pre></td></tr></table></figure><p>Thrift åè®®å±‚é‡‡ç”¨é¢å‘æµï¼ˆStream Orientedï¼‰çš„è®¾è®¡ã€‚ä¾‹å¦‚ï¼Œæ²¡å¿…è¦åœ¨çŸ¥é“å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ä¸­çš„å…ƒç´ æ•°é‡çš„é•¿åº¦çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥åºåˆ—åŒ–å®ƒä»¬ã€‚</p><p>ä»¥ä¸‹æ˜¯ Thrift æ”¯æŒçš„è¯­è¨€ä¸­é€šå¸¸ä¼šæä¾›çš„åè®®ï¼š</p><ul><li><code>binary</code></li><li><code>compact</code></li><li><code>json</code></li></ul><h3 id="å¤„ç†å™¨ï¼ˆProcessorï¼‰"><a href="#å¤„ç†å™¨ï¼ˆProcessorï¼‰" class="headerlink" title="å¤„ç†å™¨ï¼ˆProcessorï¼‰"></a>å¤„ç†å™¨ï¼ˆProcessorï¼‰</h3><p>Processor å¯¹äºä»è¾“å…¥æµè¯»å–æ•°æ®å’Œå†™å‡ºåˆ°è¾“å‡ºæµæ“ä½œåšäº†å°è£…ï¼Œè¾“å…¥å’Œè¾“å‡ºæµä½¿ç”¨ <code>Protocol</code> å¯¹è±¡è¡¨ç¤ºã€‚æ¥å£å®šä¹‰éå¸¸ç®€å•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface TProcessor &#123;</span><br><span class="line">    bool process(TProtocol in, TProtocol out) throws TException</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡å™¨ï¼ˆServerï¼‰"><a href="#æœåŠ¡å™¨ï¼ˆServerï¼‰" class="headerlink" title="æœåŠ¡å™¨ï¼ˆServerï¼‰"></a>æœåŠ¡å™¨ï¼ˆServerï¼‰</h3><p>æœåŠ¡å™¨åŒ…å«å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ol><li>åˆ›å»º Transport</li><li>ä¸º Transport åˆ›å»ºè¾“å…¥ã€è¾“å‡º Protocols</li><li>åŸºäºè¾“å…¥è¾“å‡º Protocols åˆ›å»ºä¸€ä¸ª Processor</li><li>ç­‰å¾…è¿æ¥ï¼Œå¹¶å°†å®ƒä»¬ä¸¢ç»™ Processor å¤„ç†</li></ol><h1 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h1><h2 id="ç‰ˆæœ¬åŒ–ã€å…¼å®¹æ€§è€ƒé‡"><a href="#ç‰ˆæœ¬åŒ–ã€å…¼å®¹æ€§è€ƒé‡" class="headerlink" title="ç‰ˆæœ¬åŒ–ã€å…¼å®¹æ€§è€ƒé‡"></a>ç‰ˆæœ¬åŒ–ã€å…¼å®¹æ€§è€ƒé‡</h2><p>åè®®éšç€æ—¶é—´ä¼šä¸æ–­è¿›åŒ–çš„ã€‚å¦‚æœç°æœ‰çš„æ¶ˆæ¯ç±»å‹ä¸å†æ»¡è¶³å½“å‰éœ€æ±‚ï¼ˆä¾‹å¦‚å¸Œæœ›ç»™æŸä¸ªç»“æ„ä½“æ–°å¢ä¸€ä¸ªå­—æ®µï¼‰æ—¶ï¼Œä½†æ˜¯å¸Œæœ›æ—§ç‰ˆæœ¬æ ¼å¼ç”Ÿæˆçš„ä»£ç ç»§ç»­å…¼å®¹ï¼ˆå‘å‰å…¼å®¹ï¼‰ï¼Œä¸è¦æ‹…å¿ƒï¼ä½ å¯ä»¥éå¸¸è½»æ¾åœ°æ›´æ–°åè®®è€Œä¸ç”¨æ‹…å¿ƒç ´åä¹‹å‰çš„ä»»ä½•ä»£ç ã€‚ä¸è¿‡ï¼Œå‰ææ˜¯éœ€è¦éµå¾ªä¸€äº›è§„åˆ™ï¼š</p><ol><li>å¯¹äºä»»ä½•å·²æœ‰çš„å­—æ®µï¼Œ<strong>ä¸è¦ä¿®æ”¹å‰é¢çš„ Tag Number</strong></li><li><p><strong>ä»»ä½•æ–°å¢çš„å­—æ®µéƒ½åº”æ ‡è®°ä¸ºå¯é€‰çš„</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨æ—§ç‰ˆæœ¬æ¶ˆæ¯æ ¼å¼ç”Ÿæˆçš„ä»£ç åºåˆ—åŒ–çš„æ¶ˆæ¯æ˜¯å¯ä»¥è¢«æ–°ç”Ÿæˆçš„ä»£ç æ­£ç¡®è§£æçš„ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šä¸¢å¤±ä»»ä½•å¿…é¡»çš„å­—æ®µã€‚å¯¹äºè¿™äº›å­—æ®µåº”å½“è®¾ç½®åˆç†çš„é»˜è®¤å€¼ï¼Œè¿™æ ·æ–°çš„ä»£ç å¯ä»¥æ­£ç¡®åœ°ä¸æ—§ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯äº¤äº’ã€‚åŒæ ·åœ°ï¼Œä½¿ç”¨æ–°ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯ä¹Ÿå¯ä»¥è¢«æ—§ä»£ç æ­£ç¡®è§£æï¼Œåªæ˜¯å¿½ç•¥æ‰æ–°å¢çš„å­—æ®µã€‚ç„¶è€Œï¼ŒæœªçŸ¥å­—æ®µå¹¶ä¸ä¼šè¢«é—å¼ƒï¼Œå¦‚æœæ¶ˆæ¯ä¹‹åè¢«åºåˆ—åŒ–ï¼ŒæœªçŸ¥å­—æ®µè¿˜æ˜¯ä¼šå‚ä¸åºåˆ—åŒ–çš„ã€‚å› æ­¤ï¼Œå¦‚æœæ¶ˆæ¯è¢«å‘é€åˆ°æ–°ç‰ˆæœ¬ä»£ç ï¼Œæ–°å¢å­—æ®µä¾ç„¶å¯ç”¨ã€‚</p></li><li><p>éå¿…é¡»çš„å­—æ®µå¯ä»¥è¢«ç§»é™¤æ‰ï¼Œå‰ææ˜¯ Tag Number ä¸è¦å†æ¬¡ä½¿ç”¨ï¼ˆæ¨èé‡å‘½ååºŸå¼ƒå­—æ®µï¼Œå¯ä»¥æ·»åŠ  <code>OBSOLETE_</code> å‰ç¼€ï¼‰</p></li></ol><h2 id="å¯èƒ½é€ æˆç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µåˆ†æ"><a href="#å¯èƒ½é€ æˆç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µåˆ†æ" class="headerlink" title="å¯èƒ½é€ æˆç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µåˆ†æ"></a>å¯èƒ½é€ æˆç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µåˆ†æ</h2><p><img src="./version-change-cases.jpg" alt=""></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://thrift-tutorial.readthedocs.io/en/latest/intro.html" target="_blank" rel="noopener">Thrift Tutorial</a></li><li><a href="https://diwakergupta.github.io/thrift-missing-guide/" target="_blank" rel="noopener">Thrift The Missing Guide</a></li><li><a href="https://thrift.apache.org/tutorial/" target="_blank" rel="noopener">Thrift docs</a></li><li><a href="http://thrift.apache.org/static/files/thrift-20070401.pdf" target="_blank" rel="noopener">Paper: Scalable Cross-Language Services Implementation</a></li><li><a href="http://jnb.ociweb.com/jnb/jnbJun2009.html" target="_blank" rel="noopener">Paper: Apache Thrift</a></li></ol><h1 id="ç«äº‰å¯¹æ‰‹"><a href="#ç«äº‰å¯¹æ‰‹" class="headerlink" title="ç«äº‰å¯¹æ‰‹"></a>ç«äº‰å¯¹æ‰‹</h1><ol><li><a href="https://labs.criteo.com/2017/05/serialization/" target="_blank" rel="noopener">Data Serialization Comparison</a></li><li><a href="https://martin.kleppmann.com/2012/12/05/schema-evolution-in-avro-protocol-buffers-thrift.html" target="_blank" rel="noopener">Schema evolution in Avro, Protocol Buffers and Thrift</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;çŸ¥ä¹ä½¿ç”¨çš„ RPC æ¡†æ¶æ˜¯åŸºäº Thrift æ„å»ºçš„ã€‚è‡ªç„¶å°±å¾ˆæœ‰å¿…è¦äº†è§£ä¸‹ Thrift æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿä»¥åŠæœ‰ä»€ä¹ˆæœ€ä½³å®è·µï¼Ÿ&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Thrift" scheme="http://ifaceless.space/categories/Thrift/"/>
    
    
      <category term="Thrift" scheme="http://ifaceless.space/tags/Thrift/"/>
    
      <category term="RPC" scheme="http://ifaceless.space/tags/RPC/"/>
    
      <category term="åºåˆ—åŒ–" scheme="http://ifaceless.space/tags/%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="ååºåˆ—åŒ–" scheme="http://ifaceless.space/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Beanstalkd æºç åˆæ¢</title>
    <link href="http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/"/>
    <id>http://ifaceless.space/2019/02/04/learning-beanstalkd-source-code/</id>
    <published>2019-02-04T10:22:05.000Z</published>
    <updated>2019-11-24T09:45:59.950Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚<br><a id="more"></a><br>åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ï¼Œç»å¸¸ä¼šå€ŸåŠ© Beanstalkd æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼Œå¸¸è§çš„ç”¨ä¾‹å¦‚ä¸‹ï¼š</p><ol><li>ç”¨æˆ·å®Œæˆä¼šå‘˜è´­ä¹°å¹¶æ¿€æ´»åï¼Œå‘é€ç§ä¿¡é€šçŸ¥ã€é‡ç½®è´¦å·é‡å‘½åçŠ¶æ€ç­‰ï¼›</li><li>ç”¨æˆ·å®Œæˆè¯„è®ºåï¼Œå¼‚æ­¥æ›´æ–°è¯„è®ºè®¡æ•°ï¼›</li><li>ç”¨æˆ·å¯¹ç§å®¶è¯¾æ”¶å¬è®°å½•ä¸ŠæŠ¥åï¼Œå¼‚æ­¥æ›´æ–°æœ€è¿‘æ”¶å¬çš„å°èŠ‚ã€ç´¯ç§¯æ”¶å¬æ—¶é•¿ã€åŒæ­¥åˆ°å…¶å®ƒç³»ç»Ÿç­‰ï¼›</li><li>ç”¨æˆ·è®°å½•æ·»åŠ åï¼Œä¼šåŒæ­¥è‡³ Redisï¼Œä¸ºä¿è¯æ•°æ®åº“å’Œ Redis çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¼šæå‰å¯åŠ¨ä¸€ä¸ªå»¶è¿Ÿæ ¡éªŒçš„ä»»åŠ¡ï¼ˆå¦‚ 5s åï¼‰ï¼Œæ£€æŸ¥ Redis ä¸­ä¸æ•°æ®åº“è®°å½•æ˜¯å¦ä¸€è‡´ã€‚</li></ol><h1 id="Beanstalkd-åˆè¯†"><a href="#Beanstalkd-åˆè¯†" class="headerlink" title="Beanstalkd åˆè¯†"></a>Beanstalkd åˆè¯†</h1><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ol><li>åŸºäº TCP å¹¶é‡‡ç”¨ ASCII ç¼–ç çš„æ–‡æœ¬åè®®ã€‚è¯¦ç»†å®šä¹‰å‚è§ï¼š<a href="https://github.com/beanstalkd/beanstalkd/blob/master/doc/protocol.txt" target="_blank" rel="noopener">protocol.txt</a>ï¼š<ol><li>å®¢æˆ·ç«¯è´Ÿè´£ä¸æœåŠ¡ç«¯çš„äº¤äº’ï¼š<strong>è¿æ¥</strong>ã€<strong>å‘é€å‘½ä»¤å’Œæ•°æ®</strong>ã€<strong>ç­‰å¾…å“åº”</strong>ã€<strong>å…³é—­è¿æ¥</strong></li><li>æœåŠ¡ç«¯ä¸²è¡Œå¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥</li><li>åè®®ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šæ–‡æœ¬è¡Œï¼ˆç”¨äºå®¢æˆ·ç«¯å‘½ä»¤å’ŒæœåŠ¡ç«¯å“åº”ï¼‰å’Œéç»“æ„åŒ–çš„æ•°æ®å—ï¼ˆç”¨äºä¼ é€ä»»åŠ¡ body å’Œ stats ä¿¡æ¯ï¼‰</li></ol></li></ol><ol><li>é˜Ÿåˆ—æ¶ˆæ¯æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä½†ç”¨æˆ·å¯ä»¥é€‰æ‹©å¼€å¯ WAL æœºåˆ¶ï¼ˆbinlogï¼‰ï¼Œè¿™æ ·é‡å¯åå¯ä»¥å›æ”¾ä»»åŠ¡ï¼Œæé«˜äº†å¯ç”¨æ€§</li><li>é‡‡ç”¨ç±»ä¼¼ Redis çš„å•çº¿ç¨‹æ¨¡å‹ï¼ˆIO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼‰ï¼Œå› æ­¤ä¸å¿…è€ƒè™‘å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹åŒæ­¥ã€åŠ é”ç­‰ï¼Œç®€åŒ–å®ç°</li></ol><h2 id="å…³é”®è¯"><a href="#å…³é”®è¯" class="headerlink" title="å…³é”®è¯"></a>å…³é”®è¯</h2><ol><li>Tubeï¼šç±»ä¼¼ Kafka ä¸­çš„ Topicï¼Œæˆ–è€…å…¶å®ƒé˜Ÿåˆ—ç³»ç»Ÿä¸­çš„ Channel</li><li>Jobï¼šå®¢æˆ·ç«¯ç”Ÿäº§å’Œæ¶ˆè´¹çš„åŸºæœ¬å•å…ƒã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‰¹å®šçš„ idï¼Œå¯è®¾å®šä¼˜å…ˆçº§ï¼Œè¶…æ—¶æ—¶é—´ï¼Œå»¶è¿Ÿæ‰§è¡Œæ—¶é—´ç­‰</li><li>WAL (Write Ahead Log)ï¼šè´Ÿè´£ binlog ç®¡ç†ï¼ˆå†™å…¥ã€å‹ç¼©ã€æ—¥å¿—æ–‡ä»¶æ¸…ç†ã€ä»»åŠ¡æ¢å¤ç­‰ï¼‰</li><li>Serverï¼šBeanstalkd æœåŠ¡ç«¯</li><li>Connï¼šBeanstalkd å®¢æˆ·ç«¯è¿æ¥å¤„ç†</li></ol><h2 id="ä»»åŠ¡çŠ¶æ€æµè½¬"><a href="#ä»»åŠ¡çŠ¶æ€æµè½¬" class="headerlink" title="ä»»åŠ¡çŠ¶æ€æµè½¬"></a>ä»»åŠ¡çŠ¶æ€æµè½¬</h2><p><img src="./ä»»åŠ¡çŠ¶æ€æµè½¬.png" alt="image.png"></p><h3 id="ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ"><a href="#ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ"></a>ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="./ä»»åŠ¡å…¸å‹ç”Ÿå‘½å‘¨æœŸ.png" alt="image.png"></p><h2 id="å·¥ä½œæ–¹å¼æè¿°"><a href="#å·¥ä½œæ–¹å¼æè¿°" class="headerlink" title="å·¥ä½œæ–¹å¼æè¿°"></a>å·¥ä½œæ–¹å¼æè¿°</h2><ol><li><strong>æœåŠ¡ç«¯</strong>ä¼šæœ‰ä¸€åˆ°å¤šä¸ª tubesï¼ˆåœ¨æ•°ç»„ä¸­ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ª tube éƒ½ä¼šåŒ…å«ä¸€ä¸ª<strong>å°±ç»ªé˜Ÿåˆ—</strong>ï¼ˆåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ä»¥åŠä¸€ä¸ª<strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼ˆä¹Ÿåœ¨æœ€å°å †ç»´æŠ¤ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„ tube ä¸­åº¦è¿‡å…¨éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ</li><li><strong>å®¢æˆ·ç«¯</strong>å¯ä»¥ä½¿ç”¨ <code>watch</code> æŒ‡ä»¤è®¢é˜…æŸä¸ª tubeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>ignore</code> å–æ¶ˆè®¢é˜…ï¼Œæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶è®¢é˜…å¤šä¸ª tubeï¼Œå½“æ¶ˆè´¹è€… <code>reserve</code> ä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡å¯èƒ½æ¥è‡ªå…¶ <code>watch list</code> ä¸­çš„ä»»æ„ä¸€ä¸ª tube</li><li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ <code>default</code> tubeï¼Œå¯ä»¥ä½¿ç”¨ <code>use</code> åˆ‡æ¢ tube</li><li>tube æ˜¯ä¼šæ ¹æ®éœ€è¦éšæ—¶åˆ›å»ºçš„ï¼Œå½“æ²¡æœ‰å®¢æˆ·ç«¯å¼•ç”¨æ—¶ï¼Œå°±ä¼šè¢«åˆ é™¤</li></ol><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>å€ŸåŠ© Docker å¯åŠ¨ä¸€ä¸ª Beanstalkd æœåŠ¡éå¸¸è½»æ¾ï¼Œè¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤è¡Œå³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 11300:11300 schickling/beanstalkd</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šè¿°å‘½ä»¤è¡Œæ‰§è¡Œæ­£å¸¸ï¼Œåˆ™ Beanstalkd æœåŠ¡åº”è¯¥å¯åŠ¨äº†ï¼Œå…¶é»˜è®¤ç›‘å¬çš„ç«¯å£å·ä¸º <code>11300</code>ï¼Œè¿è¡Œ <code>docker ps</code> å¯ä»¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨å¹¶è¿è¡Œï¼š</p><p><img src="./å¯åŠ¨ beansktalkd.png" alt="image.png"></p><h1 id="ç¼–è¯‘-amp-è¿è¡Œ-amp-è°ƒè¯•"><a href="#ç¼–è¯‘-amp-è¿è¡Œ-amp-è°ƒè¯•" class="headerlink" title="ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•"></a>ç¼–è¯‘ &amp; è¿è¡Œ &amp; è°ƒè¯•</h1><p>é¦–å…ˆï¼Œéœ€è¦å‰å¾€ <a href="https://github.com/beanstalkd/beanstalkd" target="_blank" rel="noopener">beanstalkd</a> ä»“åº“å…‹éš† Master åˆ†æ”¯æºç è‡³æœ¬åœ°ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ç®¡ç† C é¡¹ç›®ï¼Œè¿™é‡Œä½¿ç”¨äº† JET BRAINS å®¶æ—çš„ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„å·¥å…·æ‰“å¼€ã€‚</p><p>ç”±äº Clion ä½¿ç”¨äº† <a href="https://cmake.org/" target="_blank" rel="noopener">CMake</a> ç®¡ç† C&amp;C++ é¡¹ç›®ï¼Œæ‰€ä»¥æ‰“å¼€é¡¹ç›®æ—¶éœ€è¦åœ¨å…¶æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª CMakeLists.txt æ–‡ä»¶ï¼Œå¹¶å¡«å†™å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.13)</span><br><span class="line">project(beanstalkd C)</span><br><span class="line">set(BUILD_DIR .)</span><br><span class="line">add_custom_target(beanstalkd ALL COMMAND make WORKING_DIRECTORY $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;)</span><br><span class="line">add_custom_command(TARGET beanstalkd POST_BUILD</span><br><span class="line">        COMMAND echo copy $&#123;PROJECT_NAME&#125; to $&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">        COMMAND cp $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/beanstalkd $&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ğŸ‰ è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå·²ç»åšå®Œå•¦ã€‚æ¥ä¸‹æ¥ï¼Œå¯ä»¥å°è¯•ç‚¹å‡»ã€Œæ„å»ºã€æŒ‰é’®ï¼Œè¿›è¡Œç¼–è¯‘ã€‚ç¼–è¯‘ç»“æŸåï¼Œå°±å¯ä»¥ç‚¹å‡»è¿è¡Œå¯åŠ¨ Beanstalkd æœåŠ¡å•¦ã€‚å“¦ï¼Œå¯¹äº†ï¼Œå¦‚æœéœ€è¦è°ƒè¯•æ”¯æŒçš„è¯ï¼Œç›´æ¥åœ¨éœ€è¦çš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶ç‚¹å‡»ã€Œè°ƒè¯•ã€æŒ‰é’®å³å¯å¼€å§‹ã€‚</p><p><img src="./ç¼–è¯‘ä¸è°ƒè¯•.png" alt="image.png"></p><h2 id="å…³äº-Makefile"><a href="#å…³äº-Makefile" class="headerlink" title="å…³äº Makefile"></a>å…³äº Makefile</h2><p>æŸ¥çœ‹ Makefile æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å‡ ä¸ªå‘½ä»¤å¯ä»¥æ‰§è¡Œï¼š</p><ol><li><code>make all</code>: ç¼–è¯‘ã€é“¾æ¥å¹¶ç”Ÿæˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ <code>beanstalkd</code>ã€‚ç”±äºæˆ‘ä»¬å·²ç»å°†è¯¥å‘½ä»¤æ”¾åˆ° <code>CMakeLists.txt</code> æ–‡ä»¶ä¸­ï¼Œåœ¨ä½¿ç”¨ Clion æ„å»ºæ—¶å¯è‡ªåŠ¨è§¦å‘</li><li><code>make install</code>: å°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ <code>beanstalkd</code> å®‰è£…åˆ° <code>BINDIR=$(DESTDIR)/usr/local/bin</code> ç›®å½•ä¸‹</li><li><code>make clean</code>: æ¸…ç†ç”Ÿæˆçš„ <code>*.o</code> æ–‡ä»¶</li><li><code>make bench</code>: è·‘ Benchmark ç”¨</li></ol><h1 id="å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹"></a>å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹</h1><p>ä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚ç”Ÿäº§è€…è´Ÿè´£å°†ä¸€ç»„å¾…æŠ“å–çš„ URLs æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå†ç”±ä¸€ç»„æ¶ˆè´¹è€…å¹¶å‘è®¿é—®é˜Ÿåˆ—ä¸­çš„ URLsã€‚ä¸»æµç¨‹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šé¦–å…ˆå¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€…åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ç›‘å¬</span></span><br><span class="line"><span class="comment">// ç„¶åè®©ç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­å¡«å…… URLsï¼Œä¾›æ¶ˆè´¹è€…ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> NUM_WORKERS: <span class="built_in">isize</span> = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..NUM_WORKERS &#123;</span><br><span class="line">        <span class="comment">// å¯åŠ¨ NUM_WORKERS ä¸ªæ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">let</span> hd = thread::spawn(<span class="keyword">move</span> || consume_urls(i));</span><br><span class="line">        handles.push(hd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    produce_urls();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ¶ˆè´¹è€…ç»“æŸ</span></span><br><span class="line">    <span class="keyword">for</span> hd <span class="keyword">in</span> handles &#123;</span><br><span class="line">        hd.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿäº§è€…"><a href="#ç”Ÿäº§è€…" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">produce_urls</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> client = Beanstalkd::localhost().unwrap();</span><br><span class="line">    client.tube(<span class="string">"urls"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> urls = <span class="built_in">vec!</span>[</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/ifaceless.github.io"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/gic"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/rust-exercises"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/learning-rust"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/fixture"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/rest"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/bigcache"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/leetgogo"</span>,</span><br><span class="line">        <span class="string">"https://github.com/iFaceless/freecache"</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls &#123;</span><br><span class="line">        client.put(url, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1000</span>).unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¶ˆè´¹è€…"><a href="#æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">consume_urls</span></span>(id: <span class="built_in">isize</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] started..."</span>, id);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> client = Beanstalkd::localhost().unwrap();</span><br><span class="line">    client.watch(<span class="string">"urls"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (job_id, url) = <span class="keyword">match</span> client.reserve() &#123;</span><br><span class="line">            <span class="literal">Ok</span>(job) =&gt; job,</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] error happens: &#123;&#125;"</span>, id, e);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"[Consumer &#123;&#125;] got job &lt;&#123;&#125;&gt;: &#123;&#125;"</span>, id, job_id, url);</span><br><span class="line">        client.delete(job_id).unwrap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æºç æ¢ç´¢"><a href="#æºç æ¢ç´¢" class="headerlink" title="æºç æ¢ç´¢"></a>æºç æ¢ç´¢</h1><h2 id="æ¨¡å—åˆ†ç±»å›¾"><a href="#æ¨¡å—åˆ†ç±»å›¾" class="headerlink" title="æ¨¡å—åˆ†ç±»å›¾"></a>æ¨¡å—åˆ†ç±»å›¾</h2><p>ä¸ºäº†æ–¹ä¾¿é˜…è¯»æºç ï¼Œç²—ç•¥åœ°æ ¹æ®è‡ªå·±çš„ç†è§£ç»™å„ä¸ªæ–‡ä»¶åšäº†ç®€å•çš„åˆ†ç±»ï¼š</p><p><img src="./æ¨¡å—åˆ†ç±».png" alt="image.png"></p><h2 id="æ¨¡å—-UML-å›¾"><a href="#æ¨¡å—-UML-å›¾" class="headerlink" title="æ¨¡å— UML å›¾"></a>æ¨¡å— UML å›¾</h2><p>è™½è¯´ Beanstalkd çš„æºç æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„è®¾è®¡æ€æƒ³ä¾ç„¶å¯ä»¥ä»é¢å‘å¯¹è±¡çš„è§’åº¦æ¥è§£é‡Šã€‚æ¯”å¦‚æ¨¡å—åŒ–è®¾è®¡ã€æ¥å£è®¾è®¡ã€å¤šæ€ç­‰ã€‚æ ¹æ®è‡ªå·±çš„ç†è§£ï¼Œå¯¹å…¶ä¸­çš„ä¸€äº›æ ¸å¿ƒæ¨¡å—åšäº†æ¢³ç†ï¼Œå¹¶ç»˜åˆ¶äº†ä¸€ä¸ªç®€å•çš„ UML å›¾æ¥åŠ æ·±ç†è§£ï¼š</p><p><img src="./æ¨¡å— UML.png" alt="image.png"></p><h2 id="åŸºæœ¬æ•°æ®ç»“æ„"><a href="#åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="åŸºæœ¬æ•°æ®ç»“æ„"></a>åŸºæœ¬æ•°æ®ç»“æ„</h2><h3 id="æœ€å°å †"><a href="#æœ€å°å †" class="headerlink" title="æœ€å°å †"></a>æœ€å°å †</h3><p><strong>äºŒå‰å †ï¼ˆHeapï¼‰</strong> æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ã€‚å…¶åˆ†ä¸º<strong>æœ€å¤§å †ï¼ˆä¹Ÿå«å¤§æ ¹å †ï¼‰</strong> å’Œ <strong>æœ€å°å †ï¼ˆä¹Ÿå«å°æ ¹å †ï¼‰</strong>ï¼š</p><ol><li>æœ€å¤§å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å¤§è€…çš„å †</li><li>æœ€å°å †ï¼šæ ¹ç»“ç‚¹çš„é”®å€¼æ˜¯æ‰€æœ‰å †ç»“ç‚¹é”®å€¼ä¸­æœ€å°è€…çš„å †</li></ol><p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/heap.c" target="_blank" rel="noopener">beanstalkd/heap.c</a> æ˜¯å¯¹æœ€å°å †çš„å®ç°ã€‚é‚£ä¹ˆï¼Œbeanstalkd ä¸­å“ªäº›åœ°æ–¹ç”¨åˆ°äº†æœ€å°å †å‘¢ï¼Ÿ</p><ol><li>Tube ä¸­çš„å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—ï¼ˆæœ€å…ˆåˆ°æœŸçš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼Œè¿™æ ·å¯ä»¥åœ¨ O(1) æ—¶é—´å¤æ‚åº¦è·å–åˆ°ï¼‰</li><li>Tube ä¸­çš„å°±ç»ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆåŸºäºä¼˜å…ˆçº§æ’åˆ—ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ä¼šåœ¨å †é¡¶ï¼‰</li><li>Server ä¸­çš„å®¢æˆ·ç«¯è¿æ¥é˜Ÿåˆ—ï¼ˆåŸºäº tickat æ—¶é—´æ’åˆ—ï¼‰</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æœ€å°å †çš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">heapinsert(Heap *h, <span class="keyword">void</span> *x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰©å®¹ç­–ç•¥ï¼š2 å€é•¿åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;len == h-&gt;cap) &#123;</span><br><span class="line">        <span class="keyword">void</span> **ndata;</span><br><span class="line">        <span class="keyword">int</span> ncap = (h-&gt;len+<span class="number">1</span>) * <span class="number">2</span>; <span class="comment">/* allocate twice what we need */</span></span><br><span class="line"></span><br><span class="line">        ndata = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">void</span>*) * ncap);</span><br><span class="line">        <span class="keyword">if</span> (!ndata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(ndata, h-&gt;data, <span class="keyword">sizeof</span>(<span class="keyword">void</span>*)*h-&gt;len);</span><br><span class="line">        <span class="built_in">free</span>(h-&gt;data);</span><br><span class="line">        <span class="comment">// æŒ‡å‘æ–°çš„ä½ç½®</span></span><br><span class="line">        h-&gt;data = ndata;</span><br><span class="line">        <span class="comment">// æ›´æ–°å®¹é‡</span></span><br><span class="line">        h-&gt;cap = ncap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    k = h-&gt;len;</span><br><span class="line">    h-&gt;len++;</span><br><span class="line">    <span class="built_in">set</span>(h, k, x);</span><br><span class="line">    siftdown(h, k);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *</span><br><span class="line">heapremove(Heap *h, <span class="keyword">int</span> k)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (k &gt;= h-&gt;len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x = h-&gt;data[k];</span><br><span class="line">    h-&gt;len--;</span><br><span class="line">    <span class="comment">// ç”¨åŸæ¥çš„æ•°ç»„æœ€åä¸€ä½è¦†ç›–è¢«åˆ é™¤çš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">set</span>(h, k, h-&gt;data[h-&gt;len]);</span><br><span class="line">    siftdown(h, k);</span><br><span class="line">    siftup(h, k);</span><br><span class="line">    h-&gt;rec(x, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="built_in">set</span>(Heap *h, <span class="keyword">int</span> k, <span class="keyword">void</span> *x)</span><br><span class="line">&#123;</span><br><span class="line">    h-&gt;data[k] = x;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼šå»è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    h-&gt;rec(x, k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­ä½ç½® a æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å°äº b æŒ‡å‘çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">less(Heap *h, <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// h-&gt;less æ˜¯ä¸€ä¸ªåˆ¤æ–­å¤§å°çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">// å…¶å®è¦åœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œå®Œå…¨å¯ä»¥è‡ªå®šä¸€ä¸ªå®ç°äº†æ¯”è¾ƒå¤§å°çš„æ¥å£</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚åœ¨ Rust ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `PartialEq` é™å®š...</span></span><br><span class="line">    <span class="keyword">return</span> h-&gt;less(h-&gt;data[a], h-&gt;data[b]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å˜é•¿æ•°ç»„"><a href="#å˜é•¿æ•°ç»„" class="headerlink" title="å˜é•¿æ•°ç»„"></a>å˜é•¿æ•°ç»„</h3><p>åœ¨ C è¯­è¨€æ ‡å‡†åº“ä¸­æ˜¯æ²¡æœ‰å¯å˜é•¿åº¦çš„æ•°ç»„å®ç°çš„ï¼Œæ‰€ä»¥åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/ms.c" target="_blank" rel="noopener">beanstalkd/ms.c</a> å®ç°äº†ä¸€ç§ç±»ä¼¼çš„æ•°æ®ç»“æ„ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><code>ms</code> ç»“æ„ä½“ç»´æŠ¤ä¸€ä¸ªå¯åŠ¨æ€æ‰©å®¹çš„æ•°ç»„ï¼ˆ**itemsï¼‰</li><li>æ‰©å®¹ç­–ç•¥å¾ˆç²—æš´ï¼Œç›´æ¥æ‰©å……ä¸ºåŸæ¥å®¹é‡çš„ä¸¤å€</li><li>æ’å…¥çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li><li>åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li><li>ç”±äºåˆ é™¤æ—¶ï¼Œä¼šå°†å°¾éƒ¨ item æ›¿æ¢æ‰è¢«åˆ é™¤çš„ itemï¼Œæ‰€ä»¥ä¸èƒ½ä¾èµ–æ•°ç»„ä¸­çš„å…ƒç´ é¡ºåºï¼ˆé¡ºåºä¸ä¿è¯å’Œæ·»åŠ æ—¶ä¸€è‡´ï¼‰</li><li>åˆ é™¤ item åï¼Œå…¶å®æ•°ç»„å ç”¨çš„å†…å­˜ç©ºé—´è¿˜åœ¨ï¼ˆå¹¶æ²¡æœ‰åŠ¨æ€ç¼©å®¹çš„ç­–ç•¥ï¼‰</li></ol><p>é‚£å…·ä½“åœ¨å“ªäº›åœ°æ–¹ç”¨åˆ°äº† <code>ms</code> è¿™ç§æ•°æ®ç»“æ„å‘¢ï¼Ÿæ¢³ç†åï¼Œä¸»è¦å‘ç°ä»¥ä¸‹å‡ å¤„ï¼š</p><ol><li>å…¨å±€çš„ <a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/tube.c#L6" target="_blank" rel="noopener">Tube åˆ—è¡¨</a></li><li>å®¢æˆ·ç«¯è¿æ¥çš„ <code>Conn</code> ä¸­ç»´æŠ¤çš„ <a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/dat.h#L296" target="_blank" rel="noopener">watch list</a></li><li>ä¸ Tube å…³è”çš„<a href="https://github.com/beanstalkd/beanstalkd/blob/b5a6f7a23a368ffb31fbf48cdffe95541166d3fa/dat.h#L161" target="_blank" rel="noopener">ç­‰å¾…è¿æ¥ï¼ˆconnsï¼‰åˆ—è¡¨</a></li></ol><p>ä¸‹é¢çœ‹çœ‹å…¶å…·ä½“çš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°ç»„ï¼Œå¹¶æ³¨å†Œæ’å…¥å’Œç§»é™¤çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ms_init(ms a, ms_event_fn oninsert, ms_event_fn onremove)</span><br><span class="line">&#123;</span><br><span class="line">    a-&gt;used = a-&gt;cap = a-&gt;last = <span class="number">0</span>;</span><br><span class="line">    a-&gt;items = <span class="literal">NULL</span>;</span><br><span class="line">    a-&gt;oninsert = oninsert;</span><br><span class="line">    a-&gt;onremove = onremove;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶æ•°ç»„å¢é•¿</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">grow(ms a)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> **nitems;</span><br><span class="line">    <span class="comment">// å€é€Ÿå¢é•¿ï¼š1, 2, 4, ...</span></span><br><span class="line">    <span class="keyword">size_t</span> ncap = (a-&gt;cap &lt;&lt; <span class="number">1</span>) ? : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    nitems = <span class="built_in">malloc</span>(ncap * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="keyword">if</span> (!nitems) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ—§çš„æ•°æ®æ‹·è´åˆ°æ–°å¼€è¾Ÿçš„ç©ºé—´</span></span><br><span class="line">    <span class="built_in">memcpy</span>(nitems, a-&gt;items, a-&gt;used * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ—§çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">    <span class="built_in">free</span>(a-&gt;items);</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ–°çš„ä½ç½®</span></span><br><span class="line">    a-&gt;items = nitems;</span><br><span class="line">    <span class="comment">// æ›´æ–°æ•°ç»„å®¹é‡</span></span><br><span class="line">    a-&gt;cap = ncap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ•°ç»„å°¾éƒ¨æ’å…¥æ–°çš„ item</span></span><br><span class="line"><span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">ms_append(ms a, <span class="keyword">void</span> *item)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æŒ‰éœ€æ‰©å±•å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;used &gt;= a-&gt;cap) grow(a);</span><br><span class="line">    <span class="comment">// æ‰©å®¹å¤±è´¥ï¼Œå°±è¿”å›ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å†æ–°å¢ item äº†</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;used &gt;= a-&gt;cap) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    a-&gt;items[a-&gt;used++] = item;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰å›è°ƒï¼Œåˆ™è§¦å‘å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;oninsert) a-&gt;oninsert(a, item, a-&gt;used - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤æŒ‡å®šä½ç½®çš„ item</span></span><br><span class="line"><span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">ms_delete(ms a, <span class="keyword">size_t</span> i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= a-&gt;used) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    item = a-&gt;items[i];</span><br><span class="line">    <span class="comment">// ç›¸å½“äºæŠŠå°¾éƒ¨ item å†™åˆ°è¢«åˆ é™¤çš„ä½ç½®ï¼Œå¹¶ã€Œç¼©å®¹ã€</span></span><br><span class="line">    a-&gt;items[i] = a-&gt;items[--a-&gt;used];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* it has already been removed now */</span></span><br><span class="line">    <span class="keyword">if</span> (a-&gt;onremove) a-&gt;onremove(a, item, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h3><p><img src="./å­—å…¸.png" alt="image.png"></p><p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/job.c" target="_blank" rel="noopener">beanstalkd/job.c</a> ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿åŸºäº <code>job_id</code> å¿«é€Ÿå®šä½åˆ°å…·ä½“çš„ä»»åŠ¡ï¼Œä½œè€…å®ç°äº†ä¸€ä¸ªå­—å…¸æ•°æ®ç»“æ„ã€‚è¿™é‡Œæ˜¯å’Œ job è€¦åˆåœ¨ä¸€èµ·å®ç°çš„ï¼Œæ ¹æ®å¯¹æºç çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºè¯¥å­—å…¸æ•°æ®ç»“æ„çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>é‡‡ç”¨åŸºäº <code>job_id</code> å“ˆå¸Œå–æ¨¡çš„æ–¹å¼è®¡ç®— <code>slot_id</code></li><li>ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çª</li><li>æ ¹æ®è´Ÿè½½å› å­è‡ªåŠ¨è¿›è¡Œ rehashï¼ˆè¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹ï¼‰ï¼Œæ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç³»æ•°æ ¹æ® <a href="https://github.com/beanstalkd/beanstalkd/blob/master/primes.c" target="_blank" rel="noopener">beanstalkd/primes.c</a> è®¾ç½®</li><li>rehash è¿‡ç¨‹å¹¶æ²¡æœ‰é‡‡ç”¨ç±»ä¼¼ Redis ä¸­æ¸è¿›å¼ rehash æœºåˆ¶ï¼Œè€Œæ˜¯é˜»å¡å¼å®Œæˆæ•´ä¸ªå“ˆå¸Œè¡¨çš„ rehash åæ‰å¯ä»¥è¿›è¡Œåç»­æ“ä½œ</li></ol><p>å­˜æ”¾ job åŠ rehash çš„è¯¦ç»†æºç åˆ†æå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾ä¸€ä¸ª job</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">store_job(job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    index = _get_job_hash_index(j-&gt;r.id);</span><br><span class="line"></span><br><span class="line">    j-&gt;ht_next = all_jobs[index]; <span class="comment">// å¦‚æœå­˜åœ¨å†²çªï¼Œå°±é‡‡ç”¨é“¾åœ°å€æ³•</span></span><br><span class="line">    all_jobs[index] = j;</span><br><span class="line">    all_jobs_used++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* accept a load factor of 4 */</span></span><br><span class="line">    <span class="comment">// è´Ÿè½½å› å­è®¾ç½®ä¸º 4ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡Œ rehash</span></span><br><span class="line">    <span class="comment">// çœ‹èµ·è¿™é‡Œæ˜¯é˜»å¡çš„æ–¹å¼æ¥è¿›è¡Œ rehash äº†ï¼Œå¦‚æœ hash è¡¨å¤ªå¤§ï¼Œä¼šè¢«é˜»å¡</span></span><br><span class="line">    <span class="comment">// å¹¶æ²¡æœ‰ä½¿ç”¨ç±»ä¼¼ redis é‚£æ ·æ¸è¿›å¼ rehash æ€è·¯</span></span><br><span class="line">    <span class="keyword">if</span> (all_jobs_used &gt; (all_jobs_cap &lt;&lt; <span class="number">2</span>)) rehash(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¯æŒæ‰©å®¹å’Œç¼©å®¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">rehash(<span class="keyword">int</span> is_upscaling)</span><br><span class="line">&#123;</span><br><span class="line">    job *old = all_jobs;</span><br><span class="line">    <span class="comment">// è®°å½•ä¸‹æ—§çš„ hash è¡¨å®¹é‡ï¼Œå…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">size_t</span> old_cap = all_jobs_cap, old_used = all_jobs_used, i;</span><br><span class="line">    <span class="keyword">int</span> old_prime = cur_prime;</span><br><span class="line">    <span class="keyword">int</span> d = is_upscaling ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cur_prime + d &gt;= NUM_PRIMES) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (cur_prime + d &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_upscaling &amp;&amp; hash_table_was_oom) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    cur_prime += d;</span><br><span class="line"></span><br><span class="line">    all_jobs_cap = primes[cur_prime];</span><br><span class="line">    all_jobs = <span class="built_in">calloc</span>(all_jobs_cap, <span class="keyword">sizeof</span>(job));</span><br><span class="line">    <span class="keyword">if</span> (!all_jobs) &#123; <span class="comment">// é’ˆå¯¹æ‰©å®¹å¤±è´¥çš„å¤„ç†ï¼Œæ¢å¤åŸæ¥çš„ä¸å˜ï¼Œä½†æ˜¯æ ‡è®° OOM</span></span><br><span class="line">        twarnx(<span class="string">"Failed to allocate %zu new hash buckets"</span>, all_jobs_cap);</span><br><span class="line">        hash_table_was_oom = <span class="number">1</span>;</span><br><span class="line">        cur_prime = old_prime;</span><br><span class="line">        all_jobs = old;</span><br><span class="line">        all_jobs_cap = old_cap;</span><br><span class="line">        all_jobs_used = old_used;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡ç½® hash è¡¨çŠ¶æ€</span></span><br><span class="line">    all_jobs_used = <span class="number">0</span>;</span><br><span class="line">    hash_table_was_oom = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¶å®å°±æ˜¯æŠŠ Hash è¡¨ä¸Šæ‰€æœ‰çš„ jobs å…¨éƒ¨æ˜ å°„åˆ°æ–°çš„ç©ºé—´</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; old_cap; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (old[i]) &#123;</span><br><span class="line">            job j = old[i];</span><br><span class="line">            old[i] = j-&gt;ht_next;</span><br><span class="line">            j-&gt;ht_next = <span class="literal">NULL</span>;</span><br><span class="line">            store_job(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç„¶åæŠŠåŸæ¥çš„å†…å­˜ç©ºé—´é‡Šæ”¾æ‰</span></span><br><span class="line">    <span class="keyword">if</span> (old != all_jobs_init) &#123;</span><br><span class="line">        <span class="built_in">free</span>(old);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h3><p>é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„åœ¨ Beanstalkd å®ç°ä¸­ç”¨å¾—æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”å¦‚</p><ol><li><a href="https://github.com/beanstalkd/beanstalkd/blob/master/walg.c" target="_blank" rel="noopener">beanstalkd/walg.c</a> ä¸­ä½¿ç”¨äº†å•å‘é“¾è¡¨çš„ä¸²è”äº†ä¸€äº›åˆ—çš„æ—¥å¿—æ–‡ä»¶ï¼ˆå‚è§ä¸‰ä¸ªæ¸¸æ ‡æŒ‡é’ˆï¼š<code>head</code>, <code>cur</code>, <code>tail</code>ï¼‰</li><li><a href="https://github.com/beanstalkd/beanstalkd/blob/master/conn.c" target="_blank" rel="noopener">beanstalkd/conn.c</a> ä½¿ç”¨åŒå‘é“¾è¡¨è¿æ¥äº†ä¸€äº›åˆ—è¢« <code>reserve</code> çš„ä»»åŠ¡</li></ol><p>åœ¨ <a href="https://github.com/beanstalkd/beanstalkd/blob/master/job.c" target="_blank" rel="noopener">beastalkd/job.c</a>ï¼Œå¯ä»¥çœ‹åˆ°ä»»åŠ¡åŒå‘é“¾è¡¨å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">job_list_any_p(job head)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> head-&gt;next != head || head-&gt;prev != head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">job</span><br><span class="line">job_remove(job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!j) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!job_list_any_p(j)) <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* not in a doubly-linked list */</span></span><br><span class="line"></span><br><span class="line">    j-&gt;next-&gt;prev = j-&gt;prev;</span><br><span class="line">    j-&gt;prev-&gt;next = j-&gt;next;</span><br><span class="line"></span><br><span class="line">    j-&gt;prev = j-&gt;next = j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">job_insert(job head, job j)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (job_list_any_p(j)) <span class="keyword">return</span>; <span class="comment">/* already in a linked list */</span></span><br><span class="line"></span><br><span class="line">    j-&gt;prev = head-&gt;prev;</span><br><span class="line">    j-&gt;next = head;</span><br><span class="line">    head-&gt;prev-&gt;next = j;</span><br><span class="line">    head-&gt;prev = j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ "><a href="#éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ " class="headerlink" title="éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ "></a>éƒ¨åˆ†æ¨¡å—æºç å­¦ä¹ </h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv) &#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    <span class="comment">// å­˜æ”¾ä»»åŠ¡çš„é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job</span> <span class="title">list</span> = &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    progname = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// è®¾ç½®ä½¿ç”¨è¡Œç¼“å­˜ï¼Œè¡¨ä½¿ç”¨æ ‡å‡†è¾“å‡ºä½œä¸ºæ‰“å°ç›®æ ‡</span></span><br><span class="line">    <span class="comment">// è¯¦ç»†æ–‡æ¡£å‚è§ï¼šhttps://linux.die.net/man/3/setlinebuf</span></span><br><span class="line">    <span class="comment">// æ„æ€æ˜¯ï¼Œåªæœ‰åœ¨æ»¡è¶³ä¸€è¡Œï¼ˆæ¢è¡Œï¼‰æ—¶æ‰è¾“å‡º</span></span><br><span class="line">    setlinebuf(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="comment">// å‘½ä»¤è¡Œå¤„ç†</span></span><br><span class="line">    optparse(&amp;srv, argv + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"pid %d\n"</span>, getpid());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ç«¯ socket åˆå§‹åŒ–ç­‰ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ socket çš„ file descriptor</span></span><br><span class="line">    r = make_server_socket(srv.addr, srv.port);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) twarnx(<span class="string">"make_server_socket()"</span>), <span class="built_in">exit</span>(<span class="number">111</span>);</span><br><span class="line">    srv.sock.fd = r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åè®®å¤„ç†æ¨¡å—åˆå§‹åŒ–</span></span><br><span class="line">    prot_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (srv.user) su(srv.user);</span><br><span class="line">    set_sig_handlers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (srv.wal.use) &#123;</span><br><span class="line">        <span class="comment">// We want to make sure that only one beanstalkd tries</span></span><br><span class="line">        <span class="comment">// to use the wal directory at a time. So acquire a lock</span></span><br><span class="line">        <span class="comment">// now and never release it.</span></span><br><span class="line">        <span class="comment">// WAL å³ Write Ahead Log Directoryï¼Œä¸»è¦æ˜¯è®°å½•æ—¥å¿—ç”¨</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯è¦ä¿è¯æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ª beanstalkd å®ä¾‹ä½¿ç”¨ WAL ç›®å½•ï¼Œé˜²æ­¢ç›¸äº’å†™å…¥å†²çª</span></span><br><span class="line">        <span class="comment">// é‚£ä¼°è®¡ä»¥åå°±æ²¡æ³•ä» binlog æ¢å¤ä»»åŠ¡äº†ã€‚ã€‚ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!waldirlock(&amp;srv.wal)) &#123;</span><br><span class="line">            twarnx(<span class="string">"failed to lock wal dir %s"</span>, srv.wal.dir);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä»»åŠ¡é“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨ï¼‰</span></span><br><span class="line">        <span class="built_in">list</span>.prev = <span class="built_in">list</span>.next = &amp;<span class="built_in">list</span>;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– WALï¼Œå¦‚æœ log ä¸­æœ‰ä»»åŠ¡ï¼Œè¿˜è¦æ¢å¤å›æ¥ï¼ŒæŒ‚è½½åˆ° job list</span></span><br><span class="line">        walinit(&amp;srv.wal, &amp;<span class="built_in">list</span>);</span><br><span class="line">        <span class="comment">// å›æ”¾ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">        r = prot_replay(&amp;srv, &amp;<span class="built_in">list</span>);</span><br><span class="line">        <span class="keyword">if</span> (!r) &#123;</span><br><span class="line">            twarnx(<span class="string">"failed to replay log"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£å¼å¯åŠ¨ serverï¼Œå¹¶ç›‘å¬è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚äº†</span></span><br><span class="line">    srvserve(&amp;srv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="./å¯åŠ¨æµç¨‹.png" alt="image.png"></p><h3 id="serv-c"><a href="#serv-c" class="headerlink" title="serv.c"></a>serv.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">srvserve(Server *s)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    Socket *sock;</span><br><span class="line">    int64 period;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sockinit() == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarnx(<span class="string">"sockinit"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;sock.x = s;</span><br><span class="line">    <span class="comment">// æŒ‡å®šå›è°ƒï¼Œå½“æ¥æ”¶åˆ° `r` äº‹ä»¶åï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ</span></span><br><span class="line">    s-&gt;sock.f = (Handle)srvaccept;</span><br><span class="line">    <span class="comment">// Server ç»´æŠ¤äº†å…³è”çš„å®¢æˆ·ç«¯è¿æ¥ï¼ˆæœ€å°å †ï¼‰</span></span><br><span class="line">    s-&gt;conns.less = (Less)connless;</span><br><span class="line">    s-&gt;conns.rec = (Record)connrec;</span><br><span class="line"></span><br><span class="line">    r = listen(s-&gt;sock.fd, <span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarn(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œ</span></span><br><span class="line">    r = sockwant(&amp;s-&gt;sock, <span class="string">'r'</span>);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) &#123;</span><br><span class="line">        twarn(<span class="string">"sockwant"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå‘¨æœŸæ€§çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// å¦‚æœ tick ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ—¶é—´è¿‡ä¹…ï¼Œä¼šé˜»å¡åé¢çš„ socket connection å¤„ç†</span></span><br><span class="line">        <span class="comment">// ä¸¥é‡ä¼šå¯¼è‡´è¶…æ—¶ï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯é‡è¯•è¿‡å¤šï¼Œåˆ™å›å¢åŠ æœåŠ¡ç«¯è´Ÿè½½</span></span><br><span class="line">        period = prottick(s);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è½®è¯¢æ˜¯å¦æœ‰å°±ç»ªçš„è¯·æ±‚ï¼ˆrwï¼‰ï¼Œå…¶å®å°±æ˜¯ä¸ªé€‚é…å™¨ï¼Œå°†å…·ä½“å¹³å°ä¸‹è¿”å›çš„çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// è½¬æ¢æˆç»Ÿä¸€çš„ `r`, `w`, `h`</span></span><br><span class="line">        <span class="comment">// Linux ä½¿ç”¨ epoll å°è£…ï¼ˆå‚è§ `linux.c`ï¼‰</span></span><br><span class="line">        <span class="comment">// Unix ä½¿ç”¨ kqueue å°è£…ï¼ˆå‚è§ `darwin.c`ï¼‰</span></span><br><span class="line">        <span class="keyword">int</span> rw = socknext(&amp;sock, period);</span><br><span class="line">        <span class="keyword">if</span> (rw == <span class="number">-1</span>) &#123;</span><br><span class="line">            twarnx(<span class="string">"socknext"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rw) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè½®è¯¢åˆ°éœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å›è°ƒ Handle</span></span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„å›è°ƒä¾ç„¶åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¦‚æœä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œå°±å‘µå‘µå“’äº†</span></span><br><span class="line">            sock-&gt;f(sock-&gt;x, rw);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="tube-c"><a href="#tube-c" class="headerlink" title="tube.c"></a>tube.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»º tubeï¼Œè¿™é‡Œéœ€è¦ç»™å®š tube åç§°</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª tube æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç»„æˆï¼š</span></span><br><span class="line"><span class="comment">// 1. ç»´æŠ¤å°±ç»ªä»»åŠ¡çš„å †</span></span><br><span class="line"><span class="comment">// 2. ç»´æŠ¤å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„å †</span></span><br><span class="line"><span class="comment">// 3. ç»´æŠ¤å¤„äº buried çŠ¶æ€çš„ä»»åŠ¡é“¾è¡¨</span></span><br><span class="line"><span class="comment">// 4. ç»´æŠ¤ä¸€ä¸ªç­‰å¾…åˆ—è¡¨</span></span><br><span class="line">tube</span><br><span class="line">make_tube(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    tube t;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…å†…å­˜ç©ºé—´ï¼Œç”¨äºå­˜å‚¨ tube ç»“æ„ä½“å€¼</span></span><br><span class="line">    t = <span class="keyword">new</span>(struct tube);</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– tube åç§°</span></span><br><span class="line">    t-&gt;name[MAX_TUBE_NAME_LEN - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(t-&gt;name, name, MAX_TUBE_NAME_LEN - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;name[MAX_TUBE_NAME_LEN - <span class="number">1</span>] != <span class="string">'\0'</span>) twarnx(<span class="string">"truncating tube name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ready å †ç»´æŠ¤ç€ä¸€äº›å·²ç»å°±ç»ªçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‡å®šæŒ‰ç…§ job ä¼˜å…ˆçº§çš„æ–¹å¼æ¯”è¾ƒå¤§å°</span></span><br><span class="line">    <span class="comment">// è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ job</span></span><br><span class="line">    t-&gt;ready.less = job_pri_less;</span><br><span class="line">    <span class="comment">// delay å †ç»´æŠ¤ç€ä¸€äº›è¢«å»¶è¿Ÿæ‰§è¡Œçš„ jobsï¼Œè¿™é‡Œæ˜¯æŒ‰ç…§ job delay æ—¶é—´æ¯”è¾ƒå¤§å°</span></span><br><span class="line">    <span class="comment">// è¿™æ ·ï¼Œè¿™ä¸ªå †é¡¶å°±æ˜¯å»¶è¿Ÿæ—¶é—´æœ€çŸ­çš„ job</span></span><br><span class="line">    t-&gt;delay.less = job_delay_less;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè®°å½• job åœ¨å †ä¸Šçš„ä½ç½®</span></span><br><span class="line">    t-&gt;ready.rec = job_setheappos;</span><br><span class="line">    t-&gt;delay.rec = job_setheappos;</span><br><span class="line">    t-&gt;buried = (struct job) &#123; &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é“¾è¡¨ç»´æŠ¤ç€è¢« bury æ‰çš„ job</span></span><br><span class="line">    t-&gt;buried.prev = t-&gt;buried.next = &amp;t-&gt;buried;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ’é˜Ÿåˆ—è¡¨</span></span><br><span class="line">    ms_init(&amp;t-&gt;waiting, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾ tube</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">tube_free(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å®é™…å°±æ˜¯ä»å…¨å±€çš„ tubes åˆ—è¡¨ä¸­ç§»é™¤è¯¥ tube</span></span><br><span class="line">    prot_remove_tube(t);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å°±ç»ªçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">free</span>(t-&gt;ready.data);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å»¶è¿Ÿçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">free</span>(t-&gt;delay.data);</span><br><span class="line">    <span class="comment">// æ¸…ç©ºç­‰å¾…åˆ—è¡¨</span></span><br><span class="line">    ms_clear(&amp;t-&gt;waiting);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ tube æŒ‡å‘çš„å†…å­˜</span></span><br><span class="line">    <span class="built_in">free</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨è®¡æ•°ï¼šå‡å¼•ç”¨</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">tube_dref(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;refs &lt; <span class="number">1</span>) <span class="keyword">return</span> twarnx(<span class="string">"refs is zero for tube: %s"</span>, t-&gt;name);</span><br><span class="line"></span><br><span class="line">    --t-&gt;refs;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰å¼•ç”¨åå°±å¯ä»¥é‡Šæ”¾è¯¥ tube äº†</span></span><br><span class="line">    <span class="keyword">if</span> (t-&gt;refs &lt; <span class="number">1</span>) tube_free(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨è®¡æ•°ï¼šå¢åŠ å¼•ç”¨</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">tube_iref(tube t)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span>;</span><br><span class="line">    ++t-&gt;refs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å»ºä¸€ä¸ª tubeï¼Œç„¶åæ³¨å†Œåˆ°å…¨å±€ tubes åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">static</span> tube</span><br><span class="line">make_and_insert_tube(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    tube t = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    t = make_tube(name);</span><br><span class="line">    <span class="keyword">if</span> (!t) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We want this global tube list to behave like "weak" refs, so don't</span></span><br><span class="line"><span class="comment">     * increment the ref count. */</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯æƒ³è®©å…¨å±€ tube åˆ—è¡¨è¡¨ç°ä¸ºå¼±å¼•ç”¨ï¼Œæ‰€è¿™é‡Œå¹¶æ²¡æœ‰åšå¢åŠ å¼•ç”¨çš„æ“ä½œ</span></span><br><span class="line">    r = ms_append(&amp;tubes, t);</span><br><span class="line">    <span class="comment">// å¦‚æœæ³¨å†Œ tube å¤±è´¥ï¼Œå‡å¼•ç”¨ï¼Œå¿…è¦çš„è¯ä¼šè¢«é‡Šæ”¾æ‰</span></span><br><span class="line">    <span class="keyword">if</span> (!r) <span class="keyword">return</span> tube_dref(t), (tube) <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="job-c"><a href="#job-c" class="headerlink" title="job.c"></a>job.c</h3><p>åœ¨ Tube ä¸­æœ‰ä¸¤ä¸ªæœ€å°å †æ•°æ®ç»“æ„åˆ†åˆ«å­˜æ”¾è¢«å»¶è¿Ÿçš„ä»»ä½•å’Œå°±ç»ªçš„ä»»åŠ¡ï¼Œè¿™ä¸¤ç§ä½¿ç”¨çš„æ’åºæ–¹å¼æ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬çœ‹åˆ°åœ¨ä¸Šé¢çš„ Tube åˆå§‹åŒ–æ—¶ï¼Œç»™ä¸¤ä¸ªå †ç»‘å®šäº†ä¸åŒçš„æ¯”è¾ƒå¤§å°çš„å›è°ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t-&gt;ready.less = job_pri_less;</span><br><span class="line">t-&gt;delay.less = job_delay_less;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹å¯ä»¥çœ‹åˆ°å…·ä½“çš„æ’åºæ–¹å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºä¼˜å…ˆçº§æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">job_pri_less(<span class="keyword">void</span> *ax, <span class="keyword">void</span> *bx)</span><br><span class="line">&#123;</span><br><span class="line">    job a = ax, b = bx;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.pri &lt; b-&gt;r.pri) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.pri &gt; b-&gt;r.pri) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;r.id &lt; b-&gt;r.id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°ï¼Œå…ˆåŸºäºåˆ°æœŸæ—¶é—´æ¯”è¾ƒå“ªä¸ªå°ï¼Œå†åŸºäº id æ¯”è¾ƒå“ªä¸ªå°</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">job_delay_less(<span class="keyword">void</span> *ax, <span class="keyword">void</span> *bx)</span><br><span class="line">&#123;</span><br><span class="line">    job a = ax, b = bx;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.deadline_at &lt; b-&gt;r.deadline_at) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;r.deadline_at &gt; b-&gt;r.deadline_at) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;r.id &lt; b-&gt;r.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è¯»åæ„Ÿ"><a href="#è¯»åæ„Ÿ" class="headerlink" title="è¯»åæ„Ÿ"></a>è¯»åæ„Ÿ</h1><p>æ•´ä¸ª Beanstalkd çš„æ ¸å¿ƒçš„ä»£ç ä¸è¿‡äº”åƒè¡Œå·¦å³ï¼Œä½†è¿™å°±å®ç°äº†ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œçš„ç¡®æ˜¯å¾ˆå‰å®³ã€‚ä¸è¿‡ï¼Œä¹Ÿæ­£å› ä¸ºå…¶å®ç°æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼ Redis çš„ä¸»ä»æœºåˆ¶ç­‰ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¹¶æ²¡æœ‰å®Œæ•´åœ°å‰–ææ‰€æœ‰çš„æ¨¡å—å®ç°ï¼Œåªæ˜¯åˆ—å‡ºäº†ä¸ªäººæ¯”è¾ƒæ„Ÿå…´è¶£çš„æ¨¡å—ï¼›å…³äº binlog ç®¡ç†çš„æºç ï¼ˆæ¯”å¦‚åƒåœ¾å›æ”¶ï¼Œå‹ç¼©ï¼Œé¢„ç•™ç©ºé—´ç”³è¯·ï¼Œä»»åŠ¡æ¢å¤ç­‰ï¼‰åªæ˜¯ç²—ç•¥åœ°é˜…è¯»äº†ä¸‹ï¼Œå°±ä¸åœ¨æ­¤å¤„çŒ®ä¸‘å•¦~</p><p>æ€»çš„æ¥è¯´ï¼Œå¯¹äºå•æœºæ¶ˆæ¯é˜Ÿåˆ—å®ç°æ„Ÿå…´è¶£çš„åŒå­¦è¿˜æ˜¯æ¨èé˜…è¯»ä¸‹è¯¥ç³»ç»Ÿçš„æºç ï¼Œå¯ä»¥å­¦ä¹ å…¶ä¸­çš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œå®ç°æ€è·¯ç­‰~</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="http://www.hulkdev.com/posts/think_in_beanstalkd" target="_blank" rel="noopener">beanstalkd çš„ä¸€äº›çœ‹æ³•</a></li><li><a href="https://github.com/beanstalkd/beanstalkd" target="_blank" rel="noopener">beanstalkd repo</a></li><li><a href="https://beanstalkd.github.io/" target="_blank" rel="noopener">beanstalkd docs</a></li><li><a href="https://segmentfault.com/a/1190000016067218" target="_blank" rel="noopener">æ¶ˆæ¯é˜Ÿåˆ— beanstalkd æºç è¯¦è§£</a></li><li><a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E5%A4%A7%E2%80%94%E6%9C%80%E5%B0%8F%E5%A0%86" target="_blank" rel="noopener">æœ€å¤§â€”æœ€å°å †</a></li></ol><h1 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h1><ol><li><a href="https://www.cnblogs.com/FG123/p/5256553.html" target="_blank" rel="noopener">Kqueue ä¸ Epoll æœºåˆ¶</a></li><li><a href="https://juejin.im/entry/59376d450ce4630057427d53" target="_blank" rel="noopener">ä» 0åˆ° 100â€”â€”çŸ¥ä¹æ¶æ„å˜è¿å²</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;Beanstalkd æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œå¯¹äºæ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼ˆç›¸å¯¹äº RabbitMQ, Redis, Kafka ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯éå¸¸åˆé€‚ï¼›æ­¤å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒç»™ä»»åŠ¡è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€æ‰§è¡Œè¶…æ—¶æ—¶é—´ç­‰ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="http://ifaceless.space/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
      <category term="æºç é˜…è¯»" scheme="http://ifaceless.space/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    
      <category term="æ¶ˆæ¯é˜Ÿåˆ—" scheme="http://ifaceless.space/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
      <category term="Beanstalkd" scheme="http://ifaceless.space/tags/Beanstalkd/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹å­¦ä¹ ç¬”è®°ä¹‹ç¼–ç¨‹èŒƒå¼</title>
    <link href="http://ifaceless.space/2019/01/03/clean-arch-notes-paradigms/"/>
    <id>http://ifaceless.space/2019/01/03/clean-arch-notes-paradigms/</id>
    <published>2019-01-03T00:41:52.000Z</published>
    <updated>2019-06-24T00:49:40.528Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>è¿‘æ¥å¼€å§‹é˜…è¯» Robert C. Martin çš„æ–°è‘—ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹ï¼ˆ<em>Clean Architecture</em>ï¼‰ã€‚æ²¡æœ‰äººæ„¿æ„çœ‹åˆ°å›¢é˜Ÿå†…çš„é¡¹ç›®é€æ¸å‘å±•æˆä¸€å›¢ä¹±éº»ï¼Œç›¸äº’çº ç¼ ã€‚é‚£å¦‚ä½•ä»æ ¹æœ¬ä¸Šå‡å°‘è¿™ç§é—®é¢˜çš„å‘ç”Ÿå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬æŒæ¡ä¸€äº›å®è§‚å±‚é¢çš„è®¾è®¡æ€æƒ³ï¼Œä»ç»™é¡¹ç›®æ‰“åŸºç¡€æ—¶å°±åº”è¯¥è€ƒè™‘å¥½å„ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°ç­‰å¦‚ä½•è®¾è®¡æˆ<strong>é«˜å†…èšã€ä½è€¦åˆ</strong>çš„ç»“æ„ã€‚æ•´æ´çš„é¡¹ç›®æ¶æ„æ˜¯åˆ©äºé•¿è¿œå‘å±•çš„ï¼Œè¿™ç¯‡ç¬”è®°å°†ä¼šè®°å½•ä¸€äº›ä»ä¹¦ä¸­å­¦ä¹ åˆ°çš„é‡è¦çŸ¥è¯†ç‚¹ï¼Œä¾¿äºåæœŸå¤ä¹ å’Œå‚è€ƒã€‚</p><p>å½“ç„¶ï¼Œä½œè€…è¿˜æœ‰ä¸€æœ¬å¤§åé¼é¼çš„è‘—ä½œã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ä¹Ÿéå¸¸å€¼å¾—é˜…è¯»ï¼Œå…³äºè¿™æœ¬ä¹¦ä¹Ÿåšäº†ç‚¹ç¬”è®°ï¼Œå‚è§<a href="https://ifaceless.github.io/2018/11/04/clean-code-notes/" target="_blank" rel="noopener">ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹è¯»ä¹¦ç¬”è®°</a>~</p><a id="more"></a><h1 id="è¦ç‚¹è®°å½•"><a href="#è¦ç‚¹è®°å½•" class="headerlink" title="è¦ç‚¹è®°å½•"></a>è¦ç‚¹è®°å½•</h1><p>ä¸‰å¤§ç¼–ç¨‹èŒƒå¼æ˜¯æ ¹åŸºï¼Œæ¯ç§èŒƒå¼å…¶å®éƒ½ç»™æˆ‘ä»¬å¸¦èµ°äº†ä¸€äº›ä¸œè¥¿ï¼š<code>goto</code> è¯­å¥ã€å‡½æ•°æŒ‡é’ˆã€èµ‹å€¼ã€‚ä¸‰ç§ç¼–ç¨‹èŒƒå¼çš„æ€»ç»“ï¼š</p><ol><li><strong>ç»“æ„åŒ–ç¼–ç¨‹</strong>ï¼š<strong>Discovered by Edsger Wybe Dijkstra in 1968</strong>. <em>Structured programming imposes discipline on direct transfer of control.</em></li><li><strong>é¢å‘å¯¹è±¡ç¼–ç¨‹</strong>ï¼š<strong>Discovered by Ole Johan and Kristen Nygaard in 1966</strong>. <em>Object-oriented programming imposes discipline on indirect transfer of control.</em></li><li><strong>å‡½æ•°å¼ç¼–ç¨‹</strong>ï¼š<strong>Invented by Alonzo Church in 1936</strong>. <em>Functional programming imposes discipline upon assignment.</em></li></ol><p>ä»¥ä¸Šä¸‰ç§ç¼–ç¨‹èŒƒå¼ä¼šå½±å“åˆ°æ¶æ„çš„æ–¹æ–¹é¢é¢ï¼šæˆ‘ä»¬ä½¿ç”¨å¤šæ€æœºåˆ¶è·¨è¶Šæ¶æ„è¾¹ç•Œï¼›ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹å½±å“æ•°æ®ä½ç½®å’Œè®¿é—®ï¼›ä½¿ç”¨ç»“æ„åŒ–ç¼–ç¨‹æ„å»ºåŸºç¡€ç®—æ³•æ¨¡å—ï¼ˆåŸºçŸ³ï¼‰ã€‚<strong>å¯ä»¥å¯¹ç…§è½¯ä»¶æ¶æ„ä¸‰å¤§æ¦‚å¿µï¼šåŠŸèƒ½ã€ç»„ä»¶éš”ç¦»å’Œæ•°æ®ç®¡ç†</strong>ã€‚</p><h2 id="ç»“æ„åŒ–ç¼–ç¨‹"><a href="#ç»“æ„åŒ–ç¼–ç¨‹" class="headerlink" title="ç»“æ„åŒ–ç¼–ç¨‹"></a>ç»“æ„åŒ–ç¼–ç¨‹</h2><ol><li><p>ä»»ä½•ç¨‹åºéƒ½å¯ä»¥ç”±ä¸‰ç§ç»“æ„ç»„æˆï¼š</p><ol><li>Sequence</li><li>Selection</li><li>Iteration</li></ol></li><li><p>ç»“æ„åŒ–ç¼–ç¨‹å…è®¸æ¨¡å—å¯ä»¥è¢«é€’å½’åœ°åˆ†å‰²æˆå¾ˆå¤šå°çš„å¯è¢«è¯æ˜çš„å•å…ƒï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ¨¡å—å¯ä»¥æŒ‰ç…§åŠŸèƒ½è§£è€¦</p></li><li>ç§‘å­¦å¹¶éä¾é è¯æ˜æŸäº›å£°æ˜æ­£ç¡®è€Œå­˜åœ¨ï¼Œè€Œæ˜¯è¯æ˜å®ƒä»¬æ˜¯é”™è¯¯çš„ï¼ˆ<em>Science does not work by proving statements true, but rather by proving statements false</em>ï¼‰ã€‚å¹¶éæ‰€æœ‰çš„äº‹æƒ…éƒ½å¯ä»¥è¢«è¯å®çš„~</li><li><em>Mathmematics is the discipline of proving provable statements true. Science, in contrast, is the discipline of proving provable statements false</em></li><li>Dijkstra æ›¾ç»è¯´è¿‡ <em>Testing shows the presence, not the absence, of bugs</em>ã€‚æµ‹è¯•å¹¶ä¸èƒ½ä¿è¯ä½ çš„ç¨‹åºä¸€å®šæ­£ç¡®ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æµ‹è¯•è¯æ˜ä½ çš„ç¨‹åºå­˜åœ¨é”™è¯¯ï¼Œå¹¶é€šè¿‡å……åˆ†æµ‹è¯•ï¼Œè®©ä½ çš„ç¨‹åºæ›´åŠ æ­£ç¡®ï¼Œç›´åˆ°æ»¡è¶³æˆ‘ä»¬çš„é¢„æœŸ</li></ol><h2 id="é¢å‘å¯¹è±¡ç¼–ç¨‹"><a href="#é¢å‘å¯¹è±¡ç¼–ç¨‹" class="headerlink" title="é¢å‘å¯¹è±¡ç¼–ç¨‹"></a>é¢å‘å¯¹è±¡ç¼–ç¨‹</h2><ol><li>è®¾è®¡è‰¯å¥½çš„æ¶æ„éœ€è¦æˆ‘ä»¬ç†è§£å¹¶åº”ç”¨ OO çš„ä¸€äº›åŸåˆ™</li><li><p>ä»€ä¹ˆæ˜¯é¢å‘å¯¹è±¡ï¼š</p><ul><li>æ•°æ® + è¡Œä¸ºçš„ç»„åˆ</li><li>ä¸ºçœŸå®ä¸–ç•Œå»ºæ¨¡</li><li>å°è£…ï¼ˆEncapsulationï¼‰ã€ç»§æ‰¿ï¼ˆInheritanceï¼‰å’Œå¤šæ€ï¼ˆPolymorphismï¼‰</li></ul></li><li><p>UNIX ç³»ç»Ÿè¦æ±‚æ¯ä¸ª IO è®¾å¤‡é©±åŠ¨éƒ½éœ€è¦æä¾›äº”ä¸ªæ ‡å‡†å‡½æ•°ï¼š<code>open</code>, <code>close</code>, <code>read</code>, <code>write</code> å’Œ <code>seek</code></p></li><li>å¤šæ€å®é™…ä¸Šå°±æ˜¯å‡½æ•°æŒ‡é’ˆçš„åº”ç”¨ï¼Œè‡ªä»å†¯è¯ºä¾æ›¼æ¶æ„è¯ç”Ÿä»¥æ¥ï¼Œç¨‹åºå‘˜ä»¬å°±ä¸€ç›´åœ¨ä½¿ç”¨è¿™ç§æŠ€æœ¯äº†ã€‚ä½†æ˜¯æ˜¾å¼åœ°ä½¿ç”¨å‡½æ•°æŒ‡é’ˆæ˜¯å¾ˆå±é™©çš„ï¼Œå¹¶ä¸”ä½¿ç”¨æ—¶éœ€è¦éµå¾ªä¸€äº›åŸåˆ™ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚OO åˆ™å°†ä½ ä»ä¸­è§£æ”¾å‡ºæ¥ï¼Œè®©ä½ æ›´åŠ è½»æ¾åœ°å®ç°å¤šæ€ã€‚</li><li>OO å…è®¸åœ¨ä»»ä½•åœ°æ–¹ï¼Œä¸ºä»»ä½•æƒ…å½¢ä½¿ç”¨æ’ä»¶å¼æ¶æ„ï¼ˆä¸»è¦æ˜¯å¤šæ€çš„å¨åŠ›ï¼Œå…¶å®åœ¨å…¶å®ƒè¯­è¨€ä¸­ï¼Œå¦‚ Rust/Goï¼Œä½¿ç”¨æ¥å£æœºåˆ¶ä¹Ÿèƒ½è¾¾åˆ°ç±»ä¼¼çš„ç›®çš„ï¼‰</li><li>ä½¿ç”¨ OO è¯­è¨€å¯ä»¥å®Œå…¨æ§åˆ¶ç³»ç»Ÿä¸­æºç çš„ä¾èµ–æ–¹å‘ã€‚å¤šæ€æœºåˆ¶å¯ä»¥è®©ä»»ä½•æºç ä¾èµ–éƒ½å¯ä»¥è¢«å€’ç½®ï¼Œæ— è®ºå®ƒä»¬åœ¨å“ªå„¿</li><li><p>OO å¸¦æ¥çš„å¥½å¤„ï¼Œç”¨å‡ ä¸ªå…³é”®å­—æ¦‚æ‹¬ï¼š</p><ul><li>ä¾èµ–å€’ç½®ï¼ˆDependency inversionï¼‰</li><li>å¯ç‹¬ç«‹éƒ¨ç½²æ€§ï¼ˆIndependent deployabilityï¼‰</li><li>å¯ç‹¬ç«‹å¼€å‘æ€§ï¼ˆIndependent developabilityï¼‰</li></ul></li><li><p><strong>ä»è½¯ä»¶æ¶æ„çš„è§’åº¦çœ‹ï¼Œé¢å‘å¯¹è±¡å¯ä»¥é€šè¿‡ä½¿ç”¨å¼ºå¤§çš„å¤šæ€æœºåˆ¶ï¼Œæ¥æ§åˆ¶ç³»ç»Ÿæºç ä¾èµ–ã€‚è¿™æ ·å¯ä»¥åˆ›å»ºå‡ºæ’ä»¶å¼æ¶æ„ï¼Œå¯ä»¥å°†æ›´é«˜å±‚çš„æŠ½è±¡ç­–ç•¥å’Œåº•å±‚çš„å®ç°éš”ç¦»å¼€ã€‚åº•å±‚çš„å®ç°ç»†èŠ‚äº¤ç»™å„ä¸ªæ’ä»¶å»å®Œæˆï¼Œå¹¶ä¸”å®ƒä»¬å¯ä»¥è¢«ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼Œè€Œä¸ä¼šå’Œæ›´é«˜å±‚çš„æ¨¡å—è€¦åˆã€‚</strong></p></li></ol><h2 id="å‡½æ•°å¼ç¼–ç¨‹"><a href="#å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="å‡½æ•°å¼ç¼–ç¨‹"></a>å‡½æ•°å¼ç¼–ç¨‹</h2><ol><li>æ‰€æœ‰çš„ç«äº‰æ¡ä»¶ã€æ­»é”æ¡ä»¶å’Œå¹¶å‘æ›´æ–°çš„é—®é¢˜éƒ½æ˜¯ç”±å¯å˜å˜é‡å¯¼è‡´çš„ã€‚å‡½æ•°å¼ç¼–ç¨‹åˆ™é™åˆ¶äº†å˜é‡ä¿®æ”¹</li><li>å°†å¯å˜å’Œä¸å¯å˜çš„ç»„ä»¶éš”ç¦»å¼€æ¥ï¼šä¸å¯å˜ç»„ä»¶ä½¿ç”¨å‡½æ•°å¼æ‰§è¡Œä»»åŠ¡ï¼ˆä¸ä½¿ç”¨ä»»ä½•å¯å˜é‡ï¼‰ï¼›ä¸å¯å˜ç»„ä»¶é€šè¿‡å’Œå¯å˜ç»„ä»¶é€šä¿¡çš„æ–¹å¼æ¥åšçŠ¶æ€å˜æ›´</li><li><em>Event Sourcing</em>: æ ¸å¿ƒç­–ç•¥æ˜¯ä¸å­˜å‚¨çŠ¶æ€ï¼Œè€Œæ˜¯å­˜å‚¨äº‹åŠ¡ã€‚å½“éœ€è¦è·å–çŠ¶æ€æ—¶ï¼Œåªéœ€è¦ä»æœ€å¼€å§‹å›æ”¾äº‹åŠ¡ï¼Œæœ€ç»ˆå¾—åˆ°æƒ³è¦çš„çŠ¶æ€ã€‚è¿™æ ·çš„ç³»ç»Ÿå°±åªæœ‰ <strong>CRï¼ˆåˆ›å»ºã€è¯»å–ï¼‰</strong> äº†ï¼Œè€Œä¸ä¼šå­˜åœ¨çŠ¶æ€æ›´æ–°å’Œåˆ é™¤ã€‚å› æ­¤ï¼Œå¾ˆå¤šå¹¶å‘å¼•æ¥çš„æ›´æ–°é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿï¼ˆå…¶å®å¯ä»¥å¯¹æ¯”ä¸‹åŸºäºæ—¥å¿—å¼ LSM çš„å­˜å‚¨å¼•æ“ï¼‰ã€‚</li></ol><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><strong>ç»“æ„åŒ–ç¼–ç¨‹ã€å‡½æ•°å¼ç¼–ç¨‹ä»¥åŠé¢å‘å¯¹è±¡ç¼–ç¨‹</strong>éƒ½åˆ†åˆ«ç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸åŒçš„é™åˆ¶ï¼ˆTo tell us what not to doï¼‰ï¼Œè€Œéå¸¦æ¥æ–°çš„åŠŸèƒ½ã€‚<br>è½¯ä»¶å¹¶éå¿«é€Ÿå‘å±•çš„é«˜ç§‘æŠ€ï¼Œå› æ­¤å¾ˆå¤šåŸåˆ™è‡³ä»Šä¾ç„¶é€‚ç”¨ã€‚ä¸ç®¡æœºå™¨æ€ä¹ˆå˜åŒ–ã€å·¥å…·å¦‚ä½•å˜å¾—æ›´å¥½ï¼Œä½†è½¯ä»¶çš„æœ¬è´¨è¿˜æ˜¯ä¸€æ ·ã€‚<br>æ‰€è°“çš„è½¯ä»¶ç¨‹åºä¸è¿‡å°±æ˜¯<strong>ç”±é¡ºåºã€é€‰æ‹©ã€å¾ªç¯</strong>ç»“æ„ï¼ˆé—´æ¥ï¼‰ç»„æˆï¼Œä¸å¤šä¸å°‘ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;è¿‘æ¥å¼€å§‹é˜…è¯» Robert C. Martin çš„æ–°è‘—ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹ï¼ˆ&lt;em&gt;Clean Architecture&lt;/em&gt;ï¼‰ã€‚æ²¡æœ‰äººæ„¿æ„çœ‹åˆ°å›¢é˜Ÿå†…çš„é¡¹ç›®é€æ¸å‘å±•æˆä¸€å›¢ä¹±éº»ï¼Œç›¸äº’çº ç¼ ã€‚é‚£å¦‚ä½•ä»æ ¹æœ¬ä¸Šå‡å°‘è¿™ç§é—®é¢˜çš„å‘ç”Ÿå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬æŒæ¡ä¸€äº›å®è§‚å±‚é¢çš„è®¾è®¡æ€æƒ³ï¼Œä»ç»™é¡¹ç›®æ‰“åŸºç¡€æ—¶å°±åº”è¯¥è€ƒè™‘å¥½å„ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°ç­‰å¦‚ä½•è®¾è®¡æˆ&lt;strong&gt;é«˜å†…èšã€ä½è€¦åˆ&lt;/strong&gt;çš„ç»“æ„ã€‚æ•´æ´çš„é¡¹ç›®æ¶æ„æ˜¯åˆ©äºé•¿è¿œå‘å±•çš„ï¼Œè¿™ç¯‡ç¬”è®°å°†ä¼šè®°å½•ä¸€äº›ä»ä¹¦ä¸­å­¦ä¹ åˆ°çš„é‡è¦çŸ¥è¯†ç‚¹ï¼Œä¾¿äºåæœŸå¤ä¹ å’Œå‚è€ƒã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œä½œè€…è¿˜æœ‰ä¸€æœ¬å¤§åé¼é¼çš„è‘—ä½œã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ä¹Ÿéå¸¸å€¼å¾—é˜…è¯»ï¼Œå…³äºè¿™æœ¬ä¹¦ä¹Ÿåšäº†ç‚¹ç¬”è®°ï¼Œå‚è§&lt;a href=&quot;https://ifaceless.github.io/2018/11/04/clean-code-notes/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹è¯»ä¹¦ç¬”è®°&lt;/a&gt;~&lt;/p&gt;
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://ifaceless.space/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="æ¶æ„" scheme="http://ifaceless.space/tags/%E6%9E%B6%E6%9E%84/"/>
    
      <category term="è®¾è®¡æ€ç»´" scheme="http://ifaceless.space/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E7%BB%B4/"/>
    
      <category term="ç¼–ç¨‹èŒƒå¼" scheme="http://ifaceless.space/tags/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F/"/>
    
  </entry>
  
</feed>
