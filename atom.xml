<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é»‘ç™½ä¹‹é™¢</title>
  
  <subtitle>Valar Morghulis</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="/"/>
  <updated>2020-06-02T09:39:26.832Z</updated>
  <id>/</id>
  
  <author>
    <name>iFaceless</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust é”™è¯¯å¤„ç†</title>
    <link href="/2020/06/02/rust-error-handling/"/>
    <id>/2020/06/02/rust-error-handling/</id>
    <published>2020-06-02T07:19:45.000Z</published>
    <updated>2020-06-02T09:39:26.832Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><blockquote><p>æœ¬æ–‡å†…å®¹ä¸»è¦ç¿»è¯‘è‡ª Andrew Gallant çš„æ–‡ç«  <a href="https://blog.burntsushi.net/rust-error-handling/" target="_blank" rel="noopener">Error Handling in Rust</a>ã€‚</p></blockquote><p>å¦‚åŒå¤§å¤šæ•°çš„ç¼–ç¨‹è¯­è¨€ï¼ŒRust ä¸­ä¹Ÿéœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹å¼å¤„ç†é”™è¯¯ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œç›®å‰å¸¸è§çš„é”™è¯¯å¤„ç†æ–¹å¼ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>å¼‚å¸¸æœºåˆ¶ï¼ˆC#/Java/Python ç­‰ï¼‰ï¼›</li><li>è¿”å›é”™è¯¯ï¼ˆGo/Rust ç­‰ï¼‰ã€‚</li></ol><p>æœ¬æ–‡å°†ä¼šç»¼åˆå…¨é¢åœ°ä»‹ç» Rust ä¸­çš„é”™è¯¯å¤„ç†ï¼Œé€šè¿‡å¾ªåºæ¸è¿›åœ°å¼•å¯¼ï¼Œå¸¦é¢†åˆå­¦è€…æ‰å®åœ°æŒæ¡è¿™å—çŸ¥è¯†ã€‚å¦‚æœæˆ‘ä»¬ä¸ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨è¾ƒä¸ºæ„šè ¢çš„æ–¹å¼å¤„ç†é”™è¯¯ï¼Œè¿™ç§ä¼šæ¯”è¾ƒç¹çï¼Œäº§ç”Ÿå¾ˆå¤šæ ·æ¿ä»£ç ã€‚æ‰€ä»¥æœ¬æ–‡ä¼šæ¼”ç¤ºå¦‚ä½•å€ŸåŠ©æ ‡å‡†åº“è®©é”™è¯¯å¤„ç†<strong>æ›´åŠ ä¼˜é›…å’Œç®€æ´</strong>ã€‚</p><p><img src="https://i.loli.net/2020/06/02/6dBfsiZ9czGNCQT.png" alt="Rust é”™è¯¯å¤„ç†"></p><h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>æœ¬æ–‡çš„ä»£ç æ”¾åœ¨ä½œè€…çš„ <a href="https://github.com/BurntSushi/blog/tree/master/code/rust-error-handling" target="_blank" rel="noopener">åšå®¢ä»“åº“</a>ã€‚<br><a href="https://doc.rust-lang.org/book/ch09-00-error-handling.html" target="_blank" rel="noopener">Rust Book, Error Handling</a> ä¸­ä¹Ÿæœ‰å…³äºé”™è¯¯å¤„ç†çš„éƒ¨åˆ†ï¼Œå¯ä»¥å‚ç…§é˜…è¯»ã€‚</p><p>æœ¬æ–‡ç¯‡å¹…å·¨é•¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†™äº†å¾ˆå¤šå…³äº Sum Types å’Œç»„åˆå­ï¼ˆCombinatorsï¼‰çš„å†…å®¹ä½œä¸ºå¼€å¤´ï¼Œé€æ­¥è®²è§£ Rust é”™è¯¯å¤„ç†æ–¹å¼çš„æ”¹è¿›ã€‚å› æ­¤ï¼Œå¦‚æœä½ è®¤ä¸ºæ²¡æœ‰å¿…è¦çš„è¯ï¼Œä¹Ÿå¯ä»¥ç•¥è¿‡ã€‚ä»¥ä¸‹æ˜¯ä½œè€…æä¾›çš„ç®€è¦æŒ‡å—ï¼š</p><ol><li>å¦‚æœä½ æ˜¯ Rust æ–°æ‰‹ï¼Œå¯¹äºç³»ç»Ÿç¼–ç¨‹å’Œå¯Œç±»å‹ç³»ç»Ÿï¼ˆexpressive type systemsï¼‰ä¸å¤ªç†Ÿæ‚‰çš„è¯ï¼Œæ¨èä½ ä»å¤´å¼€å§‹é˜…è¯»ï¼ˆå¦‚æœæ˜¯å®Œå…¨æ²¡æœ‰äº†è§£è¿‡ Rust çš„ç«¥é‹ï¼Œæ¨èå…ˆé˜…è¯»ä¸‹ [Rust Book](<a href="https://doc.rust-lang.org/book/title-page.htmlï¼‰ï¼›" target="_blank" rel="noopener">https://doc.rust-lang.org/book/title-page.htmlï¼‰ï¼›</a></li><li>å¦‚æœä½ ä»æ¥æ²¡æœ‰äº†è§£è¿‡ Rustï¼Œä½†æ˜¯å¯¹äºå‡½æ•°å¼è¯­è¨€å¾ˆç†Ÿæ‚‰ï¼ˆçœ‹åˆ°ã€Œä»£æ•°æ•°æ®ç±»å‹ï¼ˆalgebaric data typesï¼‰ã€å’Œã€Œç»„åˆå­ï¼ˆcombinatorsï¼‰ã€ä¸ä¼šè®©ä½ æ„Ÿåˆ°é™Œç”Ÿï¼‰ï¼Œé‚£ä¹Ÿè®¸å¯ä»¥ç›´æ¥è·³è¿‡åŸºç¡€éƒ¨åˆ†ï¼Œä»ã€Œå¤šé”™è¯¯ç±»å‹ã€éƒ¨åˆ†å¼€å§‹é˜…è¯»ï¼Œç„¶åé˜…è¯»ã€Œæ ‡å‡†åº“ä¸­çš„ error traitsã€éƒ¨åˆ†;</li><li>å¦‚æœä½ å·²ç»æ‹¥æœ‰ Rust ç¼–ç¨‹ç»éªŒï¼Œå¹¶ä¸”åªæƒ³äº†è§£ä¸‹é”™è¯¯å¤„ç†çš„æ–¹å¼ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è·³åˆ°æœ€åï¼Œçœ‹çœ‹ä½œè€…ç»™å‡ºçš„æ¡ˆä¾‹ç ”ç©¶ï¼ˆå½“ç„¶ï¼Œè¿˜æœ‰è¯‘è€…ç»™å‡ºçš„å®é™…æ¡ˆä¾‹ï¼‰ã€‚</li></ol><h1 id="è¿è¡Œä»£ç "><a href="#è¿è¡Œä»£ç " class="headerlink" title="è¿è¡Œä»£ç "></a>è¿è¡Œä»£ç </h1><p>å¦‚æœæƒ³è¦ç›´æ¥è¿è¡Œæ ·ä¾‹ä»£ç ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> git clone git://github.com/BurntSushi/blog</span><br><span class="line"><span class="meta">$</span> cd blog/code/rust-error-handling</span><br><span class="line"><span class="meta">$</span> cargo run --bin NAME-OF-CODE-SAMPLE [ args ... ]</span><br></pre></td></tr></table></figure><h1 id="TL-TR"><a href="#TL-TR" class="headerlink" title="TL;TR"></a>TL;TR</h1><p>æ–‡ç« å¤ªé•¿ï¼Œå¦‚æœæ²¡è€å¿ƒé˜…è¯»çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹å…³äº Rust é”™è¯¯å¤„ç†çš„ä¸€äº›æ€»ç»“ã€‚ä»¥ä¸‹æ˜¯ä½œè€…æä¾›çš„ã€Œç»éªŒæ³•åˆ™ã€ï¼Œä»…ä¾›å‚è€ƒï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾—ä¸€äº›å¯å‘ã€‚</p><ul><li>å¦‚æœä½ æ­£åœ¨ç¼–å†™ç®€çŸ­çš„ç¤ºä¾‹ä»£ç ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæœ‰ä¸å°‘é”™è¯¯å¤„ç†çš„è´Ÿæ‹…ï¼Œè¿™ç§åœºæ™¯ä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>unwrap</code>ï¼ˆæ¯”å¦‚ <code>Result::unwrap</code>, <code>Option::unwrap</code> æˆ–è€… <code>Option::expect</code> ç­‰ï¼‰ã€‚é˜…è¯»ä½ ä»£ç çš„äººåº”è¯¥çŸ¥é“å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å¤„ç†é”™è¯¯ï¼ˆå¦‚æœ TA ä¸ä¼šï¼ŒæŠŠè¿™ç¯‡æ–‡ç« ç”©ç»™ TA çœ‹ï¼‰ï¼›</li><li>å¦‚æœä½ æ­£åœ¨å†™ä¸€ä¸ªç±»ä¼¼ä¸´æ—¶è„šæœ¬ä¸€æ ·çš„ç¨‹åºï¼ˆ<a href="https://www.computerhope.com/jargon/q/qad.htm" target="_blank" rel="noopener">quick-n-dirty program</a>ï¼‰ï¼Œç›´æ¥ç”¨ <code>unwrap</code> ä¹Ÿä¸ç”¨è§‰å¾—ç¾æ„§ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœåˆ«äººæ¥æ”¶ä½ è¿™ä¸ªç¨‹åºï¼Œé‚£å¯èƒ½æ˜¯è¦ä¸çˆ½çš„å“¦ï¼ˆæ¯•ç«Ÿæ²¡æœ‰ç‰¹åˆ«ä¸°å¯Œçš„é”™è¯¯æ¶ˆæ¯ï¼‰ï¼›</li><li>å¯¹äºğŸ‘†çš„åœºæ™¯ï¼Œå¦‚æœä½ è§‰å¾—ç›´æ¥ç”¨ <code>unwrap</code> ä¸å¤ªå¥½ï¼ˆæ¯•ç«Ÿå‡ºé”™ä¼šç›´æ¥ panic æ‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>Box&lt;dyn Error&gt;</code> æˆ–è€… <a href="anyhow"><code>anyhow::Error</code></a> ç±»å‹ä½œä¸ºå‡½æ•°çš„é”™è¯¯è¿”å›ç±»å‹ã€‚å¦‚æœä½¿ç”¨äº† <code>anyhow</code> crateï¼Œå½“ä½¿ç”¨ nightly ç‰ˆæœ¬çš„ Rust æ—¶ï¼Œé”™è¯¯ä¼šè‡ªåŠ¨æ‹¥æœ‰å…³è”çš„ backtraceï¼›</li><li>è¦æ˜¯ä¸Šé¢çš„æ–¹æ³•è¿˜ä¸è¡Œï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œå¹¶ä¸”å®ç° <code>From</code> å’Œ <code>Error</code> traitï¼Œä»è€Œå¯ä»¥é¡ºåˆ©åœ°ä½¿ç”¨ <code>?</code> æ“ä½œç¬¦ï¼Œè®©é”™è¯¯å¤„ç†æ›´åŠ ä¼˜é›…ï¼ˆè¦æ˜¯ä½ è¿ <code>From</code> å’Œ <code>Error</code> trait ä¹Ÿä¸æ„¿æ„åŠ¨æ‰‹å®ç°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://docs.rs/thiserror/1.0.19/thiserror/" target="_blank" rel="noopener">thiserror</a> æ¥è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼›</li><li>å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªåº“ï¼Œå¹¶ä¸”å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œæ¨èä½ è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œå¹¶ä¸”å®ç° <code>std::error::Error</code> traitï¼Œå¹¶ä¸”å®ç°åˆé€‚çš„ <code>From</code> traitï¼Œä»è€Œæ–¹ä¾¿åº“çš„è°ƒç”¨è€…ç¼–å†™ä»£ç ï¼ˆå› ä¸ºåŸºäº Rust çš„ç›¸å¹²æ€§åŸåˆ™ï¼ˆcoherence rulesï¼‰ï¼Œè°ƒç”¨è€…ä¸èƒ½ä¸ºåº“ä¸­å®šä¹‰çš„é”™è¯¯ç±»å‹å®ç° <code>From</code>ï¼Œå› æ­¤è¿™æ˜¯åº“ä½œè€…çš„èŒè´£ï¼‰ï¼›</li><li>å­¦ä¼šä½¿ç”¨ <code>Option</code> å’Œ <code>Result</code> ä¸­å®šä¹‰çš„ç»„åˆå­ï¼Œæœ‰æ—¶å€™åªæ˜¯ä½¿ç”¨å®ƒä»¬å¯èƒ½æ¯”è¾ƒç´¢ç„¶æ— å‘³ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åˆç†åœ°ç»„åˆä½¿ç”¨ <code>?</code> æ“ä½œç¬¦åˆç»„åˆå­æ¥æ”¹å–„ä»£ç ã€‚<code>and_then</code>, <code>map</code> å’Œ <code>unwrap_or</code> æ˜¯ä½œè€…æ¯”è¾ƒå–œæ¬¢çš„å‡ ä¸ªç»„åˆå­ã€‚</li></ul><p>æ€»ç»“ä¸€ä¸‹æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://i.loli.net/2020/06/02/ZqkoAClh2pSiMrd.png" alt="é”™è¯¯å®šä¹‰æµç¨‹"></p><h1 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h1><h2 id="Unwrap-è¯¦è§£"><a href="#Unwrap-è¯¦è§£" class="headerlink" title="Unwrap è¯¦è§£"></a>Unwrap è¯¦è§£</h2><h2 id="Option-ç±»å‹"><a href="#Option-ç±»å‹" class="headerlink" title="Option ç±»å‹"></a><code>Option</code> ç±»å‹</h2><h3 id="Option-lt-T-gt"><a href="#Option-lt-T-gt" class="headerlink" title="Option&lt;T&gt;"></a><code>Option&lt;T&gt;</code></h3><h2 id="Result-ç±»å‹"><a href="#Result-ç±»å‹" class="headerlink" title="Result ç±»å‹"></a><code>Result</code> ç±»å‹</h2><h3 id="è§£ææ•´æ•°"><a href="#è§£ææ•´æ•°" class="headerlink" title="è§£ææ•´æ•°"></a>è§£ææ•´æ•°</h3><h3 id="Result-ç±»å‹åˆ«å"><a href="#Result-ç±»å‹åˆ«å" class="headerlink" title="Result ç±»å‹åˆ«å"></a><code>Result</code> ç±»å‹åˆ«å</h3><h2 id="å°æ’æ›²ï¼šunwrap-å¹¶éé‚ªæ¶"><a href="#å°æ’æ›²ï¼šunwrap-å¹¶éé‚ªæ¶" class="headerlink" title="å°æ’æ›²ï¼šunwrap å¹¶éé‚ªæ¶"></a>å°æ’æ›²ï¼š<code>unwrap</code> å¹¶éé‚ªæ¶</h2><h1 id="å¤„ç†å¤šç§é”™è¯¯ç±»å‹"><a href="#å¤„ç†å¤šç§é”™è¯¯ç±»å‹" class="headerlink" title="å¤„ç†å¤šç§é”™è¯¯ç±»å‹"></a>å¤„ç†å¤šç§é”™è¯¯ç±»å‹</h1><h2 id="ç»„åˆ-Option-å’Œ-Result"><a href="#ç»„åˆ-Option-å’Œ-Result" class="headerlink" title="ç»„åˆ Option å’Œ Result"></a>ç»„åˆ <code>Option</code> å’Œ <code>Result</code></h2><h2 id="ç»„åˆå­çš„é™åˆ¶"><a href="#ç»„åˆå­çš„é™åˆ¶" class="headerlink" title="ç»„åˆå­çš„é™åˆ¶"></a>ç»„åˆå­çš„é™åˆ¶</h2><h2 id="æå‰è¿”å›"><a href="#æå‰è¿”å›" class="headerlink" title="æå‰è¿”å›"></a>æå‰è¿”å›</h2><h2 id="ä½¿ç”¨-try-å®æˆ–è€…-æ“ä½œç¬¦"><a href="#ä½¿ç”¨-try-å®æˆ–è€…-æ“ä½œç¬¦" class="headerlink" title="ä½¿ç”¨ try! å®æˆ–è€… ? æ“ä½œç¬¦"></a>ä½¿ç”¨ <code>try!</code> å®æˆ–è€… <code>?</code> æ“ä½œç¬¦</h2><h2 id="è‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a href="#è‡ªå®šä¹‰é”™è¯¯ç±»å‹" class="headerlink" title="è‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h2><h1 id="æ ‡å‡†åº“ä¸­çš„é”™è¯¯å¤„ç†-trait"><a href="#æ ‡å‡†åº“ä¸­çš„é”™è¯¯å¤„ç†-trait" class="headerlink" title="æ ‡å‡†åº“ä¸­çš„é”™è¯¯å¤„ç† trait"></a>æ ‡å‡†åº“ä¸­çš„é”™è¯¯å¤„ç† trait</h1><h2 id="Error-trait"><a href="#Error-trait" class="headerlink" title="Error trait"></a><code>Error</code> trait</h2><h2 id="From-trait"><a href="#From-trait" class="headerlink" title="From trait"></a><code>From</code> trait</h2><h2 id="try-å’Œ-å†…éƒ¨å®ç°"><a href="#try-å’Œ-å†…éƒ¨å®ç°" class="headerlink" title="try! å’Œ ? å†…éƒ¨å®ç°"></a><code>try!</code> å’Œ <code>?</code> å†…éƒ¨å®ç°</h2><h2 id="ç»„åˆè‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a href="#ç»„åˆè‡ªå®šä¹‰é”™è¯¯ç±»å‹" class="headerlink" title="ç»„åˆè‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>ç»„åˆè‡ªå®šä¹‰é”™è¯¯ç±»å‹</h2><h2 id="ç»™åº“ä½œè€…çš„ä¸€äº›å»ºè®®"><a href="#ç»™åº“ä½œè€…çš„ä¸€äº›å»ºè®®" class="headerlink" title="ç»™åº“ä½œè€…çš„ä¸€äº›å»ºè®®"></a>ç»™åº“ä½œè€…çš„ä¸€äº›å»ºè®®</h2><h1 id="æ¡ˆä¾‹ç ”ç©¶ï¼šé˜…è¯»äººå£æ•°æ®çš„å°ç¨‹åº"><a href="#æ¡ˆä¾‹ç ”ç©¶ï¼šé˜…è¯»äººå£æ•°æ®çš„å°ç¨‹åº" class="headerlink" title="æ¡ˆä¾‹ç ”ç©¶ï¼šé˜…è¯»äººå£æ•°æ®çš„å°ç¨‹åº"></a>æ¡ˆä¾‹ç ”ç©¶ï¼šé˜…è¯»äººå£æ•°æ®çš„å°ç¨‹åº</h1><h2 id="å®ƒåœ¨-GitHub-ä¸Š"><a href="#å®ƒåœ¨-GitHub-ä¸Š" class="headerlink" title="å®ƒåœ¨ GitHub ä¸Š"></a>å®ƒåœ¨ GitHub ä¸Š</h2><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h2 id="å‚æ•°è§£æ"><a href="#å‚æ•°è§£æ" class="headerlink" title="å‚æ•°è§£æ"></a>å‚æ•°è§£æ</h2><h2 id="ç¼–å†™ä¸šåŠ¡é€»è¾‘"><a href="#ç¼–å†™ä¸šåŠ¡é€»è¾‘" class="headerlink" title="ç¼–å†™ä¸šåŠ¡é€»è¾‘"></a>ç¼–å†™ä¸šåŠ¡é€»è¾‘</h2><h2 id="ä½¿ç”¨-Box-lt-dyn-Error-gt-å¤„ç†é”™è¯¯"><a href="#ä½¿ç”¨-Box-lt-dyn-Error-gt-å¤„ç†é”™è¯¯" class="headerlink" title="ä½¿ç”¨ Box&lt;dyn Error&gt; å¤„ç†é”™è¯¯"></a>ä½¿ç”¨ <code>Box&lt;dyn Error&gt;</code> å¤„ç†é”™è¯¯</h2><h2 id="ä»-stdin-ä¸­è¯»å–"><a href="#ä»-stdin-ä¸­è¯»å–" class="headerlink" title="ä» stdin ä¸­è¯»å–"></a>ä» <code>stdin</code> ä¸­è¯»å–</h2><h2 id="ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹"><a href="#ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a>ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h2><h2 id="æ·»åŠ åŠŸèƒ½"><a href="#æ·»åŠ åŠŸèƒ½" class="headerlink" title="æ·»åŠ åŠŸèƒ½"></a>æ·»åŠ åŠŸèƒ½</h2><h1 id="ç‹¬åˆ›æ¡ˆä¾‹ç ”ç©¶ï¼šæ–°å† æ•°æ®æŸ¥è¯¢"><a href="#ç‹¬åˆ›æ¡ˆä¾‹ç ”ç©¶ï¼šæ–°å† æ•°æ®æŸ¥è¯¢" class="headerlink" title="ç‹¬åˆ›æ¡ˆä¾‹ç ”ç©¶ï¼šæ–°å† æ•°æ®æŸ¥è¯¢"></a>ç‹¬åˆ›æ¡ˆä¾‹ç ”ç©¶ï¼šæ–°å† æ•°æ®æŸ¥è¯¢</h1><h1 id="åŸæ–‡"><a href="#åŸæ–‡" class="headerlink" title="åŸæ–‡"></a>åŸæ–‡</h1><ul><li><a href="https://blog.burntsushi.net/rust-error-handling/" target="_blank" rel="noopener">Error Handling in Rust</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡å†…å®¹ä¸»è¦ç¿»è¯‘è‡ª Andrew Gallant çš„æ–‡ç«  &lt;a href=&quot;https://blog.burnts
      
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="Error Handling" scheme="/tags/Error-Handling/"/>
    
      <category term="ç¿»è¯‘" scheme="/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆäºŒï¼‰ï¼šé¢„å¤‡çŸ¥è¯†</title>
    <link href="/2020/04/21/talent-plan-rust-network-programming-bb2/"/>
    <id>/2020/04/21/talent-plan-rust-network-programming-bb2/</id>
    <published>2020-04-21T03:04:30.000Z</published>
    <updated>2020-06-02T08:57:46.129Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><a id="more"></a><h1 id="ææ–™é˜…è¯»"><a href="#ææ–™é˜…è¯»" class="headerlink" title="ææ–™é˜…è¯»"></a>ææ–™é˜…è¯»</h1><h2 id="ç‚«é…·ç®—æ³•ä¹‹æ—¥å¿—ç»“æ„å­˜å‚¨"><a href="#ç‚«é…·ç®—æ³•ä¹‹æ—¥å¿—ç»“æ„å­˜å‚¨" class="headerlink" title="ç‚«é…·ç®—æ³•ä¹‹æ—¥å¿—ç»“æ„å­˜å‚¨"></a>ç‚«é…·ç®—æ³•ä¹‹æ—¥å¿—ç»“æ„å­˜å‚¨</h2><p><a href="http://blog.notdot.net/2009/12/Damn-Cool-Algorithms-Log-structured-storage" target="_blank" rel="noopener">Damn Cool Algorithms: Log structured storage</a></p><h2 id="æ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ä¸å®ç°"><a href="#æ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ä¸å®ç°" class="headerlink" title="æ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ä¸å®ç°"></a>æ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ä¸å®ç°</h2><h2 id="Bitcaskï¼Œé«˜æ€§èƒ½-amp-åŸºäºæ—¥å¿—ç»“æ„çš„-Key-Value-å­˜å‚¨"><a href="#Bitcaskï¼Œé«˜æ€§èƒ½-amp-åŸºäºæ—¥å¿—ç»“æ„çš„-Key-Value-å­˜å‚¨" class="headerlink" title="Bitcaskï¼Œé«˜æ€§èƒ½ &amp; åŸºäºæ—¥å¿—ç»“æ„çš„ Key/Value å­˜å‚¨"></a>Bitcaskï¼Œé«˜æ€§èƒ½ &amp; åŸºäºæ—¥å¿—ç»“æ„çš„ Key/Value å­˜å‚¨</h2><h2 id="Rust-ä¸­çš„é”™è¯¯å¤„ç†"><a href="#Rust-ä¸­çš„é”™è¯¯å¤„ç†" class="headerlink" title="Rust ä¸­çš„é”™è¯¯å¤„ç†"></a>Rust ä¸­çš„é”™è¯¯å¤„ç†</h2><h2 id="std-collections-æ–‡æ¡£å­¦ä¹ "><a href="#std-collections-æ–‡æ¡£å­¦ä¹ " class="headerlink" title="std::collections æ–‡æ¡£å­¦ä¹ "></a><code>std::collections</code> æ–‡æ¡£å­¦ä¹ </h2><h2 id="std-io-æ–‡æ¡£å­¦ä¹ "><a href="#std-io-æ–‡æ¡£å­¦ä¹ " class="headerlink" title="std::io æ–‡æ¡£å­¦ä¹ "></a><code>std::io</code> æ–‡æ¡£å­¦ä¹ </h2><h1 id="ç»ƒä¹ é¢˜"><a href="#ç»ƒä¹ é¢˜" class="headerlink" title="ç»ƒä¹ é¢˜"></a>ç»ƒä¹ é¢˜</h1><h2 id="ä½¿ç”¨-serde-åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆJSONï¼‰"><a href="#ä½¿ç”¨-serde-åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆJSONï¼‰" class="headerlink" title="ä½¿ç”¨ serde åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆJSONï¼‰"></a>ä½¿ç”¨ <code>serde</code> åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆJSONï¼‰</h2><h2 id="ä½¿ç”¨-serde-åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆRONï¼‰"><a href="#ä½¿ç”¨-serde-åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆRONï¼‰" class="headerlink" title="ä½¿ç”¨ serde åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆRONï¼‰"></a>ä½¿ç”¨ <code>serde</code> åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç»“æ„ï¼ˆRONï¼‰</h2><h2 id="ä½¿ç”¨-serde-åºåˆ—åŒ–ååºåˆ—åŒ–-1000-ä¸ªæ•°æ®ç»“æ„ï¼ˆBSONï¼‰"><a href="#ä½¿ç”¨-serde-åºåˆ—åŒ–ååºåˆ—åŒ–-1000-ä¸ªæ•°æ®ç»“æ„ï¼ˆBSONï¼‰" class="headerlink" title="ä½¿ç”¨ serde åºåˆ—åŒ–ååºåˆ—åŒ– 1000 ä¸ªæ•°æ®ç»“æ„ï¼ˆBSONï¼‰"></a>ä½¿ç”¨ <code>serde</code> åºåˆ—åŒ–ååºåˆ—åŒ– 1000 ä¸ªæ•°æ®ç»“æ„ï¼ˆBSONï¼‰</h2><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://github.com/pingcap/talent-plan/blob/master/courses/rust/building-blocks/bb-2.md" target="_blank" rel="noopener">PNA Rust â€” Building Blocks 2</a></li><li><a href="https://doc.rust-lang.org/rustdoc/what-is-rustdoc.html" target="_blank" rel="noopener">Whatâ€™s rustdoc</a></li></ul><h1 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h1><ul><li><a href="https://www.quora.com/What-is-the-difference-between-a-journaling-vs-a-log-structured-file-system" target="_blank" rel="noopener">What is the difference between a journaling vs a log structured file system?</a></li><li><a href="https://people.kth.se/~johanmon/courses/id2206/lectures/journal-handout.pdf" target="_blank" rel="noopener">Journaling and Log-structured file systems</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="ç½‘ç»œç¼–ç¨‹" scheme="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
      <category term="Log-Structured" scheme="/tags/Log-Structured/"/>
    
  </entry>
  
  <entry>
    <title>Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆäºŒï¼‰ï¼šç¼–å†™å†…å­˜ KV å­˜å‚¨</title>
    <link href="/2020/04/17/talent-plan-rust-network-programming-proj1/"/>
    <id>/2020/04/17/talent-plan-rust-network-programming-proj1/</id>
    <published>2020-04-17T14:10:45.000Z</published>
    <updated>2020-04-21T03:16:28.892Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ç»è¿‡ <a href="http://ifaceless.space/2020/04/15/talent-plan-rust-network-programming-bb1/" target="_blank" rel="noopener">ä¸Šä¸€èŠ‚</a> çš„å­¦ä¹ ï¼Œç›¸ä¿¡å¯¹äº Cargoã€Rust API æ–‡æ¡£ç¼–å†™è§„èŒƒã€å‘½ä»¤è¡Œå·¥å…·ç¼–å†™éƒ½æœ‰äº†åˆæ­¥è®¤è¯†ï¼Œæ²¡æœ‰æŒæ¡ä¹Ÿæ²¡å…³ç³»ã€‚æœ¬èŠ‚å°†ä¼šç»§ç»­æ·±å…¥å­¦ä¹ å’Œå®è·µï¼Œæˆ‘ä»¬å°†é‡‡ç”¨ <a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank" rel="noopener">æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Development, TDDï¼‰</a> çš„æ–¹å¼ç¼–å†™ä¸€ä¸ªç®€å•çš„å†…å­˜ key-value å­˜å‚¨åº“ï¼Œä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ç”¨äºæ¥æ”¶å’Œå¤„ç†å¢åˆ æŸ¥å‘½ä»¤ï¼Œå¹¶ä¸”æœ€ç»ˆè¿˜è¦èƒ½å¤Ÿé€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•ã€‚</p><a id="more"></a><p><strong>å…³é”®è¯</strong>ï¼šå•å…ƒæµ‹è¯•ã€<code>clap</code> å’Œ <code>structopt</code> crateã€Cargo ç¯å¢ƒå˜é‡ã€<code>clippy</code> å’Œ <code>rustfmt</code> å·¥å…·</p><p><strong>ç›®æ ‡</strong>ï¼š</p><ol><li>å­¦ä¹ è§„èŒƒçš„é¡¹ç›®ç»“æ„ï¼›</li><li>å­¦ä¹  <code>cargo new/init/test/run/clippy/fmt</code> å‘½ä»¤ï¼›</li><li>å­¦ä¹ å¦‚ä½•ä» <code>crates.io</code> å¯¼å…¥æ–°çš„ <code>crates</code>ï¼›</li><li>ä¸º key-value å­˜å‚¨å®šä¹‰åˆé€‚çš„æ•°æ®ç±»å‹ã€‚</li></ol><h1 id="äº†è§£-TDD"><a href="#äº†è§£-TDD" class="headerlink" title="äº†è§£ TDD"></a>äº†è§£ TDD</h1><p><a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank" rel="noopener">æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Developmentï¼‰</a> æ˜¯ä¸€ç§æ¯”è¾ƒæœ‰è¶£çš„è½¯ä»¶å¼€å‘æ¨¡å¼ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ ¹æ®éœ€æ±‚å…ˆå†™å¥½å•å…ƒæµ‹è¯•æ¡ä¾‹ï¼Œç„¶åå†å»ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè®©æµ‹è¯•é€šè¿‡ã€‚é€šè¿‡æµ‹è¯•é©±åŠ¨è½¯ä»¶å¼€å‘æ¨è¿›ï¼Œä¸€æ–¹é¢å¯ä»¥ä¿è¯æˆ‘ä»¬ç¼–å†™çš„ä»£ç æ»¡è¶³éœ€æ±‚ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¢å¼ºæˆ‘ä»¬çš„ä¿¡å¿ƒï¼Œå……è¶³å•å…ƒæµ‹è¯•ä¹Ÿæœ‰åŠ©äºä»£ç é‡æ„ï¼Œé¿å…å‡ºç°æ ¸å¿ƒé€»è¾‘å˜åŠ¨è€Œå¯¼è‡´ Bugã€‚</p><p>åœ¨ <a href="https://docs.google.com/viewer?a=v&amp;pid=sites&amp;srcid=ZGVmYXVsdGRvbWFpbnx0ZXN0MTIzNHNpbTQ2NXxneDpiYTJmYWIwYTAyOGJiZmQ" target="_blank" rel="noopener">Test-Driven Development by Example</a> ä¸­ç»™å‡ºäº† TDD çš„åŸºæœ¬æµç¨‹ï¼š</p><ol><li>ä¸ºæ–°åŠŸèƒ½ç¼–å†™æµ‹è¯•ï¼›</li><li>è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ŒæŸ¥çœ‹æ–°åŠŸèƒ½ç›¸å…³æµ‹è¯•æ˜¯å¦å¤±è´¥ï¼›</li><li>ç¼–å†™ä»£ç ï¼›</li><li>è¿è¡Œæµ‹è¯•ï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡æµ‹è¯•ï¼Œåˆ™å›åˆ°ä¸Šä¸€æ­¥ç»§ç»­ä¿®å¤ä»£ç ï¼›</li><li>é‡æ„ä»£ç ï¼›</li><li>ä¸æ–­é‡å¤ä¸Šè¿°æµç¨‹ã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå†æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•å‰ï¼Œæœ€å¥½æ¯æ¬¡å˜æ›´çš„ä»£ç ä¸è¦å¤ªå¤šã€‚è¿™æ ·ä¸€æ—¦æœ‰æµ‹è¯•å¤±è´¥ï¼Œå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ï¼Œå¹¶è¿›è¡Œä¿®å¤æˆ–è€…å›æ»šã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-2901a6d0e6adbfdbc0cabf547bbc13d0_1440w.png" alt="tdd"></p><h1 id="å‘½ä»¤è¡Œå’Œæ¥å£çº¦å®š"><a href="#å‘½ä»¤è¡Œå’Œæ¥å£çº¦å®š" class="headerlink" title="å‘½ä»¤è¡Œå’Œæ¥å£çº¦å®š"></a>å‘½ä»¤è¡Œå’Œæ¥å£çº¦å®š</h1><p>æœ¬èŠ‚ä¼šåˆ›å»ºä¸€ä¸ªåå« <code>tinkv</code> çš„é¡¹ç›®ï¼ŒåŒ…å«ä¸€ä¸ªåä¸º <code>tinkv</code> çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œå°†ä¼šè°ƒç”¨ <code>tinkv</code> åº“ä¸­æä¾›çš„æ–¹æ³•ï¼ˆå’Œå‘½ä»¤è¡Œå®¢æˆ·ç«¯æ‰“é€šæ”¾åˆ°åé¢å°èŠ‚ä»‹ç»ï¼‰ã€‚</p><p><code>tinkv</code> å‘½ä»¤è¡Œå®¢æˆ·ç«¯éœ€è¦æ”¯æŒå¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>tinkv set &lt;key&gt; &lt;value&gt;</code>ï¼šè®¾ç½® String ç±»å‹çš„ key value åˆ°å­˜å‚¨ä¸­ï¼›</li><li><code>tinkv get &lt;key&gt;</code>ï¼šæŸ¥è¯¢æŒ‡å®š key å¯¹åº”çš„ String å€¼ï¼›</li><li><code>tinkv rm &lt;key&gt;</code>ï¼šåˆ é™¤æŒ‡å®šçš„ keyï¼›</li><li><code>tinkv -V</code>ï¼šæ‰“å°ç¨‹åºçš„ç‰ˆæœ¬å·ã€‚</li></ul><p><code>tinkv</code> åº“ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>KvStore</code> ç±»å‹ï¼Œå°è£…äº†å­˜å‚¨æœåŠ¡çš„æ“ä½œï¼Œéœ€è¦æ”¯æŒå¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>KvStore::set(&amp;mut self, key: String, value: String)</code></li><li><code>KvStore::get(&amp;self, key: String) -&gt; Option&lt;String&gt;</code></li><li><code>KvStore::remove(&amp;mut self, key: String)</code></li></ul><h1 id="åŠ¨æ‰‹å®è·µ"><a href="#åŠ¨æ‰‹å®è·µ" class="headerlink" title="åŠ¨æ‰‹å®è·µ"></a>åŠ¨æ‰‹å®è·µ</h1><h2 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h2><p>ä½¿ç”¨ Cargo æ–°å»ºé¡¹ç›® <code>tinkv</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cargo new tinkv</span><br><span class="line">$ cd tinkv</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»º <code>src/bin/tinkv.rs</code>, <code>src/lib.rs</code> å’Œ <code>src/kvstore.rs</code> æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­˜æ”¾æµ‹è¯•çš„æ–‡ä»¶ <code>tests/tests.rs</code>ã€‚æœ€ç»ˆçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ src</span><br><span class="line">â”‚   â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”‚   â””â”€â”€ tinkv.rs</span><br><span class="line">â”‚   â”œâ”€â”€ kvstore.rs</span><br><span class="line">â”‚   â””â”€â”€ lib.rs</span><br><span class="line">â””â”€â”€ tests</span><br><span class="line">    â””â”€â”€ tests.rs</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ <code>src/bin/tinkv.rs</code> ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„ main å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"hello, tinkv"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>src/kvstore.rs</code> ä¸­æ–°å¢ <code>KvStore</code> ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KvStore</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>src/lib.rs</code> ä¸­å¯¼å‡º <code>KvStore</code> ç±»å‹ï¼Œè¿™æ ·å¯ä»¥åœ¨æµ‹è¯•ä»¥åŠ <code>src/bin/tinkv.rs::main()</code> ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> kvstore;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> kvstore::KvStore;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬å®Œå–„ä¸‹ <code>Cargo.toml</code> ä¸­ <code>[package]</code> éƒ¨åˆ†ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">"tinkv"</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">"0xE8551CCB &lt;noti@ifaceless.space&gt;"</span>]</span><br><span class="line"><span class="attr">edition</span> = <span class="string">"2018"</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">"A simple key-value store"</span></span><br><span class="line"><span class="attr">keywords</span> = [<span class="string">"database"</span>, <span class="string">"key-value"</span>]</span><br><span class="line"><span class="attr">categories</span> = [<span class="string">"Development"</span>]</span><br><span class="line"><span class="attr">license</span> = <span class="string">"MIT"</span></span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ å•å…ƒæµ‹è¯•"><a href="#æ·»åŠ å•å…ƒæµ‹è¯•" class="headerlink" title="æ·»åŠ å•å…ƒæµ‹è¯•"></a>æ·»åŠ å•å…ƒæµ‹è¯•</h2><p>æŒ‰ç…§ TDD çš„æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®Œæˆæ–°éœ€æ±‚å¯¹åº”çš„å•å…ƒæµ‹è¯•ç¼–å†™ï¼Œä¸è¿‡ç°åœ¨å·²ç»ä¸ºä½ å‡†å¤‡å¥½å•¦ï¼Œæ‰€ä»¥è¯·åˆ° <a href="https://github.com/iFaceless/talent-plan-projects/blob/master/tinkv/tests/tests.rs" target="_blank" rel="noopener">tinkv/tests</a> ä¸­å°†æ‰€æœ‰æµ‹è¯•å¤åˆ¶åˆ°æœ¬åœ° <code>tests/tests.rs</code> æ–‡ä»¶ä¸­ã€‚</p><p>ä»”ç»†é˜…è¯»æµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æœ‰ä¸¤ç±»æµ‹è¯•ï¼š</p><ol><li><code>cli_*</code> æ˜¯é’ˆå¯¹å‘½ä»¤è¡Œå®¢æˆ·ç«¯çš„æµ‹è¯•ï¼›</li><li><code>get_stored_value</code> ç­‰æ˜¯é’ˆå¯¹ <code>tinkv::KvStore</code> çš„åŠŸèƒ½æµ‹è¯•ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">cli_no_args</span></span>() &#123;<span class="comment">/* çœç•¥å†…å®¹ */</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//===============åˆ†å‰²çº¿===============</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">get_stored_value</span></span>() &#123; <span class="comment">/* çœç•¥å†…å®¹ */</span>&#125;</span><br></pre></td></tr></table></figure><p>å•å…ƒæµ‹è¯•æŸç§æ„ä¹‰ä¸Šä¹Ÿæ˜¯æ–‡æ¡£çš„è¡¥å……ï¼Œå®ƒæ¸…æ™°æè¿°äº†æŸä¸ªæ¥å£çš„è¡Œä¸ºï¼Œè€Œæˆ‘ä»¬åªéœ€è¦å®ç°é‚£ä¸ªè¡Œä¸ºå³å¯é€šè¿‡å•å…ƒæµ‹è¯•ã€‚æ‰€ä»¥åé¢çš„æˆ‘ä»¬çš„ä»»åŠ¡ä¾¿æ˜¯é€ä¸ªé€šè¿‡å•å…ƒæµ‹è¯•ï¼Œå®ŒæˆåŠŸèƒ½å¼€å‘ã€‚</p><h2 id="å®‰è£…æµ‹è¯•ä¾èµ–åŒ…"><a href="#å®‰è£…æµ‹è¯•ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…æµ‹è¯•ä¾èµ–åŒ…"></a>å®‰è£…æµ‹è¯•ä¾èµ–åŒ…</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¿è¡Œä¸‹æµ‹è¯•çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼ˆä¸ç”¨å¤šæƒ³ï¼Œä¸€å®šä¼šå¤±è´¥ï¼Œé‡ç‚¹æ˜¯æ‰¾åˆ°åŸå› ï¼‰ï¼Œè¿è¡Œ <code>cargo test</code> ç»“æœå¦‚ä¸‹ï¼š<br><img src="https://pic1.zhimg.com/80/v2-8c8375c4d165a7b2f36ff56089266a5a_1440w.jpeg" alt="import error"></p><p>æœä¸å…¶ç„¶ï¼Œçœ‹èµ·æ¥ <code>assert_cmd</code>, <code>predicates</code> crate æ— æ³•å¯¼å…¥ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦ç¼–è¾‘ä¸‹ <code>Cargo.toml</code> æ·»åŠ ä¸€ä¸‹æµ‹è¯•éœ€è¦çš„ä¾èµ–åŒ…ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[dev-dependencies]</span><br><span class="line">assert_cmd = <span class="string">"0.11.0"</span></span><br><span class="line">predicates = <span class="string">"1.0.0"</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬å†æ¬¡è¿è¡Œ <code>cargo test</code> çœ‹çœ‹æ•ˆæœï¼Œçœ‹èµ·æ¥è¿˜æ˜¯å¤±è´¥äº†å˜›ï¼Œä¸è¿‡è¿™æ¬¡æŠ¥é”™çš„åŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰ç»™ <code>tinkv::KvStore</code> å®ç° <code>get</code>, <code>set</code>, <code>remove</code> æ–¹æ³•å‘¢ã€‚<br><img src="https://pic4.zhimg.com/80/v2-f9f259e8660c4bb8da38306ef1736c1f_1440w.jpeg" alt=""></p><h2 id="ç¼–å†™-KvStore"><a href="#ç¼–å†™-KvStore" class="headerlink" title="ç¼–å†™ KvStore"></a>ç¼–å†™ KvStore</h2><p>å½“å‰çš„ç›®æ ‡æ˜¯è®©æµ‹è¯•è·‘èµ·æ¥ï¼Œè‡³å°‘ä¸è¦ç¼–è¯‘å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¦è®© <code>cargo test --no-run</code> èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ã€‚ä»ä¸Šé¢çš„æŠ¥é”™çœ‹åˆ° <code>tinkv::KvStore</code> è¿˜ç¼ºå°‘å¿…é¡»çš„æ–¹æ³•å®šä¹‰å‘¢ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰å…ˆå®Œæˆæ¡†æ¶ï¼Œå³å‡½æ•°å®šä¹‰ï¼Œå®ç°ç»†èŠ‚å…ˆç”¨ <code>panic!()</code> æ›¿ä»£ï¼ˆå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä½¿ç”¨ <code>unimplemented!()</code>ï¼Œä¸è¿‡ <code>panic!()</code> å­—æ•°æ›´å°‘ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ç”¨å¾—æ›´å¤šï¼‰ã€‚</p><p>æ·»åŠ å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KvStore</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> KvStore &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123; KvStore &#123;&#125; &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) &#123; <span class="built_in">panic!</span>(); &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt; &#123; <span class="built_in">panic!</span>(); &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) &#123; <span class="built_in">panic!</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å•¦ï¼Œè¿™æ—¶å†æ‰§è¡Œ <code>cargo test</code> åå¯ä»¥å‘ç°å·²ç»å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œå¹¶èƒ½è¿è¡Œå•å…ƒæµ‹è¯•äº†ï¼ˆè™½ç„¶éƒ½æŒ‚äº†ï¼Œä½†è‡³å°‘ç¼–è¯‘é€šè¿‡äº†ï¼Œå¯å–œå¯è´ºï¼‰ã€‚<br><img src="https://pic1.zhimg.com/80/v2-5e5faa8a547a3be3e2d938dd79c03143_1440w.jpeg" alt=""></p><h2 id="å…³äº-cargo-test-ä½¿ç”¨æç¤º"><a href="#å…³äº-cargo-test-ä½¿ç”¨æç¤º" class="headerlink" title="å…³äº cargo test ä½¿ç”¨æç¤º"></a>å…³äº cargo test ä½¿ç”¨æç¤º</h2><p>ç»†å¿ƒçš„è¯ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•è¾“å‡ºä¸­æœ‰è¿™æ ·çš„æç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">running 0 tests</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">     Running target/debug/deps/tinkv-3292fe1fc5408d8c</span><br><span class="line"></span><br><span class="line">running 0 tests</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">     Running target/debug/deps/tests-850c7d178475e2f3</span><br><span class="line"></span><br><span class="line">running 13 tests</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ˜¯è¿è¡Œäº†ä¸‰æ¬¡æµ‹è¯•å˜›ï¼Œè¿™æ˜¯å› ä¸º <code>cargo test</code> é»˜è®¤ä¼šåœ¨å¦‚ä¸‹å‡ ä¸ªä½ç½®æŸ¥æ‰¾å¹¶è¿è¡Œæµ‹è¯•ï¼š</p><ul><li>åº“æºç é‡Œé¢ï¼›</li><li>æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„æºç ä¸­ï¼›</li><li>æ¯ä¸ªæµ‹è¯•æ–‡ä»¶ï¼›</li><li>åº“æ–‡æ¡£æµ‹è¯•ã€‚</li></ul><p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ é¢å¤–çš„å‚æ•°ï¼ŒæŒ‡å®šè¿è¡Œæµ‹è¯•ï¼Œé€‰é¡¹å¦‚ä¸‹ï¼ˆè¯¦ç»†å¯ä»¥é€šè¿‡ <code>cargo help test</code> æŸ¥çœ‹ï¼‰ï¼š</p><ul><li><code>cargo test --lib</code></li><li><code>cargo test --doc</code></li><li><code>cargo test --bins</code></li><li><code>cargo test --bin foo</code></li><li><code>cargo test --test foo</code></li></ul><p>é€šå¸¸æˆ‘ä»¬åœ¨å®ç°æŸä¸ªæ¥å£åŠŸèƒ½æ—¶ï¼Œå¯ä»¥åªè¿è¡Œå¯¹åº”çš„æµ‹è¯•ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> ä»…è¿è¡Œåç§°ä¸º cli_no_args çš„æµ‹è¯•å‡½æ•°</span><br><span class="line">cargo test cli_no_args</span><br></pre></td></tr></table></figure><h2 id="ç¼–å†™å‘½ä»¤è¡Œå®¢æˆ·ç«¯"><a href="#ç¼–å†™å‘½ä»¤è¡Œå®¢æˆ·ç«¯" class="headerlink" title="ç¼–å†™å‘½ä»¤è¡Œå®¢æˆ·ç«¯"></a>ç¼–å†™å‘½ä»¤è¡Œå®¢æˆ·ç«¯</h2><p>åœ¨ä¹‹å‰çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ <code>clap</code> æ¥åˆ›å»ºä¸€ä¸ª CLI Appï¼Œä¹Ÿæ¼”ç¤ºäº†é€šè¿‡ <code>cli.yml</code> é…ç½®æˆ–è€…åœ¨ä»£ç ä¸­ä½¿ç”¨ <code>clap</code> æä¾›çš„æ„é€ å‡½æ•°ç”Ÿæˆå‘½ä»¤è¡Œåº”ç”¨çš„æ–¹å¼ã€‚ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>ç”Ÿæˆ <code>clap::App</code> æ—¶ï¼Œéœ€è¦ç¼–å†™å¾ˆå¤šæ ·æ¿ä»£ç ï¼Œæ¯”è¾ƒå•°å—¦ï¼›</li><li>åœ¨å¤„ç†å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œä½¿ç”¨ <code>matches.value_of(&quot;arg&quot;)</code> çš„æ–¹å¼æ‹¿åˆ°å€¼åï¼Œå¯èƒ½è¿˜æ¶‰åŠåˆ°ç±»å‹è½¬æ¢ç­‰æ“ä½œï¼Œä¹ŸåŒæ ·ä¼šäº§ç”Ÿå¾ˆå¤šæ ·æ¿ä»£ç ï¼Œä¸å¤Ÿä¼˜é›…å’Œé«˜æ•ˆã€‚</li></ol><p>æœ¬èŠ‚å°†ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„ <a href="https://github.com/TeXitoi/structopt" target="_blank" rel="noopener">crate structopt</a>ï¼Œæˆ‘ä»¬å°†å‘½ä»¤è¡Œå‚æ•°é€šè¿‡ç»“æ„ä½“æˆå‘˜å˜é‡è¡¨ç¤ºï¼Œå‚æ•°ç±»å‹ã€å¸®åŠ©ä¿¡æ¯ç­‰ç¼–å†™èµ·æ¥éƒ½å¾ˆè½»æ¾ï¼Œå®ƒä½¿ç”¨ Rust å®æ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆ <code>clap::App</code>ï¼ŒåŒæ—¶å¯ä»¥è‡ªåŠ¨å®Œæˆå‚æ•°ç±»å‹è½¬æ¢ï¼Œéå¸¸çµæ´»ã€‚</p><p>é¦–å…ˆï¼Œä½¿ç”¨ <code>cargo add structopt</code> æ·»åŠ è¯¥ä¾èµ–æŒ‡é¡¹ç›®ä¸­ï¼Œç„¶ååœ¨ <code>src/bin/tinkv.rs</code> ä¸­é…ç½®å‘½ä»¤è¡Œå‚æ•°å¯¹åº”çš„ç»“æ„ä½“ï¼Œå¹¶æ ¹æ®å•å…ƒæµ‹è¯•çš„é¢„æœŸè¡Œä¸ºå®ç°å‘½ä»¤è¡Œç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::exit;</span><br><span class="line"><span class="keyword">use</span> structopt::StructOpt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(StructOpt, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Command</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Get value from store</span></span><br><span class="line">    Get &#123;</span><br><span class="line">        <span class="comment">/// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/// Save key value to store</span></span><br><span class="line">    Set &#123;</span><br><span class="line">        <span class="comment">/// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">        <span class="comment">/// A string value</span></span><br><span class="line">        value: <span class="built_in">String</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="meta">#[structopt(name = <span class="meta-string">"rm"</span>)]</span></span><br><span class="line">    <span class="comment">/// Remove value from store</span></span><br><span class="line">    Remove &#123;</span><br><span class="line">        <span class="comment">/// A string key</span></span><br><span class="line">        key: <span class="built_in">String</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(StructOpt, Debug)]</span></span><br><span class="line"><span class="meta">#[structopt(</span></span><br><span class="line"><span class="meta">    rename_all = <span class="meta-string">"kebab-case"</span>,</span></span><br><span class="line"><span class="meta">    name = env!(<span class="meta-string">"CARGO_PKG_NAME"</span>), </span></span><br><span class="line"><span class="meta">    about = env!(<span class="meta-string">"CARGO_PKG_DESCRIPTION"</span>),</span></span><br><span class="line"><span class="meta">    version = env!(<span class="meta-string">"CARGO_PKG_VERSION"</span>),</span></span><br><span class="line"><span class="meta">    author = env!(<span class="meta-string">"CARGO_PKG_AUTHORS"</span>),</span></span><br><span class="line"><span class="meta">)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Opt</span></span> &#123;</span><br><span class="line">    <span class="meta">#[structopt(subcommand)]</span></span><br><span class="line">    command: Command,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> opt = Opt::from_args();</span><br><span class="line">    <span class="keyword">match</span> opt.command &#123;</span><br><span class="line">        Command::Get &#123; key: _key &#125; =&gt; unimplemented(),</span><br><span class="line">        Command::Set &#123; key: _key, value: _value &#125; =&gt; unimplemented(),</span><br><span class="line">        Command::Remove &#123; key: _value&#125; =&gt; unimplemented(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// æš‚æ—¶æ²¡æœ‰å®ç°å‘½ä»¤è¡Œæ‰§è¡Œæ—¶ä¸ [`tinkv::KvStore`] çš„äº¤äº’ï¼Œ</span></span><br><span class="line"><span class="comment">/// å› ä¸ºå½“å‰è¿˜ä¸èƒ½æŒä¹…åŒ–å­˜å‚¨ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">unimplemented</span></span>() &#123;</span><br><span class="line">    eprintln!(<span class="string">"unimplemented"</span>);</span><br><span class="line">    exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œä½¿ç”¨ <code>cargo test --tests cli</code> è¿è¡Œæ‰€æœ‰å’Œå‘½ä»¤è¡Œæœ‰å…³çš„æµ‹è¯•ï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œåº”è¯¥ä¼šå…¨éƒ¨é€šè¿‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cargo test --tests cli</span><br><span class="line">...</span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">     Running target/debug/deps/tests-850c7d178475e2f3</span><br><span class="line"></span><br><span class="line">running 9 tests</span><br><span class="line">test cli_get ... ok</span><br><span class="line">test cli_invalid_rm ... ok</span><br><span class="line">test cli_invalid_get ... ok</span><br><span class="line">test cli_invalid_subcommand ... ok</span><br><span class="line">test cli_set ... ok</span><br><span class="line">test cli_rm ... ok</span><br><span class="line">test cli_no_args ... ok</span><br><span class="line">test cli_invalid_set ... ok</span><br><span class="line">test cli_version ... ok</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="å°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­"><a href="#å°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­" class="headerlink" title="å°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­"></a>å°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­</h2><p>ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>HashMap&lt;String, String&gt;</code> ä¿å­˜è®¾ç½®çš„æ•°æ®åˆ°å†…å­˜ï¼Œè®©å•å…ƒæµ‹è¯•é€šè¿‡ã€‚å…·ä½“å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸å†èµ˜è¿°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">KvStore</span></span> &#123;</span><br><span class="line">    db: HashMap&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> KvStore &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        KvStore &#123;</span><br><span class="line">            db: HashMap::new(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>, value: <span class="built_in">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.db.insert(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get</span></span>(&amp;<span class="keyword">self</span>, key: <span class="built_in">String</span>) -&gt; <span class="built_in">Option</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.db.get(&amp;key).map(|x| x.to_string())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">remove</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: <span class="built_in">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.db.remove(&amp;key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œè¿è¡Œ <code>cargo test</code> åï¼Œæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹åº”è¯¥éƒ½ä¼šé€šè¿‡äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cargo test</span><br><span class="line">...</span><br><span class="line">running 13 tests</span><br><span class="line">test cli_get ... ok</span><br><span class="line">test cli_invalid_rm ... ok</span><br><span class="line">test cli_invalid_subcommand ... ok</span><br><span class="line">test cli_invalid_get ... ok</span><br><span class="line">test cli_no_args ... ok</span><br><span class="line">test cli_invalid_set ... ok</span><br><span class="line">test get_non_existent_value ... ok</span><br><span class="line">test get_stored_value ... ok</span><br><span class="line">test overwrite_value ... ok</span><br><span class="line">test remove_key ... ok</span><br><span class="line">test cli_rm ... ok</span><br><span class="line">test cli_set ... ok</span><br><span class="line">test cli_version ... ok</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="è§„èŒƒæ–‡æ¡£"><a href="#è§„èŒƒæ–‡æ¡£" class="headerlink" title="è§„èŒƒæ–‡æ¡£"></a>è§„èŒƒæ–‡æ¡£</h2><p>åœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»æåˆ°å¦‚ä½•è§„èŒƒç¼–å†™ API æ–‡æ¡£äº†ï¼Œæœ¬èŠ‚ä¸å†èµ˜è¿°ï¼Œä½†æ˜¯éœ€è¦å¼ºè°ƒçš„æ˜¯æ–‡æ¡£éå¸¸é‡è¦ã€‚åœ¨ Rust æ ‡å‡†åº“ä»¥åŠä¸€äº›ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ crates ä¸­ï¼Œé€šå¸¸ä¼šåœ¨ä»£ç ä¸­çœ‹åˆ°éå¸¸ä¸°å¯Œä¸”è§„èŒƒçš„æ–‡æ¡£ï¼Œå»ºè®®å¤šå¤šé˜…è¯»ã€‚</p><p>è¿™é‡Œéœ€è¦æå‡ ç‚¹ï¼š</p><ol><li>åœ¨ç¼–å†™å¥½æ–‡æ¡£åï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡ <code>cargo doc --open</code> åœ¨æœ¬åœ°æµè§ˆå™¨æŸ¥çœ‹ API æ–‡æ¡£ï¼ˆç”Ÿæˆçš„æ–‡æ¡£ä½äº <code>target/doc</code> ç›®å½•ä¸‹ï¼‰ï¼›</li><li>å¯ä»¥ä½¿ç”¨ <code>cargo test --doc</code> å¯¹æ–‡æ¡£ä¸­çš„ç¤ºä¾‹è¿›è¡Œæµ‹è¯•ï¼›</li><li>åœ¨ <code>src/lib.src</code> é¡¶éƒ¨æ·»åŠ  <code>#![deny(missing_docs)]</code> ä¼šå¼ºåˆ¶æ‰€æœ‰å…¬å¼€çš„ç±»å‹ã€å‡½æ•°ç­‰å¿…é¡»ç¼–å†™æ–‡æ¡£ï¼Œå¦åˆ™ç¼–è¯‘å¤±è´¥ã€‚</li></ol><p>æ‰€ä»¥ï¼Œåœ¨å®Œæˆä»£ç ç¼–å†™åï¼Œä¸€å®šè¦æ·»åŠ ä¸Šè§„èŒƒçš„æ–‡æ¡£å“¦~</p><h2 id="clippy-å’Œ-rustfmt"><a href="#clippy-å’Œ-rustfmt" class="headerlink" title="clippy å’Œ rustfmt"></a><code>clippy</code> å’Œ <code>rustfmt</code></h2><p><code>clippy</code> å’Œ <code>rustfmt</code> æ˜¯ Rust å·¥å…·é“¾ä¸­ä¸¤æ¬¾é‡è¦çš„å·¥å…·ï¼š</p><ul><li><code>clippy</code> ä¼šæ£€æŸ¥åˆ°ä»£ç ä¸­ä¸å¤Ÿä¼˜é›…æˆ–è€…å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„æ¨¡å¼ï¼Œå¹¶ä¼šç»™å‡ºä¿®æ”¹å»ºè®®ï¼›</li><li><code>rustfmt</code> åˆ™ä¼šæ ¼å¼åŒ–ä»£ç ï¼Œä¿è¯ä»£ç é£æ ¼ä¸€è‡´ã€‚</li></ul><p>è¿™ä¸¤ä¸ªç»„ä»¶é»˜è®¤æ²¡æœ‰å®‰è£…ï¼Œéœ€è¦é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rustup component add clippy</span><br><span class="line"><span class="meta">$</span> rustup component add rustfmt</span><br></pre></td></tr></table></figure><p>å®‰è£…åï¼Œå¯ä»¥é€šè¿‡ <code>cargo clippy</code> å’Œ <code>cargo fmt</code> åˆ†åˆ«è°ƒç”¨å®ƒä»¬ã€‚å¼ºçƒˆå»ºè®®åœ¨æäº¤ä»£ç å‰ï¼Œå…ˆè¿è¡Œ <code>cargo clippy</code> å°†å»ºè®®ä¿®æ”¹çš„åœ°æ–¹ä¿®æ”¹å¥½ï¼Œç„¶åä½¿ç”¨ <code>cargo fmt</code> æ ¼å¼åŒ–å¥½ä»£ç åå†æäº¤åˆ°ä¸»å¹²ã€‚</p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>æœ¬èŠ‚ä»¥å®è·µä¸ºä¸»ï¼Œé‡‡ç”¨ TDD æ–¹å¼é€æ­¥å®Œæˆäº†ä¸€ä¸ªç®€å•çš„å†…å­˜ key-value å­˜å‚¨åº“ä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œå¹¶æœ€ç»ˆé€šè¿‡äº†æ‰€æœ‰å•å…ƒæµ‹è¯•ï¼Œåœ¨æœ€åå†æ¬¡å¼ºè°ƒäº†æ–‡æ¡£è§„èŒƒä»¥åŠä»£ç é£æ ¼ç»Ÿä¸€ã€ç¨‹åºå¥å£®çš„é‡è¦æ€§ã€‚æœ¬èŠ‚æ¶‰åŠçš„å®Œæ•´çš„æºç å‚è§ï¼š<a href="https://github.com/iFaceless/talent-plan-projects/tree/v0.2.0" target="_blank" rel="noopener">tinkv_v0.2.0</a>ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://github.com/pingcap/talent-plan/blob/master/rust/docs/lesson-plan.md#user-content-project-1-the-rust-toolbox" target="_blank" rel="noopener">Project 1: The Rust toolbox</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ç»è¿‡ &lt;a href=&quot;http://ifaceless.space/2020/04/15/talent-plan-rust-network-programming-bb1/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ä¸Šä¸€èŠ‚&lt;/a&gt; çš„å­¦ä¹ ï¼Œç›¸ä¿¡å¯¹äº Cargoã€Rust API æ–‡æ¡£ç¼–å†™è§„èŒƒã€å‘½ä»¤è¡Œå·¥å…·ç¼–å†™éƒ½æœ‰äº†åˆæ­¥è®¤è¯†ï¼Œæ²¡æœ‰æŒæ¡ä¹Ÿæ²¡å…³ç³»ã€‚æœ¬èŠ‚å°†ä¼šç»§ç»­æ·±å…¥å­¦ä¹ å’Œå®è·µï¼Œæˆ‘ä»¬å°†é‡‡ç”¨ &lt;a href=&quot;https://en.wikipedia.org/wiki/Test-driven_development&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Development, TDDï¼‰&lt;/a&gt; çš„æ–¹å¼ç¼–å†™ä¸€ä¸ªç®€å•çš„å†…å­˜ key-value å­˜å‚¨åº“ï¼Œä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ç”¨äºæ¥æ”¶å’Œå¤„ç†å¢åˆ æŸ¥å‘½ä»¤ï¼Œå¹¶ä¸”æœ€ç»ˆè¿˜è¦èƒ½å¤Ÿé€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="ç½‘ç»œç¼–ç¨‹" scheme="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
      <category term="å­˜å‚¨" scheme="/tags/%E5%AD%98%E5%82%A8/"/>
    
  </entry>
  
  <entry>
    <title>Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µï¼ˆä¸€ï¼‰ï¼šé¢„å¤‡çŸ¥è¯†</title>
    <link href="/2020/04/15/talent-plan-rust-network-programming-bb1/"/>
    <id>/2020/04/15/talent-plan-rust-network-programming-bb1/</id>
    <published>2020-04-15T09:00:54.000Z</published>
    <updated>2020-04-21T03:17:02.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>ä»Šå¤©å¼€å§‹ã€ŒRust ç½‘ç»œç¼–ç¨‹å®è·µã€çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­çš„é¢„å¤‡çŸ¥è¯†å­¦ä¹ ï¼Œå¹¶æœ€ç»ˆèƒ½ç¼–å†™å‡ºä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä»¥ä¸‹ææ–™æ˜¯ä»Šå¤©éœ€è¦é˜…è¯»çš„ï¼š</p><ul><li><a href="https://doc.rust-lang.org/cargo/reference/manifest.html" target="_blank" rel="noopener">The Cargo manifest format</a>ï¼šäº†è§£ Cargo mainfest æ–‡ä»¶æ ¼å¼ï¼›</li><li><a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html" target="_blank" rel="noopener">Cargo environment variables</a>ï¼šäº†è§£ Cargo ç¯å¢ƒå˜é‡ï¼›</li><li><a href="https://rust-lang-nursery.github.io/api-guidelines/documentation.html" target="_blank" rel="noopener">Rust API Guidelines: Documentation</a>ï¼šäº†è§£ Rust ç¨‹åºä¸­çš„æ–‡æ¡£ç¼–å†™ï¼›</li><li><a href="https://qiita.com/tigercosmos/items/678f39b1209e60843cc3" target="_blank" rel="noopener">Write a Good CLI Program</a>ï¼šå­¦ä¹ å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œç¨‹åºã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¾æ¬¡å®Œæˆä¸Šè¿°ææ–™å­¦ä¹ ï¼Œç€é‡è®°å½•ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå¹¶åœ¨æœ€åç¼–å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºã€‚</p><a id="more"></a><h1 id="Cargo-Manifest-æ–‡ä»¶æ ¼å¼"><a href="#Cargo-Manifest-æ–‡ä»¶æ ¼å¼" class="headerlink" title="Cargo Manifest æ–‡ä»¶æ ¼å¼"></a>Cargo Manifest æ–‡ä»¶æ ¼å¼</h1><p> åœ¨ä½¿ç”¨ <code>cargo</code> å‘½ä»¤åˆ›å»ºçš„é¡¹ç›®ä¸­ï¼Œéƒ½ä¼šå­˜åœ¨ä¸€ä¸ª <code>cargo.toml</code> æ–‡ä»¶ï¼Œè¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„ manifestã€‚ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p> <figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">"app"</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">"0xE8551CCB &lt;user@host&gt;"</span>]</span><br><span class="line"><span class="attr">edition</span> = <span class="string">"2018"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">clap</span> = &#123;version = <span class="string">"2.33.0"</span>, features = [<span class="string">"yaml"</span>]&#125;</span><br><span class="line"><span class="attr">maplit</span> = <span class="string">"1.0.2"</span></span><br><span class="line"><span class="attr">lazy_static</span> = <span class="string">"1.4.0"</span></span><br><span class="line"><span class="attr">yaml-rust</span> = <span class="string">"0.3.5"</span></span><br></pre></td></tr></table></figure><p><code>cargo.toml</code> æ˜¯ç”±å¤šä¸ªéƒ¨åˆ†é…ç½®ç»„æˆçš„ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼ˆè¯¦ç»†å®šä¹‰è¯·å‚è€ƒæ–‡æ¡£ï¼‰ï¼š</p><ul><li>cargo-features: å®éªŒæ€§åŠŸèƒ½</li><li><code>[package]</code>: åŒ…å®šä¹‰ï¼ˆå¦‚åç§°ã€ç‰ˆæœ¬ã€ä½œè€…ã€Rust ç¼–è¯‘å™¨ç‰ˆæœ¬ç­‰ï¼‰</li><li><code>[[lib]]</code>: åº“çš„è®¾ç½®</li><li><code>[[bin]]</code>: äºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½®</li><li><code>[[example]]</code>: ç¤ºä¾‹æ–‡ä»¶è®¾ç½®</li><li><code>[[test]]</code>: æµ‹è¯•è®¾ç½®</li><li><code>[[bench]]</code>: åŸºå‡†æµ‹è¯•è®¾ç½®</li><li><code>[dependencies]</code>: ä¾èµ–åº“åˆ—è¡¨</li><li><code>[features]</code>: æ¡ä»¶ç¼–è¯‘åŠŸèƒ½</li><li><code>[workspace]</code>: å·¥ä½œç©ºé—´å®šä¹‰</li></ul><h1 id="Cargo-ç¯å¢ƒå˜é‡"><a href="#Cargo-ç¯å¢ƒå˜é‡" class="headerlink" title="Cargo ç¯å¢ƒå˜é‡"></a>Cargo ç¯å¢ƒå˜é‡</h1><p>ç¯å¢ƒå˜é‡å¯ä»¥ç”¨æ¥å’Œ <code>rustc</code> ä»¥åŠ Cargo è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­é€šè¿‡ <code>env!</code> å®æˆ–è€…åœ¨æ„å»ºè„šæœ¬ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¿™æ ·å¯ä»¥æ§åˆ¶æ„å»ºè¡Œä¸ºã€‚ç›¸å…³ç¯å¢ƒå˜é‡æ¯”è¾ƒå¤šï¼Œç¬”è€…åœ¨è¿™é‡Œä¸å¤šèµ˜è¿°äº†ï¼Œç­‰ç”¨åˆ°æ—¶å†æ¥æŸ¥é˜…ã€‚å»ºè®®æŠŠ <a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html" target="_blank" rel="noopener">Cargo environment variables</a> ç®€å•é˜…è¯»ä¸‹ï¼Œç•™ä¸ªå°è±¡ã€‚</p><h1 id="Rust-ç¨‹åºæ–‡æ¡£ç¼–å†™"><a href="#Rust-ç¨‹åºæ–‡æ¡£ç¼–å†™" class="headerlink" title="Rust ç¨‹åºæ–‡æ¡£ç¼–å†™"></a>Rust ç¨‹åºæ–‡æ¡£ç¼–å†™</h1><p><a href="https://rust-lang.github.io/api-guidelines/about.html" target="_blank" rel="noopener">Rust API Guidelines</a> åˆ—å‡ºäº†ä¸€äº›è®¾è®¡å’Œç¼–å†™ Rust API çš„å»ºè®®ï¼Œä¸»è¦æ˜¯ç”± Rust Lib å°ç»„åœ¨æ„å»º Rust ç”Ÿæ€ï¼Œç¼–å†™æ ‡å‡†åº“å’Œä¸€äº›å…¶å®ƒ crates æœŸé—´æ€»ç»“è€Œæ¥ã€‚å½“ç„¶ï¼Œè¿™äº›å»ºè®®å¹¶éä¸€å®šéœ€è¦éµå®ˆï¼Œä¸è¿‡æ—¢ç„¶æ¥è‡ªäºå®˜æ–¹ï¼Œé‚£è¿˜æ˜¯éå¸¸å€¼å¾—åƒç¬”è€…è¿™æ ·çš„ Rust å°ç™½å­¦ä¹ çš„ã€‚</p><p>ä»Šå¤©ä¸»è¦å­¦ä¹ å…¶ä¸­å…³äºæ–‡æ¡£ç¼–å†™çš„ä¸€äº›å»ºè®®ï¼Œå…¶å®ƒå†…å®¹å»ºè®®æŠ½ç©ºé˜…è¯»ä¸‹ã€‚å…³äºæ–‡æ¡£ç¼–å†™çš„ä¸€äº›å¤§å»ºè®®æ¢³ç†å¦‚ä¸‹ï¼ˆè¯¦ç»†ç¤ºä¾‹è¿˜è¯·å‚è§æ–‡æ¡£ <a href="https://rust-lang-nursery.github.io/api-guidelines/documentation.html" target="_blank" rel="noopener">Rust API Guidelines: Documentation</a>ï¼‰ï¼š</p><ol><li>crate çº§åˆ«çš„æ–‡æ¡£åº”è¯¥æ˜¯å…¨é¢è¯¦ç»†çš„ï¼Œä¸”åŒ…å«ä½¿ç”¨ç¤ºä¾‹ï¼›</li><li>æ‰€æœ‰å…¬å¼€çš„æ¨¡å—ã€traitã€structã€enumã€å‡½æ•°ã€æ–¹æ³•ã€å®ä»¥åŠç±»å‹å®šä¹‰éƒ½éœ€è¦æä¾›ä½¿ç”¨ç¤ºä¾‹ï¼›</li><li>æ–‡æ¡£ä¸­çš„å®ä¾‹åº”è¯¥ä½¿ç”¨ <code>?</code> å¤„ç†é”™è¯¯ï¼Œè€Œé <code>try!</code> æˆ–è€… <code>unwrap</code>ï¼›</li><li>å‡½æ•°çš„æ–‡æ¡£ä¸­åº”è¯¥åŒ…æ‹¬ï¼šå‡½æ•°åŠŸèƒ½æè¿°ã€è¿”å›çš„é”™è¯¯ï¼ˆ<code># Errors</code>ï¼‰ã€Panic æƒ…å†µï¼ˆ<code># Panics</code>ï¼‰ä»¥åŠä¸€äº›å®‰å…¨ä½¿ç”¨çš„æç¤ºï¼ˆ<code># Safty</code>ï¼Œæ¯”å¦‚ <code>std::ptr::read</code> è¿™ç§ <code>unsafe</code> å‡½æ•°ï¼‰ï¼›</li><li>æ–‡æ¡£ä¸­æåˆ°çš„ç±»å‹åº”è¯¥å…³è”åˆ°å¯¹åº”çš„æ–‡æ¡£ï¼ˆLink all the thingsï¼‰ï¼›</li><li><code>Cargo.toml</code> ä¸­åº”è¯¥åŒ…å«æ‰€æœ‰å¸¸ç”¨çš„å…ƒä¿¡æ¯ï¼š<ul><li>authors</li><li>description</li><li>license</li><li>repository</li><li>readme</li><li>keywords</li><li>categories</li></ul></li><li>crate è¦è®¾ç½®æ­£ç¡®çš„ <code>#![doc(html_root_url = &quot;https://docs.rs/CRATE/MAJOR.MINOR.PATCH&quot;)]</code>ï¼Œå°¤å…¶è¦æ³¨æ„è¿™é‡Œçš„ç‰ˆæœ¬å·è¦å’Œ <code>Cargo.toml</code> ä¸­çš„ <code>version</code> ä¿æŒä¸€è‡´ï¼›</li><li>åœ¨å‘å¸ƒæ—¥å¿—ï¼ˆRelease notesï¼‰ä¸­è®°å½•æ‰€æœ‰é‡å¤§å˜æ›´ï¼Œå°¤å…¶æ˜¯ä¸å…¼å®¹å˜æ›´éœ€è¦æ¸…æ™°æŒ‡å‡ºï¼›</li><li>å¯ä»¥é€šè¿‡ <code>#[doc(hidden)]</code> å°†ä¸€äº›æ²¡ä»€ä¹ˆå¸®åŠ©çš„å®ç°ç»†èŠ‚ï¼ˆå¦‚ç§æœ‰ç±»å‹å…³è”çš„æ–¹æ³•å®ç°ç­‰ï¼‰ä»ç”Ÿæˆçš„æ–‡æ¡£ä¸­éšè—èµ·æ¥ã€‚</li></ol><h1 id="å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œï¼ˆCLIï¼‰ç¨‹åºï¼ˆWrite-a-Good-CLI-Programï¼‰"><a href="#å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œï¼ˆCLIï¼‰ç¨‹åºï¼ˆWrite-a-Good-CLI-Programï¼‰" class="headerlink" title="å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œï¼ˆCLIï¼‰ç¨‹åºï¼ˆWrite a Good CLI Programï¼‰"></a>å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œï¼ˆCLIï¼‰ç¨‹åºï¼ˆWrite a Good CLI Programï¼‰</h1><p><a href="https://qiita.com/tigercosmos/items/678f39b1209e60843cc3" target="_blank" rel="noopener">Write a Good CLI Program</a> ä¸€æ–‡ä¸­è®²è§£åœ¨ä½¿ç”¨ Rust ç¼–å†™å‘½ä»¤è¡Œç¨‹åºçš„æœ€ä½³å®è·µï¼Œæ ¸å¿ƒçŸ¥è¯†ç‚¹åŒ…æ‹¬ï¼š</p><ol><li>ä½¿ç”¨ <code>clap crates</code> ç¼–å†™å¯ä»¥æ¥æ”¶å¤æ‚å‚æ•°çš„å‘½ä»¤è¡Œç¨‹åºï¼›</li><li>ä½¿ç”¨ <code>.env</code> ç¼–å†™åº”ç”¨é…ç½®ï¼Œä½¿ç”¨ <code>dotenv</code> è¯»å–ç¯å¢ƒå˜é‡ï¼›</li><li>é”™è¯¯å¤„ç†ï¼š<ol><li>panic ä¼šå¯¼è‡´ç¨‹åºç›´æ¥é€€å‡ºï¼Œé€€å‡ºæ²¡æœ‰é”™è¯¯ç ï¼Œé€‚åˆåœ¨è„šæœ¬ä¸­ä½¿ç”¨ï¼›</li><li>å‡½æ•°è¿”å› <code>Result</code>ï¼Œå¯ä»¥æ ¹æ®æ˜¯å¦ä¸º <code>Error</code> æ¥å†³å®šåç»­æ“ä½œï¼›</li><li>å¯ä»¥ä¸ºè‡ªå®šä¹‰ <code>Error</code> å®ç° <code>fmt::Display</code> traitï¼Œæ–¹ä¾¿æ ¼å¼åŒ–è¾“å‡ºé”™è¯¯æ¶ˆæ¯ã€‚</li></ol></li><li>ä½¿ç”¨ <code>println!()</code> ä¼šæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸­ï¼Œè€Œä½¿ç”¨ <code>eprintln!()</code> åˆ™æ˜¯æ ‡å‡†é”™è¯¯ï¼›</li><li>ä½¿ç”¨ <code>std::process::exit(1)</code> è®¾ç½®ç¨‹åºé€€å‡ºç ï¼ˆExit Codeï¼‰ã€‚</li></ol><p>æ‰€è°“çš„å‘½ä»¤è¡Œç¨‹åºï¼ˆCommand Line Interface, CLIï¼‰å°±æ˜¯æŒ‡åœ¨ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºï¼Œæ²¡æœ‰å›¾å½¢ç•Œé¢ã€‚æ¯”å¦‚ <code>ls</code>, <code>ps</code> ç­‰ã€‚åœ¨ <a href="https://github.com/agarrharr/awesome-cli-apps" target="_blank" rel="noopener">awesome-cli-apps</a> ä¸­æ”¶é›†äº†å¾ˆå¤šæ¯”è¾ƒä¼˜è´¨çš„å‘½ä»¤è¡Œç¨‹åºã€‚</p><p>é¢˜å¤–è¯ï¼šä½œè€…å®‰åˆ©äº†ä¸€ä¸ªå«ä½œ <a href="https://github.com/ogham/exa" target="_blank" rel="noopener">exa</a> å‘½ä»¤è¡Œç¨‹åºï¼Œä½¿ç”¨ Rust è¯­è¨€å®ç°ï¼Œå¯ä»¥æ›¿ä»£ <code>ls</code> å‘½ä»¤ã€‚ç¬”è€…è¯•ç”¨äº†ä¸€ä¸‹ï¼Œä½“éªŒä¸é”™ã€‚</p><p><img src="https://pic2.zhimg.com/v2-a698281fe54bda54f57384136240d31f.jpg" alt="exa"></p><h2 id="å‘½ä»¤è¡Œç¨‹åºé•¿ä»€ä¹ˆæ ·"><a href="#å‘½ä»¤è¡Œç¨‹åºé•¿ä»€ä¹ˆæ ·" class="headerlink" title="å‘½ä»¤è¡Œç¨‹åºé•¿ä»€ä¹ˆæ ·"></a>å‘½ä»¤è¡Œç¨‹åºé•¿ä»€ä¹ˆæ ·</h2><p>ä¸€èˆ¬è€Œè¨€ï¼Œå‘½ä»¤è¡Œç¨‹åºä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./program [args] [flags] [options]</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ <code>-h</code> æˆ– <code>--help</code> æŸ¥çœ‹æ›´å¤šå¸®åŠ©ä¿¡æ¯ã€‚</p><p><img src="https://pic1.zhimg.com/v2-45af0e6f82aaed8d96e23e3674469a6a.jpg" alt="exa-help"></p><h2 id="åŠ¨æ‰‹å®è·µ"><a href="#åŠ¨æ‰‹å®è·µ" class="headerlink" title="åŠ¨æ‰‹å®è·µ"></a>åŠ¨æ‰‹å®è·µ</h2><p>å¤§ç¥ Linus Torvalds æ›¾è¨€ã€ŒTalk is cheap, show me the codeã€ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æŠŠ <a href="https://qiita.com/tigercosmos/items/678f39b1209e60843cc3" target="_blank" rel="noopener">Write a Good CLI Program</a> ä¸­æåˆ°çš„ä¸€äº›æŠ€å·§å®è·µä¸€éã€‚</p><p>ç¬”è€…æ›¾ç»ä½¿ç”¨ Rust å®ç°è¿‡ä¸€ä¸ªå°å·¥å…· <a href="https://github.com/iFaceless/gic" target="_blank" rel="noopener">gic</a>ï¼Œå®ƒå¯ä»¥ç”Ÿæˆé£æ ¼ä¸€è‡´çš„ git commit messageï¼Œè¿˜ç®—å®ç”¨ã€‚æ¥ä¸‹æ¥å®ç°ä¸€ä¸ªç®€å•ç‰ˆæœ¬ <code>gitc</code> ä»…ä¾›å‚è€ƒï¼Œå…¨éƒ¨ä»£ç å‚è§ <a href="https://github.com/iFaceless/talent-plan-projects/tree/master/gitc" target="_blank" rel="noopener">talent-plan-projects/gitc</a>ã€‚</p><p>é¦–å…ˆä½¿ç”¨ cargo åˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cargo new gitc</span><br><span class="line"><span class="meta">$</span> cd gitc</span><br></pre></td></tr></table></figure><p>åº”ç”¨ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Cargo.lock</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â”œâ”€â”€ src</span><br><span class="line">â”‚   â”œâ”€â”€ cli.yml</span><br><span class="line">â”‚   â””â”€â”€ main.rs</span><br><span class="line">â””â”€â”€ target</span><br><span class="line">    â””â”€â”€ debug</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶"><a href="#å®šä¹‰å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶" class="headerlink" title="å®šä¹‰å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶"></a>å®šä¹‰å‘½ä»¤è¡Œé…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;--cli.yml--&gt;</span><br><span class="line">name: gitc</span><br><span class="line">version: &quot;0.1.0&quot;</span><br><span class="line">author: 0xE8551CCB &lt;noti@ifaceless.space&gt;</span><br><span class="line">about: Generate elegant and uniform commit message</span><br><span class="line">args:</span><br><span class="line">    - message: </span><br><span class="line">        required: true</span><br><span class="line">        index: 1</span><br><span class="line">        takes_value: true</span><br><span class="line">        help: Use the given &lt;message&gt; as the commit message</span><br><span class="line">    - use-emoji-code-only:</span><br><span class="line">        long: use-emoji-code-only</span><br><span class="line">        help: Use emoji code instead of emoji</span><br></pre></td></tr></table></figure><h3 id="æ³¨å†Œ-emoji-åˆ—è¡¨"><a href="#æ³¨å†Œ-emoji-åˆ—è¡¨" class="headerlink" title="æ³¨å†Œ emoji åˆ—è¡¨"></a>æ³¨å†Œ emoji åˆ—è¡¨</h3><p>ä¸ºäº†æ–¹ä¾¿æ‰©å±•ï¼Œå°† emoji ç›¸å…³ä¿¡æ¯æ”¾ç½®åœ¨å…¨å±€çš„åˆ—è¡¨ä¸­ï¼Œæ‰©å±•åªéœ€è¦æ–°å¢åˆ—è¡¨é¡¹å³å¯ã€‚è¿™é‡Œä½¿ç”¨ <code>layzy_static</code> å®ï¼Œä»–å¯ä»¥å®šä¹‰éœ€è¦åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œç”¨æ³•ç±»ä¼¼åœ¨å…¶å®ƒè¯­è¨€ä¸­å®šä¹‰å…¨å±€å˜é‡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> lazy_static::lazy_static;</span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ³¨å†Œ git emoji åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> GITMOJI_LIST: <span class="built_in">Vec</span>&lt;HashMap&lt;&amp;<span class="symbol">'static</span> <span class="built_in">str</span>, &amp;<span class="symbol">'static</span> <span class="built_in">str</span>&gt;&gt; = <span class="built_in">vec!</span>[</span><br><span class="line">        hashmap! &#123;</span><br><span class="line">            <span class="string">"name"</span> =&gt; <span class="string">"feat"</span>,</span><br><span class="line">            <span class="string">"emoji"</span> =&gt; <span class="string">"âœ¨"</span>,</span><br><span class="line">            <span class="string">"code"</span> =&gt; <span class="string">":feat:"</span>,</span><br><span class="line">            <span class="string">"description"</span> =&gt; <span class="string">"âœ¨ Introduce new features"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        hashmap! &#123;</span><br><span class="line">            <span class="string">"name"</span> =&gt; <span class="string">"fix"</span>,</span><br><span class="line">            <span class="string">"emoji"</span> =&gt; <span class="string">"ğŸ›"</span>,</span><br><span class="line">            <span class="string">"code"</span> =&gt; <span class="string">":fix:"</span>,</span><br><span class="line">            <span class="string">"description"</span> =&gt; <span class="string">"ğŸ› Fix bugs"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ„å»ºå‘½ä»¤è¡Œ-App"><a href="#æ„å»ºå‘½ä»¤è¡Œ-App" class="headerlink" title="æ„å»ºå‘½ä»¤è¡Œ App"></a>æ„å»ºå‘½ä»¤è¡Œ App</h3><p><a href="https://github.com/clap-rs/clap" target="_blank" rel="noopener">clap</a> æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€å·¥ä½œé«˜æ•ˆçš„ Rust å‘½ä»¤è¡Œè§£æå™¨ï¼Œå€ŸåŠ©å®ƒå¯ä»¥éå¸¸è½»æ¾åœ°åˆ›å»ºå‘½ä»¤è¡Œåº”ç”¨ã€‚gitc åœ¨åˆ›å»ºæ—¶ï¼Œä¸€éƒ¨åˆ†å‘½ä»¤è¡Œé…ç½®æ¥è‡ªé™æ€çš„ YAML æ–‡ä»¶ï¼Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯åŸºäºä¸Šè¿°å¯æ‰©å±•çš„ emoji åˆ—è¡¨é…ç½®ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">make_cli_app</span></span>&lt;<span class="symbol">'a</span>, <span class="symbol">'b</span>&gt;(yml: &amp;<span class="symbol">'a</span> Yaml) -&gt; App&lt;<span class="symbol">'a</span>, <span class="symbol">'b</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> app = App::from_yaml(yml);</span><br><span class="line">    <span class="comment">// å°† gitmoji ç›¸å…³å‘½ä»¤æ³¨å†Œè¿›æ¥</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> GITMOJI_LIST.iter() &#123;</span><br><span class="line">        app = app.arg(</span><br><span class="line">            Arg::with_name(item.get(<span class="string">"name"</span>).unwrap())</span><br><span class="line">                .help(item.get(<span class="string">"description"</span>).unwrap())</span><br><span class="line">                .long(item.get(<span class="string">"name"</span>).unwrap()),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç†è§£å‘½ä»¤è¡Œå‚æ•°å¹¶ç”Ÿæˆæ‰§è¡Œé…ç½®"><a href="#ç†è§£å‘½ä»¤è¡Œå‚æ•°å¹¶ç”Ÿæˆæ‰§è¡Œé…ç½®" class="headerlink" title="ç†è§£å‘½ä»¤è¡Œå‚æ•°å¹¶ç”Ÿæˆæ‰§è¡Œé…ç½®"></a>ç†è§£å‘½ä»¤è¡Œå‚æ•°å¹¶ç”Ÿæˆæ‰§è¡Œé…ç½®</h3><p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸‹é¢æŠ½è±¡äº†ä¸€ä¸ª <code>CommitConfig</code> ç»“æ„ä½“ï¼Œç”¨äºå°† <code>git commit</code> æœ‰å…³çš„ç‰¹æ®Šé…ç½®é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è§£æåˆ°è¿™é‡Œã€‚å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CommitConfig</span></span> &#123;</span><br><span class="line">    message: <span class="built_in">String</span>,</span><br><span class="line">    use_emoji_code_only: <span class="built_in">bool</span>,</span><br><span class="line">    gitmoji: <span class="built_in">Option</span>&lt;Gitmoji&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> CommitConfig &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from_cli_arg_matches</span></span>(m: &amp;ArgMatches) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> message = m.value_of(<span class="string">"message"</span>).unwrap();</span><br><span class="line">        <span class="keyword">let</span> use_emoji_code_only = m.is_present(<span class="string">"use-emoji-code-only"</span>);</span><br><span class="line">        CommitConfig &#123;</span><br><span class="line">            message: message.to_string(),</span><br><span class="line">            use_emoji_code_only: use_emoji_code_only,</span><br><span class="line">            gitmoji: Self::match_gitmoji(m),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">match_gitmoji</span></span>(m: &amp;ArgMatches) -&gt; <span class="built_in">Option</span>&lt;Gitmoji&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> GITMOJI_LIST.iter() &#123;</span><br><span class="line">            <span class="keyword">if</span> m.is_present(x.get(<span class="string">"name"</span>).unwrap()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">Some</span>(Gitmoji::from_gitmoji_config(x));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ-git-commit-å‘½ä»¤"><a href="#æ‰§è¡Œ-git-commit-å‘½ä»¤" class="headerlink" title="æ‰§è¡Œ git commit å‘½ä»¤"></a>æ‰§è¡Œ git commit å‘½ä»¤</h3><p>ç”±äºéœ€è¦é€šè¿‡ Shell æ‰§è¡Œ <code>git commit</code> å‘½ä»¤ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ <code>std::process::Command</code> ååŠ©å®Œæˆã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">do_git_commit</span></span>(c: &amp;CommitConfig) -&gt; <span class="built_in">Result</span>&lt;(), std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> msg = c.message.to_string();</span><br><span class="line">    <span class="comment">// æ„å»º commit æ¶ˆæ¯...ï¼ˆçœç•¥æ¶ˆæ¯æ„å»ºä»£ç ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> cmd = Command::new(<span class="string">"git"</span>);</span><br><span class="line">    cmd.arg(<span class="string">"commit"</span>).arg(<span class="string">"-m"</span>).arg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œå‘½ä»¤ï¼Œæ‹¿åˆ°è¾“å‡ºç»“æœ</span></span><br><span class="line">    <span class="keyword">let</span> output = cmd.output()?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;output.stdout));</span><br><span class="line">    <span class="keyword">if</span> !output.status.success() &#123;</span><br><span class="line">        eprintln!(<span class="string">"&#123;&#125;"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;output.stderr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™-main-å‡½æ•°"><a href="#ç¼–å†™-main-å‡½æ•°" class="headerlink" title="ç¼–å†™ main å‡½æ•°"></a>ç¼–å†™ main å‡½æ•°</h3><p>å¥½å•¦ï¼Œç°åœ¨å¯ä»¥å°†ä¸Šè¿°è¿‡ç¨‹ä¸²è”èµ·æ¥ï¼Œå®Œæˆæˆ‘ä»¬çš„ gitc å‘½ä»¤è¡Œå·¥å…·ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> yml = load_yaml!(<span class="string">"cli.yml"</span>);</span><br><span class="line">    <span class="keyword">let</span> matches = make_cli_app(yml).get_matches();</span><br><span class="line">    <span class="keyword">let</span> commit_config = CommitConfig::from_cli_arg_matches(&amp;matches);</span><br><span class="line">    <span class="keyword">match</span> do_git_commit(&amp;commit_config) &#123;</span><br><span class="line">        <span class="literal">Ok</span>(_) =&gt; (),</span><br><span class="line">        <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">            eprintln!(<span class="string">"Error: &#123;&#125;"</span>, e);</span><br><span class="line">            process::exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæˆåï¼Œä½¿ç”¨ <code>cargo build</code> å¯ä»¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://pic3.zhimg.com/v2-e741a4abc0867427cd6820286e12d969.jpg" alt="gitc-help"><br><img src="https://pic1.zhimg.com/v2-d173912444db3aa0126d574d5d3b26c9.jpg" alt="gic-run"></p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>æœ¬èŠ‚é¢„å¤‡çŸ¥è¯†ä¸»è¦å­¦ä¹ äº†ä¸ Cargo æœ‰å…³çš„ç¯å¢ƒå˜é‡ä½œç”¨ã€<code>Cargo.toml</code> ä¸­çš„å…ƒä¿¡æ¯æ„æˆä»¥åŠç¼–å†™è§„èŒƒçš„ API æ–‡æ¡£çš„æ–¹æ³•ï¼Œæœ€åé€šè¿‡ç¼–å†™ <a href="https://github.com/iFaceless/talent-plan-projects/tree/master/gitc" target="_blank" rel="noopener">talent-plan-projects/gitc</a> æŒæ¡äº†å¦‚ä½•ç¼–å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºä»¥åŠä¸€äº›æœ€ä½³å®è·µã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://github.com/pingcap/talent-plan/blob/master/rust/building-blocks/bb-1.md" target="_blank" rel="noopener">PNA Rust â€” Building Blocks 1</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;ä»Šå¤©å¼€å§‹ã€ŒRust ç½‘ç»œç¼–ç¨‹å®è·µã€çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­çš„é¢„å¤‡çŸ¥è¯†å­¦ä¹ ï¼Œå¹¶æœ€ç»ˆèƒ½ç¼–å†™å‡ºä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä»¥ä¸‹ææ–™æ˜¯ä»Šå¤©éœ€è¦é˜…è¯»çš„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://doc.rust-lang.org/cargo/reference/manifest.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;The Cargo manifest format&lt;/a&gt;ï¼šäº†è§£ Cargo mainfest æ–‡ä»¶æ ¼å¼ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://doc.rust-lang.org/cargo/reference/environment-variables.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cargo environment variables&lt;/a&gt;ï¼šäº†è§£ Cargo ç¯å¢ƒå˜é‡ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://rust-lang-nursery.github.io/api-guidelines/documentation.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Rust API Guidelines: Documentation&lt;/a&gt;ï¼šäº†è§£ Rust ç¨‹åºä¸­çš„æ–‡æ¡£ç¼–å†™ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://qiita.com/tigercosmos/items/678f39b1209e60843cc3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Write a Good CLI Program&lt;/a&gt;ï¼šå­¦ä¹ å¦‚ä½•ç¼–å†™å‘½ä»¤è¡Œç¨‹åºã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¾æ¬¡å®Œæˆä¸Šè¿°ææ–™å­¦ä¹ ï¼Œç€é‡è®°å½•ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå¹¶åœ¨æœ€åç¼–å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="ç½‘ç»œç¼–ç¨‹" scheme="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Talent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µå…¥é—¨</title>
    <link href="/2020/04/15/talent-plan-rust-network-programming-intro/"/>
    <id>/2020/04/15/talent-plan-rust-network-programming-intro/</id>
    <published>2020-04-15T03:35:00.000Z</published>
    <updated>2020-04-21T03:16:23.105Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ¬èŠ‚å°†å¼€å§‹ã€ŒTalent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µã€ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å•¦ï¼Œè¯¥ç³»åˆ—è¯¾ç¨‹çš„æœ€ç»ˆç›®æ ‡æ˜¯ä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ä¸€ä¸ªé«˜æ€§èƒ½çš„å•æœºæ—¥å¿—ç±»å‹ï¼ˆlog-structuredï¼‰ key/value å­˜å‚¨æœåŠ¡ï¼Œåˆ†ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®è¿›è¡Œé€šä¿¡ï¼Œèƒ½å¤Ÿä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œæ“ä½œã€‚</p><p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥ç³»åˆ—è¯¾ç¨‹å¹¶éé¢å‘åˆçº§ç¼–ç¨‹çˆ±å¥½è€…ã€‚å‚ä¸è¯¥ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å’Œå®è·µå‰ï¼Œæœ€å¥½å·²ç»æœ‰è¿‡å…¶å®ƒè¯­è¨€ç¼–ç¨‹ç»éªŒï¼Œå¹¶ä¸”å¯¹ Rust è¯­è¨€æœ‰åŸºæœ¬äº†è§£ï¼Œå†™è¿‡ä¸€äº› Rust ä»£ç ã€‚ç¬”è€…å¼ºçƒˆå»ºè®®é˜…è¯» The Rust Book æˆ–è€…ã€ŠRust ç¼–ç¨‹ä¹‹é“ã€‹è¿™æ ·çš„ä¹¦ç±æ¥æ‰“å¥½åŸºç¡€ã€‚Rust ä¸­å¼•å…¥çš„<strong>æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸ</strong>ç­‰æ¦‚å¿µéœ€è¦è½¬å˜æ€ç»´æ¥ç†è§£å®ƒï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½åœ°é¢†æ‚Ÿåˆ°è¿™é—¨è¯­è¨€çš„ç²¾é«“ã€‚</em></p><h1 id="å¤§çº²"><a href="#å¤§çº²" class="headerlink" title="å¤§çº²"></a>å¤§çº²</h1><p>ä»¥ä¸‹æ˜¯ Rust ç½‘ç»œç¼–ç¨‹å®è·µè¯¾ç¨‹å¤§çº²ï¼Œæ€»å…±åˆ†ä¸ºå…­ä¸ªéƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ªéƒ¨åˆ†è¿˜æ²¡å®Œæˆï¼‰ï¼Œå¾ªåºæ¸è¿›åœ°å¼•å¯¼æˆ‘ä»¬é˜…è¯»ä¸€äº›åšå®¢ï¼ŒæŒæ¡æœ€ä½³ç¼–ç¨‹å®è·µï¼Œé€šè¿‡ä¸æ–­å®è·µæ¥åŠ æ·±å¯¹è¿™é—¨è¯­è¨€çš„ç†è§£ã€‚</p><p><img src="https://pic2.zhimg.com/v2-5aba4ddbef921406caef406e0a03ca04.jpg" alt="è¯¾ç¨‹å¤§çº²"></p><h1 id="å­¦ä¹ å§¿åŠ¿"><a href="#å­¦ä¹ å§¿åŠ¿" class="headerlink" title="å­¦ä¹ å§¿åŠ¿"></a>å­¦ä¹ å§¿åŠ¿</h1><p>GitHub <a href="https://github.com/pingcap/talent-plan/" target="_blank" rel="noopener">talent-plan</a> ä»“åº“ä¸­å­˜æ”¾äº†è¯¾ç¨‹ä¸­å®‰æ’çš„ç¼–ç¨‹é¡¹ç›®ï¼Œä½äº <code>/rust/projects</code> ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ¯ä¸€ä¸ªé¡¹ç›®éƒ½æ˜¯åŸºäºå‰ä¸€ä¸ªé¡¹ç›®è¿›è¡Œæ”¹é€ çš„ï¼Œåœ¨æ¯ä¸ªé¡¹ç›®ä¸­éƒ½ä¼šå¢é‡åº”ç”¨ä¸€äº›æ–°çš„ Rust çŸ¥è¯†ï¼Œæ¯”å¦‚å­¦ä¹ å¼•å…¥ç¬¬ä¸‰æ–¹ cratesï¼Œä½¿ç”¨æ ‡å‡†ç½‘ç»œåº“ï¼Œä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ”¹è¿›æœåŠ¡æ€§èƒ½ç­‰ã€‚</p><p>åœ¨è¿›è¡Œæ¯ä¸ªé¡¹ç›®å®è·µä¹‹å‰ï¼Œä¼šæœ‰ä¸€ä¸ªé’ˆå¯¹æ€§çš„ Building Blockï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸€äº›é¢„å¤‡çŸ¥è¯†ã€‚åœ¨é¢„å¤‡çŸ¥è¯†ä¸­ï¼Œä¼šé’ˆå¯¹å’Œæ¥ä¸‹æ¥è¦å®è·µçš„é¡¹ç›®æœ‰å…³çš„è¯é¢˜ï¼Œæä¾›ä¸€äº›é˜…è¯»ææ–™å’Œç»ƒä¹ é¢˜ï¼Œåœ¨é˜…è¯»å®Œæˆåå¯ä»¥é€šè¿‡ç»ƒä¹ é¢˜å·©å›ºä¸‹å­¦ä¹ åˆ°çš„çŸ¥è¯†ï¼Œè¿™æ ·åœ¨è¿›è¡Œé¡¹ç›®å®è·µæ—¶ä¼šæ›´åŠ å¾—å¿ƒåº”æ‰‹ï¼Œæå‡æ•ˆç‡ã€‚</p><h1 id="å¼€å‘ç¯å¢ƒå‡†å¤‡"><a href="#å¼€å‘ç¯å¢ƒå‡†å¤‡" class="headerlink" title="å¼€å‘ç¯å¢ƒå‡†å¤‡"></a>å¼€å‘ç¯å¢ƒå‡†å¤‡</h1><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>rustup</code> ç®¡ç† Rust ç‰ˆæœ¬åŠç›¸å…³çš„å·¥å…·é“¾ã€‚å¦‚æœè¿˜æ²¡æœ‰å®‰è£… Rust ç¼–è¯‘å™¨ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¡Œå®Œæˆï¼ˆLinux æˆ–è€… macOS ç¯å¢ƒï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl https://sh.rustup.rs -sSf | sh</span><br></pre></td></tr></table></figure><p><code>rustup</code> å·¥å…·ä¼šä¸ºæˆ‘ä»¬å®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„ Rust ç¼–è¯‘å™¨ã€‚ä¹‹åä¹Ÿå¯ä»¥é€šè¿‡ <code>rustup update</code> è¿›è¡Œç‰ˆæœ¬æ›´æ–°ï¼Œæˆ–è€…ä½¿ç”¨ <code>rustup self uninstall</code> å®Œæˆ Rust ç¼–è¯‘å™¨å’Œ <code>rustup</code> å¸è½½ã€‚è¯¦ç»†æ“ä½œä¸å†èµ˜è¿°ï¼Œå¯å‚è§ <a href="https://doc.rust-lang.org/book/ch01-00-getting-started.html" target="_blank" rel="noopener">Rust Getting Started</a>ã€‚</p><p>ä¸‹é¢ç¬”è€…å°†è¦å®‰åˆ©ä¸¤æ¬¾ç¥å™¨çº§æ’ä»¶ï¼Œä¾¿äºæå‡ Rust ç¼–ç¨‹ä½“éªŒã€‚æ—©æœŸçš„ Rust IDE æ”¯æŒæ¯”è¾ƒå·®ï¼Œæ˜æ˜¾æ²¡æœ‰å…¶å®ƒè¯­è¨€åœ¨ IDE ä¸­ä½“éªŒèˆ’æœï¼ˆç¬”è€…æ›¾ç»åœ¨ Clion ä¸­å°è¯• Rust æ’ä»¶ï¼Œä½†æ˜¯æ•ˆæœæ¬ ä½³ï¼‰ã€‚ä¸è¿‡ç¤¾åŒºä¸€ç›´éƒ½åœ¨åŠªåŠ›æ”¹è¿›è¿™ä¸€ç‚¹ï¼Œä¸‹é¢ä»‹ç»ä¸‹ç¬”è€…çš„å¼€å‘ç¯å¢ƒï¼Œä»…ä¾›å‚è€ƒã€‚</p><ol><li>Rust ç‰ˆæœ¬ï¼š1.42</li><li>ä»£ç ç¼–è¾‘å™¨ï¼šVisual Studio Code</li><li>æ’ä»¶ï¼š<ol><li><a href="https://github.com/rust-analyzer/rust-analyzer" target="_blank" rel="noopener">rust-analyzer</a>ï¼šè¿™ä¸ªæ˜¯ç”¨æ¥æ›¿ä»£ RLSï¼ˆRust Language Serverï¼‰çš„å®éªŒäº§å“ï¼Œç›®æ ‡æ˜¯æä¾›æ›´åŠ ä¼˜ç§€çš„ IDE åŠŸèƒ½æ”¯æŒã€‚ç›®å‰è™½ç„¶å¤„äº alpha é˜¶æ®µï¼Œä¸è¿‡ç›¸å¯¹å·²æœ‰çš„å…¶å®ƒæ’ä»¶ï¼Œå·²ç»éå¸¸å®ç”¨äº†ã€‚æ”¯æŒä»£ç è‡ªåŠ¨è¡¥é½ã€æ–‡æ¡£æç¤ºã€å‡½æ•°å®ç°è·³è½¬ã€<code>main</code> å‡½æ•°è¯†åˆ«ã€å•å…ƒæµ‹è¯•è¯†åˆ«ç­‰ã€‚æ¨èä½¿ç”¨~</li><li><a href="https://www.tabnine.com/" target="_blank" rel="noopener">TabNine</a>ï¼šè¿™æ˜¯ä¸€æ¬¾æ™ºèƒ½ä»£ç è‡ªåŠ¨è¡¥å…¨å·¥å…·ï¼Œé‡‡ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯åŠ é€Ÿä»£ç ç¼–å†™ï¼Œæ”¯æŒä¸»æµç¼–ç¨‹è¯­è¨€ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒTabNine æœåŠ¡æœ¬èº«æ˜¯ä½¿ç”¨ Rust ç¼–å†™ï¼Œæ‰€ä»¥å®ƒçš„å¾ˆå¤šä»˜è´¹åŠŸèƒ½éƒ½æ˜¯å¯¹ Rust è¯­è¨€å¼€æ”¾çš„ï¼Œæ‰€ä»¥å°½ç®¡ä½¿ç”¨å§ã€‚</li></ol></li></ol><p><img src="https://pic4.zhimg.com/v2-70d3d483b71301424965477e588c2f9b.jpg" alt="å¼€å‘ç¯å¢ƒ"></p><h1 id="å…³äºè°ƒè¯•"><a href="#å…³äºè°ƒè¯•" class="headerlink" title="å…³äºè°ƒè¯•"></a>å…³äºè°ƒè¯•</h1><p>æŒæ¡è°ƒè¯•æŠ€èƒ½ï¼Œå¯¹äºæ’æŸ¥ç¨‹åºé—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚é‚£ä¹ˆå¦‚ä½•åœ¨ Visual Studio Code ä¸­è°ƒè¯•æˆ‘ä»¬çš„ Rust é¡¹ç›®å‘¢ï¼Ÿä¸‹é¢å°†ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ¼”ç¤ºä¸‹å¦‚ä½•è¿›è¡Œè°ƒè¯•ã€‚</p><p>é¦–å…ˆï¼Œåœ¨å·¥ç¨‹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªç¤ºä¾‹é¡¹ç›® <code>cargo new miao</code>ï¼Œç„¶åè¾“å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶æ‰§è¡Œ <code>cargo build</code>ï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä½äº <code>target/debug</code> ç›®å½•ä¸‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(binary_search(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>], <span class="number">10</span>), -<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(binary_search(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>], <span class="number">1</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">binary_search</span></span>(nums: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt;, target: <span class="built_in">i32</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> nums.len() == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> left = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> right = nums.len() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> left &lt; right &#123;</span><br><span class="line">        <span class="keyword">let</span> mid = left + (right - left) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> nums[mid] == target &#123;</span><br><span class="line">            <span class="keyword">return</span> mid <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> nums[mid] &lt; target &#123;</span><br><span class="line">            left = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            right = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    -<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œç‚¹å‡» vscode å·¦ä¾§å·¥å…·æ ä¸­çš„ã€Œè°ƒè¯•ã€æŒ‰é’®ï¼Œå¹¶ä¸”ç‚¹å‡»ã€Œcreate a launch.json fileã€æŒ‰é’®ï¼Œåˆ›å»ºå¯åŠ¨é…ç½®æ–‡ä»¶ã€‚åœ¨å¼¹å‡ºçš„å€™é€‰æ¡†ä¸­é€‰æ‹©ã€ŒC++ (GDB/LLDB)ã€ã€‚<br><img src="https://pic4.zhimg.com/v2-7301528605ef12c77b1de47aabcc273a.jpg" alt="create launch json"></p><p>ç´§æ¥ç€ï¼Œç¼–è¾‘ç”Ÿæˆçš„ <code>.vscode/launch.json</code> æ–‡ä»¶ï¼Œä¿®æ”¹å…¶ä¸­çš„ç¨‹åºå¯åŠ¨é…ç½®ï¼Œå³ <code>configurations.program</code> æŒ‡å‘å¯æ‰§è¡Œæ–‡ä»¶ <code>${workspaceFolder}/target/debug/miao</code>ã€‚<br><img src="https://pic4.zhimg.com/v2-164ce2e487a7dc66404363f10f875fc0.jpg" alt="edit launch json"></p><p>æ¥ä¸‹æ¥ï¼Œåœ¨ä»£ç ä¸­æ·»åŠ æ–­ç‚¹ï¼Œç„¶åæ‰§è¡Œ <code>cargo build</code>ï¼ˆé»˜è®¤ä¼šä»¥ debug æ¨¡å¼æ„å»ºï¼‰ï¼Œæœ€åå¯åŠ¨è°ƒè¯•å³å¯ã€‚</p><p><img src="https://pic2.zhimg.com/v2-49c9a51d574b00d4f27ade589fd6ca4b.jpg" alt=""></p><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· <code>rust-lldb</code> æ‰§è¡Œè°ƒè¯•ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥å‰å¾€ <a href="http://blog.dreamfever.me/2019/01/13/rust-lldb-debug-guide/" target="_blank" rel="noopener">Rust LLDB è°ƒè¯•å…¥é—¨æŒ‡åŒ—</a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>æœ¬èŠ‚å¯¹ã€ŒTalent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µã€ç³»åˆ—è¯¾ç¨‹è¿›è¡Œäº†ç®€å•ä»‹ç»ï¼Œäº†è§£è¯¾ç¨‹çš„å…·ä½“å®‰æ’ï¼Œå¹¶åœ¨æœ€åç»™å‡ºäº† Rust å¼€å‘ç¯å¢ƒæ­å»ºçš„ä¸€äº›å‚è€ƒã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://github.com/pingcap/talent-plan/tree/master/rust" target="_blank" rel="noopener">Practical Networked Applications in Rust</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ¬èŠ‚å°†å¼€å§‹ã€ŒTalent Plan ä¹‹ Rust ç½‘ç»œç¼–ç¨‹å®è·µã€ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å•¦ï¼Œè¯¥ç³»åˆ—è¯¾ç¨‹çš„æœ€ç»ˆç›®æ ‡æ˜¯ä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ä¸€ä¸ªé«˜æ€§èƒ½çš„å•
      
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="ç½‘ç»œç¼–ç¨‹" scheme="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>PingCAP Talent Plan è¯¾ç¨‹ä»‹ç»</title>
    <link href="/2020/04/13/talent-plan-summary/"/>
    <id>/2020/04/13/talent-plan-summary/</id>
    <published>2020-04-13T06:24:31.000Z</published>
    <updated>2020-04-13T10:40:05.357Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>éšç€ç§»åŠ¨äº’è”ç½‘ã€ç‰©è”ç½‘ã€äº‘è®¡ç®—ä»¥åŠæœªæ¥ 5G æŠ€æœ¯åœºæ™¯çš„åº”ç”¨æ‹“å±•ï¼Œç›¸å…³åº”ç”¨çš„æ•°æ®è§„æ¨¡ä¹Ÿåœ¨ä¸æ–­å¢é•¿ï¼Œé¢ä¸´çš„å­˜å‚¨å‹åŠ›è¶Šå‘æ˜æ˜¾ã€‚åœ¨æ­¤èƒŒæ™¯ä¸‹ï¼Œä¼ ç»Ÿçš„å•æœº MySQL æ•°æ®åº“å·²ç»æ— æ³•è½»æ¾åº”ä»˜ï¼Œå³ä¾¿ä»¥åˆ†åº“åˆ†è¡¨çš„æ–¹å¼åº”å¯¹ï¼Œä¹Ÿä¾ç„¶å­˜åœ¨æ‰©å±•æ€§è¾ƒå·®ã€å¯ä¼¸ç¼©èƒ½åŠ›ä¸è¶³ã€è‡ªåŠ¨åŒ–è¿ç»´èƒ½åŠ›ä¸è¶³ç­‰é—®é¢˜ã€‚ä¼´éšç€ Google å†…éƒ¨çš„åˆ†å¸ƒå¼æ•°æ®åº“ Spanner å’Œ F1 çš„è®¾è®¡æ€æƒ³å¼€æ”¾ï¼Œ<a href="https://www.pingcap.com" target="_blank" rel="noopener">PingCAP</a> å…¬å¸åœ¨ 2015 å¹´å—åˆ°ç›¸åº”çš„å¯å‘åå¼€å‘äº† <a href="https://book.tidb.io/" target="_blank" rel="noopener">TiDB</a> æ•°æ®åº“ï¼Œå†ç»å°†è¿‘äº”å¹´çš„è¿­ä»£ï¼Œç›®å‰å®ƒå·²ç»æˆä¸ºå¼€æºç¤¾åŒºéå¸¸çŸ¥åçš„ NewSQL æ•°æ®åº“ä»£è¡¨äº†ï¼Œå¹¶ä¸”å·²ç»åœ¨<a href="https://pingcap.com/cases-cn/" target="_blank" rel="noopener">è¯¸å¤šçŸ¥åä¼ä¸šä¸­å¾—åˆ°äº†éƒ¨ç½²å’Œåº”ç”¨</a>ã€‚</p><p>åœ¨æ­£å¼å¼•å…¥ PingCAP Talent Plan ç³»åˆ—è¯¾ç¨‹ä»‹ç»å‰ï¼Œæœ‰å¿…è¦å¯¹ TiDB æœ‰æ‰€äº†è§£ã€‚ä»¥ä¸‹å°†è¦ä»‹ç»çš„å†…å®¹åŒ…æ‹¬ï¼š</p><ol><li>TiDB æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>TiDB çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆä¼šè¯ç”Ÿ Talent Plan è¯¾ç¨‹ï¼Ÿ</li><li>Talent Plan è¯¾ç¨‹å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ</li></ol><h1 id="åˆè¯†-TiDB"><a href="#åˆè¯†-TiDB" class="headerlink" title="åˆè¯† TiDB"></a>åˆè¯† TiDB</h1><p>ä»å®˜ç½‘ä¸Šå¾—çŸ¥ï¼ŒTiDB æ˜¯ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œå¹¶ä¸”é«˜åº¦å…¼å®¹ MySQL åè®®ï¼Œè¿™ä¹Ÿä¸ºæˆ‘ä»¬è¿ç§»å¹¿æ³›åŸºäº MySQL çš„åº”ç”¨å¥ å®šäº†åŸºç¡€ã€‚ä¸‹é¢æ¥çœ‹çœ‹å®ƒä¸»è¦æœ‰å“ªäº›ç‰¹æ€§å‘¢ï¼Ÿ</p><ol><li>æ”¯æŒ OLTP + OLAP çš„æ··åˆåœºæ™¯ï¼Œæ˜¯ä¸€æ¬¾ HTAPï¼ˆHybrid Transactional/Analytical Processingï¼‰ èåˆå‹æ•°æ®åº“äº§å“ï¼›</li><li>æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¹è§‚äº‹åŠ¡+æ‚²è§‚äº‹åŠ¡æ¨¡å‹å‡æ”¯æŒï¼‰ï¼›</li><li>é«˜å¯ç”¨ï¼Œå…·å¤‡æ•…éšœè‡ªåŠ¨æ¢å¤èƒ½åŠ›ï¼›</li><li>æ˜“äºä¼¸ç¼©ï¼ŒTiDB å’Œ TiKV å‡å¯æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒæµ·é‡æ•°æ®å­˜å‚¨ï¼›</li><li>TiDB 4.0 å…¨é¢æ‹¥æŠ±äº‘åŸç”Ÿï¼Œæä¾›äº†éå¸¸å¤šçš„éƒ¨ç½²æ–¹å¼ï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿æœ¬åœ°éƒ¨ç½²æµ‹è¯•ï¼Œ<a href="https://github.com/pingcap-incubator/tiup" target="_blank" rel="noopener">tiup</a> å·¥å…·çš„è¯ç”Ÿï¼Œä¹Ÿä¸ºåƒç¬”è€…è¿™æ ·çš„å°ç™½ç”¨æˆ·é“ºå¹³äº†é“è·¯ã€‚</li></ol><h2 id="æ ¸å¿ƒç»„ä»¶"><a href="#æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h2><p><img src="https://pic4.zhimg.com/v2-c752ea0558eed832482ebfc32708aeb1.jpg" alt=""></p><p><a href="https://book.tidb.io/session1/chapter1/tidb-architecture.html" target="_blank" rel="noopener">TiDB in Action</a> ä¸­å¯¹äº TiDB çš„æ•´ä½“æ¶æ„æœ‰è¯¦ç»†çš„æè¿°ã€‚æ¦‚æ‹¬æ¥è¯´ï¼ŒTiDB çš„æ•´ä½“æ¶æ„æ¸…æ™°æ˜“æ‡‚ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li><a href="https://github.com/pingcap/tidb" target="_blank" rel="noopener">TiDB</a>ï¼šæ­¤ä¸º SQL å±‚ï¼Œå³æ— çŠ¶æ€è®¡ç®—å±‚ã€‚è´Ÿè´£ SQL è§£æã€ä¼˜åŒ–ï¼Œå¹¶ç”Ÿæˆåˆ†å¸ƒå¼æ‰§è¡Œè®¡åˆ’ã€‚å®é™…çš„æ•°æ®è¯·æ±‚ä¼šå‘é€ç»™åº•å±‚çš„å­˜å‚¨å¼•æ“ TiKVã€‚å…·ä½“å¯ä»¥é˜…è¯» <a href="https://book.tidb.io/session1/chapter3/tidb-computing.html" target="_blank" rel="noopener">è°ˆè®¡ç®—</a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</li><li><a href="https://github.com/pingcap/tikv" target="_blank" rel="noopener">TiKV</a>ï¼šæ­¤ä¸ºå­˜å‚¨å¼•æ“å±‚ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„ KV æ•°æ®åº“ã€‚TiFlash æ˜¯åˆ—å¼å­˜å‚¨å¼•æ“ï¼Œä¸»è¦æ˜¯é’ˆå¯¹åˆ†æå‹åœºæ™¯æŸ¥è¯¢è€Œè®¾è®¡ã€‚ å…·ä½“å¯ä»¥é˜…è¯» <a href="https://book.tidb.io/session1/chapter2/tidb-storage.html" target="_blank" rel="noopener">è¯´å­˜å‚¨</a> å’Œ <a href="https://book.tidb.io/session1/chapter9/tiflash-architecture.html" target="_blank" rel="noopener">TiFlash æ¶æ„åŸç†</a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</li><li><a href="https://github.com/pingcap/pd" target="_blank" rel="noopener">PD</a>ï¼šå…¨ç§°ä¸º Placement Driverï¼Œå®ƒè´Ÿè´£æ•´ä¸ª TiDB é›†ç¾¤çš„å…ƒä¿¡æ¯ç®¡ç†ã€å­˜å‚¨èŠ‚ç‚¹è®¿é—®è‡ªåŠ¨è´Ÿè½½å‡è¡¡è°ƒåº¦ã€åˆ†å¸ƒå¼äº‹åŠ¡ ID åˆ†é…ç­‰ï¼Œå¯ä»¥çœ‹æˆæ•´ä¸ªé›†ç¾¤çš„å¤§è„‘ã€‚å¯ä»¥é˜…è¯» <a href="https://book.tidb.io/session1/chapter4/scheduling-overview.html" target="_blank" rel="noopener">è®²è°ƒåº¦</a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</li></ul><h2 id="æ›´å¤šå­¦ä¹ èµ„æº"><a href="#æ›´å¤šå­¦ä¹ èµ„æº" class="headerlink" title="æ›´å¤šå­¦ä¹ èµ„æº"></a>æ›´å¤šå­¦ä¹ èµ„æº</h2><p>TiDB çš„ç¤¾åŒºèµ„æºç›¸å½“ä¸°å¯Œï¼Œåœ¨ PingCAP å®˜ç½‘ä¸­å¯ä»¥çœ‹åˆ°å¾ˆå¤šå­¦ä¹ èµ„æºï¼Œç¬”è€…ç®€å•æ•´ç†äº†ä¸‹ï¼Œä¼ é€é—¨å¦‚ä¸‹ï¼š</p><ol><li><a href="https://pingcap.com/docs-cn/stable/how-to/get-started/deploy-tidb-from-docker-compose/" target="_blank" rel="noopener">å¿«é€Ÿå…¥é—¨</a>ï¼›</li><li><a href="https://pingcap.com/blog-cn/tidb-best-practice/" target="_blank" rel="noopener">æœ€ä½³å®è·µ</a>ï¼›</li><li><a href="https://pingcap.com/docs-cn/stable/reference/tools/user-guide/" target="_blank" rel="noopener">å‘¨è¾¹å·¥å…·</a>ï¼›</li><li><a href="https://pingcap.com/blog-cn/#DM-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" target="_blank" rel="noopener">DM æºç è§£è¯»</a>ï¼›</li><li><a href="https://pingcap.com/blog-cn/#TiDB-Binlog-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" target="_blank" rel="noopener">TiDB Binglog æºç è§£è¯»</a>ï¼›</li><li><a href="https://pingcap.com/blog-cn/#TiDB-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" target="_blank" rel="noopener">TiDB æºç è§£è¯»</a>ï¼›</li><li><a href="https://pingcap.com/blog-cn/#TiKV-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" target="_blank" rel="noopener">TiKV æºç è§£è¯»</a>ï¼›</li><li><a href="https://university.pingcap.com/" target="_blank" rel="noopener">PingCAP University</a>ï¼›</li><li><a href="https://tikv.org/deep-dive/introduction/" target="_blank" rel="noopener">æ·±å…¥ TiKV</a>ã€‚</li></ol><h1 id="è·ƒè·ƒæ¬²è¯•"><a href="#è·ƒè·ƒæ¬²è¯•" class="headerlink" title="è·ƒè·ƒæ¬²è¯•"></a>è·ƒè·ƒæ¬²è¯•</h1><p>å¦‚æœå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæ„Ÿå…´è¶£çš„è¯ï¼Œé‚£ä¹ˆè·Ÿç€ PingCAP æ¨å‡ºçš„ç³»åˆ—è¯¾ç¨‹å­¦ä¹ å¹¶å‚ä¸åˆ°å¼€æºé¡¹ç›®ä¸­ï¼Œä¸€å®šä¼šæœ‰å¾ˆå¤šæ”¶è·ã€‚ä¸è¿‡é¢å¯¹å¦‚æ­¤åºå¤§çš„ç³»ç»Ÿï¼Œæƒ³è¦æ·±å…¥äº†è§£å…¶åŸç†å¹¶èƒ½å¤Ÿè¯»æ‡‚æºç è¿˜æ˜¯æœ‰äº›é—¨æ§›çš„ã€‚å¥½åœ¨æœ‰å¾ˆå¤šå®˜æ–¹çš„æºç è§£è¯»åšå®¢å¯ä»¥å­¦ä¹ ~</p><p>ä¸è¿‡åœ¨å®é™…å­¦ä¹ ä¸­è¿˜æ˜¯é‡åˆ°ä¸€äº›å›°éš¾ï¼Œæ¯”å¦‚ç¼–ç¨‹è¯­è¨€ï¼ˆGo å’Œ Rustï¼‰å®è·µä¸è¶³ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºå’Œå®è·µç»“åˆå­˜åœ¨é¸¿æ²Ÿç­‰ã€‚æ‰€ä»¥ï¼ŒPingCAP å®˜æ–¹æ¨å‡ºäº† Talent Plan è¯¾ç¨‹ï¼Œåˆ†ä¸º TiDB æ–¹å‘å’Œ TiKV æ–¹å‘ã€‚ç”±äºç¬”è€…å¯¹äº Rust è¯­è¨€çš„äº†è§£ä»…ä»…æµ®äºè¡¨é¢ï¼Œå®è·µä¸å¤šï¼Œåˆšå¥½ Talent Plan æä¾›äº†è¿™æ ·çš„æœºä¼šï¼Œå¯ä»¥ä» 0 åˆ° 1 è®¾è®¡å¹¶å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚åœ¨å®Œæˆè¿™ä¸ªç³»åˆ—è¯¾ç¨‹å­¦ä¹ åï¼Œä¹Ÿèƒ½è®©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£ TiDB å’Œ TiKVï¼Œå¹¶ä¸”åœ¨å°è¯•é˜…è¯»å®ƒä»¬çš„æºç æ—¶ï¼Œä¹Ÿä¸è‡³äºä¸€å¤´é›¾æ°´å•¦~</p><p>åœ¨ GitHub <a href="https://github.com/pingcap/talent-plan" target="_blank" rel="noopener">talent-plan</a> ä»“åº“ä¸­å¯ä»¥çœ‹åˆ°å…³äºè¿™ä¸ªç³»åˆ—è¯¾ç¨‹çš„ä»‹ç»ã€‚ä¸ºäº†ä¾¿äºå¿«é€Ÿäº†è§£è¯¾ç¨‹å¤§çº²ï¼Œç”»äº†ä¸€ä¸ªæ€ç»´å¯¼å›¾å¦‚ä¸‹ï¼ˆç¬”è€…ä¸»è¦å…³æ³¨çš„æ˜¯ Rust éƒ¨åˆ†ï¼‰ï¼š</p><p><img src="https://pic4.zhimg.com/v2-2ae2e76368fd0f0cdf08042f7d195029.jpg" alt=""></p><h1 id="ä¸Šè½¦ï¼Œèµ°å§"><a href="#ä¸Šè½¦ï¼Œèµ°å§" class="headerlink" title="ä¸Šè½¦ï¼Œèµ°å§"></a>ä¸Šè½¦ï¼Œèµ°å§</h1><p>æ¥ä¸‹æ¥ï¼Œç¬”è€…å°†æŒ‰ç…§ Talent Plan å®‰æ’çš„è¯¾ç¨‹å¾ªåºæ¸è¿›åœ°å­¦ä¹ ï¼Œå¹¶åœ¨å­¦ä¹ ä¸­åšä¸€äº›ç¬”è®°ï¼Œä»¥ä¾¿éšæ—¶å¤ä¹ ï¼Œæ¬¢è¿å›´è§‚äº¤æµ~</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://www.pingcap.com" target="_blank" rel="noopener">PingCAP å®˜ç½‘</a></li><li><a href="https://book.tidb.io/" target="_blank" rel="noopener">TiDB in Action</a></li><li><a href="https://studygolang.com/articles/21947" target="_blank" rel="noopener">æˆ‘ä»¬æ˜¯å¦‚ä½•è®¾è®¡ Rust &amp; åˆ†å¸ƒå¼å­˜å‚¨æ•™ç¨‹çš„ï¼Ÿ | Talent Plan èƒŒåçš„æ•…äº‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;éšç€ç§»åŠ¨äº’è”ç½‘ã€ç‰©è”ç½‘ã€äº‘è®¡ç®—ä»¥åŠæœªæ¥ 5G æŠ€æœ¯åœºæ™¯çš„åº”ç”¨æ‹“å±•ï¼Œç›¸å…³åº”ç”¨çš„æ•°æ®è§„æ¨¡ä¹Ÿåœ¨ä¸æ–­å¢é•¿ï¼Œé¢ä¸´çš„å­˜å‚¨å‹åŠ›è¶Šå‘æ˜æ˜¾ã€‚åœ¨æ­¤èƒŒæ™¯ä¸‹ï¼Œä¼ ç»Ÿçš„
      
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼ç³»ç»Ÿ" scheme="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Go" scheme="/tags/Go/"/>
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="PingCAP" scheme="/tags/PingCAP/"/>
    
      <category term="åˆ†å¸ƒå¼ç³»ç»Ÿ" scheme="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="å­˜å‚¨ç³»ç»Ÿ" scheme="/tags/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Go RESTful API é¡¹ç›®æ¨¡æ¿ä»‹ç»</title>
    <link href="/2020/04/02/go-rest-api-for-beginners/"/>
    <id>/2020/04/02/go-rest-api-for-beginners/</id>
    <published>2020-04-02T15:03:15.000Z</published>
    <updated>2020-04-13T10:50:03.217Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-å¼•è¨€"><a href="#0x00-å¼•è¨€" class="headerlink" title="0x00 å¼•è¨€"></a>0x00 å¼•è¨€</h1><p>ç–«æƒ…æœŸé—´å­¦çš„ä¸œè¥¿æ¯”è¾ƒæ‚ï¼ˆæ¯”å¦‚å­¦ä¹ äº†å¦‚ä½•åœ¨å¸‚åœºè¡Œæƒ…ä¸å¥½çš„æ—¶å€™è¿˜ç›²ç›®åŠ ä»“ ğŸ™‚ï¼‰ï¼Œæ²¡ä»€ä¹ˆå¹²è´§å€¼å¾—åˆ†äº«ã€‚ä¸è¿‡è€ƒè™‘åˆ°å¾ˆä¹…éƒ½æ²¡æœ‰æ›´æ–°äº†ï¼Œè¿˜æ˜¯è¦å¼ºè¿«è‡ªå·±å†™ä¸€ç‚¹ä¸œè¥¿ï¼Œä¸ç„¶å®¹æ˜“å˜æ‡’ã€‚æ€»ä¹‹ï¼Œå¤šæ€è€ƒï¼Œå¤šå®è·µè¿˜æ˜¯å¾ˆé‡è¦ã€‚</p><p>ä»Šå¤©ä¸»è¦æ˜¯æƒ³æŠŠä¸‰ä¸ªæœˆå‰å°±æ”¾åˆ° GitHub ä¸Šçš„ <a href="https://github.com/iFaceless/go-rest-api-starter" target="_blank" rel="noopener">go-rest-api-starter</a> é¡¹ç›®ä»‹ç»ä¸‹ï¼Œç›®çš„æœ‰ä¸¤ä¸ªï¼š</p><ol><li>åˆ†äº«ä¸‹æˆ‘ä»¬ç›®å‰çš„å·¥ç¨‹å®è·µï¼›</li><li>ç»™ <a href="https://github.com/ifaceless/portal" target="_blank" rel="noopener">portal</a> å¢åŠ ç‚¹æ›å…‰åº¦ ğŸ˜Šã€‚è™½ç„¶ç¬”è€…åœ¨ <a href="https://zhuanlan.zhihu.com/p/85404746" target="_blank" rel="noopener">Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ–</a> åšè¿‡ä»‹ç»ï¼Œä¸è¿‡ä¸€ç›´æ²¡æœ‰ç»™è¿‡æˆ‘ä»¬åœ¨çœŸå®ç¯å¢ƒä¸­çš„å…·ä½“ç”¨æ³•ï¼Œä»Šå¤©æä¾›çš„ç¤ºä¾‹ä¹Ÿåˆšå¥½å¯ä»¥å¸®åŠ©æ„Ÿå…´è¶£çš„åŒå­¦äº†è§£ä¸‹å®ƒçš„ç”¨æ³•ã€‚</li></ol><h1 id="0x01-ä¸ºä»€ä¹ˆï¼Ÿ"><a href="#0x01-ä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="0x01 ä¸ºä»€ä¹ˆï¼Ÿ"></a>0x01 ä¸ºä»€ä¹ˆï¼Ÿ</h1><p>å¥½çš„å·¥ç¨‹è§„èŒƒæ˜¯åœ¨é¡¹ç›®å®è·µä¸­ä¸æ–­è¸©å‘æ€»ç»“å‡ºæ¥çš„ï¼ŒæœŸé—´æˆ‘ä»¬ä¹Ÿé‡åˆ°å„ç§å†™èµ·æ¥ä¸å¤Ÿä¼˜é›…çš„åœ°æ–¹ï¼Œè‡ªç„¶å°±éœ€è¦æƒ³åŠæ³•è§£å†³è¿™äº›é—®é¢˜ã€‚ç»è¿‡è‹¥å¹²é¡¹ç›®çš„å®è·µï¼Œç»“åˆé‡åˆ°çš„é—®é¢˜ï¼Œä¹Ÿé€ äº†äº›è½®å­ä¾¿äºæå‡<strong>å¼€å‘å¹¸ç¦åº¦</strong>ã€‚æ²‰æ·€å’Œæç‚¼çš„ç»“æœï¼Œä¾¿æ˜¯ä¸€å¥—å¯ä»¥æ²¿è¢­çš„é¡¹ç›®è„šæ‰‹æ¶ï¼Œé›†æˆäº†ä¸€äº›æˆ‘ä»¬è®¤ä¸ºçš„ã€Œæœ€ä½³å®è·µã€ã€‚</p><p>ç¬”è€…ç›¸ä¿¡ä¸åŒçš„å›¢é˜Ÿæœ‰ä¸åŒçš„æƒ³æ³•ï¼Œä½†æœ¬è´¨ä¸Šéƒ½æ˜¯æ›´å¥½çš„æœåŠ¡äºä¸šåŠ¡ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»¥<strong>ä¸€è‡´</strong>ã€<strong>æ¸…æ™°</strong>çš„æ–¹å¼æ¥ç¼–å†™ä»£ç ï¼Œå¹¶ä¸”ä¿è¯é¡¹ç›®ç»“æ„ä¸è¢«éšæ„ç ´åï¼Œé¡¹ç›®çš„å¯ç»´æŠ¤æ€§å¤§äºä¸€åˆ‡ã€‚å¦å¤–ï¼Œå¯¹äºä¸šåŠ¡æ¡†æ¶ï¼Œä¹Ÿä¸åº”è¯¥ä¸€å‘³åœ°æ’æ–¥ã€‚åˆç†åœ°ä½¿ç”¨ä¸šåŠ¡æ¡†æ¶ï¼Œæ—¢æœ‰åˆ©äºç®€åŒ–ä¸šåŠ¡ä»£ç ç¼–å†™ï¼Œåˆæœ‰åˆ©äºç†è§£å’Œç»´æŠ¤ã€‚</p><h1 id="0x02-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#0x02-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="0x02 æ˜¯ä»€ä¹ˆï¼Ÿ"></a>0x02 æ˜¯ä»€ä¹ˆï¼Ÿ</h1><p><a href="https://github.com/iFaceless/go-rest-api-starter" target="_blank" rel="noopener">go-rest-api-starter</a> æ˜¯ä¸€ä¸ªå®Œæ•´çš„ RESTful API é¡¹ç›®ï¼ˆå•†å“ç®¡ç†åå°+å‰å°æ¥å£ï¼Œæºè‡ª <a href="https://dev.aizoo.com" target="_blank" rel="noopener">aizoo</a> ç®¡ç†åå°ï¼‰ï¼Œæ¼”ç¤ºäº†æˆ‘ä»¬ç›®å‰çš„å·¥ç¨‹å®è·µæ˜¯ä»€ä¹ˆæ ·çš„ã€‚å½“ç„¶ï¼Œå›¢é˜Ÿå†…éƒ¨ç‰ˆæœ¬ä½¿ç”¨äº†ä¸€äº›éå¼€æºæ¡†æ¶ï¼Œä¸è¿‡åŒæ ·çš„ç†å¿µæ¢æˆåˆ«çš„æ¡†æ¶ä¾ç„¶å¯è¡Œã€‚æ‰€ä»¥ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­ï¼Œç¬”è€…å°†ä¸€äº›å†…éƒ¨æ¡†æ¶æ¢æˆäº†å¼€æºæ¡†æ¶ï¼Œæ–¹ä¾¿å¤§å®¶å‚è€ƒã€‚</p><p>ä»è¿™ä¸ªé¡¹ç›®ä¸­å¯ä»¥äº†è§£åˆ°ä»€ä¹ˆï¼Ÿ</p><ol><li>æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œåˆ†å±‚æƒ…å†µï¼›</li><li>Model å±‚æ€ä¹ˆç¼–å†™ï¼Œå…³è”èµ„æºå¦‚ä½•ä»¥å±æ€§æ–¹å¼æš´éœ²ï¼›</li><li>Schema å±‚æ€ä¹ˆç¼–å†™ï¼Œè¡¨å•æ ¡éªŒé€»è¾‘æ”¾åœ¨ä»€ä¹ˆä½ç½®ï¼›</li><li>å¤æ‚ä¸šåŠ¡é€»è¾‘å¦‚ä½•åœ¨ Controller å±‚å®ç°ï¼›</li><li>å¦‚ä½•ä¿è¯ Handler å±‚æ•´æ´æ¸…æ™°ï¼›</li><li><a href="https://github.com/ifaceless/portal" target="_blank" rel="noopener">portal</a> æ‰€æ‰®æ¼”çš„è§’è‰²ï¼Œå¦‚ä½•ç®€åŒ–å­—æ®µæ ¼å¼åŒ–é€»è¾‘ã€‚</li></ol><p>é¦–å…ˆæ¥çœ‹ä¸‹é¡¹ç›®ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ .envï¼ˆç¯å¢ƒå˜é‡é…ç½®ï¼Œèµ„æºè¿æ¥ä¸²ç­‰ï¼‰</span><br><span class="line">â”œâ”€â”€ .env_unittestï¼ˆè·‘å•å…ƒæµ‹è¯•ä½¿ç”¨çš„æµ‹è¯•èµ„æºé…ç½®ï¼‰</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ starter-adminï¼ˆé¢å‘ç®¡ç†åå°çš„ RESTful API æœåŠ¡å™¨ï¼‰</span><br><span class="line">â”‚   â””â”€â”€ starter-webï¼ˆé¢å‘å®¢æˆ·ç«¯ã€PC ç­‰å‰å°çš„ RESTful API æœåŠ¡å™¨ï¼‰</span><br><span class="line">â”œâ”€â”€ cmdï¼ˆå„ä¸ªæœåŠ¡å¯åŠ¨çš„å…¥å£ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ adminï¼ˆç®¡ç†åå°ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ main.go</span><br><span class="line">â”‚   â”œâ”€â”€ beeï¼ˆç¦»çº¿å¼‚æ­¥ä»»åŠ¡ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ main.go</span><br><span class="line">â”‚   â”œâ”€â”€ serviceï¼ˆRPC æœåŠ¡ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ main.go</span><br><span class="line">â”‚   â””â”€â”€ webï¼ˆå®¢æˆ·ç«¯ã€PCã€å°ç¨‹åºç­‰å‰å°ï¼‰</span><br><span class="line">â”‚       â””â”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ go.modï¼ˆä¾èµ–åŒ… go modulesï¼‰</span><br><span class="line">â”œâ”€â”€ pkg</span><br><span class="line">â”‚   â”œâ”€â”€ adminï¼ˆç®¡ç†åå°æœåŠ¡ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ handler</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ router.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ schemaï¼ˆå’Œè¿”å›çš„ JSON æ•°æ®å…³è”çš„èµ„æºç»“æ„ä½“å®šä¹‰ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ validatorï¼ˆé€šç”¨çš„æ ¡éªŒä»£ç ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ configï¼ˆèµ„æºé…ç½®ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ fixture.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ init.go</span><br><span class="line">â”‚   â”‚   â””â”€â”€ mysql.go</span><br><span class="line">â”‚   â”œâ”€â”€ constantï¼ˆå¸¸é‡ã€æšä¸¾å®šä¹‰ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ enum.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ gen_enum.go</span><br><span class="line">â”‚   â”‚   â””â”€â”€ macro.go</span><br><span class="line">â”‚   â”œâ”€â”€ controllerï¼ˆå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ company.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ company_test.go</span><br><span class="line">â”‚   â”‚   â””â”€â”€ product.go</span><br><span class="line">â”‚   â”œâ”€â”€ jobï¼ˆå¼‚æ­¥ç¦»çº¿ä»»åŠ¡ä¸šåŠ¡é€»è¾‘ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ after_product_created.go</span><br><span class="line">â”‚   â”œâ”€â”€ middlewareï¼ˆå¯å¤ç”¨çš„ä¸­é—´ä»¶ï¼‰</span><br><span class="line">â”‚   â”‚   â””â”€â”€ cors.go</span><br><span class="line">â”‚   â”œâ”€â”€ modelï¼ˆModelsï¼Œå¯èƒ½è¿˜ä¼šèšåˆæ¥è‡ª RPC ç­‰æ•°æ®æºï¼Œæ•°æ®æ¨¡å‹æŠ½è±¡ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ company.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ doc.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ init.go</span><br><span class="line">â”‚   â”‚   â””â”€â”€ product.go</span><br><span class="line">â”‚   â”œâ”€â”€ utilï¼ˆå·¥å…·é›†ï¼‰</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ orderby.go</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ pic</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ rest</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ seqgen</span><br><span class="line">â”‚   â”‚   â””â”€â”€ toolkit</span><br><span class="line">â”‚   â””â”€â”€ webï¼ˆå‰å°æœåŠ¡ï¼‰</span><br><span class="line">â”‚       â”œâ”€â”€ handler</span><br><span class="line">â”‚       â”œâ”€â”€ router.go</span><br><span class="line">â”‚       â””â”€â”€ schema</span><br><span class="line">â”œâ”€â”€ scriptï¼ˆä¸€äº›è„šæœ¬æ–‡ä»¶ï¼‰</span><br><span class="line">â”‚   â””â”€â”€ 20200101</span><br><span class="line">â””â”€â”€ testdataï¼ˆå•å…ƒæµ‹è¯•æœ‰å…³æµ‹è¯•æ•°æ®ã€è¡¨ç»“æ„å®šä¹‰ï¼‰</span><br><span class="line">    â”œâ”€â”€ fixtures</span><br><span class="line">    â”‚   â”œâ”€â”€ company.yml</span><br><span class="line">    â”‚   â”œâ”€â”€ doc.yml</span><br><span class="line">    â”‚   â””â”€â”€ product.yml</span><br><span class="line">    â””â”€â”€ schema.sql</span><br></pre></td></tr></table></figure><h1 id="0x03-è¯´-Handler"><a href="#0x03-è¯´-Handler" class="headerlink" title="0x03 è¯´ Handler"></a>0x03 è¯´ Handler</h1><p>æˆ‘ä»¬å¸Œæœ› Handler å±‚çš„é€»è¾‘ä¸è¦å¤ªè¿‡å¤æ‚ï¼Œæ›¾ç»åœ¨çœ‹æŸåå°é¡¹ç›®æ—¶ï¼ŒæŸ Handler è¶³è¶³è¿‘ç™¾è¡Œä»£ç ï¼Œç³…æ‚äº†å¤§é‡çš„å­—æ®µæ ¡éªŒé€»è¾‘ã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®æ ¼å¼åŒ–é€»è¾‘ç­‰ï¼Œæåº¦å•°å—¦ï¼Œéš¾ä»¥ä¿®æ”¹å’Œç»´æŠ¤ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬ä¸å¤ªæƒ³è¦çš„ã€‚</p><p>ç†æƒ³æƒ…å†µä¸‹ï¼ŒHandler å±‚åº”è¯¥ä¿è¯è¶³å¤Ÿè½»é‡ï¼Œå®ƒå°±åº”è¯¥åƒæ˜¯èƒ¶æ°´ï¼Œè´Ÿè´£å°† Model å±‚ã€Controller å±‚ä»¥åŠ Schema å±‚ç²˜åœ¨ä¸€èµ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProducts</span><span class="params">(c *rest.Context)</span> <span class="params">(rest.Response, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. å¤æ‚é€»è¾‘ä¸‹æ²‰åˆ° Controller å±‚å®ç°</span></span><br><span class="line">    products, total, err := controller.GetProducts(</span><br><span class="line">        c.Query(<span class="string">"title"</span>),</span><br><span class="line">        c.QueryWithFallback(<span class="string">"order_by"</span>, <span class="string">"-created_at"</span>),</span><br><span class="line">        c.Offset(),</span><br><span class="line">        c.Limit(),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. Model -&gt; Schema æ¸²æŸ“</span></span><br><span class="line">    <span class="keyword">var</span> schemas []schema.OutputProductSchema</span><br><span class="line">    <span class="comment">// å€ŸåŠ© portal.Onlyï¼Œå¯ä»¥åœ¨è¯·æ±‚çš„æ—¶å€™æŒ‡å®šåªåå‡ºéœ€è¦çš„å­—æ®µå€¼</span></span><br><span class="line">     err = portal.Dump(&amp;schemas, products, portal.Only(strings.Split(c.QueryWithFallback(<span class="string">"only"</span>, <span class="string">""</span>), <span class="string">","</span>)...))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. è¿”å›ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> rest.NewPage(c, schemas, total), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateProduct</span><span class="params">(c *rest.Context)</span> <span class="params">(rest.Response, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. è¡¨å•æ ¡éªŒå’Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">var</span> input schema.InputProductSchema</span><br><span class="line">    err := c.BindJSON(&amp;input)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> product model.ProductModel</span><br><span class="line">    err = portal.Dump(&amp;product, input)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ä¸šåŠ¡é€»è¾‘å¤„ç†</span></span><br><span class="line">    prodID, err := controller.CreateProduct(&amp;product, &amp;input)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. è¿”å›å¤„ç†ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> gin.H&#123;<span class="string">"success"</span>: <span class="literal">true</span>, <span class="string">"product_id"</span>: cast.ToString(prodID)&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“æ¥çœ‹ï¼ŒHandler å±‚æ— éæ‰§è¡Œå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ˆKeep It Simple, Stupidï¼‰ï¼š</p><ol><li>è¾“å…¥å‚æ•°æ ¡éªŒå’Œå¤„ç†ï¼ˆå®é™…é€»è¾‘è¦ä¹ˆå°è£…åœ¨ Schema å±‚ï¼Œè¦ä¹ˆåœ¨æ¡†æ¶å±‚è§£å†³ï¼‰ï¼›</li><li>ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆController å±‚è´Ÿè´£ï¼‰ï¼›</li><li>ç»“æœè¿”å›ã€‚</li></ol><h1 id="0x04-è®²-Schema-ä¸-Model"><a href="#0x04-è®²-Schema-ä¸-Model" class="headerlink" title="0x04 è®² Schema ä¸ Model"></a>0x04 è®² Schema ä¸ Model</h1><p>è¿™ä¸¤ä¸ªé€‚åˆæ”¾åœ¨ä¸€èµ·è®²ï¼Œå› ä¸º Schema çš„å­—æ®µæ˜ å°„çš„æ­£æ˜¯å¯¹åº”çš„ Model ä¸­ç›¸å…³å­—æ®µã€‚ä¹Ÿè®¸è¿™é‡Œä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥åœ¨ Model å±‚ï¼Œç»™æŸä¸ª Field åŠ ä¸ª Tag <code>json: field_name</code>ï¼Œç›´æ¥åºåˆ—åŒ–è¿”å›å‡ºå»å‘¢ï¼Ÿä¸ºä½•éè¦ç”Ÿç¡¬åœ°å†™ä¸€ä¸ª Schema ç»“æ„ä½“å†åšæ˜ å°„å‘¢ï¼Ÿ</p><p>æ¥ä¸‹æ¥å°†ç»“åˆå…·ä½“çš„åœºæ™¯æ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š</p><ol><li>API è¦æ±‚è¿”å›çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®é™…ç±»å‹ä¸ä¸€è‡´ï¼ˆå¦‚ model.ID ä¸º int ç±»å‹ï¼Œä½† API è¦æ±‚è¿”å› string ç±»å‹ï¼‰ï¼›</li><li>æŸäº›å­—æ®µè¦æ±‚æ˜¯å¯é€‰è¿”å›å­—æ®µï¼ˆè¿™æ—¶å¯ä»¥è½»æ¾åœ°ä¿®æ”¹ Schema ä¸­çš„å­—æ®µä¸º <code>*type</code> å³å¯ï¼‰ã€‚</li></ol><p>æ€»ä¹‹ï¼ŒModel å±‚ä½œä¸º Source of Truthï¼Œä¿æŒæœ€åŸå§‹çš„æ ¼å¼æœ€å¥½ã€‚Schema å±‚åˆ™æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œå˜åŠ¨ï¼Œå¯¹äºä¸é€‚é…çš„åœºæ™¯ï¼Œè‡ªå®šä¹‰ format æ–¹æ³•å®Œæˆè½¬æ¢å³å¯ã€‚è¿™æ ·å¯ä»¥å°†æ”¹åŠ¨åªèšç„¦åœ¨è¾ƒå°çš„èŒƒå›´ï¼Œé¿å…åˆ°å¤„ä¿®æ”¹ç±»å‹ï¼Œæƒ³æƒ³ä¹Ÿå¿ƒç´¯ã€‚</p><p>æœ€åè¦æçš„ä¸€ç‚¹æ˜¯ Model çš„å…³è”èµ„æºï¼Œæˆ‘ä»¬æ¨èçš„å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ProductModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="keyword">int64</span></span><br><span class="line">    CompanyID <span class="keyword">int64</span></span><br><span class="line">    <span class="comment">// ... other fields ignored</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Company è¿”å›å•†å“å…³è”çš„å…¬å¸ï¼ˆæ¥æºäºåˆ«çš„è¡¨ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pd *ProductModel)</span> <span class="title">Company</span><span class="params">()</span> <span class="params">(*CompanyModel, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> company CompanyModel</span><br><span class="line">    err := DB.Where(<span class="string">"id = ?"</span>, pd.CompanyID).Find(&amp;company).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> gorm.IsRecordNotFoundError(err) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errors.WithStack(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;company, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rate è¿”å›å•†å“å…³è”çš„è¯„åˆ†ï¼ˆæ¥æºäº RPC è°ƒç”¨ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pd *ProductModel)</span> <span class="title">Rate</span><span class="params">()</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rpc.GetProductRate(pd.ID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨ Schema å±‚ï¼Œæˆ‘ä»¬åªéœ€è¦å£°æ˜éœ€è¦æ˜ å°„çš„å­—æ®µï¼Œåœ¨ç»è¿‡ <code>portal.Dump</code> æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å®Œæˆç›¸å…³å­—æ®µæ˜ å°„ï¼Œå¹¶å°†è¿”å›çš„å€¼å¡«å……åˆ°å¯¹åº”çš„ Schema å­—æ®µä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> OutputCompanySchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="keyword">string</span>           <span class="string">`json:"id"`</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OutputProductSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID            *<span class="keyword">string</span>               <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Company       *OutputCompanySchema  <span class="string">`json:"company,omitempty" portal:"nested;async"`</span></span><br><span class="line">    CreatedAt     *field.Timestamp      <span class="string">`json:"created_at,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> output OutputProductSchema</span><br><span class="line">portal.Dump(&amp;output, product)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤æ—¶å°† output json åºåˆ—åŒ–ï¼Œå°±æ˜¯æƒ³è¦å¾—åˆ°çš„ç»“æœ</span></span><br></pre></td></tr></table></figure><h1 id="0x05-ç¢ç¢å¿µ"><a href="#0x05-ç¢ç¢å¿µ" class="headerlink" title="0x05 ç¢ç¢å¿µ"></a>0x05 ç¢ç¢å¿µ</h1><p>æœ€è¿‘å‡ å¤©åœ¨å°è¯•é‡æ„æŸä¸ªé¡¹ç›®çš„æŸä¸ªå·¨é•¿çš„å‡½æ•°ï¼ˆæ¥è¿‘ 250 è¡Œï¼Œä»£ç å°±ä¸è´´äº†ï¼Œæ€•è¢«æ‰“ ğŸ˜ï¼‰ï¼Œæ¯æ¬¡ä¿®æ”¹å®ƒçš„æ—¶å€™å¿ƒæ€éƒ½è¦å´©ã€‚ä½†è¯´èµ·æ¥ï¼Œå®ƒä¹Ÿæ²¡æœ‰å¤šä¹ˆå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯äº§å“çº¿ç±»å‹è¾ƒå¤šï¼Œç³…æ‚äº†èµ„æºè·å–é€»è¾‘ã€å­—æ®µæ ¼å¼åŒ–é€»è¾‘ç­‰ç­‰ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ä¸Šè¿°çš„ Model &amp; Schema åˆ†å±‚æ€è·¯è¿›è¡Œé‡æ„ï¼Œä½†æ˜¯è¯¥å‡½æ•°åšäº†äº›ä¼˜åŒ–ï¼š</p><ol><li>ä½¿ç”¨ <code>batch_get_resource</code> æ¥å£æ›¿ä»£ <code>get_resource</code> æ¥å£ï¼›</li><li>å¹¶å‘è·å–å¤šä¸ªäº§å“çº¿çš„ç« èŠ‚ä¿¡æ¯ç­‰ã€‚</li></ol><p>å› ä¸ºè¿™ç§ä¼˜åŒ–çš„å¼•å…¥ï¼Œä¼šå¯¼è‡´ä¸Šè¿°å†™æ³•ä¸Šå­˜åœ¨ä¸€äº›ä¸å¤ªä¼˜é›…çš„åœ°æ–¹ã€‚æ¥ä¸‹æ¥ä¸¾ä¸ªæ —å­ğŸŒ°èƒ½å¤Ÿæ›´å¥½åœ°è¯´æ˜ç°åœ¨é‡åˆ°çš„é—®é¢˜ï¼š</p><p>å…ˆçœ‹çœ‹å¸¸è§„çš„ StudentModel &amp; StudentSchema å®šä¹‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StudentModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    MemberID <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Member è¿”å›å…³è”çš„è´¦å·è¯¦æƒ…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StudentModel)</span> <span class="title">Member</span><span class="params">(ctx context.Member)</span> *<span class="title">rpc</span>.<span class="title">Member</span></span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å•æ¬¡è°ƒç”¨ï¼Œè€Œéæ‰¹é‡è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> rpc.GetMemberByID(s.MemberID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MemberSchema <span class="keyword">struct</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StudentSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    Member *MemberSchema <span class="string">`portal: nested`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¸€é¡µéœ€è¦è·å– 20 ä¸ªå­¦ç”Ÿä¿¡æ¯ï¼Œportal åºåˆ—åŒ–æ—¶ï¼Œä¼šé»˜è®¤å¯åŠ¨ 20 ä¸ª goroutine åˆ†åˆ«å¤„ç† 20 ä¸ª StudentSchema çš„æ¸²æŸ“ã€‚è¿™æ ·çš„è¯ï¼Œå…·ä½“åˆ° StudentModel.Member è·å–æ—¶ï¼Œå°±ä¼šäº§ç”Ÿ 20 ä¸ªå¹¶å‘çš„ <code>GetMemberByID</code> è¯·æ±‚ï¼Œç›¸å¯¹ä¸²è¡Œæ‰§è¡Œï¼Œè¿™ç§æ–¹å¼è‡ªç„¶å¯ä»¥æé«˜é€Ÿåº¦ã€‚ä½†æ˜¯ä»£ä»·ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§ç”Ÿçš„è¯·æ±‚è¾ƒå¤šã€‚å¯¹äºä¸€äº›åå°é¡¹ç›®è¿™æ ·åšè¿˜å¥½ï¼Œä½†æ˜¯å¯¹äº C ç«¯æ¥å£ï¼Œå¦‚æœè¯·æ±‚é‡è¾ƒé«˜ï¼Œé‚£è¯·æ±‚æ”¾å¤§ä¼šæ¯”è¾ƒä¸¥é‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">students := DBGetStudents(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> output []StudentSchema</span><br><span class="line">portal.Dump(&amp;output, students)</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¸Šæ¸¸ä¸ºæˆ‘ä»¬æä¾›äº†ç±»ä¼¼ <code>func BatchGetMemberByID(memberIDs []int64) map[int64]*Member</code> æ–¹æ³•ï¼Œé‚£ä¹ˆä»¬å¯ä»¥é€šè¿‡æ‰¹é‡è°ƒç”¨çš„æ–¹å¼è§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åŒæ—¶ä¿®æ”¹åŸæœ‰çš„ Model å±‚å’Œ Schema å±‚å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StudentModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    MemberID <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StudentSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    Member *MemberSchema <span class="string">`portal: nested`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StudentSchema)</span> <span class="title">GetMember</span><span class="params">(ctx context.Context, student *StudentModel)</span> *<span class="title">rpc</span>.<span class="title">Member</span></span> &#123;</span><br><span class="line">    <span class="comment">// å‡è®¾å¤–å±‚æ‰¹é‡è°ƒç”¨ç»“æœæ”¾åœ¨ ctx ä¸­ä¼ å…¥</span></span><br><span class="line">    v := ctx.Value(<span class="string">"members"</span>).(<span class="keyword">map</span>[<span class="keyword">int64</span>]*rpc.Member)</span><br><span class="line">    <span class="keyword">return</span> v[student.MemberID]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Handler å±‚ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>BatchGetMemberByID</code> æ¥å£ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">students := DBGetStudents(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¶é›† member_ids</span></span><br><span class="line">memberIDs := <span class="built_in">make</span>([]<span class="keyword">int64</span>, <span class="built_in">len</span>(students))</span><br><span class="line"><span class="keyword">for</span> i, s := <span class="keyword">range</span> students &#123;</span><br><span class="line">    memberIDs[i] = s.MemberID</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">members := rpc.BatchGetMemberByID(memberIDs)</span><br><span class="line">ctx = context.WithValue(<span class="string">"members"</span>, members)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> output []StudentSchema</span><br><span class="line">portal.DumpWithContext(ctx, &amp;output, students)</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œä¼¼ä¹çœ‹èµ·æ¥å¹¶æ²¡æœ‰å¤šä¹ˆç¹çå˜›ã€‚ä¸è¿‡è¿™æ ·çš„å†™æ³•å¾ˆå®¹æ˜“å¯¼è‡´ Handler å±‚è†¨èƒ€ï¼Œè¯•æƒ³å†åŠ ç‚¹åˆ«çš„å…³è”èµ„æºè·å–å‘¢ï¼Ÿé‚£å„ç§ <code>BatchGetShit</code> å°±æ€¼è¿›å»äº†ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½åšåˆ°åŸæœ‰çš„ Model å±‚ä¾ç„¶ä¿æŒç®€å•çš„ <code>rpc.GetResourceByID</code> è¿™ç§ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼›Schema å±‚ä¹Ÿä¸ç”¨åšä¾µå…¥å¼ä¿®æ”¹ï¼›Handler å±‚æ›´ä¸ç”¨å¿å—å¯èƒ½å¯¼è‡´çš„ä»£ç è†¨èƒ€é—®é¢˜å‘¢ï¼Ÿä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥å¯¹ <code>rpc.GetResourceByID</code> åšç‚¹åŒ…è£…ï¼Œåœ¨åº•å±‚æ¡†æ¶ä¸Šï¼Œè‡ªåŠ¨æ”¯æŒè¯·æ±‚åˆå¹¶ï¼›è€Œå¯¹äºä¸Šå±‚è°ƒç”¨æ–¹æ— æ„ŸçŸ¥ã€‚</p><p>ç†Ÿæ‚‰ HTTP/2 çš„åŒå­¦åº”è¯¥äº†è§£åˆ°å…¶ä¸­ä¸€ä¸ªç‰¹è‰²æ˜¯å¤šè·¯å¤ç”¨ï¼Œé¿å…æ¯æ¬¡æ–°çš„è¯·æ±‚éƒ½è¦è¿›è¡Œ TCP+TLS æ¡æ‰‹ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåšåˆ°åœ¨åº•å±‚å°†ä¸Šå±‚çš„ <code>rpc.GetResourceByID</code> è‡ªåŠ¨åˆå¹¶ä¸º <code>rpc.BatchGetResourceByID</code>ï¼Œä¹Ÿèƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜è¯·æ±‚æ•ˆç‡ï¼Œå‡å°‘ä¸Šæ¸¸æœåŠ¡çš„è¯·æ±‚å‹åŠ›ã€‚è™½ç„¶ç›¸å¯¹äºå¹¶å‘ 20 ä¸ª <code>rpc.GetResourceByID</code> è¯·æ±‚ï¼Œè‡ªåŠ¨åˆå¹¶æŠ€æœ¯å¯èƒ½å› ä¸ºä¼˜åŒ–ä¸åˆ°ä½æˆ–è€…ç­–ç•¥ä¸Šçš„é—®é¢˜ï¼Œå“åº”æ—¶é—´å¯èƒ½ç¨é•¿ï¼Œä½†æ˜¯ç›¸å¯¹äºä¸²è¡Œè°ƒç”¨ï¼Œé€Ÿåº¦ç†è®ºä¸Šä¼šæœ‰å¾ˆå¤§æå‡ã€‚</p><p><img src="https://camo.githubusercontent.com/878e48b845b8e24e870c9ecd4642b0ae2ddd5dd0/68747470733a2f2f706963332e7a68696d672e636f6d2f76322d37303061333265333865316465303361633639393732343138303462356136622e706e67" alt=""></p><p>å…³äºè¿™ä¸ªè¯·æ±‚åˆå¹¶çš„ç­–ç•¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå¯ä»¥æƒ³è±¡ä¸‹ <code>rpc.BatchGetResourceByID</code> å°±åƒä¸€è¾†å¾€è¿”äºä¸¤åœ°çš„å…¬å…±æ±½è½¦ï¼Œå‡è®¾å®ƒæœ‰ä¸¤ä¸ªå…³é”®å±æ€§ï¼š</p><ol><li>è½¦ä¸Šä¹˜å®¢ä¸€æ—¦åæ»¡ç«‹åˆ»å‡ºå‘ï¼ˆä¸è®¸åŠ å¡ï¼Œå’±ä»¬è¦åˆæ³•ç»è¥ï¼‰ï¼›</li><li>åˆ°è¾¾ä¸€å®šè¶…æ—¶æ—¶é—´ç«‹åˆ»å‡ºå‘ï¼ˆå®ˆæ—¶å¾ˆé‡è¦ï¼Œä¿è¯æœåŠ¡è´¨é‡ï¼‰ï¼›</li><li>åˆ°è¾¾ç›®çš„åœ°åï¼Œè¿˜è¦åœ¨è¿”ç¨‹æ—¶å°†åŒä¸€æ‰¹ä¹˜å®¢å°½å¯èƒ½å…¨éƒ¨å¸¦å›æ¥ï¼ˆå‡è®¾ä¹˜å®¢ä»¬è¦ä¹ˆä¹°åˆ°äº†æƒ³è¦çš„ç¤¼ç‰© <code>result</code> æˆ–è€…åƒç¬”è€…ä¸€æ ·æ¯”è¾ƒç©·å°±ä»€ä¹ˆä¹Ÿæ²¡ä¹° <code>error</code>ï¼‰ã€‚</li></ol><p>åŸºäºè¿™æ ·çš„å‡è®¾ï¼Œå°è¯•ä½¿ç”¨ Go è¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„ Demoï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‰å¾€ä»“åº“ <a href="https://github.com/iFaceless/rpcx" target="_blank" rel="noopener">rpcx</a> æŸ¥çœ‹ã€‚å°è¯•å¼•å…¥äº†ä¸€ä¸ª Proxy å±‚ï¼Œç”± Proxy å±‚æ”¶é›†ä¸šåŠ¡æ–¹çš„è°ƒç”¨å‚æ•°ï¼Œå¹¶æ‰¹é‡å‘èµ·è°ƒç”¨ï¼Œæœ€åå°†ç»“æœåˆ†æ´¾ç»™ä¸šåŠ¡æ–¹ã€‚å½“ç„¶ï¼Œç›®å‰ Proxy æ˜¯ä»¥ä¸€ä¸ªå•ç‹¬çš„ goroutine éƒ¨ç½²ï¼›ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœèƒ½ç”¨ sidecar æ–¹å¼éƒ¨ç½²ï¼Œç”šè‡³å¯ä»¥åšåˆ°è¯­è¨€æ— å…³ï¼Œç‹¬ç«‹å‡çº§ï¼Œå…¶å®ƒè¯­è¨€å®ç°çš„æœåŠ¡ä¹Ÿå¯ä»¥äº«å—åˆ°åŒæ ·çš„ä¼˜åŒ–ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line">    rsdk.Init(<span class="number">10</span>, <span class="number">1</span>*time.Millisecond)</span><br><span class="line">    getMembersAutoAgg(ctx, <span class="number">20</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMembersAutoAgg</span><span class="params">(ctx context.Context, max <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= max; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">// åº•å±‚è‡ªåŠ¨å°†å¹¶å‘å•æ¬¡è°ƒç”¨è½¬æ¢æˆæ‰¹é‡è°ƒç”¨</span></span><br><span class="line">         <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">            r, err := rsdk.GetMember(ctx, <span class="keyword">int64</span>(n)+<span class="number">1</span>)</span><br><span class="line">            _, _ = r, err</span><br><span class="line">            wg.Done()</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæƒ³è¦åœ¨ç”Ÿäº§ç¯å¢ƒæäº‹æƒ…ï¼Œè¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ã€‚æ¯”å¦‚ Proxy ç›‘æ§æ€ä¹ˆåšï¼Ÿå•ç‚¹é—®é¢˜æ€ä¹ˆè§£è§£å†³ï¼Ÿæ˜¯å¦ä¼šæˆä¸ºæ¥å£è°ƒç”¨ç“¶é¢ˆï¼Ÿå¦‚ä½•ä¸å…¬å¸ç°æœ‰çš„ RPC æ¡†æ¶ç»“åˆï¼Ÿæ”¶ç›Šæ˜¯å¦çœŸçš„è¾¾åˆ°é¢„æœŸï¼ˆåˆ†æå…·ä½“åœºæ™¯ï¼‰ï¼Ÿ</p><h1 id="0x06-æ€»ç»“"><a href="#0x06-æ€»ç»“" class="headerlink" title="0x06 æ€»ç»“"></a>0x06 æ€»ç»“</h1><p>ä»¥ä¸Šåˆ†äº«äº†ä¸€äº›å…³äºå·¥ç¨‹å®è·µæ–¹é¢çš„æ€è€ƒï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œæœ‰ä»€ä¹ˆå¥½çš„æƒ³æ³•ä¹Ÿæ¬¢è¿ç•™è¨€äº¤æµ~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;0x00-å¼•è¨€&quot;&gt;&lt;a href=&quot;#0x00-å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;0x00 å¼•è¨€&quot;&gt;&lt;/a&gt;0x00 å¼•è¨€&lt;/h1&gt;&lt;p&gt;ç–«æƒ…æœŸé—´å­¦çš„ä¸œè¥¿æ¯”è¾ƒæ‚ï¼ˆæ¯”å¦‚å­¦ä¹ äº†å¦‚ä½•åœ¨å¸‚åœºè¡Œæƒ…ä¸å¥½çš„æ—¶å€™è¿˜ç›²ç›®åŠ ä»“ ğŸ™‚ï¼‰ï¼Œæ²¡ä»€ä¹ˆå¹²è´§å€¼å¾—åˆ†äº«ã€‚ä¸
      
    
    </summary>
    
      <category term="Go" scheme="/categories/Go/"/>
    
    
      <category term="Go" scheme="/tags/Go/"/>
    
      <category term="RESTful" scheme="/tags/RESTful/"/>
    
  </entry>
  
  <entry>
    <title>Rust async-std å…¥é—¨</title>
    <link href="/2020/01/20/rust-async-std-intro/"/>
    <id>/2020/01/20/rust-async-std-intro/</id>
    <published>2020-01-20T10:00:40.000Z</published>
    <updated>2020-01-21T03:45:37.518Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æ‰“ç®—åŸºäº Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust <a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚</p><p><a href="https://github.com/async-rs/async-std" target="_blank" rel="noopener">async-std</a> æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ <code>async-std</code> ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª <code>task</code> æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ <code>thread</code> æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ <code>async/await</code> é£æ ¼çš„ <code>Mutex</code> åŸè¯­ã€‚</p><a id="more"></a><p>Rust ä¸­æœ‰ä¸¤ç§ç±»å‹çš„ <code>Future</code>ï¼š</p><ol><li>æºè‡ª<a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">æ ‡å‡†åº“</a>çš„ <code>std::future::Future</code></li><li>æºè‡ª <a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  çš„ <code>futures::future::Future</code></li></ol><p>èƒŒæ™¯æ˜¯è¿™æ ·çš„ï¼Œ<a href="https://docs.rs/futures/0.3/futures/prelude/trait.Future.html" target="_blank" rel="noopener">futures-rs crate</a>  ä¸­å®šä¹‰çš„ future æ˜¯ Future ç±»å‹æœ€åˆçš„å®ç°ã€‚Rust ä¸ºäº†æ”¯æŒ <code>async/await</code> è¯­æ³•ï¼Œå°±æŠŠæ ¸å¿ƒçš„ <code>trait Future</code> è½¬ç§»åˆ°äº†æ ‡å‡†åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨çš„ <code>std::future::Future</code>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>std::future::Future</code> çœ‹ä½œæ˜¯ <code>futures::future::Future</code> çš„æœ€å°å­é›†ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä¸¥æ ¼åŒºåˆ† <code>std::future::Future</code> å’Œ <code>futures::future::Future</code>ï¼Œä»¥åŠ <code>async-std</code> æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„ã€‚æ€»çš„æ¥è¯´ï¼Œæ™®é€šçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯ä¸ä¼šå’Œ <code>std::future::Future</code> æ‰“äº¤é“çš„ï¼ˆé™¤äº†ä½¿ç”¨ <code>.await</code> è°ƒç”¨ï¼‰ã€‚é€šå¸¸åªæœ‰å®ç° <code>Future</code> çš„å¼€å‘è€…æ‰ä¼šå…³æ³¨ <code>std::future::Future</code> çš„å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚è¿‡å»å¾ˆå¤šåœ¨ <code>Future</code> ä¸­å®šä¹‰çš„åŠŸèƒ½éƒ½è¢«ç§»åŠ¨åˆ°äº† <code>FuturesExt</code> æ‰©å±• trait ä¸­ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† <code>futures</code> åº“å½“ä½œæ˜¯æ ¸å¿ƒ Rust å¼‚æ­¥åŠŸèƒ½çš„æ‰©å±•ã€‚</p><p>é‚£ä¹ˆï¼Œä¸Šé¢ä¸€ç›´æåˆ°çš„ Futures ç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿåˆæ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œ<strong>Futures å°±æ˜¯å¯¹äºä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ä¸€ç§æŠ½è±¡</strong>ï¼Œå®ƒä»¬å…¶å®ä»€ä¹ˆä¹Ÿä¸åšã€‚é‚£ä¹ˆæ€ä¹ˆæ¨è¿›æ‰§è¡Œå¹¶è·å¾—ç»“æœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é æ‰§è¡Œå™¨ <code>executor</code>ï¼Œå®ƒä¼šå†³å®š<strong>ä½•æ—¶</strong>åŠ<strong>å¦‚ä½•</strong>æ‰§è¡Œä½ çš„ Futuresã€‚<code>async-std::task</code> æ¨¡å—å°±ä¸ºæˆ‘ä»¬æä¾›äº†è¿™æ ·çš„æ‰§è¡Œå™¨æ¥å£ã€‚</p><h1 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h1><p>Rust æœ‰ä¸ªéå¸¸äº®çœ¼çš„ç‰¹æ€§å«<a href="https://blog.rust-lang.org/2015/04/10/Fearless-Concurrency.html" target="_blank" rel="noopener">ã€Œæ— è°“å¹¶å‘ã€</a>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨è·å¾—å¹¶å‘ç‰¹æ€§çš„åŒæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰çš„é—®é¢˜ï¼ˆç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥åˆ°æ•°æ®ç«äº‰çš„é—®é¢˜ï¼‰ã€‚</p><p>Futures æ˜¯å¯¹<strong>è®¡ç®—</strong>çš„æŠ½è±¡ï¼Œå®ƒä»¬æè¿°äº†ã€Œåšä»€ä¹ˆï¼ˆwhatï¼‰ã€ï¼Œä½†æ˜¯ä¸ã€Œåœ¨å“ªå„¿ï¼ˆwhereï¼‰ã€ã€ã€Œä»€ä¹ˆæ—¶å€™ï¼ˆwhenï¼‰ã€æ‰§è¡Œæ˜¯åˆ†å¼€çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ä»£ç æ‰“æ•£æˆå°æ®µçš„ã€å¯ç»„åˆçš„è¡Œä¸ºï¼Œè¿™æ ·å¯ä»¥ä½œä¸ºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ‰§è¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯<strong>è®¡ç®—</strong>ï¼ˆcompute thingsï¼‰ï¼Œå¹¶æ‰¾åˆ°å¯ä»¥æŠ½è±¡çš„åœ°æ–¹ã€‚</p><h2 id="Send-å’Œ-Sync"><a href="#Send-å’Œ-Sync" class="headerlink" title="Send å’Œ Sync"></a>Send å’Œ Sync</h2><p>Rust å®‰å…¨å¹¶å‘ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æŠ½è±¡ï¼ˆMarkersï¼‰ï¼š<code>Send</code> å’Œ <code>Sync</code>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ç®€å•çš„ä»‹ç»ï¼š</p><ul><li><code>Send</code> æ ‡è®°çš„æ•°æ®ç±»å‹æ˜¯å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªè®¡ç®—ï¼ˆcomputationï¼‰<strong>è½¬ç§»åˆ°ï¼ˆmovedï¼‰</strong>å¦å¤–ä¸€ä¸ªå¹¶å‘è®¡ç®—ï¼ˆæ‰€æœ‰æƒä¹ŸåŒæ ·è¢«è½¬ç§»äº†ï¼Œå‘é€æ–¹å°†ä¸èƒ½å†è®¿é—®å®ƒï¼‰ã€‚</li><li><code>Sync</code> æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥åœ¨å¹¶å‘ç¯å¢ƒä¸­<strong>å…±äº«ï¼ˆsharingï¼‰</strong>æ•°æ®ã€‚</li></ul><p>ä»¥ä¸Šæ²¡æœ‰ä½¿ç”¨ <code>thread</code> å³çº¿ç¨‹è¿™æ ·çš„å­—çœ¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†æŠ½è±¡çš„ <code>computation</code>ã€‚<code>Send</code> å’Œ <code>Sync</code> æœ€å¼ºå¤§çš„ç‰¹ç‚¹åœ¨äºå®ƒä¸ºæˆ‘ä»¬å‡è½»äº†çŸ¥é“å…±äº«ä»€ä¹ˆçš„è´Ÿæ‹…ã€‚åœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¯¹äºç›¸åº”çš„æ•°æ®ç±»å‹é‡‡ç”¨ä»€ä¹ˆåˆ†äº«æ–¹å¼å³å¯ã€‚</p><p>å…³äº <code>Send</code> å’Œ <code>Sync</code> çš„ç»„åˆè¿˜æœ‰æ›´å¤šæœ‰è¶£çš„ç‰¹æ€§ï¼Œå¯ä»¥å‚è€ƒ <a href="https://doc.rust-lang.org/stable/book/ch16-04-extensible-concurrency-sync-and-send.html" target="_blank" rel="noopener">Rust Book</a> äº†è§£æ›´å¤šã€‚</p><h2 id="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"><a href="#ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰" class="headerlink" title="ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰"></a>ä»€ä¹ˆæ˜¯è®¡ç®—ï¼ˆcomputationï¼‰</h2><p>æ‰€è°“çš„è®¡ç®—ï¼ˆcomputationï¼‰æ˜¯æŒ‡ä¸€ä¸ªå¯ç»„åˆçš„æ“ä½œåºåˆ—ï¼Œå¯ä»¥åŸºäºå†³ç­–åˆ†æ”¯ï¼Œå¯ä»¥ä¸€ç›´æ¨è¿›è¿è¡Œåˆ°ç»“æŸï¼Œæœ€ç»ˆè¿”å›ç»“æœæˆ–è€…é”™è¯¯ã€‚</p><h2 id="å»¶è¿Ÿè®¡ç®—"><a href="#å»¶è¿Ÿè®¡ç®—" class="headerlink" title="å»¶è¿Ÿè®¡ç®—"></a>å»¶è¿Ÿè®¡ç®—</h2><p>å¦‚ä¸Šæ‰€è¿°ï¼Œ<code>Send</code> å’Œ <code>Sync</code> éƒ½æ˜¯æè¿°æ•°æ®çš„ï¼›ä½†åº”ç”¨ç¨‹åºå¯ä¸æ­¢æ•°æ®ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“å¦‚ä½•è®¡ç®—å‡ºæ•°æ®ï¼Œç”±æ­¤å¼•å…¥äº† <code>Futures</code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>Futures</code> æ˜¯æ€ä¹ˆå…è®¸æˆ‘ä»¬ç”¨è‡ªç„¶è¯­è¨€è¡¨è¾¾è¦åšçš„äº‹æƒ…çš„ï¼Œ<code>Futures</code> ä»è¿™æ ·çš„è®¡åˆ’ï¼š</p><ul><li>Do X</li><li>If X succeeded, do Y</li></ul><p>å˜æˆäº†ï¼š</p><ul><li>Start doing X</li><li>Once X succeeds, start doing Y</li></ul><p>ç›¸æ¯”äºå‘Šè¯‰è®¡ç®—æœºè¦åšä»€ä¹ˆï¼Œå¹¶ä¸”æ ¹æ®å½“å‰ç»“æœå†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼›å»¶è¿Ÿè®¡ç®—å°±æ˜¯è®©æˆ‘ä»¬å‘Šè¯‰è®¡ç®—æœºè¦å¼€å§‹åšä»€ä¹ˆï¼Œå¹¶å“åº”<strong>æœªæ¥</strong>å¯èƒ½å‘ç”Ÿçš„äº‹ä»¶ã€‚</p><h2 id="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"><a href="#ä»ç®€å•çš„ä¾‹å­å¼€å§‹" class="headerlink" title="ä»ç®€å•çš„ä¾‹å­å¼€å§‹"></a>ä»ç®€å•çš„ä¾‹å­å¼€å§‹</h2><p>ä¸‹é¢çš„ä¾‹å­æ˜¯ä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents)?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œä¹Ÿå¾ˆç›´è§‚ã€‚é—®é¢˜æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œæ§åˆ¶æƒå°±ä¼šè½¬ç§»è‡³è¢«è°ƒç”¨çš„å‡½æ•°ç›´åˆ°å…¶è¿”å›ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸Šè¿°è¿”å›å€¼æè¿°çš„æ˜¯è¿‡å»ã€‚è€Œè¿‡å»å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæ‰€æœ‰çš„å†³ç­–éƒ½å·²ç»ç¡®å®šäº†ã€‚ä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜ç‚¹ï¼šè¿”å›çš„ç»“æœå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ç¨‹åºè¿‡å»è®¡ç®—çš„ç»“æœè§£åŒ…ï¼ˆunwrapï¼‰å‡ºæ¥ï¼Œç„¶åå†³å®šå¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><p>ä½†æˆ‘ä»¬è¿˜æ˜¯æƒ³è¦æŠ½è±¡è®¡ç®—ï¼Œå¹¶è®©åˆ«äººé€‰æ‹©å¦‚ä½•è¿è¡Œå®ƒã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ç±»å‹ï¼Œå¯ä»¥æè¿°è®¡ç®—è¿‡ç¨‹ï¼Œä½†æ˜¯åˆä¸æ‰§è¡Œå®ƒã€‚ğŸ‘† ä¸Šé¢çš„å‡½æ•°åªèƒ½è®©æˆ‘ä»¬åœ¨è°ƒç”¨å‰æˆ–è€…è°ƒç”¨åæ‰§è¡Œæ“ä½œã€‚è¿™å…¶å®å¹¶éé¢„æœŸçš„ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨åœ¨è¿è¡Œçš„æ—¶å€™åšç‚¹åˆ«çš„äº‹æƒ…ï¼ˆå®é™…ä¸Šå°±æ˜¯èƒ½å¤Ÿæ‰“æ–­æ‰§è¡Œæµï¼‰ã€‚å½“åœ¨å¹¶è¡Œç¼–ç¨‹æ—¶ï¼Œè¿™ä¹Ÿå‰¥å¤ºäº†æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡è¿è¡Œæ—¶å¯åŠ¨å¦å¤–ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡çš„èƒ½åŠ›ï¼ˆè¿™æ—¶æ§åˆ¶æƒå·²ç»è½¬ç§»ç»™æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°äº†ï¼‰ã€‚</p><p>æ­¤å¤„è™½ç„¶å¯ä»¥å¼•å…¥çº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹æœ¬èº«æ˜¯éå¸¸ç‰¹å®šçš„å¹¶å‘åŸè¯­ï¼Œè€Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾çš„æ˜¯ä¸€ç§<strong>æŠ½è±¡</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ ·çš„æŠ½è±¡å°±æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªè¿›è¡Œä¸­çš„å·¥ä½œï¼Œä¼šåœ¨æœªæ¥äº§ç”Ÿç»“æœã€‚ä¸‹é¢çœ‹çœ‹éå®Œæ•´å®šä¹‰çš„ <code>Future</code> traitï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Future</span></span> &#123;</span><br><span class="line">    <span class="comment">// Ouput æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œè¡¨ç¤ºè¾“å‡ºç»“æœçš„æ³›å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span>;</span><br><span class="line">    <span class="comment">// poll æ–¹æ³•ä¼šè¿”å›å½“å‰è®¡ç®—çš„çŠ¶æ€ï¼Œpoll æ–¹æ³•ä¼šè¿”å›ä¸¤ç§ç»“æœï¼š</span></span><br><span class="line">    <span class="comment">// 1. `Poll::Ready`ï¼Œè¡¨ç¤ºè®¡ç®—ç»“æŸ</span></span><br><span class="line">    <span class="comment">// 2. `Poll::Pending`ï¼Œè¡¨ç¤ºè®¡ç®—å°šæœªç»“æŸ</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context) -&gt; Poll&lt;Self::Output&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>poll()</code> æ–¹æ³•æ£€æŸ¥ <code>Future</code> æ˜¯å¦å®Œæˆï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™è¿”å›å¯¹åº”çš„ç»“æœã€‚æ˜¾ç„¶ï¼Œæœ€ç®€å•çš„æœºåˆ¶å°±æ˜¯åœ¨å¾ªç¯ä¸­ä¸æ–­è½®è¯¢ï¼›ä¸è¿‡æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æˆç†Ÿçš„ runtime æ¥æ‰§è¡Œã€‚<em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>poll()</code> è¿”å› <code>Poll::Ready</code> åï¼Œç»§ç»­è°ƒç”¨å¯èƒ½ä¼šæœ‰ä»¤äººå›°æƒ‘çš„è¡Œä¸ºäº§ç”Ÿï¼Œå…·ä½“å¯ä»¥å‚è§ <a href="https://doc.rust-lang.org/std/future/trait.Future.html" target="_blank" rel="noopener">futures-docs</a></em>ã€‚</p><h2 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h2><p>å®é™…ä¸Š <code>Future</code> åœ¨ Rust ä¸­å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´äº†ï¼Œåªæ˜¯ç›´æ¥æ„å»ºå’Œæè¿°å®ƒä»¬æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œ<code>async</code> å…³é”®è¯å°±æ˜¯æˆ‘ä»¬çš„æ•‘æ˜Ÿï¼Œä¸‹é¢çš„ä¾‹å­ä¸­æ¼”ç¤ºäº† <code>async-std</code> æ­é… <code>async/await</code> é‡æ„ä¸Šé¢çš„å‡½æ•°ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async æ ‡è®°å‡½æ•°ä½“æ˜¯ä¸€ä¸ªå»¶è¿Ÿè®¡ç®—å¯¹è±¡ï¼Œå½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª `Future&lt;Output = io::Result&lt;string&gt;&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">// è¯¥å€¼å¹¶éç«‹å³è¿”å›çš„ç»“æœ `io::Result&lt;String&gt;`ï¼Œ</span></span><br><span class="line"><span class="comment">//ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯äº§ç”Ÿäº†å®ç°äº† `Future&lt;Output = io::Result&lt;String&gt;&gt;` çš„ç±»å‹ï¼‰ã€‚</span></span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="await-å¹²äº†ä»€ä¹ˆ"><a href="#await-å¹²äº†ä»€ä¹ˆ" class="headerlink" title=".await å¹²äº†ä»€ä¹ˆ"></a><code>.await</code> å¹²äº†ä»€ä¹ˆ</h2><p>é¡¾åæ€ä¹‰ï¼Œ<code>.await</code> è¡¨ç¤ºç­‰å¾…è¯·æ±‚è¡Œä¸ºï¼ˆrequested actionï¼‰ç›´åˆ°å®Œæˆï¼Œç„¶åæ‰ä¼šç»§ç»­åç»­çš„æ‰§è¡Œã€‚å‡†ç¡®çš„æ¥è¯´ï¼Œ<code>.await</code> æ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºæ­¤å¤„çš„ä»£ç å°†ä¼šç­‰å¾…ç›´åˆ° <code>Future</code> äº§ç”Ÿç»“æœã€‚è‡³äº Future æ˜¯æ€ä¹ˆç»“æŸçš„ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚<code>.await</code> ä¼šè®©è¿è¡Œæ—¶æŒæ§è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œè‡³äºåœ¨è®¡ç®—ç»“æŸæ—¶è¦æ‰§è¡Œå“ªäº›æ“ä½œéƒ½ç”±è¿è¡Œæ—¶æ¥æ“å¿ƒã€‚å½“ä½ ç¼–å†™çš„æ“ä½œåœ¨åå°å®Œæˆæ—¶ï¼Œå®ƒä¼šå›åˆ°æ ‡è®°ç‚¹ï¼Œç»§ç»­åç»­çš„æ“ä½œã€‚æ‰€ä»¥è¿™ç§æ¨¡å¼ä¹Ÿç§°ä¸º <strong>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆevented programmingï¼‰</strong>ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç­‰å¾…æŸäº›äº‹ä»¶å‘ç”Ÿï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶ï¼‰ï¼Œå¹¶æ®æ­¤ä½œå‡ºå“åº”ï¼ˆæ¯”å¦‚å¼€å§‹è¯»å–å†…å®¹ï¼‰ã€‚</p><p>å½“æœ‰ 2 ä¸ªåŠä»¥ä¸Šè¿™æ ·çš„å‡½æ•°åœ¨åŒæ—¶è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„è¿è¡Œæ—¶ç³»ç»Ÿå°±èƒ½å¤Ÿå¤„ç†å½“å‰æ‰€æœ‰è¿›è¡Œçš„äº‹ä»¶äº†ï¼Œé¿å…äº†å‚»å‚»åœ°ç­‰å¾…ã€‚</p><h1 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h1><p>æˆ‘ä»¬å·²ç»çŸ¥é“ä»€ä¹ˆæ˜¯ Futures äº†ï¼Œé‚£å…·ä½“æ€ä¹ˆè¿è¡Œå®ƒä»¬å‘¢ï¼Ÿè¿™å°±æ˜¯æ¥ä¸‹æ¥è¦ä»‹ç»çš„ <code>tasks</code> æ¨¡å—è¦åšçš„äº‹æƒ…ã€‚ä¸‹é¢çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::&#123;fs::File, io, prelude::*, task&#125;;</span><br><span class="line">async <span class="function"><span class="keyword">fn</span> <span class="title">read_file</span></span>(path: &amp;<span class="built_in">str</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> file: File = File::open(path).await?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> contents = <span class="built_in">String</span>::new();</span><br><span class="line">    file.read_to_string(&amp;<span class="keyword">mut</span> contents).await?;</span><br><span class="line">    <span class="literal">Ok</span>(contents)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// `spawn` æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `Future`ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œå®ƒã€‚</span></span><br><span class="line">    <span class="comment">// è¯¥å‡½æ•°ä¼šè¿”å› `JoinHanle`ã€‚</span></span><br><span class="line">    <span class="keyword">let</span> reader_task = task::spawn(async &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å—ï¼Œå¿…é¡»è¦ä½¿ç”¨å¼‚æ­¥å—æ‰èƒ½è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼ŒåŒæ—¶</span></span><br><span class="line">        <span class="comment">// ä¹Ÿä¼šå¼•å¯¼ç¼–è¯‘å™¨å°†æ‰€æœ‰ç›¸å…³çš„æŒ‡ä»¤åŒ…å«è¿›æ¥ã€‚Rust ä¸­æ‰€æœ‰çš„å—</span></span><br><span class="line">        <span class="comment">// éƒ½ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œ `async` å—åˆ™è¿”å›çš„æ˜¯ç±»å‹ä¸º </span></span><br><span class="line">        <span class="comment">// `Future` çš„å€¼</span></span><br><span class="line">        <span class="keyword">let</span> result = read_file(<span class="string">"data.csv"</span>).await;</span><br><span class="line">        <span class="keyword">match</span> result &#123;</span><br><span class="line">            <span class="literal">Ok</span>(s) =&gt; <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, s),</span><br><span class="line">            <span class="literal">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">"Error reading &#123;:?&#125;"</span>, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Started task!"</span>);</span><br><span class="line">    task::block_on(reader_task);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Stopped task!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Rust çš„ Futures æœ‰æ—¶ä¹Ÿå«ã€Œå†·ï¼ˆcoldï¼‰ã€Futuresï¼Œä½ éœ€è¦è¿è¡Œå®ƒä»¬çš„ä¸œè¥¿ã€‚ä¸ºäº†è¿è¡Œä¸€ä¸ª Futureï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„è®°è´¦å·¥å…·ï¼šæ¯”å¦‚å½“å‰ Future æ˜¯å¦åœ¨è¿è¡Œä¸­è¿˜æ˜¯å·²ç»ç»“æŸï¼Œåœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå½“å‰çš„çŠ¶æ€ã€‚è¿™ç§è®°è´¦é€»è¾‘å°±è¢«æŠ½è±¡åˆ°äº† <code>Task</code> ä¸­ã€‚</p><p><code>Task</code> ç±»ä¼¼äº <code>Thread</code>ï¼Œä½†ä¹Ÿæœ‰äº›è®¸ä¸åŒï¼šå®ƒæ˜¯ç”±åº”ç”¨ç¨‹åºï¼ˆç”¨æˆ·ç©ºé—´ï¼‰è¢«è°ƒåº¦ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ä¼šæ„ŸçŸ¥ï¼›ä¸€æ—¦åˆ°äº†æŸä¸ªç‚¹éœ€è¦ç­‰å¾…ï¼Œåº”ç”¨ç¨‹åºè‡ªå·±éœ€è¦è´Ÿè´£å”¤é†’ä»»åŠ¡ã€‚<code>async_std</code> çš„ä»»åŠ¡å¯ä»¥æ‹¥æœ‰åç§°å’Œ IDã€‚</p><p>å½“é€šè¿‡ <code>spawn</code> ç”Ÿæˆä»»åŠ¡åï¼Œä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚è¿”å›çš„ <code>JoinHandle</code> æœ¬èº«æ˜¯ä¸€ä¸ª Futureï¼Œå®ƒä¼šåœ¨ <code>Task</code> è¿è¡Œç»“æŸåï¼ˆrun to conclusionï¼‰ä¹Ÿä¼šç»“æŸã€‚ç±»ä¼¼ <code>threads</code> å’Œ <code>join</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨å¯¹ <code>JoinHandle</code> è°ƒç”¨ <code>block_on</code> å‡½æ•°ï¼Œä»è€Œé˜»å¡ç¨‹åºï¼ˆå‡†ç¡®æ¥è¯´æ˜¯è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ï¼‰ç›´åˆ°å…¶è¿è¡Œç»“æŸã€‚</p><h2 id="Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"><a href="#Task-ä¸­æ˜¯å¦‚ä½•æ¨è¿›-Future-å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ" class="headerlink" title="Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ"></a>Task ä¸­æ˜¯å¦‚ä½•æ¨è¿› Future å®Œæˆè®¡ç®—çš„å‘¢ï¼Ÿ</h2><p>é€šè¿‡ç®€å•é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/block_on.rs#L129" target="_blank" rel="noopener">src/task/block_on.rs</a> çœ‹åˆ°æ‰§è¡Œçš„é€»è¾‘ï¼Œå½“ Task è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„  <code>run</code> å‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œè¿›è€Œæ¨è¿› Future ä¸­çš„è®¡ç®—é€»è¾‘ç›´åˆ°å®Œæˆï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Blocks the current thread on a future's result.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">run</span></span>&lt;F, T&gt;(future: F) -&gt; T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    F: Future&lt;Output = T&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    CACHE.with(|cache| &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> Poll::Ready(t) = future.as_mut().poll(cx) &#123;</span><br><span class="line">                <span class="comment">// Save the parker for the next invocation of `block`.</span></span><br><span class="line">                cache.set(<span class="literal">Some</span>(arc_parker));</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Yield a few times or park the current thread.</span></span><br><span class="line">            <span class="keyword">if</span> step &lt; <span class="number">3</span> &#123;</span><br><span class="line">                thread::yield_now();</span><br><span class="line">                step += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                arc_parker.park();</span><br><span class="line">                step = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"><a href="#JoinHandle-æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ" class="headerlink" title="JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ"></a>JoinHandle æ˜¯å¦‚ä½•å°†ä»»åŠ¡ç»“æœè¿”å›çš„å‘¢ï¼Ÿ</h2><p>ç¿»é˜… <a href="https://github.com/async-rs/async-std/blob/d283352a9add80f722c272238c6f9e122976aedb/src/task/join_handle.rs#L15" target="_blank" rel="noopener">src/task/join_handle.rs</a> æºç å¾—çŸ¥ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°äº† <code>Future trait</code> çš„å¯¹è±¡ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;T&gt;(async_task::JoinHandle&lt;T, Task&gt;);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Future <span class="keyword">for</span> JoinHandle&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = T;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">mut</span> <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> Pin::new(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>).poll(cx) &#123;</span><br><span class="line">            Poll::Pending =&gt; Poll::Pending,</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ Noneï¼Œè¡¨ç¤ºä»»åŠ¡ panic æˆ–è€…è¢«å–æ¶ˆäº†</span></span><br><span class="line">            Poll::Ready(<span class="literal">None</span>) =&gt; <span class="built_in">panic!</span>(<span class="string">"cannot await the result of a panicked task"</span>),</span><br><span class="line">            <span class="comment">// å½“ä»»åŠ¡ç»“æŸï¼Œè‡ªç„¶ä¼šæ‹¿åˆ°å…·ä½“ç»“æœ</span></span><br><span class="line">            Poll::Ready(<span class="literal">Some</span>(val)) =&gt; Poll::Ready(val),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>async_std</code> ä¸­çš„ <code>JoinHandle</code> å®é™…æ˜¯å¯¹ <code>async_task::JoinHandle</code> çš„åŒ…è£…ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥çœ‹ä¸‹å…·ä½“æ˜¯æ€ä¹ˆä» Task ä¸­å–åˆ°ç»“æœçš„ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async-task-1.1.0/src/join_handle.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A handle that awaits the result of a task.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// * `None` è¡¨ç¤ºä»»åŠ¡è¢«å–æ¶ˆæˆ–è€… panic äº†</span></span><br><span class="line"><span class="comment">/// * `Some(result)` è¡¨ç¤ºä»»åŠ¡ç»“æŸï¼Œè¿”å›çš„ç»“æœ `result` ç±»å‹ä¸º `R`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">JoinHandle</span></span>&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="comment">/// A raw task pointer.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) raw_task: NonNull&lt;()&gt;,</span><br><span class="line">    <span class="comment">/// A marker capturing generic types `R` and `T`.</span></span><br><span class="line">    <span class="keyword">pub</span>(<span class="keyword">crate</span>) _marker: PhantomData&lt;(R, T)&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;R, T&gt; Future <span class="keyword">for</span> JoinHandle&lt;R, T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Output</span></span> = <span class="built_in">Option</span>&lt;R&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">poll</span></span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">'_</span>&gt;) -&gt; Poll&lt;Self::Output&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="keyword">self</span>.raw_task.as_ptr();</span><br><span class="line">        <span class="keyword">let</span> header = ptr <span class="keyword">as</span> *<span class="keyword">const</span> Header;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> state = (*header).state.load(Ordering::Acquire);</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                <span class="comment">// If the task has been closed, notify the awaiter and return `None`.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; CLOSED != <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> Poll::Ready(<span class="literal">None</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// If the task is not completed, register the current task.</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; COMPLETED == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä»»åŠ¡å®Œæˆï¼Œæå–ç»“æœ</span></span><br><span class="line">                <span class="keyword">match</span> (*header).state.compare_exchange(</span><br><span class="line">                    state,</span><br><span class="line">                    state | CLOSED,</span><br><span class="line">                    Ordering::AcqRel,</span><br><span class="line">                    Ordering::Acquire,</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                        <span class="comment">// ä»è¿™é‡ŒæŠŠä»»åŠ¡ç»“æœè·å–å‡ºæ¥ï¼ˆæŒº Hack çš„ï¼‰ï¼Œå°±æ˜¯ä¸‹é¢çš„ output.read()</span></span><br><span class="line">                        <span class="keyword">let</span> output = ((*header).vtable.get_output)(ptr) <span class="keyword">as</span> *<span class="keyword">mut</span> R;</span><br><span class="line">                        <span class="keyword">return</span> Poll::Ready(<span class="literal">Some</span>(output.read()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Err</span>(s) =&gt; state = s,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="async-std-ä¸­çš„-Task"><a href="#async-std-ä¸­çš„-Task" class="headerlink" title="async_std ä¸­çš„ Task"></a>async_std ä¸­çš„ Task</h2><p>Task æ˜¯ <code>async_std</code> ä¸­æœ€æ ¸å¿ƒçš„æŠ½è±¡ä¹‹ä¸€ï¼Œå’Œ Rust ä¸­çš„ <code>thread</code> ç±»ä¼¼ã€‚<code>Tasks</code> å’Œè¿è¡Œæ—¶è™½ç„¶ä¹Ÿæœ‰å…³è”ï¼Œä½†å®ƒä»¬æ˜¯åˆ†å¼€çš„ã€‚<code>async_std</code> Task æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡æ˜¯å•æ¬¡åˆ†é…çš„ï¼ˆin one single allocationï¼‰ï¼›</li><li>æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª <code>backchannel</code>ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ <code>JoinHandle</code> å°†ç»“æœå’Œé”™è¯¯ä¼ é€’åˆ°å¯¹åº”çš„ä»»åŠ¡ï¼ˆspawning taskï¼‰ï¼›</li><li>å®ƒä»¬æºå¸¦ç”¨äºè°ƒè¯•çš„å…ƒä¿¡æ¯ï¼›</li><li>å®ƒä»¬æ”¯æŒ ä»»åŠ¡çº§åˆ«çš„ local storageã€‚</li></ul><p><code>async_std</code> ä»»åŠ¡ API ä¼šå¤„ç†èƒŒåçš„ runtime åˆå§‹åŒ–ï¼ˆsetupï¼‰å’Œæ¸…ç†ï¼ˆteardownï¼‰å·¥ä½œï¼Œä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ˜¾å¼åœ°å¯åŠ¨è¿è¡Œæ—¶ï¼ˆè¿™ä¸ªå’Œ Python 3 æœ‰ä¸¢ä¸¢åŒºåˆ«ï¼‰ã€‚</p><h2 id="é˜»å¡ï¼ˆBlockingï¼‰"><a href="#é˜»å¡ï¼ˆBlockingï¼‰" class="headerlink" title="é˜»å¡ï¼ˆBlockingï¼‰"></a>é˜»å¡ï¼ˆBlockingï¼‰</h2><p>ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸º Tasks éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¯èƒ½å®ƒä»¬ä¼šå…±äº«åŒä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼ˆåœ¨è¯¥çº¿ç¨‹ä¸Šåˆ‡æ¢ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚è¿™åŒæ—¶ä¹Ÿæ„å‘³ç€å¦‚æœåœ¨æŸä¸ªæ‰§è¡Œçº¿ç¨‹ä¸Šè°ƒç”¨äº†é˜»å¡ APIï¼ˆæ¯”å¦‚ <code>std::thread::sleep</code> æˆ–è€…æ ‡å‡†åº“çš„ IO å‡½æ•°ï¼‰ï¼Œä¼šå¯¼è‡´å¯¹åº”æ‰§è¡Œçº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´<strong>è¯¥æ‰§è¡Œçº¿ç¨‹ä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½åœæ­¢è¿è¡Œäº†</strong>ã€‚å…¶å®ƒçš„ä¸€äº›åº“ï¼ˆå¦‚ db driversï¼‰ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„è¡Œä¸ºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé˜»å¡å½“å‰çº¿ç¨‹æœ¬èº«å¹¶éåäº‹æƒ…ï¼Œåªæ˜¯ä¸è¦å’Œ <code>async_std</code> å¹¶å‘æ‰§è¡Œçš„æ¨¡å‹ææ··æ·†å³å¯ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿™æ ·åšï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="comment">//  æ ‡å‡†åº“ std::fsï¼Œä¼šå¯¼è‡´é˜»å¡</span></span><br><span class="line">        std::fs::read_to_string(<span class="string">"test_file"</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦æ··åˆé˜»å¡ API è°ƒç”¨ï¼Œå»ºè®®å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ ·çš„é˜»å¡æ“ä½œã€‚</p><h2 id="å…³äºé”™è¯¯å’Œ-Panic"><a href="#å…³äºé”™è¯¯å’Œ-Panic" class="headerlink" title="å…³äºé”™è¯¯å’Œ Panic"></a>å…³äºé”™è¯¯å’Œ Panic</h2><p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå¦‚æœä»»åŠ¡å¯èƒ½å‡ºé”™ï¼Œé‚£ä¹ˆä»»åŠ¡çš„è¾“å‡º <code>Output</code> åº”è¯¥æ˜¯  <code>Result&lt;T, E&gt;</code> ç±»å‹ã€‚ä½†æ˜¯åœ¨ <code>panic</code> çš„æ—¶å€™ï¼Œå…·ä½“çš„è¡¨ç°åˆ™å–å†³äºæœ‰æ²¡æœ‰åˆç†å¤„ç† panic çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šé€€å‡ºã€‚</p><p>å®è·µä¸­ï¼Œæ„å‘³ç€ <code>block_on</code> ä¼šä¼ é€’ panic åˆ°é˜»å¡è°ƒç”¨çš„åœ°æ–¹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fn main() &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        panic!(&quot;test&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br></pre></td></tr></table></figure></p><p>è€Œå¯¹äº spwan å‡ºå»çš„ä»»åŠ¡å¦‚æœ panicï¼Œåˆ™ä¼šå¯¼è‡´é€€å‡ºï¼ˆabortï¼‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task::spawn(async &#123;</span><br><span class="line">    panic!(&quot;test&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task::block_on(async &#123;</span><br><span class="line">    task::sleep(Duration::from_millis(10000)).await;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">thread &apos;async-task-driver&apos; panicked at &apos;test&apos;, examples/panic.rs:8:9</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„è¡Œä¸ºæœ€åˆçœ‹ä¸Šå»æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¦å¤–ä¸€ç§é€‰é¡¹æ˜¯å¯¹äº spawn å‡ºå»çš„ä»»åŠ¡å¦‚æœå‘ç”Ÿ panicï¼Œåˆ™ç®€å•å¿½ç•¥æ‰ã€‚å½“å‰çš„è¡Œä¸ºå¯ä»¥è¢«ä¿®æ”¹ä¸ºæ•è· spawn å‡ºå»çš„ä»»åŠ¡ä¸­å‘ç”Ÿçš„ panicï¼Œå¹¶ä¸”æ ¹æ®ä¸åŒçš„æƒ…å†µåšå‡ºä¸åŒçš„å“åº”ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦é‡‡å–ä¸åŒçš„ panic å¤„ç†ç­–ç•¥ã€‚</p><h1 id="æ›´å¤šç¤ºä¾‹"><a href="#æ›´å¤šç¤ºä¾‹" class="headerlink" title="æ›´å¤šç¤ºä¾‹"></a>æ›´å¤šç¤ºä¾‹</h1><p>åœ¨ <a href="https://github.com/async-rs/async-std/tree/master/examples" target="_blank" rel="noopener">è¿™é‡Œ</a> æœ‰ä¸å°‘ç¤ºä¾‹ä»£ç å¯ä»¥å‚è€ƒï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ UDP å®¢æˆ·ç«¯ä¾‹å­ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> async_std::io;</span><br><span class="line"><span class="keyword">use</span> async_std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> async_std::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    task::block_on(async &#123;</span><br><span class="line">        <span class="keyword">let</span> socket = UdpSocket::bind(<span class="string">"127.0.0.1:8081"</span>).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"Listening on &#123;&#125;"</span>, socket.local_addr()?);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> msg = <span class="string">"hello world"</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&lt;- &#123;&#125;"</span>, msg);</span><br><span class="line">        socket.send_to(msg.as_bytes(), <span class="string">"127.0.0.1:8080"</span>).await?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> buf = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">let</span> (n, _) = socket.recv_from(&amp;<span class="keyword">mut</span> buf).await?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"-&gt; &#123;&#125;\n"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;buf[..n]));</span><br><span class="line"></span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://book.async.rs/introduction.html" target="_blank" rel="noopener">Async programming in Rust with async-std</a></li><li><a href="https://rust-lang.github.io/async-book/" target="_blank" rel="noopener">Asynchronous Programming in Rust</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æ‰“ç®—åŸºäº Rust &lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; é€ è½®å­ï¼Œè‡ªç„¶æ˜¯è¦ç†Ÿæ‚‰ä¸‹è¿™ä¸ªåº“ã€‚ä»¥ä¸‹å†…å®¹æ˜¯æ ¹æ® Rust &lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; å®˜æ–¹æ–‡æ¡£ç¿»è¯‘æ•´ç†ï¼Œå½“ç„¶ä¹ŸåŠ å…¥äº†éƒ¨åˆ†è‡ªå·±çš„ç†è§£ï¼Œæœ‰ä¸åˆ°ä½çš„åœ°æ–¹è¿˜è¯·æŒ‡ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/async-rs/async-std&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;async-std&lt;/a&gt; æ—¨åœ¨ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œç”±äºæ˜¯æ¨¡æ‹Ÿ Rust æ ‡å‡†åº“æ¥å£ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ ‡å‡†åº“çš„è¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿä¼šéå¸¸èˆ’æœã€‚ç›®å‰ &lt;code&gt;async-std&lt;/code&gt; ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šæ¥å£ï¼šæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è®¡æ—¶å™¨ç­‰ç­‰ï¼›å®ƒè¿˜æä¾›äº†ä¸€ä¸ª &lt;code&gt;task&lt;/code&gt; æ¨¡å‹ï¼Œæœ‰ç‚¹ç±»ä¼¼ Rust æ ‡å‡†åº“ä¸­çš„ &lt;code&gt;thread&lt;/code&gt; æ¨¡å—ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ &lt;code&gt;async/await&lt;/code&gt; é£æ ¼çš„ &lt;code&gt;Mutex&lt;/code&gt; åŸè¯­ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Rust" scheme="/categories/Rust/"/>
    
    
      <category term="Rust" scheme="/tags/Rust/"/>
    
      <category term="Async" scheme="/tags/Async/"/>
    
  </entry>
  
  <entry>
    <title>åˆè¯† Elasticsearch</title>
    <link href="/2020/01/15/elasticsearch-intro/"/>
    <id>/2020/01/15/elasticsearch-intro/</id>
    <published>2020-01-15T06:06:48.000Z</published>
    <updated>2020-01-15T06:44:16.554Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æœç´¢åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯åœ¨ App ä¸­è¿˜æ˜¯ç½‘ç«™ä¸­ã€‚æœç´¢æ¯æ—¶æ¯åˆ»éƒ½åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚æœç´¢å–œæ¬¢çš„é›¶é£Ÿã€å¥½çœ‹çš„è¡£æœã€å–œæ¬¢çš„æ–‡ç« ã€æƒ³è¦å­¦ä¹ çš„è¯¾ç¨‹ç­‰ç­‰ã€‚å¦‚ä»Šè¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ æœç´¢å·²ç»éå¸¸å®¹æ˜“äº†ï¼Œæ—©æœŸæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MySQL çš„ MyISAM å­˜å‚¨å¼•æ“æ¥åšå…¨æ–‡æœ¬æœç´¢æ”¯æŒï¼Œä¸è¿‡ä»Šå¤©è¦è¯´çš„ Elasticsearch åŒæ ·å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ›´å¼ºå¤§ã€‚ç®€å•æ¥è¯´ï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œä¹Ÿæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ELK Stack æ ¸å¿ƒæˆå‘˜ã€‚å®ƒä»¥ JSON çš„æ ¼å¼å­˜å‚¨æ–‡æ¡£åˆ°ç´¢å¼•å½“ä¸­ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å¤šç§ç±»å‹ï¼Œå¹¶æä¾›å¿«é€Ÿæœç´¢çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ•´ä¸ª ELK Stack ç”Ÿæ€éå¸¸å®Œå–„ã€‚</p><a id="more"></a><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è·Ÿç€å®˜æ–¹æ–‡æ¡£å­¦ä¹ ä¸‹ Elasticsearch å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿé€‚ç”¨çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæ”¯æŒä»€ä¹ˆæ•°æ®ç±»å‹å­˜å‚¨å’Œæ£€ç´¢ï¼Ÿ</p><p><em>PS: æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ ES æ„å»ºäº†è¯¾ç¨‹å•†å“ï¼ˆSKUï¼‰ç´¢å¼•ï¼Œæ–¹ä¾¿å¯¹ç”¨æˆ·ã€ç®¡ç†åå°æä¾›è¯¾ç¨‹æœç´¢èƒ½åŠ›ã€‚</em></p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p><a href="https://github.com/deviantony/docker-elk" target="_blank" rel="noopener">docker-elk</a> ä»“åº“æä¾›äº†åœ¨ Docker ç¯å¢ƒä¸‹æ­å»º ELK Stack æœåŠ¡çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶è¯´æ˜æ–‡æ¡£è¿›è¡Œå®‰è£…ï¼ˆåœ¨ macOS Catalina ç¯å¢ƒä¸‹æ“ä½œï¼‰ã€‚</p><ol><li>å…‹éš†ä»“åº“ï¼š<code>git clone git@github.com:deviantony/docker-elk.git</code></li><li>ç¬¬ä¸€æ¬¡éœ€è¦è¿è¡Œ <code>docker-compose build</code>ï¼Œç­‰å¾…æ„å»ºå®Œæˆ</li><li>éœ€è¦åœ¨ <code>docker-compose.yml</code> ä¸­ä¿®æ”¹ä¸‹ ES çš„å¯†ç ï¼Œå½“ç„¶è¿˜æœ‰ <code>elasticsearch/config</code>ï¼Œ<code>kibana/config</code>, <code>logstash/config</code> ä¸­éƒ½æœ‰å¯†ç éœ€è¦ä¿®æ”¹ã€‚ç”±äºæ˜¯åœ¨æœ¬åœ°å­¦ä¹ ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•è®¾ç½®äº†ä¸‹å¯†ç ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®å‚è€ƒæ–‡æ¡£ï¼Œç”Ÿæˆå¤æ‚çš„å¯†ç </li><li>è¿è¡Œ <code>docker-compose up [-d]</code> å³å¯å¯åŠ¨</li><li>å…³é—­ <code>docker-compose down -v</code></li></ol><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>é…ç½®æ–‡ä»¶å¹¶éåŠ¨æ€åŠ è½½ï¼Œæ¯æ¬¡å˜æ›´åéœ€è¦é‡å¯å¯¹åº”çš„ç»„ä»¶</li><li>ç«¯å£æ˜ å°„è¯´æ˜ï¼š<ol><li>9200: ES HTTP</li><li>9300: ES TCP</li><li>5000: Logstash TCP input</li><li>5601: Kibana</li></ol></li></ol><p>å¯åŠ¨æˆåŠŸåï¼Œå¯ä»¥æ‰“å¼€ Kibana å¼€å§‹æ¢ç´¢å•¦~<br><img src="https://pic3.zhimg.com/v2-8ea49800d9c7e5e4f147349ca3237593.png" alt=""></p><h1 id="Elasticsearch-ç®€ä»‹"><a href="#Elasticsearch-ç®€ä»‹" class="headerlink" title="Elasticsearch ç®€ä»‹"></a>Elasticsearch ç®€ä»‹</h1><p>Elasticsearch æ˜¯ä¸€ä¸ª<strong>åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“</strong>ï¼ŒELK æ ˆçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚è€Œ Logstash å’Œ Beats ç”¨äº<strong>æ”¶é›†</strong>ã€<strong>èšåˆ</strong>ã€<strong>è½¬æ¢</strong>æ•°æ®ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ Elasticsearch å½“ä¸­ã€‚è€Œ Kibana åˆ™è®©æˆ‘ä»¬èƒ½å¤Ÿä¾¿æ·æ¢ç´¢ã€æŸ¥çœ‹å¹¶åˆ†äº«æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥ç®¡ç† ELK æ ˆã€‚</p><p>ES æä¾›äº†å®æ—¶çš„æœç´¢å’Œåˆ†æèƒ½åŠ›ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆç»“æ„åŒ–ã€éç»“æ„åŒ–ã€æ•°å­—ã€åœ°ç†ä½ç½®ç­‰ï¼‰ï¼ŒES ä¼šé«˜æ•ˆåœ°å­˜å‚¨å¹¶ç´¢å¼•è¿™äº›æ•°æ®ï¼Œä»è€Œæ”¯æŒå¿«é€Ÿæœç´¢ã€‚ç”±äºåˆ†å¸ƒå¼çš„ç‰¹ç‚¹ï¼Œéšç€æ•°æ®é›†çš„å¢åŠ ï¼Œå¯ä»¥è½»æ¾åœ°è¿›è¡Œæ°´å¹³æ‰©å±•æ¥æé«˜æœåŠ¡å¯é æ€§å’Œæ€§èƒ½ã€‚</p><p>ES æ”¯æŒçš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p><ol><li><strong>ä¸ºæˆ‘ä»¬çš„ App æˆ–ç½‘ç«™æä¾›æœç´¢æ”¯æŒ</strong></li><li><strong>å¯ä»¥å­˜å‚¨åˆ†ææ—¥å¿—ï¼ˆanalyze logsï¼‰ã€æŒ‡æ ‡æ•°æ®ï¼ˆmetricsï¼‰ã€å®‰å…¨äº‹ä»¶æ•°æ®ï¼ˆsecurity event dataï¼‰</strong></li><li>åŸºäºæœºå™¨å­¦ä¹ æ ¹æ®æ•°æ®å®æ—¶å»ºæ¨¡</li><li>å¯ä»¥ç”¨ä½œ GIS ç³»ç»Ÿï¼ˆåœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼‰ï¼Œç”¨äºç®¡ç†ã€é›†æˆå¹¶åˆ†æç©ºé—´ä¿¡æ¯</li><li>å¯ä»¥ç”¨äºç”Ÿç‰©å­¦ç ”ç©¶å·¥å…·ï¼Œå­˜å‚¨å¹¶å¤„ç†åŸºå› æ•°æ®</li></ol><h1 id="æ–‡æ¡£å’Œç´¢å¼•"><a href="#æ–‡æ¡£å’Œç´¢å¼•" class="headerlink" title="æ–‡æ¡£å’Œç´¢å¼•"></a>æ–‡æ¡£å’Œç´¢å¼•</h1><p>ES æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨æœåŠ¡ï¼ˆç±»æ¯” Mongoï¼Ÿï¼‰ï¼Œå®é™…åœ¨ç´¢å¼•ä¸­å­˜å‚¨çš„æ˜¯ JSON æ ¼å¼çš„æ–‡æ¡£ã€‚åœ¨ ES é›†ç¾¤ä¸­ï¼Œæ–‡æ¡£ä¼šè¢«åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤å­˜å‚¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ç«‹åˆ»è®¿é—®åˆ°ã€‚</p><p>ä¸€æ—¦æ–°çš„æ–‡æ¡£å­˜å‚¨åˆ°ç´¢å¼•åï¼Œå‡ ä¹å¯ä»¥ç«‹åˆ»è¢«æœç´¢åˆ°ï¼ˆ1s ä»¥å†…ï¼‰ï¼Œå› æ­¤å¯ä»¥æ„å»ºè¿‘ä¹å®æ—¶çš„æœç´¢å¼•æ“ã€‚é‚£ä¹ˆ ES ç©¶ç«Ÿæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒä½¿ç”¨äº†<strong>å€’æ’ç´¢å¼•ï¼ˆinverted indexï¼‰</strong>è¿™ç§æ•°æ®ç»“æ„æ¥æ”¯æŒå…¨æ–‡æœ¬æœç´¢ã€‚æ‰€è°“çš„<strong>å€’æ’ç´¢å¼•</strong>å°±æ˜¯å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ï¼Œç„¶åè®°å½•æ¯ä¸ªåˆ†è¯æ‰€åœ¨çš„æ–‡æ¡£ idï¼ˆå½“ç„¶è¿˜æœ‰è¯é¢‘ç­‰ä¿¡æ¯ï¼‰ï¼Œè¿™æ ·åœ¨æŸ¥è¯¢æ—¶å¯ä»¥åŸºäºåˆ†è¯å¿«é€Ÿå®šä½æ‰€åœ¨çš„æ–‡æ¡£ã€‚</p><p>åœ¨ ES ä¸­ï¼Œ<strong>ç´¢å¼•</strong>æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼ˆå›é¡¾ä¸‹ MySQL InnoDB çš„èšç°‡ç´¢å¼•ï¼Œè¡¨ä¸­çš„è®°å½•å­˜å‚¨åœ¨ B-Tree Node ä¸Šï¼ŒåŸºäº B+ Tree è¿™ç§æ•°æ®ç»“æ„å¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„é¡µï¼‰ï¼Œä½†æ˜¯è¿™é‡Œçš„ç´¢å¼•å’Œåœ¨å…³ç³»æ•°æ®åº“ä¸­æåˆ°çš„ç´¢å¼•æœ‰æ‰€å·®åˆ«ã€‚æ€»ç»“ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>ES çš„<strong>ç´¢å¼•ï¼ˆindexï¼‰</strong>å¯ä»¥çœ‹æˆ<strong>æ–‡æ¡£ï¼ˆdocumentï¼‰</strong>çš„é›†åˆï¼›</li><li>æ¯ä¸ª<strong>æ–‡æ¡£ï¼ˆdocumentï¼‰</strong>å¯ä»¥çœ‹æˆ<strong>å­—æ®µï¼ˆfieldï¼‰</strong>ï¼ˆç±»æ¯”ä¸‹å­—å…¸ä¸­çš„ key-valueï¼‰çš„é›†åˆï¼›<br><img src="https://pic1.zhimg.com/v2-b165c6321a00d62c6c5ab2b2ac0994bb.png" alt=""></li></ol><p>é»˜è®¤è®¾ç½®ä¸‹ï¼ŒES ä¼šä¸ºæ–‡æ¡£ä¸­çš„æ¯ä¸ªå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µéƒ½ä¼šåŒ¹é…ä¸“é—¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„ä»¥è¾¾åˆ°é«˜æ•ˆå­˜å‚¨å’Œå¿«é€Ÿæœç´¢çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šæ–‡æœ¬ä½¿ç”¨<strong>å€’æ’ç´¢å¼•</strong>ï¼Œæ•°å­—å’Œåœ°ç†ä½ç½®ä½¿ç”¨ <a href="https://www.shenyanchao.cn/blog/2018/12/04/lucene-bkd/" target="_blank" rel="noopener">BKD æ ‘</a>ã€‚</p><p>ES æ”¯æŒ schema-lessï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨ä¸ºæ¯ä¸ªå­—æ®µæ˜¾å¼æŒ‡å®šç´¢å¼•æ–¹å¼ã€‚å½“æˆ‘ä»¬å¯ç”¨åŠ¨æ€æ˜ å°„ï¼ˆdynamic mappingï¼‰æ—¶ï¼ˆè¿™ä¸ªæ˜¯é»˜è®¤è®¾ç½®ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ–°å¢å­—æ®µï¼Œè‡ªåŠ¨å°†æ–‡æ¡£ä¸­çš„ bool å€¼ã€æµ®ç‚¹æ•°ã€æ•´æ•°ã€æ—¥æœŸã€å­—ç¬¦ä¸²ç­‰æ˜ å°„æˆåˆé€‚çš„ ES æ•°æ®ç±»å‹ã€‚</p><p>å½“ç„¶ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦å…³é—­åŠ¨æ€æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™æ—¶å¯ä»¥è‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼Œä»è€Œæ§åˆ¶æ¯ä¸ªå­—æ®µå­˜å‚¨å’Œç´¢å¼•çš„æ–¹å¼ã€‚è‡ªå®šä¹‰æ˜ å°„å¸¦å¯ä»¥ï¼š</p><ol><li>åŒºåˆ†å…¨æ–‡æœ¬å­—ç¬¦ä¸²å­—æ®µå’Œç²¾ç¡®åŒ¹é…çš„å­—ç¬¦ä¸²å­—æ®µï¼›</li><li>æ‰§è¡Œç‰¹å®šè¯­è¨€çš„æ–‡æœ¬åˆ†æï¼›</li><li>ä¼˜åŒ–éƒ¨åˆ†åŒ¹é…ï¼›</li><li>ä½¿ç”¨è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼›</li><li>ä½¿ç”¨ä¸€äº›æ— æ³•è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ <code>geo_point</code>, <code>geo_shape</code>ï¼‰ã€‚</li></ol><p>æ­¤å¤–ï¼ŒES å¯ä»¥ä¸ºç›¸åŒçš„å­—æ®µå»ºç«‹ä¸åŒçš„ç´¢å¼•ï¼Œä»¥æ»¡è¶³ä¸åŒçš„éœ€æ±‚åœºæ™¯ã€‚</p><h1 id="æœç´¢ä¸åˆ†æ"><a href="#æœç´¢ä¸åˆ†æ" class="headerlink" title="æœç´¢ä¸åˆ†æ"></a>æœç´¢ä¸åˆ†æ</h1><p>ES æä¾›äº†éå¸¸ç®€å•æ˜“äºä½¿ç”¨çš„ REST APIï¼Œå¯ä»¥åˆ©ç”¨å®ƒä»¬ç®¡ç†é›†ç¾¤ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚æˆ‘ä»¬æ—¢å¯ä»¥åœ¨ Kibana æ§åˆ¶å°ä¸­å’Œ ES äº¤äº’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å„ä¸ªè¯­è¨€ï¼ˆæ”¯æŒ Java, JavaScript, Go, .Net, PHP, Perl, Python, Ruby ç­‰ï¼‰çš„å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ã€‚</p><h2 id="æœç´¢æ•°æ®"><a href="#æœç´¢æ•°æ®" class="headerlink" title="æœç´¢æ•°æ®"></a>æœç´¢æ•°æ®</h2><p><em>ç›®å‰æ”¯æŒä¸¤ç§æŸ¥è¯¢æ–¹å¼ï¼šJSON Query DSL å’Œ SQLã€‚</em></p><p>ES API å…è®¸æˆ‘ä»¬ä½¿ç”¨ç»“æ„åŒ–æŸ¥è¯¢ã€å…¨æ–‡æœ¬æŸ¥è¯¢æˆ–è€…äºŒè€…ç»„åˆï¼š</p><ol><li><strong>ç»“æ„åŒ–æŸ¥è¯¢</strong>ï¼šç±»ä¼¼ SQL é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢æŸå‡ ä¸ªå­—æ®µï¼ŒåŸºäºæŸå­—æ®µæ’åºç­‰ï¼›</li><li><strong>å…¨æ–‡æœ¬æŸ¥è¯¢</strong>ï¼šè¿”å›åŒ¹é…å…³é”®è¯çš„æ–‡æ¡£ï¼Œè¿”å›çš„ç»“æœåŸºäºç›¸å…³æ€§æ’åºã€‚</li></ol><p>æ­¤å¤–ï¼Œè¿˜æ”¯æŒå•ç‹¬åˆ†è¯ï¼ˆindividual termsï¼‰æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒçŸ­è¯­æœç´¢ï¼ˆphrase searchesï¼‰ã€ç›¸ä¼¼åº¦æœç´¢ï¼ˆsimilarity searchesï¼‰å’Œå‰ç¼€æœç´¢ï¼ˆprefix searchesï¼‰ï¼Œç”šè‡³å¯ä»¥å¾—åˆ°è‡ªåŠ¨è¡¥å…¨çš„å»ºè®®ã€‚å½“ç„¶ï¼Œå¯¹äºåœ°ç†ä½ç½®æˆ–è€…æ•°å­—ç±»å‹çš„æ•°æ®ï¼ŒES ä¹Ÿå¯ä»¥æä¾›é«˜æ•ˆçš„æŸ¥è¯¢åŠŸèƒ½ã€‚</p><h2 id="åˆ†ææ•°æ®"><a href="#åˆ†ææ•°æ®" class="headerlink" title="åˆ†ææ•°æ®"></a>åˆ†ææ•°æ®</h2><p>ES å…è®¸æˆ‘ä»¬æ‰§è¡Œ<strong>èšåˆï¼ˆaggregationï¼‰</strong>æ“ä½œï¼Œä»è€Œå¯¹å…³é”®çš„æŒ‡æ ‡ã€ å¢é•¿è¶‹åŠ¿ç­‰æœ‰æ›´ä¸ºæ·±åˆ»çš„è®¤è¯†ã€‚ES é«˜æ•ˆèšåˆçš„èƒ½åŠ›ï¼Œå¯ä»¥è®©æˆ‘ä»¬èƒ½å¤Ÿå®æ—¶åœ°åˆ†æå’Œå¯è§†åŒ–æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæœç´¢å’Œèšåˆè”åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æœç´¢ã€è¿‡æ»¤æ–‡æ¡£çš„åŒæ—¶ï¼Œå¯¹ç›¸åŒçš„ç»“æœè¿›è¡Œåˆ†æã€‚</p><p>æ­¤å¤–ï¼ŒES è¿˜æä¾›äº†è‡ªåŠ¨åˆ†ææ—¶åºæ•°æ®çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨æœºå™¨å­¦ä¹ æ¥å‘ç°æ•°æ®ä¸­çš„å¼‚å¸¸ï¼Œä¸è¿‡è¿™å—å±äºé«˜çº§åŠŸèƒ½äº†ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸‹~</p><h1 id="é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§"><a href="#é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§" class="headerlink" title="é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§"></a>é«˜å¯ç”¨ã€å¯ä¼¸ç¼©ä¸å¯é æ€§</h1><p><img src="https://pic3.zhimg.com/v2-f8f2d20ee4cd5a1cc87c4ddba58f0078.jpg" alt=""></p><p>æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œé«˜å¯ç”¨å’Œå¯ä¼¸ç¼©çš„èƒ½åŠ›è‡ªç„¶æ˜¯ ES å¿…å¤‡æŠ€èƒ½ã€‚æˆ‘ä»¬å¯ä»¥æŒ‰éœ€ç»™é›†ç¾¤å¢åŠ æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰å®ç°æ‰©å®¹ã€‚ES ä¼šè‡ªåŠ¨å°†æ•°æ®å’ŒæŸ¥è¯¢è´Ÿè½½å‡è¡¡åˆ°<strong>å¯ç”¨èŠ‚ç‚¹</strong>ä¸Šï¼Œä»¥å®ç°ä¼¸ç¼©å’Œé«˜å¯ç”¨ã€‚</p><p>é‚£ä¹ˆï¼ŒES æ˜¯å¦‚ä½•å­˜å‚¨å’Œç»´æŠ¤ç´¢å¼•çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œæ¯ä¸ª ES <strong>ç´¢å¼•ï¼ˆindexï¼‰</strong>å…¶å®æ˜¯ä¸€ä¸ªåˆ°å¤šä¸ª<strong>ç‰©ç†åˆ†ç‰‡ï¼ˆphysical shardsï¼‰</strong> æ‰€ç»„æˆçš„<strong>é€»è¾‘åˆ†ç»„ï¼ˆlogical groupï¼‰</strong>ï¼›æ¯ä¸ªåˆ†ç‰‡å®é™…æ˜¯<strong>è‡ªåŒ…å«ç´¢å¼•ï¼ˆself-contained indexï¼‰</strong>ã€‚é€šè¿‡å°†ç´¢å¼•æ”¾åˆ°å¤šä¸ªåˆ†ç‰‡å­˜å‚¨ï¼Œç„¶åå°†åˆ†ç‰‡åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼ŒES å¯ä»¥ä¸ºåˆ†ç‰‡æä¾›å†—ä½™å¤‡ä»½ï¼Œä»è€Œè¾¾åˆ°æ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨çš„ç›®çš„ã€‚éšç€é›†ç¾¤çš„æ‰©å®¹ï¼ˆæˆ–ç¼©å®¹ï¼‰ï¼ŒES ä¼šè‡ªåŠ¨å†å‡è¡¡ï¼Œå¿…è¦æ—¶ä¹Ÿä¼šåˆå¹¶åˆ†ç‰‡ã€‚</p><h2 id="å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰"><a href="#å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰" class="headerlink" title="å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰"></a>å…³äºåˆ†ç‰‡ï¼ˆshardsï¼‰</h2><p>åˆ†ç‰‡åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p><ol><li><strong>ä¸»åˆ†ç‰‡ï¼ˆprimary shardï¼‰</strong>ï¼šç´¢å¼•ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½å±äºæŸä¸ªä¸»åˆ†ç‰‡ã€‚</li><li><strong>å‰¯æœ¬åˆ†ç‰‡ï¼ˆreplicasï¼‰</strong>ï¼šå‰¯æœ¬åˆ†ç‰‡å…¶å®å°±æ˜¯ä¸»åˆ†ç‰‡çš„æ‹·è´ï¼Œä¸€æ–¹é¢å®ç°æ•°æ®å†—ä½™ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯¹å¤–æä¾›è¯»æœåŠ¡ï¼ˆæœç´¢ã€è·å–æ–‡æ¡£ç­‰ï¼‰ã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>ç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°åœ¨åˆ›å»ºåå°±ä¸èƒ½ä¿®æ”¹äº†ï¼Œåªèƒ½é‡å»ºé é‡å»ºç´¢å¼•æ¥æ‰©å±•ä¸»åˆ†ç‰‡æ•°</strong>ï¼Œä½†æ˜¯å‰¯æœ¬åˆ†ç‰‡æ•°å¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œä¸ä¼šæ‰“æ–­ç´¢å¼•å’ŒæŸ¥è¯¢æ“ä½œã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°è¶Šå¤šè¶Šå¥½å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯è¿™æ ·çš„ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘ç´¢å¼•çš„æ•°æ®é‡å¤§å°ï¼Œå°½å¯èƒ½ä¿è¯æ¯ä¸ªåˆ†ç‰‡ä¸è¦å¤ªå¤§ï¼Œåˆ†ç‰‡æ•°é‡ä¸è¦è¿‡å¤šã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åˆ†ç‰‡æ•°è¿‡å¤šä¼šå¯¼è‡´çš„é—®é¢˜å§ï¼š</p><ol><li>æ¯ä¸ªåˆ†ç‰‡å…¶å®éƒ½æ˜¯ä¸€ä¸ª Lucene ç´¢å¼•ï¼Œä¼šå ç”¨æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜å’Œ CPU èµ„æºï¼›</li><li>æœç´¢ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœåˆ†ç‰‡éƒ½ä½äºä¸åŒèŠ‚ç‚¹è¿˜å¥½ï¼Œè¦æ˜¯é›†ä¸­åœ¨æŸä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå‡ºç°çƒ­ç‚¹é—®é¢˜ï¼Œèµ„æºç«äº‰æ¿€çƒˆï¼Œæ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼›</li><li>è¿‡å¤šçš„åˆ†ç‰‡ä¹Ÿä¼šå¯¼è‡´è¿‡å¤šçš„åˆ†ç‰‡è¯·æ±‚ï¼Œä¼šäº§ç”Ÿä¸€å®šçš„ç½‘ç»œå¼€é”€ç­‰ï¼›</li><li>ES ä½¿ç”¨è¯é¢‘æ¥ç»Ÿè®¡åŒ¹é…çš„ç›¸å…³æ€§ï¼Œç»Ÿè®¡ä¼šè¢«åˆ†é…åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šï¼Œå¦‚æœå¤§é‡åˆ†ç‰‡ä¸Šåªç»´æŠ¤äº†å¾ˆå°‘çš„æ•°æ®ï¼Œåˆ™ä¼šå¯¼è‡´æœ€ç»ˆçš„æ–‡æ¡£çš„ç›¸å…³æ€§è¾ƒå·®ã€‚</li></ol><p>å¦‚æœæ¯ä¸ªåˆ†ç‰‡è¿‡å¤§ï¼Œåˆ™ä¼šå¯¼è‡´é›†ç¾¤å†å‡è¡¡åŠæ—¶ï¼Œæ¬è¿æ•°æ®æ›´è€—æ—¶ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æµ‹è¯•æ¥ç¡®å®šæœ€ä½³çš„é…ç½®ã€‚èµ·åˆå¯ä»¥è¿™æ ·ï¼š</p><ol><li>ä¿è¯æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°åœ¨ GB åˆ°å‡ å GB èŒƒå›´ã€‚å¯¹äºå¸¸è§çš„æ—¶åºæ•°æ®ï¼Œåˆ†ç‰‡å¤§å°åœ¨ 20GB ~ 40GB ä¹Ÿå¾ˆå¸¸è§ã€‚å‚è€ƒæ–‡çŒ®ä¸­ç»™å‡ºçš„å¤§å°é™åˆ¶ä¸º 30GBã€‚</li><li>é¿å…è¿‡å¤§çš„åˆ†ç‰‡é—®é¢˜ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯å®¹çº³çš„åˆ†ç‰‡æ•°é‡å’Œå¯ç”¨çš„å †ç©ºé—´æˆæ­£æ¯”ï¼Œæ¯ GB å †ç©ºé—´åˆ†ç‰‡æ•°åº”è¯¥å°äº 20ã€‚</li></ol><h2 id="ç¾å¤‡"><a href="#ç¾å¤‡" class="headerlink" title="ç¾å¤‡"></a>ç¾å¤‡</h2><p>è€ƒè™‘æ€§èƒ½çš„å› ç´ ï¼Œé€šå¸¸é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åº”è¯¥ä½äºç›¸åŒçš„ç½‘ç»œç¯å¢ƒã€‚è·¨æ•°æ®ä¸­å¿ƒå‡è¡¡åˆ†ç‰‡éå¸¸è€—æ—¶ï¼Œå¯é æ€§ä¹Ÿä¼šé™ä½ã€‚ä½†æ˜¯é«˜å¯ç”¨æ¶æ„è®¾è®¡å°±æ˜¯è¦ä¿è¯æˆ‘ä»¬ä¸è¦æŠŠé¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œï¼Œè¿™æ ·ä¸€æ—¦æŸå¤„çš„æœåŠ¡å™¨å®•æœºï¼Œä½äºå…¶å®ƒä½ç½®çš„æœåŠ¡å™¨å¯ä»¥æ¥æ›¿ç»§ç»­æä¾›æœåŠ¡ã€‚</p><p>ES ä¸ºæˆ‘ä»¬æä¾›äº† CCR åŠŸèƒ½ï¼ˆè·¨é›†ç¾¤å¤åˆ¶ï¼ŒCross-cluster replicationï¼‰ï¼Œè¿™æ ·å¯ä»¥å°†ä¸»é›†ç¾¤çš„ç´¢å¼•åŒæ­¥åˆ°è¿œç¨‹çš„é›†ç¾¤ä½œä¸ºçƒ­å¤‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŸºäºåœ°ç†ä½ç½®ä½¿ç”¨å…¶å®ƒé›†ç¾¤æä¾›è¯»è¯·æ±‚ã€‚æ‰€æœ‰çš„å†™å…¥æ“ä½œéƒ½åœ¨ä¸»é›†ç¾¤å®Œæˆï¼Œå…¶å®ƒçš„å‰¯æœ¬é›†ç¾¤éƒ½æ˜¯åªè¯»çš„ Followersã€‚</p><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="https://pic2.zhimg.com/v2-f2d85b3f20fc985bf5b47c8927c2afcf.jpg" alt=""></p><h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><p>ç”Ÿäº§ç¯å¢ƒåˆ›å»ºç´¢å¼•æ¨¡æ¿ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">PUT /_template/km_server_warehouse_template</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"km_server_warehouse*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: &#123;</span><br><span class="line">      <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">        <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"znlp-coarse"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">            <span class="attr">"tokenizer"</span>: <span class="string">"znlp-fine"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="string">"1"</span>,</span><br><span class="line">      <span class="attr">"translog"</span>: &#123;</span><br><span class="line">        <span class="attr">"sync_interval"</span>: <span class="string">"5s"</span>,</span><br><span class="line">        <span class="attr">"durability"</span>: <span class="string">"async"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="string">"4"</span>,</span><br><span class="line">      <span class="attr">"similarity"</span>: &#123;</span><br><span class="line">        <span class="attr">"scripted_bm25"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"scripted"</span>,</span><br><span class="line">          <span class="attr">"script"</span>: &#123;</span><br><span class="line">            <span class="attr">"source"</span>: <span class="string">"double k1 = 1.2; double b = 0.75; double tfNorm = doc.freq * (k1 + 1) / (doc.freq + k1 * (1 - b + b * doc.length / (1.0 * field.sumTotalTermFreq/field.docCount))); return query.boost * tfNorm;"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"contents"</span>: &#123;</span><br><span class="line">      <span class="attr">"dynamic"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"content_basic"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">          <span class="attr">"properties"</span>: &#123;</span><br><span class="line">            <span class="attr">"sku_id"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"business_id"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"business_type"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"producer"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"svip_right"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"free"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"discount"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"instabook_right"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"free"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"discount"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"svip_privileges"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"title"</span>: &#123;</span><br><span class="line">              <span class="attr">"similarity"</span>: <span class="string">"scripted_bm25"</span>,</span><br><span class="line">              <span class="attr">"analyzer"</span>: <span class="string">"znlp-fine"</span>,</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"authors"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"right_list"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"serial_status"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"public_status"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"online_time"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"categories"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">              <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"id"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"level"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"weight"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"name"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">                  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">                    <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">                      <span class="attr">"ignore_above"</span>: <span class="number">256</span>,</span><br><span class="line">                      <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"name_en"</span>: &#123;</span><br><span class="line">                  <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">                  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">                    <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">                      <span class="attr">"ignore_above"</span>: <span class="number">256</span>,</span><br><span class="line">                      <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"is_test"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"content_aggregation"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">          <span class="attr">"properties"</span>: &#123;</span><br><span class="line">            <span class="attr">"interest_count"</span>: &#123;</span><br><span class="line">              <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"created_at"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"updated_at"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" target="_blank" rel="noopener">ES ä»‹ç»</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">Query DSL</a></li><li><a href="https://www.cnblogs.com/ningskyer/articles/5789010.html" target="_blank" rel="noopener">Elasticsearchç³»ç»Ÿæ¦‚å¿µåŠæ¶æ„å›¾</a></li><li><a href="https://blog.csdn.net/zx711166/article/details/81517178" target="_blank" rel="noopener">å€’æ’ç´¢å¼•</a></li><li><a href="https://elasticsearch.cn/article/711" target="_blank" rel="noopener">èŠèŠ ELASTICSEARCH çš„é›†ç¾¤çŠ¶æ€çš„ç®¡ç†å’Œç»´æŠ¤</a></li><li><a href="https://logz.io/learn/complete-guide-elk-stack/#intro" target="_blank" rel="noopener">THE COMPLETE GUIDE TO THE ELK STACK</a></li><li><a href="https://www.edureka.co/blog/elk-stack-tutorial/" target="_blank" rel="noopener">ELK Stack Tutorial â€“ Discover, Analyze And Visualize Your Data Efficiently</a></li><li><a href="https://www.shenyanchao.cn/blog/2018/12/04/lucene-bkd/" target="_blank" rel="noopener">Lucene BKDæ ‘-åŠ¨æ€ç£ç›˜ä¼˜åŒ–BSPæ ‘</a></li><li><a href="https://www.cnblogs.com/bigben0123/p/11274296.html" target="_blank" rel="noopener">èŠèŠ ES åˆ†ç‰‡ä¼˜åŒ–</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æœç´¢åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯åœ¨ App ä¸­è¿˜æ˜¯ç½‘ç«™ä¸­ã€‚æœç´¢æ¯æ—¶æ¯åˆ»éƒ½åœ¨å‘ç”Ÿï¼Œæ¯”å¦‚æœç´¢å–œæ¬¢çš„é›¶é£Ÿã€å¥½çœ‹çš„è¡£æœã€å–œæ¬¢çš„æ–‡ç« ã€æƒ³è¦å­¦ä¹ çš„è¯¾ç¨‹ç­‰ç­‰ã€‚å¦‚ä»Šè¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ æœç´¢å·²ç»éå¸¸å®¹æ˜“äº†ï¼Œæ—©æœŸæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MySQL çš„ MyISAM å­˜å‚¨å¼•æ“æ¥åšå…¨æ–‡æœ¬æœç´¢æ”¯æŒï¼Œä¸è¿‡ä»Šå¤©è¦è¯´çš„ Elasticsearch åŒæ ·å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ›´å¼ºå¤§ã€‚ç®€å•æ¥è¯´ï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œä¹Ÿæ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ ELK Stack æ ¸å¿ƒæˆå‘˜ã€‚å®ƒä»¥ JSON çš„æ ¼å¼å­˜å‚¨æ–‡æ¡£åˆ°ç´¢å¼•å½“ä¸­ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å¤šç§ç±»å‹ï¼Œå¹¶æä¾›å¿«é€Ÿæœç´¢çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼Œæ•´ä¸ª ELK Stack ç”Ÿæ€éå¸¸å®Œå–„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Elasticsearch" scheme="/categories/Elasticsearch/"/>
    
    
      <category term="Elasticsearch" scheme="/tags/Elasticsearch/"/>
    
      <category term="ELK" scheme="/tags/ELK/"/>
    
      <category term="æœç´¢å¼•æ“" scheme="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/"/>
    
  </entry>
  
  <entry>
    <title>å¿«é€’ç½‘ç‚¹æŠ“å–æ‚è®°</title>
    <link href="/2019/12/29/craw-dilivery-network-distribution/"/>
    <id>/2019/12/29/craw-dilivery-network-distribution/</id>
    <published>2019-12-29T05:02:30.000Z</published>
    <updated>2020-01-01T04:34:08.208Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åº”æ±‚å¼€å‘ä¸€ä¸ªç®€å•çš„çˆ¬è™«ï¼Œç”¨äºä»<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">å¿«é€’ 100</a> æŠ“å–å¿«é€’ç½‘ç‚¹çš„åˆ†å¸ƒï¼Œè¾“å…¥çœä»½+åŸå¸‚+åŒºå¿ï¼Œç„¶åæ˜¯å¿«é€’å…¬å¸åç§°ï¼ŒæŠ“å–å…¶å¯¹åº”çš„å¿«é€’ç½‘ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€åœ°å€ã€ç”µè¯ã€åæ ‡ç­‰ï¼‰ã€‚è¯´èµ·æ¥ï¼Œå¼€å‘è¿™æ ·ä¸€ä¸ªç®€å•çš„çˆ¬è™«å…¶å®æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆæ²¡æœ‰æ—¶é—´è¦æ±‚ã€ä¸éœ€è¦åˆ†å¸ƒå¼æŠ“å–ã€æ²¡ä»€ä¹ˆååçˆ¬ç­–ç•¥åŠ æŒç­‰ï¼‰ï¼Œä¸è¿‡è¿™æœŸé—´ä¹Ÿé‡åˆ°ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸‹ã€‚</p><p>å¦å¤–å°±æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦äº† <a href="https://pyecharts.org/#/zh-cn/geography_charts" target="_blank" rel="noopener">pyecharts</a> è¿™ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨èµ·æ¥è¿˜æŒºæ–¹ä¾¿çš„ã€‚æ ·å¼é…ç½®å¥½ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥å¾ˆå¥½çš„è§†è§‰å†²å‡»çš„ï¼å½“ç„¶ï¼Œå…³é”®æ˜¯åˆ©ç”¨è¿™ç§å·¥å…·æœ‰åŠ©äºå¢åŠ å¯¹æŠ“å–æ•°æ®çš„ç†è§£ï¼ˆçœ‹å…·ä½“éœ€è¦çš„åˆ†æç»´åº¦äº†ï¼‰ã€‚</p><a id="more"></a><p>æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œè™½ç„¶å®šä½æŸäº›å…ƒç´ çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œå†™ XPath è¡¨è¾¾å¼ä¹Ÿæ¯”è¾ƒæ¯ç‡¥ï¼ˆä¸è¦æŒ‡æœ›æµè§ˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„ XPathï¼Œé€šå¸¸éƒ½ä¸å¤Ÿé€šç”¨ï¼‰ã€‚ä½†æ˜¯å®Œæˆæ•´ä¸ªä»»åŠ¡åï¼Œè¿˜æ˜¯æœ‰äº›æ”¶è·çš„ã€‚ä¸‹é¢å¼€å§‹å§~</p><h1 id="ç¡®å®šæ–¹æ¡ˆ"><a href="#ç¡®å®šæ–¹æ¡ˆ" class="headerlink" title="ç¡®å®šæ–¹æ¡ˆ"></a>ç¡®å®šæ–¹æ¡ˆ</h1><h2 id="å°è¯•-API-ç›´æ¥è·å–"><a href="#å°è¯•-API-ç›´æ¥è·å–" class="headerlink" title="å°è¯• API ç›´æ¥è·å–"></a>å°è¯• API ç›´æ¥è·å–</h2><p>å¿«é€’ 100 å¯¹å¤–å…¬å¼€çš„ API æ–‡æ¡£<a href="https://www.kuaidi100.com/openapi/cloud_api.shtml" target="_blank" rel="noopener">åœ¨æ­¤</a>ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¼€æ”¾ç½‘ç‚¹æŸ¥è¯¢çš„æ¥å£ï¼Œæ•…æ— æ³•ä½¿ç”¨ã€‚<em>ç›´æ¥é€šè¿‡ API æŸ¥è¯¢æ˜¯æœ€çœå¿ƒçš„æ–¹å¼ï¼Œä½†æ˜¯ç›®å‰è¿™æ¡è·¯è¡Œä¸é€š</em>ã€‚</p><h2 id="å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨-API-è¯·æ±‚"><a href="#å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨-API-è¯·æ±‚" class="headerlink" title="å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨ API è¯·æ±‚"></a>å°è¯•åˆ†æç½‘é¡µè¯·æ±‚ï¼Œé—´æ¥ä½¿ç”¨ API è¯·æ±‚</h2><p>ç½‘ç‚¹æŸ¥è¯¢çš„<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">ä¸»é¡µ</a>ï¼Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„åŸå¸‚å’Œå¿«é€’å…¬å¸ï¼Œé¡µé¢å†…å®¹è‡ªåŠ¨åˆ‡æ¢ã€‚æ­¤æ—¶ï¼Œè¿˜æ˜¯å°è¯•åˆ†æå…¶ API è¯·æ±‚ï¼Œå› ä¸ºè¿™ä¸ªé€šå¸¸æ˜¯æŠ“å–ç½‘ç«™æœ€ç®€å•çš„æ–¹å¼ã€‚</p><p>æ‰“å¼€ Chrome æµè§ˆå™¨çš„è°ƒè¯•æ¨¡å¼ï¼Œé€šè¿‡ç‚¹å‡»é¡µé¢ä¸Šçš„ç­›é€‰é¡¹ï¼ŒæŸ¥çœ‹ç½‘ç»œè¯·æ±‚ï¼Œç¡®å®šè¯·æ±‚äº†ä»€ä¹ˆæ¥å£ï¼Œä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè¿”å›çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œä»è€Œèƒ½å¤Ÿæ¨¡æ‹Ÿå…¶è¯·æ±‚æ–¹å¼æ¥è·å–æ•°æ®ã€‚æ¥ä¸‹æ¥æ¼”ç¤ºçš„æ˜¯æŸ¥è¯¢ä¸Šæµ·åœ°åŒºçš„æŸå¿«é€’å…¬å¸çš„ç½‘ç‚¹ã€‚</p><p>æˆªå›¾ 1ï¼šè¯·æ±‚æ–¹å¼ä¸º POSTï¼ŒURL ä¸º <code>www.kuaidi100.com/network/searchapi.do</code><br><img src="https://pic4.zhimg.com/80/v2-5e4a1966207a0722b6027de8c59575fa.png" alt=""></p><p>æˆªå›¾ 2ï¼šä»¥è¡¨å•çš„å½¢å¼ï¼Œæäº¤äº†è¯·æ±‚çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯é¡µé¢ç‚¹å‡»çš„ç­›é€‰é¡¹ã€‚<br><img src="https://pic4.zhimg.com/80/v2-68027253f03f285b193cbede8deff551.png" alt=""></p><p>æˆªå›¾ 3ï¼šå½“å®Œæˆè¯·æ±‚åï¼Œå¯ä»¥çœ‹åˆ°å…¶è¿”å›ç»“æœä¸º JSON ç»“æ„ï¼Œå…¶ä¸­çš„ <code>netList</code> æ­£æ˜¯æƒ³è¦æ‰¾çš„ç½‘ç‚¹æ•°æ®ã€‚<br><img src="https://pic4.zhimg.com/80/v2-e0a0299c70020102ca4f261123572f1a.png" alt=""></p><h2 id="å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–"><a href="#å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–" class="headerlink" title="å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–"></a>å°è¯•åˆ†æç½‘é¡µç»“æ„ï¼Œé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŠ“å–</h2><p>ä¸€èˆ¬åœ¨è¿›è¡Œç½‘ç«™æ•°æ®æŠ“å–æ—¶ï¼Œèƒ½é€šè¿‡å…¶ API è·å–ï¼Œå°±å°½å¯èƒ½å»åˆ©ç”¨ã€‚ä½¿ç”¨ API è¯·æ±‚æ•°æ®çš„å¥½å¤„æœ‰è¿™ä¹ˆå‡ ç‚¹ï¼š</p><ol><li>çœå»äº†åˆ†æç½‘é¡µ HTML ç»“æ„çš„æ—¶é—´ï¼Œå¯ä»¥ç›´æ¥è§£ææ¥å£è¿”å›çš„æ•°æ®ï¼Œæå–æƒ³è¦çš„ä¿¡æ¯å¹¶å­˜å‚¨å³å¯ï¼›</li><li>API è¯·æ±‚æ–¹å¼æœ€ä¸ºç®€å•å¯é çµæ´»ï¼Œä¸”èƒ½é€‚åº”è¾ƒé«˜çš„æŠ“å–é¢‘ç‡ï¼›</li><li>ç›¸å¯¹äºåˆ†æç½‘é¡µ HTML ç»“æ„ï¼Œæå–ä¿¡æ¯çš„æ–¹å¼ï¼ŒAPI æŠ“å–é€šå¸¸ä¸ç”¨åƒæ‹…å¿ƒå‰ç«¯é¡µé¢é¢‘ç¹æ”¹ç‰ˆè€Œå¯¼è‡´çˆ¬è™«ç¨‹åºä¹Ÿè¦å³ä½¿æ›´æ–°çš„å›°å¢ƒï¼Œæ–¹ä¾¿ç»´æŠ¤ã€‚</li></ol><p>ä¸è¿‡åªæ˜¯é€šè¿‡ API æ¥æŠ“å–ï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œåœ¨ Selenium çš„å¸®åŠ©ä¸‹ï¼Œä»¥å¯è§†åŒ–çš„æ–¹å¼æŠ“å–é¡µé¢è²Œä¼¼æ›´æœ‰è¶£ç‚¹ã€‚è¿™é‡Œçš„æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å®‰è£… Selenium + Chrome Web Driverï¼Œé€šè¿‡æ“çºµæµè§ˆå™¨æ¨¡æ‹Ÿäººç±»è®¿é—®é¡µé¢çš„æ–¹å¼æ¥æŠ“å–æ•°æ®ï¼›</li><li>ç¼–å†™çˆ¬è™«ç¨‹åºï¼Œæ§åˆ¶æµè§ˆå™¨æ‰“å¼€ç½‘ç‚¹æŸ¥è¯¢çš„é¦–é¡µï¼š<a href="https://www.kuaidi100.com/network/" target="_blank" rel="noopener">https://www.kuaidi100.com/network/</a></li><li>æ¥æ”¶è¾“å…¥çš„åŸå¸‚å’Œå¿«é€’å…¬å¸åç§°ä½œä¸ºå‚æ•°ï¼Œç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»ä¸‹æ‹‰æ¡†ï¼Œé€‰æ‹©åŸå¸‚ï¼›ç„¶åæ“çºµæµè§ˆå™¨ç‚¹å‡»æŒ‡å®šçš„å¿«é€’å…¬å¸ï¼›</li><li>æ¥ä¸‹æ¥å¼€å§‹è§£æé¡µé¢ç»“æ„ï¼Œæå–å¿«é€’ç½‘ç‚¹æ•°æ®è½¬æ¢ä¸º JSON æ ¼å¼ï¼ˆåœ°ç†ä½ç½®åæ ‡é€šè¿‡ç™¾åº¦åœ°å›¾ API è·å¾—ï¼‰ï¼Œå­˜å‚¨åœ¨æŒ‡å®šè·¯å¾„ä¸‹ï¼›ç„¶åä¸æ–­æ§åˆ¶æµè§ˆå™¨ç¿»é¡µï¼Œå®Œæˆå‰©ä½™é¡µé¢è§£æï¼Œè‡³æ­¤å¯¹åº”çš„ç½‘ç‚¹ä¿¡æ¯æŠ“å–å®Œæˆã€‚</li></ol><h1 id="å‡†å¤‡å¼€å‘ç¯å¢ƒ"><a href="#å‡†å¤‡å¼€å‘ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡å¼€å‘ç¯å¢ƒ"></a>å‡†å¤‡å¼€å‘ç¯å¢ƒ</h1><ol><li>Python 3.7 ç¯å¢ƒï¼›</li><li><a href="https://pypi.org/project/selenium/" target="_blank" rel="noopener">selenium-python</a>ï¼Œå…¶ä½¿ç”¨æ–‡æ¡£å‚è€ƒ<a href="https://selenium-python-zh.readthedocs.io/en/latest/getting-started.html" target="_blank" rel="noopener">æ­¤å¤„</a>ï¼›</li><li><a href="http://npm.taobao.org/mirrors/chromedriver/" target="_blank" rel="noopener">chromedriver</a> ä¸‹è½½ï¼Œå¹¶è§£å‹å¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼›</li><li>Anaconda ç¯å¢ƒå®‰è£…ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯ Jupter Notebook èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼›</li><li>ä¾èµ–çš„é‡è¦ Python åŒ…å®‰è£…ï¼š<ul><li>pyecharts</li><li>echarts-countries-pypkg </li><li>echarts-china-provinces-pypkg </li><li>echarts-china-cities-pypkg </li><li>echarts-china-counties-pypkg </li><li>echarts-china-misc-pypkg</li><li>requests</li></ul></li><li>è®°å¾—å®‰è£… Chrome æµè§ˆå™¨ã€‚</li></ol><h1 id="é¡µé¢å…³é”®å…ƒç´ å®šä½"><a href="#é¡µé¢å…³é”®å…ƒç´ å®šä½" class="headerlink" title="é¡µé¢å…³é”®å…ƒç´ å®šä½"></a>é¡µé¢å…³é”®å…ƒç´ å®šä½</h1><p>æ ¹æ®ä¸Šè¿°æŠ“å–æ€è·¯ï¼Œéœ€è¦åšçš„æ˜¯å®šä½ä¸€äº›å…³é”®å…ƒç´ ï¼Œå¹¶ä¸”èƒ½å¤Ÿä» HTML ä¸­æŠ½å–å‡ºéœ€è¦çš„ä¿¡æ¯ã€‚é¡µé¢å…ƒç´ å®šä½ï¼Œéœ€è¦äº†è§£ä¸‹ <a href="https://www.w3school.com.cn/xpath/xpath_syntax.asp" target="_blank" rel="noopener">XPath</a> è¯­æ³•ï¼Œæ‘˜å–æƒ³è¦çš„å…ƒç´ ã€‚</p><p><em>å°æŠ€å·§ï¼Œå¯ä»¥åœ¨ Chrome æ§åˆ¶å°é€šè¿‡ <code>$x(&#39;xpath-expression&#39;)</code> éªŒè¯é€‰æ‹©å™¨æ˜¯å¦æ­£å¸¸ï¼š</em><br><img src="https://pic4.zhimg.com/80/v2-7349b600693e94c344c2246ad63c1548.png" alt=""></p><ul><li><p>çœä»½é€‰æ‹©ä¸‹æ‹‰æ¡†å…ƒç´  id ä¸º <code>provinceSelect</code>ï¼š<br>  <img src="https://pic4.zhimg.com/80/v2-bac9ebd7eb25c1b40feaff8d07ef3396.png" alt=""></p></li><li><p>å®šä½çœä»½ä½ç½®ï¼ˆæ‹·è´å…¶ XPATHï¼‰<br>  <img src="https://pic1.zhimg.com/80/v2-5273d05981d0d6e9b4d611ea5408f785.png" alt=""></p></li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å…¶å®ƒå…³é”®å…ƒç´ ç¡®å®šæ–¹å¼ç±»ä¼¼ï¼Œä¸»è¦ä»¥ XPath çš„æ–¹å¼æŸ¥æ‰¾ã€‚å¾—åˆ°æœ€ç»ˆéœ€è¦çš„ XPath è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XPathExpression</span>:</span></span><br><span class="line">    <span class="comment"># çœä»½ä¸‹æ‹‰æ¡† Tab</span></span><br><span class="line">    PROVINCE_TAB = <span class="string">'//*[@id="provinces"]/div/ul/li[2]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªçœä»½</span></span><br><span class="line">    PROVINCE_ITEM = <span class="string">'//*[contains(@class, "place province") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªåŸå¸‚</span></span><br><span class="line">    CITY_ITEM = <span class="string">'//*[contains(@class, "place city") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å…·ä½“æŸä¸ªåŒºå¿</span></span><br><span class="line">    COUNTY_ITEM = <span class="string">'//*[contains(@class, "place county") and contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># å³ä¾§æŸ¥è¯¢æŒ‰é’®</span></span><br><span class="line">    QUERY_BUTTON = <span class="string">'//*[contains(@class, "btn-query")]'</span></span><br><span class="line">    <span class="comment"># å¿«é€’å…¬å¸é€‰æ‹©</span></span><br><span class="line">    PROVIDER_ITEM = <span class="string">'//ul[@id="companyCount"]/li/*[contains(text(), "&#123;&#125;")]'</span></span><br><span class="line">    <span class="comment"># ä¸‹ä¸€é¡µ</span></span><br><span class="line">    NEXT_PAGE_BUTTON = <span class="string">'//*[contains(@class, "page-down-active")]'</span></span><br><span class="line">    <span class="comment"># é¡µé¢ä¸­çš„å¿«é€’å…¬å¸ä¿¡æ¯æ¡ç›®</span></span><br><span class="line">    QUERY_ITEMS = <span class="string">'//*[@id="queryResult"]/dl'</span></span><br></pre></td></tr></table></figure><h1 id="å†™ä»£ç "><a href="#å†™ä»£ç " class="headerlink" title="å†™ä»£ç "></a>å†™ä»£ç </h1><p><code>main</code> å‡½æ•°æ˜¯å…³é”®å…¥å£ï¼Œå®ƒä¼šè°ƒç”¨çˆ¬è™«ç±»æœç´¢æŒ‡å®šä½ç½®æŒ‡å®šå…¬å¸çš„å¿«é€’ç½‘ç‚¹ä¿¡æ¯ï¼Œå¹¶å°†è¿”å›çš„æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„è·¯å¾„ä¸‹ï¼Œä½¿ç”¨ <code>json line</code> æ ¼å¼ï¼ˆå³æ¯ä¸€è¡Œéƒ½æ˜¯ json æ ¼å¼å­—ç¬¦ä¸²ï¼‰å­˜å‚¨ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(province, city, provider=<span class="string">'å…¨éƒ¨'</span>)</span>:</span></span><br><span class="line">    spider = DeliveryNetworkSpider(</span><br><span class="line">        driver_path=os.path.join(PROJECT_DIR, <span class="string">'dep/mac/chromedriver'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = spider.search(province=province, city=city, provider=provider)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">        print(err)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            print(result)</span><br><span class="line">            store_result(os.path.join(PROJECT_DIR, <span class="string">'results'</span>, <span class="string">f'<span class="subst">&#123;province&#125;</span>-<span class="subst">&#123;city&#125;</span>-<span class="subst">&#123;provider&#125;</span>.jl'</span>), result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        spider.close()</span><br></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒçˆ¬è™«ç±»"><a href="#æ ¸å¿ƒçˆ¬è™«ç±»" class="headerlink" title="æ ¸å¿ƒçˆ¬è™«ç±»"></a>æ ¸å¿ƒçˆ¬è™«ç±»</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeliveryNetworkSpider</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""åŸºäºå¿«é€’ 100 çš„å¿«é€’ç½‘ç‚¹æŸ¥è¯¢çˆ¬è™«</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, driver_path)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–å¿«é€’ç½‘ç‚¹çˆ¬è™«ï¼Œå…³é”®å‚æ•°æ˜¯è¦æŒ‡å®š webdriver è·¯å¾„ï¼Œå¦åˆ™</span></span><br><span class="line"><span class="string">        æ— æ³•æ§åˆ¶æµè§ˆå™¨è¿›è¡Œæ¨¡æ‹ŸæŸ¥è¯¢ã€‚å½“å‰ä»…æ”¯æŒ Chrome æµè§ˆå™¨ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param driver_path: é»˜è®¤æ˜¯ Mac ç‰ˆæœ¬æ‰€åœ¨çš„è·¯å¾„ï¼Œå¦‚æœæ˜¯ win</span></span><br><span class="line"><span class="string">                ç‰ˆæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># Windows ä¸‹éœ€è¦æ›¿æ¢æˆå¯¹åº”çš„ chromedriverï¼Œå¯ä»¥åœ¨ dep ç›®å½•ä¸‹æ–°å»º win</span></span><br><span class="line">        <span class="comment"># ç›®å½•ï¼Œå°† windows ç‰ˆæœ¬çš„æ”¾åˆ°ç›®å½•ä¸‹ï¼Œå¹¶ä¿®æ”¹ mac-&gt;win</span></span><br><span class="line">        self._driver = webdriver.Chrome(executable_path=driver_path)</span><br><span class="line">        self._driver.implicitly_wait(<span class="number">10</span>)  <span class="comment"># éšå¼ç­‰å¾…å…ƒç´ å‡ºç°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._driver.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, province, city, county=<span class="string">'æš‚ä¸é€‰æ‹©'</span>, provider=<span class="string">'å…¨éƒ¨'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""æ‰§è¡Œç½‘ç‚¹æŸ¥è¯¢çš„æ ¸å¿ƒæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param province: çœä»½ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰</span></span><br><span class="line"><span class="string">        :param city: åŸå¸‚ï¼ˆä¸€å®šè¦æ˜¯å¿«é€’ 100 ä¸Šæœ‰çš„åå­—ï¼‰</span></span><br><span class="line"><span class="string">        :param county: åŒºå¿ï¼Œé»˜è®¤ä¸ºå…¨éƒ¨åŒºå¿</span></span><br><span class="line"><span class="string">        :param provider: å¿«é€’æœåŠ¡å•†åå­—ï¼Œä¸ä¼ åˆ™æŸ¥è¯¢æ‰€æœ‰å¿«é€’å…¬å¸</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._open_home_page()</span><br><span class="line">        self._select_location(province, city, county)</span><br><span class="line">        self._select_provider(provider)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> self._parse_page(province, city)</span><br><span class="line">            <span class="keyword">if</span> self._has_next_page():</span><br><span class="line">                time.sleep(<span class="number">.5</span>)  <span class="comment"># é˜²æ­¢ç¿»é¡µå¤ªå¿«è¢«æŠ“åˆ°</span></span><br><span class="line">                self._visit_next_page()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_open_home_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._driver.get(<span class="string">'https://www.kuaidi100.com/network/'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_select_location</span><span class="params">(self, province, city, county)</span>:</span></span><br><span class="line">        <span class="comment"># æ‰¾åˆ°è¾“å…¥ä¸‹æ‹‰æ¡†ä½ç½®</span></span><br><span class="line">        elem = self._driver.find_element_by_id(<span class="string">'provinceSelect'</span>)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä½é€‰æ‹©çœä»½ Tab</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.PROVINCE_TAB)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¥ä¸‹æ¥é€‰æ‹©çœä»½</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.PROVINCE_ITEM.format(province))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç´§æ¥ç€é€‰æ‹©åŸå¸‚</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.CITY_ITEM.format(city))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€‰æ‹©æ‰€æœ‰åŒºåŸŸ</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.COUNTY_ITEM.format(county))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä½åˆ°æŸ¥è¯¢æŒ‰é’®ï¼Œå¹¶ç‚¹å‡»æŸ¥è¯¢è·³è½¬é¡µé¢</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.QUERY_BUTTON)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_select_provider</span><span class="params">(self, provider)</span>:</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(</span><br><span class="line">            XPathExpression.PROVIDER_ITEM.format(provider))</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_has_next_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON)</span><br><span class="line">        <span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_visit_next_page</span><span class="params">(self)</span>:</span></span><br><span class="line">        elem = self._driver.find_element_by_xpath(XPathExpression.NEXT_PAGE_BUTTON)</span><br><span class="line">        self.__highlight(elem)</span><br><span class="line">        elem.click()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__highlight</span><span class="params">(self, elem)</span>:</span></span><br><span class="line">        <span class="string">"""é«˜äº®æ“ä½œçš„å…ƒç´ """</span></span><br><span class="line">        self._driver.execute_script(</span><br><span class="line">            <span class="string">"arguments[0].setAttribute('style',arguments[1]);"</span>,</span><br><span class="line">            elem,</span><br><span class="line">            <span class="string">"outline:2px solid red;"</span>)</span><br><span class="line">        time.sleep(<span class="number">.2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_parse_page</span><span class="params">(self, province, city)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            elements = self._driver.find_elements_by_xpath(XPathExpression.QUERY_ITEMS)</span><br><span class="line">        <span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> el <span class="keyword">in</span> elements:</span><br><span class="line">                <span class="keyword">yield</span> self._extract(el.text, province, city)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_extract</span><span class="params">(text, province, city)</span>:</span></span><br><span class="line">        item = dict(</span><br><span class="line">            province=province,</span><br><span class="line">            city=city,</span><br><span class="line">            name=<span class="string">''</span>,  <span class="comment"># åç§°</span></span><br><span class="line">            address=<span class="string">''</span>,  <span class="comment"># åœ°å€</span></span><br><span class="line">            contact_phone=<span class="string">''</span>,  <span class="comment"># è”ç³»ç”µè¯</span></span><br><span class="line">            pickup_phone=<span class="string">''</span>,  <span class="comment"># å–ä»¶ç”µè¯</span></span><br><span class="line">            check_phone=<span class="string">''</span>,  <span class="comment"># æŸ¥ä»¶ç”µè¯</span></span><br><span class="line">            complaint_phone=<span class="string">''</span>,  <span class="comment"># æŠ•è¯‰ç”µè¯</span></span><br><span class="line">            location=dict(</span><br><span class="line">                lng=<span class="number">0.0</span>,  <span class="comment"># ç»åº¦</span></span><br><span class="line">                lat=<span class="number">0.0</span>,  <span class="comment"># çº¬åº¦</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–å‡ºçº¯æ–‡æœ¬åæ¢è¡Œè§£æ</span></span><br><span class="line">        lines = [l.strip() <span class="keyword">for</span> l <span class="keyword">in</span> text.splitlines() <span class="keyword">if</span> l.strip()]</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__</span><span class="params">(k)</span>:</span></span><br><span class="line">            r = [l <span class="keyword">for</span> l <span class="keyword">in</span> lines <span class="keyword">if</span> l.startswith(k)]</span><br><span class="line">            <span class="keyword">return</span> r[<span class="number">0</span>].replace(k, <span class="string">''</span>) <span class="keyword">if</span> r <span class="keyword">else</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        item[<span class="string">'name'</span>] = lines[<span class="number">0</span>]</span><br><span class="line">        item[<span class="string">'address'</span>] = __(<span class="string">'å…¬å¸åœ°å€ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'contact_phone'</span>] = __(<span class="string">'è”ç³»ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'pickup_phone'</span>] = __(<span class="string">'å–ä»¶ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'check_phone'</span>] = __(<span class="string">'æŸ¥ä»¶ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'complaint_phone'</span>] = __(<span class="string">'æŠ•è¯‰ç”µè¯ï¼š'</span>)</span><br><span class="line">        item[<span class="string">'location'</span>] = get_location(</span><br><span class="line">            item[<span class="string">'address'</span>], city=<span class="string">u"&#123;&#125;&#123;&#125;"</span>.format(province, city))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure><h2 id="åæ ‡æŸ¥è¯¢"><a href="#åæ ‡æŸ¥è¯¢" class="headerlink" title="åæ ‡æŸ¥è¯¢"></a>åæ ‡æŸ¥è¯¢</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">BASE_API = <span class="string">'http://api.map.baidu.com'</span></span><br><span class="line">LOCATION_API = <span class="string">'/geocoding/v3/?address=&#123;&#125;&amp;city=&#123;&#125;&amp;output=json&amp;ak=&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢</span></span><br><span class="line"><span class="meta">@filecache(YEAR)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_location</span><span class="params">(addr, city=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æ–‡æ¡£å‚è€ƒï¼šhttp://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr:</span><br><span class="line">        <span class="keyword">return</span> dict(lng=<span class="number">0.0</span>, lat=<span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    url = _get_query_url(LOCATION_API.format(addr, city, AK))</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    result = r.json()</span><br><span class="line">    <span class="keyword">assert</span> result[<span class="string">'status'</span>] == <span class="number">0</span>, <span class="string">u"è·å–ç»çº¬åº¦ä¿¡æ¯å¤±è´¥ï¼è¯·æ±‚ï¼š&#123;&#125;ï¼Œè¿”å›ç»“æœï¼š&#123;&#125;"</span>.format(url, result)</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">'result'</span>][<span class="string">'location'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_query_url</span><span class="params">(query_str)</span>:</span></span><br><span class="line">    query_str = query_str.replace(<span class="string">'#'</span>, <span class="string">''</span>)  <span class="comment"># å»é™¤ç‰¹æ®Šå­—ç¬¦</span></span><br><span class="line">    <span class="comment"># å¯¹ query_str è¿›è¡Œè½¬ç ï¼Œsafe å†…çš„ä¿ç•™å­—ç¬¦ä¸è½¬æ¢</span></span><br><span class="line">    qs = quote(query_str, safe=<span class="string">"/:=&amp;?#+!$,;'@()*[]"</span>)</span><br><span class="line">    sn = hashlib.md5(quote_plus(qs + SK).encode(<span class="string">'utf8'</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> BASE_API + query_str + <span class="string">f'&amp;sn=<span class="subst">&#123;sn&#125;</span>'</span></span><br></pre></td></tr></table></figure><h1 id="æ§åˆ¶æŠ“å–æ•°æ®"><a href="#æ§åˆ¶æŠ“å–æ•°æ®" class="headerlink" title="æ§åˆ¶æŠ“å–æ•°æ®"></a>æ§åˆ¶æŠ“å–æ•°æ®</h1><p>æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯æŠ“å–ä¸­é€šå¿«é€’åœ¨åŒ—äº¬å„ä¸ªåœ°åŒºçš„ç½‘ç‚¹ã€‚å¯åŠ¨åï¼Œä¼šé€šè¿‡ Selenuium æ§åˆ¶ Chrome æµè§ˆå™¨è®¿é—®æŸ¥è¯¢ç½‘ç«™ï¼Œå¹¶ç‚¹å‡»å¯¹åº”çš„å…ƒç´ ï¼Œå®Œæˆæ•°æ®çš„æŠ“å–ã€‚</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main(province=<span class="string">'åŒ—äº¬'</span>, city=<span class="string">'åŒ—äº¬'</span>, provider=<span class="string">'ä¸­é€š'</span>)</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªå·¥ä½œè¿‡ç¨‹æ¼”ç¤ºå‚è§ <a href="https://pan.baidu.com/s/1HD_fwdNHZqr1k1w3vzWyMQ" target="_blank" rel="noopener">ç™¾åº¦ç½‘ç›˜ï¼ˆæå–ç : kaunï¼‰</a>ã€‚æŠ“å–åˆ°çš„æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic3.zhimg.com/80/v2-16533f8a8c8f62a9433df19e188dd305.png" alt=""></p><h1 id="ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾"><a href="#ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾" class="headerlink" title="ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾"></a>ç»˜åˆ¶ç®€å•çš„çƒ­ç‚¹åœ°å›¾</h1><p>è¿™é‡Œå°±éœ€è¦ä½¿ç”¨å…³é”®çš„ <a href="https://pyecharts.org/" target="_blank" rel="noopener">pyecharts</a> äº†ï¼Œå…·ä½“æ€ä¹ˆå®‰è£…å’Œé…ç½®å°±ä¸å¤šè¯´äº†ï¼Œå®ƒæœ‰éå¸¸å®Œå–„çš„ä¸­æ–‡æ–‡æ¡£ï¼Œä»¥åŠä¸€äº› Demo å¯ä»¥å­¦ä¹ ã€‚ä»¥ä¸‹å°±æ˜¯åˆ©ç”¨ä¸Šè¿°æŠ“åˆ°çš„æ•°æ®ï¼Œåšä¸ªç®€å•çš„æ¼”ç¤ºï¼Œçœ‹çœ‹è¿™äº›å¿«é€’ç½‘ç‚¹çš„å…·ä½“åˆ†å¸ƒçƒ­ç‚¹æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦åˆ‡æ¢åˆ°çˆ¬è™«ç›®å½•ä¸‹ï¼Œå¹¶å¯åŠ¨ Jupter Notebookï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd path/to/kuaidi100/src</span><br><span class="line">jupter notebook # å¯åŠ¨æœåŠ¡</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ï¼Œé€‰æ‹© <code>src/heatmap.ipynb</code> æ–‡ä»¶æ‰“å¼€ï¼š<br><img src="https://pic2.zhimg.com/80/v2-af251174caa70eb0ca1f9285db7423ef.png" alt=""></p><p>èœå•æ  <code>Cell-&gt;Run All</code> æ‰§è¡Œæ‰€æœ‰ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç®€å•çš„çƒ­ç‚¹åœ°å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://pic4.zhimg.com/80/v2-1c41db550a36616d2df8808bfaa61540.png" alt=""></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è‡³æ­¤ï¼Œæ•´ä¸ªæŠ˜è…¾çš„è¿‡ç¨‹å°±å®Œç»“å’¯ã€‚ä¸»è¦æ—¶é—´èŠ±è´¹åœ¨ç¡®å®šçˆ¬é‡çš„æ–¹æ¡ˆï¼Œä»¥åŠä½¿ç”¨çµæ´»çš„æ–¹å¼å®šä½å…ƒç´ ä¸Šã€‚åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œä¹Ÿé‡åˆ°ä¸€äº›å°é—®é¢˜ï¼Œå¹¶åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼š</p><ol><li>æ¯”å¦‚æŸäº›æƒ…å†µä¸‹å…ƒç´  <code>click</code> ä¼šå¤±è´¥ï¼Œè¿™æ—¶ä¸ºäº†ä¿è¯çˆ¬è™«çš„å¥å£®æ€§ï¼Œéœ€è¦åšå¼‚å¸¸æ•è·ï¼›é¡µé¢åŠ è½½æœªå®Œæˆæ—¶ï¼Œå¯èƒ½æ— æ³•æŸ¥æ‰¾åˆ°æŒ‡å®šå…ƒç´ ï¼Œå¯¼è‡´çˆ¬è™«ç¨‹åºæŒ‚äº†ï¼Œè¿™é‡Œå°±éœ€è¦é…ç½® Selenium éšå¼ç­‰å¾… 10sã€‚</li><li>ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿ Selenium æ­£åœ¨æ“çºµçš„å…ƒç´ ï¼Œè¿™é‡Œå€ŸåŠ©äº† <code>driver.execute_script()</code> çš„æ–¹å¼ç»™é€‰ä¸­çš„å…ƒç´ æ·»åŠ çº¢è‰²è¾¹æ¡†ã€‚</li><li>å¦å¤–ï¼Œè€ƒè™‘åˆ°çˆ¬å–é¢‘ç‡è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´è§¦å‘åçˆ¬ç­–ç•¥ï¼Œè¿™é‡Œç®€å•åšäº†å»¶è¿Ÿç­‰å¾…ï¼ˆ<code>time.sleep()</code>ï¼‰ã€‚</li></ol><p>æ•´ä½“è€Œè¨€ï¼Œå†™å¾—æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±ç®€å•è®°å½•ä¸‹ã€‚å®Œæ•´çš„ä»£ç ä»“åº“å‚è§ï¼š<a href="https://gitee.com/ifaceless/kuaidi100-spider" target="_blank" rel="noopener">kuaidi100-spider</a>ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://pyecharts.org/#/zh-cn/geography_charts" target="_blank" rel="noopener">pyecharts åœ°ç†å›¾æ ‡æ–‡æ¡£</a></li><li><a href="https://blog.csdn.net/qq_31362537/article/details/90667814" target="_blank" rel="noopener">pyecharts åœ¨åœ°å›¾ä¸Šæ ¹æ®ç»çº¬åº¦å’Œé‡å€¼ï¼Œç”»å‡ºæ•£ç‚¹å›¾/çƒ­åŠ›å›¾</a></li><li><a href="http://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding" target="_blank" rel="noopener">ç™¾åº¦åœ°å›¾æ–‡æ¡£</a></li><li><a href="https://www.w3school.com.cn/xpath/xpath_syntax.asp" target="_blank" rel="noopener">XPath è¯­æ³•</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åº”æ±‚å¼€å‘ä¸€ä¸ªç®€å•çš„çˆ¬è™«ï¼Œç”¨äºä»&lt;a href=&quot;https://www.kuaidi100.com/network/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å¿«é€’ 100&lt;/a&gt; æŠ“å–å¿«é€’ç½‘ç‚¹çš„åˆ†å¸ƒï¼Œè¾“å…¥çœä»½+åŸå¸‚+åŒºå¿ï¼Œç„¶åæ˜¯å¿«é€’å…¬å¸åç§°ï¼ŒæŠ“å–å…¶å¯¹åº”çš„å¿«é€’ç½‘ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€åœ°å€ã€ç”µè¯ã€åæ ‡ç­‰ï¼‰ã€‚è¯´èµ·æ¥ï¼Œå¼€å‘è¿™æ ·ä¸€ä¸ªç®€å•çš„çˆ¬è™«å…¶å®æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡ï¼ˆæ²¡æœ‰æ—¶é—´è¦æ±‚ã€ä¸éœ€è¦åˆ†å¸ƒå¼æŠ“å–ã€æ²¡ä»€ä¹ˆååçˆ¬ç­–ç•¥åŠ æŒç­‰ï¼‰ï¼Œä¸è¿‡è¿™æœŸé—´ä¹Ÿé‡åˆ°ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œç‰¹æ­¤è®°å½•ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–å°±æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦äº† &lt;a href=&quot;https://pyecharts.org/#/zh-cn/geography_charts&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;pyecharts&lt;/a&gt; è¿™ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨èµ·æ¥è¿˜æŒºæ–¹ä¾¿çš„ã€‚æ ·å¼é…ç½®å¥½ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥å¾ˆå¥½çš„è§†è§‰å†²å‡»çš„ï¼å½“ç„¶ï¼Œå…³é”®æ˜¯åˆ©ç”¨è¿™ç§å·¥å…·æœ‰åŠ©äºå¢åŠ å¯¹æŠ“å–æ•°æ®çš„ç†è§£ï¼ˆçœ‹å…·ä½“éœ€è¦çš„åˆ†æç»´åº¦äº†ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Python" scheme="/categories/Python/"/>
    
    
      <category term="çˆ¬è™«" scheme="/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="Python" scheme="/tags/Python/"/>
    
      <category term="æ•°æ®å¯è§†åŒ–" scheme="/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£æ–‡ä»¶æè¿°ç¬¦ä¸æ–‡ä»¶å¥æŸ„</title>
    <link href="/2019/12/19/understand-file-descriptor-and-file-description/"/>
    <id>/2019/12/19/understand-file-descriptor-and-file-description/</id>
    <published>2019-12-19T05:26:37.000Z</published>
    <updated>2019-12-19T05:39:40.914Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨ã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹5.4 èŠ‚ï¼Œå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€çš„æ–‡ä»¶å…³ç³»æ˜¯è¿™æ ·æè¿°çš„ï¼šã€Œå†…æ ¸ä¸ºæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ç»´æŠ¤äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„<strong>æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸º<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>ï¼Œå¹¶å°†è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ç§°ä¸º<strong>æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰</strong>ã€‚è€Œé’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸åˆä¸ºå…¶ç»´æŠ¤äº†<strong>æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰</strong>ã€ã€‚</p><a id="more"></a><p><img src="https://pic4.zhimg.com/80/v2-3064b2743259ac1b79da998a595b7c3b.png" alt=""></p><p>åæ¥åœ¨è¿™ç¯‡æ–‡ç«  <a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a> ä¸­ï¼Œçœ‹åˆ°äº†è¿™æ ·çš„çš„æè¿°ï¼šã€Œç®€å•æ¥è¯´ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>ã€‚è¡¨ä¸­çš„æ¯ä¸€é¡¹æ˜¯struct fileç±»å‹ï¼ŒåŒ…å«äº†æ‰“å¼€æ–‡ä»¶çš„ä¸€äº›å±æ€§æ¯”å¦‚åç§»é‡ï¼Œè¯»å†™è®¿é—®æ¨¡å¼ç­‰ï¼Œè¿™æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ–‡ä»¶å¥æŸ„ã€ã€‚</p><p><img src="https://pic1.zhimg.com/80/v2-c315f6671cc7038e8199346a98d4e300.png" alt=""></p><p>é‚£ä¹ˆè¿™é‡Œæåˆ°çš„ã€Œæ‰“å¼€çš„æ–‡ä»¶è¡¨ã€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œæ€ä¹ˆåˆå˜æˆäº†æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰çš„å‘¢ï¼Ÿã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸­ä¸æ˜¯è¯´ã€Œæ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰ã€æ˜¯ç‹¬ç«‹äºè¿›ç¨‹çš„ç³»ç»Ÿçº§è¡¨å—ï¼Ÿæ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å›°æƒ‘å’ŒçŸ›ç›¾å‘¢ï¼Ÿ</p><p>ä¸ºäº†èƒ½å¤Ÿè§£ç­”å›°æƒ‘ï¼ŒåŠ æ·±å¯¹æ–‡ä»¶æè¿°ç¬¦çš„ç†è§£ï¼Œç‰¹åœ°æ·±æ‰’äº†ä¸‹ Linux å†…æ ¸çš„ç›¸å…³æºç ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ä¸Šæ–‡æåˆ°çš„<strong>æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ã€<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>ã€<strong>æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰</strong>è¿™ä¸‰ç§æŠ½è±¡çš„æ•°æ®ç»“æ„å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä»¥ä¾¿èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ä¹¦ä¸­çš„æ¦‚å¿µã€‚</p><h1 id="æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»"><a href="#æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»"></a>æ–‡ä»¶æè¿°ç¬¦ä¸æ‰“å¼€çš„æ–‡ä»¶å…³ç³»</h1><p>åœ¨åŒºåˆ†è¿™äº›æ¦‚å¿µå‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>open()</code> ç³»ç»Ÿè°ƒç”¨çš„ <code>man page</code> ä¸­æåˆ°çš„ä¸€æ®µè¯´æ˜ï¼š</p><blockquote><p>A call to open() creates a new <strong>open file description</strong>, an entry in the<br>system-wide <strong>table of open files</strong>. The open file description records<br>the file offset and the file status flags (see below). A <strong>file<br>descriptor</strong> is a reference to an open file description; this reference<br>is unaffected if pathname is subsequently removed or modified to<br>refer to a different fileâ€¦</p></blockquote><p>åœ¨çœ‹å®Œä¸Šé¢çš„ä»‹ç»åï¼Œç»“åˆã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹æåˆ°çš„åè¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½œå‡ºè¿™æ ·çš„æ˜ å°„ï¼š</p><ol><li>open file description: æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰ï¼Œå®ƒæ‰ä¼šå…³è”åˆ°çœŸæ­£åœ°æ–‡ä»¶ inode</li><li>table of open files: å°±æ˜¯ä¹¦ä¸­æåˆ°çš„ç³»ç»Ÿçº§æè¿°è¡¨ï¼ˆopen file tableï¼‰</li><li>file descriptor: å…¶å®å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹æ–‡ä»¶å¥æŸ„çš„å¼•ç”¨</li></ol><p>å¥½å•¦ï¼Œä¸‹é¢æ¥çœ‹çœ‹ä¸æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„å®ç°ç»†èŠ‚ï¼Œå¹¶äº†è§£å‡ ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨ å®ç°ã€‚</p><h1 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h1><p>ä»¥ä¸‹ä»£ç æ‘˜è‡ª <a href="https://github.com/torvalds/linux/tree/v5.4" target="_blank" rel="noopener">Linux Kernel 5.4</a>ï¼Œè€ƒè™‘åˆ°å†…æ ¸ä»£ç éå¸¸å¤æ‚ï¼Œå¤„ç†ç»†èŠ‚ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æŠŠæ¯ä¸ªå‡½æ•°æˆ–æ•°æ®ç»“æ„æ‰€æœ‰ä»£ç éƒ½è´´å‡ºæ¥ï¼Œåªä¿ç•™äº†ä¸€äº›å’Œæœ¬æ–‡ç„¦ç‚¹æœ‰å…³çš„ä»£ç è¡Œã€‚</p><h2 id="Linux-å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„"><a href="#Linux-å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„" class="headerlink" title="Linux å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„"></a>Linux å†…æ ¸ä¸­ç›¸å…³çš„æ•°æ®ç»“æ„</h2><p>æ¯ä¸ªè¿›ç¨‹éƒ½å…³è”æŒ‡å‘äº†ä¸€ä¸ª <code>files_struct</code>ï¼Œå³æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">/* Filesystem information*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span></span></span><br><span class="line"><span class="class">    /* <span class="title">Open</span> <span class="title">file</span> <span class="title">information</span>*/</span></span><br><span class="line"><span class="class">    <span class="title">struct</span> <span class="title">files_struct</span>        *<span class="title">files</span>;</span></span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * read mostly part</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œå¯ä»¥å’Œå…¶å®ƒ task å…±äº«</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;</span><br><span class="line">    <span class="keyword">bool</span> resize_in_progress;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> resize_wait;</span><br><span class="line">    <span class="comment">// fdtable æ˜¯æ¯ä¸ªè¿›ç¨‹ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * written part on a separate cache line in SMP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> file_lock ____cacheline_aligned_in_smp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> next_fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> close_on_exec_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> open_fds_init[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> full_fds_bits_init[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå…³äº fdtable ï¼ˆè¿™ä¸ªå¯ä»¥ç†è§£ä¸ºè¿›ç¨‹ç‹¬ç«‹çš„<strong>æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰</strong>ï¼‰çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_fds;</span><br><span class="line">    <span class="comment">// è¿™é‡Œ fd æ•°ç»„ï¼Œç»´æŠ¤äº†è¿›ç¨‹å…³è”çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶æ–‡ä»¶å¥æŸ„çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶å¥æŸ„å¯ä»¥å…±äº«ï¼ˆæ¯”å¦‚ï¼Œdup ç³»ç»Ÿè°ƒç”¨ï¼‰</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯åœ¨ä½¿ç”¨ open ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼šåˆ›å»ºæ–°çš„ fileï¼Œå³æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> **<span class="title">fd</span>;</span> <span class="comment">/* current fd array */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *close_on_exec;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *open_fds;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *full_fds_bits;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹çœ‹æ–‡ä»¶å¥æŸ„ï¼ˆå³ open file descriptionï¼‰æ˜¯ä»€ä¹ˆï¼Ÿå®ƒç»´æŠ¤äº†å’Œæ‰“å¼€æ–‡ä»¶æœ‰å…³çš„é‡è¦ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span>        <span class="title">f_path</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘çœŸæ­£çš„æ–‡ä»¶ï¼Œinode æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span>        *<span class="title">f_inode</span>;</span>    <span class="comment">/* cached value */</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç›¸å…³çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">f_op</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">     * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span>        f_lock;</span><br><span class="line">    <span class="keyword">enum</span> rw_hint        f_write_hint;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œåªæœ‰ count ä¸º 0 æ—¶ï¼Œæ‰ä¼šè¢«çœŸæ­£åœ°å›æ”¶</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span>        f_count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>         f_flags;</span><br><span class="line">    <span class="keyword">fmode_t</span>            f_mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>        <span class="title">f_pos_lock</span>;</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶åç§»</span></span><br><span class="line">    <span class="keyword">loff_t</span>            f_pos;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>    <span class="title">f_owner</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>    *<span class="title">f_cred</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>    <span class="title">f_ra</span>;</span></span><br><span class="line">    u64            f_version;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”»äº†ä¸€ä¸ªå›¾ï¼Œæ–¹ä¾¿äº†è§£ä¸Šè¿°æ•°æ®ç»“æ„å…³ç³»ï¼š<br><img src="https://pic1.zhimg.com/v2-f3e683ab99b911d184e6e1dd244bdba4.jpg" alt="file-descriptor-file-description"></p><h2 id="ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°"><a href="#ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°" class="headerlink" title="ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°"></a>ä¸‰ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨å®ç°</h2><h3 id="open"><a href="#open" class="headerlink" title="open"></a>open</h3><p><code>open()</code>  ç³»ç»Ÿè°ƒç”¨ä¼šåˆ†é…æ–°çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ï¼Œç”¨æ¥ç»´æŠ¤ä¸æ‰“å¼€æ–‡ä»¶ç›¸å…³çš„å…ƒä¿¡æ¯ï¼ˆå¦‚åç§»é‡ã€è·¯å¾„ã€æ“ä½œæ–¹æ³•ç­‰ï¼‰ï¼Œå¹¶ä¼šç»™è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå…¶å®å°±æ˜¯ä¸ªå°æ•´æ•°ï¼‰ã€‚å®ƒå¯¹åº”çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic4.zhimg.com/v2-57c48d5ad99dc3fca76727492cbd8a8d.jpg" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/open.c</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">do_sys_open</span><span class="params">(<span class="keyword">int</span> dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *filename, <span class="keyword">int</span> flags, <span class="keyword">umode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">open_flags</span> <span class="title">op</span>;</span></span><br><span class="line">    <span class="comment">// ä¸è¦è¢«åå­— fd è¿·æƒ‘äº†ï¼Œå…¶å®è¿™é‡Œè¿”å›çš„æ˜¯é”™è¯¯ä¿¡æ¯ï¼ˆé 0 è¡¨ç¤ºå‡ºé”™äº†ï¼ï¼‰</span></span><br><span class="line">    <span class="keyword">int</span> fd = build_open_flags(flags, mode, &amp;op);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">filename</span> *<span class="title">tmp</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (fd)</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    tmp = getname(filename);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(tmp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    fd = get_unused_fd_flags(flags);</span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span> = <span class="title">do_filp_open</span>(<span class="title">dfd</span>, <span class="title">tmp</span>, &amp;<span class="title">op</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">            put_unused_fd(fd);</span><br><span class="line">            fd = PTR_ERR(f);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fsnotify_open(f);</span><br><span class="line">            <span class="comment">// æ³¨å†Œåˆ°è¿›ç¨‹çš„ fdtable ä¸­</span></span><br><span class="line">            fd_install(fd, f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    putname(tmp);</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/namei.c</span></span><br><span class="line"><span class="function">struct file *<span class="title">do_filp_open</span><span class="params">(<span class="keyword">int</span> dfd, struct filename *pathname,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct open_flags *op)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line">    filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> filp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct file *<span class="title">path_openat</span><span class="params">(struct nameidata *nd,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct open_flags *op, <span class="keyword">unsigned</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    file = alloc_empty_file(op-&gt;open_flag, current_cred());</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> file</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> fd_install(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, struct file *file)</span><br><span class="line">&#123;</span><br><span class="line">    __fd_install(current-&gt;files, fd, file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __fd_install(struct files_struct *files, <span class="keyword">unsigned</span> <span class="keyword">int</span> fd,</span><br><span class="line">        struct file *file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    rcu_assign_pointer(fdt-&gt;fd[fd], file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h3><p><code>dup()</code> ç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šæ˜¯ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯åº•å±‚è¿˜æ˜¯ä¼šæŒ‡å‘ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦å…³è”çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line">SYSCALL_DEFINE1(dup, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fildes)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -EBADF;</span><br><span class="line">    <span class="comment">// åŸºäºä¼ å…¥çš„æ–‡ä»¶æè¿°ï¼ŒæŸ¥æ‰¾åˆ°å…³è”çš„æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    <span class="comment">// éšè—äº†ä¸€äº›é”™è¯¯åˆ¤æ–­é€»è¾‘</span></span><br><span class="line">    <span class="comment">// fget_raw ä¼šè°ƒç”¨ __fget å‡½æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> = <span class="title">fget_raw</span>(<span class="title">fildes</span>);</span></span><br><span class="line">    ret = get_unused_fd_flags(<span class="number">0</span>);</span><br><span class="line">    fd_install(ret, file);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">fget</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">fd</span>, <span class="title">fmode_t</span> <span class="title">mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">refs</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// å¾—åˆ°å½“å‰è¿›ç¨‹å…³è”çš„æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆOpen file info tableï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span> = <span class="title">current</span>-&gt;<span class="title">files</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾ fd -&gt; æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    file = fcheck_files(files, fd);</span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="comment">/* File object ref couldn't be taken.</span></span><br><span class="line"><span class="comment">         * dup2() atomicity guarantee is the reason</span></span><br><span class="line"><span class="comment">         * we loop to catch the new file (or NULL pointer)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (file-&gt;f_mode &amp; mask)</span><br><span class="line">            file = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!get_file_rcu_many(file, refs))</span><br><span class="line">            <span class="keyword">goto</span> loop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p><code>close()</code> ç³»ç»Ÿè°ƒä¼šå›æ”¶æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒæ—¶ä¼šç»™æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘çš„æ–‡ä»¶å¥æŸ„ï¼ˆfile descriptionï¼‰çš„å¼•ç”¨è®¡æ•°å‡ 1ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œå›æ”¶ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.zhimg.com/v2-2152cb65cd8c5d140c444b4bda0be2f4.jpg" alt=""></p><p>å…¶å¯¹åº”çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE1(close, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = __close_fd(current-&gt;files, fd);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs/file.c</span></span><br><span class="line"><span class="comment">// __close_fd å…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶ä¸­ `files` æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹å…³è”çš„</span></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è¡¨ã€‚</span></span><br><span class="line"><span class="keyword">int</span> __close_fd(struct files_struct *files, <span class="keyword">unsigned</span> fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    spin_lock(&amp;files-&gt;file_lock);</span><br><span class="line">    fdt = files_fdtable(files);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¼ å…¥çš„ file descriptor æœ‰æ•ˆæ€§</span></span><br><span class="line">    <span class="keyword">if</span> (fd &gt;= fdt-&gt;max_fds)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾åˆ°å…³è”çš„ file descriptionï¼Œå³æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    file = fdt-&gt;fd[fd];</span><br><span class="line">    <span class="comment">// å›æ”¶ file descriptor</span></span><br><span class="line">    rcu_assign_pointer(fdt-&gt;fd[fd], <span class="literal">NULL</span>);</span><br><span class="line">    __put_unused_fd(files, fd);</span><br><span class="line">    spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line">    <span class="comment">// å…³é—­ file description</span></span><br><span class="line">    <span class="keyword">return</span> filp_close(file, files);</span><br><span class="line">out_unlock:</span><br><span class="line">    spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line">    <span class="keyword">return</span> -EBADF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// filp_close å…³é—­æŒ‡å‘çš„ file descriptionï¼Œå…¶ä¸­ id ä¸º</span></span><br><span class="line"><span class="comment">// POSIX çº¿ç¨‹ IDã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">filp_close</span><span class="params">(struct file *filp, <span class="keyword">fl_owner_t</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–‡ä»¶å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œè¯´æ˜å­˜åœ¨é”™è¯¯ï¼Œæ— æ³•å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (!file_count(filp)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">"VFS: Close: file count is 0\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (filp-&gt;f_op-&gt;flush)</span><br><span class="line">        retval = filp-&gt;f_op-&gt;flush(filp, id);</span><br><span class="line">    <span class="comment">// å¯èƒ½ä¼šå›æ”¶ file descriptionï¼Œä½†æ˜¯ä¼šè€ƒè™‘å…¶å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    fput(filp);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹å®šä¹‰åœ¨ï¼šfs/file_table.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fput</span><span class="params">(struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç»™ file description çš„å¼•ç”¨è®¡æ•°å‡ 1</span></span><br><span class="line">    fput_many(file, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fput_many</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> refs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åŸå­æ“ä½œï¼š&amp;file-&gt;f_count -= refs</span></span><br><span class="line">    <span class="keyword">if</span> (atomic_long_sub_and_test(refs, &amp;file-&gt;f_count)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä»‹ç»äº†ä¸‹æ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€æ–‡ä»¶çš„å…³ç³»ï¼Œå¹¶ç®€è¦è®²è§£äº† Linux å†…æ ¸ä¸­å…³äºè¿™äº›æŠ½è±¡æ¦‚å¿µçš„å…·ä½“å®ç°ã€‚åŒæ—¶ï¼Œè¿˜ç®€å•ä»‹ç»äº†ä¸‹ <code>open()</code>, <code>dup()</code> å’Œ <code>close()</code> ç³»ç»Ÿè°ƒç”¨çš„å®ç°ã€‚ç›¸ä¿¡åœ¨çœ‹å®Œè¿™äº›åï¼Œèƒ½å¤Ÿæ›´åŠ æ·±å…¥å’Œæ¸…æ™°åœ°ç†è§£è¿™ä¸‰ä¸ªæ¦‚å¿µï¼š<strong>ç³»ç»Ÿçº§æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰/æè¿°è¡¨ï¼ˆopen file description tableï¼‰</strong>ã€<strong>æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰/æ–‡ä»¶æè¿°ï¼ˆfile descriptionï¼‰</strong>ä»¥åŠ<strong>æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰</strong>ã€‚</p><p>æœ€åï¼Œå›ç­”ä¸‹æœ¬æ–‡å¼€å¤´æåˆ°çš„é—®é¢˜ã€‚å…¶å®ï¼Œç«™åœ¨è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œä½œè€…åœ¨ <a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a> ä¸­æåˆ°ã€Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>ã€è¿™æ ·çš„è¯´æ³•å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚åªæ˜¯æ­¤å¤„<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>å’Œã€ŠLinux ç³»ç»Ÿç¼–ç¨‹ã€‹ä¸­æåˆ°çš„ç³»ç»Ÿçº§<strong>æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰</strong>å¹¶éä¸€ä¸ªæ¦‚å¿µã€‚ä½œè€…æåˆ°çš„<strong>æ‰“å¼€çš„æ–‡ä»¶è¡¨ï¼ˆfdtable)</strong>å…¶å®æ­£æ˜¯æŠ½è±¡çš„<strong>è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰</strong>è¡¨ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æ²¡å¿…è¦ä¸ºæ­¤çº ç»“ï¼Œå’¬æ–‡åš¼å­—ä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä¸è¿‡å¯¹äºå›°æƒ‘çš„ä¸œè¥¿è¿˜æ˜¯èƒ½å¤Ÿææ¸…æ¥šæ‰å¥½ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://juejin.im/entry/5b56f9045188251b157bb645" target="_blank" rel="noopener">Linux æ–‡ä»¶å¥æŸ„çš„è¿™äº›æŠ€æœ¯å†…å¹•ï¼Œåªæœ‰ 1% çš„äººçŸ¥é“</a></li><li><a href="https://zhuanlan.zhihu.com/p/34280875" target="_blank" rel="noopener">Linux å†…æ ¸æ–‡ä»¶æè¿°ç¬¦è¡¨çš„æ¼”å˜</a></li><li><a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener">man open(2)</a></li><li><a href="https://zhuanlan.zhihu.com/p/46031338" target="_blank" rel="noopener">Linux IOæ ¸å¿ƒæ•°æ®ç»“æ„ä¹‹ä¸€</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨ã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹5.4 èŠ‚ï¼Œå…³äºæ–‡ä»¶æè¿°ç¬¦å’Œæ‰“å¼€çš„æ–‡ä»¶å…³ç³»æ˜¯è¿™æ ·æè¿°çš„ï¼šã€Œå†…æ ¸ä¸ºæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ç»´æŠ¤äº†ä¸€ä¸ªç³»ç»Ÿçº§çš„&lt;strong&gt;æè¿°è¡¨ï¼ˆopen file description tableï¼‰&lt;/strong&gt;ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸º&lt;strong&gt;æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆopen file tableï¼‰&lt;/strong&gt;ï¼Œå¹¶å°†è¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®ç§°ä¸º&lt;strong&gt;æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼ˆopen file handleï¼‰&lt;/strong&gt;ã€‚è€Œé’ˆå¯¹æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸åˆä¸ºå…¶ç»´æŠ¤äº†&lt;strong&gt;æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ï¼ˆopen file descriptor tableï¼‰&lt;/strong&gt;ã€ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="/categories/Linux/"/>
    
    
      <category term="Linux" scheme="/tags/Linux/"/>
    
      <category term="æ–‡ä»¶æè¿°ç¬¦" scheme="/tags/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/"/>
    
      <category term="æ–‡ä»¶å¥æŸ„" scheme="/tags/%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€å®ç° Redis å­—å…¸</title>
    <link href="/2019/12/17/implement-redis-dict-in-go/"/>
    <id>/2019/12/17/implement-redis-dict-in-go/</id>
    <published>2019-12-17T09:18:10.000Z</published>
    <updated>2019-12-19T05:26:12.447Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png" alt=""></p><p>å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”®å€¼æ•°æ®åº“ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹åœ¨ <a href="https://ifaceless.space/2019/12/15/redis-low-level-data-structures/" target="_blank" rel="noopener">Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„</a>  ä¸­æåˆ°çš„ Redis å­—å…¸å®ç°çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p><ol><li>æ”¯æŒæµ·é‡ <code>&lt;key, value&gt;</code> å­˜å‚¨ï¼›</li><li>ä½¿ç”¨æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œé¿å…å› ä¸ºéœ€è¦è¿ç§»çš„ buckets å¤ªå¤šå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼ˆRedis æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼‰ï¼›</li><li>é»˜è®¤ä½¿ç”¨ SipHash ç®—æ³•è®¡ç®—é”®çš„ hash å€¼ï¼›</li><li>å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œé‡‡ç”¨äº†å¸¸è§çš„é“¾åœ°å€æ³•ï¼Œä¸”æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼›</li><li>å­—å…¸å†…éƒ¨ç»´æŠ¤äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¼šåœ¨æ‰©å®¹æœŸé—´ï¼ˆRehashï¼‰ä½¿ç”¨ï¼›</li><li>æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ã€‚</li></ol><a id="more"></a><p>åœ¨çœ‹äº† Redis å­—å…¸æºç ï¼Œææ‡‚å®ƒçš„å·¥ä½œåŸç†åï¼Œæœ‰æ²¡æœ‰æƒ³è¦è‡ªå·±å®ç°ä¸‹å‘¢ï¼Ÿæ‰€ä»¥ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å±±å¯¨ä¸€ä¸ª Redis å­—å…¸å®ç°ï¼Œè™½ç„¶ã€Œå®¹è²Œã€æœ‰å¼‚ï¼Œä½†ã€Œå†…æ ¸ã€è¿˜æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨å®ç°çš„æ—¶å€™å…ˆä¸è€ƒè™‘ goroutine å®‰å…¨é—®é¢˜ï¼Œç„¦ç‚¹æ”¾åœ¨ Redis å­—å…¸å®ç°çš„æ ¸å¿ƒæ€æƒ³ä¸Šã€‚æ‰€ä»¥åé¢çš„å®ç°ï¼Œéƒ½å‡è®¾åªæœ‰ä¸€ä¸ª goroutine åœ¨å¯¹å­—å…¸è¿›è¡Œæ“ä½œã€‚ç”±äº Go è¯­è¨€è‡ªå¸¦ GCï¼Œæ‰€ä»¥ä½¿ç”¨å®ƒæ¥å®ç°å°±ä¸ç”¨çƒ¦å¿ƒå†…å­˜ç®¡ç†çš„é—®é¢˜äº†ï¼ˆåœ¨ Redis <code>dict.c</code> å®ç°ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šä»£ç æ˜¯æ¶‰åŠå†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„ï¼‰ï¼Œè¿™æ ·å°±èƒ½è®©æˆ‘ä»¬æ›´åŠ å®¹æ˜“åœ°ç†è§£æ ¸å¿ƒçš„å®ç°ç­–ç•¥ã€‚</p><h1 id="ä¸€ç‚¹è¯´æ˜"><a href="#ä¸€ç‚¹è¯´æ˜" class="headerlink" title="ä¸€ç‚¹è¯´æ˜"></a>ä¸€ç‚¹è¯´æ˜</h1><p>æ­£æ‰€è°“ã€Œå…¥ä¹¡éšä¿—ã€å˜›ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°çš„å­—å…¸ä¸­ï¼Œå¹¶æ²¡æœ‰ç…§æ¬åŸå…ˆ Redis ä¸­å­—å…¸çš„æ¥å£ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç»„ç±»ä¼¼äºæ ‡å‡†åº“ <code>sync.Map</code> çš„æ¥å£ã€‚</p><p>å¦å¤–ï¼Œä»€ä¹ˆæ ·çš„ key å¯ä»¥ä½œä¸ºå­—å…¸çš„é”®å‘¢ï¼Ÿé¦–å…ˆï¼Œå¿…é¡»è¦æ˜¯æ–¹ä¾¿è®¡ç®—å“ˆå¸Œå€¼çš„ï¼›å…¶æ¬¡ï¼Œæ–¹ä¾¿è¿›è¡Œç›´æ¥æ¯”è¾ƒã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Redis çš„å­—å…¸å®ç°ä¸­æä¾›äº†ä¸€ç»„æ¥å£ï¼Œä¾›å®é™…ä½¿ç”¨å­—å…¸å­˜å‚¨çš„æ•°æ®ç±»å‹å®ç°ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„æ‰©å±•æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¸ºäº†ç®€å•èµ·è§ï¼Œåœ¨ä½¿ç”¨ Go è¯­è¨€å®ç°æ—¶å­—å…¸æ—¶ï¼Œä¼ å…¥çš„ <code>key</code> å’Œ <code>value</code> å‡ä¸º <code>interface{}</code>  ç±»å‹ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶çš„æ¥å£å®ç°è¦æ±‚ã€‚å¦å¤–ï¼Œé’ˆå¯¹ <code>key</code> å°†åªæ”¯æŒ <code>string</code> å’Œ <code>int</code> ç±»å‹åŠå…¶å˜ç§ã€‚è¿™ç§å¯ä»¥æ»¡è¶³åŸºæœ¬çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæ‹¥æœ‰å’Œ <code>sync.Map</code> ä¸€æ ·çš„æ¥å£ç­¾åã€‚</p><p>æœ€åï¼Œæ¥çœ‹ä¸‹å­—å…¸çš„æ¥å£è®¾è®¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store å‘å­—å…¸ä¸­æ·»åŠ æ–°çš„ key-value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Store</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, value <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Load</span> ä»å­—å…¸ä¸­è·å–æŒ‡å®š <span class="title">key</span> å¯¹åº”çš„å€¼</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Load</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">LoadOrStore</span> ç”¨äºæ ¹æ®æŒ‡å®š <span class="title">key</span> å…ˆæŸ¥æ‰¾å¯¹åº”å€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å¯¹åº”å€¼ï¼›</span></span><br><span class="line"><span class="function">// å¦åˆ™ï¼Œä¼šå°†ç»™å®š <span class="title">key</span>-<span class="title">value</span> å­˜å‚¨åˆ°å­—å…¸ä¸­ï¼Œå¹¶è¿”å›ä¼ å…¥çš„ <span class="title">value</span>ã€‚</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">LoadOrStore</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(actual <span class="keyword">interface</span>&#123;&#125;, loaded <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Delete</span> åˆ é™¤æŒ‡å®šçš„ <span class="title">key</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Len</span> è¿”å›å­—å…¸çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">uint64</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Cap</span> è¿”å›å­—å…¸çš„å®¹é‡</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">uint64</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Range</span> æ¨¡æ‹Ÿ <span class="title">Redis</span> å­—å…¸æ™®é€šè¿­ä»£å™¨è¡Œä¸ºï¼Œä¸æ”¯æŒéå®‰å…¨çš„æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Range</span><span class="params">(fn <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">RangeSafely</span> æ¨¡æ‹Ÿ <span class="title">Redis</span> å­—å…¸å®‰å…¨è¿­ä»£å™¨è¡Œä¸ºï¼Œè¿­ä»£æœŸé—´ä¸åš <span class="title">rehash</span> æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">RangeSafely</span><span class="params">(fn <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Resize</span> ç”¨äºè°ƒæ•´å­—å…¸å®¹é‡ï¼ˆæ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯ <span class="title">rehash</span> è¿˜æ˜¯æ¸è¿›å¼çš„ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">Resize</span><span class="params">()</span> <span class="title">error</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">RehashForAWhile</span> æ‰§è¡Œä¸€æ®µæ—¶é—´çš„ <span class="title">rehash</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(d *Dict)</span> <span class="title">RehashForAWhile</span><span class="params">(duration time.Duration)</span></span></span><br></pre></td></tr></table></figure><h1 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h1><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dict <span class="keyword">struct</span> &#123;</span><br><span class="line">    hashTables []*hashTable</span><br><span class="line">    rehashIdx <span class="keyword">int64</span></span><br><span class="line">    iterators <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> hashTable <span class="keyword">struct</span> &#123;</span><br><span class="line">    buckets []*entry</span><br><span class="line">    size <span class="keyword">uint64</span></span><br><span class="line">    sizemask <span class="keyword">uint64</span></span><br><span class="line">    used <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    key, value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    next *entry</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­—å…¸åˆå§‹åŒ–"><a href="#å­—å…¸åˆå§‹åŒ–" class="headerlink" title="å­—å…¸åˆå§‹åŒ–"></a>å­—å…¸åˆå§‹åŒ–</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New å®ä¾‹åŒ–ä¸€ä¸ªå­—å…¸ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">Dict</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Dict&#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‡†å¤‡ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œé»˜è®¤ä½¿ç”¨å“ˆå¸Œè¡¨ 1</span></span><br><span class="line">        <span class="comment">// åœ¨è¿›è¡Œæ‰©å®¹æ—¶ï¼Œä¼šå°†å“ˆå¸Œè¡¨ 1 ä¸­çš„æ‰€æœ‰å…ƒç´ è¿ç§»åˆ°</span></span><br><span class="line">        <span class="comment">// å“ˆå¸Œè¡¨ 2ã€‚</span></span><br><span class="line">        hashTables: []*hashTable&#123;&#123;&#125;, &#123;&#125;&#125;,</span><br><span class="line">        rehashIdx: <span class="number">-1</span>,</span><br><span class="line">        iterators: <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®"><a href="#åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®" class="headerlink" title="åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®"></a>åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šçš„é”®</h2><p>ä¸‹é¢è¿™ä¸ªå‡½æ•°å°†åŸºäºæŒ‡å®šçš„ key è®¡ç®—å‡ºå¯¹åº”çš„ hash å€¼ï¼ˆä½¿ç”¨ SipHash ç®—æ³•ï¼ŒRedis å­—å…¸ä¸­é»˜è®¤ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡æŸ¥è¯¢å“ˆå¸Œè¡¨æ¥ç¡®å®šå¯¹åº”çš„ key æ˜¯å¦å­˜åœ¨äºå­—å…¸ä¸­ã€‚è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé‡è¦ï¼Œåœ¨åé¢çš„ <code>Load</code> å’Œ <code>Store</code> å‡½æ•°ä¸­éƒ½æœ‰åº”ç”¨ï¼Œä¸‹é¢æ¥çœ‹çœ‹å®ƒçš„å…·ä½“å®ç°å§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// keyIndex åŸºäºæŒ‡å®šçš„ key è·å¾—å¯¹åº”çš„ bucket ç´¢å¼•</span></span><br><span class="line"><span class="comment">// å¦‚æœ key å·²ç»å­˜åœ¨äºå­—å…¸ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›å…³è”çš„ entry</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">keyIndex</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(idx <span class="keyword">uint64</span>, existed *entry)</span></span> &#123;</span><br><span class="line">    hash := SipHash(key)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        ht := d.hashTables[i]</span><br><span class="line">        idx = ht.sizemask &amp; hash</span><br><span class="line">        <span class="keyword">for</span> ent := ht.buckets[idx]; ent != <span class="literal">nil</span>; ent = ent.next &#123;</span><br><span class="line">            <span class="keyword">if</span> ent.key == key &#123;</span><br><span class="line">                <span class="keyword">return</span> idx, ent</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå­—å…¸å¤„äº rehashing ä¸­ï¼Œä¸Šé¢çš„å¾ªç¯å¯ä»¥ä¿è¯æœ€åçš„ idx ä¸€å®šä½äº</span></span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä»è€Œä¿è¯ä¾èµ–è¯¥æ¥å£çš„åœ°æ–¹å­˜å‚¨çš„æ–°é”®ä¸€å®šè¿›å…¥åˆ°æ–°çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    <span class="keyword">return</span> idx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢é”®å€¼å¯¹"><a href="#æŸ¥è¯¢é”®å€¼å¯¹" class="headerlink" title="æŸ¥è¯¢é”®å€¼å¯¹"></a>æŸ¥è¯¢é”®å€¼å¯¹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load ä»å­—å…¸ä¸­åŠ è½½æŒ‡å®šçš„ key å¯¹åº”çš„å€¼ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Load</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(value <span class="keyword">interface</span>&#123;&#125;, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _, existed := d.keyIndex(key)</span><br><span class="line">    <span class="keyword">if</span> existed != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> existed.value, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­˜å‚¨é”®å€¼å¯¹"><a href="#å­˜å‚¨é”®å€¼å¯¹" class="headerlink" title="å­˜å‚¨é”®å€¼å¯¹"></a>å­˜å‚¨é”®å€¼å¯¹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Store å‘å­—å…¸ä¸­æ·»åŠ  key-valueã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Store</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    ent, loaded := d.loadOrStore(key, value)</span><br><span class="line">    <span class="keyword">if</span> loaded &#123;</span><br><span class="line">        ent.value = value <span class="comment">// ç›´æ¥æ›´æ–° value å³å¯</span></span><br><span class="line">    &#125; <span class="comment">// å¦åˆ™ï¼Œä¸Šè¿°å‡½æ•°è°ƒç”¨ä¼šè‡ªåŠ¨æ·»åŠ  (key, value) åˆ°å­—å…¸ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loadOrStore å…ˆå°è¯•ä½¿ç”¨ key æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°åˆ™ç›´æ¥è¿”å›å¯¹åº” entryï¼Œ</span></span><br><span class="line"><span class="comment">// å¦åˆ™ï¼Œä¼šæ·»åŠ æ–°çš„ entry åˆ°å­—å…¸ä¸­ï¼ŒåŒæ—¶è¿”å› nilï¼Œè¡¨ç¤ºä¹‹å‰ä¸å­˜åœ¨ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">loadOrStore</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(ent *entry, loaded <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _ = d.expandIfNeeded() <span class="comment">// è¿™é‡Œç®€å•èµ·è§ï¼Œå‡è®¾ä¸€å®šæ˜¯å¯ä»¥æ‰©å®¹æˆåŠŸçš„ï¼Œå¿½ç•¥äº†é”™è¯¯</span></span><br><span class="line">    idx, existed := d.keyIndex(key)</span><br><span class="line">    ht := d.hashTables[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        ht = d.hashTables[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> existed != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> existed, <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œéœ€è¦åœ¨æŒ‡å®š bucket æ·»åŠ æ–°çš„ entry</span></span><br><span class="line">        <span class="comment">// å¯¹äºå“ˆå¸Œå†²çªçš„æƒ…å†µï¼Œé‡‡ç”¨é“¾åœ°å€æ³•ï¼Œåœ¨æ’å…¥æ–°çš„ entry æ—¶ï¼Œ</span></span><br><span class="line">        <span class="comment">// é‡‡ç”¨å¤´æ’æ³•ï¼Œä¿è¯æœ€è¿‘æ·»åŠ çš„åœ¨æœ€å‰é¢</span></span><br><span class="line">        entry := &amp;entry&#123;key: key, value: value, next: ht.buckets[idx]&#125;</span><br><span class="line">        ht.buckets[idx] = entry</span><br><span class="line">        ht.used++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤é”®å€¼å¯¹"><a href="#åˆ é™¤é”®å€¼å¯¹" class="headerlink" title="åˆ é™¤é”®å€¼å¯¹"></a>åˆ é™¤é”®å€¼å¯¹</h2><p>åˆ é™¤æ“ä½œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æŸ¥æ‰¾åˆ°è¦åˆ é™¤çš„ Entry åï¼Œéœ€è¦è®°å¾—è°ƒæ•´å“ˆå¸Œæ¡¶çš„å¤´æŒ‡é’ˆï¼Œå¯èƒ½è¢«åˆ é™¤çš„ Entry æ°å¥½å°±æ˜¯å¤´èŠ‚ç‚¹ã€‚ä»£ç å®ç°æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete ä»å­—å…¸ä¸­åˆ é™¤æŒ‡å®šçš„ keyï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆä¹Ÿ</span></span><br><span class="line"><span class="comment">// ä¸åšã€‚</span></span><br><span class="line"><span class="comment">// å®ç°æè¿°ï¼š</span></span><br><span class="line"><span class="comment">// 1. éå†å“ˆå¸Œè¡¨ï¼Œå®šä½åˆ°å¯¹åº”çš„ buckets</span></span><br><span class="line"><span class="comment">// 2. åˆ é™¤ buckets ä¸­åŒ¹é…çš„ entryã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.Len() == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸è¦åšæ— ç•çš„æŒ£æ‰ï¼</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        d.rehashStep()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash := SipHash(key)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        ht := d.hashTables[i]</span><br><span class="line">        idx := ht.sizemask &amp; hash</span><br><span class="line">        <span class="keyword">var</span> prevEntry *entry</span><br><span class="line">        <span class="keyword">for</span> ent := ht.buckets[idx]; ent != <span class="literal">nil</span>; ent = ent.next &#123;</span><br><span class="line">            <span class="keyword">if</span> ent.key == key &#123;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶éœ€è¦é‡Šæ”¾ ent èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> prevEntry != <span class="literal">nil</span> &#123;</span><br><span class="line">                    prevEntry.next = ent.next</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å¾…é‡Šæ”¾çš„èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒæ•´ buckets[idx] æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                    ht.buckets[idx] = ent.next</span><br><span class="line">                &#125;</span><br><span class="line">                ent.next = <span class="literal">nil</span></span><br><span class="line">                ht.used--</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            prevEntry = ent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰©å®¹å’Œç¼©å®¹"><a href="#æ‰©å®¹å’Œç¼©å®¹" class="headerlink" title="æ‰©å®¹å’Œç¼©å®¹"></a>æ‰©å®¹å’Œç¼©å®¹</h2><p>åœ¨ç»™å­—å…¸æ·»åŠ é”®å€¼å¯¹æ—¶ï¼Œä¼šè°ƒç”¨ <code>loadOrStore</code> æ–¹æ³•ï¼Œè€Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†ä¸€æ¬¡ <code>d.expandIfNeeded()</code> æ–¹æ³•å°è¯•ç»™å­—å…¸æŒ‰éœ€æ‰©å®¹ã€‚é‚£ä¹ˆï¼Œå­—å…¸æ‰©å®¹çš„æ—¶æœºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰©å®¹çš„ç­–ç•¥åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿä¸”çœ‹æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    _initialHashtableSize <span class="keyword">uint64</span> = <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">expandIfNeeded</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶è¡¨æ˜æ‰©å®¹å·²ç»æˆåŠŸï¼Œæ­£åœ¨è¿›è¡Œè¿ç§»ï¼ˆrehashï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œéœ€è¦ä¸€å®šçš„ç©ºé—´å­˜æ”¾æ–°çš„ keys</span></span><br><span class="line">        <span class="keyword">return</span> d.resizeTo(_initialHashtableSize)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦åˆ™ï¼Œæ ¹æ®è´Ÿè½½å› å­åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="comment">// æ‰©å®¹ç­–ç•¥ç®€å•ç²—æš´ï¼Œè‡³å°‘è¦æ˜¯å·²æœ‰å…ƒç´ ä¸ªæ•°çš„äºŒå€</span></span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].used == d.hashTables[<span class="number">0</span>].size &#123;</span><br><span class="line">        <span class="keyword">return</span> d.resizeTo(d.hashTables[<span class="number">0</span>].used * <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">resizeTo</span><span class="params">(size <span class="keyword">uint64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸»è¦æ˜¯è¦ä¿è¯æ‰©å®¹å¤§å°ç¬¦åˆè¦æ±‚ï¼Œè‡³å°‘è¦æ¯”ç°æœ‰å…ƒç´ ä¸ªæ•°å¤š</span></span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() || d.hashTables[<span class="number">0</span>].used &gt; size &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"failed to resize"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = d.nextPower(size)</span><br><span class="line">    <span class="keyword">if</span> size == d.hashTables[<span class="number">0</span>].size &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡å¼€å§‹æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">var</span> ht *hashTable</span><br><span class="line">    <span class="keyword">if</span> d.hashTables[<span class="number">0</span>].size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œæ‰©å®¹ï¼Œç»™ ht[0] å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥ keys å¯ä»¥ç›´æ¥æ”¾è¿›æ¥</span></span><br><span class="line">        ht = d.hashTables[<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ht = d.hashTables[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">// è¡¨æ˜éœ€è¦å¼€å§‹è¿›ä¸€æ­¥æ‰©å®¹ï¼Œè¿ç§» ht[0] -&gt; ht[1]</span></span><br><span class="line">        d.rehashIdx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ht.size = size</span><br><span class="line">    ht.sizemask = size - <span class="number">1</span></span><br><span class="line">    ht.buckets = <span class="built_in">make</span>([]*entry, ht.size)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextPower æ‰¾åˆ°åŒ¹é… size çš„æ‰©å®¹å¤§å°</span></span><br><span class="line"><span class="comment">// 2^2 -&gt; 2^3 -&gt; 2^4 -&gt; 2^5 -&gt; ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">nextPower</span><span class="params">(size <span class="keyword">uint64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> size &gt;= math.MaxUint64 &#123;</span><br><span class="line">        <span class="keyword">return</span> math.MaxUint64</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i := _initialHashtableSize</span><br><span class="line">    <span class="keyword">for</span> i &lt; size &#123;</span><br><span class="line">        i &lt;&lt;= <span class="number">1</span> <span class="comment">// i*= 2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“äº†æ‰©å®¹æ˜¯ä½•æ—¶è¿›è¡Œçš„äº†ï¼Œ ä½†æ˜¯çœ‹èµ·æ¥å¹¶æ²¡æœ‰åœ¨åˆ é™¤å…ƒç´ æ—¶æ‰§è¡Œç¼©å®¹æ“ä½œå‘¢ï¼Ÿé‚£ç¼©å®¹ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿåœ¨ Redis ä¸­ï¼Œæ˜¯ç”±å­—å…¸çš„ä½¿ç”¨è€…æ¥ç¡®å®šç¼©å®¹çš„æ—¶æœºçš„ï¼Œæ¯”å¦‚åœ¨åˆ é™¤é”®å€¼å¯¹åï¼Œæˆ–è€…åœ¨ <code>serverCron</code> ä¸­æ‰§è¡Œï¼ˆå…·ä½“è°ƒç”¨é“¾è·¯ä¸ºï¼š<code>serverCron-&gt;databasesCron-&gt;tryResizeHashTables-&gt;dictResize</code>ï¼‰ã€‚è¯¥æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œç”¨ Go è¯­è¨€è¡¨è¾¾å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Resize è®©å­—å…¸æ‰©å®¹æˆ–è€…ç¼©å®¹åˆ°ä¸€å®šå¤§å°ã€‚</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ä¼šå‡†å¤‡å¥½ç”¨äºæ‰©å®¹çš„ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œä½†çœŸæ­£çš„è¿ç§»è¿˜æ˜¯åˆ†æ•£</span></span><br><span class="line"><span class="comment">// åœ¨å¤šæ¬¡ Rehash æ“ä½œä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">Resize</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.isRehashing() &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"dict is rehashing"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size := d.hashTables[<span class="number">0</span>].used</span><br><span class="line">    <span class="keyword">if</span> size &lt; _initialHashtableSize &#123;</span><br><span class="line">        size = _initialHashtableSize</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> d.resizeTo(size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸è¿›å¼-rehash"><a href="#æ¸è¿›å¼-rehash" class="headerlink" title="æ¸è¿›å¼ rehash"></a>æ¸è¿›å¼ rehash</h2><p>æ¸è¿›å¼ Rehash çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å¤§é‡çš„å·¥ä½œåˆ†æˆå¾ˆå¤šæ­¥å®Œæˆã€‚åœ¨ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Load</code>, <code>Store</code>, <code>Delete</code> æ–¹æ³•ä¸­ï¼Œéƒ½æœ‰è°ƒç”¨ <code>d.rehashStep()</code>ï¼Œè¿›è€Œåˆä¼šè°ƒç”¨ <code>d.rehash(1)</code>ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¸è¿›å¼ Rehash æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rehash å®ç°æ¸è¿›å¼ Rehash ç­–ç•¥ã€‚åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œæ¯æ¬¡å¯¹æœ€å¤š</span></span><br><span class="line"><span class="comment">// steps ä¸ª buckets è¿›è¡Œè¿ç§»ã€‚å¦å¤–ï¼Œè€ƒè™‘åˆ°å¯èƒ½æ—§çš„å“ˆå¸Œè¡¨ä¸­</span></span><br><span class="line"><span class="comment">// ä¼šè¿ç»­é‡åˆ°è¾ƒå¤šçš„ç©º bucketsï¼Œå¯¼è‡´è€—è´¹æ—¶é—´ä¸å—é™åˆ¶ï¼Œè¿™é‡Œè¿˜</span></span><br><span class="line"><span class="comment">// é™å®šæœ€å¤šé‡åˆ° 10 * steps ä¸ªç©º buckets å°±é€€å‡ºã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">rehash</span><span class="params">(steps <span class="keyword">uint64</span>)</span> <span class="params">(finished <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !d.isRehashing() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    maxEmptyBucketsMeets := <span class="number">10</span> * steps</span><br><span class="line">    src, dst := d.hashTables[<span class="number">0</span>], d.hashTables[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> ; steps &gt; <span class="number">0</span> &amp;&amp; src.used != <span class="number">0</span>; steps-- &#123;</span><br><span class="line">        <span class="comment">// æ‰«æå“ˆå¸Œè¡¨ç›´åˆ°é‡åˆ°éç©ºçš„ bucket</span></span><br><span class="line">        <span class="keyword">for</span> src.buckets[d.rehashIdx] == <span class="literal">nil</span> &#123;</span><br><span class="line">            d.rehashIdx++</span><br><span class="line">            maxEmptyBucketsMeets--</span><br><span class="line">            <span class="keyword">if</span> maxEmptyBucketsMeets &lt;= <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠæ•´ä¸ª bucket ä¸Šæ‰€æœ‰çš„ entry éƒ½è¿ç§»èµ°</span></span><br><span class="line">        <span class="keyword">for</span> ent := src.buckets[d.rehashIdx]; ent != <span class="literal">nil</span>; &#123;</span><br><span class="line">            next := ent.next</span><br><span class="line">            idx := SiphHash(ent.key) &amp; dst.sizemask</span><br><span class="line">            ent.next = dst.buckets[idx]</span><br><span class="line">            dst.buckets[idx] = ent</span><br><span class="line">            src.used--</span><br><span class="line">            dst.used++</span><br><span class="line">            ent = next</span><br><span class="line">        &#125;</span><br><span class="line">        src.buckets[d.rehashIdx] = <span class="literal">nil</span> <span class="comment">// æ¸…ç©ºæ—§çš„ bucket</span></span><br><span class="line">        d.rehashIdx++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¿ç§»å®Œæ¯•ï¼Œéœ€è¦å°† ht[0] æŒ‡å‘è¿ç§»åçš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    <span class="keyword">if</span> src.used == <span class="number">0</span> &#123;</span><br><span class="line">        d.hashTables[<span class="number">0</span>] = dst</span><br><span class="line">        d.hashTables[<span class="number">1</span>] = &amp;hashTable&#123;&#125;</span><br><span class="line">        d.rehashIdx = <span class="number">-1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­—å…¸è¿­ä»£å™¨"><a href="#å­—å…¸è¿­ä»£å™¨" class="headerlink" title="å­—å…¸è¿­ä»£å™¨"></a>å­—å…¸è¿­ä»£å™¨</h2><p>è¿­ä»£å™¨çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iterator å®ç°äº†ä¸€ä¸ªå¯¹å­—å…¸çš„è¿­ä»£å™¨ã€‚</span></span><br><span class="line"><span class="comment">// ä¸è¿‡è€ƒè™‘åˆ°æˆ‘ä»¬å°†ä¸ºå­—å…¸æä¾› `Range` æ–¹æ³•ï¼Œæ•…è¯¥è¿­ä»£å™¨å°±ä¸å¾€å¤–æš´éœ²äº†ã€‚</span></span><br><span class="line"><span class="keyword">type</span> iterator <span class="keyword">struct</span> &#123;</span><br><span class="line">    d *Dict</span><br><span class="line">    tableIndex <span class="keyword">int</span></span><br><span class="line">    safe <span class="keyword">bool</span></span><br><span class="line">    fingerprint <span class="keyword">int64</span></span><br><span class="line">    entry *entry</span><br><span class="line">    bucketIndex <span class="keyword">uint64</span></span><br><span class="line">    waitFirstIteration <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newIterator</span><span class="params">(d *Dict, safe <span class="keyword">bool</span>)</span> *<span class="title">iterator</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;iterator&#123;</span><br><span class="line">        d: d,</span><br><span class="line">        safe: safe,</span><br><span class="line">        waitFirstIteration: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Redis çš„å­—å…¸ä¸­ï¼Œæä¾›äº†ä¸¤ç§ç±»å‹çš„è¿­ä»£å™¨ï¼Œåˆ†åˆ«é€šè¿‡ <code>dictGetIterator</code> å’Œ <code>dictGetSafeIterator</code> è·å¾—ã€‚æ™®é€šè¿­ä»£å™¨åªèƒ½æ‰§è¡Œå’Œå­—å…¸å…³è”çš„ <code>dictNext</code> æ–¹æ³•ï¼Œä¸å…è®¸æ‰§è¡Œ <code>dictFind</code>ï¼Œ<code>dictAdd</code> ç­‰æ“ä½œï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºè¿™äº›æ“ä½œå¯èƒ½ä¼šå¼•èµ· Rehashï¼Œä»è€Œå¯¼è‡´åœ¨è¿­ä»£æœŸé—´å¯èƒ½ä¼šæ‰«æåˆ°é‡å¤çš„é”®å€¼å¯¹ï¼ˆæ¯”å¦‚åœ¨æ‰§è¡Œ Rehash æœŸé—´ï¼ŒæŸäº›é”®å€¼å¯¹è¢«è¿ç§»åˆ°äº†æ–°çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä¼˜å…ˆæ‰«æç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç„¶åå†æ‰«æç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ï¼Œè€Œæ­¤æ—¶å¯èƒ½ä¼šé‡åˆ°ä¹‹å‰æ‰«æè¿‡çš„å…ƒç´ ï¼‰ã€‚å½“ç„¶ï¼ŒRedis çš„æ™®é€šè¿­ä»£å™¨æ˜¯æ²¡æ³•é˜»æ­¢ä½ åœ¨è¿­ä»£æœŸé—´æ‰§è¡Œä¸å®‰å…¨çš„æ“ä½œçš„ï¼Œä½†æ˜¯å®ƒä¼šé€šè¿‡è®¡ç®—è¿­ä»£å‰åå­—å…¸çš„æŒ‡çº¹ä¿¡æ¯ï¼Œå¹¶åœ¨æœ€åè¿›è¡Œæ¯”å¯¹ï¼Œè‹¥æŒ‡çº¹ä¸åŒ¹é…ï¼Œåˆ™æ— æ³•é€šè¿‡ <code>assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d))</code> æ–­è¨€ã€‚</p><p>é‚£ä¹ˆå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å¯ä»¥å…è®¸ <code>dictFind</code> å’Œ <code>dictAdd</code> ç­‰æ“ä½œæ‰§è¡Œçš„å‘¢ï¼Ÿå…¶å®å®ƒæ˜¯é€šè¿‡é˜»æ­¢å­—å…¸ <code>rehash</code> å®ç°çš„ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒæ‰å¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°æ‰«æå“ˆå¸Œè¡¨ä¸­çš„ Entriesï¼Œè€Œä¸ç”¨æ‹…å¿ƒé‡åˆ°é‡å¤çš„ Entriesã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>Load</code>ã€<code>Store</code> å’Œ <code>Delete</code> ä¸­éƒ½æœ‰ç›´æ¥æˆ–é—´æ¥åœ°è°ƒç”¨ <code>d.rehashStep()</code> æ–¹æ³•ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Dict)</span> <span class="title">rehashStep</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> d.iterators == <span class="number">0</span> &#123;</span><br><span class="line">        d.rehash(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿­ä»£å™¨æœ€é‡è¦çš„ <code>next()</code> æ–¹æ³•å®ç°ï¼Œå°±å¯ä»¥çœ‹åˆ°å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next ä¼šä¾æ¬¡æ‰«æå­—å…¸ä¸­å“ˆå¸Œè¡¨çš„æ‰€æœ‰ bucketsï¼Œå¹¶å°†å…¶ä¸­çš„ entry ä¸€ä¸€è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœå­—å…¸æ­£åœ¨ rehashï¼Œé‚£ä¹ˆä¼šåœ¨æ‰«æå®Œå“ˆå¸Œè¡¨ 1 åï¼Œç»§ç»­æ‰«æå“ˆå¸Œè¡¨ 2ã€‚éœ€è¦</span></span><br><span class="line"><span class="comment">// æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨è¿­ä»£æœŸé—´ï¼Œç»§ç»­å‘å­—å…¸ä¸­æ·»åŠ æ•°æ®å¯èƒ½æ²¡æ³•è¢«æ‰«æåˆ°ï¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(it *iterator)</span> <span class="title">next</span><span class="params">()</span> *<span class="title">entry</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> it.entry == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> it.waitFirstIteration &#123;</span><br><span class="line">                <span class="comment">// ç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œè¦åšç‚¹ç‰¹åˆ«çš„äº‹æƒ…~</span></span><br><span class="line">                <span class="keyword">if</span> it.safe &#123;</span><br><span class="line">                    <span class="comment">// å‘Šè¯‰ dictï¼Œæœ‰æ­£åœ¨è¿è¡Œçš„å®‰å…¨è¿­ä»£å™¨ï¼Œè¿›è€Œé˜»æ­¢æŸäº›æ“ä½œæ—¶çš„ Rehash æ“ä½œ</span></span><br><span class="line">                    it.d.iterators++</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    it.fingerprint = it.d.fingerprint()</span><br><span class="line">                &#125;</span><br><span class="line">                it.waitFirstIteration = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ht := it.d.hashTables[it.tableIndex]</span><br><span class="line">            <span class="keyword">if</span> it.bucketIndex &gt;= ht.size &#123;</span><br><span class="line">                <span class="keyword">if</span> !it.d.isRehashing() || it.tableIndex != <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ç»§ç»­æ‰«æ</span></span><br><span class="line">                it.tableIndex = <span class="number">1</span></span><br><span class="line">                it.bucketIndex = <span class="number">0</span></span><br><span class="line">                ht = it.d.hashTables[<span class="number">1</span>]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            it.entry = ht.buckets[it.bucketIndex]</span><br><span class="line">            it.bucketIndex++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            it.entry = it.entry.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> it.entry != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> it.entry</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    d := dict.New()</span><br><span class="line">    d.Store(<span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">    d.Store(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line">    fmt.Println(d.Load(<span class="string">"hello"</span>))</span><br><span class="line">    fmt.Println(d.LoadOrStore(<span class="string">"language"</span>, <span class="string">"Eng"</span>))</span><br><span class="line">    d.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        fmt.Println(key, <span class="string">"=&gt;"</span>, value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    _ = d.Resize()</span><br><span class="line">    d.RehashForAWhile(<span class="number">1</span> * time.Microsecond)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¥½å•¦ï¼Œå…³äº Redis å­—å…¸çš„å®ç°ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢å•¦ã€‚ç›¸ä¿¡çœ‹å®Œä¸Šé¢çš„ä»£ç åï¼Œåº”è¯¥å¯ä»¥äº†è§£åˆ° Redis å­—å…¸çš„æ‰©å®¹æœºåˆ¶ã€æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œä»¥åŠå“ˆå¸Œå†²çªè§£å†³æ–¹æ¡ˆã€‚å®Œæ•´çš„å®ç°ä»£ç åŠå…¶å•å…ƒæµ‹è¯•å‚è§ <a href="https://gitee.com/ifaceless/go-redis-dict" target="_blank" rel="noopener">go-redis-dict</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ªé”®å€¼æ•°æ®åº“ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹åœ¨ &lt;a href=&quot;https://ifaceless.space/2019/12/15/redis-low-level-data-structures/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„&lt;/a&gt;  ä¸­æåˆ°çš„ Redis å­—å…¸å®ç°çš„ä¸€äº›ç‰¹ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ”¯æŒæµ·é‡ &lt;code&gt;&amp;lt;key, value&amp;gt;&lt;/code&gt; å­˜å‚¨ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æ¸è¿›å¼ Rehash ç­–ç•¥ï¼Œé¿å…å› ä¸ºéœ€è¦è¿ç§»çš„ buckets å¤ªå¤šå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼ˆRedis æ ¸å¿ƒå¤„ç†é€»è¾‘æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;é»˜è®¤ä½¿ç”¨ SipHash ç®—æ³•è®¡ç®—é”®çš„ hash å€¼ï¼›&lt;/li&gt;
&lt;li&gt;å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œé‡‡ç”¨äº†å¸¸è§çš„é“¾åœ°å€æ³•ï¼Œä¸”æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šæ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼›&lt;/li&gt;
&lt;li&gt;å­—å…¸å†…éƒ¨ç»´æŠ¤äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¼šåœ¨æ‰©å®¹æœŸé—´ï¼ˆRehashï¼‰ä½¿ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="Redis" scheme="/categories/Redis/"/>
    
    
      <category term="Go" scheme="/tags/Go/"/>
    
      <category term="Redis" scheme="/tags/Redis/"/>
    
      <category term="å­—å…¸" scheme="/tags/%E5%AD%97%E5%85%B8/"/>
    
  </entry>
  
  <entry>
    <title>Redis æºç å­¦ä¹ ä¹‹åŸºæœ¬æ•°æ®ç»“æ„</title>
    <link href="/2019/12/15/redis-low-level-data-structures/"/>
    <id>/2019/12/15/redis-low-level-data-structures/</id>
    <published>2019-12-15T06:11:14.000Z</published>
    <updated>2019-12-15T06:17:36.398Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic4.zhimg.com/v2-1d46ebdc21d0364fefecf710d01f473d.jpeg" alt=""></p><p>Redis åº•å±‚çš„åŸºç¡€æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šåŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsdsï¼‰ã€è·³è¡¨ï¼ˆskiplistï¼‰ã€å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€æ•´æ•°é›†åˆï¼ˆintsetï¼‰ï¼Œå¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰ç­‰ï¼Œ<code>t_hash</code>ï¼Œ<code>t_set</code>, <code>t_zset</code>, <code>t_list</code> ç­‰å¯¹å¤–ç±»å‹çš„å†…éƒ¨å®ç°éƒ½ä¾èµ–äºè¿™äº›æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥éå¸¸å€¼å¾—å­¦ä¹ ã€‚</p><a id="more"></a><p>åœ¨å­¦ä¹ æ¯ç§æ•°æ®ç»“æ„æ—¶ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Œåšäº†ä»€ä¹ˆæ ·çš„æƒè¡¡ï¼Ÿæ¯”å¦‚ï¼Œæœ‰äº›æ•°æ®ç»“æ„æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥ä¼šç‰ºç‰²ä¸€å®šçš„æŸ¥æ‰¾æ•ˆç‡ï¼›</li><li>æ¯ç§æ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå…·ä½“åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹åº”ç”¨åˆ°ï¼Ÿ</li><li>ä¸€äº›æ•°æ®ç»“æ„æ¥å£çš„å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å¾ˆå¤šæ•°æ®ç»“æ„åœ¨ä¸Šå±‚ä½¿ç”¨æ—¶ï¼Œä¼šæ ¹æ®éœ€è¦é€‰æ‹©ï¼Œå¿…è¦æ—¶ä¼šè¿›è¡Œè½¬æ¢ã€‚éœ€è¦äº†è§£è½¬æ¢çš„æ—¶æœºå’Œè§¦å‘çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>æŸäº›æ•°æ®ç»“æ„å†…éƒ¨ä¼šæŒ‰éœ€æ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œéœ€è¦å…³æ³¨å®ƒä»¬æ‰©å®¹æˆ–è€…ç¼©å®¹çš„ç­–ç•¥å¦‚ä½•ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘ï¼Ÿ</li></ol><p>æœ¬æ–‡çš„æºç å­¦ä¹ ç¬”è®°æ˜¯åŸºäº Redis 5.0.7 ç‰ˆæœ¬åšçš„ï¼Œè‡ªå·±åšäº†äº›ä¸­æ–‡æ³¨é‡Šï¼Œæ¨é€åˆ°äº† <a href="https://github.com/iFaceless/redis/blob/comment-src/src" target="_blank" rel="noopener">redis comment-src åˆ†æ”¯</a>ï¼Œå‚è€ƒä¹¦ç±ä¸ºã€ŠRedis 5 æºç è®¾è®¡ä¸åˆ†æã€‹ã€‚</p><p><strong>åšäº†ä¸€ä¸ªç®€å•çš„æ€ç»´å¯¼å›¾ï¼Œç®€å•æ€»ç»“äº†å„ä¸ªæ•°æ®ç»“æ„çš„åŸºæœ¬ç‰¹ç‚¹å’Œä¸€äº›å€¼å¾—é˜…è¯»æºç çš„ APIs</strong>ï¼Œå¦‚æœæƒ³è¦å¿«é€Ÿäº†è§£çš„è¯ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°æœ¬æ–‡æœ€åä¸€èŠ‚æŸ¥çœ‹~</p><h1 id="åŠ¨æ€å­—ç¬¦ä¸²"><a href="#åŠ¨æ€å­—ç¬¦ä¸²" class="headerlink" title="åŠ¨æ€å­—ç¬¦ä¸²"></a>åŠ¨æ€å­—ç¬¦ä¸²</h1><p>åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDS, Simple Dynamic Stringï¼‰æ˜¯ Redis ä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹ä¹‹ä¸€ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²å’Œæ•´æ•°ã€‚å¹¶ä¸”å®ƒæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œè¿˜å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²çš„ç»“æŸç¬¦ â€˜\0â€™ï¼Œæ‰€ä»¥éƒ¨åˆ† C æ ‡å‡†åº“ä¸­çš„å­—ç¬¦ä¸²å‡½æ•°ä¹Ÿå¯ä»¥å¯¹ SDS è¿›è¡Œæ“ä½œã€‚</p><p>åŠ¨æ€å­—ç¬¦ä¸²å…ƒä¿¡æ¯åŠå­˜å‚¨å­—ç¬¦ä¸²çš„ buf æ˜¯ç”± sdshdr* ç»´æŠ¤çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __attribute__ ((__packed__)) ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¦æ±‚ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ï¼ŒæŒ‰ç…§å®é™…çš„å­—èŠ‚æ•°è¿›è¡Œå¯¹é½ã€‚</span></span><br><span class="line"><span class="comment">// è¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ä¸ªï¼š</span></span><br><span class="line"><span class="comment">// 1. èŠ‚çº¦å†…å­˜ï¼ˆå¦åˆ™ä¸åŒçš„ sdshdr* å› ä¸ºä¸åŒçš„å­—èŠ‚å¯¹é½æ–¹å¼ï¼Œè€Œå¯¼è‡´å æ®è¾ƒå¤šå†…å­˜ï¼‰</span></span><br><span class="line"><span class="comment">// 2. é€šè¿‡ header è·å¾— buf åœ°å€æ—¶ï¼Œä¸ç”¨è€ƒè™‘ç¹ççš„å­—èŠ‚å¯¹é½é—®é¢˜è€Œå¯¼è‡´è®¡ç®—å¤æ‚</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="comment">// flags çš„ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ä¸‰ä½è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="comment">// len å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="comment">// alloc è¡¨ç¤ºæŸ”æ€§æ•°ç»„åˆ†é…çš„é•¿åº¦ï¼ˆä¸åŒ…å« header å’Œå­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦å·ï¼‰</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="comment">// flags ä½ä¸‰ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ 5 ä½ä¿ç•™</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤–è¿˜æœ‰ sdshdr16, sdshdr32, sdshdr64ï¼ŒåŒºåˆ«ä»…åœ¨äº len, alloc ä½¿ç”¨çš„æ•´æ•°å­—èŠ‚é•¿åº¦</span></span><br></pre></td></tr></table></figure><p>å…³äº SDS çš„å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>å¦‚ä½•å…¼å®¹ C è¯­è¨€å­—ç¬¦ä¸²æ ‡å‡†ï¼Ÿ</strong> SDS è¿”å›çš„å°±æ˜¯æŒ‡å‘å­˜å‚¨å­—ç¬¦ä¸² buf çš„æŒ‡é’ˆï¼Œä¸”ä»¥ â€˜\0â€™ ç»“å°¾ã€‚</li><li><strong>å¦‚ä½•èŠ‚çº¦å†…å­˜ï¼Ÿ</strong> SDS ä¸­æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œæä¾›äº†ä¸åŒç±»å‹çš„ç»“æ„ä½“è¡¨ç¤ºï¼ˆsdshdr5, sdshdr8, sdshdr16, sdshdr32, sdshdr64ï¼‰ï¼Œå¹¶ä¸”ç»“æ„ä½“ä¸­çš„å­—æ®µæŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼ˆ<code>((__packed__))</code>ï¼‰è¿›ä¸€æ­¥å‡å°‘å› é»˜è®¤å­—èŠ‚å¯¹é½æ–¹å¼å¸¦æ¥äº†å†…å­˜æ¶ˆè€—ï¼›åŒæ—¶æŒ‰ç…§å•å­—èŠ‚å¯¹é½ï¼Œä¹Ÿæ–¹ä¾¿åŸºäº header æŒ‡é’ˆè®¡ç®—å‡ºæŸ”æ€§æ•°ç»„çš„æŒ‡é’ˆã€‚</li><li><strong>å¦‚ä½•åšåˆ°äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿ</strong> SDS Header ç»“æ„ä½“ä¸­æ‹¥æœ‰ <code>len</code> å­—æ®µï¼Œè®°å½•äº†å®é™…å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸å«ç»“æŸç¬¦ï¼‰ï¼Œå› æ­¤åœ¨è¯»å–çš„æ—¶å€™å¯ä»¥ç¡®åˆ‡åœ°çŸ¥é“åœ¨å“ªå„¿åœæ­¢ï¼Œä¸ä¼šå—åˆ°ä¸­é—´çš„ â€˜\0â€™ å½±å“ã€‚</li><li><strong>SDS åœ¨åˆ›å»ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œä¸ºä½•å°† sdshdr5 è½¬æˆ sdshdr8ï¼Ÿ</strong> è€ƒè™‘åˆ° sdshdr5 å¯èƒ½éœ€è¦é¢‘ç¹æ‰©å®¹ï¼Œå¯¼è‡´å†…å­˜å¤åˆ¶å¼€é”€ã€‚ä½¿ç”¨ sdshdr8 å¯ä»¥æœ‰æ•ˆç¼“è§£ã€‚</li><li><strong>SDS å¯¹äºçŸ­å­—ç¬¦ä¸²ä¸ºä½•ä½¿ç”¨ sdshdr5ï¼Ÿ</strong> å¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå¤šæ•°çš„å­—ç¬¦ä¸²å¯èƒ½éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²ï¼ˆé•¿åº¦ 32 ä»¥å†…ï¼‰ã€‚</li><li><strong>SDS åœ¨å†™å…¥æ—¶å¯èƒ½ä¼šæ‰©å®¹ï¼Œé‚£ä¹ˆå®ƒçš„æ‰©å®¹ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ</strong>å®ƒçš„ç­–ç•¥æ¯”è¾ƒç®€å•ï¼Œå¦‚æœ buf å‰©ä½™ç©ºé—´ï¼ˆalloc-lenï¼‰èƒ½å¤Ÿæ”¾ä¸‹æ–°å¢çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ™ä¸ä¼šæœ‰å®è´¨çš„æ‰©å®¹å‘ç”Ÿï¼›å¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿï¼Œåˆ™éœ€è¦çœ‹ len+newLen çš„é•¿åº¦å€¼ï¼Œå¦‚æœå°äº 1MBï¼Œåˆ™æŒ‰ç…§ 2 å€æ‰©å®¹ï¼›å¦åˆ™æ¯æ¬¡å¢åŠ  1MBã€‚åœ¨æ‰©å®¹åï¼Œè¿˜è¦çœ‹æ–°çš„ header ç±»å‹ï¼ˆflags å­—æ®µè¡¨ç¤ºï¼‰æ˜¯å¦å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ realloc åŸåœ°æ‰©å®¹å³å¯ï¼›å¦åˆ™éœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿæ–°ç©ºé—´ï¼Œå¹¶ä½¿ç”¨ <code>memcopy</code> å¤åˆ¶æ•°æ®ã€‚å®Œæˆæ‰©å®¹åï¼Œéœ€è¦æ›´æ–° SDS çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶è¿”å›æ–°çš„ buf æŒ‡é’ˆï¼ˆä¹Ÿå¯èƒ½æŒ‡å‘åŸæ¥ä½ç½®ï¼Œå…·ä½“çœ‹æ‰©å®¹æ—¶çš„ç­–ç•¥æ‰§è¡Œï¼‰ã€‚</li></ol><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>è¯¦ç»†çš„æºç æ³¨é‡Šå‚è§ <a href="https://github.com/iFaceless/redis/blob/9366cba9171ea96f54b96f7d83e654958fe9b71f/src/sds.c#L90" target="_blank" rel="noopener">è¿™é‡Œ</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sdsnewlen åˆ›å»ºä¸€ä¸ªæ–°çš„ sds å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ init æŒ‡å‘çš„å†…å®¹åˆå§‹åŒ–</span></span><br><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh;</span><br><span class="line">    sds s;</span><br><span class="line">    <span class="keyword">char</span> type = sdsReqType(initlen);</span><br><span class="line">    <span class="comment">// ç©ºå­—ç¬¦ä¸²åˆ›å»ºé€šå¸¸éƒ½éœ€è¦æ‰§è¡Œ append è¿½åŠ å­—ç¬¦ä¸²ã€‚ä½¿ç”¨ type 8 æ¯”è¾ƒé€‚åˆï¼Œ</span></span><br><span class="line">    <span class="comment">// type 5 å¯èƒ½ç©ºé—´ä¸è¶³ï¼Œè¿˜éœ€è¦æ‰§è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="number">0</span>) type = SDS_TYPE_8;</span><br><span class="line">    <span class="keyword">int</span> hdrlen = sdsHdrSize(type); <span class="comment">// æ ¹æ®æ•°æ®ç±»å‹ç¡®å®š header é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp; <span class="comment">/* flags pointer. */</span></span><br><span class="line">    sh = s_malloc(hdrlen+initlen+<span class="number">1</span>); <span class="comment">// åˆ†é… sds å†…å­˜ï¼Œ+1 ä¸ºäº†å­˜å‚¨ '\0'</span></span><br><span class="line">    <span class="keyword">if</span> (init==SDS_NOINIT)</span><br><span class="line">        init = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!init)</span><br><span class="line">        <span class="built_in">memset</span>(sh, <span class="number">0</span>, hdrlen+initlen+<span class="number">1</span>); <span class="comment">// å†…å­˜åˆå§‹åŒ–ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    s = (<span class="keyword">char</span>*)sh+hdrlen; <span class="comment">// æ‹¿åˆ°æŒ‡å‘ buf çš„æŒ‡é’ˆ</span></span><br><span class="line">    fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>; <span class="comment">// point to flag, æ³¨æ„ flag å…¶å®æ˜¯ unsigned char ç±»å‹</span></span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_5: &#123;</span><br><span class="line">            <span class="comment">// type 5 çš„ flag æ¯”è¾ƒç‰¹æ®Šï¼Œç±»å‹ä¿ç•™åœ¨ä½ 3 ä½</span></span><br><span class="line">            *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SDS_TYPE_8: &#123;</span><br><span class="line">            SDS_HDR_VAR(<span class="number">8</span>,s);</span><br><span class="line">            sh-&gt;len = initlen;</span><br><span class="line">            sh-&gt;alloc = initlen;</span><br><span class="line">            *fp = type;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// SDS_TYPE_16, SDS_TYPE_32, SDS_TYPE_64...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (initlen &amp;&amp; init)</span><br><span class="line">        <span class="built_in">memcpy</span>(s, init, initlen); <span class="comment">// å°†ç”¨æˆ·æŒ‡å®šåŒºåŸŸçš„æ•°æ®æ‹·è´è¿‡æ¥ï¼Œä¸è€ƒè™‘ \0ï¼ŒäºŒè¿›åˆ¶å®‰å…¨</span></span><br><span class="line">    s[initlen] = <span class="string">'\0'</span>; <span class="comment">// C è¯­è¨€å­—ç¬¦ä¸²ä»¥ '\0' ç»“å°¾</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// s å®é™…æŒ‡å‘çš„æ˜¯ buf ä½ç½®ï¼Œè¿™é‡Œéœ€è¦è®¡ç®—å‡º header æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// flag å§‹ç»ˆä½äº buf å‰é¢ï¼Œæ‰€ä»¥ s[-1] å¯ä»¥å¾—åˆ° flagï¼Œè¿›è€Œ</span></span><br><span class="line">    <span class="comment">// ç¡®å®š typeï¼Œä»è€Œå¯ä»¥è®¡ç®—å‡º header é•¿åº¦</span></span><br><span class="line">    s_free((<span class="keyword">char</span>*)s-sdsHdrSize(s[<span class="number">-1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh, *newsh;</span><br><span class="line">    <span class="keyword">size_t</span> avail = sdsavail(s); <span class="comment">// ç¡®å®š buf å‰©ä½™çš„ç©ºé—´ï¼ˆalloc-lenï¼‰</span></span><br><span class="line">    <span class="keyword">size_t</span> len, newlen;</span><br><span class="line">    <span class="keyword">char</span> type, oldtype = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class="line">    <span class="keyword">int</span> hdrlen;</span><br><span class="line">    <span class="comment">/* Return ASAP if there is enough space left. */</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= addlen)</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    <span class="comment">// ç¡®å®šç°æœ‰å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">    len = sdslen(s);</span><br><span class="line">    <span class="comment">// è·å¾—å­—ç¬¦ä¸²å¯¹åº”çš„ sdshdr æŒ‡é’ˆ</span></span><br><span class="line">    sh = (<span class="keyword">char</span> *)s - sdsHdrSize(oldtype);</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„æ–°é•¿åº¦æ˜¯åé¢æ‰©å®¹ç­–ç•¥æ‰§è¡Œçš„ä¾æ®</span></span><br><span class="line">    newlen = (len + addlen);</span><br><span class="line">    <span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class="line">        <span class="comment">// ç›®å‰æ˜¯ 1MB ä»¥å†…ï¼Œ2 å€æ‰©å®¹</span></span><br><span class="line">        newlen *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éƒ½æ˜¯åŠ  1MB</span></span><br><span class="line">        newlen += SDS_MAX_PREALLOC;</span><br><span class="line">    type = sdsReqType(newlen);</span><br><span class="line">    <span class="comment">/* Don't use type 5: the user is appending to the string and type 5 is</span></span><br><span class="line"><span class="comment">     * not able to remember empty space, so sdsMakeRoomFor() must be called</span></span><br><span class="line"><span class="comment">     * at every appending operation. */</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5)</span><br><span class="line">        type = SDS_TYPE_8;</span><br><span class="line">    hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="keyword">if</span> (oldtype == type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç±»å‹ä¸å˜ï¼Œåˆ™æ‰§è¡Œæ‰©å®¹</span></span><br><span class="line">        newsh = s_realloc(sh, hdrlen + newlen + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// è·å–æ–°çš„ sds æŒ‡å‘</span></span><br><span class="line">        s = (<span class="keyword">char</span> *)newsh + hdrlen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Since the header size changes, need to move the string forward,</span></span><br><span class="line"><span class="comment">         * and can't use realloc */</span></span><br><span class="line">        <span class="comment">// ç”±äº header å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ malloc å¼€è¾Ÿç©ºé—´äº†</span></span><br><span class="line">        newsh = s_malloc(hdrlen + newlen + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// å°† sds ä¸­çš„å†…å®¹æ‹·è´åˆ°æ–°çš„ç©ºé—´ï¼ŒåŒ…æ‹¬ \0</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)newsh + hdrlen, s, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ—§çš„å†…å­˜</span></span><br><span class="line">        s_free(sh);</span><br><span class="line">        <span class="comment">// è·å–æ–°çš„ sds æŒ‡é’ˆ</span></span><br><span class="line">        s = (<span class="keyword">char</span> *)newsh + hdrlen;</span><br><span class="line">        <span class="comment">// æ›´æ–° flags</span></span><br><span class="line">        s[<span class="number">-1</span>] = type;</span><br><span class="line">        <span class="comment">// æ›´æ–°é•¿åº¦ä¿¡æ¯</span></span><br><span class="line">        sdssetlen(s, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°åˆ†é…çš„ç©ºé—´å¤§å°</span></span><br><span class="line">    sdssetalloc(s, newlen);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è·³è¡¨ï¼ˆskiplistï¼‰"><a href="#è·³è¡¨ï¼ˆskiplistï¼‰" class="headerlink" title="è·³è¡¨ï¼ˆskiplistï¼‰"></a>è·³è¡¨ï¼ˆskiplistï¼‰</h1><p>è·³è¡¨æ˜¯ Redis é›†åˆï¼ˆzsetï¼‰åº•å±‚çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼ˆå¦ä¸€ç§æ˜¯ ziplistï¼‰ã€‚è·³è¡¨çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>åŸç†ç®€å•ï¼Œå®ç°éš¾åº¦è¿œä½äºå¹³è¡¡æ ‘ï¼ˆçº¢é»‘æ ‘ï¼‰ï¼›</li><li>å¯¹äºæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤ï¼Œå¹³å‡ O(logN) æ—¶é—´å¤æ‚åº¦ï¼Œæ•ˆç‡å’Œçº¢é»‘æ ‘ç›¸å½“ï¼›</li><li>å†…å­˜å¼€é”€ç›¸å¯¹å¹³è¡¡æ ‘å¹¶æ²¡æœ‰ç‰¹åˆ«å¤§ï¼›</li><li>ç‰¹åˆ«å®¹æ˜“å®ç° Redis zset ä¸­èŒƒå›´æŸ¥è¯¢ã€‚</li></ol><p>è·³è¡¨æ ¸å¿ƒè¦ç´ ï¼š<strong>åˆ†å±‚</strong> + <strong>æœ‰åºé“¾è¡¨</strong>ã€‚</p><p>è·³è¡¨æŸ¥æ‰¾è¿‡ç¨‹æè¿°ï¼šä»æœ€ä¸Šå±‚ä¾æ¬¡å‘åæŸ¥æ‰¾ï¼Œå¦‚æœæœ¬å±‚çš„ next èŠ‚ç‚¹å¤§äºè¦æŸ¥æ‰¾çš„å€¼ï¼Œæˆ–è€… next èŠ‚ç‚¹ä¸º NULLï¼Œåˆ™ä»æœ¬èŠ‚ç‚¹å¼€å§‹ï¼Œé™ä½ä¸€å±‚ç»§ç»­å¾€åæŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œåˆ™è¿”å›ï¼›å¦åˆ™è¿”å› NULLã€‚</p><p><em>æ­¤å‰ä½¿ç”¨ Go è¯­è¨€å°è¯•å®ç°äº†ä¸‹ Redis è·³è¡¨ï¼Œç›¸å…³æ–‡ç« å‚è§ <a href="https://zhuanlan.zhihu.com/p/96849002" target="_blank" rel="noopener">Go è¯­è¨€å®ç° Redis è·³è¡¨</a>ï¼Œæºç åŠæ³¨é‡Šå‚è§ <a href="https://link.zhihu.com/?target=https%3A//gitee.com/ifaceless/goskiplist/tree/master" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚æ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥é˜…è¯»ä¸‹~</em></p><h2 id="Redis-è·³è¡¨å®ç°ç‰¹ç‚¹"><a href="#Redis-è·³è¡¨å®ç°ç‰¹ç‚¹" class="headerlink" title="Redis è·³è¡¨å®ç°ç‰¹ç‚¹"></a>Redis è·³è¡¨å®ç°ç‰¹ç‚¹</h2><p><img src="https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png" alt=""></p><ol start="0"><li>æœ€å¤šæœ‰ 64 å±‚ï¼Œå¯ä»¥è¡¨ç¤º 2^64 ä¸ªå…ƒç´ ï¼›</li><li>æ‹¥æœ‰ backward åé€€æŒ‡é’ˆï¼Œæ–¹ä¾¿åå‘éå†ï¼›</li><li>æ·»åŠ äº† span å­—æ®µï¼Œè®°å½• forward æŒ‡å‘çš„èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„é—´éš”ã€‚span è¶Šå¤§ï¼Œè·³è¿‡çš„èŠ‚ç‚¹ä¼šè¶Šå¤šã€‚åœ¨è®¡ç®—æ’åï¼ˆrankï¼‰æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ span è®¡ç®—å¾—åˆ°ï¼›</li><li>æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œå±‚é«˜æ˜¯é€šè¿‡ <code>zlsRandomLevel()</code> å‡½æ•°éšæœºç”Ÿæˆçš„ï¼ŒèŒƒå›´æ˜¯ [1, 64]ã€‚ä½†æ˜¯è¯¥å‡½æ•°ä¼šä¿è¯è¶Šé«˜ level å€¼çš„å‡ºç°çš„æ¦‚ç‡è¶Šä½ã€‚èŠ‚ç‚¹çš„å±‚é«˜ç¡®å®šåï¼Œå°†ä¸ä¼šæ”¹è¾¹ï¼›</li><li>èŠ‚ç‚¹ä¸­çš„ score å…è®¸é‡å¤ã€‚</li></ol><h2 id="è·³è¡¨çš„å…·ä½“åº”ç”¨"><a href="#è·³è¡¨çš„å…·ä½“åº”ç”¨" class="headerlink" title="è·³è¡¨çš„å…·ä½“åº”ç”¨"></a>è·³è¡¨çš„å…·ä½“åº”ç”¨</h2><p>zset ä¼šä½¿ç”¨è·³è¡¨å­˜å‚¨æ•°æ®ï¼Œä½†æ˜¯å®ƒä¼šæ ¹æ®é…ç½® <code>zset-max-ziplist-entries 128</code> å’Œ <code>zset-max-ziplist-value 64</code> å€¼æ¥ç¡®å®šè¯¥ä½¿ç”¨è·³è¡¨è¿˜æ˜¯ ziplistã€‚å¦å¤–ï¼Œåœ¨æ–°å¢å…ƒç´ æ—¶ï¼Œå¦‚æœåŸå…ˆæ˜¯ ziplistï¼Œå½“ä¸´ç•Œæ¡ä»¶è¾¾åˆ°æ—¶ï¼Œä¼šè¢«è½¬æ¢æˆ skiplistï¼Œè€Œä¸”è½¬å˜åå°±ä¸å¯é€†äº†ã€‚</p><h2 id="æ ¸å¿ƒæºç -1"><a href="#æ ¸å¿ƒæºç -1" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>ä¸è·³è¡¨ç›¸å…³çš„å‡ ä¸ªé‡è¦çš„å‡½æ•°ä½œäº†æ³¨é‡Šï¼Œå‚è§ <a href="https://github.com/iFaceless/redis/blob/9366cba9171ea96f54b96f7d83e654958fe9b71f/src/t_zset.c#L144" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚éœ€è¦é‡ç‚¹å…³æ³¨çš„å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zskiplist *<span class="title">zslCreate</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslDeleteNode</span><span class="params">(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslDelete</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele, zskiplistNode **node)</span></span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslUpdateScore</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> curscore, sds ele, <span class="keyword">double</span> newscore)</span></span></span><br></pre></td></tr></table></figure></p><p>åœ¨çœ‹æºç æ—¶ï¼Œä¼šç»å¸¸çœ‹åˆ° <code>update[]</code> æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„æ˜¯ç”¨æ¥å­˜æ”¾æ¯ä¸€å±‚éœ€è¦è¢«æ›´æ–°çš„èŠ‚ç‚¹ï¼ˆåœ¨å¢åŠ ã€åˆ é™¤èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°ï¼‰ï¼ŒæŠŠå®ƒçœ‹æˆ <code>pending_update_nodes</code> æˆ–è®¸ä¼šæ›´å¥½ç†è§£ç‚¹ã€‚<br>å¦å¤–ï¼Œåœ¨å¢ã€åˆ ã€æ”¹çš„æ—¶å€™ï¼Œéƒ½ä¼šæ¶‰åŠåˆ° <code>span</code> çš„æ›´æ–°ï¼Œéœ€è¦ä»”ç»†æ–Ÿé…Œè®¡ç®—é€»è¾‘ï¼Œä¸€ä¸å°å¿ƒå°±ç®—é”™äº†ã€‚</p><h1 id="å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰"><a href="#å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰" class="headerlink" title="å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰"></a>å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰</h1><p>å‹ç¼©è¡¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæ˜¯ä¸€ç§ä¸ºèŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„æ•°æ®ç»“æ„ã€‚å¯ä»¥å­˜å‚¨å¤šä¸ªå…ƒç´ ï¼Œä¸”æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯æ•´æ•°æˆ–è€…å­—ç¬¦ä¸²ï¼ˆè¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—èŠ‚æ•°ç»„ï¼‰ã€‚ä¸¤ç«¯æ“ä½œï¼ˆpop/pushï¼‰æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œä½†è€ƒè™‘åˆ°å®ƒæ¯æ¬¡æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œéƒ½éœ€è¦è°ƒæ•´å†…å­˜ï¼ˆæ‰©å®¹æˆ–è€…ç¼©å°å†…å­˜å ç”¨ï¼‰ï¼Œæ‰€ä»¥å®é™…çš„æ—¶é—´å¤æ‚åº¦å’Œå®ƒå ç”¨çš„å†…å­˜æœ‰å…³ã€‚</p><p>ziplist åœ¨<strong>æ•£åˆ—è¡¨ã€åˆ—è¡¨å’Œæœ‰åºé›†åˆ</strong>ä¸­å‡æœ‰ï¼ˆç›´æ¥æˆ–é—´æ¥åœ°ï¼‰åº”ç”¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>object encoding &lt;key&gt;</code> æ¥æŸ¥çœ‹å…·ä½“çš„ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; zadd visitors 1.0 a</span><br><span class="line">&gt; object encoding visitors</span><br><span class="line">&quot;ziplist&quot;</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h2><p>åœ¨ Redis çš„ <code>ziplist.c</code> ä¸­ï¼Œä½œè€…åœ¨æ³¨é‡Šä¸­ç»™å‡ºäº†å‹ç¼©åˆ—è¡¨å­˜å‚¨å¸ƒå±€ï¼Œå¹¶ä¸”ç»™å‡ºäº†éå¸¸è¯¦ç»†çš„è¯´æ˜å’Œç¤ºä¾‹ï¼Œå€¼å¾—é˜…è¯»ã€‚æ•´ä½“æ¥çœ‹ï¼Œå‹ç¼©åˆ—è¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š<br><img src="https://pic4.zhimg.com/80/v2-0da8094f90661a53f47145881faf3315.png" alt=""></p><table><thead><tr><th>å­—æ®µå</th><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>å‹ç¼©è¡¨å­—èŠ‚é•¿åº¦ï¼ˆåŒ…æ‹¬ <code>zlbytes</code> è‡ªå·±ï¼‰</td></tr><tr><td>zltail</td><td>uint32_t</td><td>å°¾å…ƒç´ ç›¸å¯¹äºå‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»ï¼Œå¦‚æ­¤æ–¹ä¾¿å¿«é€Ÿ pop æœ€åä¸€ä¸ªå…ƒç´ </td></tr><tr><td>zllen</td><td>uint16_t</td><td>è¡¨ç¤º entries çš„ä¸ªæ•°ï¼Œæœ€å¤§æœ‰æ•ˆå€¼ä¸º <code>2^16-2</code>ï¼Œä¸€æ—¦è¶…å‡ºï¼Œè¯¥å€¼å›ºå®šä¸º <code>2^16-1</code>ï¼Œå¹¶ä¸”éœ€è¦éå†æ•´ä¸ªåˆ—è¡¨æ‰èƒ½å¾—åˆ°å‡†ç¡®çš„é•¿åº¦</td></tr><tr><td>zlend</td><td>uint8_t</td><td>å›ºå®šä¸º <code>0xff</code>ï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„ç»“å°¾</td></tr></tbody></table><h2 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ¯ä¸ª entry ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://pic4.zhimg.com/80/v2-84cb4d8cd05b321b4f611a492471c88a.png" alt=""></p><p>å…¶ä¸­ï¼Œ<code>prevlen</code> è¡¨ç¤ºå‰ä¸€ä¸ª <code>entry</code> çš„å­—èŠ‚æ•°ï¼Œä¾¿äºä»åå‘å‰éå†ï¼›<code>encoding</code> åˆ™è¡¨ç¤ºå½“å‰ <code>entry</code> çš„ç¼–ç ï¼ˆæ•´æ•°ç±»å‹ï¼Ÿå­—ç¬¦ä¸²ç±»å‹ï¼Ÿï¼‰ï¼›è€Œ <code>entry-data</code> åˆ™æ˜¯çœŸå®å­˜å‚¨å†…å®¹çš„éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œè¿™é‡Œçš„ <code>prevlen</code> å’Œ <code>encoding</code> éƒ½æ˜¯å˜é•¿çš„ï¼Œè€Œ <code>entry-data</code> åˆ™å¯èƒ½æ²¡æœ‰ï¼ˆæ¯”å¦‚å­˜å‚¨å°æ•´æ•° 0~12 æ—¶ï¼‰ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>prevlen</code> é‡‡ç”¨ <code>uint8_t</code> ç±»å‹ï¼Œå¯è¡¨ç¤ºæœ€å¤š 253 å­—èŠ‚é•¿åº¦ï¼Œè¶…å‡º 253 åï¼Œå°†ä¼šä½¿ç”¨ 5 ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// å¸¸è§„æƒ…å†µä¸‹</span><br><span class="line">&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;</span><br><span class="line">// é•¿åº¦è¶…è¿‡ 253 å</span><br><span class="line">0xFE &lt;4 å­—èŠ‚ï¼Œå°ç«¯åº prevlen&gt; &lt;encoding&gt; &lt;entry&gt;</span><br></pre></td></tr></table></figure><p><code>encoding</code> å­—æ®µä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒå ç”¨å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå’Œå®é™…è¦å­˜å‚¨çš„å†…å®¹æœ‰å…³ï¼š</p><ul><li>å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ <code>encoding</code> çš„å‰ä¸¤ä½è¡¨ç¤ºç±»å‹ï¼Œå‰©ä¸‹çš„åˆ™è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼š<ul><li><code>|00pppppp|</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 64 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œ<code>pppppp</code> è¡¨ç¤º 6 ä½æ— ç¬¦å·æ•´æ•°</li><li><code>|01pppppp|qqqqqqqq| - 2 å­—èŠ‚</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^14 å­—èŠ‚çš„å­—ç¬¦ä¸²</li><li><code>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 å­—èŠ‚</code>ï¼šè¡¨ç¤ºé•¿åº¦å°äº 2^32 çš„å­—ç¬¦ä¸² </li></ul></li><li>å¦‚æœæ˜¯æ•´æ•°ç±»å‹ï¼Œåˆ™ <code>encoding</code> çš„å‰ä¸¤ä½æ€»æ˜¯ 1ï¼Œç´§æ¥ç€çš„ä¸¤ä½åˆ™è¡¨ç¤ºå…·ä½“çš„æ•´æ•°ç±»å‹ï¼š<ul><li><code>|11000000|</code>ï¼šint16</li><li><code>|11010000|</code>ï¼šint32</li><li><code>|11100000|</code>ï¼šint64</li><li><code>|11110000|</code>ï¼š24 ä½æœ‰ç¬¦å·æ•´æ•°</li><li><code>|11111110|</code>ï¼š8 ä½æœ‰ç¬¦å·æ•´æ•°</li><li><code>|1111xxxx|</code>ï¼šè¡¨ç¤º 4 ä½ç«‹å³æ•´æ•°ï¼ˆimediate integerï¼‰ï¼Œ0~12 æ— ç¬¦å·æ•´æ•°ï¼Œæ­¤æ—¶æ²¡æœ‰ <code>entry-data</code> å­—æ®µäº†</li></ul></li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ ¹æ®ä¸Šé¢æè¿°çš„ ziplist ç¼–ç ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ¡ä»¶ä¸‹å®ƒä¼šå ç”¨è¾ƒå¤šå†…å­˜ï¼Ÿä¸ºä»€ä¹ˆè¯´ ziplist é€‚åˆå­˜å‚¨ä¸ªæ•°è¾ƒå°‘ï¼Œä¸”é•¿åº¦è¾ƒçŸ­çš„å…ƒç´ å‘¢ï¼Ÿ</p><ol><li>é€šè¿‡ <code>zzlen</code> å¯çŸ¥ï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°è¶…å‡º <code>2^16-2</code> æ—¶ï¼Œéœ€è¦éå†æ•´ä¸ª ziplist å…ƒç´ æ‰å¯ä»¥çŸ¥é“å…·ä½“çš„é•¿åº¦ï¼Œæ•ˆç‡è‡ªç„¶ä¼šé™ä½å¾ˆå¤šï¼›</li><li>é€šè¿‡ <code>prevlen</code> å¯çŸ¥ï¼Œå¦‚æœå‰ä¸€ä¸ª <code>entry</code> è¶…å‡ºå…¶è¡¨ç¤ºçš„èŒƒå›´æ—¶ï¼ˆ253 å­—èŠ‚ï¼‰ï¼Œå°±éœ€è¦ç”±åŸæ¥çš„ 1 ä¸ªå­—èŠ‚å˜æˆ 5 å­—èŠ‚è¡¨ç¤ºï¼›</li><li>é€šè¿‡ <code>encoding</code> å¯çŸ¥ï¼Œå¯¹äºå­—ç¬¦ä¸²ç±»å‹å…ƒç´ ï¼Œé•¿åº¦è¶Šé•¿ï¼Œ<code>encoding</code> éœ€è¦å ç”¨çš„å­—èŠ‚è¶Šå¤šã€‚å°¤å…¶æ˜¯åœ¨è¶…å‡º <code>2^14-1</code>  æ—¶ï¼Œæ–°çš„ <code>encoding</code> è¿˜è¦æµªè´¹ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸­çš„å 6 ä½ï¼Œè€Œä½¿ç”¨åé¢çš„ 32 ä½æ•´æ•°æ¥è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ã€‚</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå½±å“å†…å­˜å ç”¨å’Œæ‰§è¡Œæ•ˆç‡çš„ä¸»è¦å› ç´ å¦‚ä¸‹ï¼š</p><ol><li>å…ƒç´ ä¸ªæ•°ï¼›</li><li>å…ƒç´ ç±»å‹ï¼›</li><li>å…ƒç´ é•¿åº¦ã€‚</li></ol><h2 id="æ ¸å¿ƒæºç -2"><a href="#æ ¸å¿ƒæºç -2" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>ä¸ºäº†æ–¹ä¾¿è·å¾—æ¯ä¸ª entry ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œåœ¨ <code>ziplist.c</code> ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>zlentry</code> ç»“æ„ä½“ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯è¯¥ç»“æ„ä½“å¹¶é entry å®é™…ç¼–ç çš„å¸ƒå±€ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zlentry å­˜åœ¨çš„ç›®çš„å°±æ˜¯ä¿å­˜æ¯ä¸ª entry è§£ç åçš„å…ƒä¿¡æ¯ã€‚å› ä¸ºå®é™…æ¯æ¬¡å¯¹ length, encoding</span></span><br><span class="line"><span class="comment">// ç­‰è¿›è¡Œè§£ç æ˜¯æ¯”è¾ƒå¤æ‚çš„è¿ç®—ï¼Œè¿™é‡Œç¼“å­˜ä¸‹æ¥ä¹Ÿä¾¿äºåç»­æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œzlentry å¹¶éçœŸå®çš„ entry ç¼–ç ç»“æ„ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zlentry</span> &#123;</span></span><br><span class="line">    <span class="comment">// prevrawlensize è¡¨ç¤º `prevlen` å ç”¨äº†å‡ ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> prevrawlensize; <span class="comment">/* Bytes used to encode the previous entry len*/</span></span><br><span class="line">    <span class="comment">// prevrawlen è¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å®é™…é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> prevrawlen; <span class="comment">/* Previous entry len. */</span></span><br><span class="line">    <span class="comment">// lensize è¡¨ç¤º `encoding` å ç”¨äº†å‡ ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> lensize; <span class="comment">/* Bytes used to encode this entry type/len.</span></span><br><span class="line"><span class="comment">                                    For example strings have a 1, 2 or 5 bytes</span></span><br><span class="line"><span class="comment">                                    header. Integers always use a single byte.*/</span></span><br><span class="line">    <span class="comment">// len è¡¨ç¤º entry å†…å®¹çœŸæ­£çš„é•¿åº¦ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼›å¦‚æœæ˜¯æ•´æ•°</span></span><br><span class="line">    <span class="comment">// åˆ™å¯èƒ½çš„å€¼ä¸º 0ï¼ˆ4 ä½å°æ•´æ•°ï¼‰ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ8ï¼ˆå’Œå…·ä½“çš„ int ç±»å‹æœ‰å…³ï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len; <span class="comment">/* Bytes used to represent the actual entry.</span></span><br><span class="line"><span class="comment">                                    For strings this is just the string length</span></span><br><span class="line"><span class="comment">                                    while for integers it is 1, 2, 3, 4, 8 or</span></span><br><span class="line"><span class="comment">                                    0 (for 4 bit immediate) depending on the</span></span><br><span class="line"><span class="comment">                                    number range. */</span></span><br><span class="line">    <span class="comment">// headersize è¡¨ç¤ºæ•´ä¸ª header éƒ¨åˆ†é•¿åº¦ï¼š&lt;prevlen&gt; + &lt;encoding&gt;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> headersize; <span class="comment">/* prevrawlensize + lensize. */</span></span><br><span class="line">    <span class="comment">// encoding è¡¨ç¤ºå…·ä½“çš„ç¼–ç æ–¹å¼ï¼Œå¦‚æœ `ZIP_STR_*`,`ZIP_INT_*`</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯å°æ•´æ•°ï¼Œè¿˜è¦åšèŒƒå›´æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> encoding; <span class="comment">/* Set to ZIP_STR_* or ZIP_INT_* depending on</span></span><br><span class="line"><span class="comment">                                    the entry encoding. However for 4 bits</span></span><br><span class="line"><span class="comment">                                    immediate integers this can assume a range</span></span><br><span class="line"><span class="comment">                                    of values and must be range-checked. */</span></span><br><span class="line">    <span class="comment">// p æŒ‡å‘å…ƒç´ å¼€å¤´çš„æŒ‡é’ˆï¼Œå®é™…æŒ‡å‘çš„å°±æ˜¯ `prevlen` ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *p; <span class="comment">/* Pointer to the very start of the entry, that</span></span><br><span class="line"><span class="comment">                                    is, this points to prev-entry-len field. */</span></span><br><span class="line">&#125; zlentry;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç”»ä¸€ä¸ªç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://pic2.zhimg.com/v2-74aa62891936d8a5ebd929fe2fcf4656.jpg" alt=""></p><p>ziplist ç›¸å…³çš„æºç å‚è§ <a href="https://github.com/iFaceless/redis/blob/comment-src/src/ziplist.c" target="_blank" rel="noopener">æ­¤å¤„</a>ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistNew</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistPush</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">int</span> slen, <span class="keyword">int</span> where)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistInsert</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *p, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">unsigned</span> <span class="keyword">int</span> slen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistDelete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> **p)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">ziplistFind</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *p, <span class="keyword">unsigned</span> <span class="keyword">char</span> *vstr, <span class="keyword">unsigned</span> <span class="keyword">int</span> vlen, <span class="keyword">unsigned</span> <span class="keyword">int</span> skip)</span></span>;</span><br></pre></td></tr></table></figure><p>ziplist ä¸­æ¯”è¾ƒæ™¦æ¶©æˆ–è€…æ¯ç‡¥çš„éƒ¨åˆ†æ˜¯ç¼–ç ã€è§£ç æ“ä½œï¼›å…¶æ¬¡ï¼Œæ¯æ¬¡å¢åŠ æˆ–è€…ç§»é™¤å…ƒç´ æ—¶ï¼Œéƒ½æ¶‰åŠåˆ°å¾ˆå¤šå†…å­˜æ“ä½œï¼ˆåˆ†é…ç©ºé—´ã€å†…å­˜æ‹·è´ï¼‰ä»¥åŠ entry header çš„è°ƒæ•´ã€‚æƒ³è¦å†™å‡ºå¯é çš„ä»£ç æ¥ï¼Œè¿˜æ˜¯éœ€è¦å¿ƒæ€ç¼œå¯†ï¼Œé€»è¾‘æ¸…æ™°æ‰å¯ä»¥ï¼Œå¤§ä½¬ä»¬çš„ç¼–ç èƒ½åŠ›å®åœ¨æ˜¯å¤ªå¼ºæ‚äº†ï¼</p><p>è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯ï¼Œå…ƒç´ çš„æ’å…¥å’Œåˆ é™¤ï¼Œå¯èƒ½ä¼šäº§ç”Ÿ<strong>è¿é”æ›´æ–°</strong>é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è‡ªæ’å…¥ç‚¹ï¼ˆæˆ–åˆ é™¤ç‚¹ï¼‰åç»­çš„ entry prevlen éƒ½éœ€è¦ä¿®æ”¹ï¼ˆè¿˜è®°å¾—å‰é¢æåˆ°çš„ entry prevlen æ˜¯å˜é•¿çš„å—ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å°† prevlen å¢é•¿åˆ° 5 å­—èŠ‚å®¹çº³æ›´å¤§çš„å€¼ï¼›ä½†æ˜¯åè¿‡æ¥ï¼Œå¹¶æ²¡æœ‰å…è®¸ç¼©å®¹ï¼‰ã€‚ä¸è¿‡è¿™ç§æƒ…å†µï¼Œåªæœ‰åœ¨åç»­å…ƒç´ çš„å¤§å°æ¥è¿‘äº <code>ZIP_BIG_PREVLEN</code> æ‰å¯èƒ½å‘ç”Ÿï¼Œæ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥å®é™…ä¸Šä¹Ÿæ²¡åšä»€ä¹ˆä¼˜åŒ–ã€‚å…·ä½“ç­–ç•¥çš„å®ç°å¯ä»¥å‚è€ƒ <code>__ziplistCascadeUpdate()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *__ziplistCascadeUpdate(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;</span><br><span class="line">    <span class="keyword">size_t</span> offset, noffset, extra;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *np;</span><br><span class="line">    zlentry cur, next;</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="keyword">while</span> (p[<span class="number">0</span>] != ZIP_END)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰ entry é•¿åº¦å­˜å‚¨éœ€è¦çš„å­—èŠ‚æ•°ï¼šrawlensize</span></span><br><span class="line">        zipEntry(p, &amp;cur);</span><br><span class="line">        rawlen = cur.headersize + cur.len;</span><br><span class="line">        rawlensize = zipStorePrevEntryLength(<span class="literal">NULL</span>, rawlen);</span><br><span class="line">        <span class="keyword">if</span> (p[rawlen] == ZIP_END)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        zipEntry(p + rawlen, &amp;next);</span><br><span class="line">        <span class="comment">// å¦‚æœé•¿åº¦ä¸å˜ï¼Œåˆ™ç›´æ¥é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (next.prevrawlen == rawlen)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (next.prevrawlensize &lt; rawlensize) &#123;</span><br><span class="line">            <span class="comment">// ä¸‹ä¸€ä¸ªå…ƒç´ çš„ prevlen éœ€è¦æ›´å¤šå­—èŠ‚æ¥å­˜å‚¨ prevrawlen å€¼</span></span><br><span class="line">            offset = p - zl;</span><br><span class="line">            extra = rawlensize - next.prevrawlensize;</span><br><span class="line">            <span class="comment">// æ‰©å®¹ä»¥æ”¯æŒå­˜å‚¨æ›´é•¿çš„ rawlen</span></span><br><span class="line">            zl = ziplistResize(zl, curlen + extra); <span class="comment">// å¢åŠ  extra ç©ºé—´</span></span><br><span class="line">            p = zl + offset;</span><br><span class="line">            np = p + rawlen;</span><br><span class="line">            noffset = np - zl;</span><br><span class="line">            <span class="comment">// æ›´æ–° tail åç§»ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„ä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> ((zl + intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np)</span><br><span class="line">            &#123;</span><br><span class="line">                ZIPLIST_TAIL_OFFSET(zl) =</span><br><span class="line">                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)) + extra);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†åç»­ entry æ¬ç§»ï¼Œè…¾æŒªå‡ºç©ºé—´å­˜æ”¾æ–°çš„é•¿åº¦å€¼</span></span><br><span class="line">            memmove(np + rawlensize,</span><br><span class="line">                    np + next.prevrawlensize,</span><br><span class="line">                    curlen - noffset - next.prevrawlensize - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// next entry prevlen è®°å½•ä¸‹ä¹‹å‰ entry çš„é•¿åº¦å€¼        </span></span><br><span class="line">            zipStorePrevEntryLength(np, rawlen);</span><br><span class="line">            <span class="comment">// ...ç»§ç»­ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡éƒ½å¯èƒ½æ¶‰åŠåˆ°å†…å­˜çš„æ‰©å®¹å’Œå…ƒç´ çš„ memmove æ“ä½œ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é˜»æ­¢è¿›è¡Œç¼©å®¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢åç»­æ’å…¥æ—¶ï¼Œå¯èƒ½é¢‘ç¹åœ° shrink æˆ–è€… grow å¯¼è‡´</span></span><br><span class="line">            <span class="comment">// æ›´å¤šåœ°å¼€é”€ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (next.prevrawlensize &gt; rawlensize) &#123;</span><br><span class="line">                <span class="comment">/* This would result in shrinking, which we want to avoid.</span></span><br><span class="line"><span class="comment">                 * So, set "rawlen" in the available bytes. */</span></span><br><span class="line">                zipStorePrevEntryLengthLarge(p + rawlen, rawlen);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                zipStorePrevEntryLength(p + rawlen, rawlen);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å­—å…¸ï¼ˆdictï¼‰"><a href="#å­—å…¸ï¼ˆdictï¼‰" class="headerlink" title="å­—å…¸ï¼ˆdictï¼‰"></a>å­—å…¸ï¼ˆdictï¼‰</h1><p>å­—å…¸åœ¨ Redis ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º Redis æœ¬èº«å°±æ˜¯ä¸€ä¸ª Key-Value æ•°æ®åº“ã€‚Redis ä¸­çš„å­—å…¸å®ç°ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>å¯ä»¥æ”¯æŒæµ·é‡çš„ key-value æ˜ å°„ï¼›</li><li>key çš„ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•´æ•°ç­‰ç±»å‹ï¼ˆ<code>void *</code>ï¼‰ï¼›value å¯ä»¥æ˜¯å¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆstring, hash, list, set, sorted setï¼‰æˆ–è€…æ˜¯æ•´æ•°ã€æµ®ç‚¹æ•°ç­‰ï¼›</li><li>ä¸ºäº†é¿å…å“ˆå¸Œå†²çªï¼Œé‡‡ç”¨äº†é“¾åœ°å€æ³•ï¼Œå°†å†²çªçš„ Entry ä¸²è”äº†èµ·æ¥ï¼›</li><li>ä¸ºäº†é¿å…åœ¨è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œéœ€è¦å¯¹æµ·é‡ keys è¿›è¡Œ rehash è€Œå¯¼è‡´é˜»å¡æ—¶é—´è¿‡ä¹…ï¼Œé‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥ï¼›</li><li>æä¾›äº†å®‰å…¨å’Œéå®‰å…¨çš„è¿­ä»£å™¨ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå­—å…¸è¿›è¡Œè¿­ä»£ï¼›</li><li>å¯¹äº keys éå¸¸å¤§çš„å­—å…¸ï¼Œæä¾›äº† <code>dictScan</code> æ–¹æ³•ï¼Œé—´æ–­è¿­ä»£ï¼Œé¿å…å› ä¸ºæ™®é€šè¿­ä»£æ—¶é˜»å¡å…¶å®ƒæ“ä½œã€‚</li></ol><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;</span><br><span class="line">        <span class="keyword">uint64_t</span> u64;</span><br><span class="line">        <span class="keyword">int64_t</span> s64;</span><br><span class="line">        <span class="keyword">double</span> d;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></span><br><span class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size; <span class="comment">// å“ˆå¸Œè¡¨çœŸæ­£çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask; <span class="comment">// sizemask = size-1ï¼Œè¿™é‡Œç”¨äº hash &amp; sizemask è®¡ç®—å‡º slot</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used; <span class="comment">// å“ˆå¸Œè¡¨ä¸­çš„ keys ä¸ªæ•°</span></span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type; <span class="comment">// ä¾èµ–æ•°æ®æŠ½è±¡çš„æ“ä½œæ¥å£</span></span><br><span class="line">    <span class="keyword">void</span> *privdata; <span class="comment">// ç§æœ‰æ•°æ®ï¼Œé…åˆ type å­—æ®µæŒ‡å‘çš„å‡½æ•°ä½¿ç”¨</span></span><br><span class="line">    dictht ht[<span class="number">2</span>]; <span class="comment">// æœ‰ä¸¤ä¸ª hash table</span></span><br><span class="line">    <span class="comment">// rehashidx è¡¨ç¤º rehash çš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="comment">// iterators å½“å‰æ­£åœ¨è¿è¡Œçš„è¿­ä»£å™¨æ•°é‡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>å­—å…¸æ•´ä½“ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š<br><img src="https://pic3.zhimg.com/80/v2-c3ed9fd26f9d28528282d51827b76e91.png" alt=""></p><h2 id="æ‰©å®¹ä¸ç¼©å®¹"><a href="#æ‰©å®¹ä¸ç¼©å®¹" class="headerlink" title="æ‰©å®¹ä¸ç¼©å®¹"></a>æ‰©å®¹ä¸ç¼©å®¹</h2><p>åœ¨æ‰§è¡Œ <code>dictAddRaw()</code> æ—¶ï¼Œä¼šå°è¯•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dictAddRaw()</span><br><span class="line">  _dictKeyIndex()</span><br><span class="line">    _dictExpandIfNeeded()</span><br><span class="line">      dictExpand()</span><br><span class="line">        _dictNextPower()</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ‰©å®¹æˆ–è€…ç¼©å®¹çš„æ ¸å¿ƒé€»è¾‘åœ¨ <code>dictExpand()</code> å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¯¥å‡½æ•°å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictExpand</span><span class="params">(dict *d, <span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç¡®ä¿æˆ‘ä»¬è¦æ‰©å®¹çš„å¤§å°å¯ä»¥å®¹çº³ç›®å‰çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="number">0</span>].used &gt; size)</span><br><span class="line">        <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    <span class="comment">// å¾—åˆ°ç›®æ ‡æ‰©å®¹å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> realsize = _dictNextPower(size);</span><br><span class="line">    <span class="comment">/* Rehashing to the same table size is not useful. */</span></span><br><span class="line">    <span class="comment">// æ‰©å®¹æ—¶æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œé¿å…æ— æ•ˆæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (realsize == d-&gt;ht[<span class="number">0</span>].size) <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ–°çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    dictht n;</span><br><span class="line">    n.size = realsize;</span><br><span class="line">    n.sizemask = realsize<span class="number">-1</span>;</span><br><span class="line">    n.table = zcalloc(realsize*<span class="keyword">sizeof</span>(dictEntry*));</span><br><span class="line">    n.used = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ht[1] æŒ‡å‘çš„å“ˆå¸Œè¡¨ä¾›æ¸è¿›å¼ rehash ä½¿ç”¨ã€‚</span></span><br><span class="line">    d-&gt;ht[<span class="number">1</span>] = n;</span><br><span class="line">    d-&gt;rehashidx = <span class="number">0</span>; <span class="comment">// è¡¨ç¤º rehash å‡†å¤‡å®Œæ¯•ï¼Œè¿›åº¦ä¸º 0</span></span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹ç­–ç•¥ï¼š4 -&gt; 4 * 2 -&gt; 4 * 2 * 2 -&gt; ...</span></span><br><span class="line"><span class="comment">// æŒ‰ç…§ 2 çš„å€æ•°å¢åŠ ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³ size å¤§å°çš„æ•°æ‰¾åˆ°ä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> _dictNextPower(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i = DICT_HT_INITIAL_SIZE; <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= LONG_MAX)</span><br><span class="line">        <span class="keyword">return</span> LONG_MAX + <span class="number">1L</span>U;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        i *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éœ€è¦çš„æ—¶å€™ï¼ŒRedis å¯ä»¥å¯¹å­—å…¸æ‰§è¡Œç¼©å®¹æ“ä½œï¼Œå…·ä½“å¯ä»¥è°ƒç”¨ <code>dictResize()</code> å‡½æ•°å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictResize</span><span class="params">(dict *d)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> minimal = d-&gt;ht[<span class="number">0</span>].used;</span><br><span class="line">    <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">        minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    <span class="keyword">return</span> dictExpand(d, minimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸è¿›å¼-Rehash"><a href="#æ¸è¿›å¼-Rehash" class="headerlink" title="æ¸è¿›å¼ Rehash"></a>æ¸è¿›å¼ Rehash</h2><p>ä¸ºäº†é¿å…åœ¨ rehash æœŸé—´ï¼Œå› ä¸ºè¦è¿ç§»çš„ keys å¤ªå¤šï¼Œå¯¼è‡´é˜»å¡å…¶å®ƒæ“ä½œæ—¶é—´å¤ªä¹…ï¼ŒRedis çš„å­—å…¸å®ç°ä¸­ï¼Œä½¿ç”¨äº†æ¸è¿›å¼ rehash çš„ç­–ç•¥ï¼Œä»è€Œå°†å¯¹å¤§é‡ keys çš„è¿ç§»åˆ†æ•£åœ¨ N æ¬¡æ“ä½œä¸­ï¼Œç›´åˆ°æœ€ç»ˆå®Œæˆï¼Œå…·ä½“å®ç°å‚è§ <a href="https://github.com/iFaceless/redis/blob/4c5a6f422b60500816e9c507bb0265495f483dda/src/dict.c#L206" target="_blank" rel="noopener">dictRehash()</a>ã€‚</p><p>é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥åï¼Œæ¯æ¬¡åœ¨æ‰§è¡ŒæŸ¥æ‰¾ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ä»¥åŠ Redis æœåŠ¡å™¨ç©ºé—²æ—¶ï¼Œå¯ä»¥æ‰§è¡Œä¸€éƒ¨åˆ† keys çš„ rehash æ“ä½œã€‚å…·ä½“æ‰§è¡Œæ—¶æœºå¦‚ä¸‹ï¼š</p><ol><li><p><code>_dictRehashStep() -&gt; dictRehash(d, 1)</code>ï¼š</p><ol><li><code>dictAddRaw()</code></li><li><code>dictDelete()</code></li><li><code>dictUnlink()</code></li><li><code>dictFind()</code></li><li><code>dictGetRandomKey()</code></li><li><code>dictGetSomeKeys()</code></li></ol></li><li><p><code>incrementallyRehash() -&gt; dictRehashMilliseconds(d, 1) -&gt; dictRehash(d, 100)</code>ï¼šServer å¤„äºç©ºé—²æ—¶æ‰§è¡Œ 1ms çš„ rehash å·¥ä½œã€‚</p></li></ol><h2 id="æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨"><a href="#æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨" class="headerlink" title="æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨"></a>æ™®é€šè¿­ä»£å™¨ä¸å®‰å…¨è¿­ä»£å™¨</h2><p>è¿­ä»£å™¨æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¯¹å®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†ï¼Œä½†ä¸éœ€è¦äº†è§£å®¹å™¨å†…éƒ¨å®ç°ç»†èŠ‚ã€‚Redis çš„å­—å…¸ä¹Ÿæˆ‘ä»¬æä¾›äº†è¿­ä»£å™¨æ•°æ®ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictIterator</span> &#123;</span></span><br><span class="line">    dict *d;</span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    <span class="comment">// table æŒ‡å‘çš„å½“å‰åœ¨è¿­ä»£ tableï¼Œsafe è¡¨æ˜æ˜¯å¦ä¸ºå®‰å…¨çš„è¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">int</span> table, safe;</span><br><span class="line">    dictEntry *entry, *nextEntry;</span><br><span class="line">    <span class="comment">// fingerprint ç”¨æ¥æ£€æŸ¥éå®‰å…¨è¿­ä»£å™¨åœ¨ä½¿ç”¨æœŸé—´æ˜¯å¦æ‰§è¡Œäº†ä¸å…è®¸çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> fingerprint;</span><br><span class="line">&#125; dictIterator;</span><br><span class="line"></span><br><span class="line"><span class="function">dictIterator *<span class="title">dictGetIterator</span><span class="params">(dict *d)</span></span>;</span><br><span class="line"><span class="function">dictIterator *<span class="title">dictGetSafeIterator</span><span class="params">(dict *d)</span></span>;</span><br><span class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span></span>;</span><br></pre></td></tr></table></figure><p>å®‰å…¨è¿­ä»£å™¨å’Œæ™®é€šè¿­ä»£å™¨çš„åŒºåˆ«ï¼š</p><ul><li>å®‰å…¨è¿­ä»£å™¨å…è®¸æˆ‘ä»¬åœ¨è¿­ä»£æœŸé—´ï¼Œæ‰§è¡ŒæŸ¥æ‰¾ã€åˆ é™¤ã€æ–°å¢ç­‰å¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå¦‚æ‰§è¡Œ <code>keys *</code> å‘½ä»¤æ—¶ä¼šåˆ›å»ºå®‰å…¨è¿­ä»£å™¨ï¼‰ï¼›</li><li>æ™®é€šè¿­ä»£å™¨åˆ™åªèƒ½å…è®¸æˆ‘ä»¬æ‰§è¡Œ <code>dictNext()</code> è¿›è¡Œè¿­ä»£ï¼Œå…¶å®ƒæ“ä½œæ˜¯ä¸å…è®¸çš„ï¼ˆå¦‚æ‰§è¡Œ <code>sort</code> ä¼šåˆ›å»ºéå®‰å…¨è¿­ä»£å™¨ï¼‰ã€‚</li></ul><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„é™åˆ¶å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨è¿­ä»£æœŸé—´ï¼Œå¦‚æœæœ‰æ‰§è¡ŒæŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤ç­‰æ“ä½œï¼Œå¯èƒ½ä¼šå‘ç”Ÿ rehashï¼Œè¿›è€Œå¯¼è‡´æ‰«æåˆ°é‡å¤çš„ entryã€‚</p><p>æ™®é€šè¿­ä»£å™¨åœ¨è¿­ä»£å¼€å§‹æ—¶ï¼Œè®¡ç®—å‡ºå½“å‰ dict çš„æŒ‡çº¹ï¼Œå¹¶åœ¨è¿­ä»£ç»“æŸæ—¶å†æ¬¡è®¡ç®— dict çš„æŒ‡çº¹ï¼Œä»è€Œç¡®å®š dict åœ¨æ­¤æœŸé—´æ˜¯å¦å‘ç”Ÿè¿‡ä¿®æ”¹è¿‡ï¼Œç›¸å…³å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            dictht *ht = &amp;iter-&gt;d-&gt;ht[iter-&gt;table];</span><br><span class="line">            <span class="keyword">if</span> (iter-&gt;index == <span class="number">-1</span> &amp;&amp; iter-&gt;table == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¼€å§‹è¿­ä»£ï¼Œè®¡ç®—ä¸‹ fp</span></span><br><span class="line">                iter-&gt;fingerprint = dictFingerprint(iter-&gt;d);</span><br><span class="line">            &#125;</span><br><span class="line">            iter-&gt;index++;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(iter-&gt;index == <span class="number">-1</span> &amp;&amp; iter-&gt;table == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter-&gt;safe)</span><br><span class="line">            iter-&gt;d-&gt;iterators--;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            assert(iter-&gt;fingerprint == dictFingerprint(iter-&gt;d));</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(iter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆï¼Œå®‰å…¨è¿­ä»£å™¨åˆæ˜¯å¦‚ä½•åšåˆ°å®‰å…¨çš„å‘¢ï¼Ÿå…¶å®ç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œå¯¹ dict æœ‰å‰¯ä½œç”¨çš„æ“ä½œæ—¶ï¼Œé˜»æ­¢å…¶è¿›è¡Œ rehash å³å¯ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åº•å±‚çš„ hash tables ä¸ä¼šæœ‰ keys çš„è¿ç§»ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><ul><li>è¿­ä»£å™¨åˆå§‹åŒ–æ—¶ï¼Œ<code>safe</code> å­—æ®µç½® 1ï¼›</li><li>åˆæ¬¡è¿­ä»£æ—¶ï¼Œæ‰§è¡Œ <code>iter-&gt;d-&gt;iterators++</code>ï¼Œå‘Šè¯‰ <code>dict</code> å½“å‰å­˜åœ¨å®‰å…¨çš„è¿­ä»£å™¨åœ¨è¿è¡Œï¼›</li><li><code>_dictRehashStep</code> æ—¶ï¼Œå¦‚æœ <code>dict-&gt;iterators != 0</code> åˆ™ä¸ä¼šæ‰§è¡Œ rehashã€‚</li></ul><h2 id="é—´æ–­è¿­ä»£å™¨"><a href="#é—´æ–­è¿­ä»£å™¨" class="headerlink" title="é—´æ–­è¿­ä»£å™¨"></a>é—´æ–­è¿­ä»£å™¨</h2><p>ä¸ºäº†é¿å…æ‰«ææ‰€æœ‰çš„ keys è€Œé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼ˆäº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒæ˜¯ç¦ç”¨ <code>keys</code> å‘½ä»¤çš„ï¼‰ï¼ŒRedis åœ¨ 2.8 ä¹‹ååŠ å…¥äº† <code>scan</code> æ“ä½œï¼Œä»è€Œèƒ½å¤Ÿé—´æ–­åœ°è¿­ä»£æ•´ä¸ªå­—å…¸ã€‚<code>zscan</code> å’Œ <code>hscan</code> åº•å±‚éƒ½ä¼šæ‰§è¡Œé—´æ–­è¿­ä»£æ“ä½œï¼Œå®ƒçš„å…·ä½“å®ç°å‚è§ <a href="https://github.com/iFaceless/redis/blob/4c5a6f422b60500816e9c507bb0265495f483dda/src/dict.c#L878" target="_blank" rel="noopener">dictScan</a>ï¼Œæ ¸å¿ƒæ˜¯å›´ç»•ä¸€ä¸ªæ¸¸æ ‡è¿›è¡Œçš„ï¼Œå…³äºå®ƒçš„å…·ä½“ç­–ç•¥å¯ä»¥å‚è§æºç çš„è¯¦ç»†æè¿°ã€‚</p><p>è¿™é‡Œæ€»ç»“ä¸‹ <code>dictScan</code> ç®—æ³•çš„ä¸»è¦ç‰¹ç‚¹ï¼š</p><ol><li><strong>è¿­ä»£å™¨æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ˆå’Œä¸Šé¢çš„ä¸¤ä¸ªç›¸æ¯”ï¼‰</strong>ï¼Œè¿­ä»£ä½ç½®æ˜¯åŸºäºæ¸¸æ ‡è®¡ç®—çš„ï¼Œè€Œæ¸¸æ ‡ä¼šè¿”å›ç»™ç”¨æˆ·ï¼Œç”±ç”¨æˆ·ä¿å­˜ï¼Œå¹¶åœ¨è¿­ä»£æ—¶ä¼ å…¥ï¼›</li><li><strong>å¯èƒ½ä¼šè¿­ä»£åˆ°é‡å¤çš„å…ƒç´ </strong>ï¼Œä½†ç”±äºé‡‡ç”¨äº† <em>reverse binary iteration</em> ç®—æ³•ï¼Œèƒ½å¤Ÿä¿è¯ä¸æ¼éå†ä¸”å°½å¯èƒ½ä¸é‡å¤éå†ï¼›</li><li><strong>æ¯æ¬¡è¿­ä»£ä¼šè¿”å›å¤šä¸ªå…ƒç´ </strong>ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºé¿å… rehash çš„å½±å“ï¼Œæ¯æ¬¡ä¼šå°†ä¸€ä¸ª bucket ä¸Šæ‰€æœ‰çš„ keys éƒ½è¿”å›å‡ºå»ã€‚</li></ol><h1 id="æ•´æ•°é›†åˆï¼ˆintsetï¼‰"><a href="#æ•´æ•°é›†åˆï¼ˆintsetï¼‰" class="headerlink" title="æ•´æ•°é›†åˆï¼ˆintsetï¼‰"></a>æ•´æ•°é›†åˆï¼ˆintsetï¼‰</h1><p>é¡¾åæ€ä¹‰ï¼Œintset æ˜¯è½¬é—¨ç”¨äº<strong>å­˜å‚¨æ•´æ•°</strong>çš„é›†åˆã€‚å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡çš„ï¼Œéšç€å…ƒç´ ä¸­æœ€å¤§çš„å…ƒç´ çš„ç±»å‹å‘ç”Ÿå˜åŒ–ï¼Œå®ƒä¹Ÿä¼šæŒ‰éœ€æ‰©å®¹ã€‚intset è¿˜æœ‰ä¸ªç‰¹ç‚¹æ˜¯<strong>æœ‰åºä¸”ä¸é‡å¤</strong>ï¼ˆå¯ä»¥æƒ³åˆ°æŸ¥æ‰¾æ—¶å°±å¯ä»¥å…‰æ˜æ­£å¤§åœ°åˆ©ç”¨äºŒåˆ†ç®—æ³•äº†ï¼‰ã€‚</p><p>intset å®é™…ä¸Šæ˜¯ Redis é›†åˆç±»å‹åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œ<strong>å½“å…ƒç´ ä¸º 64 ä½ä»¥å†…æœ‰ç¬¦å·æ•´æ•°ï¼ˆæ”¯æŒ <code>int16_t</code>, <code>int32_t</code>, <code>int64_t</code>ï¼‰ï¼Œä¸”å…ƒç´ ä¸ªæ•°ä¸å¤š</strong>ï¼ˆå–å†³äº <code>set_max_intset_entries</code> è®¾ç½®ï¼‰æ—¶ä½¿ç”¨ã€‚å½“å…ƒç´ ä¸ªæ•°è¶…å‡ºè®¾å®šå€¼ï¼Œæˆ–è€…æ–°å¢å…ƒç´ ç±»å‹éæ•´æ•°ï¼Œ<strong>intset å°±ä¼šè¢«è½¬æ¢æˆ hashtable</strong>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ dict æ¥å­˜å‚¨ã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">setTypeCreate</span><span class="params">(sds value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isSdsRepresentableAsLongLong(value,<span class="literal">NULL</span>) == C_OK)</span><br><span class="line">        <span class="keyword">return</span> createIntsetObject();</span><br><span class="line">    <span class="keyword">return</span> createSetObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setTypeAdd</span><span class="params">(robj *subject, sds value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> llval;</span><br><span class="line">    <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_HT) &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_INTSET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isSdsRepresentableAsLongLong(value, &amp;llval) == C_OK) &#123;</span><br><span class="line">            <span class="keyword">uint8_t</span> success = <span class="number">0</span>;</span><br><span class="line">            subject-&gt;ptr = intsetAdd(subject-&gt;ptr, llval, &amp;success);</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                <span class="comment">// å…ƒç´ ä¸ªæ•°è¶…å‡ºèŒƒå›´ï¼Œéœ€è¦è½¬æ¢æˆå­—å…¸å­˜å‚¨</span></span><br><span class="line">                <span class="keyword">if</span> (intsetLen(subject-&gt;ptr) &gt; server.set_max_intset_entries)</span><br><span class="line">                    setTypeConvert(subject, OBJ_ENCODING_HT);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// éæ•´æ•°ç±»å‹ï¼Œè½¬æ¢æˆå­—å…¸</span></span><br><span class="line">            setTypeConvert(subject, OBJ_ENCODING_HT);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> encoding; <span class="comment">// æ•´æ•°é•¿åº¦ï¼šINTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</span></span><br><span class="line">    <span class="keyword">uint32_t</span> length; <span class="comment">// æ•´æ•°ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure><p>ç®€å•ç”»äº†ä¸ªå†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹ï¼Œç›¸ä¿¡å¯ä»¥ç›´è§‚åœ°è¡¨è¾¾è¿™ä¸ªæ•°æ®ç»“æ„çš„ç‰¹ç‚¹ï¼š<br><img src="https://pic1.zhimg.com/80/v2-c565192165aad2be79d17ae7e6517bc1.png" alt=""></p><h2 id="æ ¸å¿ƒæºç -3"><a href="#æ ¸å¿ƒæºç -3" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>intset çš„æ ¸å¿ƒ API æ¯”è¾ƒå°‘ï¼Œä¸”å®ç°æ¯”è¾ƒç®€å•ï¼Œå¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å¤šèµ˜è¿°äº†ï¼Œç›¸å…³æºç ä¸­æ–‡æ³¨é‡Šç›´æ¥çœ‹ <a href="https://github.com/iFaceless/redis/blob/c4e3ab7aa976ff1bde948803a6212c1cb2764b76/src/intset.c#L97" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">intset *<span class="title">intsetNew</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function">intset *<span class="title">intsetAdd</span><span class="params">(intset *is, <span class="keyword">int64_t</span> value, <span class="keyword">uint8_t</span> *success)</span></span>; <span class="comment">// O(N)</span></span><br><span class="line"><span class="function">intset *<span class="title">intsetRemove</span><span class="params">(intset *is, <span class="keyword">int64_t</span> value, <span class="keyword">int</span> *success)</span></span>; <span class="comment">// O(N)</span></span><br><span class="line"><span class="keyword">uint8_t</span> intsetFind(intset *is, <span class="keyword">int64_t</span> value); <span class="comment">// O(logN)</span></span><br><span class="line"><span class="keyword">int64_t</span> intsetRandom(intset *is); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">uint8_t</span> intsetGet(intset *is, <span class="keyword">uint32_t</span> pos, <span class="keyword">int64_t</span> *value); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">uint32_t</span> intsetLen(<span class="keyword">const</span> intset *is); <span class="comment">// O(1)</span></span><br><span class="line"><span class="keyword">size_t</span> intsetBlobLen(intset *is); <span class="comment">// O(1)</span></span><br></pre></td></tr></table></figure><h1 id="å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰"><a href="#å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰" class="headerlink" title="å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰"></a>å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰</h1><p>å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä½†æ˜¯å®ƒçš„æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä½äº ziplist ä¸­ï¼Œå¹¶ä¸”ä¸­é—´èŠ‚ç‚¹çš„ ziplist è¿˜å¯ä»¥ä½¿ç”¨ LZF ç®—æ³•è¿›è¡Œå‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœå†…å­˜ã€‚æ€»çš„æ¥è¯´ï¼Œquicklist æ˜¯ä¸€ä¸ªç»¼åˆäº†åŒå‘é“¾è¡¨å’Œ ziplist ä¼˜ç‚¹çš„æ•°æ®ç»“æ„ã€‚ziplist æœ€å¤§çš„ç‰¹ç‚¹æ˜¯èŠ‚çº¦å†…å­˜ï¼Œä½†ä¸é€‚å®œå­˜å‚¨è¿‡å¤šçš„å…ƒç´ ï¼›è€Œé“¾è¡¨åˆ™ä¾¿äºä»å¤´éƒ¨æˆ–è€…å°¾éƒ¨æ‰§è¡Œæ’å…¥æˆ–æŸ¥æ‰¾ã€‚</p><p>å› æ­¤ï¼Œquicklist ç®—æ˜¯ä¸º Redis åˆ—è¡¨ç±»å‹ <code>t_list</code> ç‰¹åˆ«å®šåˆ¶çš„æ•°æ®ç»“æ„ï¼Œå…¼é¡¾äº†æ—¶é—´å’Œç©ºé—´æ•ˆç‡ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„ <code>LPUSH</code>, <code>LPOP</code>, <code>RPUSH</code>, <code>RPOP</code> å‘½ä»¤ï¼Œå®é™…ä¸Šåªéœ€è¦æ“ä½œåˆ—è¡¨ä¸¤ç«¯å³å¯ï¼Œè€Œ qucklist æ°å¥½ç»´æŠ¤äº† head å’Œ tail çš„èŠ‚ç‚¹æŒ‡é’ˆï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-5eace6803426c11a9f2b27a83ff5d94f.png" alt=""></p><h2 id="æ•°æ®ç»“æ„-2"><a href="#æ•°æ®ç»“æ„-2" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// quicklist æ˜¯å¯¹å¿«é€Ÿé“¾è¡¨è¿™ç§æ•°æ®ç»“æ„çš„æŠ½è±¡ï¼Œå…¶ä¸­å­˜å‚¨äº†ä¸€äº›å…ƒä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></span><br><span class="line">    <span class="comment">// head, tail æŒ‡å‘é“¾è¡¨çš„å¤´å°¾</span></span><br><span class="line">    quicklistNode *head;</span><br><span class="line">    quicklistNode *tail;</span><br><span class="line">    <span class="comment">// count è®°å½•äº†æ‰€æœ‰ ziplists çš„å…ƒç´ ä¸ªæ•°ä¹‹å’Œ</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> count; <span class="comment">/* total count of all entries in all ziplists */</span></span><br><span class="line">    <span class="comment">// len è®°å½•äº†æœ‰å¤šå°‘ä¸ª Nodes</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len; <span class="comment">/* number of quicklistNodes */</span></span><br><span class="line">    <span class="comment">// fill è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¯ä»¥åŒ…å«çš„æ•°æ®é¡¹ï¼Œæ­£æ•°è¡¨ç¤ºæœ€å¤šå¯ä»¥å«æœ‰çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">// è´Ÿæ•°åˆ™è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹ ziplist çš„æœ€å¤§é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼š</span></span><br><span class="line">    <span class="comment">// -1, 4KB</span></span><br><span class="line">    <span class="comment">// -2, 8KB</span></span><br><span class="line">    <span class="comment">// -3, 16KB</span></span><br><span class="line">    <span class="comment">// -4, 32KB</span></span><br><span class="line">    <span class="comment">// -5, 64KB</span></span><br><span class="line">    <span class="keyword">int</span> fill : <span class="number">16</span>; <span class="comment">/* fill factor for individual nodes */</span></span><br><span class="line">    <span class="comment">// compress è¡¨ç¤ºä¸¤ç«¯ä¸è¢«å‹ç¼©çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚ä¸€èˆ¬å¯¹äº list çš„æ“ä½œé€šå¸¸æ˜¯åœ¨ä¸¤ç«¯è¿›è¡Œçš„</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ï¼Œä¸ºäº†æ–¹ä¾¿ LPUSH/LPOP/RPUSH/RPOP å‘½ä»¤ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©å¯¹ä¸¤ç«¯ä¸åšå‹ç¼©ã€‚</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œä¼šå¯¹ä¸­é—´èŠ‚ç‚¹è¿›è¡Œå‹ç¼©ï¼ˆziplist å·²ç»å¤ŸèŠ‚çº¦å†…å­˜äº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å‹ç¼©</span></span><br><span class="line">    <span class="comment">// æ›´è¿›ä¸€æ­¥åœ°èŠ‚çº¦å†…å­˜ï¼‰ï¼Œä»£ä»·å°±æ˜¯æ¶ˆè€—ç‚¹ CPU æ—¶é—´ç”¨äºå‹ç¼©æˆ–è€…è§£å‹ç¼©ã€‚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> compress : <span class="number">16</span>; <span class="comment">/* depth of end nodes not to compress;0=off */</span></span><br><span class="line">&#125; quicklist;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistNode å®é™…ä¸Šæ˜¯å¯¹ ziplist çš„æè¿°ï¼Œå…ƒç´ å­˜å‚¨äº ziplist ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦åœ¨ quicklistNode ä¸­ä½äº ziplist çš„ä¸€äº›å…ƒä¿¡æ¯å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸º</span></span><br><span class="line"><span class="comment">// èŠ‚ç‚¹æŒ‡å‘çš„ ziplist å¯ä»¥è¢«å‹ç¼©ï¼Œè¿™æ ·å°±ä¸èƒ½å¿«é€Ÿè·å–ä¸€äº›å…ƒä¿¡æ¯äº†ï¼ˆå…ƒç´ ä¸ªæ•°ç­‰ï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// åŒå‘é“¾è¡¨ï¼Œè‡ªç„¶éœ€è¦å‰åå…³è”</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘ ziplist æŒ‡é’ˆï¼ˆå¦‚æœæ˜¯å‹ç¼©èŠ‚ç‚¹ï¼Œå®é™…æŒ‡å‘çš„æ˜¯ quicklistLZFï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl;</span><br><span class="line">    <span class="comment">// ziplist çš„å¤§å°ï¼ˆbytesï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz; <span class="comment">/* ziplist size in bytes */</span></span><br><span class="line">    <span class="comment">// ziplist ä¸­å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count : <span class="number">16</span>; <span class="comment">/* count of items in ziplist */</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤º ziplist è¿›è¡Œäº†å‹ç¼©ç¼–ç ï¼ŒRAW=1 è¡¨ç¤ºæ²¡æœ‰å‹ç¼©ï¼›2 è¡¨ç¤ºä½¿ç”¨äº† LZF ç®—æ³•å‹ç¼©</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> encoding : <span class="number">2</span>; <span class="comment">/* RAW==1 or LZF==2 */</span></span><br><span class="line">    <span class="comment">// å®¹å™¨ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> container : <span class="number">2</span>; <span class="comment">/* NONE==1 or ZIPLIST==2 */</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯å¦è¢«å‹ç¼©è¿‡ï¼Ÿå¦‚æœå‹ç¼©è¿‡è¿˜éœ€è¦åœ¨ä½¿ç”¨å‰è¿›è¡Œè§£å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> recompress : <span class="number">1</span>; <span class="comment">/* was this node previous compressed? */</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹å¤ªå°äº†ï¼Œæ— æ³•å‹ç¼©</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attempted_compress : <span class="number">1</span>; <span class="comment">/* node can't compress; too small */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extra : <span class="number">10</span>; <span class="comment">/* more bits to steal for future usage */</span></span><br><span class="line">&#125; quicklistNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistLZF è¡¨ç¤º ziplist å‹ç¼©åçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ª 4+N å­—èŠ‚å¤§å°çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistLZF</span> &#123;</span></span><br><span class="line">    <span class="comment">// sz è¡¨ç¤º LZF å‹ç¼©åçš„æ•°æ®å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz; <span class="comment">/* LZF size in bytes*/</span></span><br><span class="line">    <span class="comment">// compressed å­˜å‚¨å‹ç¼©åçš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">char</span> compressed[];</span><br><span class="line">&#125; quicklistLZF;</span><br><span class="line"></span><br><span class="line"><span class="comment">// quicklistEntry æ˜¯å¯¹ quicklistNode ä¸‹ ziplist æŸä¸ªå…ƒç´ çš„æŠ½è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">// æ–¹ä¾¿æˆ‘ä»¬è·å–å…ƒç´ çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistEntry</span> &#123;</span></span><br><span class="line">    <span class="comment">// quicklist æŒ‡å‘ quicklist çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">const</span> quicklist *quicklist;</span><br><span class="line">    <span class="comment">// quicklistNode å½“å‰ entry å…³è”çš„èŠ‚ç‚¹</span></span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="comment">// zi å…³è”çš„ ziplist</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zi;</span><br><span class="line">    <span class="comment">// value æŒ‡å‘ string ç±»å‹çš„å…ƒç´ ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *value;</span><br><span class="line">    <span class="comment">// longvalue å…ƒç´ è½¬æ¢ä¸ºæ•´æ•°çš„å€¼</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> longval;</span><br><span class="line">    <span class="comment">// sz è¡¨ç¤º value çš„æœ‰æ•ˆé•¿åº¦ï¼ˆstring ç±»å‹ç¼–ç æ—¶ï¼Œencoding ä¸­çš„é•¿åº¦éƒ¨åˆ†å°±æ˜¯è¿™ä¸ªï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;</span><br><span class="line">    <span class="comment">// offset è¡¨ç¤ºåœ¨å½“å‰ ziplist ä¸­çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">&#125; quicklistEntry;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹å›¾å¯ä»¥å¯¹ quicklist æœ‰ä¸ªç›´è§‚çš„æ„Ÿå—ï¼Œä¾¿äºç†è§£è¿™ç§æ•°æ®ç»“æ„ï¼š<br><img src="https://pic1.zhimg.com/80/v2-1f634fd2892ebc00aef8aeb8f03ceb09.png" alt=""></p><h2 id="æ ¸å¿ƒæºç -4"><a href="#æ ¸å¿ƒæºç -4" class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><p>quicklist çš„æºç æ¯”è¾ƒå¤šï¼Œå°±ä¸å†æœ¬æ–‡ä¸­èµ˜è¿°äº†ï¼Œè¯¦ç»†çš„æºç æ³¨é‡Šå¯ä»¥åœ¨ <a href="https://github.com/iFaceless/redis/blob/152cb8a4be4ce107a34135314020ec69bca93216/src/quicklist.c#L94" target="_blank" rel="noopener">æ­¤å¤„</a> æŸ¥çœ‹ã€‚å€¼å¾—é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// n ä¸º quicklist èŠ‚ç‚¹ä¸ªæ•°ï¼Œm è¡¨ç¤ºå†…éƒ¨ ziplist çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="function">quicklist *<span class="title">quicklistCreate</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">// O(1)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushHead</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushTail</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistPush</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz, <span class="keyword">int</span> where)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertAfter</span><span class="params">(quicklist *quicklist, quicklistEntry *node, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertBefore</span><span class="params">(quicklist *quicklist, quicklistEntry *node, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz)</span></span>; <span class="comment">// O(m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistIndex</span><span class="params">(<span class="keyword">const</span> quicklist *quicklist, <span class="keyword">const</span> <span class="keyword">long</span> <span class="keyword">long</span> index, quicklistEntry *entry)</span></span>; <span class="comment">// O(n+m)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPop</span><span class="params">(quicklist *quicklist, <span class="keyword">int</span> where, <span class="keyword">unsigned</span> <span class="keyword">char</span> **data, <span class="keyword">unsigned</span> <span class="keyword">int</span> *sz, <span class="keyword">long</span> <span class="keyword">long</span> *slong)</span></span>;  <span class="comment">// O(m)</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™é‡Œå°±ä¸å¤šåºŸè¯äº†ï¼Œå¯¹äºåŸºæœ¬çš„æ•°æ®ç»“æ„åšäº†ç‚¹æ€»ç»“ï¼Œæ”¾åœ¨ä¸‹é¢çš„æ€ç»´å¯¼å›¾ä¸­ã€‚å…¶ä¸­ APIs åˆ†æ”¯å¹¶éæ¯ä¸ªæ•°æ®ç»“æ„å…¨éƒ¨çš„æ¥å£ï¼Œè€Œæ˜¯ä¸€äº›æ¯”è¾ƒæœ‰è¶£ï¼Œå€¼å¾—é˜…è¯»æºç çš„æ¥å£ï¼Œæœ‰å…´è¶£åœ°è¯å¯ä»¥æ¬£èµä¸‹å®ƒä»¬çš„å†…éƒ¨å®ç°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€æŒ‡æ­£~</p><p><img src="https://pic2.zhimg.com/80/v2-82b204f0b41afb79e21e84d76a4806ef.png" alt=""></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-1d46ebdc21d0364fefecf710d01f473d.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;Redis åº•å±‚çš„åŸºç¡€æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šåŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsdsï¼‰ã€è·³è¡¨ï¼ˆskiplistï¼‰ã€å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ã€å­—å…¸ï¼ˆdictï¼‰ã€æ•´æ•°é›†åˆï¼ˆintsetï¼‰ï¼Œå¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰ç­‰ï¼Œ&lt;code&gt;t_hash&lt;/code&gt;ï¼Œ&lt;code&gt;t_set&lt;/code&gt;, &lt;code&gt;t_zset&lt;/code&gt;, &lt;code&gt;t_list&lt;/code&gt; ç­‰å¯¹å¤–ç±»å‹çš„å†…éƒ¨å®ç°éƒ½ä¾èµ–äºè¿™äº›æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥éå¸¸å€¼å¾—å­¦ä¹ ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="/categories/Redis/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Redis" scheme="/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€å®ç° Redis è·³è¡¨</title>
    <link href="/2019/12/11/implement-redis-skiplist-in-go/"/>
    <id>/2019/12/11/implement-redis-skiplist-in-go/</id>
    <published>2019-12-11T12:58:39.000Z</published>
    <updated>2019-12-15T06:08:45.313Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png" alt=""><br>è¯»è¿‡ Redis æºç çš„ç«¥é‹ï¼Œæƒ³å¿…ä¼šçŸ¥é“ zset å®ç°æ—¶ï¼Œä½¿ç”¨äº†ã€Œè·³è¡¨ã€ï¼ˆSkiplistï¼‰è¿™ç§æ•°æ®ç»“æ„å§ã€‚å®ƒçš„åŸç†éå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœå¯¹é“¾è¡¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼ˆæ ¸å¿ƒï¼š<strong>æœ‰åºé“¾è¡¨</strong> + <strong>åˆ†å±‚</strong>ï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸ä¼šè¯¦ç»†è®²è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¯¹äº Redis è·³è¡¨æºç çš„è¯¦ç»†åˆ†æã€‚å› ä¸ºå·²ç»æœ‰å‰è¾ˆä»¬äº§å‡ºäº†éå¸¸ä¸°å¯Œçš„æ–‡ç« æ¥è®²è§£ Redis è·³è¡¨ï¼Œéœ€è¦çš„è¯ï¼Œæ¨èé˜…è¯» <a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> äº†è§£æ›´å¤šç»†èŠ‚ã€‚</p><a id="more"></a><p>æ€»çš„æ¥è¯´ï¼ŒRedis çš„ zset å®ç°ä¸­ï¼Œé€‰ç”¨ã€Œè·³è¡¨ã€çš„ä¸»è¦åŸå› å¦‚ä¸‹ï¼š</p><ol><li><strong>åŸç†æ¸…æ™°æ˜“æ‡‚ï¼Œä¸”å®¹æ˜“å®ç°ï¼Œæ–¹ä¾¿ç»´æŠ¤</strong>ï¼šå¯¹æ¯”ä¸‹å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘ï¼ˆå¯èƒ½å°±åƒ Raft v.s. Paxos çš„æ„Ÿè§‰ä¸€æ ·ï¼‰ï¼Œä¸ç®¡æ˜¯åŸç†è¿˜æ˜¯å®ç°éƒ½ç®€å•äº†å¾ˆå¤šã€‚å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘åœ¨å®ç°æ—¶ï¼Œè¿˜è¦æ—¶åˆ»ç»´æŠ¤èŠ‚ç‚¹å…³ç³»ï¼Œå¿…è¦æ—¶è¿˜éœ€è¦æ‰§è¡Œæ ‘çš„å·¦æ—‹æˆ–è€…å³æ—‹æ¥ä¿æŒå¹³è¡¡ï¼›</li><li><strong>æ‹¥æœ‰åª²ç¾å¹³è¡¡æ ‘æˆ–è€…çº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡</strong>ï¼šæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„å¹³å‡æ—¶é—´å¤æ‚åº¦å¯ä»¥è¾¾åˆ° O(logN)ã€‚</li></ol><p>å½“ç„¶ï¼Œç›¸å¯¹äº William Pugh åœ¨ä»–çš„è®ºæ–‡ä¸­æ‰€æè¿°çš„ã€Œè·³è¡¨ã€ç®—æ³•è€Œè¨€ï¼Œä½œè€…åœ¨å®ç° Redis ä¸­çš„ã€Œè·³è¡¨ã€æ—¶ï¼Œç»™å®ƒåŠ äº†ç‚¹ã€Œæ–™ã€ï¼š</p><ol><li>å…è®¸é‡å¤çš„åˆ†æ•°å­˜åœ¨ï¼›</li><li>åœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œä¸ä»…ä¼šæ¯”è¾ƒ scoreï¼Œè¿˜ä¼šè€ƒè™‘å…³è”çš„æ•°æ®ï¼›</li><li>æ·»åŠ äº†ä¸€ä¸ªå›é€€æŒ‡é’ˆï¼Œä»è€Œæ„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆlevel[0]ï¼‰ï¼Œä¾¿äºå€’åºéå†é“¾è¡¨ï¼ˆ<code>ZREVRANGE</code>ï¼‰ä½¿ç”¨ã€‚</li></ol><p>å¥½äº†ï¼ŒåºŸè¯å®Œæ¯•ã€‚æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€æ¥å®ç°ã€Œè·³è¡¨ã€å§ï¼ˆè´´ä»£ç æ¨¡å¼å¼€å¯~ï¼‰ã€‚</p><h1 id="è·³è¡¨å®ç°"><a href="#è·³è¡¨å®ç°" class="headerlink" title="è·³è¡¨å®ç°"></a>è·³è¡¨å®ç°</h1><p>ä»¥ä¸‹ä»…ä»…åˆ—å‡ºäº†å‡ ä¸ªæ¯”è¾ƒæœ‰è¶£ä¸”å…³é”®çš„æ–¹æ³•å®ç°ï¼Œå³ï¼šæ’å…¥ã€åˆ é™¤å’Œæ›´æ–°åˆ†æ•°ã€‚å®Œæ•´çš„å®ç°æºç å¯ä»¥å‚è€ƒ <a href="https://gitee.com/ifaceless/goskiplist/tree/master" target="_blank" rel="noopener">è¿™é‡Œ</a> æˆ–è€… <a href="https://github.com/iFaceless/always-coding/tree/master/datastructure/skiplist" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼ŒåŒ…å«äº†æ¯”è¾ƒè¯¦ç»†çš„å•å…ƒæµ‹è¯•ã€‚</p><h2 id="æ•°æ®ç»“æ„å®šä¹‰"><a href="#æ•°æ®ç»“æ„å®šä¹‰" class="headerlink" title="æ•°æ®ç»“æ„å®šä¹‰"></a>æ•°æ®ç»“æ„å®šä¹‰</h2><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œå‡è®¾å­˜å‚¨çš„å…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼ˆè¦æ˜¯ä½¿ç”¨ <code>interface{}</code> çš„è¯ï¼Œåˆå¾—åŠ äº›ä»£ç æ”¯æŒå…ƒç´ ä¹‹é—´çš„æ¯”è¾ƒäº†ï¼‰ã€‚ä½†æ˜¯åœ¨ Redis ä¸­ï¼Œå®é™…çš„ <code>element</code>  ç±»å‹æ˜¯ <code>sds</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    MaxLevel = <span class="number">64</span> <span class="comment">// è¶³ä»¥å®¹çº³ 2^64 ä¸ªå…ƒç´ </span></span><br><span class="line">    P = <span class="number">0.25</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">    elem <span class="keyword">string</span></span><br><span class="line">    score <span class="keyword">float64</span></span><br><span class="line">    backward *Node</span><br><span class="line">    level []skipLevel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> skipLevel <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// forward æ¯å±‚éƒ½è¦æœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ</span></span><br><span class="line">    forward *Node</span><br><span class="line">    <span class="comment">// span é—´éš”å®šä¹‰ä¸ºï¼šä»å½“å‰èŠ‚ç‚¹åˆ° forward æŒ‡å‘çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¹‹é—´é—´éš”çš„èŠ‚ç‚¹æ•°</span></span><br><span class="line">    span <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Skiplist <span class="keyword">struct</span> &#123;</span><br><span class="line">    header, tail *Node</span><br><span class="line">    level <span class="keyword">int</span> <span class="comment">// è®°å½•è·³è¡¨çš„å®é™…é«˜åº¦</span></span><br><span class="line">    length <span class="keyword">int</span> <span class="comment">// è®°å½•è·³è¡¨çš„é•¿åº¦ï¼ˆä¸å«å¤´èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¾…åŠ©æ–¹æ³•"><a href="#è¾…åŠ©æ–¹æ³•" class="headerlink" title="è¾…åŠ©æ–¹æ³•"></a>è¾…åŠ©æ–¹æ³•</h2><p>è€ƒè™‘åˆ°åœ¨å®ç°æ—¶ï¼Œç»å¸¸éœ€è¦æ¯”è¾ƒ score å’Œ elementï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç»™ <code>Node</code> å®ç°äº†ä¸€äº›æ¯”è¾ƒæ–¹æ³•ï¼Œä¾¿äºä½¿ç”¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Compare</span><span class="params">(other *Node)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> node.score &lt; other.score || (node.score == other.score &amp;&amp; node.elem &lt; other.elem) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> node.score &gt; other.score || (node.score == other.score &amp;&amp; node.elem &gt; other.elem) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Lt</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &lt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Lte</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &lt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Gt</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) &gt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(node *Node)</span> <span class="title">Eq</span><span class="params">(other *Node)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.Compare(other) == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ’å…¥å…ƒç´ "><a href="#æ’å…¥å…ƒç´ " class="headerlink" title="æ’å…¥å…ƒç´ "></a>æ’å…¥å…ƒç´ </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Insert å‘è·³è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">// 1. æŸ¥æ‰¾æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="comment">// 2. åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œå¹¶åœ¨ç›®æ ‡ä½ç½®æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// 3. è°ƒæ•´è·³è¡¨ backward æŒ‡é’ˆç­‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">Insert</span><span class="params">(score <span class="keyword">float64</span>, elem <span class="keyword">string</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        <span class="comment">// update ç”¨äºè®°å½•æ¯å±‚å¾…æ›´æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        <span class="comment">// rank ç”¨æ¥è®°å½•æ¯å±‚ç»è¿‡çš„èŠ‚ç‚¹è®°å½•ï¼ˆå¯ä»¥çœ‹æˆåˆ°å¤´èŠ‚ç‚¹çš„è·ç¦»ï¼‰</span></span><br><span class="line">        rank [MaxLevel]<span class="keyword">int</span></span><br><span class="line">        <span class="comment">// æ„å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œç”¨äºä¸‹é¢çš„å¤§å°åˆ¤æ–­ï¼Œå…¶ level åœ¨åé¢è®¾ç½®</span></span><br><span class="line">        node = &amp;Node&#123;score: score, elem: elem&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">if</span> cur == sl.header &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rank[i] = rank[i+<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸åŒå±‚çš„åä¸€ä¸ªèŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœåä¸€ä¸ªæ¯”ç›®æ ‡å€¼å°ï¼Œåˆ™å¯ä»¥ç»§ç»­å‘å</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ä¸‹é™åˆ°ä¸€å±‚æŸ¥æ‰¾ã€‚æ³¨æ„è¿™é‡Œçš„å¤§å°æ¯”è¾ƒæ˜¯æŒ‰ç…§ score å’Œ</span></span><br><span class="line">        <span class="comment">// elem ç»¼åˆè®¡ç®—å¾—åˆ°çš„ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(node) &#123;</span><br><span class="line">            rank[i] += cur.level[i].span</span><br><span class="line">            <span class="comment">// åŒå±‚ç»§ç»­å¾€åæŸ¥æ‰¾</span></span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´è·³è¡¨é«˜åº¦</span></span><br><span class="line">    level := sl.randomLevel()</span><br><span class="line">    <span class="keyword">if</span> level &gt; sl.level &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ¯å±‚</span></span><br><span class="line">        <span class="keyword">for</span> i := level - <span class="number">1</span>; i &gt;= sl.level; i-- &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span></span><br><span class="line">            update[i] = sl.header</span><br><span class="line">            update[i].level[i].span = sl.length</span><br><span class="line">        &#125;</span><br><span class="line">        sl.level = level</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°èŠ‚ç‚¹ levelï¼Œå¹¶æ’å…¥æ–°èŠ‚ç‚¹</span></span><br><span class="line">    node.setLevel(level)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; level; i++ &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°æ¯å±‚çš„èŠ‚ç‚¹æŒ‡å‘</span></span><br><span class="line">        node.level[i].forward = update[i].level[i].forward</span><br><span class="line">        update[i].level[i].forward = node</span><br><span class="line">        <span class="comment">// æ›´æ–° span ä¿¡æ¯</span></span><br><span class="line">        node.level[i].span = update[i].level[i].span - (rank[<span class="number">0</span>] - rank[i])</span><br><span class="line">        update[i].level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é’ˆå¯¹æ–°å¢èŠ‚ç‚¹ level &lt; sl.level çš„æƒ…å†µï¼Œéœ€è¦æ›´æ–°ä¸Šé¢æ²¡æœ‰æ‰«åˆ°çš„å±‚ span</span></span><br><span class="line">    <span class="keyword">for</span> i := level; i &lt; sl.level; i++ &#123;</span><br><span class="line">        update[i].level[i].span++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´ backward æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™ backward ä¸º nil</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ backward æŒ‡å‘ä¹‹å‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> update[<span class="number">0</span>] != sl.header &#123;</span><br><span class="line">        <span class="comment">// update[0] å°±æ˜¯å’Œæ–°å¢èŠ‚ç‚¹ç›¸é‚»çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        node.backward = update[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°å¢èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™éœ€è¦æ›´æ–° tail æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> node.level[<span class="number">0</span>].forward == <span class="literal">nil</span> &#123;</span><br><span class="line">        sl.tail = node</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­é—´èŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹çš„å›é€€æŒ‡é’ˆ</span></span><br><span class="line">        node.level[<span class="number">0</span>].forward.backward = node</span><br><span class="line">    &#125;</span><br><span class="line">    sl.length++</span><br><span class="line">    <span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// randomLevel å¯¹äºæ–°å¢èŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªéšæœºçš„ level</span></span><br><span class="line"><span class="comment">// è¿”å›çš„ level èŒƒå›´ä¸º [1, MaxLevel]ã€‚å¹¶ä¸”ï¼Œé‡‡ç”¨çš„</span></span><br><span class="line"><span class="comment">// ç®—æ³•ä¼šä¿è¯ï¼Œæ›´å¤§çš„ level è¿”å›çš„æ¦‚ç‡è¶Šä½ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ª level å‡ºç°çš„æ¦‚ç‡è®¡ç®—ï¼š(1-p) * p^(level-1)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">randomLevel</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    level := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> rand.Float64() &lt; P &amp;&amp; level &lt; MaxLevel &#123;</span><br><span class="line">        level++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> level</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Delete ç”¨äºåˆ é™¤è·³è¡¨ä¸­æŒ‡å®šçš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">Delete</span><span class="params">(score <span class="keyword">float64</span>, elem <span class="keyword">string</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°éœ€è¦åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        targetNode = &amp;Node&#123;elem: elem, score: score&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123;</span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›®æ ‡èŠ‚ç‚¹æ‰¾åˆ°åï¼Œè¿™é‡Œéœ€è¦åˆ¤æ–­ä¸‹ elem æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">    <span class="comment">// score å¯ä»¥é‡å¤ï¼Œæ‰€ä»¥å¿…é¡»è¦è°¨æ…</span></span><br><span class="line">    nodeToBeDeleted := update[<span class="number">0</span>].level[<span class="number">0</span>].forward</span><br><span class="line">    <span class="keyword">if</span> nodeToBeDeleted == <span class="literal">nil</span> || !nodeToBeDeleted.Eq(targetNode) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    sl.deleteNode(update, nodeToBeDeleted)</span><br><span class="line">    <span class="keyword">return</span> nodeToBeDeleted</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">deleteNode</span><span class="params">(update [64]*Node, nodeToBeDeleted *Node)</span></span> &#123;</span><br><span class="line">    <span class="comment">// è¿™æ—¶æˆ‘ä»¬è¦åˆ é™¤çš„èŠ‚ç‚¹å°±æ˜¯ nodeToBeDeleted</span></span><br><span class="line">    <span class="comment">// è°ƒæ•´æ¯å±‚å¾…æ›´æ–°èŠ‚ç‚¹ï¼Œä¿®æ”¹ forward æŒ‡å‘</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sl.level; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> update[i].level[i].forward == nodeToBeDeleted &#123;</span><br><span class="line">            update[i].level[i].forward = nodeToBeDeleted.level[i].forward</span><br><span class="line">            update[i].level[i].span += nodeToBeDeleted.level[i].span - <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            update[i].level[i].span--</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´å›é€€æŒ‡é’ˆï¼š</span></span><br><span class="line">    <span class="comment">// 1. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–° sl.tail</span></span><br><span class="line">    <span class="comment">// 2. å¦‚æœè¢«åˆ é™¤çš„èŠ‚ç‚¹ä½äºä¸­é—´ï¼Œåˆ™ç›´æ¥æ›´æ–°åä¸€ä¸ªèŠ‚ç‚¹ backward å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> sl.tail == nodeToBeDeleted &#123;</span><br><span class="line">        sl.tail = nodeToBeDeleted.backward</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nodeToBeDeleted.level[<span class="number">0</span>].forward.backward = nodeToBeDeleted.backward</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒæ•´å±‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span> sl.header.level[sl.level<span class="number">-1</span>].forward == <span class="literal">nil</span> &#123;</span><br><span class="line">        sl.level--</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‡å°‘èŠ‚ç‚¹è®¡æ•°</span></span><br><span class="line">    sl.length--</span><br><span class="line">    nodeToBeDeleted.backward = <span class="literal">nil</span></span><br><span class="line">    nodeToBeDeleted.level[<span class="number">0</span>].forward = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°åˆ†æ•°"><a href="#æ›´æ–°åˆ†æ•°" class="headerlink" title="æ›´æ–°åˆ†æ•°"></a>æ›´æ–°åˆ†æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UpdateScore ç”¨äºæ›´æ–°èŠ‚ç‚¹çš„åˆ†æ•°ã€‚è¯¥å‡½æ•°ä¼šä¿è¯æ›´æ–°åˆ†æ•°åï¼Œ</span></span><br><span class="line"><span class="comment">// èŠ‚ç‚¹çš„æœ‰åºæ€§ä¾ç„¶å¯ä»¥ç»´æŒã€‚</span></span><br><span class="line"><span class="comment">// ç­–ç•¥å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">// 1. å¿«é€Ÿåˆ¤æ–­èƒ½å¦åŸèŠ‚ç‚¹ä¿®æ”¹ï¼Œå¦‚æœå¯ä»¥åˆ™ç›´æ¥ä¿®æ”¹å¹¶è¿”å›ï¼›</span></span><br><span class="line"><span class="comment">// 2. é‡‡ç”¨æ›´åŠ æ˜‚è´µçš„æ“ä½œï¼šåˆ é™¤å†æ·»åŠ ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">UpdateScore</span><span class="params">(curScore <span class="keyword">float64</span>, elem <span class="keyword">string</span>, newScore <span class="keyword">float64</span>)</span> *<span class="title">Node</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        update [MaxLevel]*Node</span><br><span class="line">        targetNode = &amp;Node&#123;elem: elem, score: curScore&#125;</span><br><span class="line">    )</span><br><span class="line">    cur := sl.header</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> i := sl.level - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">        <span class="keyword">for</span> cur.level[i].forward != <span class="literal">nil</span> &amp;&amp; cur.level[i].forward.Lt(targetNode) &#123;</span><br><span class="line">            cur = cur.level[i].forward</span><br><span class="line">        &#125;</span><br><span class="line">        update[i] = cur</span><br><span class="line">    &#125;</span><br><span class="line">    node := cur.level[<span class="number">0</span>].forward</span><br><span class="line">    <span class="keyword">if</span> node == <span class="literal">nil</span> || !node.Eq(targetNode) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sl.canUpdateScoreFor(node, newScore) &#123;</span><br><span class="line">        node.score = newScore</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œå¢åŠ æ–°èŠ‚ç‚¹</span></span><br><span class="line">        sl.deleteNode(update, node)</span><br><span class="line">        <span class="keyword">return</span> sl.Insert(newScore, node.elem)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// canUpdateScoreFor ç¡®å®šèƒ½å¦ç›´æ¥åœ¨åŸæœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œä¿®æ”¹</span></span><br><span class="line"><span class="comment">// ä»€ä¹ˆæ¡ä»¶æ‰å¯ä»¥ç›´æ¥åŸåœ°æ›´æ–° score å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment">// 1. node æ˜¯å”¯ä¸€ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼ˆnode.backward == NULL &amp;&amp; node-&gt;level[0].forward == NULLï¼‰</span></span><br><span class="line"><span class="comment">// 2. node æ˜¯ç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸”æ–°çš„åˆ†æ•°è¦æ¯” node ä¹‹åèŠ‚ç‚¹åˆ†æ•°è¦å°ï¼ˆè¿™æ ·æ‰èƒ½ä¿è¯æœ‰åºï¼‰</span></span><br><span class="line"><span class="comment">// å³ï¼šnode.backward == NULL &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newScoreï¼‰</span></span><br><span class="line"><span class="comment">// 3. node æ˜¯æœ€åä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸” node ä¹‹å‰èŠ‚ç‚¹çš„åˆ†æ•°è¦æ¯”æ–°æ”¹çš„åˆ†æ•°å°</span></span><br><span class="line"><span class="comment">// å³ï¼šnode-&gt;backward-&gt;score &lt; newScore &amp;&amp; node-&gt;level[0].forward == NULL</span></span><br><span class="line"><span class="comment">// 4. node æ˜¯ä¿®æ”¹çš„åçš„åˆ†æ•°æ°å¥½è¿˜èƒ½ä¿è¯ä½äºå‰ä¸€ä¸ªå’Œåä¸€ä¸ªèŠ‚ç‚¹åˆ†æ•°ä¹‹é—´</span></span><br><span class="line"><span class="comment">// å³ï¼šnode-&gt;backward-&gt;score &lt; newscore &amp;&amp; node-&gt;level[0].forward-&gt;score &gt; newscore</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Skiplist)</span> <span class="title">canUpdateScoreFor</span><span class="params">(node *Node, newScore <span class="keyword">float64</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.backward == <span class="literal">nil</span> || node.backward.score &lt; newScore) &amp;&amp;</span><br><span class="line">        (node.level[<span class="number">0</span>].forward == <span class="literal">nil</span> || node.level[<span class="number">0</span>].forward.score &gt; newScore) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¿—è¯è¯´ï¼Œã€Œè¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥éš¾ã€ã€‚åœ¨å®ç°ã€Œè·³è¡¨ã€çš„æ—¶å€™æ„Ÿå—é¢‡æ·±ï¼Œä¼¼ä¹çœ‹å®Œ Redis çš„ã€Œè·³è¡¨ã€æºç å’Œç½‘ä¸Šè¯¸å¤šå‰è¾ˆç¼–å†™çš„æ–‡ç« åï¼Œè‡ªä»¥ä¸ºæ‡‚å¾—äº†åŸç†ï¼ˆå¯èƒ½ç¡®å®æ‡‚äº†ï¼‰ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°çš„æ—¶å€™è¿˜æ˜¯è¸©äº†ä¸å°‘å‘ã€‚æ¯”å¦‚ï¼Œç©ºæŒ‡é’ˆå¼•èµ· panicï¼›<code>i--</code> å†™æˆäº† <code>i++</code> å¯¼è‡´æŸ¥æ‰¾å¤±è´¥ï¼›ä¸€äº›è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­ç­‰ã€‚æ€»ä¹‹ï¼Œç»†èŠ‚å†³å®šæˆè´¥ï¼Œéœ€è¦åœ¨ä¿æŒæ€è·¯æ¸…æ™°çš„åŒæ—¶ï¼Œæ›´åŠ è°¨æ…ä¸€äº›æ‰èƒ½å†™å‡ºè¶³å¤Ÿå¥å£®çš„ä»£ç æ¥ã€‚å½“ç„¶ï¼Œè¿™æœŸé—´è‡ªç„¶å°‘ä¸äº†å•å…ƒæµ‹è¯•çš„åŠ©æ”»ï¼Œå¦åˆ™æœ‰å¾ˆå¤šé—®é¢˜å¯èƒ½éƒ½æ²¡æ³•æš´éœ²å‡ºæ¥~</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/53975333" target="_blank" rel="noopener">æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯è·³è¡¨ï¼Ÿ</a></li><li><a href="https://juejin.im/post/57fa935b0e3dd90057c50fbc" target="_blank" rel="noopener">Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v2-102788cac4f586778ffbf6767eb99d4f.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;è¯»è¿‡ Redis æºç çš„ç«¥é‹ï¼Œæƒ³å¿…ä¼šçŸ¥é“ zset å®ç°æ—¶ï¼Œä½¿ç”¨äº†ã€Œè·³è¡¨ã€ï¼ˆSkiplistï¼‰è¿™ç§æ•°æ®ç»“æ„å§ã€‚å®ƒçš„åŸç†éå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœå¯¹é“¾è¡¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼ˆæ ¸å¿ƒï¼š&lt;strong&gt;æœ‰åºé“¾è¡¨&lt;/strong&gt; + &lt;strong&gt;åˆ†å±‚&lt;/strong&gt;ï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡å¹¶ä¸ä¼šè¯¦ç»†è®²è§£ã€Œè·³è¡¨ã€çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå¯¹äº Redis è·³è¡¨æºç çš„è¯¦ç»†åˆ†æã€‚å› ä¸ºå·²ç»æœ‰å‰è¾ˆä»¬äº§å‡ºäº†éå¸¸ä¸°å¯Œçš„æ–‡ç« æ¥è®²è§£ Redis è·³è¡¨ï¼Œéœ€è¦çš„è¯ï¼Œæ¨èé˜…è¯» &lt;a href=&quot;https://juejin.im/post/57fa935b0e3dd90057c50fbc&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt; äº†è§£æ›´å¤šç»†èŠ‚ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="/categories/Redis/"/>
    
    
      <category term="Go" scheme="/tags/Go/"/>
    
      <category term="Redis" scheme="/tags/Redis/"/>
    
      <category term="è·³è¡¨" scheme="/tags/%E8%B7%B3%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>Redis 5 æºç åˆæ¢</title>
    <link href="/2019/12/08/primitive-exploration-of-redis5/"/>
    <id>/2019/12/08/primitive-exploration-of-redis5/</id>
    <published>2019-12-08T07:01:24.000Z</published>
    <updated>2019-12-15T06:10:30.103Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">Redis, REmote DIctionary Server</a> å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼</p><p>ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š</p><ol><li>è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›</li><li>ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›</li><li>ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ol><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯<strong>å­—ç¬¦ä¸²ã€é›†åˆï¼ˆæœ‰åº/æ— åºï¼‰ã€å­—å…¸ã€åˆ—è¡¨</strong>ç­‰ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚</p><a id="more"></a><p>æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚</p><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ</p><p>é¦–å…ˆï¼Œ<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹</a> å’Œ <a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a> å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚</p><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼›</li><li>åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼›</li><li>æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼›</li><li>å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚</li></ol><h1 id="Redis-ç‰¹ç‚¹"><a href="#Redis-ç‰¹ç‚¹" class="headerlink" title="Redis ç‰¹ç‚¹"></a>Redis ç‰¹ç‚¹</h1><p>ç¬¬ä¸€ä¸ªå€¼å¾—ç§°é“çš„ç‰¹ç‚¹å°±æ˜¯<strong>é«˜æ€§èƒ½</strong>ï¼ŒRedis çš„é«˜æ€§èƒ½å¾—ç›Šäºå¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š</p><ol><li>å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼›</li><li>æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼›</li><li>ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼›</li><li>é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚</li></ol><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><code>&lt;key, value&gt;</code> ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼›</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼›</li><li>æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼›</li><li>æ”¯æŒé›†ç¾¤ã€‚</li></ol><h1 id="æºç æ¦‚è§ˆ"><a href="#æºç æ¦‚è§ˆ" class="headerlink" title="æºç æ¦‚è§ˆ"></a>æºç æ¦‚è§ˆ</h1><p><em>åé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼š<a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">https://github.com/iFaceless/redis/tree/5.0</a>ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ <code>comment-src</code> åˆ†æ”¯ä¸‹ã€‚</em></p><p>å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ <a href="https://github.com/antirez/redis/tree/5.0#source-code-layout" target="_blank" rel="noopener">README.md</a> ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š</p><ul><li><code>src</code>: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰</li><li><code>tests</code>: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰</li><li><code>deps</code>: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« <code>jemalloc</code> æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ <code>malloc</code>ï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡</li></ul><h2 id="server-h"><a href="#server-h" class="headerlink" title="server.h"></a>server.h</h2><p><code>server.h</code> ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ <code>struct redisServer</code> ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li><code>db</code>: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®</li><li><code>commands</code>: å‘½ä»¤è¡¨</li><li><code>clients</code>: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨</li><li><code>master</code>: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯</li></ul><p>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>redisClient</code>ï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="comment">// å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    sds querybuf;</span><br><span class="line">    <span class="keyword">int</span> argc;</span><br><span class="line">    robj **argv;</span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="comment">// reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">    <span class="built_in">list</span> *reply;</span><br><span class="line">    <span class="keyword">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class="line">    ... many other fields ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>robj</code>ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="comment">// type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></span><br><span class="line">    <span class="comment">// refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">   <span class="comment">// ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><h2 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h2><p>Redis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ <code>main</code> å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š</p><ul><li><code>initServerConfig()</code> ç”¨æ¥é…ç½® <code>struct server</code> çš„é»˜è®¤å€¼</li><li><code>initServer()</code> åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰</li><li><code>aeMain()</code> å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥</li></ul><p>Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>serverCron()</code> ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ <code>server.hz</code> é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰</li><li><code>beforeSleep()</code> ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰</li></ul><p>åœ¨ <code>server.c</code> ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š</p><ul><li><code>call()</code> ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨</li><li><code>activeExpireCycle()</code> ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys</li><li><code>freeMemoryIfNeeded()</code> å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ <code>maxmemory</code> æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜</li><li><code>redisCommandTable</code> ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§</li></ul><h2 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h2><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š</p><ul><li><code>createClient()</code> åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯</li><li><code>addReply*()</code> å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ®</li><li><code>writeToClient()</code> ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« <code>sendReplyToClient()</code> è°ƒç”¨</li><li><code>readQueryFromClient()</code> ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº</li><li><code>processInputBuffer()</code> æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ <code>processCommand()</code> æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤</li><li><code>freeClient()</code> é‡Šæ”¾å®¢æˆ·ç«¯</li></ul><h2 id="aof-c-å’Œ-rdb-c"><a href="#aof-c-å’Œ-rdb-c" class="headerlink" title="aof.c å’Œ rdb.c"></a>aof.c å’Œ rdb.c</h2><p>é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<code>rdb.c</code> åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›<code>aof.c</code> åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚</p><h2 id="db-c"><a href="#db-c" class="headerlink" title="db.c"></a>db.c</h2><p><code>db.c</code> ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ <code>DEL</code> å’Œ <code>EXPIRE</code> ç­‰ã€‚æ­¤å¤–ï¼Œ<code>db.c</code> ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p>ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š</p><ul><li><code>lookupKeyRead()</code> å’Œ <code>lookupKeyWrite()</code> ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>NULL</code></li><li><code>dbAdd()</code> åŠæ›´æŠ½è±¡çš„å‡½æ•° <code>setKey()</code> æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key</li><li><code>dbDelete()</code> ç§»é™¤ key åŠå…³è”çš„ value</li><li><code>emptyDb()</code> ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“</li></ul><h2 id="object-c"><a href="#object-c" class="headerlink" title="object.c"></a>object.c</h2><p><code>struct robj</code> æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ <code>object.c</code> ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>incrRefcount()</code> å’Œ <code>decrRefCount()</code> ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡</li><li><code>createObject()</code> ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ <code>createStringObjectFromLongLong()</code> ç­‰</li></ul><h2 id="replication-c"><a href="#replication-c" class="headerlink" title="replication.c"></a>replication.c</h2><p><code>replication.c</code> æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚</p><p>è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° <code>replicationFeedSlaves()</code>ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† <code>SYNC</code> å’Œ <code>PSYNC</code> å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚</p><h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><ul><li><code>t_hash.c</code>, <code>t_list.c</code>, <code>t_set.c</code>, <code>t_string.c</code> å’Œ <code>t_zset.c</code>  æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç°</li><li><code>ae.c</code> Redis äº‹ä»¶å¾ªç¯å®ç°</li><li><code>sds.c</code> Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸²</li><li><code>anet.c</code> å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£</li><li><code>dict.c</code> éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç°</li><li><code>scripting.c</code> å®ç°äº† Luc è„šæœ¬</li><li><code>cluster.c</code> Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ <a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis é›†ç¾¤è¯´æ˜</a></li></ul><h2 id="æ€ç»´å¯¼å›¾"><a href="#æ€ç»´å¯¼å›¾" class="headerlink" title="æ€ç»´å¯¼å›¾"></a>æ€ç»´å¯¼å›¾</h2><p><img src="https://pic1.zhimg.com/80/v2-f63c98a65e85898b828f3446f260a060.png" alt=""></p><h1 id="æ„å»º-amp-è°ƒè¯•"><a href="#æ„å»º-amp-è°ƒè¯•" class="headerlink" title="æ„å»º &amp; è°ƒè¯•"></a>æ„å»º &amp; è°ƒè¯•</h1><p>Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a> ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ <a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a> è¿™ç¯‡æ–‡ç« ~</p><p>åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° <code>src</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./mkreleasehdr.sh</code> è„šæœ¬ç”Ÿæˆ <code>src/release.h</code> æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake .</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ <code>src/server.c</code> ï¼Œå¹¶æ‰¾åˆ° <code>main</code> å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» <code>main</code> å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚</p><p><img src="https://pic1.zhimg.com/v2-823df912ab47cf9dbe7ccc53a0eae03f.jpg" alt=""></p><p>Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š<br><img src="https://pic2.zhimg.com/v2-66bb67315fc0d86701b95ae306679eeb.jpg" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://github.com/antirez/redis/tree/5.0" target="_blank" rel="noopener">Redis README</a></li><li><a href="https://sunznx.com/redis/redis-source-debug-with-clion.html" target="_blank" rel="noopener">Clion è°ƒè¯• Redis æºç </a></li><li><a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/iFaceless/redis/tree/5.0&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Redis, REmote DIctionary Server&lt;/a&gt; å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼&lt;/p&gt;
&lt;p&gt;ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›&lt;/li&gt;
&lt;li&gt;ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯&lt;strong&gt;å­—ç¬¦ä¸²ã€é›†åˆï¼ˆæœ‰åº/æ— åºï¼‰ã€å­—å…¸ã€åˆ—è¡¨&lt;/strong&gt;ç­‰ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Redis" scheme="/categories/Redis/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Redis" scheme="/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>gcache æºç å­¦ä¹ </title>
    <link href="/2019/12/03/gcache-code-analysis/"/>
    <id>/2019/12/03/gcache-code-analysis/</id>
    <published>2019-12-03T12:36:43.000Z</published>
    <updated>2019-12-08T07:11:32.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">Redis, REmote DIctionary Server</a> å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼</p><p>ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š</p><ol><li>è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›</li><li>ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›</li><li>ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ol><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯ <code>string</code>, <code>set</code>, <code>zset</code>, <code>list</code>, <code>hash map</code>ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚</p><a id="more"></a><p>æ—¢ç„¶ Redis è¿™ä¹ˆé‡è¦ï¼Œè‡ªç„¶å¾ˆæœ‰å¿…è¦èŠ±æ—¶é—´å»ç ”ç©¶ä¸‹ Redisï¼Œå¹¶é˜…è¯»å®ƒçš„æºç æ¥å­¦ä¹ å®ƒçš„ä¸€äº›è®¾è®¡æ€æƒ³ï¼Œç¼–ç¨‹é£æ ¼ç­‰ã€‚ä¸å¾—ä¸è¯´ï¼ŒRedis å®˜æ–¹æ–‡æ¡£éå¸¸ç»™åŠ›ï¼Œæºç æ³¨é‡Šå¾ˆå……åˆ†ï¼Œä»£ç é£æ ¼ã€è´¨é‡éƒ½æ˜¯éå¸¸ä¸€æµçš„ã€‚</p><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Redis æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆé‡è¦ï¼Ÿæ¥ä¸‹æ¥å°±æ˜¯æ€ä¹ˆæ¥å­¦ä¹ å®ƒï¼Ÿç„¶åæ˜¯æœŸæœ›è¾¾æˆä»€ä¹ˆæ ·çš„ç›®æ ‡ï¼Ÿ</p><p>é¦–å…ˆï¼Œ<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹</a> å’Œ <a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a> å°†ä½œä¸ºå­¦ä¹  Redis æºç çš„ä¸»è¦å‚è€ƒä¹¦ç±ï¼ˆã€Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€ï¼‰ï¼›å…¶æ¬¡æ˜¯é˜…è¯»ä¸‹ Redis å®˜æ–¹æ–‡æ¡£ä¸­æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼›å½“ç„¶ï¼Œæœ€åä¸”æœ€é‡è¦çš„æ˜¯è‡ªå·±è¦è®¤çœŸé˜…è¯»æºç ã€‚</p><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼ŒæœŸæœ›åœ¨å­¦ä¹ å®Œ Redis è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘æƒ³ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>åŸ¹å…»é˜…è¯»çŸ¥åå¼€æºé¡¹ç›®æºç çš„è€å¿ƒï¼ŒæŒæ¡é˜…è¯»æºç çš„æŠ€å·§å’Œå·¥å…·ï¼›</li><li>åŠ æ·±å¯¹ Redis çš„ç†è§£ï¼Œäº†è§£å®ƒçš„æ¶æ„è®¾è®¡ï¼›</li><li>æŒæ¡ Redis å¸¸ç”¨çš„æ•°æ®ç»“æ„è®¾è®¡æ€æƒ³ï¼Œå¹¶èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åˆç†è¿ç”¨å„ç§æ•°æ®ç»“æ„å®ç°éœ€æ±‚ï¼›</li><li>å¸æ”¶ç²¾é«“ï¼Œæå‡è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œä¸šä½™æ—¶é—´è¿˜å¯ä»¥å°è¯•æŠ˜è…¾ä¸ªç®€å•çš„æ•°æ®åº“ã€‚</li></ol><h1 id="Redis-ç‰¹ç‚¹"><a href="#Redis-ç‰¹ç‚¹" class="headerlink" title="Redis ç‰¹ç‚¹"></a>Redis ç‰¹ç‚¹</h1><p>Redis ä¹‹æ‰€ä»¥èƒ½å¤Ÿæœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹åŸå› ï¼š</p><ol><li>å®ƒæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå†…å­˜çš„è¯»å†™é€Ÿåº¦å¾ˆå¿«ï¼›</li><li>æ‹¥æœ‰åˆç†è®¾è®¡çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹æŸ¥å¾ˆç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨å†…å­˜ï¼›</li><li>ä½¿ç”¨äº† I/O å¤šè·¯å¤ç”¨çš„æœºåˆ¶ï¼ˆselect, poll, epoll, kqueueï¼‰ï¼Œé«˜æ•ˆå¤„ç†é«˜å¹¶å‘çš„ç½‘ç»œè¿æ¥ï¼›</li><li>é‡‡ç”¨äº†å•è¿›ç¨‹æ¨¡å‹ï¼ˆRedis Server ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé¿å…çº¿ç¨‹è°ƒåº¦å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ï¼ˆå¦‚åŠ é”ã€é‡Šæ”¾é”ç­‰ï¼‰ã€‚</li></ol><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><code>&lt;key, value&gt;</code> ä¸­çš„ value é™¤äº†æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚é›†åˆã€å­—å…¸ã€ä½å›¾ç­‰ï¼‰ï¼›</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯åœ¨é‡å¯åæ¢å¤ï¼Œæ”¯æŒ AOFã€RDB å’Œ AOF + RDB ä¸‰ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼›</li><li>æ”¯æŒä¸»ä»ç»“æ„ï¼Œä»èŠ‚ç‚¹å¯åšæ•°æ®å¤‡ä»½ï¼Œä¹Ÿå¯å¯¹å¤–æä¾›è¯»æœåŠ¡ï¼›</li><li>æ”¯æŒé›†ç¾¤ã€‚</li></ol><h1 id="æºç æ¦‚è§ˆ"><a href="#æºç æ¦‚è§ˆ" class="headerlink" title="æºç æ¦‚è§ˆ"></a>æºç æ¦‚è§ˆ</h1><p><em>åé¢çš„æºç å­¦ä¹ ä¼šåŸºäº Redis æœ€æ–°çš„ç¨³å®šç‰ˆ 5.0.7ï¼Œå‚è§ä»“åº“ï¼š<a href="https://github.com/iFaceless/redis/tree/5.0" target="_blank" rel="noopener">https://github.com/iFaceless/redis/tree/5.0</a>ï¼Œæºç æ³¨é‡Šä¼šæ¨é€åˆ°è¯¥ä»“åº“çš„ <code>comment-src</code> åˆ†æ”¯ä¸‹ã€‚</em></p><p>å…³äº Redis æºç çš„ç»“æ„ï¼Œåœ¨ Redis çš„ <a href="https://github.com/antirez/redis/tree/5.0#source-code-layout" target="_blank" rel="noopener">README.md</a> ä¸­æœ‰æ‰€ä»‹ç»ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„ç›®å½•ï¼š</p><ul><li><code>src</code>: Redis æ ¸å¿ƒå®ç°ï¼ˆC è¯­è¨€ï¼‰</li><li><code>tests</code>: å•å…ƒæµ‹è¯•ä»£ç ï¼ˆTcl è¯­è¨€ï¼‰</li><li><code>deps</code>: Redis ä¾èµ–çš„ä¸€äº›åº“ã€‚å…¶ä¸­åŒ…å« <code>jemalloc</code> æºç ï¼Œå®ƒæ˜¯ Redis åœ¨ Linux ä¸‹é»˜è®¤çš„å†…å­˜åˆ†é…åº“ï¼Œç”¨æ¥æ›¿ä»£æ ‡å‡†åº“ <code>malloc</code>ï¼Œä»¥æœŸå‡å°‘å†…å­˜åˆ†é…ç¢ç‰‡</li></ul><h2 id="server-h"><a href="#server-h" class="headerlink" title="server.h"></a>server.h</h2><p><code>server.h</code> ä¸­å®šä¹‰äº† Redis Server éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ <code>struct redisServer</code> ç»´æŠ¤äº† Redis æœåŠ¡ç«¯é…ç½®å’Œå…±äº«çŠ¶æ€ï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li><code>db</code>: è¡¨ç¤º Redis æ•°æ®åº“ï¼Œç”¨æ¥å­˜å‚¨æ•°æ®</li><li><code>commands</code>: å‘½ä»¤è¡¨</li><li><code>clients</code>: è¿æ¥åˆ°å½“å‰æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é“¾è¡¨</li><li><code>master</code>: replica èŠ‚ç‚¹ master å®¢æˆ·ç«¯</li></ul><p>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>redisClient</code>ï¼Œç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ã€‚è¿™é‡Œç»™ä»‹ç»å‡ ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="comment">// å­˜æ”¾å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    sds querybuf;</span><br><span class="line">    <span class="keyword">int</span> argc;</span><br><span class="line">    robj **argv;</span><br><span class="line">    redisDb *db;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="comment">// reply &amp; buf ç»´æŠ¤æœåŠ¡ç«¯è¦å‘ç»™å®¢æˆ·ç«¯çš„å›å¤é˜Ÿåˆ—ï¼Œå½“åº•å±‚çš„ fd å¯å†™æ—¶ï¼Œä¼šä»¥æ¸è¿›åœ°æ–¹å¼å‘é€ç¼“å†²åŒºæ•°æ®</span></span><br><span class="line">    <span class="built_in">list</span> *reply;</span><br><span class="line">    <span class="keyword">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class="line">    ... many other fields ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„æ˜¯ <code>robj</code>ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ª Redis å¯¹è±¡ï¼Œåœ¨ Redis å†…éƒ¨å®ç°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨ä½¿ç”¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// redisObject åŸºæœ¬ä¸Šå¯ä»¥è¡¨ç¤ºæ‰€æœ‰å¸¸ç”¨çš„ Redis æ•°æ®ç±»å‹ï¼ˆlists, sets, strings ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="comment">// type è¡¨ç¤ºå…·ä½“çš„æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></span><br><span class="line">    <span class="comment">// refcount è¡¨ç¤ºå¯¹è±¡å¼•ç”¨æ¬¡æ•°ï¼Œå€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œé¿å…ä¸ºé‡å¤å¯¹è±¡åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">   <span class="comment">// ptr æŒ‡å‘åº•å±‚çš„çœŸæ­£çš„å¯¹è±¡è¡¨ç¤ºï¼Œç»“åˆ `encoding` è¿›è¡Œè§£æ</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure><h2 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h2><p>Redis Server å¯åŠ¨çš„å…¥å£å®šä¹‰åœ¨æ­¤å¤„ï¼ˆå‚è§ <code>main</code> å‡½æ•°ï¼‰ã€‚ä¸‹é¢æ˜¯ Redis Server å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œçš„é‡è¦æ­¥éª¤ï¼š</p><ul><li><code>initServerConfig()</code> ç”¨æ¥é…ç½® <code>struct server</code> çš„é»˜è®¤å€¼</li><li><code>initServer()</code> åˆ†é…ä¸€äº›å¿…è¦çš„æ•°æ®ç»“æ„ã€é…ç½®ç›‘å¬çš„ socket ç­‰</li><li><code>aeMain()</code> å¯åŠ¨ Event Loopï¼Œç›‘å¬æ–°çš„è¿æ¥</li></ul><p>Event Loop ä¸­ä¼šå‘¨æœŸè°ƒç”¨çš„ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>serverCron()</code> ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼ˆå‚è€ƒ <code>server.hz</code> é…ç½®çš„é¢‘ç‡ï¼‰ï¼Œæ‰§è¡Œä¸€äº›å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå¦‚æ£€æŸ¥å®¢æˆ·ç«¯è¶…æ—¶ç­‰</li><li><code>beforeSleep()</code> ä¼šåœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶é©±åŠ¨åº“ä¸»å¾ªç¯æ—¶è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡çœ ç­‰å¾… ready çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰</li></ul><p>åœ¨ <code>server.c</code> ä¸­è¿˜æœ‰å‡ ä¸ªå‡½æ•°ä¸“é—¨å¤„ç†å…¶å®ƒç±»å‹çš„é‡è¦ä»»åŠ¡ï¼š</p><ul><li><code>call()</code> ä¼šåœ¨æŒ‡å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒæŒ‡å®šå‘½ä»¤æ—¶è¢«ä½¿ç”¨</li><li><code>activeExpireCycle()</code> ç”¨æ¥å¤„ç†è¿‡æœŸçš„ keys</li><li><code>freeMemoryIfNeeded()</code> å½“ Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ <code>maxmemory</code> æŒ‡å®šçš„å€¼ï¼Œä¸”æœ‰æ–°çš„å†™å…¥è¿›æ¥æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å‡½æ•°æ¸…ç†å†…å­˜</li><li><code>redisCommandTable</code> ç»´æŠ¤äº†æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå‘½ä»¤çš„åç§°ã€å›è°ƒå‡½æ•°ã€å‚æ•°ä¸ªæ•°åŠå…¶å®ƒå±æ€§</li></ul><h2 id="networking-c"><a href="#networking-c" class="headerlink" title="networking.c"></a>networking.c</h2><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†æ‰€æœ‰çš„ I/O å‡½æ•°ï¼Œç”¨æ¥å’Œå®¢æˆ·ç«¯ã€master åŠ replicas äº¤äº’ï¼š</p><ul><li><code>createClient()</code> åˆå§‹åŒ–æ–°çš„å®¢æˆ·ç«¯</li><li><code>addReply*()</code> å‡½æ•°æ—ç”¨äºç»™å®¢æˆ·ç«¯æ·»åŠ å“åº”æ•°æ®</li><li><code>writeToClient()</code> ç”¨äºå°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒä¼šè¢« <code>sendReplyToClient()</code> è°ƒç”¨</li><li><code>readQueryFromClient()</code> ç”¨äºèšé›†ä»å®¢æˆ·ç«¯è¯»å–çš„æ•°æ®åˆ°æŸ¥è¯¢ç¼“å†²åŒº</li><li><code>processInputBuffer()</code> æ˜¯ä»å®¢æˆ·ç«¯æŸ¥è¯¢ç¼“å†²åŒºï¼ˆquery bufferï¼‰æ ¹æ® Redis åè®®è§£ææŸ¥è¯¢å‘½ä»¤çš„å…¥å£å‡½æ•°ã€‚ä¸€æ—¦å‘½ä»¤å¯ä»¥å¤„ç†äº†ï¼Œå°±ä¼šè°ƒç”¨ <code>processCommand()</code> æ¥çœŸæ­£æ‰§è¡Œå‘½ä»¤</li><li><code>freeClient()</code> é‡Šæ”¾å®¢æˆ·ç«¯</li></ul><h2 id="aof-c-å’Œ-rdb-c"><a href="#aof-c-å’Œ-rdb-c" class="headerlink" title="aof.c å’Œ rdb.c"></a>aof.c å’Œ rdb.c</h2><p>é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ Redis ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆçš„å…·ä½“å®ç°æ–‡ä»¶ã€‚Redis çš„æŒä¹…åŒ–æ¨¡å‹æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒä¼šé€šè¿‡ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶èƒ½è®¿é—®ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼›æ¥ä¸‹æ¥è¿™ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šå°†å†…å­˜å†…å®¹æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<code>rdb.c</code> åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šä½¿ç”¨è¿™ç§æœºåˆ¶ï¼›<code>aof.c</code> åœ¨æ‰§è¡Œ AOF é‡å†™ï¼ˆé¿å… Append Only æ–‡ä»¶è¿‡å¤§ï¼‰æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªæœºåˆ¶ã€‚</p><h2 id="db-c"><a href="#db-c" class="headerlink" title="db.c"></a>db.c</h2><p><code>db.c</code> ä¸­å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ“ä½œå‘½ä»¤ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹ key è¿›è¡Œçš„æ“ä½œï¼Œè€Œéå¯¹åº”çš„æ•°æ®ï¼Œæ¯”å¦‚ <code>DEL</code> å’Œ <code>EXPIRE</code> ç­‰ã€‚æ­¤å¤–ï¼Œ<code>db.c</code> ä¸­è¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„ API ç”¨äºåœ¨ Redis æ•°æ®é›†ä¸Šæ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œä¸ç”¨è®¿é—®å†…éƒ¨å…·ä½“çš„æ•°æ®ç»“æ„ã€‚</p><p>ä»¥ä¸‹æ˜¯è®¸å¤šå‘½ä»¤å®ç°ä¸­éƒ½ä¼šç”¨åˆ°çš„å‡½æ•°ï¼š</p><ul><li><code>lookupKeyRead()</code> å’Œ <code>lookupKeyWrite()</code> ç”¨äºåŸºäºæŒ‡å®š key å¾—åˆ°å¯¹åº”å€¼çš„æŒ‡é’ˆï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>NULL</code></li><li><code>dbAdd()</code> åŠæ›´æŠ½è±¡çš„å‡½æ•° <code>setKey()</code> æ˜¯ç”¨æ¥åœ¨ Redis ä¸­åˆ›å»ºæ–°çš„ key</li><li><code>dbDelete()</code> ç§»é™¤ key åŠå…³è”çš„ value</li><li><code>emptyDb()</code> ç§»é™¤æŒ‡å®šçš„æ•°æ®åº“æˆ–è€…æ‰€æœ‰çš„æ•°æ®åº“</li></ul><h2 id="object-c"><a href="#object-c" class="headerlink" title="object.c"></a>object.c</h2><p><code>struct robj</code> æ˜¯ Redis å¯¹è±¡çš„å®šä¹‰ï¼Œåœ¨ <code>object.c</code> ä¸­æœ‰å¾ˆå¤šåº”ç”¨äº Redis å¯¹è±¡çš„æ“ä½œï¼Œå…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>incrRefcount()</code> å’Œ <code>decrRefCount()</code> ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨å€¼ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾å¯¹è±¡</li><li><code>createObject()</code> ç”¨äºåˆ†é…æ–°çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’ˆå¯¹ç‰¹æ®Šå†…å®¹åˆ†é…å­—ç¬¦ä¸²å¯¹è±¡çš„å‡½æ•°ï¼Œå¦‚ <code>createStringObjectFromLongLong()</code> ç­‰</li></ul><h2 id="replication-c"><a href="#replication-c" class="headerlink" title="replication.c"></a>replication.c</h2><p><code>replication.c</code> æ–‡ä»¶ä¸­å®ç°äº† master å’Œ replica è§’è‰²ã€‚ä½†è¿™å—å†…å®¹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¯¹ Redis å…¶å®ƒéƒ¨åˆ†ä»£ç æœ‰æ‰€äº†è§£åå†æ¥å­¦ä¹ å®ƒã€‚</p><p>è¯¥æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•° <code>replicationFeedSlaves()</code>ï¼Œå®ƒç”¨æ¥å°†å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯å’Œä¸»èŠ‚ç‚¹æ•°æ®åŒæ­¥ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®ç°äº† <code>SYNC</code> å’Œ <code>PSYNC</code> å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºä»èŠ‚ç‚¹åˆæ¬¡åˆå§‹åŒ–åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿æ¥æ–­å¼€å¹¶é‡è¿åç»§ç»­ä¿æŒåŒæ­¥ã€‚</p><h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><ul><li><code>t_hash.c</code>, <code>t_list.c</code>, <code>t_set.c</code>, <code>t_string.c</code> å’Œ <code>t_zset.c</code>  æ˜¯ Redis æ•°æ®ç±»å‹çš„åº•å±‚å®ç°</li><li><code>ae.c</code> Redis äº‹ä»¶å¾ªç¯å®ç°</li><li><code>sds.c</code> Redis åŠ¨æ€å˜é•¿å­—ç¬¦ä¸²</li><li><code>anet.c</code> å¯¹å†…æ ¸æä¾›çš„ç½‘ç»œæ¥å£åšäº†å°è£…ï¼Œä»è€Œèƒ½å¤Ÿä»¥æ›´åŠ ç®€å•çš„æ–¹å¼ä½¿ç”¨ POSIX ç½‘ç»œæ¥å£</li><li><code>dict.c</code> éé˜»å¡ã€æ¸è¿› rehash å­—å…¸å®ç°</li><li><code>scripting.c</code> å®ç°äº† Luc è„šæœ¬</li><li><code>cluster.c</code> Redis é›†ç¾¤å®ç°ã€‚åœ¨äº†è§£è¿™å—ä»£ç å‰ï¼Œè®°å¾—å‚è€ƒä¸‹ <a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis é›†ç¾¤è¯´æ˜</a></li></ul><h2 id="æ€ç»´å¯¼å›¾"><a href="#æ€ç»´å¯¼å›¾" class="headerlink" title="æ€ç»´å¯¼å›¾"></a>æ€ç»´å¯¼å›¾</h2><p><img src="https://pic4.zhimg.com/v2-aab236e8173ddcc8e76721fbf651ea53.jpg" alt=""></p><h1 id="æ„å»º-amp-è°ƒè¯•"><a href="#æ„å»º-amp-è°ƒè¯•" class="headerlink" title="æ„å»º &amp; è°ƒè¯•"></a>æ„å»º &amp; è°ƒè¯•</h1><p>Redis å®˜æ–¹æ–‡æ¡£ä¸­æœ‰å…³äºæ„å»ºå’Œè¿è¡Œå®ƒçš„è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª IDE æ­»å¿ å…šï¼Œè‡ªç„¶æ˜¯è¦åœ¨ <a href="https://www.jetbrains.com/clion/" target="_blank" rel="noopener">Clion</a> ä¸­æ„å»ºå’Œè°ƒè¯• Redis çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒClion ä½¿ç”¨äº† cmake æ¥ç®¡ç†é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Redis æºç æ ¹ç›®å½•ä¸‹ä¸ºå®ƒåˆ›å»ºå¥½ CMakeLists.txt æ‰èƒ½è¿›è¡Œæ„å»ºã€‚å…·ä½“å¯å‚è€ƒ <a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a> è¿™ç¯‡æ–‡ç« ~</p><p>åœ¨å®Œæˆä¸Šä¸€æ­¥åï¼Œåˆ‡åˆ° <code>src</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./mkreleasehdr.sh</code> è„šæœ¬ç”Ÿæˆ <code>src/release.h</code> æ–‡ä»¶ï¼Œå¦åˆ™æ„å»ºå¯èƒ½ä¼šå¤±è´¥ã€‚ç„¶ååœ¨æºç ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake .</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Clion æ‰“å¼€ <code>src/server.c</code> ï¼Œå¹¶æ‰¾åˆ° <code>main</code> å‡½æ•°ï¼Œç‚¹å‡»å·¥å…·æ ä¸­çš„è¿è¡Œæˆ–è°ƒè¯•æŒ‰é’®ï¼Œæˆ–è€…ç‚¹å‡» <code>main</code> å‡½æ•°å·¦ä¾§çš„æŒ‰é’®é€‰æ‹©è¿è¡Œæˆ–è°ƒè¯•ã€‚</p><p><img src="https://pic1.zhimg.com/v2-823df912ab47cf9dbe7ccc53a0eae03f.jpg" alt=""></p><p>Redis æœåŠ¡å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨ 6379 ç«¯å£ï¼Œä¹Ÿå¯ä»¥åœ¨ Clion ä¸­é…ç½®å‚æ•°ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£ç­‰ï¼š<br><img src="https://pic2.zhimg.com/v2-66bb67315fc0d86701b95ae306679eeb.jpg" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ Clion æ¥é˜…è¯»ã€è¿è¡Œæˆ–è€…è°ƒè¯• Redis ä»£ç å•¦ã€‚æœ‰äº†ç¥å™¨åŠ©æ”»ï¼Œä¾¿äºæˆ‘ä»¬é€šè¿‡è°ƒè¯•å·¥å…·è¿½è¸ªè°ƒç”¨é“¾ï¼Œå¹¶äº†è§£æ‰§è¡Œæ­¥éª¤ä¸­å„ä¸ªä¸­é—´çŠ¶æ€ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol><li><a href="https://github.com/antirez/redis/tree/5.0" target="_blank" rel="noopener">Redis README</a></li><li><a href="https://sunznx.com/redis/redis-source-debug-with-clion.html" target="_blank" rel="noopener">Clion è°ƒè¯• Redis æºç </a></li><li><a href="https://lijinglin.dev/post/2019/debug-redis-with-clion/" target="_blank" rel="noopener">ä½¿ç”¨ Clion æ¥è°ƒè¯• Redis æºç </a></li><li><a href="https://book.douban.com/subject/34804798/" target="_blank" rel="noopener">ã€ŠRedis 5 è®¾è®¡ä¸æºç åˆ†æã€‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/iFaceless/redis/tree/5.0&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Redis, REmote DIctionary Server&lt;/a&gt; å› å…¶é«˜æ•ˆã€ç®€å•ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒã€é«˜æ€§èƒ½ã€æŒä¹…åŒ–å’Œé›†ç¾¤æ”¯æŒç­‰ç‰¹æ€§å¾—åˆ°äº†ç¨‹åºå‘˜ä»¬çš„é’çï¼Œå¹¶è¢«å¹¿æ³›éƒ¨ç½²å’Œåº”ç”¨åœ¨ä¼—å¤šäº’è”ç½‘å…¬å¸ã€‚è€Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ¯”è¾ƒç®€å•çš„æ–‡æœ¬åè®®ï¼Œä½¿å¾—å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰ä¼—å¤šç¼–ç¨‹è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼›ç”šè‡³ä¹Ÿæœ‰ä¸€äº›å…¶å®ƒç±»å‹çš„ K-V æ•°æ®åº“å…¼å®¹äº† Redis åè®®ï¼&lt;/p&gt;
&lt;p&gt;ç»“åˆæˆ‘ä»¬ç›®å‰çš„ä¸šåŠ¡æ¥çœ‹ï¼Œæœ‰éå¸¸å¤šçš„åœºæ™¯ä½¿ç”¨åˆ°äº† Redisï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è®°å½•ç”¨æˆ·é€šçŸ¥ã€çŸ­ä¿¡å‘é€æ ‡å¿—ï¼Œé¿å…é‡å¤å‘é€ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ Redis é›†åˆç»´æŠ¤ä¸€äº›ç™½åå•ç”¨æˆ·è¡¨ï¼›&lt;/li&gt;
&lt;li&gt;ä¸ºæ”¯æŒå¿«é€Ÿè·å¾—ç”¨æˆ·ä¼šå‘˜æ—¶é•¿ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯åœ¨ Redis é›†ç¾¤ä¸­ä¹Ÿç»´æŠ¤äº†ä¸€ä»½ï¼Œå¹¶é‡‡å–ç›¸å…³æªæ–½ç»´æŒä¸ MySQL æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯å¯ä»¥ä¾‹ä¸¾ï¼Œä½†å°±æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ Redis æ•°æ®ç»“æ„æ¥çœ‹ï¼Œä¸»è¦å°±æ˜¯ &lt;code&gt;string&lt;/code&gt;, &lt;code&gt;set&lt;/code&gt;, &lt;code&gt;zset&lt;/code&gt;, &lt;code&gt;list&lt;/code&gt;, &lt;code&gt;hash map&lt;/code&gt;ã€‚è™½è¯´ Redis ç»™æˆ‘ä»¬æä¾›äº†å…¶å®ƒä¸°å¯Œçš„å†…å­˜æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨åˆ°çš„å¹¶ä¸å¤šã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Go" scheme="/categories/Go/"/>
    
    
      <category term="ç¼“å­˜" scheme="/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="LRU" scheme="/tags/LRU/"/>
    
      <category term="LFU" scheme="/tags/LFU/"/>
    
      <category term="ARC" scheme="/tags/ARC/"/>
    
  </entry>
  
  <entry>
    <title>Go è¯­è¨€ä¸­å¦‚ä½•ä»¥ä¼˜é›…çš„å§¿åŠ¿å®ç°å¯¹è±¡åºåˆ—åŒ–ï¼Ÿ</title>
    <link href="/2019/11/28/portal/"/>
    <id>/2019/11/28/portal/</id>
    <published>2019-11-28T13:50:45.000Z</published>
    <updated>2019-11-28T09:41:31.558Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚</p><p>è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚<br><a id="more"></a><br>ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¹Ÿé‡åˆ°äº†è¯¸å¤šé—®é¢˜ï¼š</p><ol><li>API Schema çš„å­—æ®µç±»å‹å’Œ Model ä¸­å®šä¹‰çš„ä¸åŒï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨å‘å·å™¨è·å¾—çš„ ID åœ¨ Model struct ä¸­å®šä¹‰çš„æ˜¯ int64ï¼Œä½†æ˜¯ä¸ºäº†é¿å… json.Marshal æ—¶æº¢å‡ºï¼ˆæµè§ˆå™¨æˆªæ–­ï¼‰ï¼Œç»Ÿä¸€è¿”å›äº† string ç±»å‹çš„ IDï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼›</li><li>API Schema çš„å­—æ®µåç§°å’Œ Model ä¸­å®šä¹‰çš„å¯èƒ½ä¸åŒï¼›</li><li>æ”¯æŒçµæ´»çš„ Schema å­—æ®µè¿‡æ»¤æ¯”è¾ƒéº»çƒ¦ï¼Œä¸åŒçš„é¡¹ç›®å®ç°å¯èƒ½ä¸åŒï¼›</li><li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚è¯¾ç¨‹ API Schema å…³è”çš„ä¸€äº›æ•°æ®æ¥è‡ªäºå…¶å®ƒæœåŠ¡ï¼ˆéœ€è¦é€šè¿‡ RPC è°ƒç”¨ï¼‰ï¼Œè¿™æ—¶å¦‚æœèƒ½å¤Ÿå¹¶å‘åŠ è½½å°±æœ‰æé«˜æ¥å£å“åº”é€Ÿåº¦çš„å¯èƒ½ï¼Œä½†æ˜¯éœ€è¦æ¯æ¬¡åœ¨åº”ç”¨å±‚é‡æ–°å®ç°ï¼ˆå½“ç„¶å¯ä»¥å†æŠ½ä¸€å±‚å‡ºæ¥ï¼Œä¸è¿‡è¿˜æ˜¯å¾ˆéº»çƒ¦ï¼Œä¼šæœ‰å¿ƒæ™ºè´Ÿæ‹…ï¼‰ã€‚</li><li>â€¦â€¦</li></ol><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ</p><h1 id="æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”"><a href="#æ€ä¹ˆè§£å†³ï¼Ÿ-ğŸ¤”" class="headerlink" title="æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”"></a>æ€ä¹ˆè§£å†³ï¼Ÿ ğŸ¤”</h1><p>æˆ‘ä»¬ä¹‹å‰åœ¨ä½¿ç”¨ Python é¡¹ç›®å¼€å‘æ—¶ï¼Œä½¿ç”¨åˆ°äº† <a href="https://github.com/marshmallow-code/marshmallow" target="_blank" rel="noopener">marshmallow</a> è¿™ä¸ªè½»é‡çº§çš„å¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ã€‚å½“ç„¶ï¼Œå®ƒä¸ä»…ä»…æä¾›åºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œè¿˜æœ‰ååºåˆ—åŒ–ä»¥åŠå­—æ®µæ ¡éªŒçš„èƒ½åŠ›ã€‚å¦‚æœèƒ½å¤Ÿæ°å½“çš„ä½¿ç”¨å®ƒï¼Œæ˜¯å¯ä»¥æå‡å¼€å‘æ•ˆç‡çš„ã€‚å¦‚æœåœ¨ Go è¯­è¨€ç¤¾åŒºä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªæ¡†æ¶çš„è¯ï¼Œå®ƒæ˜¯å¯ä»¥è§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜çš„ã€‚</p><p>åœ¨ç»è¿‡ä¸€ç•ªæ€æƒ³æ–—äº‰åï¼Œæ–—èƒ†å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„æ¡†æ¶ <a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> ç”¨äºè§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›é—®é¢˜ã€‚<a href="https://github.com/iFaceless/portal" target="_blank" rel="noopener">portal</a> èšç„¦äºä»¥ä¼˜é›…ä¸”ä¸€è‡´çš„æ–¹å¼å¤„ç†å¯¹è±¡åºåˆ—åŒ–çš„é—®é¢˜ï¼›è€Œå¯¹äº Struct Fields çš„æ ¡éªŒé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¬¬ä¸‰æ–¹åº“å¦‚ <a href="https://github.com/go-playground/validator" target="_blank" rel="noopener">go-playground/validator</a> æˆ– <a href="https://github.com/asaskevich/govalidator" target="_blank" rel="noopener">asaskevich/govalidator</a>ã€‚</p><p>ç›®å‰æ¥è¯´ï¼Œæ ¸å¿ƒåŠŸèƒ½å‡å·²æŒ‰ç…§æœ€åˆçš„è®¾è®¡å®ç°äº†ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ol><li>æä¾›ç®€æ´æ˜“ç”¨çš„ API æ¥å£</li><li>æ”¯æŒéå¸¸çµæ´»çš„å­—æ®µè¿‡æ»¤èƒ½åŠ›ï¼ˆä»»æ„æ·±åº¦çš„åµŒå¥—å­—æ®µè¿‡æ»¤ï¼‰</li><li>è‡ªåŠ¨å°è¯•ç±»å‹è½¬æ¢ï¼Œè¿œç¦»æ‰‹åŠ¨ç¼–å†™å¤ªå¤šæ²¡ä»€ä¹ˆçµé­‚çš„ç±»å‹è½¬æ¢ä»£ç ï¼ˆæ—©ç‚¹ä¸‹ç­ä¸å¥½å—ï¼Ÿï¼‰</li><li>æ”¯æŒå¹¶å‘å¡«å……å­—æ®µå€¼ï¼š<ol><li>å¯æ‰‹åŠ¨æŒ‡å®šå“ªäº›å­—æ®µå¼‚æ­¥åŠ è½½</li><li>å¯è®¾ç½®å…¨å±€çš„ goroutine æ± å¤§å°</li></ol></li></ol><h1 id="ä½¿ç”¨-PORTAL"><a href="#ä½¿ç”¨-PORTAL" class="headerlink" title="ä½¿ç”¨ PORTAL"></a>ä½¿ç”¨ PORTAL</h1><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰è£…è¯¥åŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get get -u github.com/ifaceless/portal</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ Model ç»“æ„ä½“</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotificationModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">int</span></span><br><span class="line">    Title   <span class="keyword">string</span></span><br><span class="line">    Content <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Fullname</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">        <span class="comment">// åç§°ç”šè‡³å¯ä»¥æ¥è‡ª RPC è°ƒç”¨ç­‰ï¼Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"user:%d"</span>, u.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notifications è¿”å›ç”¨æˆ·å…³è”çš„ä¸€äº›é€šçŸ¥ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *UserModel)</span> <span class="title">Notifications</span><span class="params">()</span> <span class="params">(result []*NotificationModel)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1</span>; i++ &#123;</span><br><span class="line">        result = <span class="built_in">append</span>(result, &amp;NotificationModel&#123;</span><br><span class="line">            ID:      i,</span><br><span class="line">            Title:   fmt.Sprintf(<span class="string">"title_%d"</span>, i),</span><br><span class="line">            Content: fmt.Sprintf(<span class="string">"content_%d"</span>, i),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="keyword">int</span></span><br><span class="line">    UserID <span class="keyword">int</span></span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User è¿”å› Task å…³è”çš„ç”¨æˆ·æ˜¯è°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TaskModel)</span> <span class="title">User</span><span class="params">()</span> *<span class="title">UserModel</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;UserModel&#123;t.UserID&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒæ­¥ï¼šå®šä¹‰ API Schema ç»“æ„ä½“</strong></p><p>ä»¥ä¸‹ Schema åœ¨å®šä¹‰æ—¶ï¼Œéƒ½æ·»åŠ äº† json tagï¼Œå¹¶ä¸”æ ‡è®°ä¸º omitemptyã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œ<strong>å½“æˆ‘ä»¬é€‰æ‹©è¿‡æ»¤æŸäº›å­—æ®µçš„æ—¶å€™ï¼Œportal å°±ä¸ä¼šå¡«å……å¯¹åº”çš„ Schema Fields</strong>ã€‚å› æ­¤ï¼Œæ ‡è®°äº† omitempty çš„å­—æ®µåœ¨ json.Marshal åå°±ä¸ä¼šå‡ºç°ï¼Œä»è€Œè¾¾åˆ°å­—æ®µè¿‡æ»¤çš„ç›®çš„ã€‚ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NotiSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">string</span> <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title   <span class="keyword">string</span> <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Content <span class="keyword">string</span> <span class="string">`json:"content,omitempty"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID                   <span class="keyword">string</span>        <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    <span class="comment">// åç§°æ˜¯ä» User.Fullname() æ–¹æ³•ä¸­è·å–ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º User çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨ `attr` æ ‡è®°</span></span><br><span class="line">    Name                 <span class="keyword">string</span>        <span class="string">`json:"name,omitempty" portal:"attr:Fullname"`</span></span><br><span class="line">        <span class="comment">// nested è¡¨æ˜è¯¥å­—æ®µçš„å€¼æ˜¯ä¸€ä¸ªå¤åˆç±»å‹ï¼Œportal ä¼šè‡ªåŠ¨å°† notifications æ•°æ®å¡«å……åˆ°å¯¹åº”çš„ schema åˆ—è¡¨</span></span><br><span class="line">    Notifications        []*NotiSchema <span class="string">`json:"notifications,omitempty" portal:"nested"`</span></span><br><span class="line">    AnotherNotifications []*NotiSchema <span class="string">`json:"another_notifications,omitempty" portal:"nested;attr:Notifications"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskSchema <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID          <span class="keyword">string</span>      <span class="string">`json:"id,omitempty"`</span></span><br><span class="line">    Title       <span class="keyword">string</span>      <span class="string">`json:"title,omitempty"`</span></span><br><span class="line">    Description <span class="keyword">string</span>      <span class="string">`json:"description,omitempty" portal:"meth:GetDescription"`</span></span><br><span class="line">    <span class="comment">// UserSchema is a nested schema</span></span><br><span class="line">    User        *UserSchema <span class="string">`json:"user,omitempty" portal:"nested"`</span></span><br><span class="line">    <span class="comment">// We just want `Name` field for `SimpleUser`.</span></span><br><span class="line">    <span class="comment">// Besides, the data source is the same with `UserSchema`</span></span><br><span class="line">    SimpleUser  *UserSchema <span class="string">`json:"simple_user,omitempty" portal:"nested;only:Name;attr:User"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetDescription æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•æ¥æä¾›æƒ³è¦çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿”å›ä¸åŒçš„æ–‡æ¡ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TaskSchema)</span> <span class="title">GetDescription</span><span class="params">(model *model.TaskModel)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Custom description"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ­¥ï¼šæŒ‰éœ€åºåˆ—åŒ–</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"github.com/ifaceless/portal"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// log debug info</span></span><br><span class="line">    portal.SetDebug(<span class="literal">true</span>)</span><br><span class="line">    <span class="comment">// set max worker pool size</span></span><br><span class="line">    portal.SetMaxPoolSize(<span class="number">1024</span>)</span><br><span class="line">    <span class="comment">// make sure to clean up.</span></span><br><span class="line">    <span class="keyword">defer</span> portal.CleanUp()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write to a specified task schema</span></span><br><span class="line">    <span class="keyword">var</span> taskSchema schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel)</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","title":"Finish your jobs.","description":"Custom description","user":&#123;"id":"1","name":"user:1","notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;],"another_notifications":[&#123;"id":"0","title":"title_0","content":"content_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// select specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"Title"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// select fields with alias defined in the json tag.</span></span><br><span class="line">    <span class="comment">// actually, the default alias tag is `json`, `portal.FieldAliasMapTagName("json")` is optional.</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"title"</span>, <span class="string">"SimpleUser"</span>), portal.FieldAliasMapTagName(<span class="string">"json"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// you can keep any fields for any nested schemas</span></span><br><span class="line">    <span class="comment">// multiple fields are separated with ','</span></span><br><span class="line">    <span class="comment">// nested fields are wrapped with '[' and ']'</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Only(<span class="string">"ID"</span>, <span class="string">"User[ID,Notifications[ID],AnotherNotifications[Title]]"</span>, <span class="string">"SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"id":"1","user":&#123;"id":"1","notifications":[&#123;"id":"0"&#125;],"another_notifications":[&#123;"title":"title_0"&#125;]&#125;,"simple_user":&#123;"name":"user:1"&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ignore specified fields</span></span><br><span class="line">    portal.Dump(&amp;taskSchema, &amp;taskModel, portal.Exclude(<span class="string">"Description"</span>, <span class="string">"ID"</span>, <span class="string">"User[Name,Notifications[ID,Content],AnotherNotifications], SimpleUser"</span>))</span><br><span class="line">    <span class="comment">// data: &#123;"title":"Finish your jobs.","user":&#123;"id":"1","notifications":[&#123;"title":"title_0"&#125;]&#125;&#125;</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dump multiple tasks</span></span><br><span class="line">    <span class="keyword">var</span> taskSchemas []schema.TaskSchema</span><br><span class="line">    portal.Dump(&amp;taskSchemas, &amp;taskModels, portal.Only(<span class="string">"ID"</span>, <span class="string">"Title"</span>, <span class="string">"User[Name]"</span>))</span><br><span class="line">    <span class="comment">// data: [&#123;"id":"0","title":"Task #1","user":&#123;"name":"user:100"&#125;&#125;,&#123;"id":"1","title":"Task #2","user":&#123;"name":"user:101"&#125;&#125;]</span></span><br><span class="line">    data, _ := json.Marshal(taskSchema)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šä»…ä»…æ˜¯ PORTAL çš„ä¸€äº›ç®€å•åœºæ™¯çš„åº”ç”¨ï¼Œè¯¦ç»†å¯ä»¥æŸ¥çœ‹<a href="https://github.com/iFaceless/portal/blob/master/examples/todo" target="_blank" rel="noopener">å®Œæ•´ç¤ºä¾‹</a>ï¼Œåœ¨<a href="https://github.com/iFaceless/portal/blob/master/USERGUIDE.md" target="_blank" rel="noopener">ä½¿ç”¨æŒ‡å—</a>ä¸­æä¾›äº†ä¸€äº›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ã€‚</p><h1 id="æ ¸å¿ƒ-API"><a href="#æ ¸å¿ƒ-API" class="headerlink" title="æ ¸å¿ƒ API"></a>æ ¸å¿ƒ API</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(opts ...Option)</span> <span class="params">(*Chell, error)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">Dump</span><span class="params">(dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span> <span class="title">error</span> </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">DumpWithContext</span><span class="params">(ctx context.Context, dst, src <span class="keyword">interface</span>&#123;&#125;, opts ...Option)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetDebug</span><span class="params">(v <span class="keyword">bool</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">SetMaxPoolSize</span><span class="params">(size <span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">CleanUp</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h1 id="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"><a href="#å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥" class="headerlink" title="å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥"></a>å…³äºå¹¶å‘åŠ è½½çš„ç­–ç•¥</h1><ul><li>å½“æŸä¸ª Schema ç»“æ„ä½“å­—æ®µæ ‡è®°äº† <code>portal:&quot;async&quot;</code> æ ‡ç­¾æ—¶ä¼šå¼‚æ­¥å¡«å……å­—æ®µå€¼ï¼›</li><li>å½“åºåˆ—åŒ– Schema åˆ—è¡¨æ—¶ï¼Œä¼šåˆ†æ Schema ä¸­æœ‰æ— æ ‡è®°äº† <code>async</code> çš„å­—æ®µï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ä½¿ç”¨å¹¶å‘å¡«å……ç­–ç•¥ï¼›å¦åˆ™åªåœ¨å½“å‰ goroutine ä¸­å®Œæˆåºåˆ—åŒ–ï¼›</li><li>å¯ä»¥åœ¨ Dump æ—¶æ·»åŠ  <code>portal.DisableConcurrency()</code> ç¦ç”¨å¹¶å‘åºåˆ—åŒ–çš„åŠŸèƒ½ã€‚</li></ul><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p><strong>Q: ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€ worker pool å­˜åœ¨ï¼Ÿ</strong><br><strong>A:</strong> è€ƒè™‘åˆ°åœ¨ Web æœåŠ¡ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutine å¤„ç†ã€‚è€Œåœ¨å¤„ç†è¯·æ±‚ä¸­ï¼Œå¦‚æœä¸é™åˆ¶ PORTAL å¹¶å‘åŠ è½½å­—æ®µå€¼æ—¶çš„ goroutine æ•°é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„èµ„æºæ¶ˆè€—é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† ants æ¡†æ¶ã€‚</p><p><strong>Q: æ€§èƒ½ v.s å¼€å‘æ•ˆç‡ï¼Ÿ</strong><br><strong>A:</strong>å…¶å®å¼•å…¥è¿™ç§æ¡†æ¶ï¼ŒåŠ¿å¿…ä¼šå¯¹æ¥å£å¤„ç†æ—¶çš„å†…å­˜å ç”¨ï¼Œå¤„ç†æ€§èƒ½äº§ç”Ÿå½±å“ã€‚å› ä¸ºå†…éƒ¨å®ç°ä¸­ä¹Ÿä¸å¯é¿å…åœ°å¤§é‡ä½¿ç”¨äº†åå°„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½çš„è¯ï¼Œé‚£è¿˜æ˜¯ä¸æ¨èä½¿ç”¨äº†ã€‚å°±æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥è¯´ï¼Œå¾ˆå¤šæ¥å£çš„ QPS å¹¶ä¸é«˜ï¼ˆå°¤å…¶æ˜¯ä¸€äº›åå°æ¥å£ï¼‰ï¼Œä¸ç®¡æ˜¯ CPU è¿˜æ˜¯å†…å­˜èµ„æºéƒ½æ˜¯å……è¶³çš„ã€‚è¿™ä¸ªæ—¶å€™ä½¿ç”¨ PORTAL æ˜¯å¯ä»¥æœ‰æ•ˆæé«˜å¼€å‘æ•ˆç‡çš„ï¼ˆä¸ªäººæ„šè§ï¼‰ï¼Œæ¯•ç«Ÿå¯ä»¥å°‘å†™ä¸€äº›ä»£ç ï¼Œè®©æœºå™¨å¹²äº›è ¢æ´»è„æ´»ã€‚</p><p><strong>Q: å®é™…é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ portal çš„ï¼Ÿæœ‰ä»€ä¹ˆä½“ä¼šï¼Ÿå¸¦æ¥äº†ä»€ä¹ˆæ”¶ç›Šï¼Ÿ</strong><br><strong>A:</strong>å†ç»å°†è¿‘ä¸€ä¸ªæœˆçš„å®é™…é¡¹ç›®å®è·µï¼Œportal ç›®å‰å·²ç»è¶‹äºç¨³å®šï¼Œå¹¶ä¸”ä¿®å¤äº†å¤§é‡é—®é¢˜ï¼Œå‘å¸ƒäº† 22 ä¸ªç‰ˆæœ¬ã€‚ç›®å‰è¯¥å·¥å…·åŒ…åº”åº”ç”¨åœ¨å¤šä¸ªçº¿ä¸ŠæœåŠ¡ä¸­ï¼ˆåŒ…æ‹¬ HTTP RESTful API å’Œ RPC ä¸­ Model åˆ° thrift å®šä¹‰ç±»å‹çš„æ˜ å°„ï¼‰ï¼Œæ•´ä½“æ„Ÿå—å°±æ˜¯å¼€å‘ä½“éªŒæˆå€æé«˜ï¼Œè€Œä¸”å¸¦æ¥äº†æ€§èƒ½å½±å“å¹¶æ²¡æœ‰æœ€å¼€å§‹è®¤ä¸ºçš„é‚£ä¹ˆå¤§ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸ªäººè®¤ä¸ºï¼Œæ¡†æ¶çš„å¼•å…¥æ­£æ˜¯ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œæå‡é¡¹ç›®è´¨é‡çš„ã€‚æ¡†æ¶å±‚çš„æŠ½è±¡å’Œå°è£…å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½åœ¨ä¸šåŠ¡ä»£ç å±‚ç¼–å†™é‡å¤æœºæ¢°å¼çš„ä»£ç ï¼ŒåŒæ—¶èƒ½å¤Ÿä¿è¯ç¼–å†™æ–¹å¼çš„ä¸€è‡´æ€§ï¼Œæå‡é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚<strong>æ‰€è°“çš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿè®¸æ ¹æœ¬ä¸æ˜¯é—®é¢˜ï¼›æ‰€è°“çš„æå‰ä¼˜åŒ–ï¼Œä¹Ÿè®¸åªæ˜¯è¿‡åº¦ä¼˜åŒ–ã€‚</strong>æˆ‘ä»¬åº”è¯¥ç”¨ 20% æ—¶é—´è§£å†³ 80% çš„å¸¸è§„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯é«˜æ•ˆç‡é«˜è´¨é‡çš„é‚£ç§ã€‚è€Œå‰©ä¸‹ 20% çš„éš¾é¢˜ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ«çš„æ–¹æ³•è§£å†³ã€‚åˆ‡å‹¿æœ¬æœ«å€’ç½®ï¼</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;åœ¨æˆ‘ä»¬çš„ Web åç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°†æ•°æ®æºè·å–ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰æ”¾åœ¨ models.go ä¸­ï¼Œä¸ç®¡å…¶å…³è”çš„æ•°æ®æ˜¯æ¥è‡ªäºæ•°æ®åº“ã€Redis è¿˜æ˜¯ RPCï¼Œæ€»ä¹‹éƒ½æ˜¯æ”¶æ•›åœ¨è¿™ä¸€å±‚ä»¥æä¾›æ›´å¥½çš„å¤ç”¨æ€§ã€‚&lt;/p&gt;
&lt;p&gt;è€Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œå¦‚ C ç«¯ HTTP API è¦æ±‚è¿”å›çš„æ•°æ®ï¼Œåˆ™å®šä¹‰å¯¹åº”çš„ Schema structï¼Œä»è€Œèšåˆéœ€è¦çš„æ•°æ®ä¸‹å‘å‡ºå»ã€‚å½“ç„¶ï¼Œå¯¹äº Admin API å’Œ RPC API ä¹Ÿä¼šæ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„ Schema structã€‚ä½†æ˜¯ï¼Œå®ƒä»¬éƒ½ä¼šå¤ç”¨ç›¸åŒçš„ modelsã€‚æƒ³å¿…è¿™äº›åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ“ä½œäº†å§ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Web å¼€å‘" scheme="/categories/Web-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Go" scheme="/tags/Go/"/>
    
      <category term="å¯¹è±¡åºåˆ—åŒ–" scheme="/tags/%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="Web API" scheme="/tags/Web-API/"/>
    
      <category term="portal" scheme="/tags/portal/"/>
    
  </entry>
  
  <entry>
    <title>è®ºæ–‡å­¦ä¹ ä¹‹ Linux è°ƒåº¦å™¨</title>
    <link href="/2019/11/17/guide-to-linux-scheduler/"/>
    <id>/2019/11/17/guide-to-linux-scheduler/</id>
    <published>2019-11-17T15:20:14.000Z</published>
    <updated>2019-11-28T09:55:32.191Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><em>Linux Kernel Development</em> ä¸€ä¹¦ä¸­ï¼Œå…³äº Linux çš„è¿›ç¨‹è°ƒåº¦å™¨å¹¶æ²¡æœ‰è®²è§£çš„å¾ˆæ·±å…¥ï¼Œåªæ˜¯æåˆ°äº† CFS è°ƒåº¦å™¨çš„åŸºæœ¬æ€æƒ³å’Œä¸€äº›å®ç°ç»†èŠ‚ï¼›å¹¶æ²¡æœ‰ Linux æ—©æœŸçš„è°ƒåº¦å™¨ä»‹ç»ï¼Œä»¥åŠæœ€è¿‘è¿™äº›å¹´æ–°å¢çš„åœ¨å†…æ ¸æºç æ ‘å¤–ç»´æŠ¤çš„è°ƒåº¦å™¨æ€æƒ³ã€‚æ‰€ä»¥åœ¨ç»è¿‡ä¸€ç•ªæœå¯»åï¼Œçœ‹åˆ°äº†è¿™ç¯‡è®ºæ–‡ <a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a>ï¼Œå¯¹ Linux çš„è°ƒåº¦å™¨å†å²è¿›è¡Œäº†å›é¡¾ï¼Œå¹¶ä¸”ç›¸å¯¹ç»†è‡´åœ°è®²è§£äº† CFS è°ƒåº¦å™¨ã€‚æ•´ä½“æ¥è¯´ï¼Œè™½ç„¶æ¯”è¾ƒå•°å—¦ï¼Œä½†æ˜¯å¯¹äºæƒ³è¦çŸ¥é“æ›´å¤šç»†èŠ‚çš„æˆ‘æ¥è¯´éå¸¸é€‚åˆï¼Œæ‰€ä»¥å°±æœ‰äº†ç¿»è¯‘å®ƒçš„å†²åŠ¨ã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ è¿‡ç¨‹ä¹Ÿå‚è€ƒäº†å…¶å®ƒè®ºæ–‡ã€‚ä¸‹é¢å¼€å¯å­¦ä¹ ä¹‹æ—…å§~</p><a id="more"></a><p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Linux ä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹éƒ½æ˜¯ç”±åŒä¸€ä¸ªç»“æ„ä½“ï¼ˆtask_structï¼Œå³ä»»åŠ¡æè¿°ç¬¦ï¼‰è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æ–‡ä¸­ä¼šäº¤å‰ä½¿ç”¨è¿›ç¨‹ã€çº¿ç¨‹å’Œä»»åŠ¡ç­‰æœ¯è¯­ï¼Œå¯ä»¥å°†å®ƒä»¬è§†ä½œåŒä¹‰è¯ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ç§°ä¸ºæœ€å°æ‰§è¡Œå•å…ƒã€‚ä½† Linux çš„è°ƒåº¦ç®—æ³•ï¼ˆå¦‚ CFSï¼‰å¯ä»¥åº”ç”¨æ›´åŠ é€šç”¨çš„è°ƒåº¦å•å…ƒï¼ˆå¦‚çº¿ç¨‹ã€cgroupã€ç”¨æˆ·ç­‰ï¼‰ã€‚æ€»ä¹‹ï¼Œä¸è¦è¿‡åº¦çº ç»“è¿™é‡Œçš„æœ¯è¯­ï¼Œé‡è¦çš„æ˜¯äº†è§£æ¯ç§è°ƒåº¦ç®—æ³•çš„æ€æƒ³ï¼</em></p><h1 id="ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦"></a>ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦</h1><p>Linux æ˜¯ä¸€ä¸ªå¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿï¼Œè¿™å°±æ„å‘³ç€å®ƒå¯ä»¥ã€ŒåŒæ—¶ã€æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚åœ¨å•æ ¸å¤„ç†å™¨ä¸Šï¼Œä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰§è¡Œï¼ˆå¹¶å‘ï¼‰ï¼›è€Œåœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œåˆ™å…è®¸ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œã€‚ç„¶è€Œï¼Œä¸ç®¡æ˜¯ä½•ç§ç¡¬ä»¶ç±»å‹çš„æœºå™¨ä¸Šï¼Œå¯èƒ½åŒæ—¶è¿˜æœ‰å¾ˆå¤šåœ¨å†…å­˜ä¸­æ— æ³•å¾—åˆ°æ‰§è¡Œçš„è¿›ç¨‹ï¼Œå®ƒä»¬æ­£åœ¨ç­‰å¾…è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨ç¡çœ ã€‚è´Ÿè´£å°† CPU æ—¶é—´åˆ†é…ç»™è¿›ç¨‹çš„å†…æ ¸ç»„ä»¶å°±æ˜¯ã€Œè¿›ç¨‹è°ƒåº¦å™¨ã€ã€‚</p><p>è°ƒåº¦å™¨è´Ÿè´£ç»´æŠ¤è¿›ç¨‹è°ƒåº¦é¡ºåºï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¦‚åŒå¤šæ•°å…¶å®ƒçš„ç°ä»£æ“ä½œç³»ç»Ÿï¼ŒLinux å®ç°äº†<strong>æŠ¢å å¼</strong>å¤šä»»åŠ¡æœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒåº¦å™¨å¯ä»¥éšæ—¶å†³å®šä»»æ„è¿›ç¨‹åœæ­¢è¿è¡Œï¼Œè€Œè®©å…¶å®ƒè¿›ç¨‹è·å¾— CPU èµ„æºã€‚è¿™ç§è¿èƒŒæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ„æ„¿ï¼Œåœæ­¢å…¶è¿è¡Œçš„è¡Œä¸ºå°±æ˜¯æ‰€è°“çš„ã€ŒæŠ¢å ã€ã€‚æŠ¢å é€šå¸¸å¯ä»¥åœ¨å®šæ—¶å™¨ä¸­æ–­æ—¶å‘ç”Ÿï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢ä»»åŠ¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šå®Œæˆè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¯ä¸ªè¿›ç¨‹æ‰€è·å¾—çš„è¿è¡Œæ—¶é—´å«åš<strong>è¿›ç¨‹çš„æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰</strong>ã€‚</p><p>ä»»åŠ¡é€šå¸¸å¯ä»¥åŒºåˆ†ä¸º<strong>äº¤äº’å¼ï¼ˆI/O å¯†é›†å‹ï¼‰</strong>å’Œ<strong>éäº¤äº’å¼ï¼ˆCPU å¯†é›†å‹ï¼‰</strong>ä»»åŠ¡ã€‚äº¤äº’å¼ä»»åŠ¡é€šå¸¸ä¼šé‡åº¦ä¾èµ– I/O æ“ä½œï¼ˆå¦‚ GUI åº”ç”¨ï¼‰ï¼Œå¹¶ä¸”é€šå¸¸ç”¨ä¸å®Œåˆ†é…ç»™å®ƒçš„æ—¶é—´ç‰‡ã€‚è€Œéäº¤äº’å¼ä»»åŠ¡ï¼ˆå¦‚æ•°å­¦è¿ç®—ï¼‰åˆ™éœ€è¦ä½¿ç”¨æ›´å¤šçš„ CPU èµ„æºã€‚å®ƒä»¬é€šå¸¸ä¼šç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡ä¹‹åè¢«æŠ¢å ï¼Œå¹¶ä¸ä¼šè¢« I/O è¯·æ±‚é¢‘ç¹é˜»å¡ã€‚</p><p>å½“ç„¶ï¼Œç°å®ä¸­çš„åº”ç”¨ç¨‹åºå¯èƒ½åŒæ—¶åŒ…å«ä¸Šè¿°ä¸¤ç§åˆ†ç±»ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ‹¼å†™æ£€æŸ¥æ—¶ä¹Ÿä¼šéœ€è¦å ç”¨å¤§é‡ CPU èµ„æºã€‚</p><p><strong>æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥å°±éœ€è¦å‡è¡¡è¿™ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¿è¯æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¾—åˆ°è¶³å¤Ÿçš„æ‰§è¡Œèµ„æºï¼Œè€Œä¸ä¼šå¯¹å…¶å®ƒä»»åŠ¡äº§ç”Ÿæ˜æ˜¾çš„æ€§èƒ½å½±å“ã€‚</strong> Linux ä¸ºäº†ä¿è¯ CPU åˆ©ç”¨ç‡æœ€å¤§åŒ–ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ›´å¿«çš„å“åº”æ—¶é—´ï¼Œå€¾å‘äºä¸ºéäº¤äº’å¼ä»»åŠ¡åˆ†é…æ›´å¤§çš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯ä»¥è¾ƒä½çš„é¢‘ç‡è¿è¡Œå®ƒä»¬ï¼›è€Œé’ˆå¯¹ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œåˆ™ä¼šåœ¨è¾ƒçŸ­å‘¨æœŸå†…é¢‘ç¹åœ°æ‰§è¡Œã€‚</p><h1 id="è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦"><a href="#è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦" class="headerlink" title="è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦"></a>è°ƒåº¦æœ‰å…³çš„è¿›ç¨‹æè¿°ç¬¦</h1><p>è¿›ç¨‹æè¿°ç¬¦ï¼ˆtask_structï¼‰ä¸­çš„å¾ˆå¤šå­—æ®µä¼šè¢«è°ƒåº¦æœºåˆ¶ç›´æ¥ä½¿ç”¨ã€‚ä»¥ä¸‹ä»…åˆ—å‡ºä¸€äº›æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶åœ¨åæ–‡è¯¦ç»†è®¨è®ºã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> <span class="title">rt</span>;</span></span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> policy;</span><br><span class="line">    <span class="keyword">cpumask_t</span> cpus_allowed;</span><br><span class="line">    â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…³äºè¿™äº›å­—æ®µçš„è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>prio</code> è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿›ç¨‹è¿è¡Œæ—¶é—´ï¼ŒæŠ¢å é¢‘ç‡éƒ½ä¾èµ–äºè¿™äº›å€¼ã€‚<code>rt_priority</code> åˆ™ç”¨äºå®æ—¶ï¼ˆreal-timeï¼‰ä»»åŠ¡ï¼›</li><li><code>sched_class</code> è¡¨ç¤ºè¿›ç¨‹ä½äºå“ªä¸ªè°ƒåº¦ç±»ï¼›</li><li><code>sched_entity</code> çš„æ„ä¹‰æ¯”è¾ƒç‰¹æ®Šã€‚é€šå¸¸æŠŠä¸€ä¸ªçº¿ç¨‹ï¼ˆLinux ä¸­çš„è¿›ç¨‹ã€ä»»åŠ¡åŒä¹‰è¯ï¼‰å«ä½œæœ€å°è°ƒåº¦å•å…ƒã€‚ä½†æ˜¯ Linux è°ƒåº¦å™¨ä¸ä»…ä»…åªèƒ½å¤Ÿè°ƒåº¦å•ä¸ªä»»åŠ¡ï¼Œ<strong>è€Œä¸”è¿˜å¯ä»¥å°†ä¸€ç»„è¿›ç¨‹ï¼Œç”šè‡³å±äºæŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹ä½œä¸ºæ•´ä½“è¿›è¡Œè°ƒåº¦</strong>ã€‚è¿™å°±å…è®¸æˆ‘ä»¬å®ç°ç»„è°ƒåº¦ï¼Œä»è€Œå°† CPU æ—¶é—´å…ˆåˆ†é…åˆ°è¿›ç¨‹ç»„ï¼Œå†åœ¨ç»„å†…åˆ†é…åˆ°å•ä¸ªçº¿ç¨‹ã€‚å½“å¼•å…¥è¿™é¡¹åŠŸèƒ½åï¼Œå¯ä»¥å¤§å¹…åº¦æå‡æ¡Œé¢ç³»ç»Ÿçš„äº¤äº’æ€§ã€‚æ¯”å¦‚ï¼Œå¯ä»¥å°†ç¼–è¯‘ä»»åŠ¡èšé›†æˆä¸€ä¸ªç»„ï¼Œç„¶åè¿›è¡Œè°ƒåº¦ï¼Œä»è€Œä¸ä¼šå¯¹äº¤äº’æ€§äº§ç”Ÿæ˜æ˜¾çš„å½±å“ã€‚è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸‹ï¼Œ**Linux è°ƒåº¦å™¨ä¸ä»…ä»…èƒ½ç›´æ¥è°ƒåº¦è¿›ç¨‹ï¼Œä¹Ÿèƒ½å¯¹è°ƒåº¦å•å…ƒï¼ˆschedulable entitiesï¼‰è¿›è¡Œè°ƒåº¦ã€‚è¿™æ ·çš„è°ƒåº¦å•å…ƒæ­£æ˜¯ç”¨ <code>struct sched_entity</code> æ¥è¡¨ç¤ºçš„ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå®ƒå¹¶éä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥åµŒå¥—åœ¨è¿›ç¨‹æè¿°ç¬¦ä¸­çš„ã€‚å½“ç„¶ï¼Œåé¢çš„è°ˆè®ºå°†èšç„¦åœ¨å•è¿›ç¨‹è°ƒåº¦è¿™ç§ç®€å•åœºæ™¯ã€‚ç”±äºè°ƒåº¦å™¨æ˜¯é¢å‘è°ƒåº¦å•å…ƒè®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒä¼šå°†å•ä¸ªè¿›ç¨‹ä¹Ÿè§†ä¸ºè°ƒåº¦å•å…ƒï¼Œå› æ­¤ä¼šä½¿ç”¨ <code>sched_entity</code> ç»“æ„ä½“æ“ä½œå®ƒä»¬ã€‚<code>sched_rt_entity</code> åˆ™æ˜¯å®æ—¶è°ƒåº¦æ—¶ä½¿ç”¨çš„ã€‚</li><li><code>policy</code> è¡¨æ˜ä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼šé€šå¸¸æ„å‘³ç€é’ˆå¯¹æŸäº›ç‰¹å®šçš„è¿›ç¨‹ç»„ï¼ˆå¦‚éœ€è¦æ›´é•¿æ—¶é—´ç‰‡ï¼Œæ›´é«˜ä¼˜å…ˆçº§ç­‰ï¼‰åº”ç”¨ç‰¹æ®Šçš„è°ƒåº¦å†³ç­–ã€‚Linux å†…æ ¸ç›®å‰æ”¯æŒçš„è°ƒåº¦ç­–ç•¥å¦‚ä¸‹ï¼š<ul><li><code>SCHED_NORMAL</code>ï¼šæ™®é€šä»»åŠ¡ä½¿ç”¨çš„è°ƒåº¦ç­–ç•¥ï¼›</li><li><code>SCHED_BATCH</code>ï¼šä¸åƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œå¯å…è®¸ä»»åŠ¡è¿è¡Œå°½å¯èƒ½é•¿çš„æ—¶é—´ï¼Œä»è€Œæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ï¼Œä½†æ˜¯ä»£ä»·è‡ªç„¶æ˜¯æŸå¤±äº¤äº’æ€§èƒ½ã€‚è¿™ç§éå¸¸é€‚åˆæ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼ˆæ‰¹é‡çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼‰;</li><li><code>SCHED_IDLE</code>ï¼šå®ƒè¦æ¯” nice 19 çš„ä»»åŠ¡ä¼˜å…ˆçº§è¿˜è¦ä½ï¼Œä½†å®ƒå¹¶éçœŸçš„ç©ºé—²ä»»åŠ¡;</li><li><code>SCHED_FIFO</code> å’Œ <code>SCHED_RR</code> æ˜¯è½¯å®æ—¶è¿›ç¨‹è°ƒåº¦ç­–ç•¥ã€‚å®ƒä»¬æ˜¯ç”± POSIX æ ‡å‡†å®šä¹‰çš„ï¼Œç”± <code>&lt;kernel/sched/rt.c&gt;</code> é‡Œé¢å®šä¹‰çš„å®æ—¶è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ã€‚RR å®ç°çš„æ˜¯å¸¦æœ‰å›ºå®šæ—¶é—´ç‰‡çš„è½®è½¬è°ƒåº¦æ–¹å¼ï¼›SCHED_FIFO åˆ™ä½¿ç”¨çš„æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æœºåˆ¶ã€‚</li></ul></li><li><code>cpus_allowed</code>ï¼šç”¨æ¥è¡¨ç¤ºä»»åŠ¡çš„ CPU äº²å’Œæ€§ã€‚ç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡ <code>sched_setaffinity</code> ç³»ç»Ÿè°ƒç”¨æ¥è®¾ç½®ã€‚</li></ul><h1 id="ä¼˜å…ˆçº§-Priority"><a href="#ä¼˜å…ˆçº§-Priority" class="headerlink" title="ä¼˜å…ˆçº§ Priority"></a>ä¼˜å…ˆçº§ Priority</h1><h2 id="è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="è¿›ç¨‹ä¼˜å…ˆçº§"></a>è¿›ç¨‹ä¼˜å…ˆçº§</h2><h3 id="æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§"><a href="#æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§" class="headerlink" title="æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§"></a>æ™®é€šä»»åŠ¡ä¼˜å…ˆçº§</h3><p>æ‰€æœ‰çš„ç±» Unix æ“ä½œç³»ç»Ÿéƒ½å®ç°äº†ä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªå€¼ï¼Œç„¶åé€šè¿‡è¯¥å€¼å†³å®šä»»åŠ¡çš„é‡è¦ç¨‹åº¦ã€‚å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸€è‡´ï¼Œåˆ™ä¸€æ¬¡é‡å¤è¿è¡Œå®ƒä»¬ã€‚åœ¨ Linux ä¸­ï¼Œæ¯ä¸€ä¸ªæ™®é€šä»»åŠ¡éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ª nice å€¼ï¼Œå®ƒçš„èŒƒå›´æ˜¯ -20 åˆ° +19ï¼Œä»»åŠ¡é»˜è®¤ nice å€¼æ˜¯ 0ã€‚<br><img src="https://pic1.zhimg.com/v2-665ed41d133e9e332c4fdc6034240cb5.jpg" alt=""></p><p>nice å€¼è¶Šé«˜ï¼Œä»»åŠ¡ä¼˜å…ˆçº§è¶Šä½ï¼ˆitâ€™s nice to othersï¼‰ã€‚Linux ä¸­å¯ä»¥ä½¿ç”¨ <code>nice(int increment)</code> ç³»ç»Ÿè°ƒç”¨æ¥ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨çš„å®ç°ä½äº <code>&lt;kernel/shced/core.c&gt;</code> ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åªèƒ½ä¸ºè¯¥ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹å¢åŠ  nice å€¼ï¼ˆå³é™ä½ä¼˜å…ˆçº§ï¼‰ã€‚å¦‚æœéœ€è¦å¢åŠ ä¼˜å…ˆçº§ï¼ˆå‡å°‘ nice å€¼ï¼‰ï¼Œæˆ–è€…ä¿®æ”¹å…¶å®ƒç”¨æˆ·è¿›ç¨‹ä¼˜å…ˆçº§ï¼Œåˆ™å¿…é¡»ä»¥ root èº«ä»½æ“ä½œã€‚</p><h3 id="å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§"><a href="#å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§" class="headerlink" title="å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§"></a>å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§</h3><p>åœ¨ Linux ä¸­ï¼Œé™¤äº†æ™®é€šä»»åŠ¡å¤–ï¼Œè¿˜æœ‰ä¸€ç±»ä»»åŠ¡å±äºå®æ—¶ä»»åŠ¡ã€‚å®æ—¶ä»»åŠ¡æ˜¯ç¡®ä¿å®ƒä»¬èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæœ‰ä¸¤ç±»å®æ—¶ä»»åŠ¡ï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š</p><ul><li><strong>ç¡¬å®æ—¶ä»»åŠ¡</strong>ï¼šä¼šæœ‰ä¸¥æ ¼çš„æ—¶é—´é™åˆ¶ï¼Œä»»åŠ¡å¿…é¡»åœ¨æ—¶é™å†…å®Œæˆã€‚æ¯”å¦‚ç›´å‡æœºçš„é£æ§ç³»ç»Ÿï¼Œå°±éœ€è¦åŠæ—¶å“åº”é©¾é©¶å‘˜çš„æ“æ§ï¼Œå¹¶åšå‡ºé¢„æœŸçš„åŠ¨ä½œã€‚ç„¶è€Œï¼ŒLinux æœ¬èº«å¹¶ä¸æ”¯æŒç¡¬å®æ—¶ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰ä¸€äº›åŸºäºå®ƒä¿®æ”¹çš„ç‰ˆæœ¬ï¼Œå¦‚ RTLinuxï¼ˆå®ƒä»¬é€šå¸¸è¢«ç§°ä¸º RTOSï¼‰åˆ™æ˜¯æ”¯æŒç¡¬å®æ—¶è°ƒåº¦çš„ã€‚</li><li><strong>è½¯å®æ—¶ä»»åŠ¡</strong>ï¼šè½¯å®æ—¶ä»»åŠ¡å…¶å®ä¹Ÿä¼šæœ‰æ—¶é—´é™åˆ¶ï¼Œä½†ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»åŠ¡æ™šä¸€ç‚¹è¿è¡Œä»»åŠ¡ï¼Œå¹¶ä¸ä¼šé€ æˆä¸å¯æŒ½å›çš„ç¾éš¾æ€§äº‹æ•…ã€‚å®è·µä¸­ï¼Œè½¯å®æ—¶ä»»åŠ¡ä¼šæä¾›ä¸€å®šçš„æ—¶é—´é™åˆ¶ä¿éšœï¼Œä½†æ˜¯ä¸è¦è¿‡åº¦ä¾èµ–è¿™ç§ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼ŒVOIP è½¯ä»¶ä¼šä½¿ç”¨è½¯å®æ—¶ä¿éšœçš„åè®®ä¼ æ¥é€éŸ³è§†é¢‘ä¿¡å·ï¼Œä½†æ˜¯å³ä¾¿å› ä¸ºæ“ä½œç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œè€Œäº§ç”Ÿä¸€ç‚¹å»¶è¿Ÿï¼Œä¹Ÿä¸ä¼šé€ æˆå¾ˆå¤§å½±å“ã€‚<strong>æ— è®ºå¦‚ä½•ï¼Œè½¯å®æ—¶ä»»åŠ¡æ€»ä¼šæ¯”æ™®é€šä»»åŠ¡çš„ä¼˜å…ˆçº§æ›´é«˜</strong>ã€‚</li></ul><p>Linux ä¸­å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§èŒƒå›´æ˜¯ 0~99ï¼Œä½†æ˜¯æœ‰è¶£çš„æ˜¯ï¼Œå®ƒå’Œ nice å€¼çš„ä½œç”¨åˆšå¥½ç›¸åï¼Œè¿™é‡Œçš„ä¼˜å…ˆçº§å€¼è¶Šå¤§ï¼Œå°±æ„å‘³ç€ä¼˜å…ˆçº§è¶Šé«˜ã€‚<br><img src="https://pic4.zhimg.com/v2-d5299a6846bcb492ec3340f1a725b323.jpg" alt=""></p><p>ç±»ä¼¼å…¶å®ƒçš„ Unix ç³»ç»Ÿï¼ŒLinux ä¹Ÿæ˜¯åŸºäº POSIX 1b æ ‡å‡†å®šä¹‰çš„ ã€ŒReal-time Extensionsã€å®ç°å®æ—¶ä¼˜å…ˆçº§ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿä¸­çš„å®æ—¶ä»»åŠ¡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ps -eo pid, rtprio, cmd</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯é€šè¿‡ <code>chrt -p pid</code> æŸ¥çœ‹å•ä¸ªè¿›ç¨‹çš„è¯¦æƒ…ã€‚Linux ä¸­å¯ä»¥é€šè¿‡ <code>chrt -p prio pid</code> æ›´æ”¹å®æ—¶ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ“ä½œçš„æ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼ˆé€šå¸¸å¹¶ä¸ä¼šå°†æ™®é€šç”¨æˆ·çš„è¿›ç¨‹è®¾ç½®ä¸ºå®æ—¶çš„ï¼‰ï¼Œåˆ™å¿…é¡»æœ‰ root æƒé™æ‰å¯ä»¥ä¿®æ”¹å®æ—¶ä¼˜å…ˆçº§ã€‚</p><h2 id="å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§"></a>å†…æ ¸è§†è§’ä¸‹çš„è¿›ç¨‹ä¼˜å…ˆçº§</h2><p>å®æ—¶ä¸Šï¼Œå†…æ ¸çœ‹åˆ°çš„ä»»åŠ¡ä¼˜å…ˆçº§å’Œç”¨æˆ·çœ‹åˆ°çš„å¹¶ä¸ç›¸åŒï¼Œåœ¨è®¡ç®—å’Œç®¡ç†ä¼˜å…ˆçº§æ—¶ä¹Ÿéœ€è¦è€ƒè™‘å¾ˆå¤šæ–¹é¢ã€‚Linux å†…æ ¸ä¸­ä½¿ç”¨ 0~139 è¡¨ç¤ºä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”ï¼Œ<strong>å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong>ï¼ˆæ³¨æ„å’Œç”¨æˆ·ç©ºé—´çš„åŒºåˆ«ï¼‰ã€‚å…¶ä¸­ 0~99 ä¿ç•™ç»™å®æ—¶è¿›ç¨‹ï¼Œ100~139ï¼ˆæ˜ å°„æˆ nice å€¼å°±æ˜¯ -20~19ï¼‰ä¿ç•™ç»™æ™®é€šè¿›ç¨‹ã€‚<br><img src="https://pic2.zhimg.com/v2-4d4d4645d2dc1a52bbea516e8d82171b.jpg" alt=""></p><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>&lt;include/linux/sched/prio.h&gt;</code> å¤´æ–‡ä»¶ä¸­çœ‹åˆ°å†…æ ¸è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§çš„å•ä½ï¼ˆscaleï¼‰å’Œå®å®šä¹‰ï¼ˆmacrosï¼‰ï¼Œå®ƒä»¬ç”¨æ¥å°†ç”¨æˆ·ç©ºé—´ä¼˜å…ˆçº§æ˜ å°„åˆ°åˆ°å†…æ ¸ç©ºé—´ã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_NICE 19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_NICE -20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_WIDTH (MAX_NICE - MIN_NICE + 1)</span></span><br><span class="line">â€¦</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_RT_PRIO 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_RT_PRIO MAX_USER_RT_PRIO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PRIO (MAX_RT_PRIO + NICE_WIDTH)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_PRIO (MAX_RT_PRIO + NICE_WIDTH / 2)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Convert user-nice values [ -20 ... 0 ... 19 ]</span></span><br><span class="line"><span class="comment">* to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],</span></span><br><span class="line"><span class="comment">* and back.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NICE_TO_PRIO(nice) ((nice) + DEFAULT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIO_TO_NICE(prio) ((prio) - DEFAULT_PRIO)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 'User priority' is the nice value converted to something we</span></span><br><span class="line"><span class="comment">* can work with better when scaling various scheduler parameters,</span></span><br><span class="line"><span class="comment">* it's a [ 0 ... 39 ] range.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_PRIO(p) ((p)-MAX_RT_PRIO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_USER_PRIO(p) USER_PRIO((p)-&gt;static_prio)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_USER_PRIO (USER_PRIO(MAX_PRIO))</span></span><br></pre></td></tr></table></figure></p><h2 id="ä¼˜å…ˆçº§è®¡ç®—"><a href="#ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="ä¼˜å…ˆçº§è®¡ç®—"></a>ä¼˜å…ˆçº§è®¡ç®—</h2><p>åœ¨ <code>task_struct</code> ä¸­æœ‰å‡ ä¸ªå­—æ®µç”¨æ¥è¡¨ç¤ºè¿›ç¨‹ä¼˜å…ˆçº§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> prio, static_prio, normal_prio;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rt_priority;</span><br></pre></td></tr></table></figure></p><p><code>static_prio</code> æ˜¯ç”±ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾å®šçš„ã€Œé™æ€ã€ä¼˜å…ˆçº§æ˜ å°„æˆå†…æ ¸è¡¨ç¤ºçš„ä¼˜å…ˆçº§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;static_prio = NICE_TO_PRIO(nice_value);</span><br></pre></td></tr></table></figure></p><p><code>normal_prio</code> å­˜æ”¾çš„æ˜¯åŸºäº <code>static_prio</code> å’Œè¿›ç¨‹è°ƒåº¦ç­–ç•¥ï¼ˆå®æ—¶æˆ–æ™®é€šï¼‰å†³å®šçš„ä¼˜å…ˆçº§ï¼Œç›¸åŒçš„é™æ€ä¼˜å…ˆçº§ï¼Œåœ¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥ä¸‹ï¼Œå¾—åˆ°çš„æ­£å¸¸ä¼˜å…ˆçº§æ˜¯ä¸åŒçš„ã€‚å­è¿›ç¨‹åœ¨ fork æ—¶ï¼Œä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ <code>normal_prio</code>ã€‚</p><p><code>prio</code> åˆ™æ˜¯ã€ŒåŠ¨æ€ä¼˜å…ˆçº§ã€ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ä¼˜å…ˆçº§ä¼šå‘ç”Ÿå˜åŠ¨ã€‚ä¸€ç§åœºæ™¯å°±æ˜¯ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡ç»™æŸä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡ä¸€æ®µæ—¶é—´ï¼Œä»è€ŒæŠ¢å å…¶å®ƒé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¸€æ—¦ <code>static_prio</code> ç¡®å®šï¼Œ<code>prio</code> å­—æ®µå°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¡ç®—ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;prio = effective_prio(p);</span><br><span class="line"><span class="comment">// kernel/sched/core.c ä¸­å®šä¹‰äº†è®¡ç®—æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">effective_prio</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p-&gt;normal_prio = normal_prio(p);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If we are RT tasks or we were boosted to RT priority,</span></span><br><span class="line"><span class="comment">    * keep the priority unchanged. Otherwise, update priority</span></span><br><span class="line"><span class="comment">    * to the normal priority:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!rt_prio(p-&gt;prio))</span><br><span class="line">        <span class="keyword">return</span> p-&gt;normal_prio;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;prio;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">normal_prio</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> prio;</span><br><span class="line">    <span class="keyword">if</span> (task_has_dl_policy(p))</span><br><span class="line">        prio = MAX_DL_PRIO<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (task_has_rt_policy(p))</span><br><span class="line">        prio = MAX_RT_PRIO<span class="number">-1</span> - p-&gt;rt_priority;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        prio = __normal_prio(p);</span><br><span class="line">    <span class="keyword">return</span> prio;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> __normal_prio(struct task_struct *p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;static_prio;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="è´Ÿè½½æƒé‡ï¼ˆLoad-Weightsï¼‰"><a href="#è´Ÿè½½æƒé‡ï¼ˆLoad-Weightsï¼‰" class="headerlink" title="è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰"></a>è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰</h2><p>ä¼˜å…ˆçº§ä¼šè®©ä¸€äº›ä»»åŠ¡æ¯”åˆ«çš„ä»»åŠ¡æ›´é‡è¦ï¼Œå› æ­¤ä¹Ÿä¼šè·å¾—æ›´å¤šçš„ CPU ä½¿ç”¨æ—¶é—´ã€‚nice å€¼å’Œæ—¶é—´ç‰‡çš„æ¯”ä¾‹å…³ç³»æ˜¯é€šè¿‡è´Ÿè½½æƒé‡ï¼ˆLoad Weightsï¼‰è¿›è¡Œç»´æŠ¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>task_struct-&gt;se.load</code> ä¸­çœ‹åˆ°è¿›ç¨‹çš„æƒé‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span> <span class="comment">/* for load-balancing */</span></span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> weight;</span><br><span class="line">    u32 inv_weight;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†è®© nice å€¼çš„å˜åŒ–åæ˜ åˆ° CPU æ—¶é—´å˜åŒ–ç‰‡ä¸Šæ›´åŠ åˆç†ï¼ŒLinux å†…æ ¸ä¸­å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºæ˜ å°„ nice å€¼åˆ°æƒé‡ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> prio_to_weight[<span class="number">40</span>] = &#123;</span><br><span class="line">    <span class="comment">/* -20 */</span> <span class="number">88761</span>, <span class="number">71755</span>, <span class="number">56483</span>, <span class="number">46273</span>, <span class="number">36291</span>,</span><br><span class="line">    <span class="comment">/* -15 */</span> <span class="number">29154</span>, <span class="number">23254</span>, <span class="number">18705</span>, <span class="number">14949</span>, <span class="number">11916</span>,</span><br><span class="line">    <span class="comment">/* -10 */</span> <span class="number">9548</span>, <span class="number">7620</span>, <span class="number">6100</span>, <span class="number">4904</span>, <span class="number">3906</span>,</span><br><span class="line">    <span class="comment">/* -5 */</span> <span class="number">3121</span>, <span class="number">2501</span>, <span class="number">1991</span>, <span class="number">1586</span>, <span class="number">1277</span>,</span><br><span class="line">    <span class="comment">/* 0 */</span> <span class="number">1024</span>, <span class="number">820</span>, <span class="number">655</span>, <span class="number">526</span>, <span class="number">423</span>,</span><br><span class="line">    <span class="comment">/* 5 */</span> <span class="number">335</span>, <span class="number">272</span>, <span class="number">215</span>, <span class="number">172</span>, <span class="number">137</span>,</span><br><span class="line">    <span class="comment">/* 10 */</span> <span class="number">110</span>, <span class="number">87</span>, <span class="number">70</span>, <span class="number">56</span>, <span class="number">45</span>,</span><br><span class="line">    <span class="comment">/* 15 */</span> <span class="number">36</span>, <span class="number">29</span>, <span class="number">23</span>, <span class="number">18</span>, <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ä¸Šé¢çš„æ˜ å°„è¡¨ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªä¼˜å…ˆçº§éƒ½æ˜¯ 0 çš„ä»»åŠ¡ï¼Œæ¯ä¸ªéƒ½èƒ½è·å¾— 50% çš„ CPU æ—¶é—´ï¼ˆ1024 / (1024 + 1024) = 0.5ï¼‰ã€‚å¦‚æœçªç„¶ç»™å…¶ä¸­çš„ä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§æå‡äº† 1 ï¼ˆnice å€¼ -1ï¼‰ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªä»»åŠ¡åº”è¯¥ä¼šè·å¾—é¢å¤– 10% å·¦å³çš„ CPU æ—¶é—´ï¼Œè€Œå¦ä¸€ä¸ªåˆ™ä¼šå‡å°‘ 10% CPU æ—¶é—´ã€‚æ¥çœ‹çœ‹è®¡ç®—ç»“æœï¼š1277 / (1024 + 1277) â‰ˆ 0.55ï¼Œ1024 / (1024 + 1277) â‰ˆ 0.45ï¼ŒäºŒè€…å·®è·åˆšå¥½åœ¨ 10% å·¦å³ï¼Œç¬¦åˆé¢„æœŸã€‚å®Œæ•´çš„è®¡ç®—å‡½æ•°å®šä¹‰åœ¨ <code>&lt;kernel/sched/core.c&gt;</code> ä¸­ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set_load_weight</span><span class="params">(struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> prio = p-&gt;static_prio - MAX_RT_PRIO;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> *<span class="title">load</span> = &amp;<span class="title">p</span>-&gt;<span class="title">se</span>.<span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * SCHED_IDLE tasks get minimal weight:</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;policy == SCHED_IDLE) &#123;</span><br><span class="line">        load-&gt;weight = scale_load(WEIGHT_IDLEPRIO);</span><br><span class="line">        load-&gt;inv_weight = WMULT_IDLEPRIO;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    load-&gt;weight = scale_load(prio_to_weight[prio]);</span><br><span class="line">    load-&gt;inv_weight = prio_to_wmult[prio];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="è°ƒåº¦ç±»-Scheduling-Classes"><a href="#è°ƒåº¦ç±»-Scheduling-Classes" class="headerlink" title="è°ƒåº¦ç±» Scheduling Classes"></a>è°ƒåº¦ç±» Scheduling Classes</h1><p>è™½è¯´ Linux å†…æ ¸ä½¿ç”¨çš„ C è¯­è¨€å¹¶éæ‰€è°“çš„ OOP è¯­è¨€ï¼ˆæ²¡æœ‰ç±»ä¼¼ C++/Java ä¸­çš„ class æ¦‚å¿µï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ä»£ç ä¸­çœ‹åˆ°ä¸€äº›ä½¿ç”¨ C è¯­è¨€ç»“æ„ä½“ + å‡½æ•°æŒ‡é’ˆï¼ˆHooksï¼‰çš„æ–¹å¼æ¥æ¨¡æ‹Ÿé¢å‘å¯¹è±¡çš„æ–¹å¼ï¼ŒæŠ½è±¡è¡Œä¸ºå’Œæ•°æ®ã€‚è°ƒåº¦ç±»ä¹Ÿæ˜¯è¿™æ ·å®ç°çš„ï¼ˆæ­¤å¤–ï¼Œè¿˜æœ‰ <code>inode_operations</code>, <code>super_block_operations</code> ç­‰ï¼‰ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;kernel/shced/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆå¦‚ SMP ç›¸å…³çš„ï¼‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> &#123;</span></span><br><span class="line">    <span class="comment">// å¤šä¸ª sched_class æ˜¯é“¾æ¥åœ¨ä¸€èµ·çš„</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†è°ƒåº¦å•å…ƒï¼ˆå¦‚ä¸€ä¸ªä»»åŠ¡ï¼‰æ”¾åˆ°</span></span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶é€’å¢ `nr_running` å˜é‡ï¼ˆè¯¥å˜é‡è¡¨ç¤ºè¿è¡Œé˜Ÿåˆ—ä¸­å¯è¿è¡Œçš„ä»»åŠ¡æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">void</span> (*enqueue_task) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¸å¯è¿è¡Œæ—¶è°ƒç”¨ã€‚å®ƒä¼šå°†ä»»åŠ¡ç§»å‡ºé˜Ÿåˆ—ï¼ŒåŒæ—¶é€’å‡ `nr_running`</span></span><br><span class="line">    <span class="keyword">void</span> (*dequeue_task) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook å¯ä»¥åœ¨ä»»åŠ¡éœ€è¦ä¸»åŠ¨æ”¾å¼ƒ CPU æ—¶è°ƒç”¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä¸ä¼šæ”¹å˜</span></span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„å¯è¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ä¾ç„¶ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ã€‚ç±»ä¼¼äºå…ˆ dequeue_taskï¼Œ</span></span><br><span class="line">    <span class="comment">// å† enqueue_task</span></span><br><span class="line">    <span class="keyword">void</span> (*yield_task) (struct rq *rq);</span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡è¿›å…¥å¯è¿è¡ŒçŠ¶æ€æ—¶è°ƒç”¨å¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> (*check_preempt_curr) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="comment">// è¯¥ hook ç”¨æ¥é€‰æ‹©æœ€é€‚åˆè¿è¡Œçš„ä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * (*<span class="title">pick_next_task</span>) (<span class="title">struct</span> <span class="title">rq</span> *<span class="title">rq</span>, <span class="title">struct</span> <span class="title">task_struct</span> *<span class="title">prev</span>);</span></span><br><span class="line">    <span class="comment">// è¯¥ hook ä¼šåœ¨ä»»åŠ¡ä¿®æ”¹è‡ªèº«çš„è°ƒåº¦ç±»æˆ–è€…ä»»åŠ¡ç»„æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> (*set_curr_task) (struct rq *rq);</span><br><span class="line">    <span class="comment">// é€šå¸¸æ˜¯åœ¨æ—¶é’Ÿä¸­æ–­æ—¶è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»»åŠ¡åˆ‡æ¢</span></span><br><span class="line">    <span class="keyword">void</span> (*task_tick) (struct rq *rq, struct task_struct *p, <span class="keyword">int</span> queued);</span><br><span class="line">    <span class="comment">// å½“ä»»åŠ¡è¢« fork æ—¶é€šçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">void</span> (*task_fork) (struct task_struct *p);</span><br><span class="line">    <span class="comment">// å½“ä»»åŠ¡æŒ‚æ‰æ—¶é€šçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="keyword">void</span> (*task_dead) (struct task_struct *p);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…³äºè°ƒåº¦ç­–ç•¥çš„å…·ä½“ç»†èŠ‚çš„å®ç°æœ‰å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p><ul><li><code>core.c</code> åŒ…å«è°ƒåº¦å™¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼›</li><li><code>fair.c</code> å®ç°äº† CFSï¼ˆComple Faire Schedulerï¼Œå®Œå…¨å…¬å¹³ä»»åŠ¡è°ƒåº¦å™¨ï¼‰ è°ƒåº¦å™¨ï¼Œåº”ç”¨äºæ™®é€šä»»åŠ¡ï¼›</li><li><code>rt.c</code> å®ç°äº†å®æ—¶è°ƒåº¦ï¼Œåº”ç”¨äºå®æ—¶ä»»åŠ¡ï¼›</li><li><code>idle_task.c</code> å½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œçš„ä»»åŠ¡æ—¶ï¼Œä¼šè¿è¡Œç©ºé—²ä»»åŠ¡ã€‚<br>å†…æ ¸æ˜¯åŸºäºä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼ˆSCHED_*ï¼‰æ¥å†³å®šä½¿ç”¨ä½•ç§è°ƒåº¦ç±»å®ç°ï¼Œå¹¶ä¼šè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚<code>SCHED_NORMAL</code>, <code>SCHED_BATCH</code> å’Œ <code>SCHED_IDLE</code> è¿›ç¨‹ä¼šæ˜ å°„åˆ° <code>fair_sched_class</code> ï¼ˆç”± CFS å®ç°ï¼‰ï¼›<code>SCHED_RR</code> å’Œ <code>SCHED_FIFO</code> åˆ™æ˜ å°„çš„ <code>rt_sched_class</code> ï¼ˆå®æ—¶è°ƒåº¦å™¨ï¼‰ã€‚</li></ul><h1 id="è¿è¡Œé˜Ÿåˆ—-Run-Queue"><a href="#è¿è¡Œé˜Ÿåˆ—-Run-Queue" class="headerlink" title="è¿è¡Œé˜Ÿåˆ— Run Queue"></a>è¿è¡Œé˜Ÿåˆ— Run Queue</h1><p>æ‰€æœ‰å¯è¿è¡Œçš„ä»»åŠ¡æ˜¯æ”¾åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­çš„ï¼Œå¹¶ä¸”ç­‰å¾… CPU è¿è¡Œã€‚æ¯ä¸ª CPU æ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„è¿è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡ä»»æ„æ—¶åˆ»åªèƒ½å¤„äºå…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åœ¨å¤šå¤„ç†å™¨æœºå™¨ä¸­ï¼Œä¼šæœ‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»»åŠ¡å°±ä¼šè½¬ç§»åˆ°å…¶å®ƒ CPU ä¸Šè¿è¡Œçš„å¯èƒ½ã€‚</p><p>è¿è¡Œé˜Ÿåˆ—æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;kernel/sched/sched.h&gt;</code>ï¼‰:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºäº†ç®€å•èµ·è§ï¼Œéšè—äº†éƒ¨åˆ†ä»£ç ï¼ˆSMP ç›¸å…³ï¼‰</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ˜¯æ¯ä¸ª CPU éƒ½ä¼šæœ‰çš„ä¸€ä¸ªä»»åŠ¡è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰é˜Ÿåˆ—ä¸­æ€»å…±æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆåŒ…å«æ‰€æœ‰çš„ sched classï¼‰</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_running;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_LOAD_IDX_MAX 5</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cpu_load[CPU_LOAD_IDX_MAX];</span><br><span class="line">    <span class="comment">// è¿è¡Œé˜Ÿåˆ—è´Ÿè½½è®°å½•</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">// åµŒå¥—çš„ CFS è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span> <span class="title">cfs</span>;</span></span><br><span class="line">    <span class="comment">// åµŒå¥—çš„å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨è¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> <span class="title">rt</span>;</span></span><br><span class="line">    <span class="comment">// curr æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æè¿°ç¬¦</span></span><br><span class="line">    <span class="comment">// idle åˆ™æŒ‡å‘ç©ºé—²è¿›ç¨‹æè¿°ç¬¦ï¼ˆå½“æ²¡æœ‰å…¶å®ƒå¯è¿è¡Œä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šå¯åŠ¨ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">curr</span>, *<span class="title">idle</span>;</span></span><br><span class="line">    u64 clock;</span><br><span class="line">    <span class="keyword">int</span> cpu;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ"><a href="#ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ" class="headerlink" title="ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ"></a>ä½•æ—¶è¿è¡Œè°ƒåº¦å™¨ï¼Ÿ</h1><p>å®æ—¶ä¸Šï¼Œè°ƒåº¦å‡½æ•° <code>schedule()</code> ä¼šåœ¨å¾ˆå¤šåœºæ™¯ä¸‹è¢«è°ƒç”¨ã€‚æœ‰çš„æ˜¯ç›´æ¥è°ƒç”¨ï¼Œæœ‰çš„åˆ™æ˜¯éšå¼è°ƒç”¨ï¼ˆé€šè¿‡è®¾ç½® <code>TIF_NEED_RESCHED</code> æ¥æç¤ºæ“ä½œç³»ç»Ÿå°½å¿«è¿è¡Œè°ƒåº¦å‡½æ•°ï¼‰ã€‚ä»¥ä¸‹ä¸‰ä¸ªè°ƒåº¦æ—¶æœºå€¼å¾—å…³æ³¨ä¸‹ï¼š</p><ul><li><p><strong>æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨ <code>scheduler_tick()</code> å‡½æ•°</strong>ï¼Œè¯¥å‡½æ•°ä¼šæ›´æ–°ä¸€äº›å’Œè°ƒåº¦æœ‰å…³çš„æ•°æ®ç»Ÿè®¡ï¼Œå¹¶è§¦å‘è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦æ–¹æ³•ï¼Œä»è€Œé—´æ¥åœ°è¿›è¡Œè°ƒåº¦ã€‚ä»¥ 2.6.39 æºç ä¸ºä¾‹ï¼Œå¯èƒ½çš„è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scheduler_tick</span><br><span class="line">â””â”€â”€ task_tick</span><br><span class="line">    â””â”€â”€ entity_tick</span><br><span class="line">        â””â”€â”€ check_preempt_tick</span><br><span class="line">            â””â”€â”€ resched_task</span><br><span class="line">                â””â”€â”€ set_tsk_need_resched</span><br></pre></td></tr></table></figure></li><li><p><strong>å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è¿›å…¥ç¡çœ çŠ¶æ€</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡ä¼šä¸»åŠ¨é‡Šæ”¾ CPUã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥ä»»åŠ¡ä¼šå› ä¸ºç­‰å¾…æŒ‡å®šçš„äº‹ä»¶è€Œç¡çœ ï¼Œå®ƒå¯ä»¥å°†è‡ªå·±æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨å¾ªç¯æ£€æŸ¥æœŸæœ›çš„æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚åœ¨è¿›å…¥ç¡çœ å‰ï¼Œä»»åŠ¡å¯ä»¥å°†è‡ªå·±çš„çŠ¶æ€è®¾ç½®ä¸º <code>TASK_INTERRUPTABLE</code>ï¼ˆé™¤äº†ä»»åŠ¡è¦ç­‰å¾…çš„äº‹ä»¶å¯å”¤é†’å¤–ï¼Œä¹Ÿå¯ä»¥è¢«ä¿¡å·å”¤é†’ï¼‰æˆ–è€… <code>TASK_UNINTERRUPTABLE</code>ï¼ˆè‡ªç„¶æ˜¯ä¸ä¼šç†ä¼šä¿¡å·å’¯ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>schedule()</code> é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡è¿è¡Œã€‚</p></li><li><p><strong>ç¡çœ çš„ä»»åŠ¡è¢«å”¤é†’</strong>ã€‚ä»»åŠ¡ç­‰å¾…çš„äº‹ä»¶å¯ä»¥åœ¨å…³è”çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šè°ƒç”¨ <code>wake_up()</code> å‡½æ•°å”¤é†’ä»»åŠ¡ï¼šç›¸å…³ä»»åŠ¡ä¼šå°†è‡ªå·±è®¾ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥è¿è¡Œé˜Ÿåˆ—ã€‚å¦‚æœå½“å‰å”¤é†’çš„ä»»åŠ¡ä¼˜å…ˆçº§æ¯”è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä»»ä½•ä»»åŠ¡éƒ½é«˜ï¼Œåˆ™ä¼šè®¾ç½® <code>TIF_NEED_RESCHED</code> æ ‡å¿—ï¼Œä»è€Œè®©æ“ä½œç³»ç»Ÿå°½å¿«è°ƒç”¨ <code>schedule()</code> å‡½æ•°ã€‚</p></li></ul><h1 id="Linux-è°ƒåº¦å™¨"><a href="#Linux-è°ƒåº¦å™¨" class="headerlink" title="Linux è°ƒåº¦å™¨"></a>Linux è°ƒåº¦å™¨</h1><h2 id="æ—©æœŸç‰ˆæœ¬"><a href="#æ—©æœŸç‰ˆæœ¬" class="headerlink" title="æ—©æœŸç‰ˆæœ¬"></a>æ—©æœŸç‰ˆæœ¬</h2><p>Linux 0.0.1 ç‰ˆæœ¬å°±å·²ç»æœ‰äº†ä¸€ä¸ªç®€å•çš„è°ƒåº¦å™¨ï¼Œå½“ç„¶å¹¶éé€‚åˆæ‹¥æœ‰ç‰¹åˆ«å¤šå¤„ç†å™¨çš„ç³»ç»Ÿã€‚è¯¥è°ƒåº¦å™¨åªç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„è¿›ç¨‹é˜Ÿåˆ—ï¼Œæ¯æ¬¡éƒ½éœ€è¦éå†è¯¥é˜Ÿåˆ—æ¥å¯»æ‰¾æ–°çš„è¿›ç¨‹æ‰§è¡Œï¼Œè€Œä¸”å¯¹ä»»åŠ¡æ•°é‡è¿˜æœ‰ä¸¥æ ¼é™åˆ¶ï¼ˆ<code>NR_TASKS</code> åœ¨æœ€åˆçš„ç‰ˆæœ¬ä¸­åªæœ‰ 32ï¼‰ã€‚ä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„å§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 'schedule()' is the scheduler function. </span></span><br><span class="line"><span class="comment">// This is GOOD CODE! There probably won't be any reason to change </span></span><br><span class="line"><span class="comment">// this, as it should work well in all circumstances (ie gives </span></span><br><span class="line"><span class="comment">// IO-bound processes good response etc)...</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, next, c;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> **<span class="title">p</span>;</span></span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰ä¿¡å·ï¼Œåˆ™éœ€è¦å”¤é†’ `TASK_INTERRUPTABLE` çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">for</span> (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p)</span><br><span class="line">        <span class="keyword">if</span> (*p) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123;</span><br><span class="line">                (*p)-&gt;signal |= (<span class="number">1</span> &lt;&lt; (SIGALRM - <span class="number">1</span>));</span><br><span class="line">                (*p)-&gt;alarm = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;signal &amp;&amp; (*p)-&gt;state == TASK_INTERRUPTIBLE)</span><br><span class="line">                (*p)-&gt;state = TASK_RUNNING;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        c = <span class="number">-1</span>;</span><br><span class="line">        next = <span class="number">0</span>;</span><br><span class="line">        i = NR_TASKS;</span><br><span class="line">        p = &amp;task[NR_TASKS];</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ‰¾åˆ°æ—¶é—´ç‰‡æœ€é•¿çš„é‚£ä¸ª</span></span><br><span class="line">        <span class="keyword">while</span> (--i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!*--p)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c)</span><br><span class="line">                c = (*p)-&gt;counter, next = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// éå†ä»»åŠ¡ï¼Œé‡æ–°è®¾å€¼æ—¶é—´ç‰‡</span></span><br><span class="line">        <span class="keyword">for</span> (p = &amp;LAST_TASK; p &gt; &amp;FIRST_TASK; --p)</span><br><span class="line">            <span class="keyword">if</span> (*p)</span><br><span class="line">                (*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; <span class="number">1</span>) + (*p)-&gt;priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    switch_to(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="O-n"><a href="#O-n" class="headerlink" title="O(n)"></a>O(n)</h2><p>2.4 ç‰ˆæœ¬çš„ Linux å†…æ ¸ä½¿ç”¨çš„è°ƒåº¦ç®—æ³•éå¸¸ç®€å•å’Œç›´æ¥ï¼Œç”±äºæ¯æ¬¡åœ¨å¯»æ‰¾ä¸‹ä¸€ä¸ªä»»åŠ¡æ—¶éœ€è¦éå†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆé“¾è¡¨ï¼‰ï¼Œå› æ­¤è¢«ç§°ä¸º O(n) è°ƒåº¦å™¨ï¼ˆæ—¶é—´å¤æ‚åº¦ï¼‰ã€‚</p><p>å½“ç„¶ï¼Œè¯¥è°ƒåº¦å™¨è¦æ¯” 0.01 ç‰ˆæœ¬å†…æ ¸ä¸­çš„è°ƒåº¦ç®—æ³•ç¨å¾®å¤æ‚ç‚¹ï¼Œå®ƒå¼•å…¥äº† epoch æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯å°†æ—¶é—´åˆ†æˆçºªå…ƒï¼ˆepochsï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæ¯ä¸ªçºªå…ƒç»“æŸï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½åº”è¯¥è¿è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œè€Œä¸”é€šå¸¸ç”¨å…‰äº†å®ƒå½“å‰çš„æ—¶é—´ç‰‡ã€‚ä½†å®é™…ä¸Šï¼Œæœ‰äº›ä»»åŠ¡å¹¶æ²¡æœ‰å®Œå…¨ç”¨å®Œæ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆå®ƒå‰©ä½™æ—¶é—´ç‰‡çš„ä¸€åŠå°†ä¼šå’Œæ–°çš„æ—¶é—´ç‰‡ç›¸åŠ ï¼Œä»è€Œåœ¨ä¸‹ä¸€ä¸ªçºªå…ƒè¿è¡Œæ›´é•¿çš„æ—¶é—´ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>schedule()</code> ç®—æ³•çš„æ ¸å¿ƒæºç ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schedule() ç®—æ³•ä¼šéå†æ‰€æœ‰çš„ä»»åŠ¡ï¼ˆO(N)ï¼‰ï¼Œå¹¶ä¸”è®¡ç®—å‡ºæ¯ä¸ªä»»åŠ¡çš„</span></span><br><span class="line"><span class="comment">// goodness å€¼ï¼Œä¸”æŒ‘é€‰å‡ºã€Œæœ€å¥½ã€çš„ä»»åŠ¡æ¥è¿è¡Œã€‚</span></span><br><span class="line"><span class="comment">// ä»¥ä¸‹æ˜¯éƒ¨åˆ†æ ¸å¿ƒæºç ï¼Œä¸»è¦æ˜¯äº†è§£ä¸‹å®ƒçš„æ€è·¯ã€‚</span></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æè¿°ç¬¦ï¼š</span></span><br><span class="line">    <span class="comment">// 1. prev: å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// 2. next: ä¸‹ä¸€ä¸ªå°†è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// 3. p: å½“å‰æ­£åœ¨éå†çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">prev</span>, *<span class="title">next</span>, *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> this_cpu, c; <span class="comment">// c è¡¨ç¤ºæƒé‡å€¼</span></span><br><span class="line">repeat_schedule:</span><br><span class="line">    <span class="comment">// é»˜è®¤é€‰ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">    next = idle_task(this_cpu);</span><br><span class="line">    c = <span class="number">-1000</span>;</span><br><span class="line">    list_for_each(tmp, &amp;runqueue_head) &#123;</span><br><span class="line">        p = list_entry(tmp, struct task_struct, run_list);</span><br><span class="line">        <span class="keyword">if</span> (can_schedule(p, this_cpu)) &#123;</span><br><span class="line">            <span class="keyword">int</span> weight = goodness(p, this_cpu, prev-&gt;active_mm);</span><br><span class="line">            <span class="keyword">if</span> (weight &gt; c)</span><br><span class="line">                c = weight, next = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æºç ä¸­çš„ <code>goodness()</code> å‡½æ•°ä¼šè®¡ç®—å‡ºä¸€ä¸ªæƒé‡å€¼ï¼Œå®ƒçš„ç®—æ³•åŸºæœ¬æ€æƒ³å°±æ˜¯åŸºäºè¿›ç¨‹æ‰€å‰©ä½™çš„æ—¶é’ŸèŠ‚æ‹æ•°ï¼ˆæ—¶é—´ç‰‡ï¼‰ï¼Œå†åŠ ä¸ŠåŸºäºè¿›ç¨‹ä¼˜å…ˆçº§çš„æƒé‡å€¼ã€‚è¿”å›å€¼å¦‚ä¸‹ï¼š</p><ul><li>-1000 è¡¨ç¤ºä¸è¦é€‰æ‹©è¯¥è¿›ç¨‹è¿è¡Œ</li><li>0 è¡¨ç¤ºæ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œéœ€è¦é‡æ–°è®¡ç®— countersï¼ˆå¯èƒ½ä¼šè¢«é€‰ä¸­è¿è¡Œï¼‰</li><li>æ­£æ•´æ•°ï¼šè¡¨ç¤º goodness å€¼ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰</li><li>+1000 è¡¨ç¤ºå®æ—¶è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥å°±è¦é€‰æ‹©å®ƒè¿è¡Œ</li></ul><p>æœ€åï¼Œé’ˆå¯¹ O(n) è°ƒåº¦å™¨åšä¸‹æ€»ç»“ï¼š</p><ol><li>ç®—æ³•å®ç°éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¸é«˜æ•ˆï¼ˆä»»åŠ¡è¶Šå¤šï¼Œéå†è€—è´¹æ—¶é—´è¶Šä¹…ï¼‰</li><li>æ²¡æœ‰å¾ˆå¥½çš„æ‰©å±•æ€§ï¼Œå¤šæ ¸å¤„ç†å™¨æ€ä¹ˆåŠï¼Ÿ</li><li>å¯¹äºå®æ—¶ä»»åŠ¡è°ƒåº¦æ”¯æŒè¾ƒå¼±ï¼ˆæ— è®ºå¦‚ä½•ä½œä¸ºä¼˜å…ˆçº§é«˜çš„å®æ—¶ä»»åŠ¡éƒ½éœ€è¦åœ¨éå†å®Œåˆ—è¡¨åæ‰å¯ä»¥çŸ¥é“ï¼‰</li></ol><h2 id="O-1"><a href="#O-1" class="headerlink" title="O(1)"></a>O(1)</h2><p><a href="https://en.wikipedia.org/wiki/Ingo_Moln%C3%A1r" target="_blank" rel="noopener">Ingo MolnÃ¡r</a> å¤§ä½¬åœ¨ 2.6 ç‰ˆæœ¬çš„å†…æ ¸ä¸­åŠ å…¥äº†å…¨æ–°çš„è°ƒåº¦ç®—æ³•ï¼Œå®ƒèƒ½å¤Ÿåœ¨å¸¸æ•°æ—¶é—´å†…è°ƒåº¦ä»»åŠ¡ï¼Œå› æ­¤è¢«ç§°ä¸º O(1) è°ƒåº¦å™¨ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå¼•å…¥çš„ä¸€äº›æ–°ç‰¹æ€§ï¼š</p><ul><li>å…¨å±€ä¼˜å…ˆçº§å•ä½ï¼ŒèŒƒå›´æ˜¯ 0~139ï¼Œæ•°å€¼è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li><li><strong>å°†ä»»åŠ¡æ‹†åˆ†æˆå®æ—¶ï¼ˆ0~99ï¼‰å’Œæ­£å¸¸ï¼ˆ100~139ï¼‰ä¸¤éƒ¨åˆ†</strong>ã€‚æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡è·å¾—æ›´å¤šæ—¶é—´ç‰‡</li><li><strong>å³åˆ»æŠ¢å ï¼ˆearly preemptionï¼‰</strong>ã€‚å½“ä»»åŠ¡çŠ¶æ€å˜æˆ <code>TASK_RUNNING</code> æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å…¶ä¼˜å…ˆçº§æ˜¯å¦æ¯”å½“å‰è¿è¡Œçš„ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™æŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œåˆ‡æ¢åˆ°è¯¥ä»»åŠ¡</li><li><strong>å®æ—¶ä»»åŠ¡ä½¿ç”¨é™æ€ä¼˜å…ˆçº§</strong></li><li><strong>æ™®é€šä»»åŠ¡ä½¿ç”¨ä½¿ç”¨åŠ¨æ€ä¼˜å…ˆçº§</strong>ã€‚ä»»åŠ¡ä¼˜å…ˆçº§ä¼šåœ¨å…¶ä½¿ç”¨å®Œè‡ªå·±çš„æ—¶é—´ç‰‡åé‡æ–°è®¡ç®—ï¼Œå†…æ ¸ä¼šè€ƒè™‘å®ƒè¿‡å»çš„è¡Œä¸ºï¼Œå†³å®šå®ƒçš„äº¤äº’æ€§ç­‰çº§ã€‚äº¤äº’å‹ä»»åŠ¡æ›´å®¹æ˜“å¾—åˆ°è°ƒåº¦</li></ul><p>O(n) çš„è°ƒåº¦å™¨ä¼šåœ¨æ¯ä¸ªçºªå…ƒç»“æŸåï¼ˆæ‰€æœ‰ä»»åŠ¡çš„æ—¶é—´ç‰‡éƒ½ä½¿ç”¨è¿‡ï¼‰ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚è€Œ O(1) åˆ™æ˜¯åœ¨æ¯ä¸ªä»»åŠ¡æ—¶é—´ç‰‡é…é¢ç”¨å®Œåå°±é‡æ–°è®¡ç®—ä¼˜å…ˆçº§ã€‚O(1) è°ƒåº¦å™¨ä¸º<strong>æ¯ä¸ª CPU ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå³ active å’Œ expired</strong>ã€‚active é˜Ÿåˆ—å­˜æ”¾çš„æ˜¯æ—¶é—´ç‰‡å°šæœªç”¨å®Œçš„ä»»åŠ¡ï¼Œè€Œ expired åˆ™æ˜¯æ—¶é—´ç‰‡å·²ç»è€—å°½çš„ä»»åŠ¡ã€‚å½“ä¸€ä¸ªä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å®Œåï¼Œå°±ä¼šè¢«è½¬åˆ° expired é˜Ÿåˆ—ï¼Œè€Œä¸”ä¼šé‡æ–°è®¡ç®—å®ƒçš„ä¼˜å…ˆçº§ã€‚<strong>å½“ active é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨è½¬ç§»åˆ° expired é˜Ÿåˆ—åï¼Œä¼šäº¤æ¢äºŒè€…ï¼ˆè®© active æŒ‡å‘ expired é˜Ÿåˆ—ï¼Œexpired æŒ‡å‘ active é˜Ÿåˆ—ï¼‰</strong>ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œé˜Ÿåˆ—åˆ‡æ¢éƒ½å’Œä»»åŠ¡æ•°é‡å¤šå¯¡æ— å…³ï¼Œèƒ½å¤Ÿåœ¨ O(1) æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆã€‚</p><p>åœ¨å…ˆå‰ä»‹ç»çš„è°ƒåº¦ç®—æ³•ä¸­ï¼Œå¦‚æœæƒ³è¦å–ä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ï¼Œè¿˜éœ€è¦éå†æ•´ä¸ªä»»åŠ¡é“¾è¡¨æ‰å¯ä»¥ã€‚è€Œ O(1) è°ƒåº¦å™¨åˆ™å¾ˆç‰¹åˆ«ï¼Œå®ƒä¸ºæ¯ç§ä¼˜å…ˆçº§æä¾›äº†ä¸€ä¸ªä»»åŠ¡é“¾è¡¨ã€‚æ‰€æœ‰çš„å¯è¿è¡Œä»»åŠ¡ä¼šè¢«åˆ†æ•£åœ¨ä¸åŒä¼˜å…ˆçº§é˜Ÿåº”çš„é“¾è¡¨ä¸­ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹å…¨æ–°çš„ <code>runqueue</code> æ˜¯æ€ä¹ˆå®šä¹‰çš„å§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">runqueue</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_running; <span class="comment">/* å¯è¿è¡Œçš„ä»»åŠ¡æ€»æ•°ï¼ˆæŸä¸ª CPUï¼‰ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> *<span class="title">active</span>;</span> <span class="comment">/* æŒ‡å‘ active çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> *<span class="title">expired</span>;</span> <span class="comment">/* æŒ‡å‘ expired çš„é˜Ÿåˆ—çš„æŒ‡é’ˆ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> <span class="title">arrays</span>[2];</span> <span class="comment">/* å®é™…å­˜æ”¾ä¸åŒä¼˜å…ˆçº§å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥ç›´è§‚æ„Ÿå—ä¸‹ä»»åŠ¡é˜Ÿåˆ—ï¼š<br><img src="https://pic4.zhimg.com/v2-a4e9ffb8e01f5adbb240bd0f3e19991f.jpg" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>prio_array</code> æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prio_array</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> nr_active; <span class="comment">/* åˆ—è¡¨ä¸­çš„ä»»åŠ¡æ€»æ•° */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> bitmap[BITMAP_SIZE]; <span class="comment">/* ä½å›¾è¡¨ç¤ºå¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨æ˜¯å¦æœ‰ä»»åŠ¡å­˜åœ¨ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>[<span class="title">MAX_PRIO</span>];</span> <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¯ç§ä¼˜å…ˆçº§å¯¹åº”ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼‰ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>prio_array</code> ä¸­å­˜åœ¨ä¸€ä¸ªä½å›¾ï¼Œå®ƒæ˜¯ç”¨æ¥æ ‡è®°æ¯ä¸ª priority å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨æ˜¯å¦å­˜åœ¨ä»»åŠ¡çš„ã€‚æ¥ä¸‹æ¥çœ‹çœ‹ä¸ºä½• O(1) è°ƒåº¦å™¨å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´æ‰¾åˆ°éœ€è¦è¿è¡Œçš„ä»»åŠ¡ï¼š</p><ol><li><strong>å¸¸æ•°æ—¶é—´ç¡®å®šä¼˜å…ˆçº§</strong>ï¼šé¦–å…ˆä¼šåœ¨ä½å›¾ä¸­æŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªè®¾ç½®ä¸º 1 çš„ä½ï¼ˆæ€»å…±æœ‰ 140 bitsï¼Œä»ç¬¬ä¸€ä¸ª bit å¼€å§‹æœç´¢ï¼Œè¿™æ ·å¯ä»¥ä¿è¯é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆå¾—åˆ°æœºä¼šè¿è¡Œï¼‰ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±å¯ä»¥ç¡®å®šå“ªä¸ªä¼˜å…ˆçº§æœ‰ä»»åŠ¡ï¼Œå‡è®¾æ‰¾åˆ°åçš„å€¼ä¸º <code>priority</code>ï¼›</li><li><strong>å¸¸æ•°æ—¶é—´è·å¾—ä¸‹ä¸€ä¸ªä»»åŠ¡</strong>ï¼šåœ¨ <code>queue[priority]</code> å¯¹åº”çš„ä»»åŠ¡é“¾è¡¨ä¸­æå–ç¬¬ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼ˆå¤šä¸ªä»»åŠ¡ä¼šè½®è½¬æ‰§è¡Œï¼‰ã€‚<br><img src="https://pic1.zhimg.com/v2-5dbbda39ff60d26fd2605ef6970dc468.jpg" alt=""></li></ol><p>å¥½äº†ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸‹ O(1) è°ƒåº¦å™¨çš„ä¼˜ç¼ºç‚¹äº†ï¼š</p><ol><li>è®¾è®¡ä¸Šè¦æ¯” O(n) è°ƒåº¦å™¨æ›´åŠ å¤æ‚ç²¾å¦™ï¼›</li><li>ç›¸å¯¹æ¥è¯´æ‰©å±•æ€§æ›´å¥½ï¼Œæ€§èƒ½æ›´ä¼˜ï¼Œåœ¨ä»»åŠ¡åˆ‡æ¢ä¸Šçš„å¼€é”€æ›´å°ï¼›</li><li>ç”¨æ¥æ ‡è®°ä»»åŠ¡æ˜¯å¦ä¸ºäº¤äº’ç±»å‹çš„ç®—æ³•è¿˜æ˜¯è¿‡äºå¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºé”™ã€‚</li></ol><h2 id="Staircase"><a href="#Staircase" class="headerlink" title="Staircase"></a>Staircase</h2><p><em>Staircase Scheduler</em> æ˜¯ Con Kolivas ä¸ºäº†æ”¹å–„æ¡Œé¢ç³»ç»Ÿäº¤äº’åº”ç”¨çš„å“åº”æ—¶é—´è€Œå®ç°çš„è°ƒåº¦å™¨ï¼Œä½†å®ƒå¹¶éå†…æ ¸å®˜æ–¹æ”¯æŒçš„è°ƒåº¦å™¨ã€‚å®ƒçš„æ•´ä½“è®¾è®¡æ€æƒ³ç±»ä¼¼äº <em>Operating Systems: The Three Easy Pieces</em> ä¸­æåˆ°çš„ MLFQï¼ˆMultilevel Feedback Queueï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„è®¾è®¡æ€æƒ³ï¼š</p><ol><li>é¦–å…ˆï¼Œå®ƒä¹Ÿæ˜¯å°†ä»»åŠ¡æŒ‰ç…§ä¼˜å…ˆçº§æ”¾åœ¨ä¸åŒçš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆç±»ä¼¼ä¸Šé¢çš„ active é˜Ÿåˆ—ï¼‰</li><li>è°ƒåº¦å™¨æ¯æ¬¡ä¼šä»æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­è·å–ä¸€ä¸ªè¦åˆ‡æ¢æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ—¶é—´ç‰‡ä½¿ç”¨å®Œæ¯•åï¼Œä¼šå°†å…¶ä¼˜å…ˆçº§è°ƒä½ä¸€ä¸ªç­‰çº§ï¼Œç›´åˆ°å…¶ä¼˜å…ˆçº§é™åˆ°æœ€ä½ã€‚</li><li>å½“å¤„äºæœ€ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ç”¨å…‰äº†æ—¶é—´ç‰‡åï¼Œå®ƒä¼šè¢«é‡æ–°æ”¾åˆ°æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡é“¾è¡¨ä¸­ï¼ˆè¿™ä¸ªæ–°çš„ä¼˜å…ˆçº§æ˜¯å®ƒä¹‹å‰æœ€é«˜ä¼˜å…ˆçº§å‡ 1 åçš„å€¼ï¼‰ï¼ŒåŒæ—¶ä¼šè·å¾—ä¸¤å€äºä¹‹å‰çš„æ—¶é—´ç‰‡</li><li>å¯¹äºé•¿æ—¶é—´ç¡çœ çš„ä»»åŠ¡ï¼Œä¼šè¢«æ”¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡é“¾è¡¨ã€‚æ‰€ä»¥äº¤äº’å¼ä»»åŠ¡å¯ä»¥ä¿æŒåœ¨æœ€é«˜ä¼˜å…ˆçº§ä½ç½®ï¼Œä»è€Œä¿æŒè‰¯å¥½çš„å“åº”æ€§èƒ½ï¼›è€Œæ‰¹å¤„ç†ä»»åŠ¡åˆ™å¤„äºä½ä¼˜å…ˆçº§ï¼Œä½†æ˜¯ä¼šè·å¾—æ›´å¤šçš„æ‰§è¡Œæ—¶é—´ã€‚</li></ol><h2 id="CFS"><a href="#CFS" class="headerlink" title="CFS"></a>CFS</h2><h3 id="å•æ ¸è°ƒåº¦"><a href="#å•æ ¸è°ƒåº¦" class="headerlink" title="å•æ ¸è°ƒåº¦"></a>å•æ ¸è°ƒåº¦</h3><p>CFS çš„å…¨ç§°æ˜¯ Complete Fair Schedulerï¼Œä¹Ÿå°±æ˜¯å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ã€‚å®ƒå®ç°äº†ä¸€ä¸ªåŸºäºæƒé‡çš„å…¬å¹³é˜Ÿåˆ—ç®—æ³•ï¼Œä»è€Œå°† CPU æ—¶é—´åˆ†é…ç»™å¤šä¸ªä»»åŠ¡ï¼ˆæ¯ä¸ªä»»åŠ¡çš„æƒé‡å’Œå®ƒçš„ nice å€¼æœ‰å…³ï¼Œnice å€¼è¶Šä½ï¼Œæƒé‡å€¼è¶Šé«˜ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è™šæ‹Ÿè¿è¡Œæ—¶é—´ vruntimeï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªä»»åŠ¡æ‰€ä½¿ç”¨çš„ CPU æ—¶é—´é™¤ä»¥å…¶ä¼˜å…ˆçº§å¾—åˆ°çš„å€¼ã€‚ç›¸åŒä¼˜å…ˆçº§å’Œç›¸åŒ vruntime çš„ä¸¤ä¸ªä»»åŠ¡å®é™…è¿è¡Œçš„æ—¶é—´ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œè¿™å°±æ„å‘³ç€ CPU èµ„æºæ˜¯ç”±å®ƒä»¬å‡åˆ†äº†ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰ä»»åŠ¡èƒ½å¤Ÿå…¬å¹³æ¨è¿›ï¼Œæ¯å½“éœ€è¦æŠ¢å å½“å‰ä»»åŠ¡æ—¶ï¼ŒCFS æ€»ä¼šæŒ‘é€‰å‡º <code>vruntime</code> æœ€å°çš„é‚£ä¸ªä»»åŠ¡è¿è¡Œã€‚</p><p>å†…æ ¸ç‰ˆæœ¬åœ¨ 2.6.38 ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ä¼šè¢«å½“æˆç‹¬ç«‹çš„è°ƒåº¦å•å…ƒï¼Œå¹¶ä¸”å’Œç³»ç»Ÿä¸­å…¶å®ƒçº¿ç¨‹å…±äº«èµ„æºï¼Œè¿™å°±æ„å‘³ç€ä¸€ä¸ªå¤šçº¿ç¨‹çš„åº”ç”¨ä¼šæ¯”å•çº¿ç¨‹çš„åº”ç”¨è·å¾—æ›´å¤šçš„èµ„æºã€‚ä¹‹åï¼ŒCFS ä¸æ–­æ”¹è¿›ï¼Œç›®å‰å·²ç»æ”¯æŒå°†ä¸€ä¸ªåº”ç”¨ä¸­çš„çº¿ç¨‹æ‰“åŒ…åˆ° cgroup ç»“æ„ä¸­ï¼Œcgroup çš„ vruntime æ˜¯å…¶ä¸­æ‰€æœ‰çº¿ç¨‹çš„ vuntime ä¹‹å’Œã€‚ç„¶å CFS å°±å¯ä»¥å°†å®ƒçš„ç®—æ³•åº”ç”¨äºcgroup ä¹‹é—´ï¼Œä»è€Œä¿è¯å…¬å¹³æ€§ã€‚å½“æŸä¸ª cgroup è¢«é€‰ä¸­åï¼Œå…¶ä¸­æ‹¥æœ‰æœ€å° vruntime çš„çº¿ç¨‹ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œä¿è¯ cgroup ä¸­çš„çº¿ç¨‹ä¹‹é—´çš„å…¬å¹³æ€§ã€‚cgroup è¿˜å¯ä»¥åµŒå¥—ï¼Œä¾‹å¦‚ systemd ä¼šè‡ªåŠ¨é…ç½® cgroup æ¥ä¿è¯ä¸åŒç”¨æˆ·ä¹‹é—´çš„å…¬å¹³æ€§ï¼Œç„¶ååœ¨ç”¨æˆ·è¿è¡Œçš„å¤šä¸ªåº”ç”¨ä¹‹é—´ç»´æŒå…¬å¹³æ€§ã€‚</p><p>CFS é€šè¿‡åœ¨ä¸€å®šæ—¶é—´å†…è¿è¡Œè°ƒåº¦æ‰€æœ‰çš„çº¿ç¨‹æ¥é¿å…é¥¥é¥¿é—®é¢˜ã€‚å½“è¿è¡Œçš„ çº¿ç¨‹æ•°åœ¨ 8 ä¸ªåŠä»¥ä¸‹æ—¶ï¼Œé»˜è®¤çš„æ—¶é—´å‘¨æœŸæ˜¯ 48msï¼›è€Œå½“å¤šäº 8 ä¸ªçº¿ç¨‹æ—¶ï¼Œæ—¶é—´å‘¨æœŸå°±ä¼šéšç€çº¿ç¨‹æ•°é‡è€Œå¢åŠ ï¼ˆ6ms * çº¿ç¨‹æ•°ï¼Œä¹‹æ‰€ä»¥é€‰æ‹© 6msï¼Œæ˜¯ä¸ºäº†é¿å…é¢‘ç¹æŠ¢å ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹åˆ‡æ¢çš„å¼€é”€ï¼‰ã€‚ç”±äº CFS æ€»æ˜¯ä¼šæŒ‘é€‰ vruntime æœ€å°çš„çº¿ç¨‹æ‰§è¡Œï¼Œå®ƒå°±éœ€è¦é¿å…æŸä¸ªçº¿ç¨‹çš„ vruntime å¤ªå°ï¼Œä»¥è‡³äºå…¶å®ƒçº¿ç¨‹éœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½å¾—åˆ°è°ƒåº¦ï¼ˆä¼šæœ‰é¥¥é¥¿é—®é¢˜ï¼‰ã€‚æ‰€ä»¥åœ¨å®è·µä¸­ï¼ŒCFS ä¼šä¿è¯æ‰€æœ‰çº¿ç¨‹ä¹‹é—´çš„ vruntime ä¹‹å·®ä½äºæŠ¢å æ—¶é—´ï¼ˆ6msï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡å¦‚ä¸‹ä¸¤ç‚¹æ¥ä¿è¯çš„ï¼š</p><ol><li>å½“çº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå®ƒçš„ vruntime å€¼ç­‰äºè¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçº¿ç¨‹çš„æœ€å¤§ vruntimeï¼›</li><li>å½“çº¿ç¨‹ä»ç¡çœ ä¸­å”¤é†’æ—¶ï¼Œå®ƒçš„ vruntime å€¼ä¼šè¢«æ›´æ–°ä¸ºå¤§äºæˆ–ç­‰äºæ‰€æœ‰å¾…è°ƒåº¦çº¿ç¨‹ä¸­æœ€å°çš„ vruntimeã€‚ä½¿ç”¨æœ€å° vruntime è¿˜å¯ä»¥ä¿è¯é¢‘ç¹ç¡çœ çš„çº¿ç¨‹ä¼˜å…ˆè¢«è°ƒåº¦ï¼Œè¿™å¯¹äºæ¡Œé¢ç³»ç»Ÿéå¸¸é€‚åˆï¼Œå®ƒä¼šå‡å°‘äº¤äº’åº”ç”¨çš„å“åº”å»¶è¿Ÿã€‚</li></ol><p>CFS è¿˜å¼•å…¥äº†å¯å‘å¼è°ƒåº¦æ€æƒ³æ¥æ”¹å–„é«˜é€Ÿç¼“å­˜åˆ©ç”¨ç‡ã€‚ä¾‹å¦‚ï¼Œå½“çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥è¯¥çº¿ç¨‹çš„ vruntime å’Œæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ vruntime ä¹‹å·®æ˜¯å¦éå¸¸æ˜¾è‘—ï¼ˆä¸´ç•Œå€¼æ˜¯ 1msï¼‰ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™ä¸ä¼šæŠ¢å å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯è¿™ç§åšæ³•è¿˜æ˜¯ä»¥ç‰ºç‰²è°ƒåº¦å»¶è¿Ÿä¸ºä»£ä»·çš„ï¼Œç®—æ˜¯ä¸€ç§æƒè¡¡å§ã€‚</p><h3 id="å¤šæ ¸è´Ÿè½½å‡è¡¡"><a href="#å¤šæ ¸è´Ÿè½½å‡è¡¡" class="headerlink" title="å¤šæ ¸è´Ÿè½½å‡è¡¡"></a>å¤šæ ¸è´Ÿè½½å‡è¡¡</h3><p>åœ¨å¤šæ ¸ç¯å¢ƒä¸­ï¼ŒLinux CFS ä¼šå°†<em>å·¥ä½œï¼ˆworkï¼‰</em>åˆ†æ‘Šåˆ°å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸­æ‰§è¡Œã€‚ä½†æ˜¯è¿™ä¸ç­‰åŒäºå°†çº¿ç¨‹å‡åˆ†åˆ°å¤šä¸ªå¤„ç†å™¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª CPU å¯†é›†å‹çš„çº¿ç¨‹å’Œ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹å¯èƒ½åˆ†åˆ«åœ¨ä¸¤ä¸ªæ ¸ä¸Šæ‰§è¡Œï¼Œå…¶ä¸­ä¸€ä¸ªä¸“é—¨æ‰§è¡Œ CPU å¯†é›†å‹çº¿ç¨‹ï¼›è€Œå¦ä¸€ä¸ªåˆ™å¤„ç†é‚£ 10 ä¸ªé¢‘ç¹ç¡çœ çš„çº¿ç¨‹ã€‚</p><p>ä¸ºäº†å¤šä¸ªå¤„ç†å™¨ä¸Šçš„å·¥ä½œé‡å‡è¡¡ï¼ŒCFS ä½¿ç”¨äº† <code>load</code> æŒ‡æ ‡æ¥è¡¡é‡çº¿ç¨‹å’Œå¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µã€‚çº¿ç¨‹çš„è´Ÿè½½å’Œçº¿ç¨‹çš„ CPU å¹³å‡ä½¿ç”¨ç‡ç›¸å…³ï¼šç»å¸¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½è¦ä½äºä¸ç¡çœ çš„çº¿ç¨‹è´Ÿè½½ã€‚ç±»ä¼¼ vruntimeï¼Œçº¿ç¨‹çš„è´Ÿè½½ä¹Ÿæ˜¯çº¿ç¨‹çš„ä¼˜å…ˆçº§åŠ æƒå¾—åˆ°çš„ã€‚è€Œå¤„ç†å™¨çš„è´Ÿè½½æ˜¯åœ¨è¯¥å¤„ç†å™¨ä¸Šå¯è¿è¡Œçº¿ç¨‹çš„è´Ÿè½½ä¹‹å’Œã€‚CFS ä¼šå°è¯•å‡è¡¡å¤„ç†å™¨çš„è´Ÿè½½ã€‚</p><p>CFS ä¼šåœ¨çº¿ç¨‹åˆ›å»ºå’Œå”¤é†’æ—¶å…³æ³¨å¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µï¼Œè°ƒåº¦å™¨é¦–å…ˆè¦å†³å®šå°†ä»»åŠ¡æ”¾åœ¨å“ªä¸ªå¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚è¿™é‡Œä¹Ÿä¼šæ¶‰åŠåˆ°å¯å‘å¼æ€æƒ³ï¼Œæ¯”å¦‚ï¼Œå¦‚æœ CFS æ£€æŸ¥åˆ°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé‚£ä¹ˆå®ƒä¼šå°†æ¶ˆè´¹è€…çº¿ç¨‹å°½å¯èƒ½åœ°åˆ†æ•£åˆ°æœºå™¨çš„å¤šä¸ªå¤„ç†å™¨ä¸Šï¼Œå› ä¸ºå¤šæ•°æ ¸å¿ƒéƒ½é€‚åˆå¤„ç†å”¤é†’çš„çº¿ç¨‹ã€‚</p><p>è´Ÿè½½å‡è¡¡è¿˜ä¼šå‘¨æœŸæ€§å‘ç”Ÿï¼Œæ¯éš” 4msï¼Œæ¯ä¸ªå¤„ç†å™¨éƒ½ä¼šå°è¯•ä»å…¶å®ƒå¤„ç†å™¨å·å–ä¸€äº›å·¥ä½œã€‚å½“ç„¶ï¼Œè¿™ç§ work-stealing å‡è¡¡æ–¹æ³•è¿˜ä¼šè€ƒè™‘æœºå™¨çš„æ‹“æ‰‘ç»“æ„ï¼šå¤„ç†å™¨ä¼šå°è¯•ä»è·ç¦»å®ƒä»¬ã€Œæ›´è¿‘ã€çš„å…¶å®ƒå¤„ç†å™¨ä¸Šå°è¯•çªƒå–å·¥ä½œï¼Œè€Œéè·ç¦»ã€Œæ›´è¿œã€çš„å¤„ç†å™¨ï¼ˆå¦‚è¿œç¨‹ NUMA èŠ‚ç‚¹ï¼‰ã€‚å½“å¤„ç†å™¨å†³å®šè¦ä»å…¶å®ƒå¤„ç†å™¨çªƒå–ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šå°è¯•åœ¨äºŒè€…ä¹‹é—´å‡è¡¡è´Ÿè½½ï¼Œå¹¶ä¸”ä¼šçªƒå–å¤šè¾¾ 32 ä¸ªçº¿ç¨‹ã€‚æ­¤å¤–ï¼Œå½“å¤„ç†å™¨è¿›å…¥ç©ºé—²çŠ¶æ€æ—¶ï¼Œå®ƒä¹Ÿä¼šç«‹åˆ»è°ƒç”¨è´Ÿè½½å‡è¡¡å™¨ã€‚</p><p>åœ¨å¤§å‹çš„ NUMA æœºå™¨ä¸Šï¼ŒCFS å¹¶ä¸ä¼šç²—æš´åœ°æ¯”è¾ƒæ‰€æœ‰ CPU çš„è´Ÿè½½ï¼Œè€Œæ˜¯ä»¥åˆ†å±‚çš„æ–¹å¼è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚ä»¥ä¸€å°æœ‰ä¸¤ä¸ª NUMA èŠ‚ç‚¹çš„æœºå™¨ä¸ºä¾‹ï¼ŒCFS ä¼šå…ˆåœ¨ NUMA èŠ‚ç‚¹å†…éƒ¨çš„å¤„ç†å™¨ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œç„¶åæ¯”è¾ƒ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½ï¼ˆé€šè¿‡èŠ‚ç‚¹å†…éƒ¨å¤„ç†å™¨è´Ÿè½½è®¡ç®—å¾—åˆ°ï¼‰ï¼Œå†å†³å®šè¦ä¸è¦åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¦‚æœ NUMA èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½å·®è·åœ¨ 25% ä»¥å†…ï¼Œåˆ™ä¸ä¼šè¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ€»ç»“æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªå¤„ç†å™¨ï¼ˆæˆ–å¤„ç†å™¨ç»„ï¼‰ä¹‹é—´çš„è·ç¦»è¶Šè¿œï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä¸å¹³è¡¡æ€§å·®è·è¶Šå¤§çš„æƒ…å†µä¸‹æ‰ä¼šè€ƒè™‘è´Ÿè½½å‡è¡¡ã€‚</p><h3 id="è¿è¡Œé˜Ÿåˆ—"><a href="#è¿è¡Œé˜Ÿåˆ—" class="headerlink" title="è¿è¡Œé˜Ÿåˆ—"></a>è¿è¡Œé˜Ÿåˆ—</h3><p>CFS å¼•å…¥äº†<a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree" target="_blank" rel="noopener">çº¢é»‘æ ‘</a>ï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€æ£µåŠå¹³è¡¡äºŒå‰æ ‘ï¼Œå¯¹äºæ’å…¥å’ŒæŸ¥æ‰¾éƒ½æœ‰ O(log(N)) çš„æ—¶é—´å¤æ‚åº¦ï¼‰æ¥ç»´æŠ¤è¿è¡Œé˜Ÿåˆ—ï¼Œæ ‘çš„èŠ‚ç‚¹å€¼æ˜¯è°ƒåº¦å•å…ƒçš„ vruntimeï¼Œæ‹¥æœ‰æœ€å° vruntime çš„èŠ‚ç‚¹ä½äºæ ‘çš„æœ€å·¦ä¸‹è¾¹ã€‚<br><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Red-black_tree_example.svg/2560px-Red-black_tree_example.svg.png" alt=""></p><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>cfs_rq</code> æ•°æ®ç»“æ„çš„å®šä¹‰ï¼ˆä½äº <code>&lt;kernel/sched/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cfs_rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰ä»»åŠ¡çš„ç´¯è®¡æƒé‡å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¯¥é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_running;</span><br><span class="line">    <span class="comment">// è¿è¡Œé˜Ÿåˆ—ä¸­æœ€å°çš„ vruntime</span></span><br><span class="line">    u64 min_vruntime;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ŒæŒ‡å‘è¿è¡Œä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">tasks_timeline</span>;</span></span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªå³å°†è¢«è°ƒåº¦çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_leftmost</span>;</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„è°ƒåº¦å•å…ƒ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">curr</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>CFS ç®—æ³•å®é™…åº”ç”¨äºè°ƒåº¦å•å…ƒï¼ˆè¿™æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æŠ½è±¡ï¼Œå¯ä»¥æ˜¯çº¿ç¨‹ã€cgroups ç­‰ï¼‰ï¼Œè°ƒåº¦å•å…ƒæ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼ˆä½äº <code>&lt;include/linux/sched.h&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè°ƒåº¦å•å…ƒçš„è´Ÿè½½æƒé‡ï¼ˆæ¯”å¦‚è¯¥è°ƒåº¦å•å…ƒæ˜¯ä¸€ä¸ªç»„ï¼Œåˆ™è¯¥å€¼å°±æ˜¯è¯¥ç»„ä¸‹æ‰€æœ‰çº¿ç¨‹çš„è´Ÿè½½æƒé‡çš„ç»„åˆï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">load_weight</span> <span class="title">load</span>;</span> <span class="comment">/* for load-balancing */</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">run_node</span>;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰è°ƒåº¦å•å…ƒæ˜¯å¦ä½äºè¿è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> on_rq;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    u64 exec_start;</span><br><span class="line">    <span class="comment">// æ€»å…±è¿è¡Œçš„æ—¶é—´ï¼Œè¯¥å€¼æ˜¯é€šè¿‡ `update_curr()` æ›´æ–°çš„ã€‚</span></span><br><span class="line">    u64 sum_exec_runtime;</span><br><span class="line">    <span class="comment">// åŸºäºè™šæ‹Ÿæ—¶é’Ÿè®¡ç®—å‡ºè¯¥è°ƒåº¦å•å…ƒå·²è¿è¡Œçš„æ—¶é—´</span></span><br><span class="line">    u64 vruntime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè®°å½•ä¹‹å‰è¿è¡Œçš„æ—¶é—´ä¹‹å’Œ</span></span><br><span class="line">    u64 prev_sum_exec_runtime;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h3 id="è™šæ‹Ÿæ—¶é’Ÿ"><a href="#è™šæ‹Ÿæ—¶é’Ÿ" class="headerlink" title="è™šæ‹Ÿæ—¶é’Ÿ"></a>è™šæ‹Ÿæ—¶é’Ÿ</h3><p>å‰é¢æåˆ°çš„ vruntime ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆå«ä½œè™šæ‹Ÿè¿è¡Œæ—¶é—´å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±è¦æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ã€‚ä¸ºäº†æ›´å¥½åœ°å®ç°å…¬å¹³æ€§ï¼ŒCFS ä½¿ç”¨äº†è™šæ‹Ÿæ—¶é’Ÿæ¥æµ‹é‡ä¸€ä¸ªç­‰å¾…çš„è°ƒåº¦å•å…ƒåœ¨ä¸€ä¸ª<strong>å®Œå…¨å…¬å¹³çš„å¤„ç†å™¨</strong>ä¸Šå…è®¸æ‰§è¡Œçš„æ—¶é—´ã€‚ç„¶è€Œï¼Œè™šæ‹Ÿæ—¶é’Ÿå¹¶æ²¡æœ‰çœŸå®çš„å®ç°ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚</p><p>æˆ‘ä»¬å¯ä»¥åŸºäºçœŸå®æ—¶é—´å’Œä»»åŠ¡çš„è´Ÿè½½æƒé‡æ¥è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ï¼Œè¯¥ç®—æ³•æ˜¯åœ¨ <code>update_cur()</code> å‡½æ•°ä¸­å®ç°çš„ï¼Œå®ƒä¼šæ›´æ–°è°ƒåº¦å•å…ƒçš„æ—¶é—´è®°è´¦ä¿¡æ¯ï¼Œä»¥åŠ CFS è¿è¡Œé˜Ÿåˆ—çš„ <code>min_vruntime</code>ï¼ˆå®Œæ•´å®šä¹‰ä½äº <code>&lt;kernel/sched/fair.c&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_curr</span><span class="params">(struct cfs_rq *cfs_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">curr</span> = <span class="title">cfs_rq</span>-&gt;<span class="title">curr</span>;</span></span><br><span class="line">    u64 now = rq_clock_task(rq_of(cfs_rq));</span><br><span class="line">    u64 delta_exec;</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!curr))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡ºè°ƒåº¦å•å…ƒå¼€å§‹æ‰§è¡Œæ—¶é—´å’Œå½“å‰ä¹‹é—´çš„å·®å€¼ï¼Œå³çœŸå®è¿è¡Œæ—¶é—´</span></span><br><span class="line">    delta_exec = now - curr-&gt;exec_start;</span><br><span class="line">    curr-&gt;vruntime += calc_delta_fair(delta_exec, curr);</span><br><span class="line">    update_min_vruntime(cfs_rq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u64 <span class="title">calc_delta_fair</span><span class="params">(u64 delta, struct sched_entity *se)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é»˜è®¤çš„ä¼˜å…ˆçº§ï¼ˆå†…éƒ¨ nice å€¼æ˜¯ 120ï¼‰ï¼Œé‚£ä¹ˆè™šæ‹Ÿè¿è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="comment">// å°±æ˜¯çœŸå®è¿è¡Œæ—¶é—´ã€‚å¦åˆ™ï¼Œä¼šåŸºäº `__calc_delta` è®¡ç®—å‡ºè™šæ‹Ÿè¿è¡Œæ—¶é—´ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (unlikely(se-&gt;load.weight != NICE_0_LOAD))</span><br><span class="line">        <span class="comment">// è¯¥è®¡ç®—è¿‡ç¨‹åŸºæœ¬ç­‰åŒäºï¼š</span></span><br><span class="line">        <span class="comment">// delta = delta_exec * NICE_0_LOAD / cur-&gt;load.weight;</span></span><br><span class="line">        delta = __calc_delta(delta, NICE_0_LOAD, &amp;se-&gt;load);</span><br><span class="line">    <span class="keyword">return</span> delta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_min_vruntime</span><span class="params">(struct cfs_rq *cfs_rq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 vruntime = cfs_rq-&gt;min_vruntime;</span><br><span class="line">    <span class="keyword">if</span> (cfs_rq-&gt;curr)</span><br><span class="line">        <span class="comment">// å¦‚æœæ­¤æ—¶æœ‰ä»»åŠ¡åœ¨è¿è¡Œï¼Œå°±æ›´æ–°æœ€å°è¿è¡Œæ—¶é—´ä¸ºå½“å‰ä»»åŠ¡çš„ vruntime</span></span><br><span class="line">        vruntime = cfs_rq-&gt;curr-&gt;vruntime;</span><br><span class="line">    <span class="keyword">if</span> (cfs_rq-&gt;rb_leftmost)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è°ƒåº¦å•å…ƒ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *<span class="title">se</span> = <span class="title">rb_entry</span>(<span class="title">cfs_rq</span>-&gt;<span class="title">rb_leftmost</span>,</span></span><br><span class="line"><span class="class">                                           <span class="title">struct</span> <span class="title">sched_entity</span>,</span></span><br><span class="line"><span class="class">                                           <span class="title">run_node</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (!cfs_rq-&gt;curr)</span><br><span class="line">            vruntime = se-&gt;vruntime;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// ä¿è¯ min_vruntime æ˜¯äºŒè€…ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªå€¼</span></span><br><span class="line">            vruntime = min_vruntime(vruntime, se-&gt;vruntime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¹‹æ‰€ä»¥å»äºŒè€…ä¹‹é—´çš„æœ€å¤§å€¼ï¼Œæ˜¯ä¸ºäº†ä¿è¯ min_vruntime èƒ½å¤Ÿå•è°ƒå¢é•¿</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æƒ³æƒ³ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ</span></span><br><span class="line">    cfs_rq-&gt;min_vruntime = max_vruntime(cfs_rq-&gt;min_vruntime, vruntime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æœ€åï¼Œæ¥æ€»ç»“ä¸‹ä½¿ç”¨è™šæ‹Ÿæ—¶é’Ÿçš„æ„ä¹‰ï¼š</p><ul><li>å½“ä»»åŠ¡è¿è¡Œæ—¶ï¼Œå®ƒçš„è™šæ‹Ÿæ—¶é—´æ€»æ˜¯ä¼šå¢åŠ ï¼Œä»è€Œä¿è¯å®ƒä¼šè¢«ç§»åŠ¨åˆ°çº¢é»‘æ ‘çš„å³ä¾§ï¼›</li><li>å¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè™šæ‹Ÿæ—¶é’Ÿçš„èŠ‚æ‹æ›´æ…¢ï¼Œä»è€Œè®©å®ƒç§»åŠ¨åˆ°çº¢é»‘æ ‘å³ä¾§çš„é€Ÿåº¦å°±è¶Šæ…¢ï¼Œå› æ­¤å®ƒä»¬è¢«å†æ¬¡è°ƒåº¦çš„æœºä¼šå°±æ›´å¤§äº›ã€‚<br><img src="https://pic3.zhimg.com/v2-bcc1970ab1806342e946bf4e9b6ff1d7.jpg" alt=""></li></ul><h3 id="é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡"><a href="#é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡" class="headerlink" title="é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡"></a>é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡</h3><p>CFS å¯ä»¥åœ¨çº¢é»‘æ ‘ä¸­ä¸€ç›´æ‰¾åˆ°æœ€å·¦ï¼ˆleftmostï¼‰è¾¹çš„èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªè¿è¡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯çœŸæ­£å®ç° <code>__pick_first_entity()</code> çš„å‡½æ•°å…¶å®å¹¶æ²¡æœ‰çœŸæ­£åœ°æ‰§è¡ŒæŸ¥æ‰¾ï¼ˆè™½ç„¶å¯ä»¥åœ¨ O(log(N)) æ—¶é—´å†…æ‰¾åˆ°ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼ˆå®Œæ•´å®šä¹‰ä½äº <code>&lt;kernel/sched/fair.c&gt;</code>ï¼‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> *__<span class="title">pick_first_entity</span>(<span class="title">struct</span> <span class="title">cfs_rq</span> *<span class="title">cfs_rq</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// å…¶å®è¿™é‡Œå–çš„æ˜¯ç¼“å­˜çš„ leftmost èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ‰§è¡Œå°±ä¼šæ›´å¿«äº†</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">left</span> = <span class="title">cfs_rq</span>-&gt;<span class="title">rb_leftmost</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!left)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> rb_entry(left, struct sched_entity, run_node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="å®æ—¶è°ƒåº¦å™¨"><a href="#å®æ—¶è°ƒåº¦å™¨" class="headerlink" title="å®æ—¶è°ƒåº¦å™¨"></a>å®æ—¶è°ƒåº¦å™¨</h2><p>Linux å®æ—¶ä»»åŠ¡è°ƒåº¦å™¨å®ç°ä½äº <code>&lt;kernel/sched/rt.c</code>ï¼Œå¯¹äºç³»ç»Ÿè€Œè¨€ï¼Œå®æ—¶ä»»åŠ¡å±äºè´µå®¢ï¼Œä¸€æ—¦å­˜åœ¨å®æ—¶ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œé‚£å°±åº”å½“å°½å¯èƒ½åŠæ—¶åœ°ä¸ºå®ƒä»¬æœåŠ¡ã€‚å¯¹äºå®æ—¶ä»»åŠ¡è€Œè¨€ï¼Œæœ‰ä¸¤ç§è°ƒåº¦ç­–ç•¥å­˜åœ¨ï¼š</p><ul><li><p><code>SCHED_FIFO</code>: è¿™ä¸ªå…¶å®å°±æ˜¯ä¸€ä¸ªå…ˆåˆ°å…ˆæœåŠ¡çš„è°ƒåº¦ç®—æ³•ã€‚è¿™ç±»ä»»åŠ¡æ²¡æœ‰æ—¶é—´ç‰‡é™åˆ¶ï¼Œå®ƒä»¬ä¼šä¸€ç›´è¿è¡Œç›´åˆ°é˜»å¡æˆ–è€…ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œäº¦æˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡æŠ¢å ã€‚è¯¥ç±»ä»»åŠ¡æ€»ä¼šæŠ¢å  <code>SCHED_NORMAL</code> ä»»åŠ¡ã€‚å¦‚æœå¤šä¸ªä»»åŠ¡å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ï¼Œé‚£å®ƒä»¬ä¼šä»¥è½®è¯¢çš„æ–¹å¼è°ƒåº¦ï¼ˆä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œä¼šè¢«æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œï¼‰ï¼›</p></li><li><p><code>SCHED_RR</code>: è¿™ç§ç­–ç•¥ç±»ä¼¼äº <code>SCHED_FIFO</code>ï¼Œåªæ˜¯å¤šäº†æ—¶é—´ç‰‡é™åˆ¶ã€‚ç›¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šä»¥è½®è¯¢çš„æ–¹å¼è¢«è°ƒåº¦ï¼Œæ¯ä¸ªè¿è¡Œçš„ä»»åŠ¡éƒ½ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å…¶ç”¨å…‰è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œæˆ–è€…è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æŠ¢å ã€‚å½“ä»»åŠ¡çš„æ—¶é—´ç‰‡ç”¨å…‰åï¼Œå®ƒä¼šé‡æ–°è¡¥å……èƒ½é‡ï¼Œå¹¶è¢«åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚é»˜è®¤çš„æ—¶é—´ç‰‡æ˜¯ 100msï¼Œå¯ä»¥åœ¨ <code>&lt;include/linux/sched/rt.h&gt;</code> æ‰¾åˆ°å…¶å®šä¹‰ã€‚</p></li></ul><p>å®æ—¶ä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯é™æ€çš„ï¼Œä¸ä¼šåƒä¹‹å‰æåˆ°çš„ç®—æ³•ï¼Œä¼šé‡æ–°è®¡ç®—ä»»åŠ¡ä¼˜å…ˆçº§ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ <code>chrt</code> å‘½ä»¤æ›´æ”¹ä»»åŠ¡ä¼˜å…ˆçº§ã€‚</p><h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p>å®æ—¶ä»»åŠ¡æœ‰è‡ªå·±çš„è°ƒåº¦å•å…ƒæ•°æ®ç»“æ„ï¼ˆä½äº <code>&lt;include/linux/sched.h&gt;</code>ï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">run_list</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> timeout;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> watchdog_stamp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> time_slice;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> *<span class="title">back</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> *<span class="title">parent</span>;</span></span><br><span class="line">    <span class="comment">/* rq on which this entity is (to be) queued: */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span> *<span class="title">rt_rq</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><code>SCHED_FIFO</code> çš„æ—¶é—´ç‰‡æ˜¯ 0ï¼Œå¯ä»¥åœ¨ <code>&lt;kernel/sched/rt.c&gt;</code> ä¸­çœ‹åˆ°å…·ä½“å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sched_rr_timeslice = RR_TIMESLICE;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">get_rr_interval_rt</span><span class="params">(struct rq *rq,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       struct task_struct *task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task-&gt;policy == SCHED_RR)</span><br><span class="line">        <span class="keyword">return</span> sched_rr_timeslice;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">è€Œå…³äºè¿è¡Œé˜Ÿåˆ—çš„å®šä¹‰å¦‚ä¸‹ï¼š</span><br><span class="line">```c</span><br><span class="line"><span class="comment">/* Real-Time classes' related field in a runqueue: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_rq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å®æ—¶ä»»åŠ¡éƒ½ä¿å­˜åœ¨ `active.queue[prio]` é“¾è¡¨ä¸­</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_prio_array</span> <span class="title">active</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rt_nr_running;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span>;</span> <span class="comment">/* main runqueue */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* This is the priority-queue data structure of the RT scheduling class:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_prio_array</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* include 1 bit for delimiter */</span></span><br><span class="line">    <span class="comment">// ç±»ä¼¼ O(1) è°ƒåº¦å™¨ï¼Œä½¿ç”¨ä½å›¾æ¥æ ‡è®°å¯¹åº”ä¼˜å…ˆçº§çš„é“¾è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">    DECLARE_BITMAP(bitmap, MAX_RT_PRIO + <span class="number">1</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>[<span class="title">MAX_RT_PRIO</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ç±»ä¼¼äº CFS ä¸­çš„ <code>update_curr()</code> å‡½æ•°ï¼Œ<code>update_curr_rt()</code> å‡½æ•°ç”¨æ¥è·Ÿè¸ªå®æ—¶ä»»åŠ¡çš„ CPU å ç”¨æƒ…å†µï¼Œæ”¶é›†ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ›´æ–°æ—¶é—´ç‰‡ç­‰ï¼Œä½†è¿™é‡Œä½¿ç”¨çš„æ˜¯çœŸå®æ—¶é—´ï¼Œè€Œæ²¡æœ‰è™šæ‹Ÿæ—¶é—´çš„æ¦‚å¿µã€‚å®Œæ•´å®šä¹‰å¯ä»¥å‚è€ƒ <a href="https://github.com/torvalds/linux/blob/a6ed68d6468bd5a3da78a103344ded1435fed57a/kernel/sched/rt.c#L955" target="_blank" rel="noopener">kernel/sched/rt.c#L955</a>ã€‚</p><h2 id="BFS-amp-MuqSS"><a href="#BFS-amp-MuqSS" class="headerlink" title="BFS &amp; MuqSS"></a>BFS &amp; MuqSS</h2><p>å…³äº BFS å’Œ MuqSS çš„ç²¾å½©ä»‹ç»å¯ä»¥å‚è€ƒ <a href="https://mp.weixin.qq.com/s/kI3pFJ3qUgQJ2P_--G3ehQ" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚<br>æ€»ä½“æ¥è¯´ï¼ŒBFS æ˜¯ä¸€ä¸ªé€‚ç”¨äºæ¡Œé¢æˆ–ç§»åŠ¨è®¾å¤‡çš„è°ƒåº¦å™¨ï¼Œè®¾è®¡åœ°æ¯”è¾ƒç®€æ´ï¼Œç”¨äºæ”¹å–„æ¡Œé¢åº”ç”¨çš„äº¤äº’æ€§ï¼Œå‡å°å“åº”æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚å®ƒé‡‡ç”¨äº†å…¨å±€å•ä»»åŠ¡é˜Ÿåˆ—è®¾è®¡ï¼Œä¸å†è®©æ¯ä¸ª CPU éƒ½æœ‰ç‹¬ç«‹çš„è¿è¡Œé˜Ÿåˆ—ã€‚è™½ç„¶ä½¿ç”¨å•ä¸ªå…¨å±€é˜Ÿåˆ—ï¼Œéœ€è¦å¼•å…¥é˜Ÿåˆ—é”æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ï¼Œä½†æ˜¯å¯¹äºæ¡Œé¢ç³»ç»Ÿè€Œè¨€ï¼Œå¤„ç†å™¨é€šå¸¸éƒ½æ¯”è¾ƒå°‘ï¼Œé”çš„å¼€é”€åŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚BFS æ¯æ¬¡ä¼šåœ¨ä»»åŠ¡é“¾è¡¨ä¸­é€‰æ‹©å…·æœ‰æœ€å° virtual deadline çš„ä»»åŠ¡è¿è¡Œã€‚</p><p>MuqSS æ˜¯ä½œè€…åæ¥åŸºäº BFS æ”¹è¿›çš„ä¸€æ¬¾è°ƒåº¦å™¨ï¼ŒåŒæ ·æ˜¯ç”¨äºæ¡Œé¢ç¯å¢ƒä»»åŠ¡è°ƒåº¦ã€‚å®ƒä¸»è¦è§£å†³äº† BFS çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>æ¯æ¬¡éœ€è¦åœ¨å¯¹åº”ä¼˜å…ˆçº§é“¾è¡¨ä¸­éå†æŸ¥æ‰¾éœ€è¦æ‰§è¡Œä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚æ‰€ä»¥æ–°çš„è°ƒåº¦å™¨å¼•å…¥äº†è·³è¡¨æ¥è§£å†³è¯¥é—®é¢˜ï¼Œä»è€Œå°†æ—¶é—´å¤æ‚åº¦é™ä½åˆ° O(1)ã€‚</li><li>å…¨å±€é”äº‰å¤ºçš„å¼€é”€ä¼˜åŒ–ï¼Œé‡‡ç”¨ <code>try_lock</code> æ›¿ä»£ <code>lock</code>ã€‚<br><img src="https://mmbiz.qpic.cn/mmbiz_png/Ass1lsY6bytXicPsWIWNWxe47NbURjISJ8rdLqdPkHHW9vngCa5CojQPoI8s7f3f2V6I1OMBJXB1rbOhlmb6wrg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""></li></ol><h1 id="æ·±å…¥å­¦ä¹ "><a href="#æ·±å…¥å­¦ä¹ " class="headerlink" title="æ·±å…¥å­¦ä¹ "></a>æ·±å…¥å­¦ä¹ </h1><ul><li>ã€ŠLinux è®¾è®¡ä¸å®ç° ç¬¬ä¸‰ç‰ˆã€‹è¿›ç¨‹è°ƒåº¦ç« èŠ‚</li><li><a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a></li><li><a href="https://oska874.gitbooks.io/process-scheduling-in-linux/chapter1.html" target="_blank" rel="noopener">Process Scheduling in Linux</a></li><li><a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">å†…æ ¸æ–‡æ¡£ï¼šCFS Scheduler è®¾è®¡</a></li><li>Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹<ul><li>å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</li><li>Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„</li></ul></li><li><a href="https://opensource.com/article/19/2/fair-scheduling-linux" target="_blank" rel="noopener">Linux å…¬å¹³è°ƒåº¦</a><ul><li>å¯¹æ¯”äº†ä¼ ç»Ÿè°ƒåº¦å™¨å’Œ CFS çš„åŒºåˆ«</li><li>ç®€å•ä»‹ç»äº† CFS çš„å®ç°</li></ul></li><li><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" target="_blank" rel="noopener">The Battle of Schedulers: FreeBSD ULE vs Linux CFS</a><ul><li>é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ†</li><li>å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ</li></ul></li><li><a href="https://zhuanlan.zhihu.com/p/33621500" target="_blank" rel="noopener">NUMA æ¶æ„æ·±ç©¶</a><ul><li>æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„</li><li>NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³»</li></ul></li><li><a href="https://jin-yang.github.io/post/linux-kernel-scheduler.html" target="_blank" rel="noopener">Kernel è°ƒåº¦ç³»ç»Ÿ</a><ul><li>é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—®</li><li>vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ</li><li>vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ</li></ul></li><li><a href="https://mp.weixin.qq.com/s/kI3pFJ3qUgQJ2P_--G3ehQ" target="_blank" rel="noopener">ä¸¤ä¸ªéå¸¸æœ‰æ„æ€çš„é€‚åˆæ¡Œé¢ä½¿ç”¨çš„ Linux task è°ƒåº¦å™¨: BFS å’Œ MuqSS</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;em&gt;Linux Kernel Development&lt;/em&gt; ä¸€ä¹¦ä¸­ï¼Œå…³äº Linux çš„è¿›ç¨‹è°ƒåº¦å™¨å¹¶æ²¡æœ‰è®²è§£çš„å¾ˆæ·±å…¥ï¼Œåªæ˜¯æåˆ°äº† CFS è°ƒåº¦å™¨çš„åŸºæœ¬æ€æƒ³å’Œä¸€äº›å®ç°ç»†èŠ‚ï¼›å¹¶æ²¡æœ‰ Linux æ—©æœŸçš„è°ƒåº¦å™¨ä»‹ç»ï¼Œä»¥åŠæœ€è¿‘è¿™äº›å¹´æ–°å¢çš„åœ¨å†…æ ¸æºç æ ‘å¤–ç»´æŠ¤çš„è°ƒåº¦å™¨æ€æƒ³ã€‚æ‰€ä»¥åœ¨ç»è¿‡ä¸€ç•ªæœå¯»åï¼Œçœ‹åˆ°äº†è¿™ç¯‡è®ºæ–‡ &lt;a href=&quot;https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;A complete guide to Linux process scheduling&lt;/a&gt;ï¼Œå¯¹ Linux çš„è°ƒåº¦å™¨å†å²è¿›è¡Œäº†å›é¡¾ï¼Œå¹¶ä¸”ç›¸å¯¹ç»†è‡´åœ°è®²è§£äº† CFS è°ƒåº¦å™¨ã€‚æ•´ä½“æ¥è¯´ï¼Œè™½ç„¶æ¯”è¾ƒå•°å—¦ï¼Œä½†æ˜¯å¯¹äºæƒ³è¦çŸ¥é“æ›´å¤šç»†èŠ‚çš„æˆ‘æ¥è¯´éå¸¸é€‚åˆï¼Œæ‰€ä»¥å°±æœ‰äº†ç¿»è¯‘å®ƒçš„å†²åŠ¨ã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ è¿‡ç¨‹ä¹Ÿå‚è€ƒäº†å…¶å®ƒè®ºæ–‡ã€‚ä¸‹é¢å¼€å¯å­¦ä¹ ä¹‹æ—…å§~&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="/categories/Linux/"/>
    
    
      <category term="Linux" scheme="/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="CFS" scheme="/tags/CFS/"/>
    
  </entry>
  
  <entry>
    <title>Linux è°ƒåº¦å™¨å­¦ä¹ èµ„æ–™æ•´ç†</title>
    <link href="/2019/11/05/linux-kernel-scheduler-papers/"/>
    <id>/2019/11/05/linux-kernel-scheduler-papers/</id>
    <published>2019-11-05T13:18:35.000Z</published>
    <updated>2019-11-28T09:41:31.557Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><img src="https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f23_hd.png" alt=""></p><p>ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚<br><a id="more"></a><br>ä¸€ç›´ä»¥æ¥ï¼Œå„è·¯ Linux Hackers éƒ½å¸Œæœ›èƒ½ä¸º Linux æä¾›è¿™æ ·ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ¡Œé¢ç³»ç»Ÿä¸Šæœ‰è¾ƒå¥½çš„äº¤äº’æ€§ï¼Œè€Œåœ¨é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šæœ‰è¾ƒå¥½çš„ååé‡ã€‚</p><p>ä»¥ä¸‹åˆ—ä¸¾ä¸€äº›å­¦ä¹ èµ„æ–™ï¼Œå¯ä»¥è¿›ä¸€æ­¥äº†è§£ï¼</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li>è®ºæ–‡ï¼š<a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a>ï¼Œè¿™ç¯‡è®ºæ–‡è®²å¾—æ¯”è¾ƒå¥½ï¼Œå‡†å¤‡ç¿»è¯‘å‡ºæ¥ä»¥ä¾›æ¬£èµ</li><li>GitBook: <a href="https://oska874.gitbooks.io/process-scheduling-in-linux/chapter1.html" target="_blank" rel="noopener">Process Scheduling in Linux</a></li><li>å†…æ ¸æ–‡æ¡£ï¼š<a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux scheduler doc, CFS</a></li><li><p>Linux è¿›ç¨‹ä¸çº¿ç¨‹ï¼šã€ŠLinux ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œ ç¬¬ 28 ç« åŠåç»­ã€‹</p><ul><li>å¯ä»¥å…³æ³¨ä¸‹å’Œè¿›ç¨‹çº¿ç¨‹æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</li><li>Pthread çº¿ç¨‹æ˜¯æ€ä¹ˆåœ¨ Linux ä¸­å®ç°çš„</li></ul></li><li><p><a href="https://opensource.com/article/19/2/fair-scheduling-linux" target="_blank" rel="noopener">Linux å…¬å¹³è°ƒåº¦</a></p></li><li><p><a href="https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf" target="_blank" rel="noopener">The Battle of Schedulers: FreeBSD ULE vs Linux CFS</a></p><ul><li>é‡ç‚¹å¯ä»¥çœ‹ä¸‹å…³äº CFS çš„ç®€è¿° &amp; è´Ÿè½½å‡è¡¡éƒ¨åˆ†</li><li>å¯ä»¥ç®€å•çœ‹çœ‹ ULE æ˜¯çš„å®ç°åŸç†ï¼ˆinteractive, batch queueï¼‰ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šæœ‰é¥¿æ­»çš„æƒ…å†µ</li></ul></li><li><p><a href="https://zhuanlan.zhihu.com/p/33621500" target="_blank" rel="noopener">NUMA æ¶æ„æ·±ç©¶</a></p><ul><li>æ—©æœŸçš„ x86 æ˜¯ Universal Memory Arch, UMA æ¶æ„</li><li>NUMA æ¶æ„å‡ºæ¥åï¼Œè®¿é—®ä¸åŒå†…å­˜åœ°å€ï¼Œé€Ÿåº¦æ˜¯æœ‰å·®åˆ«äº†ï¼Œå’Œç¡¬ä»¶æ¶æ„æœ‰å¾ˆå¤§å…³ç³»</li></ul></li><li><p><a href="https://jin-yang.github.io/post/linux-kernel-scheduler.html" target="_blank" rel="noopener">Kernel è°ƒåº¦ç³»ç»Ÿ</a></p><ul><li>é‡ç‚¹å…³æ³¨ä½œè€…å…³äº CFS åˆ—å‡ºçš„å‡ ä¸ªçµé­‚æ‹·é—®</li><li>vruntime åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿæ”¹å˜ï¼Ÿ</li><li>vruntime åˆå§‹å€¼æ˜¯æ€ä¹ˆè®¾å®šçš„ï¼Ÿ</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://pic1.zhimg.com/80/v2-43f561d7d0646c34ed8c7bbf6fb52f23_hd.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç³»ç»Ÿä¸­çš„ CPU æ•°é‡æœ‰é™ï¼Œè€Œç”¨æˆ·å¸Œæœ›ã€ŒåŒæ—¶ã€å¾—åˆ°æœåŠ¡çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰å¸¸å¸¸ä¼šå¤šäºå¯ç”¨çš„ CPU æ ¸æ•°ï¼Œè¿™æ—¶å°±éœ€è¦èªæ˜çš„ä»»åŠ¡è°ƒåº¦å™¨æ¥ä¸ºæˆ‘ä»¬å®ç° CPU è™šæ‹ŸåŒ–ï¼Œè®©æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½å¾—åˆ°æœåŠ¡ã€‚è°ƒåº¦å™¨éœ€è¦ç…§é¡¾åˆ°ä»»åŠ¡çš„å“åº”æ—¶é—´ï¼ˆå¦åˆ™ç”¨æˆ·ä¼šåœ¨æ•²å‡»é”®ç›˜åç­‰å¾ˆä¹…ï¼Œä½“éªŒå¾ˆæ¸£ï¼‰ï¼Œè¿˜è¦ä¿è¯ä¸€å®šçš„å‘¨è½¬æ—¶é—´ï¼ˆCPU å¯†é›†å‹çš„ä»»åŠ¡æœŸæœ›è·å¾—æ›´å¤šçš„è¿ç»­è¿è¡Œæ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ CPU ç¼“å­˜äº²å’Œæ€§ï¼Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½æŸå¤±ï¼Œå°¤å…¶æ˜¯ç°ä»£ç³»ç»Ÿ TLB miss, Page Fault æƒ©ç½šéå¸¸ä¸¥é‡ï¼‰ï¼ŒåŒæ—¶è¿˜ä¸èƒ½è®©æŸäº›ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é¥¿æ­»ã€‚å¯è§è°ƒåº¦å™¨æ˜¯å®ç°å¤šä»»åŠ¡çš„æ ¸å¿ƒï¼Œç°ä»£æ“ä½œç³»ç»Ÿå¿…å¤‡ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="/categories/Linux/"/>
    
    
      <category term="Linux" scheme="/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="CFS" scheme="/tags/CFS/"/>
    
  </entry>
  
  <entry>
    <title>Linux Kernel Development å­¦ä¹ ä¸æ€»ç»“</title>
    <link href="/2019/10/30/linux-kernel-dev-notes/"/>
    <id>/2019/10/30/linux-kernel-dev-notes/</id>
    <published>2019-10-30T09:47:22.000Z</published>
    <updated>2019-11-28T09:41:31.556Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>æœ€è¿‘æŠ½æ—¶é—´æŠŠ <a href="http://pages.cs.wisc.edu/~remzi/OSTEP/" target="_blank" rel="noopener"><em>Operating Systems: Three Easy Pieces</em></a> ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´ ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆ<em>Linux Kernel Development</em>ï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚<br><a id="more"></a><br>åœ¨å­¦ä¹ ä¹‹å‰ï¼Œæ€è€ƒäº†ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥åœ¨å­¦ä¹ ä¸­æ¢ç´¢è¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼š</p><ol><li>Linux ä¸­è¿›ç¨‹ã€çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå„ç§è°ƒåº¦ç­–ç•¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li><li>å¹¶å‘é—®é¢˜è‚¯å®šéœ€è¦æ³¨æ„ï¼ŒLinux ä¸­å¦‚ä½•åº”å¯¹ç«æ€æ¡ä»¶ &amp; æ•°æ®ç«äº‰å‘¢ï¼Ÿå„ç§å¸¸è§çš„åŒæ­¥åŸè¯­åˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>Linux çš„å†…å­˜è™šæ‹ŸåŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå†…å­˜å¸ƒå±€ï¼Ÿè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Ÿ</li><li>æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ€ä¹ˆè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å¯¹ç”¨æˆ·æä¾›ä¸€è‡´ä¼˜é›…çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„å‘¢ï¼Ÿ</li><li>Linux å†…æ ¸ä¸­æœ‰å“ªäº›éå¸¸ç»å…¸çš„ç®—æ³•å’Œæ•°æ®ç»“æ„çš„åº”ç”¨ï¼Ÿå®ƒä»¬ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</li></ol><h1 id="Linux-å†…æ ¸ç®€ä»‹"><a href="#Linux-å†…æ ¸ç®€ä»‹" class="headerlink" title="Linux å†…æ ¸ç®€ä»‹"></a>Linux å†…æ ¸ç®€ä»‹</h1><p><img src="https://pic4.zhimg.com/80/v2-e0c1aced72034fd29160b2a0dbc73fa5_r.png" alt=""></p><p>è¯´åˆ° Linuxï¼Œå°±ä¸å¾—ä¸æåˆ°å®ƒçš„ç¥–å…ˆ Unix ç³»ç»Ÿã€‚Unix åœ¨ 1970 å¹´å·¦å³è¢« Ken Thompson é¦–å…ˆåœ¨ä¸€å° PDP-7 æœºå‹ä¸Šå®ç°ï¼Œè€Œåç§»æ¤åˆ° PDP-11 æœºå™¨ä¸Šï¼Œ1973 å¹´å®ƒè¢«ä½¿ç”¨ C è¯­è¨€é‡å†™ï¼Œæä¾›äº†æ›´åŠ å¼ºå¤§çš„å¯ç§»æ¤æ€§ã€‚</p><p>ç»è¿‡å¤šå¹´å‘å±•ï¼ŒUnix ç³»ç»Ÿæˆä¸ºäº†ä¸€ä¸ªå¼ºå¤§ã€å¥å£®ä¸”ç¨³å®šçš„æ“ä½œç³»ç»Ÿã€‚å…¶å¼ºå¤§çš„æ ¹æœ¬åŸå› å¦‚ä¸‹ï¼š</p><ol><li>ç®€æ´ï¼Œä»…æä¾›æ•°ç™¾ä¸ªè®¾è®¡ç›®æ ‡æ˜ç¡®çš„ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>æ‰€æœ‰çš„ä¸œè¥¿éƒ½è¢«å½“ä½œæ–‡ä»¶çœ‹å¾…</li><li>å¾ˆå¼ºçš„ç§»æ¤èƒ½åŠ›</li><li>è¿›ç¨‹åˆ›å»ºéå¸¸è¿…é€Ÿï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨</li><li>æ‹¥æœ‰ç®€å•ä¸”ç¨³å®šçš„è¿›ç¨‹é—´é€šä¿¡åŸè¯­</li></ol><p>Linux æ˜¯ç±» Unix ç³»ç»Ÿï¼Œå®ƒçš„å®ç°å’Œ Unix ä¹Ÿæœ‰ä¸€äº›å¤§ç›¸å¾„åº­çš„æ–¹é¢ï¼Œä½†æ˜¯å®ƒä¾ç„¶ç»§æ‰¿äº† Unix çš„è®¾è®¡ç›®æ ‡ï¼Œä¿è¯äº† API çš„ä¸€è‡´æ€§ï¼ˆæœ‰å“ä½çš„ç¨‹åºå‘˜éƒ½åº”è¯¥è¦å­¦ä¹ è¿™ä¸€æ€æƒ³ï¼‰ã€‚</p><p>Linux è¯æ±‡ä¸€èˆ¬ç”¨æ¥æŒ‡ä»£å†…æ ¸ã€‚å®ƒçš„åŸºç¡€åŒ…æ‹¬ï¼š</p><ol><li>å†…æ ¸</li><li>C åº“</li><li>å·¥å…·é›†</li><li>ç³»ç»Ÿçš„åŸºæœ¬å·¥å…·ï¼Œå¦‚ Shell</li></ol><p>ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿå®½æ³›çš„æ“ä½œç³»ç»Ÿæ˜¯æŒ‡æ•´ä¸ªç³»ç»Ÿä¸­è´Ÿè´£å®Œæˆæœ€åŸºæœ¬åŠŸèƒ½å’Œç³»ç»Ÿç®¡ç†çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬<strong>å†…æ ¸ã€è®¾å¤‡é©±åŠ¨ã€å¯åŠ¨å¼•å¯¼ç¨‹åºã€å‘½ä»¤è¡Œ Shell æˆ–ç”¨æˆ·ç•Œé¢ã€æ–‡ä»¶ç®¡ç†å·¥å…·å’Œç³»ç»Ÿå·¥å…·</strong>ã€‚å†…æ ¸åˆ™æ˜¯é‚£ä¸ªæœ€äº®çš„ä»”ï¼Œå®ƒé€šå¸¸ç”±å¦‚ä¸‹å‡ ä¸ªé‡è¦éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>ä¸­æ–­æœåŠ¡</li><li>ä»»åŠ¡è°ƒåº¦ç¨‹åº</li><li>å†…å­˜ç®¡ç†ç¨‹åº</li><li>ç½‘ç»œ</li><li>è¿›ç¨‹é—´é€šä¿¡ç­‰ç³»ç»ŸæœåŠ¡</li></ol><p>Linux çš„ä¸­æ–­æœåŠ¡æ˜¯ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªä¸æ‰€æœ‰è¿›ç¨‹æ— å…³ã€ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ç¬¬ä¸€æ—¶é—´èƒ½å¤Ÿå“åº”å’Œå¤„ç†ä¸­æ–­è¯·æ±‚ï¼Œç„¶åå¿«é€Ÿé€€å‡ºã€‚</p><p>å¤„ç†å™¨åœ¨ä»»æ„æ—¶é—´ç‚¹æ´»åŠ¨å¯æ¦‚æ‹¬ä¸ºä»¥ä¸‹ä¸‰ç§ä¹‹ä¸€ï¼š</p><ol><li>è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œç”¨æˆ·è¿›ç¨‹</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä»£è¡¨æŸä¸ªç‰¹å®šçš„è¿›ç¨‹æ‰§è¡Œï¼ˆå¦‚æŸä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸è¿›ç¨‹æ— å…³ï¼Œå¤„ç†ç‰¹å®šçš„ä¸­æ–­</li></ol><h2 id="å¾®å†…æ ¸å’Œå®å†…æ ¸"><a href="#å¾®å†…æ ¸å’Œå®å†…æ ¸" class="headerlink" title="å¾®å†…æ ¸å’Œå®å†…æ ¸"></a>å¾®å†…æ ¸å’Œå®å†…æ ¸</h2><p>è¿™ä¸ªæ˜¯æ¯”è¾ƒæœ‰è¶£çš„å†å²äº†ï¼Œæ“ä½œç³»ç»Ÿè®¾è®¡æœ‰ä¸¤å¤§ä¸»è¦é˜µè¥ï¼šå¾®å†…æ ¸å’Œå®å†…æ ¸ã€‚</p><p>å¾®å†…æ ¸çš„åŠŸèƒ½åˆ’åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æ˜¯ä¸€ä¸ªæœåŠ¡ï¼ˆC/S æ¨¡å‹ï¼ŒæœåŠ¡ä¸å†…æ ¸äº¤äº’ï¼‰ã€‚ç³»ç»Ÿé‡‡ç”¨ IPC ç¦æ­¢äº’é€šæ¶ˆæ¯ï¼Œäº’æ¢ã€ŒæœåŠ¡ã€ã€‚æœåŠ¡çš„ç‹¬ç«‹æ€§å¯ä»¥é¿å…ä¸€ä¸ªæœåŠ¡å¤±è´¥æ®ƒåŠå…¶å®ƒæœåŠ¡ã€‚æ¨¡å—åŒ–è®¾è®¡ä¹Ÿéå¸¸é€‚åˆçƒ­æ’æ‹”ã€‚ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯ IPC çš„å¼€é”€å¤šäºå‡½æ•°è°ƒç”¨ï¼ˆç±»æ¯”å¾®æœåŠ¡çš„ç½‘ç»œå¼€é”€å’Œåœ¨æœ¬åœ°è°ƒç”¨å‡½æ•°çš„å¼€é”€ï¼‰ã€‚</p><p>å®å†…æ ¸åˆ™æ˜¯å®ç”¨ä¸»ä¹‰è€…å–œæ¬¢çš„è®¾è®¡ï¼Œå®ƒæ˜¯æ¯”è¾ƒç®€å•çš„è®¾è®¡ï¼Œæ•´ä½“ä¸Šå°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿‡ç¨‹ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ã€‚å†…æ ¸ä¹‹é—´çš„é€šä¿¡å¾®ä¸è¶³é“ï¼Œæ€§èƒ½é«˜ã€‚</p><p>Linux è‡ªç„¶æ˜¯å®å†…æ ¸è®¾è®¡ï¼ŒLinux å†…æ ¸è¿è¡Œåœ¨å•ç‹¬çš„å†…æ ¸åœ°å€ç©ºé—´ä¸Šã€‚åŒæ—¶å®ƒä¹Ÿé‡‡çº³äº†å¾®å†…æ ¸çš„ç²¾åï¼Œä½¿å®ƒæˆä¸ºæ¨¡å—åŒ–çš„ã€å¤šçº¿ç¨‹çš„ä»¥åŠå†…æ ¸æœ¬èº«å¯è°ƒåº¦çš„æ“ä½œç³»ç»Ÿã€‚</p><h2 id="ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«"><a href="#ä¸ä¼ ç»Ÿ-Unix-åŒºåˆ«" class="headerlink" title="ä¸ä¼ ç»Ÿ Unix åŒºåˆ«"></a>ä¸ä¼ ç»Ÿ Unix åŒºåˆ«</h2><ol><li>æ”¯æŒåŠ¨æ€åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆè¿™ä¸ªä¸æ˜¯å¾®å†…æ ¸å®£ç§°çš„å¥½å¤„å—ï¼Ÿå’±ä¹Ÿæœ‰ï¼‰</li><li>æ”¯æŒå¯¹ç§°å¤šå¤„ç†æœºåˆ¶ï¼ˆSMPï¼‰</li><li>å†…æ ¸å¯ä»¥æŠ¢å ï¼ˆpreemptiveï¼‰ï¼šä»»åŠ¡å¯ä»¥æœ‰ä¼˜å…ˆçº§</li><li>å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒå¾ˆç‰¹åˆ«ï¼šå†…æ ¸ä¸åŒºåˆ†çº¿ç¨‹å’Œä¸€èˆ¬çš„è¿›ç¨‹ï¼Œå¯¹äºå†…æ ¸è€Œè¨€ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸€æ ·ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€äº›å…±äº«èµ„æºè€Œå·²</li><li>å…·æœ‰è®¾å¤‡ç±»çš„é¢å‘å¯¹è±¡çš„è®¾å¤‡æ¨¡å‹ã€çƒ­æ’æ‹”äº‹ä»¶ï¼Œç”¨æˆ·ç©ºé—´çš„è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ˆsysfsï¼‰</li><li>å¿½ç•¥äº†ä¸€äº›æ‹™åŠ£ç‰¹æ€§</li><li>è‡ªç”±ï¼šä»»ä½•æ”¹å˜éƒ½å¿…é¡»è¦èƒ½é€šè¿‡ç®€æ´çš„è®¾è®¡åŠæ­£ç¡®å¯é çš„å®ç°æ¥è§£å†³ç°å®ä¸­ç¡®å®å­˜åœ¨çš„é—®é¢˜</li></ol><h2 id="å†…æ ¸ç‰ˆæœ¬"><a href="#å†…æ ¸ç‰ˆæœ¬" class="headerlink" title="å†…æ ¸ç‰ˆæœ¬"></a>å†…æ ¸ç‰ˆæœ¬</h2><p><code>&lt;ä¸»ç‰ˆæœ¬&gt;.&lt;ä»ç‰ˆæœ¬&gt;.&lt;ä¿®è®¢&gt;[.&lt;ç¨³å®šç‰ˆæœ¬å·&gt;]</code>ï¼Œå…¶ä¸­<strong>ä»ç‰ˆæœ¬å·</strong>ä¸ºå¶æ•°ï¼Œåˆ™ä¸ºç¨³å®šç‰ˆæœ¬ï¼Œå¦åˆ™ä¸ºå¼€å‘ç‰ˆæœ¬ã€‚</p><h2 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h2><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>å¯ä»¥ä½¿ç”¨çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><code>make config</code></li><li><code>make menuconfig1</code></li><li><code>make gconfig</code></li><li>é»˜è®¤é…ç½®ï¼š<code>make defconfig</code></li></ol><p>éªŒè¯å’Œæ›´æ–°é…ç½®ï¼š<code>make oldconfig</code></p><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><ol><li>ç›´æ¥ç¼–è¯‘ï¼š<code>make</code></li><li>å¯¼å‡ºä¸å…³å¿ƒçš„ infoï¼š<code>make &gt;/dev/null</code></li><li>æŒ‡å®šå¹¶è¡Œç¼–è¯‘æ•°é‡ï¼š<code>make -j4 &gt;/dev/null</code></li></ol><h2 id="å†…æ ¸å¼€å‘ç‰¹ç‚¹"><a href="#å†…æ ¸å¼€å‘ç‰¹ç‚¹" class="headerlink" title="å†…æ ¸å¼€å‘ç‰¹ç‚¹"></a>å†…æ ¸å¼€å‘ç‰¹ç‚¹</h2><ol><li>ä¸èƒ½ä½¿ç”¨æ ‡å‡† C åº“</li><li><p>å¿…é¡»ä½¿ç”¨ GNU Cï¼ˆéœ€è¦ç”¨åˆ°å®ƒçš„ä¸€äº›æ‰©å±•ç‰¹æ€§ï¼‰</p><ol><li><code>inline</code>ï¼šé€šå¸¸å°†å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå‡½æ•°æœ¬èº«æ¯”è¾ƒçŸ­çš„å®šä¹‰æˆå†…è”å‡½æ•°ã€‚åœ¨å†…æ ¸ä¸­ï¼Œä¸ºäº†ç±»å‹å®‰å…¨å’Œæ˜“è¯»æ€§ï¼Œä¼˜å…ˆä½¿ç”¨ inline å‡½æ•°ï¼Œè€Œéå¤æ‚çš„å®</li><li>å†…è”ç¼–è¯‘ï¼šæ”¯æŒä½¿ç”¨ <code>asm()</code> åµŒå…¥æ±‡ç¼–ä»£ç </li><li>åˆ†æ”¯å£°æ˜ï¼šå¯ä»¥ä½¿ç”¨ <code>likely()</code> å’Œ <code>unlikely()</code> å£°æ˜åˆ†æ”¯æ˜¯å¦ç»å¸¸å‡ºç°æˆ–å¾ˆå°‘å‡ºç°ï¼ŒæŒ‡å¯¼ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ï¼ˆè¦ææ¸…æ¥šï¼Œå¦åˆ™ä¼˜åŒ–åè€Œå˜æˆäº†æ‹–ç´¯ï¼‰</li></ol></li><li><p>ç¼ºä¹åƒç”¨æˆ·ç©ºé—´ä¸­çš„å†…å­˜ä¿æŠ¤æœºåˆ¶</p><ol><li>å†…æ ¸ä¸­å‘ç”Ÿå†…å­˜é”™è¯¯ä¼šå¯¼è‡´ oopsï¼Œå†…æ ¸å¯èƒ½ä¼šæ­»æ‰</li><li>å†…æ ¸ä¸­çš„å†…å­˜æ˜¯<strong>ä¸åˆ†é¡µ</strong>çš„ï¼Œæ¯ç”¨æ‰ä¸€ä¸ªå­—èŠ‚ï¼Œç‰©ç†å†…å­˜å°±å‡å°‘ä¸€ä¸ªå­—èŠ‚</li></ol></li><li><p>éš¾ä»¥æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—</p><ol><li>ä¸èƒ½åƒç”¨æˆ·ç©ºé—´æ‰§è¡Œæµ®ç‚¹æ•°è®¡ç®—é‚£æ ·ï¼Œå¯ä»¥é€šè¿‡ trap çš„æ–¹å¼å°†æ•´æ•°æ¨¡å¼è½¬æ¢åˆ°æµ®ç‚¹æ•°æ¨¡å¼è®¡ç®—</li><li>å†…æ ¸ä¸èƒ½å®Œç¾æ”¯æŒæµ®ç‚¹æ•°è®¡ç®—ï¼Œæœ¬èº«ä¹Ÿæ— æ³•é™·å…¥ã€‚éè¦æ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦æ‰‹åŠ¨ä¿å­˜å’Œæ¢å¤æµ®ç‚¹å¯„å­˜å™¨ï¼Œéå¸¸éº»çƒ¦</li></ol></li><li><p>å†…æ ¸ç»™æ¯ä¸ªè¿›ç¨‹<strong>åªæœ‰ä¸€ä¸ªå¾ˆå°çš„å®šé•¿å †æ ˆ</strong></p><ol><li>ç”¨æˆ·ç©ºé—´çš„æ ˆå¯ä»¥åŠ¨æ€å¢é•¿ï¼Œå¯æ”¯æŒéå¸¸å¤§çš„æ•°æ®ç»“æ„</li><li>å†…æ ¸æ ˆçš„å¤§å°å’Œä½“ç³»ç»“æ„æœ‰å…³ï¼ˆå¦‚ x86 å¯ä»¥æ˜¯ 4KB/8KBï¼‰</li><li>å†å²ä¸Šæ¥è¯´ï¼Œå†…æ ¸æ ˆå¤§å°æ˜¯ä¸¤é¡µï¼Œ32 ä½æ˜¯ 8KBï¼Œ64 ä½æ˜¯ 16KBï¼›æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„æ ˆ</li></ol></li><li><p>ç”±äºè¦æ”¯æŒå¼‚æ­¥ä¸­æ–­ã€æŠ¢å å’Œ SMPï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å®‰å…¨å’ŒåŒæ­¥</p></li><li>è€ƒè™‘å¯ç§»æ¤æ€§<ol><li>ä¿æŒå­—èŠ‚åº</li><li>64 ä½å¯¹é½</li><li>ä¸å‡å®šå­—é•¿å’Œé¡µé¢é•¿åº¦</li></ol></li></ol><h1 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h1><h2 id="ç®¡ç†è¿›ç¨‹"><a href="#ç®¡ç†è¿›ç¨‹" class="headerlink" title="ç®¡ç†è¿›ç¨‹"></a>ç®¡ç†è¿›ç¨‹</h2><ol><li>å†…æ ¸æŠŠè¿›ç¨‹çš„åˆ—è¡¨å­˜æ”¾åœ¨ task list åŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ª entry çš„ç±»å‹æ˜¯ <code>task_struct</code>ï¼Œè¢«ç§°ä¸º <code>process descriptor</code></li><li>é€šè¿‡ slabï¼ˆæ›´æ–°çš„åº”è¯¥æ˜¯ SLUBï¼‰ åˆ†é…å™¨åˆ†é… task_struct ç»“æ„ä½“ï¼ˆå¯¹è±¡å¤ç”¨å’Œç¼“å­˜ç€è‰²ï¼‰ï¼Œæ¯ä¸ªä»»åŠ¡çš„ <code>thread_info</code> ä½äºå†…æ ¸æ ˆçš„å°¾ç«¯ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘ <code>task_struct</code> çš„æŒ‡é’ˆåŠå…¶å®ƒä¿¡æ¯</li><li>è¿›ç¨‹é€šè¿‡ PID è¿›è¡ŒåŒºåˆ†ï¼Œå…¶å€¼å­˜æ”¾åœ¨ <code>process descriptor</code> ä¸­ã€‚ç”±äºè¿›ç¨‹å¤„ç†ä»£ç éœ€è¦é¢‘ç¹è®¿é—® <code>task_struct</code> ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ PowerPC ç­‰æœºå™¨ä¸Šï¼Œæœ‰ä¸“é—¨çš„å¯„å­˜å™¨å­˜å‚¨äº†ç›¸åº”çš„æŒ‡é’ˆï¼›è€Œåœ¨ x86 ä½“ç³»ä¸‹ï¼Œåˆ™æ˜¯åˆ©ç”¨å†…æ ¸æ ˆå°¾åˆ›å»ºçš„ <code>thread_info</code>ï¼Œå¹¶å€ŸåŠ©åç§»è®¡ç®—é—´æ¥æŸ¥æ‰¾ <code>task_struct</code> ç»“æ„ä½“</li><li><p>è¿›ç¨‹çŠ¶æ€ï¼š</p><ol><li>TASK_RUNNING</li><li>TASK_INTERRUPTABLE</li><li>TASK_UNINTERRUPTABLE</li><li>__TASK_TRACED: è¢«å…¶å®ƒè¿›ç¨‹è·Ÿè¸ªçš„è¿›ç¨‹ï¼ˆå¦‚ ptrace å¯¹è°ƒè¯•ç¨‹åºè¿›è¡Œè·Ÿè¸ªï¼‰</li><li><p>__TASK_STOPPED: è¿›ç¨‹åœæ­¢æ‰§è¡Œï¼Œæ²¡æœ‰æŠ•å…¥è¿è¡Œä¹Ÿæ— æ³•æŠ•å…¥è¿è¡Œ</p><p><img src="https://pic2.zhimg.com/80/v2-ad2075f3f165ab1ab983605446be9b28_r.png" alt=""></p></li></ol></li><li><p>æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯ PID ä¸º 1 çš„ init è¿›ç¨‹çš„åä»£ï¼Œinit è¿›ç¨‹çš„æè¿°ç¬¦æ˜¯ä½œä¸º init_task é™æ€åˆ†é…çš„ï¼ˆæ¯”è¾ƒç‰¹æ®Šï¼‰</p></li><li><p>Unix ç³»ç»Ÿè¿›ç¨‹åˆ›å»ºï¼š</p><ol><li>é€šè¿‡ <code>fork()</code> æ‹·è´å½“å‰è¿›ç¨‹åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆåŒºåˆ«çˆ¶è¿›ç¨‹ï¼šæœ‰æ–°çš„ PIDï¼Œæœ‰æŸäº›èµ„æºå’Œç»Ÿè®¡é‡ï¼‰</li><li><code>exec()</code> å‡½æ•°è´Ÿè´£è¯»å–å¯æ‰§è¡Œæ–‡ä»¶å¹¶å°†å…¶è½½å…¥åœ°å€ç©ºé—´å¼€å§‹è¿è¡Œ</li></ol></li><li><p>å†™æ—¶æ‹·è´ï¼šå†…æ ¸å¹¶éå¼€å§‹å°±å¤åˆ¶æ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè€Œæ˜¯è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ‹·è´ï¼Œåªæœ‰åœ¨éœ€è¦å†™å…¥çš„æ—¶å€™ï¼Œæ•°æ®æ‰ä¼šè¢«å¤åˆ¶ï¼Œä»è€Œæ‹¥æœ‰å„è‡ªçš„æ‹·è´ã€‚<code>fork()</code> å®é™…å¼€é”€ï¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œç»™å­è¿›ç¨‹åˆ›å»ºå”¯ä¸€çš„è¿›ç¨‹æè¿°ç¬¦</p></li><li>Linux ä¸­çš„ <code>fork()</code> å’Œ <code>vfork()</code> éƒ½æ˜¯é€šè¿‡ <code>clone()</code> ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚<code>vfork()</code> çš„ç‰¹ç‚¹æ˜¯ï¼šä¸æ‹·è´çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä¸”å­è¿›ç¨‹ä½œä¸ºçˆ¶è¿›ç¨‹çš„å•ç‹¬çº¿ç¨‹åœ¨å®ƒçš„åœ°å€ç©ºé—´æ‰§è¡Œï¼Œçˆ¶è¿›ç¨‹é˜»å¡ç›´åˆ°å­è¿›ç¨‹é€€å‡ºæˆ–æ‰§è¡Œ <code>exec()</code></li><li><p>Linux ä¸­çš„çº¿ç¨‹å®ç°ï¼š</p><ol><li>ä»å†…æ ¸è§’åº¦çœ‹ï¼Œæ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹çœ‹å¾…ï¼Œåªæ˜¯ä¸å…¶å®ƒè¿›ç¨‹å…±äº«æŸäº›èµ„æºã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰å±äºè‡ªå·±çš„ task_struct</li><li>å…¶å®ƒç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹è¢«æŠ½è±¡æˆä¸€ç§è€—è´¹èµ„æºè¾ƒå°‘çš„èµ„æºï¼Œè¿è¡Œè¿…é€Ÿçš„æ‰§è¡Œå•å…ƒ</li><li>é€šè¿‡ <code>clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, 0);</code> åˆ›å»ºçº¿ç¨‹</li><li>å¯¹æ¯” <code>fork()</code> å®ç°ï¼š<code>clone(SIGCHLD, 0)</code></li><li>å¯¹æ¯” <code>vfork()</code> å®ç°ï¼š<code>clone(CLONE_VFORK | CLONE_VM | SIGCHLD, 0)</code></li></ol></li><li><p>å†…æ ¸çº¿ç¨‹ï¼š</p><ol><li>å†…æ ¸é€šå¸¸éœ€è¦åœ¨åå°æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè¿™äº›ä»»åŠ¡å¯é€šè¿‡ kernel thread å®Œæˆã€‚è¿™ç§æ˜¯è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„æ ‡å‡†è¿›ç¨‹</li><li>å†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¯è¢«è°ƒåº¦ï¼Œå¯è¢«æŠ¢å </li></ol></li><li><p>è¿›ç¨‹ç»ˆç»“ï¼š</p><ol><li>é€šå¸¸é€šè¿‡ <code>do_exit()</code> å®Œæˆé€€å‡ºï¼ŒæœŸé—´ä¼šé‡Šæ”¾ç›¸å…³çš„èµ„æºï¼Œæœ€ç»ˆå°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º <code>EXIT_ZOMBIE</code>ï¼Œä½†æ˜¯æ­¤æ—¶çš„å†…æ ¸æ ˆã€thread_info å’Œ task_struct ç»“æ„ä½“è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä»è€Œç»™çˆ¶è¿›ç¨‹æä¾›ä¿¡æ¯</li><li>çˆ¶è¿›ç¨‹è·å¾—å·²ç»ˆç»“çš„å­è¿›ç¨‹ä¿¡æ¯åï¼ˆçˆ¶è¿›ç¨‹å¯é€šè¿‡ <code>wait()</code> ç³»ç»Ÿè°ƒç”¨æ”¶é›†ä¿¡æ¯ï¼‰ï¼Œæˆ–è€…é€šçŸ¥å†…æ ¸å®ƒä¸å…³æ³¨è¿™äº›ä¿¡æ¯ï¼Œæ‰ä¼šé‡Šæ”¾å‰©ä½™çš„å†…å­˜ç©ºé—´</li></ol></li><li><p>å­¤å„¿è¿›ç¨‹ï¼š</p><ol><li>é€€å‡ºæ—¶æ°¸è¿œå¤„äºåƒµæ­»çŠ¶æ€ï¼Œç™½ç™½æµªè´¹å†…å­˜</li><li>è§£å†³åŠæ³•å°±æ˜¯åœ¨å½“å‰çº¿ç¨‹ç»„å¯»æ‰¾æŸä¸ªçº¿ç¨‹ä½œä¸ºçˆ¶äº²ï¼Œå®åœ¨ä¸è¡Œï¼Œå°±è®© init æ¥ç›˜</li></ol></li></ol><h2 id="è°ƒåº¦è¿›ç¨‹"><a href="#è°ƒåº¦è¿›ç¨‹" class="headerlink" title="è°ƒåº¦è¿›ç¨‹"></a>è°ƒåº¦è¿›ç¨‹</h2><ol><li><p>å¤šä»»åŠ¡ç³»ç»Ÿåˆ†ä¸ºä¸¤ç±»ï¼š</p><ol><li>éæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆcooperative multitaskingï¼‰</li><li>æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆpreemptive multitaskingï¼‰</li></ol></li><li><p>è¿›ç¨‹è°ƒåº¦ç­–ç•¥ä¼šå…³å¿ƒè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡</p></li><li>Linux ä¸­çš„è¿›ç¨‹åˆ†ä¸ºæ™®é€šè¿›ç¨‹å’Œå®æ—¶è¿›ç¨‹ï¼Œå…¶ä¸­å‰è€…çš„ä¼˜å…ˆçº§åœ¨ (-20, +19ï¼‰ï¼Œè€Œåè€…åˆ™æ˜¯ (0, 99)ã€‚æ­¤å¤–ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºæ™®é€šè¿›ç¨‹ä¼˜å…ˆçº§çš„ï¼Œæ‰€ä»¥æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜ å°„è¿‡æ¥å°±æ˜¯ (100, 139)</li><li>Linux ä¸­å¯ä»¥é€šè¿‡ <code>nice</code> è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¶Šå°çš„å€¼æ‹¥æœ‰è¶Šé«˜çš„æƒé‡ï¼›åä¹‹ï¼Œåˆ™æƒé‡è¶Šä½ï¼ˆä½“ç°åœ¨æ—¶é—´ç‰‡ä¸Šï¼‰</li></ol><h3 id="CFS-è°ƒåº¦å™¨"><a href="#CFS-è°ƒåº¦å™¨" class="headerlink" title="CFS è°ƒåº¦å™¨"></a>CFS è°ƒåº¦å™¨</h3><ol><li>Linux 2.6 å†…æ ¸å¼•å…¥äº† CFS è°ƒåº¦å™¨ï¼ˆä½äº <code>sched/fair.c</code>ï¼‰ä½œä¸ºæ™®é€šè¿›ç¨‹çš„è°ƒåº¦å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿‘ä¹å®Œç¾çš„å…¬å¹³è°ƒåº¦å™¨ï¼ˆæƒè¡¡å‘¨è½¬æ—¶é—´å’Œå“åº”æ—¶é—´ï¼‰ã€‚å¹¶éé‡‡ç”¨æ—¶é—´ç‰‡è¿›è¡Œåˆ†é…ï¼Œè€Œæ˜¯ç»™è¿›ç¨‹åˆ†é…äº†å¤„ç†å™¨ä½¿ç”¨çš„æ¯”é‡ï¼Œä»è€Œç¡®ä¿è¿›ç¨‹è°ƒåº¦ä¸­èƒ½å¤Ÿæœ‰æ’å®šçš„å…¬å¹³æ€§ï¼Œä»è€Œå°†åˆ‡æ¢é¢‘ç‡ç½®äºä¸æ–­å˜åŠ¨ä¸­</li><li>CFS åŸºäºä¸€ä¸ªç®€å•çš„ç†å¿µï¼šè¿›ç¨‹è°ƒåº¦çš„æ•ˆæœåº”è¯¥ç­‰åŒäºç³»ç»Ÿæ‹¥æœ‰ä¸€ä¸ªå®Œç¾çš„å¤šä»»åŠ¡å¤„ç†å™¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½èƒ½è·å¾— 1/n_running å¤„ç†å™¨æ—¶é—´</li><li>CFS å…è®¸æ¯ä¸ªè¿›ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå¾ªç¯è½®è½¬ï¼Œæ€»æ˜¯é€‰æ‹© vruntime æœ€å°çš„è¿›ç¨‹ä½œä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯é€šè¿‡æ‰€æœ‰å¯è¿è¡Œç»å¸¸æ€»æ•°ä¸ºåŸºç¡€æ¥è®¡ç®—å‡ºè¿›ç¨‹åº”è¯¥è¿è¡Œå¤šä¹…ï¼Œè€Œéä¾é  nice å€¼æ¥è®¡ç®—æ—¶é—´ç‰‡ï¼ˆä¼ ç»Ÿçš„åšæ³•å°±æ˜¯è¿™ç§ï¼‰</li><li>è°ƒåº¦å™¨å®ç°æ¦‚è¦ï¼š<ol><li><code>sched_entity</code> ç»“æ„ä½“è·Ÿè¸ªè¿è¡Œè®°è´¦ï¼ˆå…¶ä¸­åŒ…å« vruntimeï¼‰</li><li>æ‰€æœ‰å¯è¿è¡Œçš„è¿›ç¨‹éƒ½ä½äºä¸€æ£µé»‘çº¢æ ‘ä¸­ï¼ˆO(logN) æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾ï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½ä¼šä»æ ‘çš„æœ€å·¦å¶å­èŠ‚ç‚¹ä¸Šï¼ˆleftmostï¼‰æ‰¾åˆ° vruntime æœ€å°çš„é‚£ä¸ªè¿›ç¨‹è¿è¡Œï¼ˆå®æ—¶ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯æå‰ç¼“å­˜å¥½çš„ï¼‰</li><li>è°ƒåº¦å™¨å…¥å£å¤„ä¼šæ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„è°ƒåº¦ç±»ï¼Œç„¶åè·å–åˆ°è°æ˜¯ä¸‹ä¸€ä¸ªè¯¥è¿è¡Œçš„è¿›ç¨‹</li><li>ç¡çœ ï¼šè¿›ç¨‹ä¼šæŠŠè‡ªå·±æ ‡è®°æˆä¼‘çœ çŠ¶æ€ï¼Œä»å¯æ‰§è¡Œçº¢é»‘æ ‘ä¸­æº¢å‡ºï¼Œå¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè°ƒç”¨ <code>schedule()</code> æ‰§è¡Œä¸€ä¸ªå…¶ä»–è¿›ç¨‹</li><li>å”¤é†’ï¼šè¿›ç¨‹è¢«è®¾ç½®ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ï¼Œä»ç­‰å¾…é˜Ÿåˆ—ç§»é™¤ï¼Œæ·»åŠ åˆ°å¯æ‰§è¡Œçº¢é»‘æ ‘</li></ol></li><li>CFS å®ç°äº†å¦‚ä¸‹å‡ ç§è°ƒåº¦ç­–ç•¥ï¼š<ol><li>SCHED_NORMALï¼ˆä»¥å‰å«åš SCHED_OTHERï¼‰ï¼šç”¨äºæ™®é€šä»»åŠ¡è°ƒåº¦</li><li>SCHED_BATCHï¼šå¹¶éåƒæ™®é€šä»»åŠ¡é‚£æ ·è¢«é¢‘ç¹æŠ¢å ï¼Œä¼šå°½å¯èƒ½å…è®¸ä»»åŠ¡è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ï¼Œä»è€Œåˆ©ç”¨ä¸Š CPU äº²å’Œæ€§ä»¥åŠæ›´å¥½åœ°å¤ç”¨ç¼“å­˜</li><li>SCHED_IDLEï¼šè¿™ç§ä»»åŠ¡ä¼˜å…ˆçº§æ¯” nice 19 è¿˜è¦ä½</li></ol></li></ol><h3 id="æŠ¢å "><a href="#æŠ¢å " class="headerlink" title="æŠ¢å "></a>æŠ¢å </h3><ol><li>ç”¨æˆ·æŠ¢å ï¼ˆæ£€æŸ¥ need_resched æ ‡è¯†ç¬¦ï¼‰ï¼šä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶ï¼›ä»ä¸­æ–­å¤„ç†è¿”å›ç”¨æˆ·ç©ºé—´æ—¶</li><li>å†…æ ¸æŠ¢å ï¼ˆthread_info ä¸­å­˜åœ¨ preemt_count è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰æ²¡æœ‰é”è¢«æŒæœ‰ï¼‰ï¼šå°±æ˜¯è°ƒåº¦ç¨‹åºèƒ½å¤Ÿåœ¨å†…æ ¸ä»»åŠ¡æ‰§è¡ŒæœŸé—´è¢«æ‰§è¡Œ<ol><li>åªè¦é‡æ–°è°ƒåº¦æ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰æŒæœ‰é”ï¼‰ï¼Œå†…æ ¸å°±å¯ä»¥åœ¨ä»»ä½•æ—¶é—´æŠ¢å æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li><li>å†…æ ¸æŠ¢å æ—¶æœºï¼š<ol><li>ä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨æ‰§è¡Œï¼Œä¸”è¿”å›å†…æ ¸ç©ºé—´ä¹‹å‰</li><li>å†…æ ¸ä»£ç å†æ¬¡å…·æœ‰å¯æŠ¢å æ€§æ—¶</li><li>å†…æ ¸ä»»åŠ¡æ˜¾å¼è°ƒç”¨ <code>schedule()</code></li><li>å†…æ ¸ä¸­çš„ä»»åŠ¡é˜»å¡ï¼ˆæ­¤æ—¶ä¼šå¯¼è‡´è°ƒç”¨ <code>schedule()</code>ï¼‰</li></ol></li></ol></li></ol><h3 id="å®æ—¶è°ƒåº¦å™¨"><a href="#å®æ—¶è°ƒåº¦å™¨" class="headerlink" title="å®æ—¶è°ƒåº¦å™¨"></a>å®æ—¶è°ƒåº¦å™¨</h3><ol><li>å®æ—¶è°ƒåº¦å™¨æ˜¯åœ¨ <code>sched/rt.c</code> ä¸­å®ç°çš„ï¼Œå®ƒä½¿ç”¨äº† 100 ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼ˆå¯¹åº” 1~99 ä»»åŠ¡ä¼˜å…ˆçº§ï¼‰ï¼Œå®ç°äº† SCHED_FIFO å’Œ SCHED_RR ç­–ç•¥ã€‚</li><li><p>SCHED_FIFO:</p><ol><li>ç®€å•çš„å…ˆå…¥å…ˆå‡ºè°ƒåº¦ç®—æ³•ï¼Œä¸ä¾èµ–æ—¶é—´ç‰‡</li><li>è¯¥çº§åˆ«ä»»åŠ¡æ¯” SCHED_NORMAL çº§åˆ«çš„è¿›ç¨‹å…ˆå¾—åˆ°è°ƒåº¦</li><li>ä¸€æ—¦ä»»åŠ¡å¤„äºæ‰§è¡ŒæœŸé—´ï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼›åªæœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ SCHED_FIFO/SCHED_RR ä»»åŠ¡æ‰å¯ä»¥æŠ¢å </li></ol></li><li><p>SCHED_RR:</p><ol><li>ç±»ä¼¼ FIFOï¼Œä½†æ˜¯æ¯ä¸ªä»»åŠ¡ä¼šæœ‰åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡è€—å°½åå°±è¦æ¢å…¶å®ƒä»»åŠ¡æ‰§è¡Œ</li><li>å¯¹äº FIFO è¿›ç¨‹ï¼Œé«˜ä¼˜å…ˆçº§å§‹ç»ˆæŠ¢å ä½ä¼˜å…ˆçº§è¿›ç¨‹ï¼›ä½ä¼˜å…ˆçº§è¿›ç¨‹ä¸èƒ½æŠ¢å  SCHED_RR è¿›ç¨‹ï¼Œå³ä¾¿å…¶è€—å°½äº†æ—¶é—´ç‰‡</li></ol></li><li><p>Linux æä¾›çš„æ˜¯è½¯å®æ—¶å·¥ä½œæ–¹å¼ï¼Œå°½åŠ›ä½¿å¾—è¿›ç¨‹èƒ½å¤Ÿåœ¨é™å®šçš„æ—¶é—´åˆ°æ¥å‰æ‰§è¡Œï¼Œä½†å†…æ ¸ä¸ä¿è¯æ€»èƒ½æ»¡è¶³è¿™äº›è¿›ç¨‹çš„è¦æ±‚</p></li></ol><h3 id="è°ƒåº¦å™¨ç±»"><a href="#è°ƒåº¦å™¨ç±»" class="headerlink" title="è°ƒåº¦å™¨ç±»"></a>è°ƒåº¦å™¨ç±»</h3><p>è°ƒåº¦å™¨ç±»éœ€è¦å®ç°ä¸€äº› hooksï¼Œè¿™æ ·å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™åšåˆé€‚çš„æ“ä½œã€‚éƒ¨åˆ† hooks å¦‚ä¸‹ï¼š</p><ul><li><code>enqueue_task</code></li><li><code>dequeue_task</code></li><li><code>yield_task</code></li><li><code>check_preempt_cur</code></li><li><code>pick_next_task</code></li><li><code>set_curr_task</code></li><li><code>task_tick</code></li></ul><h3 id="è°ƒåº¦ç›¸å…³çš„-syscall"><a href="#è°ƒåº¦ç›¸å…³çš„-syscall" class="headerlink" title="è°ƒåº¦ç›¸å…³çš„ syscall"></a>è°ƒåº¦ç›¸å…³çš„ syscall</h3><table><thead><tr><th>ç³»ç»Ÿè°ƒç”¨</th><th>æè¿°</th></tr></thead><tbody><tr><td>nice()</td><td>è®¾ç½®è¿›ç¨‹çš„ nice å€¼</td></tr><tr><td>sched_setscheduler()</td><td>è®¾ç½®è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_getscheduler()</td><td>è·å–è°ƒåº¦ç­–ç•¥</td></tr><tr><td>sched_setparam()</td><td>è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</td></tr><tr><td>sched_getparam()</td><td></td></tr><tr><td>sched_rr_get_interval()</td><td>æ—¶é—´ç‰‡å€¼</td></tr><tr><td>sched_setaffinity()</td><td>è®¾ç½®å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>sched_getaffinity()</td><td>è·å–è¿›ç¨‹å¤„ç†å™¨äº²å’ŒåŠ›</td></tr><tr><td>shced_yield()</td><td>æš‚æ—¶è®©å‡ºå¤„ç†å™¨</td></tr></tbody></table><h1 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œè¿›ç¨‹æ˜¯åœ¨æ“ä½œç³»ç»Ÿæä¾›çš„ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ï¼Œè€Œå¦‚æœéœ€è¦æ‰“å¼€æ–‡ä»¶ç­‰æ“ä½œï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥åˆ°å†…æ ¸æ€ï¼Œç”±æ“ä½œç³»ç»Ÿä»£æ›¿å®Œæˆå’Œç¡¬ä»¶çš„äº¤äº’ï¼Œä»è€Œä¸ºè¿›ç¨‹æä¾›æœåŠ¡ã€‚æ‰€ä»¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨æ—¶åœ¨ç”¨æˆ·ç©ºé—´å’Œè¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚ã€‚è¿™ä¸ªä¸­é—´å±‚çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li>ä¸ºç”¨æˆ·ç©ºé—´æä¾›ç¡¬ä»¶æ¥å£æŠ½è±¡</li><li>ç³»ç»Ÿè°ƒç”¨ä¿è¯ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®š</li><li>æ“ä½œç³»ç»Ÿå¯ä»¥æŒæ§è¿›ç¨‹çš„ç¡¬ä»¶è®¿é—®æ„å›¾ï¼Œå¹¶ä¸”ä»£åŠ³</li></ol><p>é‚£ä¹ˆç³»ç»Ÿè°ƒç”¨åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä¸€å¥è¯æ€»ç»“ä¸ºï¼š<strong>å½“ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶ï¼Œä¼šé™·å…¥åˆ°å†…æ ¸ï¼Œä¼ é€’ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•°ï¼Œæ‰§è¡Œæ­£ç¡®çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼å¸¦å›ç”¨æˆ·ç©ºé—´ã€‚</strong>å¯è§ï¼Œç³»ç»Ÿè°ƒç”¨éå¸¸ç‰¹æ®Šï¼Œå®Œå…¨ä¸åŒäºå¸¸è§„çš„å‡½æ•°è°ƒç”¨ï¼Œçœ‹èµ·æ¥éå¸¸ Hackã€‚</p><p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡å‡ ä¸ªé—®é¢˜ï¼ŒåŠ æ·±å¯¹ä¸Šè¿°æè¿°çš„ç†è§£ï¼š</p><ol><li><strong>å¦‚ä½•é™·å…¥åˆ°å†…æ ¸ï¼Ÿ</strong>é€šè¿‡è½¯ä¸­æ–­çš„æ–¹å¼å®ç°ï¼Œé€šè¿‡å¼•å‘ä¸€ä¸ªå¼‚å¸¸è§¦å‘ç³»ç»Ÿåˆ‡æ¢åˆ°å†…æ ¸æ€æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</li><li><strong>ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>åœ¨ Linux ä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªç¼–å·ï¼Œè¿›ç¨‹å…¶å®æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·è€Œä¸æ˜¯åç§°æ¥å‘ŠçŸ¥å†…æ ¸è‡ªå·±ä¸­æ„å“ªä¸ªç³»ç»Ÿè°ƒç”¨çš„ã€‚</li><li><strong>å¦‚ä½•ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ</strong>é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œåœ¨ x86 ä¸­ï¼Œå°±æ˜¯å°†ç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨ eax å¯„å­˜å™¨ä¼ é€’ç»™å†…æ ¸çš„ã€‚</li><li><strong>å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Ÿ</strong>    <ol><li>ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯å°†å‚æ•°æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸€èˆ¬æ¥è¯´ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸ä¼šå¾ˆå¤šã€‚åœ¨ x86 ä¸­ï¼Œå¯ä»¥ç”¨ ebx, ecx, edx, esi å’Œ edi æŒ‰é¡ºåºå­˜æ”¾äº”ä¸ªå‚æ•°ã€‚</li><li>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯å°†å‚æ•°å­˜æ”¾åœ¨ç”¨æˆ·ç©ºé—´å†…å­˜ä¸­ï¼Œå¹¶å°†å‚æ•°æŒ‡é’ˆå­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è¿™ç§æ˜¯ä¸ºäº†åº”ä»˜å‚æ•°è¶…è¿‡ 6 ä¸ªæƒ…å†µã€‚</li></ol></li><li><strong>è¿”å›å€¼å¦‚ä½•å¸¦ç»™ç”¨æˆ·ç©ºé—´ï¼Ÿ</strong>å½“ç„¶ä¹Ÿæ˜¯é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’çš„ï¼Œåœ¨ x86 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ eax å¯„å­˜å™¨ã€‚</li></ol><h1 id="å†…æ ¸æ•°æ®ç»“æ„"><a href="#å†…æ ¸æ•°æ®ç»“æ„" class="headerlink" title="å†…æ ¸æ•°æ®ç»“æ„"></a>å†…æ ¸æ•°æ®ç»“æ„</h1><p><img src="https://pic1.zhimg.com/80/v2-2bbaf34ff51ed6c19c0390d1fd118b40_hd.png" alt="å†…æ ¸æ•°æ®ç»“æ„"></p><p>Linux å†…æ ¸é“¾è¡¨å®ç°ç‹¬æ ‘ä¸€å¸œã€‚å®ƒæ˜¯å°†é“¾è¡¨å¡å…¥åˆ°æ•°æ®ç»“æ„ï¼Œè€Œéå¸¸è§„çš„é‚£ç§åœ¨æ•°æ®ç»“æ„ä¸­å¡å…¥é“¾è¡¨ã€‚</p><p>å¯ä»¥çœ‹ä¸‹å¯¹æ¯”å°±çŸ¥é“ä¸ºä½•ç‰¹åˆ«äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸¸è§„å®šä¹‰æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Linux å†…æ ¸é“¾è¡¨å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span> <span class="comment">// æ‰€æœ‰çš„ node å½¢æˆé“¾è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œé€šç”¨çš„é“¾è¡¨æ“ä½œå°±å¯ä»¥åŸºäº <code>struct list_head</code> æ¥å®ç°äº†ã€‚é‚£å¦‚ä½•å’Œæ ¹æ®é“¾è¡¨æŒ‡é’ˆè·å¾—å¯¹åº”çš„ <code>node</code> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ <code>container_of()</code> å®ï¼Œå®é™…ä¸Š C è¯­è¨€ä¸­ï¼Œä¸€ä¸ªç»™å®šç»“æ„ä½“ä¸­çš„å˜é‡åç§»åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¯ä»¥å€Ÿæ­¤è·å¾—çˆ¶ç»“æ„ä¸­çš„ä»»æ„å˜é‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define container_of(ptr, type, member) (&#123; \</span><br><span class="line">    const typeof( ((type *)0)-&gt;member) *__mptr = (ptr); \</span><br><span class="line">    (type *)( (char *)__mptr - offsetof(type, member) );&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å’Œä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å’Œä¸­æ–­å¤„ç†"></a>ä¸­æ–­å’Œä¸­æ–­å¤„ç†</h1><p><img src="https://pic4.zhimg.com/80/v2-78cb6999358bdd22b1a00c221f1d606e_r.png" alt=""></p><p>ä¸­æ–­æ˜¯å„ç§ç¡¬ä»¶è®¾å¤‡ä¸å¤„ç†å™¨ååŒé«˜æ•ˆå·¥ä½œçš„æ–¹å¼ä¹‹ä¸€ã€‚å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸€äº›å¤–éƒ¨è®¾å¤‡åˆ™ä¼šæ…¢å¾ˆå¤šï¼›ä¸ºäº†èƒ½å¤Ÿä¿è¯ CPU ä¸æµªè´¹æ—¶é—´è½®è¯¢è®¾å¤‡çŠ¶æ€ï¼Œè€Œé™ä½åˆ©ç”¨ç‡ï¼Œæ‰€ä»¥éœ€è¦ä¸­æ–­æœºåˆ¶æ¥é€šçŸ¥ CPUã€‚å½“å¤„ç†å™¨æ¥æ”¶åˆ°ä¸­æ–­åï¼Œä¼šå»æ‰§è¡Œå·²æ³¨å†Œçš„ç›¸å…³ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–­å’Œå‰é¢æåˆ°çš„å¼‚å¸¸ï¼ˆFaultï¼‰æ˜¯ä¸åŒçš„ï¼š</p><ol><li>ä¸­æ–­é€šå¸¸æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œä¸è€ƒè™‘æ—¶é’ŸåŒæ­¥ï¼›</li><li>å¼‚å¸¸åˆ™å¿…é¡»ä¸å¤„ç†å™¨æ—¶é’ŸåŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥ä¸­æ–­ï¼ˆå¦‚é™¤ 0 é”™è¯¯ã€ç¼ºé¡µï¼‰ã€‚</li></ol><p>Linux ä¸­å¯¹äºä¸­æ–­çš„å“åº”å’Œå¤„ç†åˆ†æˆ<strong>ä¸ŠåŠéƒ¨</strong>å’Œ<strong>ä¸‹åŠéƒ¨</strong>ã€‚å…¶ä¸­ä¸ŠåŠéƒ¨ä¼šåœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·åå¿«é€Ÿå®Œæˆå¿…è¦å·¥ä½œçš„ï¼ˆæœ‰ä¸¥æ ¼çš„æ—¶é™ï¼‰ï¼Œè€Œæ›´åŠ ç¹é‡çš„ä»»åŠ¡åˆ™ä¼šåœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚åœ¨ä¸ŠåŠéƒ¨éœ€è¦å¿«é€Ÿæ‰§è¡Œï¼Œä¸”æ— æ³•ç¡çœ ï¼›ä½†ä¸‹åŠéƒ¨åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚</p><h2 id="æ— é¡»é‡å…¥"><a href="#æ— é¡»é‡å…¥" class="headerlink" title="æ— é¡»é‡å…¥"></a>æ— é¡»é‡å…¥</h2><p>Linux ä¸­çš„ä¸­æ–­å¤„ç†ä¸ç”¨è€ƒè™‘é‡å…¥ï¼Œå› ä¸ºå½“ç»™å®šä¸­æ–­å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œå¯¹åº”ä¸­æ–­çº¿åœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šè¢«å±è”½ï¼Œé¿å…åŒä¸€ä¸­æ–­çº¿æ¥æ”¶å¦å¤–çš„ä¸­æ–­ã€‚è¿™æ ·åšç®€åŒ–äº†ä¸­æ–­å¤„ç†ç¨‹åºçš„ç¼–å†™ã€‚</p><h2 id="ä¸­æ–­ä¸Šä¸‹æ–‡"><a href="#ä¸­æ–­ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸­æ–­ä¸Šä¸‹æ–‡"></a>ä¸­æ–­ä¸Šä¸‹æ–‡</h2><p>æ‰€è°“çš„ä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆinterrupt contextï¼‰ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚ä¸­æ–­ä¸Šä¸‹æ–‡å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡æ²¡æœ‰åŠæ¯›é’±å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œè¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œä¸€ç•ªå¯¹æ¯”ï¼š</p><table><thead><tr><th>ä¸­æ–­ä¸Šä¸‹æ–‡</th><th>è¿›ç¨‹ä¸Šä¸‹æ–‡</th></tr></thead><tbody><tr><td>æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºæ—¶ï¼Œå†…æ ¸æ‰€å¤„çš„ä¸Šä¸‹æ–‡</td><td>å†…æ ¸ä»£è¡¨è¿›ç¨‹æ‰§è¡Œï¼ˆç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œå†…æ ¸çº¿ç¨‹ï¼‰æ—¶ï¼Œæ‰€å¤„çš„æ“ä½œæ¨¡å¼</td></tr><tr><td>ä¸è¿›ç¨‹æ— ç“œï¼Œä¸ current å®æ— ç“œ</td><td>å¯é€šè¿‡ current å®å…³è”å½“å‰è¿›ç¨‹</td></tr><tr><td>æ²¡æœ‰åå¤‡è¿›ç¨‹ï¼Œæ— æ³•ç¡çœ ï¼Œä¹Ÿä¸èƒ½è°ƒç”¨ä¼šå¯¼è‡´ç¡çœ çš„å‡½æ•°</td><td>å¯ç¡çœ ï¼Œå¯è°ƒç”¨è°ƒåº¦ç¨‹åº</td></tr><tr><td>æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶é™</td><td>æ²¡æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚</td></tr></tbody></table><h2 id="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"><a href="#ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ" class="headerlink" title="ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ"></a>ä¸‹åŠéƒ¨åŠæ¨åæ‰§è¡Œçš„å·¥ä½œ</h2><p>ä¸‹åŠéƒ¨å°±æ˜¯æ‰§è¡Œå’Œä¸­æ–­å¤„ç†ç›¸å…³ï¼Œä½†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºä¸­ä¸ä¼šæ‰§è¡Œçš„å·¥ä½œã€‚å¼•å…¥ä¸‹åŠéƒ¨çš„ç›®çš„å°±æ˜¯è®©ä¸­æ–­å¤„ç†ç¨‹åºå°½å¯èƒ½åœ°ç®€çŸ­ã€å¿«é€Ÿï¼Œé¿å…å±è”½ä¸­æ–­å¤ªä¹…ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å“åº”èƒ½åŠ›å’Œæ€§èƒ½å—åˆ°å½±å“ï¼›è€Œæ¯”è¾ƒç¹é‡çš„å·¥ä½œå¯ä»¥åœ¨ä¸‹åŠéƒ¨æ‰§è¡Œã€‚</p><p>ä¸‹åŠéƒ¨ä¸»è¦å®ç°æ–¹å¼ï¼š</p><ol><li><strong>è½¯ä¸­æ–­</strong><ol><li>å¯¹äºæ—¶é—´è¦æ±‚ä¸¥æ ¼ï¼Œä¸”èƒ½è‡ªå·±é«˜æ•ˆå®ŒæˆåŠ é”çš„å·¥ä½œï¼Œå¯ä½¿ç”¨è½¯ä¸­æ–­ï¼ˆå¦‚ç½‘ç»œã€SCSIï¼‰</li><li>è½¯ä¸­æ–­æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸å“åº”ä¸­æ–­ï¼Œä½†å®ƒè‡ªèº«<strong>ä¸èƒ½ç¡çœ </strong></li></ol></li><li><strong>tasklet</strong><ol><li>åŸºäºè½¯ä¸­æ–­å®ç°ï¼ŒåŒä¸€ä¸ªå¤„ç†ç¨‹åºçš„å¤šä¸ªå®ä¾‹ä¸èƒ½å†å¤šä¸ªå¤„ç†å™¨åŒæ—¶è¿è¡Œ</li><li>ç”¨é€”å¹¿æ³›ï¼Œæ¥å£ç®€å•ï¼Œæ€§èƒ½ä¸é”™</li><li>ä¸èƒ½ç¡çœ </li></ol></li><li><strong>å·¥ä½œé˜Ÿåˆ—</strong>ä¸­çš„å·¥ä½œå¯ä»¥äº¤ç»™å†…æ ¸çº¿ç¨‹æ¨åæ‰§è¡Œï¼ˆä¼šåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¼˜åŠ¿ï¼Œä¸”å¯ä»¥é‡æ–°è°ƒåº¦å’Œç¡çœ </li></ol><h1 id="å†…æ ¸åŒæ­¥"><a href="#å†…æ ¸åŒæ­¥" class="headerlink" title="å†…æ ¸åŒæ­¥"></a>å†…æ ¸åŒæ­¥</h1><p>åœ¨è¿›è¡Œå†…æ ¸ç¼–ç¨‹æ—¶ï¼Œæ—¶åˆ»éœ€è¦æ³¨æ„å¹¶å‘å¸¦æ¥çš„é—®é¢˜ï¼Œéœ€è¦èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ä¸´ç•ŒåŒºï¼Œæ­£ç¡®åŠ é”ã€è§£é”ï¼Œä¿è¯å…³é”®æ•°æ®ç»“æ„ä¸è¢«é”™è¯¯ä¿®æ”¹ã€‚é‚£ä¹ˆæœ‰å“ªäº›æƒ…å†µèƒ½é€ æˆå¹¶å‘é—®é¢˜å‘¢ï¼Ÿ</p><ol><li><strong>ä¸­æ–­</strong>ï¼šå¼‚æ­¥å‘ç”Ÿï¼Œä¼šä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>è½¯ä¸­æ–­å’Œ tasklet</strong>ï¼šå†…æ ¸ä¼šåœ¨ä»»æ„æ—¶åˆ»å”¤é†’è½¯ä¸­æ–­å’Œ taskletï¼Œæ‰“æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li><strong>å†…æ ¸æŠ¢å </strong>ï¼šå†…æ ¸ä¸­çš„ä»»åŠ¡å¯èƒ½è¢«å…¶å®ƒä»»åŠ¡æŠ¢å </li><li><strong>ç¡çœ åŠä¸ç”¨æˆ·ç©ºé—´åŒæ­¥</strong>ï¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œçš„è¿›ç¨‹å¯èƒ½ä¼šç¡çœ ï¼Œä»è€Œå¯¼è‡´è°ƒåº¦ç¨‹åºè¢«å”¤é†’ï¼Œå¹¶è¿è¡Œæ–°çš„ç”¨æˆ·è¿›ç¨‹</li><li><strong>SMP</strong>ï¼šå¤šä¸ªå¤„ç†å™¨ä¼šå¹¶è¡Œæ‰§è¡Œ</li></ol><p><img src="https://pic3.zhimg.com/80/v2-de0df74c2c0f79723ab558d3b2727e71.png" alt=""></p><h1 id="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"><a href="#å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†" class="headerlink" title="å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†"></a>å®šæ—¶å™¨å’Œæ—¶é—´ç®¡ç†</h1><p>å†…æ ¸éœ€è¦åœ¨ç¡¬ä»¶ï¼ˆRTC å’Œ Timerï¼‰çš„å¸®åŠ©ä¸‹æ‰èƒ½è®¡ç®—å’Œç®¡ç†æ—¶é—´ï¼Œå†…æ ¸é€šè¿‡<strong>å·²çŸ¥çš„</strong>ï¼ˆè¿™ä¸ªæ—¶é’Ÿå‘¨æœŸæ˜¯å¯ç¼–ç¨‹çš„ï¼Œå¯ç¡®å®šçš„ï¼‰æ—¶é’Ÿä¸­æ–­é—´éš”æ¥è®¡ç®— wall time å’Œ jiffiesï¼ˆç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ€»æ•°ï¼‰ã€‚é‚£ä¹ˆï¼Œåœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶ç©¶ç«Ÿä¼šåšå“ªäº›å·¥ä½œå‘¢ï¼Ÿä»¥ä¸‹ç»™å‡ºä¸€äº›ä¼šå‘¨æœŸæ‰§è¡Œçš„å·¥ä½œï¼š</p><ol><li>æ›´æ–°ç³»ç»Ÿè¿è¡Œæ—¶é—´å’Œå®é™…æ—¶é—´</li><li>å¯¹äº SMP ç³»ç»Ÿï¼Œéœ€è¦å‡è¡¡å„å¤„ç†å™¨ä¸Šçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœè¿è¡Œé˜Ÿåˆ—è´Ÿè½½ä¸å‡è¡¡ï¼Œéœ€è¦å°½é‡è®©å®ƒä»¬å‡è¡¡</li><li>æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦ç”¨å°½äº†è‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œå¦‚æœæ—¶ï¼Œåˆ™é‡æ–°è¿›è¡Œè°ƒåº¦</li><li>è¿è¡Œè¶…æ—¶çš„åŠ¨æ€å®šæ—¶å™¨</li><li>æ›´æ–°èµ„æºæ¶ˆè€—å’Œå¤„ç†å™¨æ—¶é—´ç»Ÿè®¡å€¼</li></ol><h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><h2 id="é¡µ"><a href="#é¡µ" class="headerlink" title="é¡µ"></a>é¡µ</h2><p>å†…æ ¸æ˜¯æŠŠç‰©ç†å†…å­˜åˆ†é¡µç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µï¼ˆpageï¼‰æ˜¯æœ€åŸºæœ¬çš„ç®¡ç†å•å…ƒã€‚MMU ä¹Ÿæ˜¯ä»¥é¡µå¤§å°ä¸ºå•ä½è½¬æ¢è™šæ‹Ÿåœ°å€åˆ°ç¡¬ä»¶åœ°å€çš„ã€‚ä¸åŒçš„ä½“ç³»ç»“æ„ï¼Œé¡µå¤§å°ä¸åŒï¼Œä¸€èˆ¬ 32 ä½ç³»ç»Ÿæ˜¯ 4KBï¼Œ64 ä½ç³»ç»Ÿæ˜¯ 8KBã€‚</p><h2 id="åŒº"><a href="#åŒº" class="headerlink" title="åŒº"></a>åŒº</h2><p>å› ä¸ºç¡¬ä»¶å­˜åœ¨é™åˆ¶ï¼Œå†…æ ¸æ— æ³•å¯¹æ‰€æœ‰çš„é¡µä¸€è§†åŒä»ã€‚å› æ­¤éœ€è¦æŠŠé¡µåˆ’åˆ†æˆä¸åŒçš„åŒºï¼ˆzoneï¼‰ï¼Œå†…æ ¸éœ€è¦å¤„ç†å¦‚ä¸‹å› ä¸ºç¡¬ä»¶ç¼ºé™·è€Œå¼•èµ·çš„å†…å­˜å¯»å€é—®é¢˜ï¼š</p><ol><li>ä¸€äº›ç¡¬ä»¶åªèƒ½ç”¨ç‰¹å®šçš„å†…å­˜åœ°å€æ‰§è¡Œ DMA æ“ä½œ</li><li>ä¸€äº›ä½“ç³»ç»“æ„çš„å†…å­˜ç‰©ç†å¯»å€èŒƒå›´æ¯”è™šæ‹Ÿåœ°å€èŒƒå›´å¤§</li></ol><p>å†…æ ¸çš„åˆ†åŒºæœ‰å››ç§ï¼š</p><ol><li><strong>ZONE_DMA</strong>ï¼šå¯æ‰§è¡Œ DMA æ“ä½œçš„é¡µé›†åˆ</li><li>ZONE_DMA32ï¼šåŒä¸Šï¼Œä½†ä»…é™äº 32 ä½è®¾å¤‡</li><li><strong>ZONE_NORMAL</strong>ï¼šèƒ½å¤Ÿæ­£å¸¸æ˜ å°„çš„é¡µ</li><li>ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­çš„é¡µä¸èƒ½æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼ˆè¿™é‡Œé™äº 32 ä½åœ°å€ç©ºé—´ï¼Œ64 ä½å°±ä¸ä¼šæœ‰é—®é¢˜äº†ï¼‰</li></ol><h2 id="é¡µç”³è¯·å’Œé‡Šæ”¾"><a href="#é¡µç”³è¯·å’Œé‡Šæ”¾" class="headerlink" title="é¡µç”³è¯·å’Œé‡Šæ”¾"></a>é¡µç”³è¯·å’Œé‡Šæ”¾</h2><ol><li><code>alloc_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘é¡µç»“æ„çš„æŒ‡é’ˆ</li><li><code>alloc_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­é¡µ</li><li><code>__get_free_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œè¿”å›æŒ‡å‘å…¶é€»è¾‘åœ°å€çš„æŒ‡é’ˆ</li><li><code>__get_free_pages(gfp_mask, order)</code>ï¼šåˆ†é… 2^order ä¸ªè¿ç»­ç‰©ç†é¡µï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>get_zeroed_page(gfp_mask)</code>ï¼šåªåˆ†é…ä¸€é¡µï¼Œä¸”å¡«å…… 0 ï¼Œè¿”å›é€»è¾‘åœ°å€æŒ‡é’ˆ</li><li><code>__free_pages(struct page *page, unsinged int order)</code></li><li><code>free_pages(unsigned long addr, unsinged int order)</code></li><li><code>free_page(unsigned long addr)</code></li></ol><h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p><code>void *kmalloc(size_t size, gfp_t flags)</code>ï¼Œ<code>kmalloc()</code> ç±»ä¼¼äº <code>malloc()</code>ï¼Œå¯ä»¥è·å¾—æŒ‡å®šå­—èŠ‚å¤§å°çš„å†…æ ¸å†…å­˜ï¼Œå®ƒåˆ†é…å¾—åˆ°çš„é¡µçš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯è¿ç»­çš„ã€‚<br><code>void kfree(const void *ptr)</code> é‡Šæ”¾åˆ†é…çš„å†…å­˜ç©ºé—´</p><p>å…³äºæ ‡è®°ä½ï¼Œå¸¸ç”¨çš„æ˜¯ GFP_KERNELï¼Œå…è®¸ç¡çœ ï¼Œç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ç©ºé—´ï¼›å¦å¤–çš„ GFP_ATOMICï¼Œåˆ™ä¸å¯ä»¥ç¡çœ ï¼Œå¯ç”¨äºè¿›ç¨‹ä¸Šä¸‹æ–‡ã€ä¸­æ–­å¤„ç†ç¨‹åºã€è½¯ä¸­æ–­ã€taskletã€‚</p><h2 id="vmalloc"><a href="#vmalloc" class="headerlink" title="vmalloc"></a>vmalloc</h2><p><code>vmalloc()</code> ç±»ä¼¼ <code>kmalloc()</code>ï¼Œä¸åŒçš„æ˜¯ï¼Œå®ƒåˆ†é…çš„å†…å­˜è™šæ‹Ÿåœ°å€è™½ç„¶æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯å®é™…çš„ç‰©ç†åœ°å€æ— éœ€è¿ç»­ã€‚å®ƒé€šè¿‡åˆ†é…éè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†ã€Œä¿®æ­£ã€é¡µè¡¨ï¼Œä»è€ŒæŠŠå†…å­˜æ˜ å°„åˆ°é€»è¾‘åœ°å€ç©ºé—´è¿ç»­çš„åŒºåŸŸã€‚å®ƒéœ€è¦ä¸“é—¨çš„é¡µè¡¨æ¥å®Œæˆè¿ç»­è™šæ‹Ÿåœ°å€åˆ°å®é™…éè¿ç»­ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œå¼€é”€è¾ƒå¤§ï¼Œä¸”å®¹æ˜“å¼•èµ· TLB æŠ–åŠ¨ï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­æ›´å€¾å‘äºä½¿ç”¨ <code>kmalloc()</code>ã€‚</p><h2 id="slab-å±‚"><a href="#slab-å±‚" class="headerlink" title="slab å±‚"></a>slab å±‚</h2><p>slab å±‚å……å½“é€šç”¨æ•°æ®ç»“æ„çš„ç¼“å­˜å±‚çš„è§’è‰²ï¼Œå®ƒä¼šä¸ºä¸åŒçš„å¯¹è±¡åˆ’åˆ†æˆä¸åŒçš„é«˜é€Ÿç¼“å­˜ç»„ï¼Œæ¯ç»„å­˜æ”¾ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼Œå­˜æ”¾ task_struct å’Œ inode å°±åˆ†å±äºä¸åŒçš„ç»„ã€‚kmalloc() ä¹Ÿæ˜¯åŸºäº slab å±‚ä¹‹ä¸Šï¼Œä½¿ç”¨äº†ä¸€ç»„é€šç”¨é«˜é€Ÿç¼“å­˜ã€‚</p><p>slab åˆ†é…å™¨å¼•å…¥çš„ç›®çš„ï¼š</p><ol><li>é¿å…é¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡éœ€è¦é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾ï¼Œé™ä½å¼€é”€</li><li>é¢‘ç¹åˆ†é…å›æ”¶å®¹æ˜“å¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œå‡å°‘ç¢ç‰‡é—®é¢˜</li><li>æé«˜æ€§èƒ½</li><li>éƒ¨åˆ†ç¼“å­˜ä¸“å±äºæŸä¸ªå¤„ç†å™¨æ—¶ï¼Œå¯ä»¥å®ç°æ— é”åˆ†é…å’Œé‡Šæ”¾ï¼ˆtcmallocï¼‰</li></ol><p><img src="https://pic1.zhimg.com/80/v2-1540217805cb1d2ee083d293209bbbaf_r.png" alt=""></p><h1 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰" class="headerlink" title="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰"></a>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</h1><p>VFS æ˜¯ Linux æä¾›çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼Œæ¶µç›–äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¸¸ç”¨åŠŸèƒ½é›†å’Œè¡Œä¸ºï¼Œä»è€Œæ”¯æŒå„ç§å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ NTFS, FAT, EXT4ï¼‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ç©ºé—´ write() -&gt; VFS sys_write() -&gt; æ–‡ä»¶ç³»ç»Ÿçš„å†™æ–¹æ³• -&gt; å­˜å‚¨è®¾å¤‡</span><br></pre></td></tr></table></figure></p><p>Unix æ–‡ä»¶ç³»ç»Ÿä¼ ç»ŸæŠ½è±¡æ¦‚å¿µï¼šFile, DirectoryEntry, Index Node å’Œ Mount Pointã€‚Unix æ–‡ä»¶çš„ç‰¹ç‚¹æ˜¯é¢å‘å­—èŠ‚æµæŠ½è±¡è®¾è®¡çš„ï¼Œå…·æœ‰ç®€å•ã€çµæ´»çš„ç‰¹æ€§ã€‚åœ¨ Unix ä¸­ï¼Œç›®å½•ä¹Ÿæ˜¯æ™®é€šæ–‡ä»¶ï¼Œå…¶åˆ—å‡ºäº†åŒ…å«åœ¨ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ã€‚</p><p>VFS ä¸­çš„ä¸»è¦å¯¹è±¡ï¼š</p><ol><li>è¶…çº§å—å¯¹è±¡ï¼Œä»£è¡¨å…·ä½“å·²å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶</li><li>ç›®å½•é¡¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ†</li><li>æ–‡ä»¶å¯¹è±¡ï¼Œä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼ˆå…¶å®å®ƒä¼šæŒ‡å‘ç›®å½•é¡¹å¯¹è±¡ï¼Œè€Œç›®å½•é¡¹å¯¹è±¡æ‰æ˜¯çœŸæ­£è¡¨ç¤ºå·²æ‰“å¼€çš„å®é™…æ–‡ä»¶ï¼Œå› ä¸ºå…¶ä¸­åŒ…å«äº†æŒ‡å‘ inode çš„æŒ‡é’ˆï¼‰</li></ol><h1 id="å—-I-O"><a href="#å—-I-O" class="headerlink" title="å— I/O"></a>å— I/O</h1><p>Linux ä¸­ï¼Œè®¾å¤‡åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol><li><strong>å—è®¾å¤‡</strong>ï¼šæ”¯æŒéšæœºè®¿é—®å›ºå®šå¤§å°çš„æ•°æ®å—ï¼Œå¦‚ç¡¬ç›˜ã€é—ªå­˜</li><li><strong>å­—ç¬¦è®¾å¤‡</strong>ï¼šä»¥å­—ç¬¦æµçš„å½¢å¼è¢«è®¿é—®ï¼Œå¦‚é”®ç›˜</li><li><strong>ç½‘ç»œè®¾å¤‡</strong></li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹å—è®¾å¤‡çš„è¯·æ±‚ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·åœ¨ I/O è¯·æ±‚é˜Ÿåˆ—ä¸Šï¼Œå¹¶ä¸”ç”± I/O è°ƒåº¦ç¨‹åºæ¥ç®¡ç†è¯·æ±‚é˜Ÿåˆ—ã€‚å®ƒä¼šå†³å®šè¯·æ±‚é˜Ÿåˆ—ä¸­çš„è¯·æ±‚<strong>å¦‚ä½•æ’åº</strong>ï¼Œä»¥åŠ<strong>ä½•æ—¶</strong>å‘é€åˆ°å…·ä½“çš„å—è®¾å¤‡ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œå°±æ˜¯æœŸæœ›å€ŸåŠ© I/O è°ƒåº¦ç¨‹åºï¼Œå¯¹è¯·æ±‚è¿›è¡Œ<strong>åˆå¹¶</strong>å’Œ<strong>æ’åº</strong>ï¼Œä»è€Œæœ‰æ•ˆæé«˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼ˆä¹Ÿå¯èƒ½é€ æˆæŸäº›è¯·æ±‚å¾—ä¸åˆ°å…¬å¹³å¯¹å¾…ï¼Œç”šè‡³å‡ºç°é¥¥é¥¿çš„æƒ…å†µï¼‰ã€‚ä»¥ä¸‹è®°å½•çš„æ˜¯ Linux ä¸­å·²ç»å®ç°çš„å‡ ç§ I/O è°ƒåº¦ç®—æ³•ï¼š</p><ol><li><p><strong>Linus ç”µæ¢¯</strong></p><ol><li>æ”¯æŒå‘å‰å’Œå‘ååˆå¹¶ï¼ˆé€šå¸¸éƒ½æ˜¯è¿™ç§å±…å¤šï¼‰</li><li>æœ‰è¾ƒå¥½çš„å…¨å±€ååé‡</li><li>ä¼šå‘ç”Ÿè¯·æ±‚é¥¥é¥¿é—®é¢˜</li></ol></li><li><p><strong>æœ€ç»ˆæœŸé™ï¼ˆdeadlineï¼‰ I/O è°ƒåº¦</strong></p><ol><li>é™ä½äº†ç³»ç»Ÿçš„å…¨å±€ååé‡</li><li>è¯»è¯·æ±‚è¶…æ—¶ 500msï¼Œå†™è¯·æ±‚è¶…æ—¶ 5sï¼Œè¶…æ—¶å¿…ç„¶å¾—åˆ°æœåŠ¡ï¼Œé¿å…é•¿æ—¶é—´é¥¥é¥¿çš„é—®é¢˜</li></ol></li><li><p><strong>é¢„æµ‹ï¼ˆanticipatoryï¼‰ I/O è°ƒåº¦</strong></p><ol><li>ç›®æ ‡æ˜¯ä¿æŒè¾ƒå¥½çš„è¯»å“åº”åŒæ—¶ï¼Œæä¾›è‰¯å¥½çš„å…¨å±€ååé‡ã€‚è§†å›¾å‡å°‘åœ¨è¿›è¡Œ I/O æ“ä½œæœŸé—´ï¼Œå¤„ç†æ–°åˆ°çš„è¯»è¯·æ±‚å¸¦æ¥çš„å¯»å€æ•°é‡</li><li>è¯·æ±‚æäº¤åä¸ä¼šç›´æ¥è¿”å›å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œè€Œä¼šç©ºé—²ç‰‡åˆ»ï¼ˆå‡ æ¯«ç§’ï¼‰ï¼Œç­‰å¾…åº”ç”¨æäº¤å…¶å®ƒè¯»è¯·æ±‚</li></ol></li><li><p><strong>å®Œå…¨å…¬å¹³æ’é˜Ÿ I/O è°ƒåº¦ï¼ˆCFQï¼‰</strong></p><ol><li>ä¸ºç‰¹æ®Šå·¥ä½œè´Ÿè½½çš„åœºæ™¯è®¾è®¡ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è¯·æ±‚é˜Ÿåˆ—</li><li>ä»¥æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚</li></ol></li></ol><h1 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h1><p>ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡é‡‡ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œç»™æ¯ä¸ªè¿›ç¨‹è¥é€ äº†ç‹¬äº«å†…å­˜çš„å‡è±¡ï¼Œè¿™æ˜¯å†…å­˜è™šæ‹ŸåŒ–çš„é‡è¦æœºåˆ¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°ä»£é‡‡ç”¨è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿé€šå¸¸éƒ½ä½¿ç”¨å¹³å¦åœ°å€ç©ºé—´ï¼Œè€Œéåˆ†æ®µå¼çš„å†…å­˜æ¨¡å¼ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†…å­˜åœ°å€ç©ºé—´ä¼šæ ¹æ®éœ€è¦åˆ’åˆ†æˆä¸åŒçš„åŒºåŸŸã€‚å†…æ ¸å¯ä»¥ç»™è¿›ç¨‹åœ°å€ç©ºé—´åŠ¨æ€æ·»åŠ æˆ–å‡å°‘å†…å­˜åŒºåŸŸã€‚æ¯ä¸ªè¿›ç¨‹åªèƒ½è®¿é—®æœ‰æ•ˆå†…å­˜åŒºåŸŸå†…çš„å†…å­˜åœ°å€ï¼Œæ¯ä¸ªå†…å­˜åŒºåŸŸä¼šåŒ…å«æƒé™ç­‰å±æ€§ã€‚<strong>è¿›ç¨‹ä¸­ä»»æ„æœ‰æ•ˆåœ°å€åªèƒ½ä½äºå”¯ä¸€çš„åŒºåŸŸï¼Œä¸”è¿™äº›åŒºåŸŸä¸èƒ½ç›¸äº’è¦†ç›–</strong>ã€‚</p><p>å†…å­˜åŒºåŸŸå¯ä»¥åŒ…å«å„ç§å†…å­˜å¯¹è±¡ï¼š</p><ol><li>å¯æ‰§è¡Œæ–‡ä»¶ä»£ç çš„å†…å­˜æ˜ å°„ï¼Œtext section</li><li>å¯æ‰§è¡Œæ–‡ä»¶å·²åˆå§‹åŒ–å…¨å±€å˜é‡çš„å†…å­˜æ˜ å°„ï¼Œdata section</li><li>åŒ…å«æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒBSS æ®µçš„é›¶é¡µçš„å†…å­˜æ˜ å°„</li><li>è¿›ç¨‹ç”¨æˆ·ç©ºé—´æ ˆçš„é›¶é¡µå†…å­˜æ˜ å°„</li><li>æ¯ä¸ªä¸€ä¸ªè¯¸å¦‚ C åº“æˆ–åŠ¨æ€è¿æ¥ç¨‹åºç­‰å…±äº«çš„  text section, data section å’Œ bss ä¹Ÿè¢«è½½å…¥åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</li><li>å†…å­˜æ˜ å°„æ–‡ä»¶</li><li>å…±äº«å†…å­˜æ®µ</li><li>åŒ¿åæ˜ å°„ï¼Œå¦‚ malloc() åˆ†é…çš„å†…å­˜</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm_struct -&gt; vm_area_struct</span><br></pre></td></tr></table></figure><h2 id="64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"><a href="#64-ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€" class="headerlink" title="64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€"></a>64 ä½ç³»ç»Ÿè¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€</h2><p><img src="https://pic4.zhimg.com/80/v2-5f2b9c321b7100a11e2dae9e48bce81f_r.png" alt=""><br>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ 64bit çš„åœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨ä¸€åŠçš„åœ°å€ç©ºé—´ï¼ˆ128 TiBï¼‰ï¼Œè€Œå¦ä¸€åŠåˆ™æ˜¯å†…æ ¸ç©ºé—´ä½¿ç”¨ã€‚å†…æ ¸é€šå¸¸é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šè¢«æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å½“ä¸­ã€‚è€Œåœ¨å†…æ ¸ä¸­ï¼Œæ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚è¯¦ç»†çš„å†…å­˜å¸ƒå±€å¯ä»¥å‚è€ƒåé¢çš„å­¦ä¹ èµ„æ–™~</p><h2 id="é¡µè¡¨"><a href="#é¡µè¡¨" class="headerlink" title="é¡µè¡¨"></a>é¡µè¡¨</h2><p>Linux ä¸­ä½¿ç”¨ä¸‰çº§é¡µè¡¨å®Œæˆåœ°å€è½¬æ¢ï¼Œä½¿ç”¨å¤šçº§é¡µè¡¨å¯ä»¥èŠ‚çº¦åœ°å€è½¬æ¢éœ€è¦å ç”¨çš„ç©ºé—´ã€‚ä½†ç”±äºå®Œæˆè™šæ‹Ÿé¡µåœ°å€åˆ°ç‰©ç†é¡µåœ°å€è½¬æ¢éƒ½éœ€è¦åœ¨ä¸‰çº§é¡µè¡¨ä¸­æŸ¥æ‰¾åˆ°æ˜ å°„ï¼Œå¼€é”€æ¯”è¾ƒé«˜ã€‚æ‰€ä»¥å¾ˆå¤šä½“ç³»ç»“æ„æä¾›äº† TLB ä½œä¸ºåœ°å€æ˜ å°„çš„ç¡¬ä»¶ç¼“å­˜ã€‚<br><img src="https://pic4.zhimg.com/80/v2-e7ae1f0fcc4b3a1d0af4e65a1ca04101_r.png" alt=""><br><img src="https://pic4.zhimg.com/80/v2-ff24fef84f1c136922f8bf1f5679ea99_hd.png" alt=""></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»ä½“ä¸Šæ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯æ¯”è¾ƒé€‚åˆå¯¹æ“ä½œç³»ç»ŸåŸºæœ¬æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¸”å¯¹äº Linux å†…æ ¸ä¹Ÿæœ‰ä¸€ç‚¹äº†è§£çš„å‰æä¸‹é˜…è¯»ï¼Œå¦åˆ™åœ¨çœ‹åˆ°ä¸€äº›æ¦‚å¿µçš„æ—¶å€™ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ¯”å¦‚å¯¹äºè¿›ç¨‹ã€çº¿ç¨‹çš„æŠ½è±¡å®šä¹‰ï¼Œè™šæ‹Ÿå†…å­˜ä¸­è®²åˆ°çš„åˆ†é¡µã€åˆ†æ®µæ¦‚å¿µä»¥åŠå¤šçº§é¡µè¡¨çš„æ¦‚å¿µã€‚å¦å¤–ï¼Œå¯¹äºå¸¸ç”¨æ•°æ®ç»“æ„éœ€è¦æœ‰æ¸…æ™°çš„è®¤è¯†ï¼›å¹¶å‘ç›¸å…³çš„åŒæ­¥é—®é¢˜ä¹Ÿæœ‰äº†è§£ã€‚<br>è™½ç„¶æ•´æœ¬ä¹¦æ˜¯åŸºäº Linux 2.6.3x å†…æ ¸ä¸ºåŸºç¡€çš„ï¼Œå¦‚ä»Šçš„ Linux å†…æ ¸å·²ç»å‘å±•åˆ° 5.x æ—¶ä»£äº†ï¼Œè¿™æœŸé—´å˜åŒ–è‚¯å®šæœ‰å¾ˆå¤šã€‚ä½†è¿™æœ¬ä¹¦çš„ä»·å€¼è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå…¶ä¸­è®²å¾—å¾ˆå¤šæ€æƒ³ã€æ–¹æ³•ä¾ç„¶å®ç”¨ï¼Œå¯ä»¥å˜é€šåœ°å»çœ‹å¾…å’Œç†è§£ã€‚</p><h1 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h1><ol><li>POSIX: Portable Operating System Interface</li><li>TLB: Translation Lookup Buffer</li><li>CFS: Complete Fair Scheduler</li><li>CFQ: Complete Fair Queueingï¼Œè¿™ä¸ªæ˜¯ IO è°ƒåº¦å™¨ä¹‹ä¸€</li><li>VFS: Virtual File System</li><li>VMA: Virtual Memory Area</li><li>MMU: Memory Map Unit</li><li>jiffies: Linux ä¸­ç”¨æ¥è®°å½•ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„èŠ‚æ‹æ•°çš„å…¨å±€å˜é‡ï¼Œè¿˜æœ‰ä¸€ä¸ª jiffies_64</li><li>ISR: Interrupt Service Routine</li></ol><h1 id="æ·±å…¥å­¦ä¹ "><a href="#æ·±å…¥å­¦ä¹ " class="headerlink" title="æ·±å…¥å­¦ä¹ "></a>æ·±å…¥å­¦ä¹ </h1><ul><li>ã€ŠLinux å†…æ ¸è®¾è®¡ä¸å®ç° Linux Kernel Developmentï¼Œç¬¬ 3 ç‰ˆã€‹</li><li><a href="https://unix.stackexchange.com/questions/364660/are-threads-implemented-as-processes-on-linux" target="_blank" rel="noopener">Are Threads Implemented As Processes on Linux</a></li><li><a href="https://zh.wikipedia.org/wiki/POSIX%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">POSIX çº¿ç¨‹</a></li><li><a href="https://juejin.im/post/5d23326d6fb9a07efe2de11e" target="_blank" rel="noopener">Linux çº¿ç¨‹å®ç°</a></li><li><a href="https://www.kernel.org/doc/html/latest/scheduler/sched-design-CFS.html" target="_blank" rel="noopener">Linux Sched Doc CFS</a></li><li><a href="https://trepo.tuni.fi/bitstream/handle/10024/96864/GRADU-1428493916.pdf" target="_blank" rel="noopener">A complete guide to Linux process scheduling</a></li><li><a href="https://www.win.tue.nl/~aeb/linux/lk/lk-9.html" target="_blank" rel="noopener">Linux Memory</a></li><li><a href="https://www.it.iitb.ac.in/frg/wiki/images/f/fc/113050076_Rajesh_Prodduturi_week5_presentation_3_2012-08-04.pdf" target="_blank" rel="noopener">Linux memory management</a></li><li><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">x86_64 å†…å­˜æ˜ å°„</a></li><li><a href="https://simonis.github.io/Memory/" target="_blank" rel="noopener">The Memory Layout of a 64-bit Linux Process</a></li><li><a href="https://stackoverflow.com/questions/55443733/linux-kernel-memory-layout" target="_blank" rel="noopener">Linux kernel memory layout</a></li><li><a href="https://www.kernel.org/doc/gorman/html/understand/understand006.html" target="_blank" rel="noopener">Chapter 3 Page Table Management</a></li><li><a href="https://ifaceless.space/2019/11/18/linux-kernel-scheduler-papers/" target="_blank" rel="noopener">Linux è°ƒåº¦å™¨èµ„æ–™æ•´ç†</a></li><li><a href="https://makelinux.github.io/kernel_map/" target="_blank" rel="noopener">Linux Kernel Map</a></li><li><a href="https://hackernoon.com/entering-god-mode-the-kernel-space-mirroring-attack-8a86b749545f" target="_blank" rel="noopener">Entering God Mode â€” The Kernel Space Mirroring Attack</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘æŠ½æ—¶é—´æŠŠ &lt;a href=&quot;http://pages.cs.wisc.edu/~remzi/OSTEP/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;em&gt;Operating Systems: Three Easy Pieces&lt;/em&gt;&lt;/a&gt; ç»ˆäºçœ‹å®Œäº†ï¼ˆå…¶å® 2017 å¹´å°±çŸ¥é“å®ƒäº†ï¼Œæ²¡æƒ³åˆ°æ‹–åˆ°äº† 2019 å¹´ ğŸ˜…ï¼‰ï¼Œå…¨ä¹¦åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè™šæ‹ŸåŒ–ã€å¹¶å‘ã€æŒä¹…åŒ–ï¼‰å¯¹æ“ä½œç³»ç»Ÿçš„ä¸€äº›é€šç”¨è®¾è®¡æ€æƒ³è¿›è¡Œäº†ä»‹ç»ï¼Œå­¦å®Œåï¼Œå¯¹äºè¿›ç¨‹ã€å†…å­˜è™šæ‹ŸåŒ–ã€å¹¶å‘ã€æ–‡ä»¶ç³»ç»Ÿæœ‰äº†æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚ä½†æ˜¯ï¼ŒçœŸå®çš„ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¿™å°±æ˜¯å¸Œæœ›åœ¨é˜…è¯»ã€ŠLinux è®¾è®¡ä¸å®ç°ã€‹ï¼ˆ&lt;em&gt;Linux Kernel Development&lt;/em&gt;ï¼‰åæ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚å½“ç„¶ï¼Œåœ¨å­¦ä¹ ä¸­ä¹Ÿé’ˆå¯¹å¾ˆå¤šéƒ¨åˆ†æœé›†äº†ä¸å°‘å­¦ä¹ èµ„æ–™ï¼Œæ•´ç†åœ¨æ–‡åï¼Œæ–¹ä¾¿åŠ æ·±ç†è§£ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Linux" scheme="/categories/Linux/"/>
    
    
      <category term="Linux" scheme="/tags/Linux/"/>
    
      <category term="è°ƒåº¦å™¨" scheme="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="å†…å­˜ç®¡ç†" scheme="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
      <category term="æ–‡ä»¶ç³»ç»Ÿ" scheme="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
</feed>
